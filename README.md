# èˆªå°å¨ - åŸºäº LangChain çš„æ™ºèƒ½ RAG çƒ¹é¥ªåŠ©æ‰‹

ä¸€ä¸ªåŸºäº LangChain å¼€å‘çš„æ™ºèƒ½æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ç³»ç»Ÿï¼Œä¸“é—¨ç”¨äºçƒ¹é¥ªé¢†åŸŸçš„é—®ç­”åŠ©æ‰‹ã€‚ç³»ç»Ÿé›†æˆäº†å‘é‡æ£€ç´¢ã€é‡æ’æ¨¡å‹å’Œæ™ºèƒ½ Agentï¼Œèƒ½å¤ŸåŸºäºèœè°±æ•°æ®åº“æä¾›ä¸“ä¸šçš„çƒ¹é¥ªå»ºè®®ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ä»‹ç»](#-é¡¹ç›®ä»‹ç»)
- [åŠŸèƒ½ç‰¹æ€§](#-åŠŸèƒ½ç‰¹æ€§)
- [æŠ€æœ¯æ ˆ](#-æŠ€æœ¯æ ˆ)
- [å®‰è£…æ­¥éª¤](#-å®‰è£…æ­¥éª¤)
- [é…ç½®è¯´æ˜](#-é…ç½®è¯´æ˜)
- [ä½¿ç”¨æ–¹æ³•](#-ä½¿ç”¨æ–¹æ³•)
- [é¡¹ç›®ç»“æ„](#-é¡¹ç›®ç»“æ„)
- [æ€§èƒ½ç›‘æ§](#-æ€§èƒ½ç›‘æ§)
- [å¸¸è§é—®é¢˜](#-å¸¸è§é—®é¢˜)

## ğŸ¯ é¡¹ç›®ä»‹ç»

èˆªå°å¨æ˜¯ä¸€ä¸ªæ™ºèƒ½çƒ¹é¥ªåŠ©æ‰‹ï¼Œé‡‡ç”¨ RAGï¼ˆRetrieval-Augmented Generationï¼‰æ¶æ„ï¼Œç»“åˆäº†ï¼š

- **å‘é‡æ£€ç´¢**ï¼šä½¿ç”¨ FAISS å‘é‡æ•°æ®åº“è¿›è¡Œå¿«é€Ÿç›¸ä¼¼åº¦æœç´¢
- **é‡æ’æ¨¡å‹**ï¼šå¯é€‰çš„é‡æ’åŠŸèƒ½ï¼Œæå‡æ£€ç´¢ç»“æœçš„ç›¸å…³æ€§
- **æ™ºèƒ½ Agent**ï¼šåŸºäº LangChain çš„ Agent æ¡†æ¶ï¼Œæ”¯æŒå·¥å…·è°ƒç”¨å’Œè®°å¿†åŠŸèƒ½
- **äº¤äº’ç•Œé¢**ï¼šåŸºäº Streamlit çš„å‹å¥½ Web ç•Œé¢

ç³»ç»Ÿèƒ½å¤Ÿå›ç­”å„ç§çƒ¹é¥ªç›¸å…³é—®é¢˜ï¼ŒåŒ…æ‹¬ï¼š
- å…·ä½“èœè°±åšæ³•
- æ ¹æ®å·²æœ‰é£Ÿææ¨èèœè°±
- çƒ¹é¥ªæŠ€å·§å’Œæ¦‚å¿µè§£é‡Š
- èœè°±æ¨èå’Œä¿®æ”¹å»ºè®®

> **æ•°æ®æ¥æº**ï¼šæœ¬é¡¹ç›®çš„æ•°æ®æºè‡ª GitHub é¡¹ç›® [HowToCook](https://github.com/Anduin2017/HowToCook)ï¼Œä¸€ä¸ªä¼˜ç§€çš„ç¨‹åºå‘˜åœ¨å®¶åšé¥­æ–¹æ³•æŒ‡å—ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½

1. **æ™ºèƒ½æ£€ç´¢**
   - æ”¯æŒå‘é‡ç›¸ä¼¼åº¦æ£€ç´¢
   - å¯é€‰çš„é‡æ’åŠŸèƒ½ï¼Œæå‡æ£€ç´¢ç²¾åº¦
   - å¯é…ç½®çš„å¬å›æ•°é‡ï¼ˆTop Kï¼‰å’Œé‡æ’åè¿”å›æ•°é‡ï¼ˆTop Nï¼‰

2. **æ™ºèƒ½ Agent**
   - åŸºäº LangChain çš„ Tools Agent
   - è‡ªåŠ¨å·¥å…·è°ƒç”¨å’Œå†³ç­–
   - æ”¯æŒå¯¹è¯è®°å¿†åŠŸèƒ½

3. **äº¤äº’ç•Œé¢**
   - å‹å¥½çš„ Streamlit Web ç•Œé¢
   - å®æ—¶æ€§èƒ½ç›‘æ§
   - å¯é…ç½®çš„æ£€ç´¢å‚æ•°
   - æ–°å¯¹è¯åŠŸèƒ½

4. **æ€§èƒ½ç›‘æ§**
   - æ£€ç´¢æ—¶é—´ç»Ÿè®¡
   - ç”Ÿæˆæ—¶é—´ç»Ÿè®¡
   - æ€»å»¶è¿Ÿç›‘æ§
   - ååé‡è®¡ç®—

### é«˜çº§ç‰¹æ€§

- âœ… **å¯é€‰é‡æ’**ï¼šæ”¯æŒå¯ç”¨/ç¦ç”¨é‡æ’åŠŸèƒ½
- âœ… **å‚æ•°å¯é…ç½®**ï¼šé‡æ’æ¨¡å‹ã€Top Kã€Top N ç­‰å‚æ•°å¯åœ¨ç•Œé¢ä¸­è°ƒæ•´
- âœ… **å¯¹è¯è®°å¿†**ï¼šæ”¯æŒå¤šè½®å¯¹è¯ï¼Œä¿æŒä¸Šä¸‹æ–‡
- âœ… **æ€§èƒ½æŠ¥å‘Š**ï¼šè¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡å±•ç¤º

## ğŸ›  æŠ€æœ¯æ ˆ

- **æ¡†æ¶**ï¼šLangChain 0.3.x
- **å‘é‡æ•°æ®åº“**ï¼šFAISS
- **åµŒå…¥æ¨¡å‹**ï¼šDashScope text-embedding-v4
- **é‡æ’æ¨¡å‹**ï¼šDashScope qwen3-rerank / qwen-rerank
- **LLM**ï¼šDashScope qwen-flash
- **Web æ¡†æ¶**ï¼šStreamlit
- **Python**ï¼š3.x

## ğŸ“¦ å®‰è£…æ­¥éª¤

### 1. å…‹éš†é¡¹ç›®

```bash
git clone <repository-url>
cd 2025RAG
```

### 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰

```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# æˆ–
venv\Scripts\activate  # Windows
```

### 3. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

å¦‚æœé‡åˆ°ä¾èµ–å†²çªï¼Œå¯ä»¥è¿è¡Œä¿®å¤è„šæœ¬ï¼š

```bash
bash fix_dependencies.sh
```

### 4. é…ç½® API Key

ç¼–è¾‘ `retriever-generator/agent_backend.py` æ–‡ä»¶ï¼Œåœ¨ç¬¬ 123 è¡Œè®¾ç½®ä½ çš„ DashScope API Keyï¼š

```python
API_KEY = "your-api-key-here"  # åœ¨è¿™é‡Œè®¾ç½®ä½ çš„ API key
```

### 5. å‡†å¤‡å‘é‡ç´¢å¼•

ç¡®ä¿ `retriever-generator/faiss_index2/` ç›®å½•ä¸‹å­˜åœ¨å‘é‡ç´¢å¼•æ–‡ä»¶ï¼š
- `index.faiss`
- `index.pkl`

å¦‚æœæ²¡æœ‰ï¼Œéœ€è¦å…ˆè¿è¡Œç´¢å¼•æ„å»ºè„šæœ¬ï¼ˆå‚è€ƒ `faiss_index/build_index.py`ï¼‰ã€‚

## âš™ï¸ é…ç½®è¯´æ˜

### API Key é…ç½®

åœ¨ `retriever-generator/agent_backend.py` ä¸­é…ç½®ï¼š

```python
API_KEY = "sk-your-api-key-here"
```

### æ£€ç´¢å‚æ•°é…ç½®

åœ¨ Streamlit ç•Œé¢çš„ä¾§è¾¹æ å¯ä»¥é…ç½®ï¼š

1. **å¯ç”¨é‡æ’**ï¼šé€‰æ‹©æ˜¯å¦ä½¿ç”¨é‡æ’æ¨¡å‹
2. **é‡æ’æ¨¡å‹**ï¼šé€‰æ‹©é‡æ’æ¨¡å‹ï¼ˆqwen3-rerank æˆ– qwen-rerankï¼‰
3. **Top K**ï¼šå¬å›çš„æ–‡æ¡£æ•°é‡ï¼ˆ1-20ï¼‰
4. **Rerank Top N**ï¼šé‡æ’åè¿”å›çš„æ–‡æ¡£æ•°é‡ï¼ˆ1-10ï¼Œä»…åœ¨å¯ç”¨é‡æ’æ—¶ä½¿ç”¨ï¼‰

### é»˜è®¤é…ç½®

- **é‡æ’æ¨¡å‹**ï¼šqwen3-rerank
- **Top K**ï¼š5ï¼ˆå¯ç”¨é‡æ’æ—¶ï¼‰æˆ– 3ï¼ˆä¸å¯ç”¨é‡æ’æ—¶ï¼‰
- **Rerank Top N**ï¼š3
- **LLM æ¨¡å‹**ï¼šqwen-flash
- **æ¸©åº¦å‚æ•°**ï¼š0.1

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æœ¬åœ°è¿è¡Œ

#### å¯åŠ¨åº”ç”¨

```bash
cd retriever-generator
streamlit run app.py
```

åº”ç”¨å°†åœ¨æµè§ˆå™¨ä¸­è‡ªåŠ¨æ‰“å¼€ï¼Œé»˜è®¤åœ°å€ä¸ºï¼š`http://localhost:8501`

### ä½¿ç”¨æ­¥éª¤

1. **é…ç½®å‚æ•°**ï¼ˆä¾§è¾¹æ ï¼‰
   - é€‰æ‹©æ˜¯å¦å¯ç”¨é‡æ’
   - å¦‚æœå¯ç”¨é‡æ’ï¼Œé€‰æ‹©é‡æ’æ¨¡å‹å’Œè®¾ç½®å‚æ•°
   - è®¾ç½® Top K å’Œ Top N å‚æ•°

2. **å¼€å§‹å¯¹è¯**
   - åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ä½ çš„é—®é¢˜
   - ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€ç´¢ç›¸å…³æ–‡æ¡£å¹¶ç”Ÿæˆå›ç­”

3. **æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡**
   - ä¾§è¾¹æ æ˜¾ç¤ºå¹³å‡æ€§èƒ½æŒ‡æ ‡
   - æ¯æ¬¡æŸ¥è¯¢åæ˜¾ç¤ºæœ¬æ¬¡æŸ¥è¯¢çš„æ€§èƒ½æŒ‡æ ‡

4. **å¼€å§‹æ–°å¯¹è¯**
   - ç‚¹å‡»ä¾§è¾¹æ çš„"ğŸ”„ å¼€å§‹æ–°å¯¹è¯"æŒ‰é’®
   - æ¸…ç©ºå¯¹è¯å†å²ï¼Œå¼€å§‹æ–°çš„ä¼šè¯

## ğŸ“ é¡¹ç›®ç»“æ„

```
2025RAG/
â”œâ”€â”€ retriever-generator/          # ä¸»è¦åº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ app.py                    # Streamlit ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ agent_backend.py         # Agent åç«¯é€»è¾‘
â”‚   â”œâ”€â”€ agentrag.py              # Agent RAG ç¤ºä¾‹
â”‚   â”œâ”€â”€ Rerank_A_G.py            # é‡æ’ RAG ç¤ºä¾‹
â”‚   â”œâ”€â”€ faiss_index2/            # FAISS å‘é‡ç´¢å¼•
â”‚   â”‚   â”œâ”€â”€ index.faiss
â”‚   â”‚   â””â”€â”€ index.pkl
â”‚   â””â”€â”€ __pycache__/
â”œâ”€â”€ faiss_index/                  # ç´¢å¼•æ„å»ºè„šæœ¬
â”‚   â”œâ”€â”€ build_index.py
â”‚   â”œâ”€â”€ index.faiss
â”‚   â””â”€â”€ index.pkl
â”œâ”€â”€ data/                         # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ chunked_corpus_fuzi/
â”‚   â””â”€â”€ howtocook/
â”œâ”€â”€ requirements.txt              # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ fix_dependencies.sh          # ä¾èµ–ä¿®å¤è„šæœ¬
â””â”€â”€ README.md                    # æœ¬æ–‡ä»¶
```

### æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

- **`app.py`**ï¼šStreamlit Web åº”ç”¨ä¸»æ–‡ä»¶ï¼ŒåŒ…å«ç•Œé¢å’Œäº¤äº’é€»è¾‘
- **`agent_backend.py`**ï¼šAgent åç«¯ï¼ŒåŒ…å«æ£€ç´¢å™¨ã€é‡æ’æ¨¡å‹å’Œ Agent æ‰§è¡Œå™¨çš„åˆå§‹åŒ–
- **`agentrag.py`**ï¼šAgent RAG çš„ç¤ºä¾‹ä»£ç 
- **`Rerank_A_G.py`**ï¼šå¸¦é‡æ’åŠŸèƒ½çš„ RAG ç¤ºä¾‹ä»£ç 

## ğŸ“Š æ€§èƒ½ç›‘æ§

ç³»ç»Ÿæä¾›è¯¦ç»†çš„æ€§èƒ½ç›‘æ§åŠŸèƒ½ï¼š

### å®æ—¶æŒ‡æ ‡

- **æ£€ç´¢æ—¶é—´**ï¼šå‘é‡æ£€ç´¢å’Œé‡æ’çš„æ€»è€—æ—¶
- **ç”Ÿæˆæ—¶é—´**ï¼šLLM ç”Ÿæˆå›ç­”çš„è€—æ—¶
- **æ€»å»¶è¿Ÿ**ï¼šä»æŸ¥è¯¢åˆ°å›ç­”çš„æ€»æ—¶é—´
- **ååé‡**ï¼šæ¯ç§’å¤„ç†çš„è¯·æ±‚æ•°

### æŸ¥çœ‹æ–¹å¼

1. **å•æ¬¡æŸ¥è¯¢æŒ‡æ ‡**ï¼šæ¯æ¬¡æŸ¥è¯¢åï¼Œåœ¨å›ç­”ä¸‹æ–¹å±•å¼€"ğŸ“Š æœ¬æ¬¡æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡"
2. **å¹³å‡æŒ‡æ ‡**ï¼šä¾§è¾¹æ æ˜¾ç¤ºæ‰€æœ‰æŸ¥è¯¢çš„å¹³å‡æ€§èƒ½æŒ‡æ ‡

## â“ å¸¸è§é—®é¢˜

### 1. ä¾èµ–å†²çªé—®é¢˜

å¦‚æœé‡åˆ° LangChain ç‰ˆæœ¬å†²çªï¼Œè¿è¡Œï¼š

```bash
bash fix_dependencies.sh
```

### 2. API Key é”™è¯¯

ç¡®ä¿åœ¨ `agent_backend.py` ä¸­æ­£ç¡®è®¾ç½®äº† API Keyï¼Œå¹¶ä¸” API Key æœ‰æ•ˆã€‚

### 3. å‘é‡ç´¢å¼•ä¸å­˜åœ¨

å¦‚æœæç¤ºæ‰¾ä¸åˆ°å‘é‡ç´¢å¼•ï¼Œéœ€è¦å…ˆæ„å»ºç´¢å¼•ï¼š

```bash
python faiss_index/build_index.py
```

### 4. é‡æ’åŠŸèƒ½ä¸å·¥ä½œ

æ£€æŸ¥ï¼š
- æ˜¯å¦åœ¨ç•Œé¢ä¸­å¯ç”¨äº†é‡æ’
- API Key æ˜¯å¦æœ‰é‡æ’æ¨¡å‹çš„æƒé™
- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

### 5. æ€§èƒ½é—®é¢˜

å¦‚æœå“åº”è¾ƒæ…¢ï¼Œå¯ä»¥å°è¯•ï¼š
- å‡å°‘ Top K å€¼
- ç¦ç”¨é‡æ’åŠŸèƒ½
- æ£€æŸ¥ç½‘ç»œè¿æ¥

## ğŸ”§ å¼€å‘è¯´æ˜

### ä¿®æ”¹ API Key

ç¼–è¾‘ `retriever-generator/agent_backend.py`ï¼š

```python
API_KEY = "your-new-api-key"
```

### ä¿®æ”¹é»˜è®¤å‚æ•°

åœ¨ `agent_backend.py` çš„ `load_agent_executor` å‡½æ•°ä¸­ä¿®æ”¹é»˜è®¤å€¼ï¼š

```python
def load_agent_executor(
    memory: ConversationBufferMemory = None,
    enable_rerank: bool = True,
    rerank_model: str = "qwen3-rerank",
    top_k: int = 5,
    rerank_top_n: int = 3
):
```

### æ·»åŠ æ–°çš„é‡æ’æ¨¡å‹

åœ¨ `app.py` çš„ä¾§è¾¹æ é…ç½®ä¸­æ·»åŠ æ–°çš„é€‰é¡¹ï¼š

```python
rerank_model = st.selectbox(
    "é‡æ’æ¨¡å‹",
    options=["qwen3-rerank", "qwen-rerank", "new-model"],  # æ·»åŠ æ–°æ¨¡å‹
    ...
)
```

## ğŸ“ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚

## ğŸ™ è‡´è°¢

æœ¬é¡¹ç›®çš„æ•°æ®æºè‡ª GitHub é¡¹ç›® [HowToCook](https://github.com/Anduin2017/HowToCook)ï¼Œæ„Ÿè°¢åŸä½œè€…å’Œæ‰€æœ‰è´¡çŒ®è€…çš„è¾›å‹¤å·¥ä½œï¼

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤ Issue æˆ–è”ç³»é¡¹ç›®ç»´æŠ¤è€…ã€‚

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ğŸ³**
