### 第1页

The Python/C API
Release 3.14.0rc3
Guido van Rossum and the Python development team
October 01, 2025
Python Software Foundation
Email: docs@python.org

### 第3页

CONTENTS
1 Introduction 3
1.1 Languageversioncompatibility. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3
1.2 Codingstandards . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3
1.3 IncludeFiles . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3
1.4 Usefulmacros . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4
1.5 Objects,TypesandReferenceCounts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6
1.5.1 ReferenceCounts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6
1.5.2 Types . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9
1.6 Exceptions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 10
1.7 EmbeddingPython . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 11
1.8 DebuggingBuilds . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 12
1.9 Recommendedthirdpartytools . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 12
2 CAPIStability 15
2.1 UnstableCAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15
2.2 StableApplicationBinaryInterface . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15
2.2.1 LimitedCAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15
2.2.2 StableABI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16
2.2.3 LimitedAPIScopeandPerformance . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16
2.2.4 LimitedAPICaveats . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16
2.3 PlatformConsiderations . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17
2.4 ContentsofLimitedAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17
3 TheVeryHighLevelLayer 43
4 ReferenceCounting 47
5 ExceptionHandling 51
5.1 Printingandclearing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 51
5.2 Raisingexceptions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 52
5.3 Issuingwarnings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 54
5.4 Queryingtheerrorindicator . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 55
5.5 SignalHandling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 58
5.6 ExceptionClasses. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 60
5.7 ExceptionObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 60
5.8 UnicodeExceptionObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 61
5.9 RecursionControl . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 62
5.10 Exceptionandwarningtypes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 63
5.10.1 Exceptiontypes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 63
5.10.2 OSErroraliases . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 67
5.10.3 Warningtypes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 69
6 Definingextensionmodules 71
6.1 Multiplemoduleinstances . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 71
6.2 Initializationfunction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 72
i

### 第4页

6.3 Multi-phaseinitialization . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 72
6.4 Legacysingle-phaseinitialization . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 73
7 Utilities 75
7.1 OperatingSystemUtilities . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 75
7.2 SystemFunctions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 78
7.3 ProcessControl . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 80
7.4 ImportingModules . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 80
7.5 Datamarshallingsupport . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 84
7.6 Parsingargumentsandbuildingvalues . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 85
7.6.1 Parsingarguments . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 85
7.6.2 Buildingvalues . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 92
7.7 Stringconversionandformatting . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 94
7.8 PyHashAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 96
7.9 Reflection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 97
7.10 Codecregistryandsupportfunctions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 98
7.10.1 CodeclookupAPI. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 99
7.10.2 RegistryAPIforUnicodeencodingerrorhandlers . . . . . . . . . . . . . . . . . . . . . 99
7.11 PyTimeCAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 100
7.11.1 Types . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 100
7.11.2 ClockFunctions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 100
7.11.3 RawClockFunctions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 101
7.11.4 Conversionfunctions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 101
7.12 SupportforPerfMaps . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 101
8 AbstractObjectsLayer 103
8.1 ObjectProtocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 103
8.2 CallProtocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 113
8.2.1 Thetp_callProtocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 113
8.2.2 TheVectorcallProtocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 113
8.2.3 ObjectCallingAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 115
8.2.4 CallSupportAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 117
8.3 NumberProtocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 118
8.4 SequenceProtocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 121
8.5 MappingProtocol. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 123
8.6 IteratorProtocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 124
8.7 BufferProtocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 125
8.7.1 Bufferstructure . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 125
8.7.2 Bufferrequesttypes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 127
8.7.3 Complexarrays . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 129
8.7.4 Buffer-relatedfunctions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 130
9 ConcreteObjectsLayer 133
9.1 FundamentalObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 133
9.1.1 TypeObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 133
9.1.2 TheNoneObject . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 140
9.2 NumericObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 140
9.2.1 IntegerObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 140
9.2.2 BooleanObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 150
9.2.3 Floating-PointObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 150
9.2.4 ComplexNumberObjects. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 152
9.3 SequenceObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 154
9.3.1 BytesObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 154
9.3.2 ByteArrayObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 156
9.3.3 UnicodeObjectsandCodecs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 157
9.3.4 TupleObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 179
9.3.5 StructSequenceObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 180
9.3.6 ListObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 182
9.4 ContainerObjects. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 184
ii

### 第5页

9.4.1 DictionaryObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 184
9.4.2 SetObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 189
9.5 FunctionObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 190
9.5.1 FunctionObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 190
9.5.2 InstanceMethodObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 193
9.5.3 MethodObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 193
9.5.4 CellObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 193
9.5.5 CodeObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 194
9.5.6 CodeObjectFlags . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 197
9.5.7 Extrainformation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 199
9.6 OtherObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 200
9.6.1 FileObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 200
9.6.2 ModuleObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 201
9.6.3 Moduledefinitions. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 202
9.6.4 Creatingextensionmodulesdynamically . . . . . . . . . . . . . . . . . . . . . . . . . . 205
9.6.5 Supportfunctions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 206
9.6.6 IteratorObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 209
9.6.7 DescriptorObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 209
9.6.8 SliceObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 210
9.6.9 MemoryViewobjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 211
9.6.10 WeakReferenceObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 212
9.6.11 Capsules . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 213
9.6.12 FrameObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 215
9.6.13 GeneratorObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 217
9.6.14 CoroutineObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 218
9.6.15 ContextVariablesObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 218
9.6.16 DateTimeObjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 220
9.6.17 ObjectsforTypeHinting . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 224
10 Initialization,Finalization,andThreads 225
10.1 BeforePythonInitialization. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 225
10.2 Globalconfigurationvariables . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 226
10.3 Initializingandfinalizingtheinterpreter . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 229
10.4 Process-wideparameters . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 232
10.5 ThreadStateandtheGlobalInterpreterLock . . . . . . . . . . . . . . . . . . . . . . . . . . . . 235
10.5.1 Detachingthethreadstatefromextensioncode . . . . . . . . . . . . . . . . . . . . . . . 236
10.5.2 Non-Pythoncreatedthreads . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 236
10.5.3 Supportingsubinterpretersinnon-Pythonthreads. . . . . . . . . . . . . . . . . . . . . . 237
10.5.4 Cautionsaboutfork() . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 237
10.5.5 Cautionsregardingruntimefinalization . . . . . . . . . . . . . . . . . . . . . . . . . . . 238
10.5.6 High-levelAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 238
10.5.7 Low-levelAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 241
10.6 Sub-interpretersupport . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 243
10.6.1 APer-InterpreterGIL . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 246
10.6.2 Bugsandcaveats . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 246
10.7 AsynchronousNotifications. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 246
10.8 ProfilingandTracing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247
10.9 Referencetracing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 249
10.10 AdvancedDebuggerSupport . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 249
10.11 ThreadLocalStorageSupport . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 250
10.11.1 ThreadSpecificStorage(TSS)API . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 250
10.11.2 ThreadLocalStorage(TLS)API . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 251
10.12 SynchronizationPrimitives . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 252
10.12.1 PythonCriticalSectionAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 252
11 PythonInitializationConfiguration 255
11.1 PyInitConfigCAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 255
11.1.1 Example . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 255
iii

### 第6页

11.1.2 CreateConfig . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 256
11.1.3 ErrorHandling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 256
11.1.4 GetOptions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 256
11.1.5 SetOptions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 257
11.1.6 Module . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 257
11.1.7 InitializePython . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 258
11.2 ConfigurationOptions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 258
11.3 RuntimePythonconfigurationAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 259
11.4 PyConfigCAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 260
11.4.1 Example . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 261
11.4.2 PyWideStringList . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 261
11.4.3 PyStatus . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 262
11.4.4 PyPreConfig . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 263
11.4.5 PreinitializePythonwithPyPreConfig . . . . . . . . . . . . . . . . . . . . . . . . . . . 265
11.4.6 PyConfig . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 266
11.4.7 InitializationwithPyConfig . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 277
11.4.8 IsolatedConfiguration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279
11.4.9 PythonConfiguration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279
11.4.10 PythonPathConfiguration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279
11.5 Py_GetArgcArgv() . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 281
11.6 Delayingmainmoduleexecution . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 281
12 MemoryManagement 283
12.1 Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 283
12.2 AllocatorDomains . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 284
12.3 RawMemoryInterface . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 284
12.4 MemoryInterface. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 285
12.5 Objectallocators . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 286
12.6 DefaultMemoryAllocators . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 288
12.7 CustomizeMemoryAllocators . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 288
12.8 DebughooksonthePythonmemoryallocators . . . . . . . . . . . . . . . . . . . . . . . . . . . 290
12.9 Thepymallocallocator . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 291
12.9.1 CustomizepymallocArenaAllocator . . . . . . . . . . . . . . . . . . . . . . . . . . . . 291
12.10 Themimallocallocator . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 292
12.11 tracemallocCAPI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 292
12.12 Examples . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 292
13 ObjectImplementationSupport 295
13.1 AllocatingObjectsontheHeap. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 295
13.2 ObjectLifeCycle . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 297
13.2.1 LifeEvents . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 297
13.2.2 CyclicIsolateDestruction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 300
13.2.3 Functions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 301
13.3 CommonObjectStructures . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 301
13.3.1 Baseobjecttypesandmacros . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 301
13.3.2 Implementingfunctionsandmethods . . . . . . . . . . . . . . . . . . . . . . . . . . . . 303
13.3.3 Accessingattributesofextensiontypes . . . . . . . . . . . . . . . . . . . . . . . . . . . 306
13.4 TypeObjectStructures . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 310
13.4.1 QuickReference . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 311
13.4.2 PyTypeObjectDefinition . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 315
13.4.3 PyObjectSlots. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 316
13.4.4 PyVarObjectSlots . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 317
13.4.5 PyTypeObjectSlots . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 317
13.4.6 StaticTypes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 341
13.4.7 HeapTypes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 341
13.4.8 NumberObjectStructures. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 341
13.4.9 MappingObjectStructures . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 343
13.4.10 SequenceObjectStructures . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 344
iv

### 第7页

13.4.11 BufferObjectStructures . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 345
13.4.12 AsyncObjectStructures . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 346
13.4.13 SlotTypetypedefs. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 346
13.4.14 Examples . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 348
13.5 SupportingCyclicGarbageCollection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 350
13.5.1 ControllingtheGarbageCollectorState. . . . . . . . . . . . . . . . . . . . . . . . . . . 354
13.5.2 QueryingGarbageCollectorState. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 354
14 APIandABIVersioning 355
14.1 Build-timeversionconstants . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 355
14.2 Run-timeversion . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 355
14.3 Bit-packingmacros . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 355
15 MonitoringCAPI 357
16 GeneratingExecutionEvents 359
16.1 ManagingtheMonitoringState . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 360
A Glossary 363
B Aboutthisdocumentation 381
B.1 ContributorstothePythondocumentation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 381
C HistoryandLicense 383
C.1 Historyofthesoftware . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 383
C.2 TermsandconditionsforaccessingorotherwiseusingPython . . . . . . . . . . . . . . . . . . . . 384
C.2.1 PYTHONSOFTWAREFOUNDATIONLICENSEVERSION2 . . . . . . . . . . . . . 384
C.2.2 BEOPEN.COMLICENSEAGREEMENTFORPYTHON2.0 . . . . . . . . . . . . . . 385
C.2.3 CNRILICENSEAGREEMENTFORPYTHON1.6.1 . . . . . . . . . . . . . . . . . . 385
C.2.4 CWILICENSEAGREEMENTFORPYTHON0.9.0THROUGH1.2 . . . . . . . . . . 386
C.2.5 ZERO-CLAUSEBSDLICENSEFORCODEINTHEPYTHONDOCUMENTATION . 387
C.3 LicensesandAcknowledgementsforIncorporatedSoftware . . . . . . . . . . . . . . . . . . . . . 387
C.3.1 MersenneTwister . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 387
C.3.2 Sockets . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 388
C.3.3 Asynchronoussocketservices . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 389
C.3.4 Cookiemanagement. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 389
C.3.5 Executiontracing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 389
C.3.6 UUencodeandUUdecodefunctions . . . . . . . . . . . . . . . . . . . . . . . . . . . . 390
C.3.7 XMLRemoteProcedureCalls . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 391
C.3.8 test_epoll . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 391
C.3.9 Selectkqueue . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 392
C.3.10 SipHash24 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 392
C.3.11 strtodanddtoa. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 393
C.3.12 OpenSSL . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 393
C.3.13 expat. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 396
C.3.14 libffi . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 397
C.3.15 zlib . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 397
C.3.16 cfuhash . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 398
C.3.17 libmpdec . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 398
C.3.18 W3CC14Ntestsuite . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 399
C.3.19 mimalloc . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 400
C.3.20 asyncio . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 400
C.3.21 GlobalUnboundedSequences(GUS) . . . . . . . . . . . . . . . . . . . . . . . . . . . . 400
C.3.22 Zstandardbindings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 401
D Copyright 403
Bibliography 405
Index 407
v

### 第8页

vi

### 第9页

ThismanualdocumentstheAPIusedbyCandC++programmerswhowanttowriteextensionmodulesorembed
Python. Itisacompaniontoextending-index,whichdescribesthegeneralprinciplesofextensionwritingbutdoes
notdocumenttheAPIfunctionsindetail.
CONTENTS 1

### 第10页

2 CONTENTS

### 第11页

CHAPTER
ONE
INTRODUCTION
TheApplicationProgrammer’sInterfacetoPythongivesCandC++programmersaccesstothePythoninterpreter
atavarietyoflevels. TheAPIisequallyusablefromC++,butforbrevityitisgenerallyreferredtoasthePython/C
API.TherearetwofundamentallydifferentreasonsforusingthePython/CAPI.Thefirstreasonistowriteextension
modules for specific purposes; these are C modules that extend the Python interpreter. This is probably the most
commonuse. ThesecondreasonistousePythonasacomponentinalargerapplication;thistechniqueisgenerally
referredtoasembeddingPythoninanapplication.
Writinganextensionmoduleisarelativelywell-understoodprocess,wherea“cookbook”approachworkswell. There
areseveraltoolsthatautomatetheprocesstosomeextent. WhilepeoplehaveembeddedPythoninotherapplications
sinceitsearlyexistence,theprocessofembeddingPythonislessstraightforwardthanwritinganextension.
Many API functions are useful independent of whether you’re embedding or extending Python; moreover, most
applications that embed Python will need to provide a custom extension as well, so it’s probably a good idea to
becomefamiliarwithwritinganextensionbeforeattemptingtoembedPythoninarealapplication.
1.1 Language version compatibility
Python’sCAPIiscompatiblewithC11andC++11versionsofCandC++.
Thisisalowerlimit: theCAPIdoesnotrequirefeaturesfromlaterC/C++versions. Youdonotneedtoenableyour
compiler’s“c11mode”.
1.2 Coding standards
Ifyou’rewritingCcodeforinclusioninCPython,youmustfollowtheguidelinesandstandardsdefinedinPEP7.
TheseguidelinesapplyregardlessoftheversionofPythonyouarecontributingto. Followingtheseconventionsis
notnecessaryforyourownthirdpartyextensionmodules,unlessyoueventuallyexpecttocontributethemtoPython.
1.3 Include Files
Allfunction,typeandmacrodefinitionsneededtousethePython/CAPIareincludedinyourcodebythefollowing
line:
#define PY_SSIZE_T_CLEAN
#include <Python.h>
Thisimpliesinclusionofthefollowingstandardheaders: <stdio.h>,<string.h>,<errno.h>,<limits.h>,
<assert.h>and<stdlib.h>(ifavailable).
(cid:174) Note
SincePythonmaydefinesomepre-processordefinitionswhichaffectthestandardheadersonsomesystems,you
mustincludePython.hbeforeanystandardheadersareincluded.
3

### 第12页

ItisrecommendedtoalwaysdefinePY_SSIZE_T_CLEANbeforeincludingPython.h. SeeParsingarguments
andbuildingvaluesforadescriptionofthismacro.
AlluservisiblenamesdefinedbyPython.h(exceptthosedefinedbytheincludedstandardheaders)haveoneofthe
prefixesPyor_Py. Namesbeginningwith_PyareforinternalusebythePythonimplementationandshouldnotbe
usedbyextensionwriters. Structuremembernamesdonothaveareservedprefix.
(cid:174) Note
UsercodeshouldneverdefinenamesthatbeginwithPyor_Py. Thisconfusesthereader,andjeopardizesthe
portabilityoftheusercodetofuturePythonversions,whichmaydefineadditionalnamesbeginningwithoneof
theseprefixes.
TheheaderfilesaretypicallyinstalledwithPython. OnUnix,thesearelocatedinthedirectoriesprefix/include/
pythonversion/ and exec_prefix/include/pythonversion/, where prefix and exec_prefix are
defined by the corresponding parameters to Python’s configure script and version is '%d.%d' % sys.
version_info[:2]. OnWindows,theheadersareinstalledinprefix/include,whereprefixistheinstalla-
tiondirectoryspecifiedtotheinstaller.
Toincludetheheaders,placebothdirectories(ifdifferent)onyourcompiler’ssearchpathforincludes. Donotplace
the parent directories on the search path and then use #include <pythonX.Y/Python.h>; this will break on
multi-platform builds since the platform independent headers under prefix include the platform specific headers
fromexec_prefix.
C++usersshouldnotethatalthoughtheAPIisdefinedentirelyusingC,theheaderfilesproperlydeclaretheentry
pointstobeextern "C". Asaresult,thereisnoneedtodoanythingspecialtousetheAPIfromC++.
1.4 Useful macros
SeveralusefulmacrosaredefinedinthePythonheaderfiles. Manyaredefinedclosertowheretheyareuseful(for
example, Py_RETURN_NONE, PyMODINIT_FUNC). Others of a more general utility are defined here. This is not
necessarilyacompletelisting.
Py_ABS(x)
Returntheabsolutevalueofx.
Addedinversion3.3.
Py_ALWAYS_INLINE
Askthecompilertoalwaysinlineastaticinlinefunction. Thecompilercanignoreitanddecidetonotinline
thefunction.
ItcanbeusedtoinlineperformancecriticalstaticinlinefunctionswhenbuildingPythonindebugmodewith
functioninliningdisabled. Forexample,MSCdisablesfunctioninliningwhenbuildingindebugmode.
Marking blindly a static inline function with Py_ALWAYS_INLINE can result in worse performances (due
to increasedcode sizefor example). Thecompiler isusuallysmarter thanthe developerfor thecost/benefit
analysis.
IfPythonisbuiltindebugmode(ifthePy_DEBUG macroisdefined),thePy_ALWAYS_INLINEmacrodoes
nothing.
Itmustbespecifiedbeforethefunctionreturntype. Usage:
static inline Py_ALWAYS_INLINE int random(void) { return 4; }
Addedinversion3.11.
4 Chapter1. Introduction

### 第13页

Py_CHARMASK(c)
Argumentmustbeacharacteroranintegerintherange[-128,127]or[0,255]. Thismacroreturnsccastto
anunsigned char.
Py_DEPRECATED(version)
Usethisfordeprecateddeclarations. Themacromustbeplacedbeforethesymbolname.
Example:
Py_DEPRECATED(3.8) PyAPI_FUNC(int) Py_OldFunction(void);
Changedinversion3.8: MSVCsupportwasadded.
Py_GETENV(s)
Like getenv(s), but returns NULL if -E was passed on the command line (see PyConfig.
use_environment).
Py_MAX(x,y)
Returnthemaximumvaluebetweenxandy.
Addedinversion3.3.
Py_MEMBER_SIZE(type,member)
Returnthesizeofastructure(type)memberinbytes.
Addedinversion3.6.
Py_MIN(x,y)
Returntheminimumvaluebetweenxandy.
Addedinversion3.3.
Py_NO_INLINE
Disableinliningonafunction. Forexample,itreducestheCstackconsumption: usefulonLTO+PGObuilds
whichheavilyinlinecode(seebpo-33720).
Usage:
Py_NO_INLINE static int random(void) { return 4; }
Addedinversion3.11.
Py_STRINGIFY(x)
ConvertxtoaCstring. E.g. Py_STRINGIFY(123)returns"123".
Addedinversion3.4.
Py_UNREACHABLE()
Usethiswhenyouhaveacodepaththatcannotbereachedbydesign. Forexample,inthedefault: clause
inaswitchstatementforwhichallpossiblevaluesarecoveredincasestatements. Usethisinplaceswhere
youmightbetemptedtoputanassert(0)orabort()call.
Inreleasemode,themacrohelpsthecompilertooptimizethecode,andavoidsawarningaboutunreachable
code. Forexample,themacroisimplementedwith__builtin_unreachable()onGCCinreleasemode.
A use for Py_UNREACHABLE() is following a call a function that never returns but that is not declared
_Py_NO_RETURN.
Ifacodepathisveryunlikelycodebutcanbereachedunderexceptionalcase,thismacromustnotbeused.
Forexample,underlowmemoryconditionorifasystemcallreturnsavalueoutoftheexpectedrange. Inthis
case,it’sbettertoreporttheerrortothecaller. Iftheerrorcannotbereportedtocaller,Py_FatalError()
canbeused.
Addedinversion3.7.
1.4. Usefulmacros 5

### 第14页

Py_UNUSED(arg)
Usethisforunusedargumentsinafunctiondefinitiontosilencecompilerwarnings. Example:int func(int
a, int Py_UNUSED(b)) { return a; }.
Addedinversion3.4.
PyDoc_STRVAR(name,str)
Createsavariablewithnamenamethatcanbeusedindocstrings. IfPythonisbuiltwithoutdocstrings,the
valuewillbeempty.
UsePyDoc_STRVARfordocstringstosupportbuildingPythonwithoutdocstrings,asspecifiedinPEP7.
Example:
PyDoc_STRVAR(pop_doc, "Remove and return the rightmost element.");
static PyMethodDef deque_methods[] = {
// ...
{"pop", (PyCFunction)deque_pop, METH_NOARGS, pop_doc},
// ...
}
PyDoc_STR(str)
Createsadocstringforthegiveninputstringoranemptystringifdocstringsaredisabled.
UsePyDoc_STRinspecifyingdocstringstosupportbuildingPythonwithoutdocstrings,asspecifiedinPEP
7.
Example:
static PyMethodDef pysqlite_row_methods[] = {
{"keys", (PyCFunction)pysqlite_row_keys, METH_NOARGS,
PyDoc_STR("Returns the keys of the row.")},
{NULL, NULL}
};
1.5 Objects, Types and Reference Counts
MostPython/CAPIfunctionshaveoneormoreargumentsaswellasareturnvalueoftypePyObject*. Thistype
isapointertoanopaquedatatyperepresentinganarbitraryPythonobject. SinceallPythonobjecttypesaretreated
the same way by the Python language in most situations (e.g., assignments, scope rules, and argument passing), it
is only fitting that they should be represented by a single C type. Almost all Python objects live on the heap: you
neverdeclareanautomaticorstaticvariableoftypePyObject,onlypointervariablesoftypePyObject*canbe
declared. The sole exception are the type objects; since these must never be deallocated, they are typically static
PyTypeObjectobjects.
AllPythonobjects(evenPythonintegers)haveatypeandareferencecount. Anobject’stypedetermineswhatkind
ofobjectitis(e.g.,aninteger,alist,orauser-definedfunction;therearemanymoreasexplainedintypes). Foreach
ofthewell-knowntypesthereisamacrotocheckwhetheranobjectisofthattype;forinstance,PyList_Check(a)
istrueif(andonlyif)theobjectpointedtobyaisaPythonlist.
1.5.1 Reference Counts
Thereferencecountisimportantbecausetoday’scomputershaveafinite(andoftenseverelylimited)memorysize;
itcountshowmanydifferentplacestherearethathaveastrongreferencetoanobject. Suchaplacecouldbeanother
object,oraglobal(orstatic)Cvariable,oralocalvariableinsomeCfunction. Whenthelaststrongreferencetoan
objectisreleased(i.e. itsreferencecountbecomeszero),theobjectisdeallocated. Ifitcontainsreferencestoother
objects,thosereferencesarereleased. Thoseotherobjectsmaybedeallocatedinturn,iftherearenomorereferences
tothem,andsoon. (There’sanobviousproblemwithobjectsthatreferenceeachotherhere;fornow,thesolutionis
“don’tdothat.”)
6 Chapter1. Introduction

### 第15页

Referencecountsarealwaysmanipulatedexplicitly. ThenormalwayistousethemacroPy_INCREF()totakeanew
referencetoanobject(i.e. incrementitsreferencecountbyone),andPy_DECREF()toreleasethatreference(i.e.
decrementthereferencecountbyone). ThePy_DECREF()macroisconsiderablymorecomplexthantheincrefone,
sinceitmustcheckwhetherthereferencecountbecomeszeroandthencausetheobject’sdeallocatortobecalled. The
deallocatorisafunctionpointercontainedintheobject’stypestructure. Thetype-specificdeallocatortakescareof
releasingreferencesforotherobjectscontainedintheobjectifthisisacompoundobjecttype,suchasalist,aswellas
performinganyadditionalfinalizationthat’sneeded. There’snochancethatthereferencecountcanoverflow;atleast
asmanybitsareusedtoholdthereferencecountastherearedistinctmemorylocationsinvirtualmemory(assuming
sizeof(Py_ssize_t) >= sizeof(void*)). Thus,thereferencecountincrementisasimpleoperation.
Itisnotnecessarytoholdastrongreference(i.e. incrementthereferencecount)foreverylocalvariablethatcontains
apointertoanobject. Intheory,theobject’sreferencecountgoesupbyonewhenthevariableismadetopointto
itanditgoesdownbyonewhenthevariablegoesoutofscope. However,thesetwocanceleachotherout,soatthe
endthereferencecounthasn’tchanged. Theonlyrealreasontousethereferencecountistopreventtheobjectfrom
beingdeallocatedaslongasourvariableispointingtoit. Ifweknowthatthereisatleastoneotherreferencetothe
objectthatlivesatleastaslongasourvariable, thereisnoneedtotakeanew strongreference(i.e. incrementthe
referencecount)temporarily. Animportantsituationwherethisarisesisinobjectsthatarepassedasargumentsto
CfunctionsinanextensionmodulethatarecalledfromPython;thecallmechanismguaranteestoholdareference
toeveryargumentforthedurationofthecall.
However, a common pitfall is to extract an object from a list and hold on to it for a while without taking a new
reference. Some other operation might conceivably remove the object from the list, releasing that reference, and
possiblydeallocatingit. Therealdangeristhatinnocent-lookingoperationsmayinvokearbitraryPythoncodewhich
coulddothis;thereisacodepathwhichallowscontroltoflowbacktotheuserfromaPy_DECREF(),soalmostany
operationispotentiallydangerous.
Asafeapproachistoalwaysusethegenericoperations(functionswhosenamebeginswithPyObject_,PyNumber_,
PySequence_orPyMapping_). Theseoperationsalwayscreateanewstrongreference(i.e. incrementthereference
count)oftheobjecttheyreturn. ThisleavesthecallerwiththeresponsibilitytocallPy_DECREF()whentheyare
donewiththeresult;thissoonbecomessecondnature.
ReferenceCountDetails
ThereferencecountbehavioroffunctionsinthePython/CAPIisbestexplainedintermsofownershipofreferences.
Ownership pertains to references, never to objects (objects are not owned: they are always shared). “Owning a
reference”meansbeingresponsibleforcallingPy_DECREFonitwhenthereferenceisnolongerneeded. Ownership
canalsobetransferred,meaningthatthecodethatreceivesownershipofthereferencethenbecomesresponsiblefor
eventuallyreleasingitbycallingPy_DECREF()orPy_XDECREF()whenit’snolongerneeded—orpassingonthis
responsibility (usually to its caller). When a function passes ownership of a reference on to its caller, the caller is
saidtoreceiveanewreference. Whennoownershipistransferred,thecallerissaidtoborrowthereference. Nothing
needstobedoneforaborrowedreference.
Conversely,whenacallingfunctionpassesinareferencetoanobject,therearetwopossibilities: thefunctionsteals
areferencetotheobject,oritdoesnot. Stealingareferencemeansthatwhenyoupassareferencetoafunction,that
functionassumesthatitnowownsthatreference,andyouarenotresponsibleforitanylonger.
Few functions steal references; the two notable exceptions are PyList_SetItem() and PyTuple_SetItem(),
which steal a reference to the item (but not to the tuple or list into which the item is put!). These functions were
designedtostealareferencebecauseofacommonidiomforpopulatingatupleorlistwithnewlycreatedobjects;for
example, thecodetocreatethetuple(1, 2, "three")couldlooklikethis(forgettingabouterrorhandlingfor
themoment;abetterwaytocodethisisshownbelow):
PyObject *t;
t = PyTuple_New(3);
PyTuple_SetItem(t, 0, PyLong_FromLong(1L));
PyTuple_SetItem(t, 1, PyLong_FromLong(2L));
PyTuple_SetItem(t, 2, PyUnicode_FromString("three"));
Here,PyLong_FromLong()returnsanewreferencewhichisimmediatelystolenbyPyTuple_SetItem(). When
you want to keep using an object although the reference to it will be stolen, use Py_INCREF() to grab another
1.5. Objects,TypesandReferenceCounts 7

### 第16页

referencebeforecallingthereference-stealingfunction.
Incidentally, PyTuple_SetItem() is the only way to set tuple items; PySequence_SetItem() and
PyObject_SetItem() refuse to do this since tuples are an immutable data type. You should only use
PyTuple_SetItem()fortuplesthatyouarecreatingyourself.
EquivalentcodeforpopulatingalistcanbewrittenusingPyList_New()andPyList_SetItem().
However, in practice, you will rarely use these ways of creating and populating a tuple or list. There’s a generic
function, Py_BuildValue(), that can create most common objects from C values, directed by a format string.
Forexample, theabovetwoblocksofcodecouldbe replacedbythefollowing(whichalsotakescareoftheerror
checking):
PyObject *tuple, *list;
tuple = Py_BuildValue("(iis)", 1, 2, "three");
list = Py_BuildValue("[iis]", 1, 2, "three");
It is much more common to use PyObject_SetItem() and friends with items whose references you are only
borrowing,likeargumentsthatwerepassedintothefunctionyouarewriting. Inthatcase,theirbehaviourregarding
referencesismuchsaner,sinceyoudon’thavetotakeanewreferencejustsoyoucangivethatreferenceaway(“have
itbestolen”). Forexample,thisfunctionsetsallitemsofalist(actually,anymutablesequence)toagivenitem:
int
set_all(PyObject *target, PyObject *item)
{
Py_ssize_t i, n;
n = PyObject_Length(target);
if (n < 0)
return -1;
for (i = 0; i < n; i++) {
PyObject *index = PyLong_FromSsize_t(i);
if (!index)
return -1;
if (PyObject_SetItem(target, index, item) < 0) {
Py_DECREF(index);
return -1;
}
Py_DECREF(index);
}
return 0;
}
The situation is slightly different for function return values. While passing a reference to most functions does not
changeyourownershipresponsibilitiesforthatreference,manyfunctionsthatreturnareferencetoanobjectgiveyou
ownershipofthereference. Thereasonissimple: inmanycases, thereturnedobjectiscreatedonthefly, andthe
referenceyougetistheonlyreferencetotheobject. Therefore,thegenericfunctionsthatreturnobjectreferences,
likePyObject_GetItem()andPySequence_GetItem(),alwaysreturnanewreference(thecallerbecomesthe
ownerofthereference).
Itisimportanttorealizethatwhetheryouownareferencereturnedbyafunctiondependsonwhichfunctionyoucall
only—theplumage(thetypeoftheobjectpassedasanargumenttothefunction)doesn’tenterintoit! Thus,ifyou
extractanitemfromalistusingPyList_GetItem(), youdon’townthereference—butifyouobtainthesame
itemfromthesamelistusingPySequence_GetItem()(whichhappenstotakeexactlythesamearguments),you
doownareferencetothereturnedobject.
Hereisanexampleofhowyoucouldwriteafunctionthatcomputesthesumoftheitemsinalistofintegers;once
usingPyList_GetItem(),andonceusingPySequence_GetItem().
8 Chapter1. Introduction

### 第17页

long
sum_list(PyObject *list)
{
Py_ssize_t i, n;
long total = 0, value;
PyObject *item;
n = PyList_Size(list);
if (n < 0)
return -1; /* Not a list */
for (i = 0; i < n; i++) {
item = PyList_GetItem(list, i); /* Can't fail */
if (!PyLong_Check(item)) continue; /* Skip non-integers */
value = PyLong_AsLong(item);
if (value == -1 && PyErr_Occurred())
/* Integer too big to fit in a C long, bail out */
return -1;
total += value;
}
return total;
}
long
sum_sequence(PyObject *sequence)
{
Py_ssize_t i, n;
long total = 0, value;
PyObject *item;
n = PySequence_Length(sequence);
if (n < 0)
return -1; /* Has no length */
for (i = 0; i < n; i++) {
item = PySequence_GetItem(sequence, i);
if (item == NULL)
return -1; /* Not a sequence, or other failure */
if (PyLong_Check(item)) {
value = PyLong_AsLong(item);
Py_DECREF(item);
if (value == -1 && PyErr_Occurred())
/* Integer too big to fit in a C long, bail out */
return -1;
total += value;
}
else {
Py_DECREF(item); /* Discard reference ownership */
}
}
return total;
}
1.5.2 Types
TherearefewotherdatatypesthatplayasignificantroleinthePython/CAPI;mostaresimpleCtypessuchasint,
long,doubleandchar*. Afewstructuretypesareusedtodescribestatictablesusedtolistthefunctionsexported
byamoduleorthedataattributesofanewobjecttype,andanotherisusedtodescribethevalueofacomplexnumber.
Thesewillbediscussedtogetherwiththefunctionsthatusethem.
1.5. Objects,TypesandReferenceCounts 9

### 第18页

typePy_ssize_t
Part of the Stable ABI. A signed integral type such that sizeof(Py_ssize_t) == sizeof(size_t).
C99 doesn’t define such a thing directly (size_t is an unsigned integral type). See PEP 353 for details.
PY_SSIZE_T_MAXisthelargestpositivevalueoftypePy_ssize_t.
1.6 Exceptions
ThePythonprogrammeronlyneedstodealwithexceptionsifspecificerrorhandlingisrequired;unhandledexcep-
tionsareautomaticallypropagatedto thecaller, thento thecaller’scaller, andso on, untiltheyreachthetop-level
interpreter,wheretheyarereportedtotheuseraccompaniedbyastacktraceback.
ForCprogrammers,however,errorcheckingalwayshastobeexplicit. AllfunctionsinthePython/CAPIcanraise
exceptions, unless an explicit claim is made otherwise in a function’s documentation. In general, when a function
encountersanerror,itsetsanexception,discardsanyobjectreferencesthatitowns,andreturnsanerrorindicator.
If not documented otherwise, this indicator is either NULL or -1, depending on the function’s return type. A few
functionsreturnaBooleantrue/falseresult,withfalseindicatinganerror. Veryfewfunctionsreturnnoexpliciterror
indicatororhaveanambiguousreturnvalue,andrequireexplicittestingforerrorswithPyErr_Occurred(). These
exceptionsarealwaysexplicitlydocumented.
Exceptionstateismaintainedinper-threadstorage(thisisequivalenttousingglobalstorageinanunthreadedappli-
cation). Athreadcanbeinoneoftwostates: anexceptionhasoccurred,ornot. ThefunctionPyErr_Occurred()
can be used to check for this: it returns a borrowed reference to the exception type object when an exception has
occurred,andNULLotherwise. Thereareanumberoffunctionstosettheexceptionstate: PyErr_SetString()
isthemostcommon(thoughnotthemostgeneral)functiontosettheexceptionstate,andPyErr_Clear()clears
theexceptionstate.
Thefullexceptionstateconsistsofthreeobjects(allofwhichcanbeNULL):theexceptiontype,thecorresponding
exception value, and the traceback. These have the same meanings as the Python result of sys.exc_info();
however,theyarenotthesame: thePythonobjectsrepresentthelastexceptionbeinghandledbyaPythontry…
except statement, while the C level exception state only exists while an exception is being passed on between C
functions until it reaches the Python bytecode interpreter’s main loop, which takes care of transferring it to sys.
exc_info()andfriends.
Note that starting with Python 1.5, the preferred, thread-safe way to access the exception state from Python code
istocallthefunctionsys.exc_info(), whichreturnstheper-threadexceptionstateforPythoncode. Also, the
semanticsofbothwaystoaccesstheexceptionstatehavechangedsothatafunctionwhichcatchesanexceptionwill
saveandrestoreitsthread’sexceptionstatesoastopreservetheexceptionstateofitscaller. Thispreventscommon
bugsinexceptionhandlingcodecausedbyaninnocent-lookingfunctionoverwritingtheexceptionbeinghandled;it
alsoreducestheoftenunwantedlifetimeextensionforobjectsthatarereferencedbythestackframesinthetraceback.
Asageneralprinciple,afunctionthatcallsanotherfunctiontoperformsometaskshouldcheckwhetherthecalled
functionraisedanexception,andifso,passtheexceptionstateontoitscaller. Itshoulddiscardanyobjectreferences
thatitowns,andreturnanerrorindicator,butitshouldnotsetanotherexception—thatwouldoverwritetheexception
thatwasjustraised,andloseimportantinformationabouttheexactcauseoftheerror.
Asimpleexampleofdetectingexceptionsandpassingthemonisshowninthesum_sequence()exampleabove.
Itsohappensthatthisexampledoesn’tneedtocleanupanyownedreferenceswhenitdetectsanerror. Thefollowing
example function shows some error cleanup. First, to remind you why you like Python, we show the equivalent
Pythoncode:
def incr_item(dict, key):
try:
item = dict[key]
except KeyError:
item = 0
dict[key] = item + 1
HereisthecorrespondingCcode,inallitsglory:
10 Chapter1. Introduction

### 第19页

int
incr_item(PyObject *dict, PyObject *key)
{
/* Objects all initialized to NULL for Py_XDECREF */
PyObject *item = NULL, *const_one = NULL, *incremented_item = NULL;
int rv = -1; /* Return value initialized to -1 (failure) */
item = PyObject_GetItem(dict, key);
if (item == NULL) {
/* Handle KeyError only: */
if (!PyErr_ExceptionMatches(PyExc_KeyError))
goto error;
/* Clear the error and use zero: */
PyErr_Clear();
item = PyLong_FromLong(0L);
if (item == NULL)
goto error;
}
const_one = PyLong_FromLong(1L);
if (const_one == NULL)
goto error;
incremented_item = PyNumber_Add(item, const_one);
if (incremented_item == NULL)
goto error;
if (PyObject_SetItem(dict, key, incremented_item) < 0)
goto error;
rv = 0; /* Success */
/* Continue with cleanup code */
error:
/* Cleanup code, shared by success and failure path */
/* Use Py_XDECREF() to ignore NULL references */
Py_XDECREF(item);
Py_XDECREF(const_one);
Py_XDECREF(incremented_item);
return rv; /* -1 for error, 0 for success */
}
This example represents an endorsed use of the goto statement in C! It illustrates the use of
PyErr_ExceptionMatches()andPyErr_Clear()tohandlespecificexceptions,andtheuseofPy_XDECREF()
to dispose of owned references that may be NULL (note the 'X' in the name; Py_DECREF() would crash when
confrontedwithaNULLreference). Itisimportantthatthevariablesusedtoholdownedreferencesareinitializedto
NULLforthistowork;likewise,theproposedreturnvalueisinitializedto-1(failure)andonlysettosuccessafter
thefinalcallmadeissuccessful.
1.7 Embedding Python
Theoneimportanttaskthatonlyembedders(asopposedtoextensionwriters)ofthePythoninterpreterhavetoworry
aboutistheinitialization,andpossiblythefinalization,ofthePythoninterpreter. Mostfunctionalityoftheinterpreter
canonlybeusedaftertheinterpreterhasbeeninitialized.
ThebasicinitializationfunctionisPy_Initialize(). Thisinitializesthetableofloadedmodules,andcreatesthe
1.7. EmbeddingPython 11

### 第20页

fundamentalmodulesbuiltins,__main__,andsys. Italsoinitializesthemodulesearchpath(sys.path).
Py_Initialize()doesnotsetthe“scriptargumentlist”(sys.argv). IfthisvariableisneededbyPythoncodethat
willbeexecutedlater,settingPyConfig.argvandPyConfig.parse_argvmustbeset: seePythonInitialization
Configuration.
On most systems (in particular, on Unix and Windows, although the details are slightly different),
Py_Initialize() calculates the module search path based upon its best guess for the location of the standard
Python interpreter executable, assuming that the Python library is found in a fixed location relative to the Python
interpreterexecutable. Inparticular,itlooksforadirectorynamedlib/pythonX.Yrelativetotheparentdirectory
wheretheexecutablenamedpythonisfoundontheshellcommandsearchpath(theenvironmentvariablePATH).
Forinstance,ifthePythonexecutableisfoundin/usr/local/bin/python,itwillassumethatthelibrariesarein
/usr/local/lib/pythonX.Y.(Infact,thisparticularpathisalsothe“fallback”location,usedwhennoexecutable
filenamedpythonisfoundalongPATH.)Theusercanoverridethisbehaviorbysettingtheenvironmentvariable
PYTHONHOME,orinsertadditionaldirectoriesinfrontofthestandardpathbysettingPYTHONPATH.
The embedding application can steer the search by setting PyConfig.program_name before calling
Py_InitializeFromConfig(). Note that PYTHONHOME still overrides this and PYTHONPATH is still inserted
in front of the standard path. An application that requires total control has to provide its own implementation of
Py_GetPath(),Py_GetPrefix(),Py_GetExecPrefix(),andPy_GetProgramFullPath()(alldefinedin
Modules/getpath.c).
Sometimes,itisdesirableto“uninitialize”Python. Forinstance,theapplicationmaywanttostartover(makeanother
calltoPy_Initialize())ortheapplicationissimplydonewithitsuseofPythonandwantstofreememoryallo-
catedbyPython. ThiscanbeaccomplishedbycallingPy_FinalizeEx(). ThefunctionPy_IsInitialized()
returnstrueifPythoniscurrentlyintheinitializedstate. Moreinformationaboutthesefunctionsisgiveninalater
chapter. NoticethatPy_FinalizeEx()doesnotfreeallmemoryallocatedbythePythoninterpreter,e.g. memory
allocatedbyextensionmodulescurrentlycannotbereleased.
1.8 Debugging Builds
Python can be built with several macros to enable extra checks of the interpreter and extension modules. These
checkstendtoaddalargeamountofoverheadtotheruntimesotheyarenotenabledbydefault.
AfulllistofthevarioustypesofdebuggingbuildsisinthefileMisc/SpecialBuilds.txtinthePythonsource
distribution. Buildsareavailablethatsupporttracingofreferencecounts,debuggingthememoryallocator,orlow-
levelprofilingofthemaininterpreterloop. Onlythemostfrequentlyusedbuildswillbedescribedintheremainder
ofthissection.
Py_DEBUG
CompilingtheinterpreterwiththePy_DEBUGmacrodefinedproduceswhatisgenerallymeantbyadebugbuildof
Python. Py_DEBUGisenabledintheUnixbuildbyadding--with-pydebugtothe./configurecommand. It
isalsoimpliedbythepresenceofthenot-Python-specific_DEBUGmacro. WhenPy_DEBUGisenabledintheUnix
build,compileroptimizationisdisabled.
Inadditiontothereferencecountdebuggingdescribedbelow,extrachecksareperformed,seePythonDebugBuild.
DefiningPy_TRACE_REFSenablesreferencetracing(seetheconfigure --with-trace-refs option). When
defined,acirculardoublylinkedlistofactiveobjectsismaintainedbyaddingtwoextrafieldstoeveryPyObject.
Totalallocationsaretrackedaswell. Uponexit,allexistingreferencesareprinted. (Ininteractivemodethishappens
aftereverystatementrunbytheinterpreter.)
PleaserefertoMisc/SpecialBuilds.txtinthePythonsourcedistributionformoredetailedinformation.
1.9 Recommended third party tools
ThefollowingthirdpartytoolsofferbothsimplerandmoresophisticatedapproachestocreatingC,C++andRust
extensionsforPython:
• Cython
12 Chapter1. Introduction

### 第21页

• cffi
• HPy
• nanobind(C++)
• Numba
• pybind11(C++)
• PyO3(Rust)
• SWIG
UsingtoolssuchasthesecanhelpavoidwritingcodethatistightlyboundtoaparticularversionofCPython,avoid
referencecountingerrors, andfocusmoreonyourowncodethanonusingtheCPythonAPI.Ingeneral, newver-
sionsofPythoncanbesupportedbyupdatingthetool,andyourcodewilloftenusenewerandmoreefficientAPIs
automatically. SometoolsalsosupportcompilingforotherimplementationsofPythonfromasinglesetofsources.
These projects are not supported by the same people who maintain Python, and issues need to be raised with the
projectsdirectly. Remembertocheckthattheprojectisstillmaintainedandsupported,asthelistabovemaybecome
outdated.
(cid:181) Seealso
PythonPackagingUserGuide: BinaryExtensions
ThePythonPackagingUserGuidenotonlycoversseveralavailabletoolsthatsimplifythecreationofbinary
extensions, butalsodiscussesthevariousreasonswhycreatinganextensionmodulemaybedesirablein
thefirstplace.
1.9. Recommendedthirdpartytools 13

| (cid:181) Seealso |
| --- |
| PythonPackagingUserGuide: BinaryExtensions
ThePythonPackagingUserGuidenotonlycoversseveralavailabletoolsthatsimplifythecreationofbinary
extensions, butalsodiscussesthevariousreasonswhycreatinganextensionmodulemaybedesirablein
thefirstplace. |

### 第22页

14 Chapter1. Introduction

### 第23页

CHAPTER
TWO
C API STABILITY
Unlessdocumentedotherwise,Python’sCAPIiscoveredbytheBackwardsCompatibilityPolicy,PEP387. Most
changestoitaresource-compatible(typicallybyonlyaddingnewAPI).ChangingexistingAPIorremovingAPIis
onlydoneafteradeprecationperiodortofixseriousissues.
CPython’sApplicationBinaryInterface(ABI)isforward-andbackwards-compatibleacrossaminorrelease(ifthese
arecompiledthesameway;seePlatformConsiderationsbelow). So,codecompiledforPython3.10.0willworkon
3.10.8andviceversa,butwillneedtobecompiledseparatelyfor3.9.xand3.11.x.
TherearetwotiersofCAPIwithdifferentstabilityexpectations:
• UnstableAPI,maychangeinminorversionswithoutadeprecationperiod. ItismarkedbythePyUnstable
prefixinnames.
• LimitedAPI,iscompatibleacrossseveralminorreleases. WhenPy_LIMITED_APIisdefined,onlythissubset
isexposedfromPython.h.
Thesearediscussedinmoredetailbelow.
Namesprefixedbyanunderscore, suchas_Py_InternalState, areprivateAPIthatcanchangewithoutnotice
eveninpatchreleases. IfyouneedtousethisAPI,considerreachingouttoCPythondeveloperstodiscussadding
publicAPIforyourusecase.
2.1 Unstable C API
Any API named with the PyUnstable prefix exposes CPython implementation details, and may change in every
minor release (e.g. from 3.9 to 3.10) without any deprecation warnings. However, it will not change in a bugfix
release(e.g. from3.10.0to3.10.1).
Itisgenerallyintendedforspecialized,low-leveltoolslikedebuggers.
ProjectsthatusethisAPIareexpectedtofollowCPythondevelopmentandspendextraeffortadjustingtochanges.
2.2 Stable Application Binary Interface
Forsimplicity,thisdocumenttalksaboutextensions,buttheLimitedAPIandStableABIworkthesamewayforall
usesoftheAPI–forexample,embeddingPython.
2.2.1 Limited C API
Python3.2introducedtheLimitedAPI,asubsetofPython’sCAPI.ExtensionsthatonlyusetheLimitedAPIcanbe
compiledonceandbeloadedonmultipleversionsofPython. ContentsoftheLimitedAPIarelistedbelow.
Py_LIMITED_API
DefinethismacrobeforeincludingPython.htooptintoonlyusetheLimitedAPI,andtoselecttheLimited
APIversion.
DefinePy_LIMITED_APItothevalueofPY_VERSION_HEXcorrespondingtothelowestPythonversionyour
extensionsupports. TheextensionwillbeABI-compatiblewithallPython3releasesfromthespecifiedone
onward,andcanuseLimitedAPIintroduceduptothatversion.
15

### 第24页

Rather than using the PY_VERSION_HEX macro directly, hardcode a minimum minor version (e.g.
0x030A0000forPython3.10)forstabilitywhencompilingwithfuturePythonversions.
YoucanalsodefinePy_LIMITED_APIto3. Thisworksthesameas0x03020000(Python3.2,theversion
thatintroducedLimitedAPI).
2.2.2 Stable ABI
Toenablethis,PythonprovidesaStableABI:asetofsymbolsthatwillremainABI-compatibleacrossPython3.x
versions.
(cid:174) Note
TheStableABIpreventsABIissues,likelinkererrorsduetomissingsymbolsordatacorruptionduetochangesin
structurelayoutsorfunctionsignatures. However,otherchangesinPythoncanchangethebehaviorofextensions.
SeePython’sBackwardsCompatibilityPolicy(PEP387)fordetails.
TheStableABIcontainssymbolsexposedintheLimitedAPI,butalsootherones–forexample,functionsnecessary
tosupportolderversionsoftheLimitedAPI.
OnWindows,extensionsthatusetheStableABIshouldbelinkedagainstpython3.dllratherthanaversion-specific
librarysuchaspython39.dll.
Onsomeplatforms, Pythonwilllookforandloadsharedlibraryfilesnamedwiththeabi3tag(e.g. mymodule.
abi3.so). ItdoesnotcheckifsuchextensionsconformtoaStableABI.Theuser(ortheirpackagingtools)needto
ensurethat,forexample,extensionsbuiltwiththe3.10+LimitedAPIarenotinstalledforlowerversionsofPython.
AllfunctionsintheStableABIarepresentasfunctionsinPython’ssharedlibrary,notsolelyasmacros. Thismakes
themusablefromlanguagesthatdon’tusetheCpreprocessor.
2.2.3 Limited API Scope and Performance
ThegoalfortheLimitedAPIistoalloweverythingthatispossiblewiththefullCAPI,butpossiblywithaperfor-
mancepenalty.
Forexample,whilePyList_GetItem()isavailable,its“unsafe”macrovariantPyList_GET_ITEM()isnot. The
macrocanbefasterbecauseitcanrelyonversion-specificimplementationdetailsofthelistobject.
Without Py_LIMITED_API defined, some C API functions are inlined or replaced by macros. Defining
Py_LIMITED_API disables this inlining, allowing stability as Python’s data structures are improved, but possibly
reducingperformance.
ByleavingoutthePy_LIMITED_APIdefinition,itispossibletocompileaLimitedAPIextensionwithaversion-
specificABI.ThiscanimproveperformanceforthatPythonversion, butwilllimitcompatibility. Compilingwith
Py_LIMITED_APIwillthenyieldanextensionthatcanbedistributedwhereaversion-specificoneisnotavailable
–forexample,forprereleasesofanupcomingPythonversion.
2.2.4 Limited API Caveats
NotethatcompilingwithPy_LIMITED_APIisnot acompleteguaranteethatcodeconformstotheLimitedAPI or
theStableABI.Py_LIMITED_APIonlycoversdefinitions,butanAPIalsoincludesotherissues,suchasexpected
semantics.
Oneissuethat Py_LIMITED_API doesnotguard againstiscalling a functionwith argumentsthatareinvalid ina
lowerPythonversion. Forexample,considerafunctionthatstartsacceptingNULLforanargument. InPython3.9,
NULLnowselectsadefaultbehavior,butinPython3.8,theargumentwillbeuseddirectly,causingaNULLdereference
andcrash. Asimilarargumentworksforfieldsofstructs.
Another issue is that some struct fields are currently not hidden when Py_LIMITED_API is defined, even though
they’repartoftheLimitedAPI.
16 Chapter2. CAPIStability

### 第25页

Forthesereasons,werecommendtestinganextensionwithallminorPythonversionsitsupports,andpreferablyto
buildwiththelowestsuchversion.
WealsorecommendreviewingdocumentationofallusedAPItocheckifitisexplicitlypartoftheLimitedAPI.Even
withPy_LIMITED_APIdefined,afewprivatedeclarationsareexposedfortechnicalreasons(orevenunintentionally,
asbugs).
AlsonotethattheLimitedAPIisnotnecessarilystable: compilingwithPy_LIMITED_APIwithPython3.8means
thattheextensionwillrunwithPython3.12,butitwillnotnecessarilycompilewithPython3.12. Inparticular,parts
oftheLimitedAPImaybedeprecatedandremoved,providedthattheStableABIstaysstable.
2.3 Platform Considerations
ABIstabilitydependsnotonlyonPython,butalsoonthecompilerused,lower-levellibrariesandcompileroptions.
For the purposes of the Stable ABI, these details define a “platform”. They usually depend on the OS type and
processorarchitecture
It is the responsibility of each particular distributor of Python to ensure that all Python versions on a particular
platformarebuiltinawaythatdoesnotbreaktheStableABI.ThisisthecasewithWindowsandmacOSreleases
frompython.organdmanythird-partydistributors.
2.4 Contents of Limited API
Currently,theLimitedAPI includesthefollowingitems:
• PY_VECTORCALL_ARGUMENTS_OFFSET
• PyAIter_Check()
• PyArg_Parse()
• PyArg_ParseTuple()
• PyArg_ParseTupleAndKeywords()
• PyArg_UnpackTuple()
• PyArg_VaParse()
• PyArg_VaParseTupleAndKeywords()
• PyArg_ValidateKeywordArguments()
• PyBaseObject_Type
• PyBool_FromLong()
• PyBool_Type
• PyBuffer_FillContiguousStrides()
• PyBuffer_FillInfo()
• PyBuffer_FromContiguous()
• PyBuffer_GetPointer()
• PyBuffer_IsContiguous()
• PyBuffer_Release()
• PyBuffer_SizeFromFormat()
• PyBuffer_ToContiguous()
• PyByteArrayIter_Type
• PyByteArray_AsString()
2.3. PlatformConsiderations 17

### 第26页

• PyByteArray_Concat()
• PyByteArray_FromObject()
• PyByteArray_FromStringAndSize()
• PyByteArray_Resize()
• PyByteArray_Size()
• PyByteArray_Type
• PyBytesIter_Type
• PyBytes_AsString()
• PyBytes_AsStringAndSize()
• PyBytes_Concat()
• PyBytes_ConcatAndDel()
• PyBytes_DecodeEscape()
• PyBytes_FromFormat()
• PyBytes_FromFormatV()
• PyBytes_FromObject()
• PyBytes_FromString()
• PyBytes_FromStringAndSize()
• PyBytes_Repr()
• PyBytes_Size()
• PyBytes_Type
• PyCFunction
• PyCFunctionFast
• PyCFunctionFastWithKeywords
• PyCFunctionWithKeywords
• PyCFunction_GetFlags()
• PyCFunction_GetFunction()
• PyCFunction_GetSelf()
• PyCFunction_New()
• PyCFunction_NewEx()
• PyCFunction_Type
• PyCMethod_New()
• PyCallIter_New()
• PyCallIter_Type
• PyCallable_Check()
• PyCapsule_Destructor
• PyCapsule_GetContext()
• PyCapsule_GetDestructor()
• PyCapsule_GetName()
• PyCapsule_GetPointer()
18 Chapter2. CAPIStability

### 第27页

• PyCapsule_Import()
• PyCapsule_IsValid()
• PyCapsule_New()
• PyCapsule_SetContext()
• PyCapsule_SetDestructor()
• PyCapsule_SetName()
• PyCapsule_SetPointer()
• PyCapsule_Type
• PyClassMethodDescr_Type
• PyCodec_BackslashReplaceErrors()
• PyCodec_Decode()
• PyCodec_Decoder()
• PyCodec_Encode()
• PyCodec_Encoder()
• PyCodec_IgnoreErrors()
• PyCodec_IncrementalDecoder()
• PyCodec_IncrementalEncoder()
• PyCodec_KnownEncoding()
• PyCodec_LookupError()
• PyCodec_NameReplaceErrors()
• PyCodec_Register()
• PyCodec_RegisterError()
• PyCodec_ReplaceErrors()
• PyCodec_StreamReader()
• PyCodec_StreamWriter()
• PyCodec_StrictErrors()
• PyCodec_Unregister()
• PyCodec_XMLCharRefReplaceErrors()
• PyComplex_FromDoubles()
• PyComplex_ImagAsDouble()
• PyComplex_RealAsDouble()
• PyComplex_Type
• PyDescr_NewClassMethod()
• PyDescr_NewGetSet()
• PyDescr_NewMember()
• PyDescr_NewMethod()
• PyDictItems_Type
• PyDictIterItem_Type
• PyDictIterKey_Type
2.4. ContentsofLimitedAPI 19

### 第28页

• PyDictIterValue_Type
• PyDictKeys_Type
• PyDictProxy_New()
• PyDictProxy_Type
• PyDictRevIterItem_Type
• PyDictRevIterKey_Type
• PyDictRevIterValue_Type
• PyDictValues_Type
• PyDict_Clear()
• PyDict_Contains()
• PyDict_Copy()
• PyDict_DelItem()
• PyDict_DelItemString()
• PyDict_GetItem()
• PyDict_GetItemRef()
• PyDict_GetItemString()
• PyDict_GetItemStringRef()
• PyDict_GetItemWithError()
• PyDict_Items()
• PyDict_Keys()
• PyDict_Merge()
• PyDict_MergeFromSeq2()
• PyDict_New()
• PyDict_Next()
• PyDict_SetItem()
• PyDict_SetItemString()
• PyDict_Size()
• PyDict_Type
• PyDict_Update()
• PyDict_Values()
• PyEllipsis_Type
• PyEnum_Type
• PyErr_BadArgument()
• PyErr_BadInternalCall()
• PyErr_CheckSignals()
• PyErr_Clear()
• PyErr_Display()
• PyErr_DisplayException()
• PyErr_ExceptionMatches()
20 Chapter2. CAPIStability

### 第29页

• PyErr_Fetch()
• PyErr_Format()
• PyErr_FormatV()
• PyErr_GetExcInfo()
• PyErr_GetHandledException()
• PyErr_GetRaisedException()
• PyErr_GivenExceptionMatches()
• PyErr_NewException()
• PyErr_NewExceptionWithDoc()
• PyErr_NoMemory()
• PyErr_NormalizeException()
• PyErr_Occurred()
• PyErr_Print()
• PyErr_PrintEx()
• PyErr_ProgramText()
• PyErr_ResourceWarning()
• PyErr_Restore()
• PyErr_SetExcFromWindowsErr()
• PyErr_SetExcFromWindowsErrWithFilename()
• PyErr_SetExcFromWindowsErrWithFilenameObject()
• PyErr_SetExcFromWindowsErrWithFilenameObjects()
• PyErr_SetExcInfo()
• PyErr_SetFromErrno()
• PyErr_SetFromErrnoWithFilename()
• PyErr_SetFromErrnoWithFilenameObject()
• PyErr_SetFromErrnoWithFilenameObjects()
• PyErr_SetFromWindowsErr()
• PyErr_SetFromWindowsErrWithFilename()
• PyErr_SetHandledException()
• PyErr_SetImportError()
• PyErr_SetImportErrorSubclass()
• PyErr_SetInterrupt()
• PyErr_SetInterruptEx()
• PyErr_SetNone()
• PyErr_SetObject()
• PyErr_SetRaisedException()
• PyErr_SetString()
• PyErr_SyntaxLocation()
• PyErr_SyntaxLocationEx()
2.4. ContentsofLimitedAPI 21

### 第30页

• PyErr_WarnEx()
• PyErr_WarnExplicit()
• PyErr_WarnFormat()
• PyErr_WriteUnraisable()
• PyEval_AcquireThread()
• PyEval_EvalCode()
• PyEval_EvalCodeEx()
• PyEval_EvalFrame()
• PyEval_EvalFrameEx()
• PyEval_GetBuiltins()
• PyEval_GetFrame()
• PyEval_GetFrameBuiltins()
• PyEval_GetFrameGlobals()
• PyEval_GetFrameLocals()
• PyEval_GetFuncDesc()
• PyEval_GetFuncName()
• PyEval_GetGlobals()
• PyEval_GetLocals()
• PyEval_InitThreads()
• PyEval_ReleaseThread()
• PyEval_RestoreThread()
• PyEval_SaveThread()
• PyExc_ArithmeticError
• PyExc_AssertionError
• PyExc_AttributeError
• PyExc_BaseException
• PyExc_BaseExceptionGroup
• PyExc_BlockingIOError
• PyExc_BrokenPipeError
• PyExc_BufferError
• PyExc_BytesWarning
• PyExc_ChildProcessError
• PyExc_ConnectionAbortedError
• PyExc_ConnectionError
• PyExc_ConnectionRefusedError
• PyExc_ConnectionResetError
• PyExc_DeprecationWarning
• PyExc_EOFError
• PyExc_EncodingWarning
22 Chapter2. CAPIStability

### 第31页

• PyExc_EnvironmentError
• PyExc_Exception
• PyExc_FileExistsError
• PyExc_FileNotFoundError
• PyExc_FloatingPointError
• PyExc_FutureWarning
• PyExc_GeneratorExit
• PyExc_IOError
• PyExc_ImportError
• PyExc_ImportWarning
• PyExc_IndentationError
• PyExc_IndexError
• PyExc_InterruptedError
• PyExc_IsADirectoryError
• PyExc_KeyError
• PyExc_KeyboardInterrupt
• PyExc_LookupError
• PyExc_MemoryError
• PyExc_ModuleNotFoundError
• PyExc_NameError
• PyExc_NotADirectoryError
• PyExc_NotImplementedError
• PyExc_OSError
• PyExc_OverflowError
• PyExc_PendingDeprecationWarning
• PyExc_PermissionError
• PyExc_ProcessLookupError
• PyExc_RecursionError
• PyExc_ReferenceError
• PyExc_ResourceWarning
• PyExc_RuntimeError
• PyExc_RuntimeWarning
• PyExc_StopAsyncIteration
• PyExc_StopIteration
• PyExc_SyntaxError
• PyExc_SyntaxWarning
• PyExc_SystemError
• PyExc_SystemExit
• PyExc_TabError
2.4. ContentsofLimitedAPI 23

### 第32页

• PyExc_TimeoutError
• PyExc_TypeError
• PyExc_UnboundLocalError
• PyExc_UnicodeDecodeError
• PyExc_UnicodeEncodeError
• PyExc_UnicodeError
• PyExc_UnicodeTranslateError
• PyExc_UnicodeWarning
• PyExc_UserWarning
• PyExc_ValueError
• PyExc_Warning
• PyExc_WindowsError
• PyExc_ZeroDivisionError
• PyExceptionClass_Name()
• PyException_GetArgs()
• PyException_GetCause()
• PyException_GetContext()
• PyException_GetTraceback()
• PyException_SetArgs()
• PyException_SetCause()
• PyException_SetContext()
• PyException_SetTraceback()
• PyFile_FromFd()
• PyFile_GetLine()
• PyFile_WriteObject()
• PyFile_WriteString()
• PyFilter_Type
• PyFloat_AsDouble()
• PyFloat_FromDouble()
• PyFloat_FromString()
• PyFloat_GetInfo()
• PyFloat_GetMax()
• PyFloat_GetMin()
• PyFloat_Type
• PyFrameObject
• PyFrame_GetCode()
• PyFrame_GetLineNumber()
• PyFrozenSet_New()
• PyFrozenSet_Type
24 Chapter2. CAPIStability

### 第33页

• PyGC_Collect()
• PyGC_Disable()
• PyGC_Enable()
• PyGC_IsEnabled()
• PyGILState_Ensure()
• PyGILState_GetThisThreadState()
• PyGILState_Release()
• PyGILState_STATE
• PyGetSetDef
• PyGetSetDescr_Type
• PyImport_AddModule()
• PyImport_AddModuleObject()
• PyImport_AddModuleRef()
• PyImport_AppendInittab()
• PyImport_ExecCodeModule()
• PyImport_ExecCodeModuleEx()
• PyImport_ExecCodeModuleObject()
• PyImport_ExecCodeModuleWithPathnames()
• PyImport_GetImporter()
• PyImport_GetMagicNumber()
• PyImport_GetMagicTag()
• PyImport_GetModule()
• PyImport_GetModuleDict()
• PyImport_Import()
• PyImport_ImportFrozenModule()
• PyImport_ImportFrozenModuleObject()
• PyImport_ImportModule()
• PyImport_ImportModuleLevel()
• PyImport_ImportModuleLevelObject()
• PyImport_ImportModuleNoBlock()
• PyImport_ReloadModule()
• PyIndex_Check()
• PyInterpreterState
• PyInterpreterState_Clear()
• PyInterpreterState_Delete()
• PyInterpreterState_Get()
• PyInterpreterState_GetDict()
• PyInterpreterState_GetID()
• PyInterpreterState_New()
2.4. ContentsofLimitedAPI 25

### 第34页

• PyIter_Check()
• PyIter_Next()
• PyIter_NextItem()
• PyIter_Send()
• PyListIter_Type
• PyListRevIter_Type
• PyList_Append()
• PyList_AsTuple()
• PyList_GetItem()
• PyList_GetItemRef()
• PyList_GetSlice()
• PyList_Insert()
• PyList_New()
• PyList_Reverse()
• PyList_SetItem()
• PyList_SetSlice()
• PyList_Size()
• PyList_Sort()
• PyList_Type
• PyLongObject
• PyLongRangeIter_Type
• PyLong_AsDouble()
• PyLong_AsInt()
• PyLong_AsInt32()
• PyLong_AsInt64()
• PyLong_AsLong()
• PyLong_AsLongAndOverflow()
• PyLong_AsLongLong()
• PyLong_AsLongLongAndOverflow()
• PyLong_AsNativeBytes()
• PyLong_AsSize_t()
• PyLong_AsSsize_t()
• PyLong_AsUInt32()
• PyLong_AsUInt64()
• PyLong_AsUnsignedLong()
• PyLong_AsUnsignedLongLong()
• PyLong_AsUnsignedLongLongMask()
• PyLong_AsUnsignedLongMask()
• PyLong_AsVoidPtr()
26 Chapter2. CAPIStability

### 第35页

• PyLong_FromDouble()
• PyLong_FromInt32()
• PyLong_FromInt64()
• PyLong_FromLong()
• PyLong_FromLongLong()
• PyLong_FromNativeBytes()
• PyLong_FromSize_t()
• PyLong_FromSsize_t()
• PyLong_FromString()
• PyLong_FromUInt32()
• PyLong_FromUInt64()
• PyLong_FromUnsignedLong()
• PyLong_FromUnsignedLongLong()
• PyLong_FromUnsignedNativeBytes()
• PyLong_FromVoidPtr()
• PyLong_GetInfo()
• PyLong_Type
• PyMap_Type
• PyMapping_Check()
• PyMapping_GetItemString()
• PyMapping_GetOptionalItem()
• PyMapping_GetOptionalItemString()
• PyMapping_HasKey()
• PyMapping_HasKeyString()
• PyMapping_HasKeyStringWithError()
• PyMapping_HasKeyWithError()
• PyMapping_Items()
• PyMapping_Keys()
• PyMapping_Length()
• PyMapping_SetItemString()
• PyMapping_Size()
• PyMapping_Values()
• PyMem_Calloc()
• PyMem_Free()
• PyMem_Malloc()
• PyMem_RawCalloc()
• PyMem_RawFree()
• PyMem_RawMalloc()
• PyMem_RawRealloc()
2.4. ContentsofLimitedAPI 27

### 第36页

• PyMem_Realloc()
• PyMemberDef
• PyMemberDescr_Type
• PyMember_GetOne()
• PyMember_SetOne()
• PyMemoryView_FromBuffer()
• PyMemoryView_FromMemory()
• PyMemoryView_FromObject()
• PyMemoryView_GetContiguous()
• PyMemoryView_Type
• PyMethodDef
• PyMethodDescr_Type
• PyModuleDef
• PyModuleDef_Base
• PyModuleDef_Init()
• PyModuleDef_Type
• PyModule_Add()
• PyModule_AddFunctions()
• PyModule_AddIntConstant()
• PyModule_AddObject()
• PyModule_AddObjectRef()
• PyModule_AddStringConstant()
• PyModule_AddType()
• PyModule_Create2()
• PyModule_ExecDef()
• PyModule_FromDefAndSpec2()
• PyModule_GetDef()
• PyModule_GetDict()
• PyModule_GetFilename()
• PyModule_GetFilenameObject()
• PyModule_GetName()
• PyModule_GetNameObject()
• PyModule_GetState()
• PyModule_New()
• PyModule_NewObject()
• PyModule_SetDocString()
• PyModule_Type
• PyNumber_Absolute()
• PyNumber_Add()
28 Chapter2. CAPIStability

### 第37页

• PyNumber_And()
• PyNumber_AsSsize_t()
• PyNumber_Check()
• PyNumber_Divmod()
• PyNumber_Float()
• PyNumber_FloorDivide()
• PyNumber_InPlaceAdd()
• PyNumber_InPlaceAnd()
• PyNumber_InPlaceFloorDivide()
• PyNumber_InPlaceLshift()
• PyNumber_InPlaceMatrixMultiply()
• PyNumber_InPlaceMultiply()
• PyNumber_InPlaceOr()
• PyNumber_InPlacePower()
• PyNumber_InPlaceRemainder()
• PyNumber_InPlaceRshift()
• PyNumber_InPlaceSubtract()
• PyNumber_InPlaceTrueDivide()
• PyNumber_InPlaceXor()
• PyNumber_Index()
• PyNumber_Invert()
• PyNumber_Long()
• PyNumber_Lshift()
• PyNumber_MatrixMultiply()
• PyNumber_Multiply()
• PyNumber_Negative()
• PyNumber_Or()
• PyNumber_Positive()
• PyNumber_Power()
• PyNumber_Remainder()
• PyNumber_Rshift()
• PyNumber_Subtract()
• PyNumber_ToBase()
• PyNumber_TrueDivide()
• PyNumber_Xor()
• PyOS_AfterFork()
• PyOS_AfterFork_Child()
• PyOS_AfterFork_Parent()
• PyOS_BeforeFork()
2.4. ContentsofLimitedAPI 29

### 第38页

• PyOS_CheckStack()
• PyOS_FSPath()
• PyOS_InputHook
• PyOS_InterruptOccurred()
• PyOS_double_to_string()
• PyOS_getsig()
• PyOS_mystricmp()
• PyOS_mystrnicmp()
• PyOS_setsig()
• PyOS_sighandler_t
• PyOS_snprintf()
• PyOS_string_to_double()
• PyOS_strtol()
• PyOS_strtoul()
• PyOS_vsnprintf()
• PyObject
• PyObject.ob_refcnt
• PyObject.ob_type
• PyObject_ASCII()
• PyObject_AsFileDescriptor()
• PyObject_Bytes()
• PyObject_Call()
• PyObject_CallFunction()
• PyObject_CallFunctionObjArgs()
• PyObject_CallMethod()
• PyObject_CallMethodObjArgs()
• PyObject_CallNoArgs()
• PyObject_CallObject()
• PyObject_Calloc()
• PyObject_CheckBuffer()
• PyObject_ClearWeakRefs()
• PyObject_CopyData()
• PyObject_DelAttr()
• PyObject_DelAttrString()
• PyObject_DelItem()
• PyObject_DelItemString()
• PyObject_Dir()
• PyObject_Format()
• PyObject_Free()
30 Chapter2. CAPIStability

### 第39页

• PyObject_GC_Del()
• PyObject_GC_IsFinalized()
• PyObject_GC_IsTracked()
• PyObject_GC_Track()
• PyObject_GC_UnTrack()
• PyObject_GenericGetAttr()
• PyObject_GenericGetDict()
• PyObject_GenericSetAttr()
• PyObject_GenericSetDict()
• PyObject_GetAIter()
• PyObject_GetAttr()
• PyObject_GetAttrString()
• PyObject_GetBuffer()
• PyObject_GetItem()
• PyObject_GetIter()
• PyObject_GetOptionalAttr()
• PyObject_GetOptionalAttrString()
• PyObject_GetTypeData()
• PyObject_HasAttr()
• PyObject_HasAttrString()
• PyObject_HasAttrStringWithError()
• PyObject_HasAttrWithError()
• PyObject_Hash()
• PyObject_HashNotImplemented()
• PyObject_Init()
• PyObject_InitVar()
• PyObject_IsInstance()
• PyObject_IsSubclass()
• PyObject_IsTrue()
• PyObject_Length()
• PyObject_Malloc()
• PyObject_Not()
• PyObject_Realloc()
• PyObject_Repr()
• PyObject_RichCompare()
• PyObject_RichCompareBool()
• PyObject_SelfIter()
• PyObject_SetAttr()
• PyObject_SetAttrString()
2.4. ContentsofLimitedAPI 31

### 第40页

• PyObject_SetItem()
• PyObject_Size()
• PyObject_Str()
• PyObject_Type()
• PyObject_Vectorcall()
• PyObject_VectorcallMethod()
• PyProperty_Type
• PyRangeIter_Type
• PyRange_Type
• PyReversed_Type
• PySeqIter_New()
• PySeqIter_Type
• PySequence_Check()
• PySequence_Concat()
• PySequence_Contains()
• PySequence_Count()
• PySequence_DelItem()
• PySequence_DelSlice()
• PySequence_Fast()
• PySequence_GetItem()
• PySequence_GetSlice()
• PySequence_In()
• PySequence_InPlaceConcat()
• PySequence_InPlaceRepeat()
• PySequence_Index()
• PySequence_Length()
• PySequence_List()
• PySequence_Repeat()
• PySequence_SetItem()
• PySequence_SetSlice()
• PySequence_Size()
• PySequence_Tuple()
• PySetIter_Type
• PySet_Add()
• PySet_Clear()
• PySet_Contains()
• PySet_Discard()
• PySet_New()
• PySet_Pop()
32 Chapter2. CAPIStability

### 第41页

• PySet_Size()
• PySet_Type
• PySlice_AdjustIndices()
• PySlice_GetIndices()
• PySlice_GetIndicesEx()
• PySlice_New()
• PySlice_Type
• PySlice_Unpack()
• PyState_AddModule()
• PyState_FindModule()
• PyState_RemoveModule()
• PyStructSequence_Desc
• PyStructSequence_Field
• PyStructSequence_GetItem()
• PyStructSequence_New()
• PyStructSequence_NewType()
• PyStructSequence_SetItem()
• PyStructSequence_UnnamedField
• PySuper_Type
• PySys_Audit()
• PySys_AuditTuple()
• PySys_FormatStderr()
• PySys_FormatStdout()
• PySys_GetObject()
• PySys_GetXOptions()
• PySys_ResetWarnOptions()
• PySys_SetArgv()
• PySys_SetArgvEx()
• PySys_SetObject()
• PySys_WriteStderr()
• PySys_WriteStdout()
• PyThreadState
• PyThreadState_Clear()
• PyThreadState_Delete()
• PyThreadState_Get()
• PyThreadState_GetDict()
• PyThreadState_GetFrame()
• PyThreadState_GetID()
• PyThreadState_GetInterpreter()
2.4. ContentsofLimitedAPI 33

### 第42页

• PyThreadState_New()
• PyThreadState_SetAsyncExc()
• PyThreadState_Swap()
• PyThread_GetInfo()
• PyThread_ReInitTLS()
• PyThread_acquire_lock()
• PyThread_acquire_lock_timed()
• PyThread_allocate_lock()
• PyThread_create_key()
• PyThread_delete_key()
• PyThread_delete_key_value()
• PyThread_exit_thread()
• PyThread_free_lock()
• PyThread_get_key_value()
• PyThread_get_stacksize()
• PyThread_get_thread_ident()
• PyThread_get_thread_native_id()
• PyThread_init_thread()
• PyThread_release_lock()
• PyThread_set_key_value()
• PyThread_set_stacksize()
• PyThread_start_new_thread()
• PyThread_tss_alloc()
• PyThread_tss_create()
• PyThread_tss_delete()
• PyThread_tss_free()
• PyThread_tss_get()
• PyThread_tss_is_created()
• PyThread_tss_set()
• PyTraceBack_Here()
• PyTraceBack_Print()
• PyTraceBack_Type
• PyTupleIter_Type
• PyTuple_GetItem()
• PyTuple_GetSlice()
• PyTuple_New()
• PyTuple_Pack()
• PyTuple_SetItem()
• PyTuple_Size()
34 Chapter2. CAPIStability

### 第43页

• PyTuple_Type
• PyTypeObject
• PyType_ClearCache()
• PyType_Freeze()
• PyType_FromMetaclass()
• PyType_FromModuleAndSpec()
• PyType_FromSpec()
• PyType_FromSpecWithBases()
• PyType_GenericAlloc()
• PyType_GenericNew()
• PyType_GetBaseByToken()
• PyType_GetFlags()
• PyType_GetFullyQualifiedName()
• PyType_GetModule()
• PyType_GetModuleByDef()
• PyType_GetModuleName()
• PyType_GetModuleState()
• PyType_GetName()
• PyType_GetQualName()
• PyType_GetSlot()
• PyType_GetTypeDataSize()
• PyType_IsSubtype()
• PyType_Modified()
• PyType_Ready()
• PyType_Slot
• PyType_Spec
• PyType_Type
• PyUnicodeDecodeError_Create()
• PyUnicodeDecodeError_GetEncoding()
• PyUnicodeDecodeError_GetEnd()
• PyUnicodeDecodeError_GetObject()
• PyUnicodeDecodeError_GetReason()
• PyUnicodeDecodeError_GetStart()
• PyUnicodeDecodeError_SetEnd()
• PyUnicodeDecodeError_SetReason()
• PyUnicodeDecodeError_SetStart()
• PyUnicodeEncodeError_GetEncoding()
• PyUnicodeEncodeError_GetEnd()
• PyUnicodeEncodeError_GetObject()
2.4. ContentsofLimitedAPI 35

### 第44页

• PyUnicodeEncodeError_GetReason()
• PyUnicodeEncodeError_GetStart()
• PyUnicodeEncodeError_SetEnd()
• PyUnicodeEncodeError_SetReason()
• PyUnicodeEncodeError_SetStart()
• PyUnicodeIter_Type
• PyUnicodeTranslateError_GetEnd()
• PyUnicodeTranslateError_GetObject()
• PyUnicodeTranslateError_GetReason()
• PyUnicodeTranslateError_GetStart()
• PyUnicodeTranslateError_SetEnd()
• PyUnicodeTranslateError_SetReason()
• PyUnicodeTranslateError_SetStart()
• PyUnicode_Append()
• PyUnicode_AppendAndDel()
• PyUnicode_AsASCIIString()
• PyUnicode_AsCharmapString()
• PyUnicode_AsDecodedObject()
• PyUnicode_AsDecodedUnicode()
• PyUnicode_AsEncodedObject()
• PyUnicode_AsEncodedString()
• PyUnicode_AsEncodedUnicode()
• PyUnicode_AsLatin1String()
• PyUnicode_AsMBCSString()
• PyUnicode_AsRawUnicodeEscapeString()
• PyUnicode_AsUCS4()
• PyUnicode_AsUCS4Copy()
• PyUnicode_AsUTF16String()
• PyUnicode_AsUTF32String()
• PyUnicode_AsUTF8AndSize()
• PyUnicode_AsUTF8String()
• PyUnicode_AsUnicodeEscapeString()
• PyUnicode_AsWideChar()
• PyUnicode_AsWideCharString()
• PyUnicode_BuildEncodingMap()
• PyUnicode_Compare()
• PyUnicode_CompareWithASCIIString()
• PyUnicode_Concat()
• PyUnicode_Contains()
36 Chapter2. CAPIStability

### 第45页

• PyUnicode_Count()
• PyUnicode_Decode()
• PyUnicode_DecodeASCII()
• PyUnicode_DecodeCharmap()
• PyUnicode_DecodeCodePageStateful()
• PyUnicode_DecodeFSDefault()
• PyUnicode_DecodeFSDefaultAndSize()
• PyUnicode_DecodeLatin1()
• PyUnicode_DecodeLocale()
• PyUnicode_DecodeLocaleAndSize()
• PyUnicode_DecodeMBCS()
• PyUnicode_DecodeMBCSStateful()
• PyUnicode_DecodeRawUnicodeEscape()
• PyUnicode_DecodeUTF16()
• PyUnicode_DecodeUTF16Stateful()
• PyUnicode_DecodeUTF32()
• PyUnicode_DecodeUTF32Stateful()
• PyUnicode_DecodeUTF7()
• PyUnicode_DecodeUTF7Stateful()
• PyUnicode_DecodeUTF8()
• PyUnicode_DecodeUTF8Stateful()
• PyUnicode_DecodeUnicodeEscape()
• PyUnicode_EncodeCodePage()
• PyUnicode_EncodeFSDefault()
• PyUnicode_EncodeLocale()
• PyUnicode_Equal()
• PyUnicode_EqualToUTF8()
• PyUnicode_EqualToUTF8AndSize()
• PyUnicode_FSConverter()
• PyUnicode_FSDecoder()
• PyUnicode_Find()
• PyUnicode_FindChar()
• PyUnicode_Format()
• PyUnicode_FromEncodedObject()
• PyUnicode_FromFormat()
• PyUnicode_FromFormatV()
• PyUnicode_FromObject()
• PyUnicode_FromOrdinal()
• PyUnicode_FromString()
2.4. ContentsofLimitedAPI 37

### 第46页

• PyUnicode_FromStringAndSize()
• PyUnicode_FromWideChar()
• PyUnicode_GetDefaultEncoding()
• PyUnicode_GetLength()
• PyUnicode_InternFromString()
• PyUnicode_InternInPlace()
• PyUnicode_IsIdentifier()
• PyUnicode_Join()
• PyUnicode_Partition()
• PyUnicode_RPartition()
• PyUnicode_RSplit()
• PyUnicode_ReadChar()
• PyUnicode_Replace()
• PyUnicode_Resize()
• PyUnicode_RichCompare()
• PyUnicode_Split()
• PyUnicode_Splitlines()
• PyUnicode_Substring()
• PyUnicode_Tailmatch()
• PyUnicode_Translate()
• PyUnicode_Type
• PyUnicode_WriteChar()
• PyVarObject
• PyVarObject.ob_base
• PyVarObject.ob_size
• PyVectorcall_Call()
• PyVectorcall_NARGS()
• PyWeakReference
• PyWeakref_GetObject()
• PyWeakref_GetRef()
• PyWeakref_NewProxy()
• PyWeakref_NewRef()
• PyWrapperDescr_Type
• PyWrapper_New()
• PyZip_Type
• Py_AddPendingCall()
• Py_AtExit()
• Py_BEGIN_ALLOW_THREADS
• Py_BLOCK_THREADS
38 Chapter2. CAPIStability

### 第47页

• Py_BuildValue()
• Py_BytesMain()
• Py_CompileString()
• Py_DecRef()
• Py_DecodeLocale()
• Py_END_ALLOW_THREADS
• Py_EncodeLocale()
• Py_EndInterpreter()
• Py_EnterRecursiveCall()
• Py_Exit()
• Py_FatalError()
• Py_FileSystemDefaultEncodeErrors
• Py_FileSystemDefaultEncoding
• Py_Finalize()
• Py_FinalizeEx()
• Py_GenericAlias()
• Py_GenericAliasType
• Py_GetBuildInfo()
• Py_GetCompiler()
• Py_GetConstant()
• Py_GetConstantBorrowed()
• Py_GetCopyright()
• Py_GetExecPrefix()
• Py_GetPath()
• Py_GetPlatform()
• Py_GetPrefix()
• Py_GetProgramFullPath()
• Py_GetProgramName()
• Py_GetPythonHome()
• Py_GetRecursionLimit()
• Py_GetVersion()
• Py_HasFileSystemDefaultEncoding
• Py_IncRef()
• Py_Initialize()
• Py_InitializeEx()
• Py_Is()
• Py_IsFalse()
• Py_IsFinalizing()
• Py_IsInitialized()
2.4. ContentsofLimitedAPI 39

### 第48页

• Py_IsNone()
• Py_IsTrue()
• Py_LeaveRecursiveCall()
• Py_Main()
• Py_MakePendingCalls()
• Py_NewInterpreter()
• Py_NewRef()
• Py_PACK_FULL_VERSION()
• Py_PACK_VERSION()
• Py_REFCNT()
• Py_ReprEnter()
• Py_ReprLeave()
• Py_SetProgramName()
• Py_SetPythonHome()
• Py_SetRecursionLimit()
• Py_TYPE()
• Py_UCS4
• Py_UNBLOCK_THREADS
• Py_UTF8Mode
• Py_VaBuildValue()
• Py_Version
• Py_XNewRef()
• Py_buffer
• Py_intptr_t
• Py_ssize_t
• Py_uintptr_t
• allocfunc
• binaryfunc
• descrgetfunc
• descrsetfunc
• destructor
• getattrfunc
• getattrofunc
• getbufferproc
• getiterfunc
• getter
• hashfunc
• initproc
• inquiry
40 Chapter2. CAPIStability

### 第49页

• iternextfunc
• lenfunc
• newfunc
• objobjargproc
• objobjproc
• releasebufferproc
• reprfunc
• richcmpfunc
• setattrfunc
• setattrofunc
• setter
• ssizeargfunc
• ssizeobjargproc
• ssizessizeargfunc
• ssizessizeobjargproc
• symtable
• ternaryfunc
• traverseproc
• unaryfunc
• vectorcallfunc
• visitproc
2.4. ContentsofLimitedAPI 41

### 第50页

42 Chapter2. CAPIStability

### 第51页

CHAPTER
THREE
THE VERY HIGH LEVEL LAYER
ThefunctionsinthischapterwillletyouexecutePythonsourcecodegiveninafileorabuffer,buttheywillnotlet
youinteractinamoredetailedwaywiththeinterpreter.
Severalofthesefunctionsacceptastartsymbolfromthegrammarasaparameter. Theavailablestartsymbolsare
Py_eval_input,Py_file_input,andPy_single_input. Thesearedescribedfollowingthefunctionswhich
acceptthemasparameters.
Note also that several of these functions take FILE* parameters. One particular issue which needs to be handled
carefullyisthattheFILEstructurefordifferentClibrariescanbedifferentandincompatible. UnderWindows(at
least),itispossiblefordynamicallylinkedextensionstoactuallyusedifferentlibraries,socareshouldbetakenthat
FILE*parametersareonlypassedtothesefunctionsifitiscertainthattheywerecreatedbythesamelibrarythat
thePythonruntimeisusing.
intPyRun_AnyFile(FILE*fp,constchar*filename)
ThisisasimplifiedinterfacetoPyRun_AnyFileExFlags()below, leavingcloseit setto0andflagssetto
NULL.
intPyRun_AnyFileFlags(FILE*fp,constchar*filename,PyCompilerFlags*flags)
ThisisasimplifiedinterfacetoPyRun_AnyFileExFlags()below,leavingthecloseitargumentsetto0.
intPyRun_AnyFileEx(FILE*fp,constchar*filename,intcloseit)
ThisisasimplifiedinterfacetoPyRun_AnyFileExFlags()below,leavingtheflagsargumentsettoNULL.
intPyRun_AnyFileExFlags(FILE*fp,constchar*filename,intcloseit,PyCompilerFlags*flags)
Iffpreferstoafileassociatedwithaninteractivedevice(consoleorterminalinputorUnixpseudo-terminal),
return the value of PyRun_InteractiveLoop(), otherwise return the result of PyRun_SimpleFile().
filename is decoded from the filesystem encoding (sys.getfilesystemencoding()). If filename
is NULL, this function uses "???" as the filename. If closeit is true, the file is closed before
PyRun_SimpleFileExFlags()returns.
intPyRun_SimpleString(constchar*command)
This is a simplified interface to PyRun_SimpleStringFlags() below, leaving the PyCompilerFlags*
argumentsettoNULL.
intPyRun_SimpleStringFlags(constchar*command,PyCompilerFlags*flags)
ExecutesthePythonsourcecodefromcommand inthe__main__moduleaccordingtotheflagsargument.
If__main__doesnotalreadyexist,itiscreated. Returns0onsuccessor-1ifanexceptionwasraised. If
therewasanerror,thereisnowaytogettheexceptioninformation. Forthemeaningofflags,seebelow.
Note that if an otherwise unhandled SystemExit is raised, this function will not return -1, but exit the
process,aslongasPyConfig.inspectiszero.
intPyRun_SimpleFile(FILE*fp,constchar*filename)
ThisisasimplifiedinterfacetoPyRun_SimpleFileExFlags()below,leavingcloseitsetto0andflagsset
toNULL.
intPyRun_SimpleFileEx(FILE*fp,constchar*filename,intcloseit)
ThisisasimplifiedinterfacetoPyRun_SimpleFileExFlags()below,leavingflagssettoNULL.
43

### 第52页

intPyRun_SimpleFileExFlags(FILE*fp,constchar*filename,intcloseit,PyCompilerFlags*flags)
Similar to PyRun_SimpleStringFlags(), but the Python source code is read from fp instead of an in-
memory string. filename should be the name of the file, it is decoded from filesystem encoding and error
handler. Ifcloseitistrue,thefileisclosedbeforePyRun_SimpleFileExFlags()returns.
(cid:174) Note
OnWindows,fpshouldbeopenedasbinarymode(e.g. fopen(filename, "rb")). Otherwise,Python
maynothandlescriptfilewithLFlineendingcorrectly.
intPyRun_InteractiveOne(FILE*fp,constchar*filename)
ThisisasimplifiedinterfacetoPyRun_InteractiveOneFlags()below,leavingflagssettoNULL.
intPyRun_InteractiveOneFlags(FILE*fp,constchar*filename,PyCompilerFlags*flags)
Read and execute a single statement from a file associated with an interactive device according to the flags
argument. Theuserwillbepromptedusingsys.ps1andsys.ps2. filenameisdecodedfromthefilesystem
encodinganderrorhandler.
Returns0whentheinputwasexecutedsuccessfully,-1iftherewasanexception,oranerrorcodefromthe
errcode.hincludefiledistributedaspartofPythoniftherewasaparseerror. (Notethaterrcode.hisnot
includedbyPython.h,somustbeincludedspecificallyifneeded.)
intPyRun_InteractiveLoop(FILE*fp,constchar*filename)
ThisisasimplifiedinterfacetoPyRun_InteractiveLoopFlags()below,leavingflagssettoNULL.
intPyRun_InteractiveLoopFlags(FILE*fp,constchar*filename,PyCompilerFlags*flags)
ReadandexecutestatementsfromafileassociatedwithaninteractivedeviceuntilEOFisreached. Theuser
willbepromptedusingsys.ps1andsys.ps2. filenameisdecodedfromthefilesystemencodinganderror
handler. Returns0atEOForanegativenumberuponfailure.
int(*PyOS_InputHook)(void)
PartoftheStableABI.Canbesettopointtoafunctionwiththeprototypeint func(void). Thefunction
will be called when Python’s interpreter prompt is about to become idle and wait for user input from the
terminal. Thereturnvalueisignored. Overridingthishookcanbeusedtointegratetheinterpreter’sprompt
withothereventloops,asdoneintheModules/_tkinter.cinthePythonsourcecode.
Changedinversion3.12: Thisfunctionisonlycalledfromthemaininterpreter.
char*(*PyOS_ReadlineFunctionPointer)(FILE*,FILE*,constchar*)
Canbesettopointtoafunctionwiththeprototypechar *func(FILE *stdin, FILE *stdout, char
*prompt),overridingthedefaultfunctionusedtoreadasinglelineofinputattheinterpreter’sprompt. The
functionisexpectedtooutputthestringpromptifit’snotNULL,andthenreadalineofinputfromtheprovided
standardinputfile,returningtheresultingstring. Forexample,Thereadlinemodulesetsthishooktoprovide
line-editingandtab-completionfeatures.
The result must be a string allocated by PyMem_RawMalloc() or PyMem_RawRealloc(), or NULL if an
erroroccurred.
Changedinversion3.4: TheresultmustbeallocatedbyPyMem_RawMalloc()orPyMem_RawRealloc(),
insteadofbeingallocatedbyPyMem_Malloc()orPyMem_Realloc().
Changedinversion3.12: Thisfunctionisonlycalledfromthemaininterpreter.
PyObject*PyRun_String(constchar*str,intstart,PyObject*globals,PyObject*locals)
Returnvalue: Newreference. ThisisasimplifiedinterfacetoPyRun_StringFlags()below,leavingflags
settoNULL.
PyObject*PyRun_StringFlags(constchar*str,intstart,PyObject*globals,PyObject*locals,PyCompilerFlags
*flags)
Return value: New reference. Execute Python source code from str in the context specified by the objects
globals andlocals withthecompilerflagsspecifiedbyflags. globals mustbeadictionary; locals canbeany
44 Chapter3. TheVeryHighLevelLayer

### 第53页

objectthatimplementsthemappingprotocol. Theparameterstartspecifiesthestarttokenthatshouldbeused
toparsethesourcecode.
ReturnstheresultofexecutingthecodeasaPythonobject,orNULLifanexceptionwasraised.
PyObject*PyRun_File(FILE*fp,constchar*filename,intstart,PyObject*globals,PyObject*locals)
Returnvalue: Newreference. ThisisasimplifiedinterfacetoPyRun_FileExFlags()below,leavingcloseit
setto0andflagssettoNULL.
PyObject*PyRun_FileEx(FILE*fp,constchar*filename,intstart,PyObject*globals,PyObject*locals,int
closeit)
Returnvalue: Newreference. ThisisasimplifiedinterfacetoPyRun_FileExFlags()below,leavingflags
settoNULL.
PyObject*PyRun_FileFlags(FILE*fp,constchar*filename,intstart,PyObject*globals,PyObject*locals,
PyCompilerFlags*flags)
Returnvalue: Newreference. ThisisasimplifiedinterfacetoPyRun_FileExFlags()below,leavingcloseit
setto0.
PyObject*PyRun_FileExFlags(FILE*fp,constchar*filename,intstart,PyObject*globals,PyObject*locals,
intcloseit,PyCompilerFlags*flags)
Returnvalue: Newreference. SimilartoPyRun_StringFlags(),butthePythonsourcecodeisreadfrom
fpinsteadofanin-memorystring. filenameshouldbethenameofthefile,itisdecodedfromthefilesystem
encodinganderrorhandler. Ifcloseitistrue,thefileisclosedbeforePyRun_FileExFlags()returns.
PyObject*Py_CompileString(constchar*str,constchar*filename,intstart)
Return value: New reference. Part of the Stable ABI. This is a simplified interface to
Py_CompileStringFlags()below,leavingflagssettoNULL.
PyObject*Py_CompileStringFlags(constchar*str,constchar*filename,intstart,PyCompilerFlags*flags)
Returnvalue: Newreference. ThisisasimplifiedinterfacetoPy_CompileStringExFlags()below,with
optimizesetto-1.
PyObject*Py_CompileStringObject(constchar*str,PyObject*filename,intstart,PyCompilerFlags*flags,int
optimize)
Return value: New reference. Parse and compile the Python source code in str, returning the resulting code
object. The start token is given by start; this can be used to constrain the code which can be compiled and
shouldbePy_eval_input,Py_file_input,orPy_single_input. Thefilenamespecifiedbyfilename
isusedtoconstructthecodeobjectandmayappearintracebacksorSyntaxErrorexceptionmessages. This
returnsNULLifthecodecannotbeparsedorcompiled.
The integer optimize specifies the optimization level of the compiler; a value of -1 selects the optimization
leveloftheinterpreterasgivenby-Ooptions. Explicitlevelsare0(nooptimization;__debug__istrue),1
(assertsareremoved,__debug__isfalse)or2(docstringsareremovedtoo).
Addedinversion3.4.
PyObject*Py_CompileStringExFlags(constchar*str,constchar*filename,intstart,PyCompilerFlags*flags,
intoptimize)
Return value: New reference. Like Py_CompileStringObject(), but filename is a byte string decoded
fromthefilesystemencodinganderrorhandler.
Addedinversion3.2.
PyObject*PyEval_EvalCode(PyObject*co,PyObject*globals,PyObject*locals)
Returnvalue:Newreference. PartoftheStableABI.ThisisasimplifiedinterfacetoPyEval_EvalCodeEx(),
withjustthecodeobject,andglobalandlocalvariables. TheotherargumentsaresettoNULL.
PyObject*PyEval_EvalCodeEx(PyObject*co,PyObject*globals,PyObject*locals,PyObject*const*args,int
argcount,PyObject*const*kws,intkwcount,PyObject*const*defs,int
defcount,PyObject*kwdefs,PyObject*closure)
Returnvalue: Newreference. PartoftheStableABI.Evaluateaprecompiledcodeobject,givenaparticular
45

### 第54页

environmentforitsevaluation. Thisenvironmentconsistsofadictionaryofglobalvariables,amappingobject
oflocalvariables,arraysofarguments,keywordsanddefaults,adictionaryofdefaultvaluesforkeyword-only
argumentsandaclosuretupleofcells.
PyObject*PyEval_EvalFrame(PyFrameObject*f)
Returnvalue: Newreference. PartoftheStableABI.Evaluateanexecutionframe. Thisisasimplifiedinterface
toPyEval_EvalFrameEx(),forbackwardcompatibility.
PyObject*PyEval_EvalFrameEx(PyFrameObject*f,intthrowflag)
Return value: New reference. Part of the Stable ABI. This is the main, unvarnished function of Python in-
terpretation. The code object associated with the execution frame f is executed, interpreting bytecode and
executingcallsasneeded. Theadditionalthrowflagparametercanmostlybeignored-iftrue,thenitcauses
anexceptiontoimmediatelybethrown;thisisusedforthethrow()methodsofgeneratorobjects.
Changedinversion3.4: Thisfunctionnowincludesadebugassertiontohelpensurethatitdoesnotsilently
discardanactiveexception.
intPyEval_MergeCompilerFlags(PyCompilerFlags*cf)
Thisfunctionchangestheflagsofthecurrentevaluationframe,andreturnstrueonsuccess,falseonfailure.
intPy_eval_input
ThestartsymbolfromthePythongrammarforisolatedexpressions;forusewithPy_CompileString().
intPy_file_input
ThestartsymbolfromthePythongrammarforsequencesofstatementsasreadfromafileorothersource;for
usewithPy_CompileString(). ThisisthesymboltousewhencompilingarbitrarilylongPythonsource
code.
intPy_single_input
ThestartsymbolfromthePythongrammarforasinglestatement;forusewithPy_CompileString(). This
isthesymbolusedfortheinteractiveinterpreterloop.
structPyCompilerFlags
Thisisthestructureusedtoholdcompilerflags. Incaseswherecodeisonlybeingcompiled,itispassedas
int flags,andincaseswherecodeisbeingexecuted,itispassedasPyCompilerFlags *flags. Inthis
case,from __future__ importcanmodifyflags.
Whenever PyCompilerFlags *flags is NULL, cf_flags is treated as equal to 0, and any modification
duetofrom __future__ importisdiscarded.
intcf_flags
Compilerflags.
intcf_feature_version
cf_feature_versionistheminorPythonversion. ItshouldbeinitializedtoPY_MINOR_VERSION.
Thefieldisignoredbydefault,itisusedifandonlyifPyCF_ONLY_ASTflagissetincf_flags.
Changedinversion3.8: Addedcf_feature_versionfield.
Theavailablecompilerflagsareaccessibleasmacros:
PyCF_ALLOW_TOP_LEVEL_AWAIT
PyCF_ONLY_AST
PyCF_OPTIMIZED_AST
PyCF_TYPE_COMMENTS
SeecompilerflagsindocumentationoftheastPythonmodule,whichexportstheseconstantsunderthe
samenames.
The “PyCF” flags above can be combined with “CO_FUTURE” flags such as CO_FUTURE_ANNOTATIONS to
enablefeaturesnormallyselectableusingfuturestatements. SeeCodeObjectFlagsforacompletelist.
46 Chapter3. TheVeryHighLevelLayer

### 第55页

CHAPTER
FOUR
REFERENCE COUNTING
ThefunctionsandmacrosinthissectionareusedformanagingreferencecountsofPythonobjects.
Py_ssize_tPy_REFCNT(PyObject*o)
PartoftheStableABIsinceversion3.14. GetthereferencecountofthePythonobjecto.
Notethatthereturnedvaluemaynotactuallyreflecthowmanyreferencestotheobjectareactuallyheld. For
example,someobjectsareimmortalandhaveaveryhighrefcountthatdoesnotreflecttheactualnumberof
references. Consequently,donotrelyonthereturnedvaluetobeaccurate,otherthanavalueof0or1.
UsethePy_SET_REFCNT()functiontosetanobjectreferencecount.
(cid:174) Note
Onfreethreaded buildsofPython,returning1isn’tsufficienttodetermineifit’ssafetotreatoashaving
noaccessbyotherthreads. UsePyUnstable_Object_IsUniquelyReferenced()forthatinstead.
SeealsothefunctionPyUnstable_Object_IsUniqueReferencedTemporary().
Changedinversion3.10: Py_REFCNT()ischangedtotheinlinestaticfunction.
Changedinversion3.11: Theparametertypeisnolongerconst PyObject*.
voidPy_SET_REFCNT(PyObject*o,Py_ssize_trefcnt)
Settheobjectoreferencecountertorefcnt.
OnPythonbuildwithFreeThreading,ifrefcntislargerthanUINT32_MAX,theobjectismadeimmortal.
Thisfunctionhasnoeffectonimmortalobjects.
Addedinversion3.9.
Changedinversion3.12: Immortalobjectsarenotmodified.
voidPy_INCREF(PyObject*o)
Indicatetakinganewstrongreferencetoobjecto,indicatingitisinuseandshouldnotbedestroyed.
Thisfunctionhasnoeffectonimmortalobjects.
Thisfunctionisusuallyusedtoconvertaborrowedreferencetoastrongreferencein-place. ThePy_NewRef()
functioncanbeusedtocreateanewstrongreference.
Whendoneusingtheobject,releaseisbycallingPy_DECREF().
TheobjectmustnotbeNULL;ifyouaren’tsurethatitisn’tNULL,usePy_XINCREF().
Donotexpectthisfunctiontoactuallymodifyoinanyway. Foratleastsomeobjects,thisfunctionhasno
effect.
Changedinversion3.12: Immortalobjectsarenotmodified.
47

### 第56页

voidPy_XINCREF(PyObject*o)
SimilartoPy_INCREF(),buttheobjectocanbeNULL,inwhichcasethishasnoeffect.
SeealsoPy_XNewRef().
PyObject*Py_NewRef(PyObject*o)
PartoftheStableABIsinceversion3.10. Createanewstrongreferencetoanobject: callPy_INCREF()ono
andreturntheobjecto.
Whenthestrongreferenceisnolongerneeded,Py_DECREF()shouldbecalledonittoreleasethereference.
TheobjectomustnotbeNULL;usePy_XNewRef()ifocanbeNULL.
Forexample:
Py_INCREF(obj);
self->attr = obj;
canbewrittenas:
self->attr = Py_NewRef(obj);
SeealsoPy_INCREF().
Addedinversion3.10.
PyObject*Py_XNewRef(PyObject*o)
PartoftheStableABIsinceversion3.10. SimilartoPy_NewRef(),buttheobjectocanbeNULL.
IftheobjectoisNULL,thefunctionjustreturnsNULL.
Addedinversion3.10.
voidPy_DECREF(PyObject*o)
Releaseastrongreferencetoobjecto,indicatingthereferenceisnolongerused.
Thisfunctionhasnoeffectonimmortalobjects.
Oncethelaststrongreferenceisreleased(i.e. theobject’sreferencecountreaches0),theobject’stype’sdeal-
locationfunction(whichmustnotbeNULL)isinvoked.
Thisfunctionisusuallyusedtodeleteastrongreferencebeforeexitingitsscope.
TheobjectmustnotbeNULL;ifyouaren’tsurethatitisn’tNULL,usePy_XDECREF().
Donotexpectthisfunctiontoactuallymodifyoinanyway. Foratleastsomeobjects,thisfunctionhasno
effect.
(cid:193) Warning
ThedeallocationfunctioncancausearbitraryPythoncodetobeinvoked(e.g. whenaclassinstancewitha
__del__()methodisdeallocated). Whileexceptionsinsuchcodearenotpropagated,theexecutedcode
hasfreeaccesstoallPythonglobalvariables. Thismeansthatanyobjectthatisreachablefromaglobal
variableshouldbeinaconsistentstatebeforePy_DECREF()isinvoked. Forexample,codetodeletean
objectfromalistshouldcopyareferencetothedeletedobjectinatemporaryvariable,updatethelistdata
structure,andthencallPy_DECREF()forthetemporaryvariable.
Changedinversion3.12: Immortalobjectsarenotmodified.
voidPy_XDECREF(PyObject*o)
SimilartoPy_DECREF(),buttheobjectocanbeNULL,inwhichcasethishasnoeffect. Thesamewarning
fromPy_DECREF()applieshereaswell.
48 Chapter4. ReferenceCounting

### 第57页

voidPy_CLEAR(PyObject*o)
Release a strong reference for object o. The object may be NULL, in which case the macro has no effect;
otherwise the effect is the same as for Py_DECREF(), except that the argument is also set to NULL. The
warningforPy_DECREF()doesnotapplywithrespecttotheobjectpassedbecausethemacrocarefullyuses
atemporaryvariableandsetstheargumenttoNULLbeforereleasingthereference.
Itisagoodideatousethismacrowheneverreleasingareferencetoanobjectthatmightbetraversedduring
garbagecollection.
Changedinversion3.12: Themacroargumentisnowonlyevaluatedonce. Iftheargumenthassideeffects,
thesearenolongerduplicated.
voidPy_IncRef(PyObject*o)
Part of the Stable ABI. Indicate taking a new strong reference to object o. A function version of
Py_XINCREF(). ItcanbeusedforruntimedynamicembeddingofPython.
voidPy_DecRef(PyObject*o)
PartoftheStableABI.Releaseastrongreferencetoobjecto. AfunctionversionofPy_XDECREF(). Itcan
beusedforruntimedynamicembeddingofPython.
Py_SETREF(dst,src)
Macrosafelyreleasingastrongreferencetoobjectdstandsettingdsttosrc.
AsincaseofPy_CLEAR(),“theobvious”codecanbedeadly:
Py_DECREF(dst);
dst = src;
Thesafewayis:
Py_SETREF(dst, src);
Thatarrangestosetdst tosrcbeforereleasingthereferencetotheoldvalueofdst,sothatanycodetriggered
asaside-effectofdstgettingtorndownnolongerbelievesdstpointstoavalidobject.
Addedinversion3.6.
Changedinversion3.12: Themacroargumentsarenowonlyevaluatedonce. Ifanargumenthassideeffects,
thesearenolongerduplicated.
Py_XSETREF(dst,src)
VariantofPy_SETREFmacrothatusesPy_XDECREF()insteadofPy_DECREF().
Addedinversion3.6.
Changedinversion3.12: Themacroargumentsarenowonlyevaluatedonce. Ifanargumenthassideeffects,
thesearenolongerduplicated.
49

### 第58页

50 Chapter4. ReferenceCounting

### 第59页

CHAPTER
FIVE
EXCEPTION HANDLING
ThefunctionsdescribedinthischapterwillletyouhandleandraisePythonexceptions. Itisimportanttounderstand
some of the basics of Python exception handling. It works somewhat like the POSIX errno variable: there is a
globalindicator(perthread)ofthelasterrorthatoccurred. MostCAPIfunctionsdon’tclearthisonsuccess,butwill
setittoindicatethecauseoftheerroronfailure. MostCAPIfunctionsalsoreturnanerrorindicator,usuallyNULL
iftheyaresupposedtoreturnapointer,or-1iftheyreturnaninteger(exception: thePyArg_*functionsreturn1
forsuccessand0forfailure).
Concretely,theerrorindicatorconsistsofthreeobjectpointers: theexception’stype,theexception’svalue,andthe
traceback object. Any of those pointers can be NULL if non-set (although some combinations are forbidden, for
exampleyoucan’thaveanon-NULLtracebackiftheexceptiontypeisNULL).
When a function must fail because some function it called failed, it generally doesn’t set the error indicator; the
functionitcalledalreadysetit. Itisresponsibleforeitherhandlingtheerrorandclearingtheexceptionorreturning
after cleaning up any resources it holds (such as object references or memory allocations); it should not continue
normallyifitisnotpreparedtohandletheerror. Ifreturningduetoanerror,itisimportanttoindicatetothecaller
thatanerrorhasbeenset. Iftheerrorisnothandledorcarefullypropagated,additionalcallsintothePython/CAPI
maynotbehaveasintendedandmayfailinmysteriousways.
(cid:174) Note
Theerrorindicatorisnottheresultofsys.exc_info(). Theformercorrespondstoanexceptionthatisnotyet
caught(andisthereforestillpropagating),whilethelatterreturnsanexceptionafteritiscaught(andhastherefore
stoppedpropagating).
5.1 Printing and clearing
voidPyErr_Clear()
PartoftheStableABI.Cleartheerrorindicator. Iftheerrorindicatorisnotset,thereisnoeffect.
voidPyErr_PrintEx(intset_sys_last_vars)
PartoftheStableABI.Printastandardtracebacktosys.stderrandcleartheerrorindicator. Unlessthe
error is a SystemExit, in that case no traceback is printed and the Python process will exit with the error
codespecifiedbytheSystemExitinstance.
Callthisfunctiononlywhentheerrorindicatorisset. Otherwiseitwillcauseafatalerror!
If set_sys_last_vars is nonzero, the variable sys.last_exc is set to the printed exception. For backwards
compatibility, the deprecated variables sys.last_type, sys.last_value and sys.last_traceback
arealsosettothetype,valueandtracebackofthisexception,respectively.
Changedinversion3.12: Thesettingofsys.last_excwasadded.
voidPyErr_Print()
PartoftheStableABI.AliasforPyErr_PrintEx(1).
51

### 第60页

voidPyErr_WriteUnraisable(PyObject*obj)
PartoftheStableABI.Callsys.unraisablehook()usingthecurrentexceptionandobjargument.
Thisutilityfunctionprintsawarningmessagetosys.stderrwhenanexceptionhasbeensetbutitisim-
possiblefortheinterpretertoactuallyraisetheexception. Itisused,forexample,whenanexceptionoccurs
inan__del__()method.
Thefunctioniscalledwithasingleargumentobjthatidentifiesthecontextinwhichtheunraisableexception
occurred. Ifpossible,thereprofobjwillbeprintedinthewarningmessage. IfobjisNULL,onlythetraceback
isprinted.
Anexceptionmustbesetwhencallingthisfunction.
Changedinversion3.4: Printatraceback. PrintonlytracebackifobjisNULL.
Changedinversion3.8: Usesys.unraisablehook().
voidPyErr_FormatUnraisable(constchar*format,...)
Similar to PyErr_WriteUnraisable(), but the format and subsequent parameters help format
the warning message; they have the same meaning and values as in PyUnicode_FromFormat().
PyErr_WriteUnraisable(obj) is roughly equivalent to PyErr_FormatUnraisable("Exception
ignored in: %R", obj). IfformatisNULL,onlythetracebackisprinted.
Addedinversion3.13.
voidPyErr_DisplayException(PyObject*exc)
Part of the Stable ABI since version 3.12. Print the standard traceback display of exc to sys.stderr, in-
cludingchainedexceptionsandnotes.
Addedinversion3.12.
5.2 Raising exceptions
Thesefunctionshelpyousetthecurrentthread’serrorindicator. Forconvenience,someofthesefunctionswillalways
returnaNULLpointerforuseinareturnstatement.
voidPyErr_SetString(PyObject*type,constchar*message)
PartoftheStableABI.Thisisthemostcommonwaytosettheerrorindicator. Thefirstargumentspecifies
theexceptiontype;itisnormallyoneofthestandardexceptions,e.g. PyExc_RuntimeError. Youneednot
createanewstrongreferencetoit(e.g. withPy_INCREF()). Thesecondargumentisanerrormessage;itis
decodedfrom'utf-8'.
voidPyErr_SetObject(PyObject*type,PyObject*value)
Part of the Stable ABI. This function is similar to PyErr_SetString() but lets you specify an arbitrary
Pythonobjectforthe“value”oftheexception.
PyObject*PyErr_Format(PyObject*exception,constchar*format,...)
Returnvalue: AlwaysNULL.PartoftheStableABI.ThisfunctionsetstheerrorindicatorandreturnsNULL.
exception should be a Python exception class. The format and subsequent parameters help format the error
message; they have the same meaning and values as in PyUnicode_FromFormat(). format is an ASCII-
encodedstring.
PyObject*PyErr_FormatV(PyObject*exception,constchar*format,va_listvargs)
Returnvalue: AlwaysNULL.PartoftheStableABIsinceversion3.5. SameasPyErr_Format(),buttaking
ava_listargumentratherthanavariablenumberofarguments.
Addedinversion3.5.
voidPyErr_SetNone(PyObject*type)
PartoftheStableABI.ThisisashorthandforPyErr_SetObject(type, Py_None).
52 Chapter5. ExceptionHandling

### 第61页

intPyErr_BadArgument()
PartoftheStableABI.ThisisashorthandforPyErr_SetString(PyExc_TypeError, message),where
messageindicatesthatabuilt-inoperationwasinvokedwithanillegalargument. Itismostlyforinternaluse.
PyObject*PyErr_NoMemory()
Return value: Always NULL. Part of the Stable ABI. This is a shorthand for
PyErr_SetNone(PyExc_MemoryError); it returns NULL so an object allocation function can write
return PyErr_NoMemory();whenitrunsoutofmemory.
PyObject*PyErr_SetFromErrno(PyObject*type)
Returnvalue: AlwaysNULL.PartoftheStableABI.Thisisaconveniencefunctiontoraiseanexceptionwhen
a C library function has returned an error and set the C variable errno. It constructs a tuple object whose
firstitemistheintegererrnovalueandwhoseseconditemisthecorrespondingerrormessage(gottenfrom
strerror()), and then calls PyErr_SetObject(type, object). On Unix, when the errno value is
EINTR, indicating an interrupted system call, this calls PyErr_CheckSignals(), and if that set the error
indicator,leavesitsettothat. ThefunctionalwaysreturnsNULL,soawrapperfunctionaroundasystemcall
canwritereturn PyErr_SetFromErrno(type);whenthesystemcallreturnsanerror.
PyObject*PyErr_SetFromErrnoWithFilenameObject(PyObject*type,PyObject*filenameObject)
Returnvalue: AlwaysNULL.PartoftheStableABI.SimilartoPyErr_SetFromErrno(),withtheadditional
behaviorthatiffilenameObjectisnotNULL,itispassedtotheconstructoroftypeasathirdparameter. Inthe
caseofOSErrorexception,thisisusedtodefinethefilenameattributeoftheexceptioninstance.
PyObject*PyErr_SetFromErrnoWithFilenameObjects(PyObject*type,PyObject*filenameObject,
PyObject*filenameObject2)
Return value: Always NULL. Part of the Stable ABI since version 3.7. Similar to
PyErr_SetFromErrnoWithFilenameObject(), but takes a second filename object, for raising
errorswhenafunctionthattakestwofilenamesfails.
Addedinversion3.4.
PyObject*PyErr_SetFromErrnoWithFilename(PyObject*type,constchar*filename)
Return value: Always NULL. Part of the Stable ABI. Similar to
PyErr_SetFromErrnoWithFilenameObject(), but the filename is given as a C string. filename
isdecodedfromthefilesystemencodinganderrorhandler.
PyObject*PyErr_SetFromWindowsErr(intierr)
Return value: Always NULL. Part of the Stable ABI on Windows since version 3.7. This is a convenience
functiontoraiseOSError. Ifcalledwithierrof0,theerrorcodereturnedbyacalltoGetLastError()is
usedinstead. ItcallstheWin32functionFormatMessage()toretrievetheWindowsdescriptionoferrorcode
givenbyierrorGetLastError(),thenitconstructsaOSErrorobjectwiththewinerrorattributesettothe
errorcode,thestrerrorattributesettothecorrespondingerrormessage(gottenfromFormatMessage()),
andthencallsPyErr_SetObject(PyExc_OSError, object). ThisfunctionalwaysreturnsNULL.
Availability: Windows.
PyObject*PyErr_SetExcFromWindowsErr(PyObject*type,intierr)
Return value: Always NULL. Part of the Stable ABI on Windows since version 3.7. Similar to
PyErr_SetFromWindowsErr(),withanadditionalparameterspecifyingtheexceptiontypetoberaised.
Availability: Windows.
PyObject*PyErr_SetFromWindowsErrWithFilename(intierr,constchar*filename)
Return value: Always NULL. Part of the Stable ABI on Windows since version 3.7. Similar to
PyErr_SetFromWindowsErr(), with the additional behavior that if filename is not NULL, it is decoded
fromthefilesystemencoding(os.fsdecode())andpassedtotheconstructorofOSErrorasathirdparam-
etertobeusedtodefinethefilenameattributeoftheexceptioninstance.
Availability: Windows.
PyObject*PyErr_SetExcFromWindowsErrWithFilenameObject(PyObject*type,intierr,PyObject
*filename)
5.2. Raisingexceptions 53

### 第62页

Return value: Always NULL. Part of the Stable ABI on Windows since version 3.7. Similar to
PyErr_SetExcFromWindowsErr(),withtheadditionalbehaviorthatiffilenameisnotNULL,itispassedto
theconstructorofOSErrorasathirdparametertobeusedtodefinethefilenameattributeoftheexception
instance.
Availability: Windows.
PyObject*PyErr_SetExcFromWindowsErrWithFilenameObjects(PyObject*type,intierr,PyObject
*filename,PyObject*filename2)
Return value: Always NULL. Part of the Stable ABI on Windows since version 3.7. Similar to
PyErr_SetExcFromWindowsErrWithFilenameObject(),butacceptsasecondfilenameobject.
Availability: Windows.
Addedinversion3.4.
PyObject*PyErr_SetExcFromWindowsErrWithFilename(PyObject*type,intierr,constchar*filename)
Return value: Always NULL. Part of the Stable ABI on Windows since version 3.7. Similar to
PyErr_SetFromWindowsErrWithFilename(), with an additional parameter specifying the exception
typetoberaised.
Availability: Windows.
PyObject*PyErr_SetImportError(PyObject*msg,PyObject*name,PyObject*path)
Returnvalue: AlwaysNULL.PartoftheStableABIsinceversion3.7. Thisisaconveniencefunctiontoraise
ImportError. msgwillbesetastheexception’smessagestring. nameandpath,bothofwhichcanbeNULL,
willbesetastheImportError’srespectivenameandpathattributes.
Addedinversion3.3.
PyObject*PyErr_SetImportErrorSubclass(PyObject*exception,PyObject*msg,PyObject*name,PyObject
*path)
Returnvalue: AlwaysNULL.PartoftheStableABIsinceversion3.6. MuchlikePyErr_SetImportError()
butthisfunctionallowsforspecifyingasubclassofImportErrortoraise.
Addedinversion3.6.
voidPyErr_SyntaxLocationObject(PyObject*filename,intlineno,intcol_offset)
Setfile,line,andoffsetinformationforthecurrentexception. IfthecurrentexceptionisnotaSyntaxError,
then it sets additional attributes, which make the exception printing subsystem think the exception is a
SyntaxError.
Addedinversion3.4.
voidPyErr_SyntaxLocationEx(constchar*filename,intlineno,intcol_offset)
PartoftheStableABIsinceversion3.7. LikePyErr_SyntaxLocationObject(), butfilenameisabyte
stringdecodedfromthefilesystemencodinganderrorhandler.
Addedinversion3.2.
voidPyErr_SyntaxLocation(constchar*filename,intlineno)
PartoftheStableABI.LikePyErr_SyntaxLocationEx(),butthecol_offsetparameterisomitted.
voidPyErr_BadInternalCall()
Part of the Stable ABI. This is a shorthand for PyErr_SetString(PyExc_SystemError, message),
wheremessageindicatesthataninternaloperation(e.g. aPython/CAPIfunction)wasinvokedwithanillegal
argument. Itismostlyforinternaluse.
5.3 Issuing warnings
UsethesefunctionstoissuewarningsfromCcode. TheymirrorsimilarfunctionsexportedbythePythonwarnings
module. Theynormallyprintawarningmessagetosys.stderr;however,itisalsopossiblethattheuserhasspecified
54 Chapter5. ExceptionHandling

### 第63页

thatwarningsaretobeturnedintoerrors, andinthatcasetheywillraiseanexception. Itisalsopossiblethatthe
functionsraiseanexceptionbecauseofaproblemwiththewarningmachinery. Thereturnvalueis0ifnoexception
israised,or-1ifanexceptionisraised. (Itisnotpossibletodeterminewhetherawarningmessageisactuallyprinted,
norwhatthereasonisfortheexception;thisisintentional.) Ifanexceptionisraised,thecallershoulddoitsnormal
exceptionhandling(forexample,Py_DECREF()ownedreferencesandreturnanerrorvalue).
intPyErr_WarnEx(PyObject*category,constchar*message,Py_ssize_tstack_level)
Part of the Stable ABI. Issue a warning message. The category argument is a warning category (see below)
orNULL;themessageargumentisaUTF-8encodedstring. stack_levelisapositivenumbergivinganumber
ofstackframes; thewarningwillbeissuedfromthecurrentlyexecutinglineofcodeinthatstackframe. A
stack_levelof1isthefunctioncallingPyErr_WarnEx(),2isthefunctionabovethat,andsoforth.
Warning categories must be subclasses of PyExc_Warning; PyExc_Warning is a subclass of
PyExc_Exception;thedefaultwarningcategoryisPyExc_RuntimeWarning. ThestandardPythonwarn-
ingcategoriesareavailableasglobalvariableswhosenamesareenumeratedatWarningtypes.
Forinformationaboutwarningcontrol,seethedocumentationforthewarningsmoduleandthe-Woptionin
thecommandlinedocumentation. ThereisnoCAPIforwarningcontrol.
intPyErr_WarnExplicitObject(PyObject*category,PyObject*message,PyObject*filename,intlineno,
PyObject*module,PyObject*registry)
Issue a warning message with explicit control over all warning attributes. This is a straightforward wrapper
aroundthePythonfunctionwarnings.warn_explicit();seethereformoreinformation. Themoduleand
registryargumentsmaybesettoNULLtogetthedefaulteffectdescribedthere.
Addedinversion3.4.
intPyErr_WarnExplicit(PyObject*category,constchar*message,constchar*filename,intlineno,constchar
*module,PyObject*registry)
Part of the Stable ABI. Similar to PyErr_WarnExplicitObject() except that message and module are
UTF-8encodedstrings,andfilenameisdecodedfromthefilesystemencodinganderrorhandler.
intPyErr_WarnFormat(PyObject*category,Py_ssize_tstack_level,constchar*format,...)
PartoftheStableABI.FunctionsimilartoPyErr_WarnEx(),butusePyUnicode_FromFormat()toformat
thewarningmessage. formatisanASCII-encodedstring.
Addedinversion3.2.
intPyErr_ResourceWarning(PyObject*source,Py_ssize_tstack_level,constchar*format,...)
Part of the Stable ABI since version 3.6. Function similar to PyErr_WarnFormat(), but category is
ResourceWarninganditpassessourcetowarnings.WarningMessage.
Addedinversion3.6.
5.4 Querying the error indicator
PyObject*PyErr_Occurred()
Return value: Borrowed reference. Part of the Stable ABI. Test whether the error indicator is set. If set,
return the exception type (the first argument to the last call to one of the PyErr_Set* functions or to
PyErr_Restore()). If not set, return NULL. You do not own a reference to the return value, so you do
notneedtoPy_DECREF()it.
Thecallermusthaveanattachedthreadstate.
(cid:174) Note
Do not compare the return value to a specific exception; use PyErr_ExceptionMatches() instead,
shownbelow. (Thecomparisoncouldeasilyfailsincetheexceptionmaybeaninstanceinsteadofaclass,
inthecaseofaclassexception,oritmaybeasubclassoftheexpectedexception.)
5.4. Queryingtheerrorindicator 55

### 第64页

intPyErr_ExceptionMatches(PyObject*exc)
Part of the Stable ABI. Equivalent to PyErr_GivenExceptionMatches(PyErr_Occurred(), exc).
Thisshouldonlybecalledwhenanexceptionisactuallyset; amemoryaccessviolationwilloccurifnoex-
ceptionhasbeenraised.
intPyErr_GivenExceptionMatches(PyObject*given,PyObject*exc)
PartoftheStableABI.Returntrueifthegivenexceptionmatchestheexceptiontypeinexc. Ifexcisaclass
object,thisalsoreturnstruewhengivenisaninstanceofasubclass. Ifexcisatuple,allexceptiontypesinthe
tuple(andrecursivelyinsubtuples)aresearchedforamatch.
PyObject*PyErr_GetRaisedException(void)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.12. Returntheexceptioncurrentlybeing
raised,clearingtheerrorindicatoratthesametime. ReturnNULLiftheerrorindicatorisnotset.
Thisfunctionisusedbycodethatneedstocatchexceptions,orcodethatneedstosaveandrestoretheerror
indicatortemporarily.
Forexample:
{
PyObject *exc = PyErr_GetRaisedException();
/* ... code that might produce other errors ... */
PyErr_SetRaisedException(exc);
}
(cid:181) Seealso
PyErr_GetHandledException(),tosavetheexceptioncurrentlybeinghandled.
Addedinversion3.12.
voidPyErr_SetRaisedException(PyObject*exc)
PartoftheStableABIsinceversion3.12. Setexcastheexceptioncurrentlybeingraised,clearingtheexisting
exceptionifoneisset.
(cid:193) Warning
Thiscallstealsareferencetoexc,whichmustbeavalidexception.
Addedinversion3.12.
voidPyErr_Fetch(PyObject**ptype,PyObject**pvalue,PyObject**ptraceback)
PartoftheStableABI.Deprecatedsinceversion3.12: UsePyErr_GetRaisedException()instead.
Retrievetheerrorindicatorintothreevariableswhoseaddressesarepassed. Iftheerrorindicatorisnotset,
setallthreevariablestoNULL.Ifitisset,itwillbeclearedandyouownareferencetoeachobjectretrieved.
ThevalueandtracebackobjectmaybeNULLevenwhenthetypeobjectisnot.
(cid:174) Note
Thisfunctionisnormallyonlyusedbylegacycodethatneedstocatchexceptionsorsaveandrestorethe
errorindicatortemporarily.
Forexample:
56 Chapter5. ExceptionHandling

| (cid:181) Seealso |
| --- |
| PyErr_GetHandledException(),tosavetheexceptioncurrentlybeinghandled. |


| (cid:193) Warning |
| --- |
| Thiscallstealsareferencetoexc,whichmustbeavalidexception. |

### 第65页

{
PyObject *type, *value, *traceback;
PyErr_Fetch(&type, &value, &traceback);
/* ... code that might produce other errors ... */
PyErr_Restore(type, value, traceback);
}
voidPyErr_Restore(PyObject*type,PyObject*value,PyObject*traceback)
PartoftheStableABI.Deprecatedsinceversion3.12: UsePyErr_SetRaisedException()instead.
Settheerrorindicatorfromthethreeobjects,type,value,andtraceback,clearingtheexistingexceptionifone
isset. IftheobjectsareNULL,theerrorindicatoriscleared. DonotpassaNULLtypeandnon-NULLvalueor
traceback. Theexceptiontypeshouldbeaclass. Donotpassaninvalidexceptiontypeorvalue. (Violating
theseruleswillcausesubtleproblemslater.) Thiscalltakesawayareferencetoeachobject: youmustown
areferencetoeachobjectbeforethecallandafterthecallyounolongerownthesereferences. (Ifyoudon’t
understandthis,don’tusethisfunction. Iwarnedyou.)
(cid:174) Note
Thisfunctionisnormallyonlyusedbylegacycodethatneedstosaveandrestoretheerrorindicatortem-
porarily. UsePyErr_Fetch()tosavethecurrenterrorindicator.
voidPyErr_NormalizeException(PyObject**exc,PyObject**val,PyObject**tb)
Part of the Stable ABI. Deprecated since version 3.12: Use PyErr_GetRaisedException() instead, to
avoidanypossiblede-normalization.
Undercertaincircumstances,thevaluesreturnedbyPyErr_Fetch()belowcanbe“unnormalized”,meaning
that*excisaclassobjectbut*valisnotaninstanceofthesameclass. Thisfunctioncanbeusedtoinstantiate
the class in that case. If the values are already normalized, nothing happens. The delayed normalization is
implementedtoimproveperformance.
(cid:174) Note
Thisfunctiondoesnot implicitlysetthe__traceback__attributeontheexceptionvalue. Ifsettingthe
tracebackappropriatelyisdesired,thefollowingadditionalsnippetisneeded:
if (tb != NULL) {
PyException_SetTraceback(val, tb);
}
PyObject*PyErr_GetHandledException(void)
Part of the Stable ABI since version 3.11. Retrieve the active exception instance, as would be returned by
sys.exception(). Thisreferstoanexceptionthatwasalreadycaught,nottoanexceptionthatwasfreshly
raised. ReturnsanewreferencetotheexceptionorNULL.Doesnotmodifytheinterpreter’sexceptionstate.
(cid:174) Note
Thisfunctionisnotnormallyusedbycodethatwantstohandleexceptions. Rather,itcanbeusedwhen
codeneedstosaveandrestoretheexceptionstatetemporarily. UsePyErr_SetHandledException()
torestoreorcleartheexceptionstate.
Addedinversion3.11.
5.4. Queryingtheerrorindicator 57

### 第66页

voidPyErr_SetHandledException(PyObject*exc)
PartoftheStableABIsinceversion3.11. Settheactiveexception,asknownfromsys.exception(). This
referstoanexceptionthatwasalreadycaught,nottoanexceptionthatwasfreshlyraised. Tocleartheexception
state,passNULL.
(cid:174) Note
Thisfunctionisnotnormallyusedbycodethatwantstohandleexceptions. Rather,itcanbeusedwhen
codeneedstosaveandrestoretheexceptionstatetemporarily. UsePyErr_GetHandledException()
togettheexceptionstate.
Addedinversion3.11.
voidPyErr_GetExcInfo(PyObject**ptype,PyObject**pvalue,PyObject**ptraceback)
Part of the Stable ABI since version 3.7. Retrieve the old-style representation of the exception info, as
known from sys.exc_info(). This refers to an exception that was already caught, not to an excep-
tion that was freshly raised. Returns new references for the three objects, any of which may be NULL.
Does not modify the exception info state. This function is kept for backwards compatibility. Prefer using
PyErr_GetHandledException().
(cid:174) Note
Thisfunctionisnotnormallyusedbycodethatwantstohandleexceptions. Rather,itcanbeusedwhen
codeneedstosaveandrestoretheexceptionstatetemporarily. UsePyErr_SetExcInfo()torestoreor
cleartheexceptionstate.
Addedinversion3.3.
voidPyErr_SetExcInfo(PyObject*type,PyObject*value,PyObject*traceback)
PartoftheStableABIsinceversion3.7. Settheexceptioninfo,asknownfromsys.exc_info(). Thisrefers
toanexceptionthatwasalreadycaught,nottoanexceptionthatwasfreshlyraised. Thisfunctionstealsthe
referencesofthearguments. Tocleartheexceptionstate,passNULLforallthreearguments. Thisfunctionis
keptforbackwardscompatibility. PreferusingPyErr_SetHandledException().
(cid:174) Note
Thisfunctionisnotnormallyusedbycodethatwantstohandleexceptions. Rather,itcanbeusedwhen
codeneedstosaveandrestoretheexceptionstatetemporarily. UsePyErr_GetExcInfo()toreadthe
exceptionstate.
Addedinversion3.3.
Changedinversion3.11: ThetypeandtracebackargumentsarenolongerusedandcanbeNULL.The
interpreter now derives them from the exception instance (the value argument). The function still steals
referencesofallthreearguments.
5.5 Signal Handling
intPyErr_CheckSignals()
PartoftheStableABI.ThisfunctioninteractswithPython’ssignalhandling.
IfthefunctioniscalledfromthemainthreadandunderthemainPythoninterpreter,itcheckswhetherasignal
hasbeensenttotheprocessesandifso,invokesthecorrespondingsignalhandler. Ifthesignalmoduleis
supported,thiscaninvokeasignalhandlerwritteninPython.
58 Chapter5. ExceptionHandling

### 第67页

Thefunctionattemptstohandleallpendingsignals,andthenreturns0. However,ifaPythonsignalhandler
raisesanexception,theerrorindicatorissetandthefunctionreturns-1immediately(suchthatotherpending
signalsmaynothavebeenhandledyet: theywillbeonthenextPyErr_CheckSignals()invocation).
Ifthefunctioniscalledfromanon-mainthread,orunderanon-mainPythoninterpreter,itdoesnothingand
returns0.
Thisfunctioncanbecalledbylong-runningCcodethatwantstobeinterruptiblebyuserrequests(suchasby
pressingCtrl-C).
(cid:174) Note
ThedefaultPythonsignalhandlerforSIGINTraisestheKeyboardInterruptexception.
voidPyErr_SetInterrupt()
Part of the Stable ABI. Simulate the effect of a SIGINT signal arriving. This is equivalent to
PyErr_SetInterruptEx(SIGINT).
(cid:174) Note
This function is async-signal-safe. It can be called without an attached thread state and from a C signal
handler.
intPyErr_SetInterruptEx(intsignum)
Part of the Stable ABI since version 3.10. Simulate the effect of a signal arriving. The next time
PyErr_CheckSignals()iscalled,thePythonsignalhandlerforthegivensignalnumberwillbecalled.
ThisfunctioncanbecalledbyCcodethatsetsupitsownsignalhandlingandwantsPythonsignalhandlers
to be invoked as expected when an interruption is requested (for example when the user presses Ctrl-C to
interruptanoperation).
Ifthegivensignalisn’thandledbyPython(itwassettosignal.SIG_DFLorsignal.SIG_IGN),itwillbe
ignored.
If signum is outside of the allowed range of signal numbers, -1 is returned. Otherwise, 0 is returned. The
errorindicatorisneverchangedbythisfunction.
(cid:174) Note
This function is async-signal-safe. It can be called without an attached thread state and from a C signal
handler.
Addedinversion3.10.
intPySignal_SetWakeupFd(intfd)
Thisutilityfunctionspecifiesafiledescriptortowhichthesignalnumberiswrittenasasinglebytewhenever
asignalisreceived. fdmustbenon-blocking. Itreturnstheprevioussuchfiledescriptor.
Thevalue-1disablesthefeature;thisistheinitialstate. Thisisequivalenttosignal.set_wakeup_fd()
inPython,butwithoutanyerrorchecking. fd shouldbeavalidfiledescriptor. Thefunctionshouldonlybe
calledfromthemainthread.
Changedinversion3.5: OnWindows,thefunctionnowalsosupportssockethandles.
5.5. SignalHandling 59

### 第68页

5.6 Exception Classes
PyObject*PyErr_NewException(constchar*name,PyObject*base,PyObject*dict)
Returnvalue: Newreference. PartoftheStableABI.Thisutilityfunctioncreatesandreturnsanewexception
class. Thenameargumentmustbethenameofthenewexception,aCstringoftheformmodule.classname.
ThebaseanddictargumentsarenormallyNULL.ThiscreatesaclassobjectderivedfromException(acces-
sibleinCasPyExc_Exception).
The__module__attributeofthenewclassissettothefirstpart(uptothelastdot)ofthenameargument,
andtheclassnameissettothelastpart(afterthelastdot). Thebaseargumentcanbeusedtospecifyalternate
baseclasses;itcaneitherbeonlyoneclassoratupleofclasses. Thedict argumentcanbeusedtospecifya
dictionaryofclassvariablesandmethods.
PyObject*PyErr_NewExceptionWithDoc(constchar*name,constchar*doc,PyObject*base,PyObject*dict)
Returnvalue: Newreference. PartoftheStableABI.SameasPyErr_NewException(),exceptthatthenew
exception class can easily be given a docstring: If doc is non-NULL, it will be used as the docstring for the
exceptionclass.
Addedinversion3.2.
intPyExceptionClass_Check(PyObject*ob)
Returnnon-zeroifobisanexceptionclass,zerootherwise. Thisfunctionalwayssucceeds.
constchar*PyExceptionClass_Name(PyObject*ob)
PartoftheStableABIsinceversion3.8. Returntp_nameoftheexceptionclassob.
5.7 Exception Objects
PyObject*PyException_GetTraceback(PyObject*ex)
Return value: New reference. Part of the Stable ABI. Return the traceback associated with the exception as
anewreference, asaccessiblefromPythonthroughthe__traceback__attribute. Ifthereisnotraceback
associated,thisreturnsNULL.
intPyException_SetTraceback(PyObject*ex,PyObject*tb)
PartoftheStableABI.Setthetracebackassociatedwiththeexceptiontotb. UsePy_Nonetoclearit.
PyObject*PyException_GetContext(PyObject*ex)
Return value: New reference. Part of the Stable ABI. Return the context (another exception instance during
whose handling ex was raised) associated with the exception as a new reference, as accessible from Python
throughthe__context__attribute. Ifthereisnocontextassociated,thisreturnsNULL.
voidPyException_SetContext(PyObject*ex,PyObject*ctx)
PartoftheStableABI.Setthecontextassociatedwiththeexceptiontoctx. UseNULLtoclearit. Thereisno
typechecktomakesurethatctxisanexceptioninstance. Thisstealsareferencetoctx.
PyObject*PyException_GetCause(PyObject*ex)
Returnvalue: Newreference. PartoftheStableABI.Returnthecause(eitheranexceptioninstance,orNone,
setbyraise ... from ...)associatedwiththeexceptionasanewreference,asaccessiblefromPython
throughthe__cause__attribute.
voidPyException_SetCause(PyObject*ex,PyObject*cause)
PartoftheStableABI.Setthecauseassociatedwiththeexceptiontocause. UseNULLtoclearit. Thereisno
typechecktomakesurethatcauseiseitheranexceptioninstanceorNone. Thisstealsareferencetocause.
The__suppress_context__attributeisimplicitlysettoTruebythisfunction.
PyObject*PyException_GetArgs(PyObject*ex)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.12. Returnargsofexceptionex.
60 Chapter5. ExceptionHandling

### 第69页

voidPyException_SetArgs(PyObject*ex,PyObject*args)
PartoftheStableABIsinceversion3.12. Setargsofexceptionextoargs.
PyObject*PyUnstable_Exc_PrepReraiseStar(PyObject*orig,PyObject*excs)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Implementpartoftheinterpreter’simplementationofexcept*. origistheoriginalexceptionthatwascaught,
andexcsisthelistoftheexceptionsthatneedtoberaised. Thislistcontainstheunhandledpartoforig,ifany,
aswellastheexceptionsthatwereraisedfromtheexcept*clauses(sotheyhaveadifferenttracebackfrom
orig)andthosethatwerereraised(andhavethesametracebackasorig). ReturntheExceptionGroupthat
needstobereraisedintheend,orNoneifthereisnothingtoreraise.
Addedinversion3.12.
5.8 Unicode Exception Objects
ThefollowingfunctionsareusedtocreateandmodifyUnicodeexceptionsfromC.
PyObject*PyUnicodeDecodeError_Create(constchar*encoding,constchar*object,Py_ssize_tlength,
Py_ssize_tstart,Py_ssize_tend,constchar*reason)
Return value: New reference. Part of the Stable ABI. Create a UnicodeDecodeError object with the at-
tributesencoding,object,length,start,endandreason. encodingandreasonareUTF-8encodedstrings.
PyObject*PyUnicodeDecodeError_GetEncoding(PyObject*exc)
PyObject*PyUnicodeEncodeError_GetEncoding(PyObject*exc)
Return value: New reference. Part of the Stable ABI. Return the encoding attribute of the given exception
object.
PyObject*PyUnicodeDecodeError_GetObject(PyObject*exc)
PyObject*PyUnicodeEncodeError_GetObject(PyObject*exc)
PyObject*PyUnicodeTranslateError_GetObject(PyObject*exc)
Returnvalue: Newreference. PartoftheStableABI.Returntheobjectattributeofthegivenexceptionobject.
intPyUnicodeDecodeError_GetStart(PyObject*exc,Py_ssize_t*start)
intPyUnicodeEncodeError_GetStart(PyObject*exc,Py_ssize_t*start)
intPyUnicodeTranslateError_GetStart(PyObject*exc,Py_ssize_t*start)
PartoftheStableABI.Getthestartattributeofthegivenexceptionobjectandplaceitinto*start. startmust
notbeNULL.Return0onsuccess,-1onfailure.
IftheUnicodeError.objectisanemptysequence,theresultingstartis0. Otherwise,itisclippedto[0,
len(object) - 1].
(cid:181) Seealso
UnicodeError.start
intPyUnicodeDecodeError_SetStart(PyObject*exc,Py_ssize_tstart)
intPyUnicodeEncodeError_SetStart(PyObject*exc,Py_ssize_tstart)
intPyUnicodeTranslateError_SetStart(PyObject*exc,Py_ssize_tstart)
PartoftheStableABI.Setthestartattributeofthegivenexceptionobjecttostart. Return0onsuccess,-1on
failure.
5.8. UnicodeExceptionObjects 61

| (cid:181) Seealso |
| --- |
| UnicodeError.start |

### 第70页

(cid:174) Note
Whilepassinganegativestartdoesnotraiseanexception,thecorrespondinggetterswillnotconsideritas
arelativeoffset.
intPyUnicodeDecodeError_GetEnd(PyObject*exc,Py_ssize_t*end)
intPyUnicodeEncodeError_GetEnd(PyObject*exc,Py_ssize_t*end)
intPyUnicodeTranslateError_GetEnd(PyObject*exc,Py_ssize_t*end)
PartoftheStableABI.Gettheendattributeofthegivenexceptionobjectandplaceitinto*end. endmustnot
beNULL.Return0onsuccess,-1onfailure.
IftheUnicodeError.objectisanemptysequence,theresultingendis0. Otherwise,itisclippedto[1,
len(object)].
intPyUnicodeDecodeError_SetEnd(PyObject*exc,Py_ssize_tend)
intPyUnicodeEncodeError_SetEnd(PyObject*exc,Py_ssize_tend)
intPyUnicodeTranslateError_SetEnd(PyObject*exc,Py_ssize_tend)
PartoftheStableABI.Settheendattributeofthegivenexceptionobjecttoend. Return0onsuccess,-1on
failure.
(cid:181) Seealso
UnicodeError.end
PyObject*PyUnicodeDecodeError_GetReason(PyObject*exc)
PyObject*PyUnicodeEncodeError_GetReason(PyObject*exc)
PyObject*PyUnicodeTranslateError_GetReason(PyObject*exc)
Returnvalue: Newreference. PartoftheStableABI.Returnthereasonattributeofthegivenexceptionobject.
intPyUnicodeDecodeError_SetReason(PyObject*exc,constchar*reason)
intPyUnicodeEncodeError_SetReason(PyObject*exc,constchar*reason)
intPyUnicodeTranslateError_SetReason(PyObject*exc,constchar*reason)
PartoftheStableABI.Setthereasonattributeofthegivenexceptionobjecttoreason. Return0onsuccess,
-1onfailure.
5.9 Recursion Control
ThesetwofunctionsprovideawaytoperformsaferecursivecallsattheClevel, bothinthecoreandinextension
modules. TheyareneedediftherecursivecodedoesnotnecessarilyinvokePythoncode(whichtracksitsrecursion
depthautomatically). Theyarealsonotneededfortp_call implementationsbecausethecallprotocol takescareof
recursionhandling.
intPy_EnterRecursiveCall(constchar*where)
PartoftheStableABIsinceversion3.9. MarksapointwherearecursiveC-levelcallisabouttobeperformed.
The function then checks if the stack limit is reached. If this is the case, a RecursionError is set and a
nonzerovalueisreturned. Otherwise,zeroisreturned.
where should be a UTF-8 encoded string such as " in instance check" to be concatenated to the
RecursionErrormessagecausedbytherecursiondepthlimit.
Changedinversion3.9: ThisfunctionisnowalsoavailableinthelimitedAPI.
voidPy_LeaveRecursiveCall(void)
PartoftheStableABIsinceversion3.9. EndsaPy_EnterRecursiveCall(). Mustbecalledonceforeach
successfulinvocationofPy_EnterRecursiveCall().
Changedinversion3.9: ThisfunctionisnowalsoavailableinthelimitedAPI.
62 Chapter5. ExceptionHandling

| (cid:181) Seealso |
| --- |
| UnicodeError.end |

### 第71页

Properlyimplementingtp_reprforcontainertypesrequiresspecialrecursionhandling. Inadditiontoprotectingthe
stack,tp_repralsoneedstotrackobjectstopreventcycles. Thefollowingtwofunctionsfacilitatethisfunctionality.
Effectively,thesearetheCequivalenttoreprlib.recursive_repr().
intPy_ReprEnter(PyObject*object)
PartoftheStableABI.Calledatthebeginningofthetp_reprimplementationtodetectcycles.
If the object has already been processed, the function returns a positive integer. In that case the tp_repr
implementationshouldreturnastringobjectindicatingacycle. Asexamples,dictobjectsreturn{...}and
listobjectsreturn[...].
Thefunctionwillreturnanegativeintegeriftherecursionlimitisreached. Inthatcasethetp_reprimple-
mentationshouldtypicallyreturnNULL.
Otherwise,thefunctionreturnszeroandthetp_reprimplementationcancontinuenormally.
voidPy_ReprLeave(PyObject*object)
Part of the Stable ABI. Ends a Py_ReprEnter(). Must be called once for each invocation of
Py_ReprEnter()thatreturnszero.
5.10 Exception and warning types
All standard Python exceptions and warning categories are available as global variables whose names are PyExc_
followedbythePythonexceptionname. ThesehavethetypePyObject*;theyareallclassobjects.
Forcompleteness,hereareallthevariables:
5.10.1 Exception types
Cname Pythonname
BaseException
PyObject*PyExc_BaseException
PartoftheStableABI.
BaseExceptionGroup
PyObject*PyExc_BaseExceptionGroup
PartoftheStableABIsinceversion3.11.
Exception
PyObject*PyExc_Exception
PartoftheStableABI.
ArithmeticError
PyObject*PyExc_ArithmeticError
PartoftheStableABI.
AssertionError
PyObject*PyExc_AssertionError
PartoftheStableABI.
AttributeError
PyObject*PyExc_AttributeError
PartoftheStableABI.
BlockingIOError
PyObject*PyExc_BlockingIOError
PartoftheStableABIsinceversion3.7.
continuesonnextpage
5.10. Exceptionandwarningtypes 63

| Cname | Pythonname |
| --- | --- |
| PyObject*PyExc_BaseException
PartoftheStableABI. | BaseException |
| PyObject*PyExc_BaseExceptionGroup
PartoftheStableABIsinceversion3.11. | BaseExceptionGroup |
| PyObject*PyExc_Exception
PartoftheStableABI. | Exception |
| PyObject*PyExc_ArithmeticError
PartoftheStableABI. | ArithmeticError |
| PyObject*PyExc_AssertionError
PartoftheStableABI. | AssertionError |
| PyObject*PyExc_AttributeError
PartoftheStableABI. | AttributeError |
| PyObject*PyExc_BlockingIOError
PartoftheStableABIsinceversion3.7. | BlockingIOError |

### 第72页

Table 1–continuedfrompreviouspage
Cname Pythonname
BrokenPipeError
PyObject*PyExc_BrokenPipeError
PartoftheStableABIsinceversion3.7.
BufferError
PyObject*PyExc_BufferError
PartoftheStableABI.
ChildProcessError
PyObject*PyExc_ChildProcessError
PartoftheStableABIsinceversion3.7.
ConnectionAbortedError
PyObject*PyExc_ConnectionAbortedError
PartoftheStableABIsinceversion3.7.
ConnectionError
PyObject*PyExc_ConnectionError
PartoftheStableABIsinceversion3.7.
ConnectionRefusedError
PyObject*PyExc_ConnectionRefusedError
PartoftheStableABIsinceversion3.7.
ConnectionResetError
PyObject*PyExc_ConnectionResetError
PartoftheStableABIsinceversion3.7.
EOFError
PyObject*PyExc_EOFError
PartoftheStableABI.
FileExistsError
PyObject*PyExc_FileExistsError
PartoftheStableABIsinceversion3.7.
FileNotFoundError
PyObject*PyExc_FileNotFoundError
PartoftheStableABIsinceversion3.7.
FloatingPointError
PyObject*PyExc_FloatingPointError
PartoftheStableABI.
GeneratorExit
PyObject*PyExc_GeneratorExit
PartoftheStableABI.
ImportError
PyObject*PyExc_ImportError
PartoftheStableABI.
continuesonnextpage
64 Chapter5. ExceptionHandling

| Cname | Pythonname |
| --- | --- |
| PyObject*PyExc_BrokenPipeError
PartoftheStableABIsinceversion3.7. | BrokenPipeError |
| PyObject*PyExc_BufferError
PartoftheStableABI. | BufferError |
| PyObject*PyExc_ChildProcessError
PartoftheStableABIsinceversion3.7. | ChildProcessError |
| PyObject*PyExc_ConnectionAbortedError
PartoftheStableABIsinceversion3.7. | ConnectionAbortedError |
| PyObject*PyExc_ConnectionError
PartoftheStableABIsinceversion3.7. | ConnectionError |
| PyObject*PyExc_ConnectionRefusedError
PartoftheStableABIsinceversion3.7. | ConnectionRefusedError |
| PyObject*PyExc_ConnectionResetError
PartoftheStableABIsinceversion3.7. | ConnectionResetError |
| PyObject*PyExc_EOFError
PartoftheStableABI. | EOFError |
| PyObject*PyExc_FileExistsError
PartoftheStableABIsinceversion3.7. | FileExistsError |
| PyObject*PyExc_FileNotFoundError
PartoftheStableABIsinceversion3.7. | FileNotFoundError |
| PyObject*PyExc_FloatingPointError
PartoftheStableABI. | FloatingPointError |
| PyObject*PyExc_GeneratorExit
PartoftheStableABI. | GeneratorExit |
| PyObject*PyExc_ImportError
PartoftheStableABI. | ImportError |

### 第73页

Table 1–continuedfrompreviouspage
Cname Pythonname
IndentationError
PyObject*PyExc_IndentationError
PartoftheStableABI.
IndexError
PyObject*PyExc_IndexError
PartoftheStableABI.
InterruptedError
PyObject*PyExc_InterruptedError
PartoftheStableABIsinceversion3.7.
IsADirectoryError
PyObject*PyExc_IsADirectoryError
PartoftheStableABIsinceversion3.7.
KeyError
PyObject*PyExc_KeyError
PartoftheStableABI.
KeyboardInterrupt
PyObject*PyExc_KeyboardInterrupt
PartoftheStableABI.
LookupError
PyObject*PyExc_LookupError
PartoftheStableABI.
MemoryError
PyObject*PyExc_MemoryError
PartoftheStableABI.
ModuleNotFoundError
PyObject*PyExc_ModuleNotFoundError
PartoftheStableABIsinceversion3.6.
NameError
PyObject*PyExc_NameError
PartoftheStableABI.
NotADirectoryError
PyObject*PyExc_NotADirectoryError
PartoftheStableABIsinceversion3.7.
NotImplementedError
PyObject*PyExc_NotImplementedError
PartoftheStableABI.
OSError
PyObject*PyExc_OSError
PartoftheStableABI.
continuesonnextpage
5.10. Exceptionandwarningtypes 65

| Cname | Pythonname |
| --- | --- |
| PyObject*PyExc_IndentationError
PartoftheStableABI. | IndentationError |
| PyObject*PyExc_IndexError
PartoftheStableABI. | IndexError |
| PyObject*PyExc_InterruptedError
PartoftheStableABIsinceversion3.7. | InterruptedError |
| PyObject*PyExc_IsADirectoryError
PartoftheStableABIsinceversion3.7. | IsADirectoryError |
| PyObject*PyExc_KeyError
PartoftheStableABI. | KeyError |
| PyObject*PyExc_KeyboardInterrupt
PartoftheStableABI. | KeyboardInterrupt |
| PyObject*PyExc_LookupError
PartoftheStableABI. | LookupError |
| PyObject*PyExc_MemoryError
PartoftheStableABI. | MemoryError |
| PyObject*PyExc_ModuleNotFoundError
PartoftheStableABIsinceversion3.6. | ModuleNotFoundError |
| PyObject*PyExc_NameError
PartoftheStableABI. | NameError |
| PyObject*PyExc_NotADirectoryError
PartoftheStableABIsinceversion3.7. | NotADirectoryError |
| PyObject*PyExc_NotImplementedError
PartoftheStableABI. | NotImplementedError |
| PyObject*PyExc_OSError
PartoftheStableABI. | OSError |

### 第74页

Table 1–continuedfrompreviouspage
Cname Pythonname
OverflowError
PyObject*PyExc_OverflowError
PartoftheStableABI.
PermissionError
PyObject*PyExc_PermissionError
PartoftheStableABIsinceversion3.7.
ProcessLookupError
PyObject*PyExc_ProcessLookupError
PartoftheStableABIsinceversion3.7.
PythonFinalizationError
PyObject*PyExc_PythonFinalizationError
RecursionError
PyObject*PyExc_RecursionError
PartoftheStableABIsinceversion3.7.
ReferenceError
PyObject*PyExc_ReferenceError
PartoftheStableABI.
RuntimeError
PyObject*PyExc_RuntimeError
PartoftheStableABI.
StopAsyncIteration
PyObject*PyExc_StopAsyncIteration
PartoftheStableABIsinceversion3.7.
StopIteration
PyObject*PyExc_StopIteration
PartoftheStableABI.
SyntaxError
PyObject*PyExc_SyntaxError
PartoftheStableABI.
SystemError
PyObject*PyExc_SystemError
PartoftheStableABI.
SystemExit
PyObject*PyExc_SystemExit
PartoftheStableABI.
TabError
PyObject*PyExc_TabError
PartoftheStableABI.
TimeoutError
PyObject*PyExc_TimeoutError
PartoftheStableABIsinceversion3.7.
continuesonnextpage
66 Chapter5. ExceptionHandling

| Cname | Pythonname |
| --- | --- |
| PyObject*PyExc_OverflowError
PartoftheStableABI. | OverflowError |
| PyObject*PyExc_PermissionError
PartoftheStableABIsinceversion3.7. | PermissionError |
| PyObject*PyExc_ProcessLookupError
PartoftheStableABIsinceversion3.7. | ProcessLookupError |
| PyObject*PyExc_PythonFinalizationError | PythonFinalizationError |
| PyObject*PyExc_RecursionError
PartoftheStableABIsinceversion3.7. | RecursionError |
| PyObject*PyExc_ReferenceError
PartoftheStableABI. | ReferenceError |
| PyObject*PyExc_RuntimeError
PartoftheStableABI. | RuntimeError |
| PyObject*PyExc_StopAsyncIteration
PartoftheStableABIsinceversion3.7. | StopAsyncIteration |
| PyObject*PyExc_StopIteration
PartoftheStableABI. | StopIteration |
| PyObject*PyExc_SyntaxError
PartoftheStableABI. | SyntaxError |
| PyObject*PyExc_SystemError
PartoftheStableABI. | SystemError |
| PyObject*PyExc_SystemExit
PartoftheStableABI. | SystemExit |
| PyObject*PyExc_TabError
PartoftheStableABI. | TabError |
| PyObject*PyExc_TimeoutError
PartoftheStableABIsinceversion3.7. | TimeoutError |

### 第75页

Table 1–continuedfrompreviouspage
Cname Pythonname
TypeError
PyObject*PyExc_TypeError
PartoftheStableABI.
UnboundLocalError
PyObject*PyExc_UnboundLocalError
PartoftheStableABI.
UnicodeDecodeError
PyObject*PyExc_UnicodeDecodeError
PartoftheStableABI.
UnicodeEncodeError
PyObject*PyExc_UnicodeEncodeError
PartoftheStableABI.
UnicodeError
PyObject*PyExc_UnicodeError
PartoftheStableABI.
UnicodeTranslateError
PyObject*PyExc_UnicodeTranslateError
PartoftheStableABI.
ValueError
PyObject*PyExc_ValueError
PartoftheStableABI.
ZeroDivisionError
PyObject*PyExc_ZeroDivisionError
PartoftheStableABI.
Addedinversion3.3: PyExc_BlockingIOError,PyExc_BrokenPipeError,PyExc_ChildProcessError,
PyExc_ConnectionError, PyExc_ConnectionAbortedError, PyExc_ConnectionRefusedError,
PyExc_ConnectionResetError, PyExc_FileExistsError, PyExc_FileNotFoundError,
PyExc_InterruptedError, PyExc_IsADirectoryError, PyExc_NotADirectoryError,
PyExc_PermissionError, PyExc_ProcessLookupError and PyExc_TimeoutError were introduced
followingPEP3151.
Addedinversion3.5: PyExc_StopAsyncIterationandPyExc_RecursionError.
Addedinversion3.6: PyExc_ModuleNotFoundError.
Addedinversion3.11: PyExc_BaseExceptionGroup.
5.10.2 OSError aliases
ThefollowingareacompatibilityaliasestoPyExc_OSError.
Changedinversion3.3: Thesealiasesusedtobeseparateexceptiontypes.
5.10. Exceptionandwarningtypes 67

| Cname | Pythonname |
| --- | --- |
| PyObject*PyExc_TypeError
PartoftheStableABI. | TypeError |
| PyObject*PyExc_UnboundLocalError
PartoftheStableABI. | UnboundLocalError |
| PyObject*PyExc_UnicodeDecodeError
PartoftheStableABI. | UnicodeDecodeError |
| PyObject*PyExc_UnicodeEncodeError
PartoftheStableABI. | UnicodeEncodeError |
| PyObject*PyExc_UnicodeError
PartoftheStableABI. | UnicodeError |
| PyObject*PyExc_UnicodeTranslateError
PartoftheStableABI. | UnicodeTranslateError |
| PyObject*PyExc_ValueError
PartoftheStableABI. | ValueError |
| PyObject*PyExc_ZeroDivisionError
PartoftheStableABI. | ZeroDivisionError |

### 第76页

Cname Pythonname Notes
OSError
PyObject
*PyExc_EnvironmentError
PartoftheStableABI.
OSError
PyObject*PyExc_IOError
PartoftheStableABI.
OSError [win]
PyObject
*PyExc_WindowsError
Part of the Stable ABI on
Windowssinceversion3.7.
Notes:
68 Chapter5. ExceptionHandling

| Cname | Pythonname | Notes |
| --- | --- | --- |
| PyObject
*PyExc_EnvironmentError
PartoftheStableABI. | OSError |  |
| PyObject*PyExc_IOError
PartoftheStableABI. | OSError |  |
| PyObject
*PyExc_WindowsError
Part of the Stable ABI on
Windowssinceversion3.7. | OSError | [win] |

### 第77页

5.10.3 Warning types
Cname Pythonname
Warning
PyObject*PyExc_Warning
PartoftheStableABI.
BytesWarning
PyObject*PyExc_BytesWarning
PartoftheStableABI.
DeprecationWarning
PyObject*PyExc_DeprecationWarning
PartoftheStableABI.
EncodingWarning
PyObject*PyExc_EncodingWarning
PartoftheStableABIsinceversion3.10.
FutureWarning
PyObject*PyExc_FutureWarning
PartoftheStableABI.
ImportWarning
PyObject*PyExc_ImportWarning
PartoftheStableABI.
PendingDeprecationWarning
PyObject*PyExc_PendingDeprecationWarning
PartoftheStableABI.
ResourceWarning
PyObject*PyExc_ResourceWarning
PartoftheStableABIsinceversion3.7.
RuntimeWarning
PyObject*PyExc_RuntimeWarning
PartoftheStableABI.
SyntaxWarning
PyObject*PyExc_SyntaxWarning
PartoftheStableABI.
UnicodeWarning
PyObject*PyExc_UnicodeWarning
PartoftheStableABI.
UserWarning
PyObject*PyExc_UserWarning
PartoftheStableABI.
Addedinversion3.2: PyExc_ResourceWarning.
Addedinversion3.10: PyExc_EncodingWarning.
5.10. Exceptionandwarningtypes 69

| Cname | Pythonname |
| --- | --- |
| PyObject*PyExc_Warning
PartoftheStableABI. | Warning |
| PyObject*PyExc_BytesWarning
PartoftheStableABI. | BytesWarning |
| PyObject*PyExc_DeprecationWarning
PartoftheStableABI. | DeprecationWarning |
| PyObject*PyExc_EncodingWarning
PartoftheStableABIsinceversion3.10. | EncodingWarning |
| PyObject*PyExc_FutureWarning
PartoftheStableABI. | FutureWarning |
| PyObject*PyExc_ImportWarning
PartoftheStableABI. | ImportWarning |
| PyObject*PyExc_PendingDeprecationWarning
PartoftheStableABI. | PendingDeprecationWarning |
| PyObject*PyExc_ResourceWarning
PartoftheStableABIsinceversion3.7. | ResourceWarning |
| PyObject*PyExc_RuntimeWarning
PartoftheStableABI. | RuntimeWarning |
| PyObject*PyExc_SyntaxWarning
PartoftheStableABI. | SyntaxWarning |
| PyObject*PyExc_UnicodeWarning
PartoftheStableABI. | UnicodeWarning |
| PyObject*PyExc_UserWarning
PartoftheStableABI. | UserWarning |

### 第78页

70 Chapter5. ExceptionHandling

### 第79页

CHAPTER
SIX
DEFINING EXTENSION MODULES
ACextensionforCPythonisasharedlibrary(forexample,a.sofileonLinux,.pydDLLonWindows),whichis
loadableintothePythonprocess(forexample,itiscompiledwithcompatiblecompilersettings),andwhichexports
aninitializationfunction.
To be importable by default (that is, by importlib.machinery.ExtensionFileLoader), the shared library
mustbeavailableonsys.path,andmustbenamedafterthemodulenameplusanextensionlistedinimportlib.
machinery.EXTENSION_SUFFIXES.
(cid:174) Note
Building,packaginganddistributingextensionmodulesisbestdonewiththird-partytools,andisoutofscopeof
thisdocument. OnesuitabletoolisSetuptools,whosedocumentationcanbefoundathttps://setuptools.pypa.io/
en/latest/setuptools.html.
Normally, the initialization function returns a module definition initialized using PyModuleDef_Init(). This
allowssplittingthecreationprocessintoseveralphases:
• Beforeanysubstantialcodeisexecuted,Pythoncandeterminewhichcapabilitiesthemodulesupports,andit
canadjusttheenvironmentorrefuseloadinganincompatibleextension.
• Bydefault,Pythonitselfcreatesthemoduleobject–thatis,itdoestheequivalentofobject.__new__()for
classes. Italsosetsinitialattributeslike__package__and__loader__.
• Afterwards,themoduleobjectisinitializedusingextension-specificcode–theequivalentof__init__()on
classes.
Thisiscalledmulti-phaseinitializationtodistinguishitfromthelegacy(butstillsupported)single-phaseinitialization
scheme,wheretheinitializationfunctionreturnsafullyconstructedmodule. Seethesingle-phase-initializationsection
belowfordetails.
Changedinversion3.5: Addedsupportformulti-phaseinitialization(PEP489).
6.1 Multiple module instances
Bydefault,extensionmodulesarenotsingletons. Forexample,ifthesys.modulesentryisremovedandthemodule
isre-imported,anewmoduleobjectiscreated,andtypicallypopulatedwithfreshmethodandtypeobjects. Theold
moduleissubjecttonormalgarbagecollection. Thismirrorsthebehaviorofpure-Pythonmodules.
Additional module instances may be created in sub-interpreters or after Python runtime reinitialization
(Py_Finalize() and Py_Initialize()). In these cases, sharing Python objects between module instances
wouldlikelycausecrashesorundefinedbehavior.
Toavoidsuchissues, eachinstanceofanextensionmoduleshouldbeisolated: changestooneinstanceshouldnot
implicitly affect the others, and all state owned by the module, including references to Python objects, should be
specifictoaparticularmoduleinstance. Seeisolating-extensions-howtoformoredetailsandapracticalguide.
Asimplerwaytoavoidtheseissuesisraisinganerroronrepeatedinitialization.
71

### 第80页

All modules are expected to support sub-interpreters, or otherwise explicitly signal a lack of support. This is usu-
allyachievedbyisolationorblockingrepeatedinitialization, asabove. Amodulemayalsobelimitedtothemain
interpreterusingthePy_mod_multiple_interpretersslot.
6.2 Initialization function
Theinitializationfunctiondefinedbyanextensionmodulehasthefollowingsignature:
PyObject*PyInit_modulename(void)
ItsnameshouldbePyInit_<name>,with<name>replacedbythenameofthemodule.
FormoduleswithASCII-onlynames,thefunctionmustinsteadbenamedPyInit_<name>,with<name>replaced
bythenameofthemodule. Whenusing Multi-phase initialization, non-ASCIImodule namesareallowed. In this
case,theinitializationfunctionnameisPyInitU_<name>,with<name>encodedusingPython’spunycodeencoding
withhyphensreplacedbyunderscores. InPython:
def initfunc_name(name):
try:
suffix = b'_' + name.encode('ascii')
except UnicodeEncodeError:
suffix = b'U_' + name.encode('punycode').replace(b'-', b'_')
return b'PyInit' + suffix
Itisrecommendedtodefinetheinitializationfunctionusingahelpermacro:
PyMODINIT_FUNC
Declareanextensionmoduleinitializationfunction. Thismacro:
• specifiesthePyObject*returntype,
• addsanyspeciallinkagedeclarationsrequiredbytheplatform,and
• forC++,declaresthefunctionasextern "C".
Forexample,amodulecalledspamwouldbedefinedlikethis:
static struct PyModuleDef spam_module = {
.m_base = PyModuleDef_HEAD_INIT,
.m_name = "spam",
...
};
PyMODINIT_FUNC
PyInit_spam(void)
{
return PyModuleDef_Init(&spam_module);
}
It is possible to export multiple modules from a single shared library by defining multiple initialization functions.
However,importingthemrequiresusingsymboliclinksoracustomimporter,becausebydefaultonlythefunction
correspondingtothefilenameisfound. SeetheMultiplemodulesinonelibrarysectioninPEP489fordetails.
Theinitializationfunctionistypicallytheonlynon-staticitemdefinedinthemodule’sCsource.
6.3 Multi-phase initialization
Normally, the initialization function (PyInit_modulename) returns a PyModuleDef instance with non-NULL
m_slots. Beforeitisreturned,thePyModuleDefinstancemustbeinitializedusingthefollowingfunction:
72 Chapter6. Definingextensionmodules

### 第81页

PyObject*PyModuleDef_Init(PyModuleDef *def)
PartoftheStableABIsinceversion3.5. EnsureamoduledefinitionisaproperlyinitializedPythonobjectthat
correctlyreportsitstypeandareferencecount.
Returndef casttoPyObject*,orNULLifanerroroccurred.
CallingthisfunctionisrequiredforMulti-phaseinitialization. Itshouldnotbeusedinothercontexts.
Note that Python assumes that PyModuleDef structures are statically allocated. This function may return
eitheranewreferenceoraborrowedone;thisreferencemustnotbereleased.
Addedinversion3.5.
6.4 Legacy single-phase initialization
(cid:193) Attention
Single-phase initialization is a legacy mechanism to initialize extension modules, with known drawbacks and
designflaws. Extensionmoduleauthorsareencouragedtousemulti-phaseinitializationinstead.
In single-phase initialization, the initialization function (PyInit_modulename) should create, populate
and return a module object. This is typically done using PyModule_Create() and functions like
PyModule_AddObjectRef().
Single-phaseinitializationdiffersfromthedefaultinthefollowingways:
• Single-phasemodulesare,orrathercontain,“singletons”.
Whenthemoduleisfirstinitialized,Pythonsavesthecontentsofthemodule’s__dict__(thatis,typically,
themodule’sfunctionsandtypes).
Forsubsequentimports,Pythondoesnotcalltheinitializationfunctionagain. Instead,itcreatesanewmodule
objectwithanew__dict__,andcopiesthesavedcontentstoit. Forexample,givenasingle-phasemodule
_testsinglephase1thatdefinesafunctionsumandanexceptionclasserror:
>>> import sys
>>> import _testsinglephase as one
>>> del sys.modules['_testsinglephase']
>>> import _testsinglephase as two
>>> one is two
False
>>> one.__dict__ is two.__dict__
False
>>> one.sum is two.sum
True
>>> one.error is two.error
True
TheexactbehaviorshouldbeconsideredaCPythonimplementationdetail.
• ToworkaroundthefactthatPyInit_modulenamedoesnottakeaspecargument,somestateoftheimport
machinery is saved and applied to the first suitable module created during the PyInit_modulename call.
Specifically,whenasub-moduleisimported,thismechanismprependstheparentpackagenametothename
ofthemodule.
Asingle-phasePyInit_modulenamefunctionshouldcreate“its”moduleobjectassoonaspossible,before
anyothermoduleobjectscanbecreated.
• Non-ASCIImodulenames(PyInitU_modulename)arenotsupported.
• Single-phasemodulessupportmodulelookupfunctionslikePyState_FindModule().
1_testsinglephaseisaninternalmoduleusedinCPython’sself-testsuite;yourinstallationmayormaynotincludeit.
6.4. Legacysingle-phaseinitialization 73

| (cid:193) Attention |
| --- |
| Single-phase initialization is a legacy mechanism to initialize extension modules, with known drawbacks and
designflaws. Extensionmoduleauthorsareencouragedtousemulti-phaseinitializationinstead. |

### 第82页

74 Chapter6. Definingextensionmodules

### 第83页

CHAPTER
SEVEN
UTILITIES
The functions in this chapter perform various utility tasks, ranging from helping C code be more portable across
platforms, using Python modules from C, and parsing function arguments and constructing Python values from C
values.
7.1 Operating System Utilities
PyObject*PyOS_FSPath(PyObject*path)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.6. Returnthefilesystemrepresentationfor
path. Iftheobjectisastrorbytesobject,thenanewstrongreferenceisreturned. Iftheobjectimplements
theos.PathLikeinterface,then__fspath__()isreturnedaslongasitisastrorbytesobject. Otherwise
TypeErrorisraisedandNULLisreturned.
Addedinversion3.6.
intPy_FdIsInteractive(FILE*fp,constchar*filename)
Returntrue(nonzero)ifthestandardI/Ofilefpwithnamefilenameisdeemedinteractive. Thisisthecasefor
files for which isatty(fileno(fp)) is true. If the PyConfig.interactive is non-zero, this function
alsoreturnstrueifthefilenamepointerisNULLorifthenameisequaltooneofthestrings'<stdin>'or
'???'.
ThisfunctionmustnotbecalledbeforePythonisinitialized.
voidPyOS_BeforeFork()
Part of the Stable ABI on platforms with fork() since version 3.7. Function to prepare some internal state
before a process fork. This should be called before calling fork() or any similar function that clones the
currentprocess. Onlyavailableonsystemswherefork()isdefined.
(cid:193) Warning
TheCfork()callshouldonlybemadefromthe“main”thread (ofthe“main”interpreter). Thesameis
trueforPyOS_BeforeFork().
Addedinversion3.7.
voidPyOS_AfterFork_Parent()
PartoftheStableABIonplatformswithfork()sinceversion3.7. Functiontoupdatesomeinternalstateafter
aprocessfork. Thisshouldbecalledfromtheparentprocessaftercallingfork()oranysimilarfunctionthat
clonesthecurrentprocess, regardlessofwhetherprocesscloningwassuccessful. Onlyavailableonsystems
wherefork()isdefined.
(cid:193) Warning
TheCfork()callshouldonlybemadefromthe“main”thread (ofthe“main”interpreter). Thesameis
trueforPyOS_AfterFork_Parent().
75

| (cid:193) Warning |
| --- |
| TheCfork()callshouldonlybemadefromthe“main”thread (ofthe“main”interpreter). Thesameis
trueforPyOS_BeforeFork(). |


| (cid:193) Warning |
| --- |
| TheCfork()callshouldonlybemadefromthe“main”thread (ofthe“main”interpreter). Thesameis
trueforPyOS_AfterFork_Parent(). |

### 第84页

Addedinversion3.7.
voidPyOS_AfterFork_Child()
PartoftheStableABIonplatformswithfork()sinceversion3.7. Functiontoupdateinternalinterpreterstate
afteraprocessfork. Thismustbecalledfromthechildprocessaftercallingfork(),oranysimilarfunction
that clones the current process, if there is any chance the process will call back into the Python interpreter.
Onlyavailableonsystemswherefork()isdefined.
(cid:193) Warning
TheCfork()callshouldonlybemadefromthe“main”thread (ofthe“main”interpreter). Thesameis
trueforPyOS_AfterFork_Child().
Addedinversion3.7.
(cid:181) Seealso
os.register_at_fork() allows registering custom Python functions to be called by
PyOS_BeforeFork(),PyOS_AfterFork_Parent()andPyOS_AfterFork_Child().
voidPyOS_AfterFork()
PartoftheStableABIonplatformswithfork(). Functiontoupdatesomeinternalstateafteraprocessfork;
thisshouldbecalledinthenewprocessifthePythoninterpreterwillcontinuetobeused. Ifanewexecutable
isloadedintothenewprocess,thisfunctiondoesnotneedtobecalled.
Deprecatedsinceversion3.7: ThisfunctionissupersededbyPyOS_AfterFork_Child().
intPyOS_CheckStack()
PartoftheStableABIonplatformswithUSE_STACKCHECKsinceversion3.7. Returntruewhentheinterpreter
runs out of stack space. This is a reliable check, but is only available when USE_STACKCHECK is defined
(currentlyoncertainversionsofWindowsusingtheMicrosoftVisualC++compiler). USE_STACKCHECKwill
bedefinedautomatically;youshouldneverchangethedefinitioninyourowncode.
typedefvoid(*PyOS_sighandler_t)(int)
PartoftheStableABI.
PyOS_sighandler_tPyOS_getsig(inti)
Part of the Stable ABI. Return the current signal handler for signal i. This is a thin wrapper around either
sigaction()orsignal(). Donotcallthosefunctionsdirectly!
PyOS_sighandler_tPyOS_setsig(inti,PyOS_sighandler_th)
PartoftheStableABI.Setthesignalhandlerforsignalitobeh;returntheoldsignalhandler. Thisisathin
wrapperaroundeithersigaction()orsignal(). Donotcallthosefunctionsdirectly!
wchar_t*Py_DecodeLocale(constchar*arg,size_t*size)
PartoftheStableABIsinceversion3.7.
(cid:193) Warning
This function should not be called directly: use the PyConfig API with the
PyConfig_SetBytesString()functionwhichensuresthatPythonispreinitialized.
ThisfunctionmustnotbecalledbeforePythonispreinitializedandsothattheLC_CTYPElocaleisproperly
configured: seethePy_PreInitialize()function.
Decodeabytestringfromthefilesystemencodinganderrorhandler. Iftheerrorhandlerissurrogateescapeer-
rorhandler,undecodablebytesaredecodedascharactersinrangeU+DC80..U+DCFF;andifabytesequence
76 Chapter7. Utilities

| (cid:193) Warning |
| --- |
| TheCfork()callshouldonlybemadefromthe“main”thread (ofthe“main”interpreter). Thesameis
trueforPyOS_AfterFork_Child(). |


| (cid:181) Seealso |
| --- |
| os.register_at_fork() allows registering custom Python functions to be called by
PyOS_BeforeFork(),PyOS_AfterFork_Parent()andPyOS_AfterFork_Child(). |


| (cid:193) Warning |
| --- |
| This function should not be called directly: use the PyConfig API with the
PyConfig_SetBytesString()functionwhichensuresthatPythonispreinitialized.
ThisfunctionmustnotbecalledbeforePythonispreinitializedandsothattheLC_CTYPElocaleisproperly
configured: seethePy_PreInitialize()function. |

### 第85页

canbedecodedasasurrogatecharacter,thebytesareescapedusingthesurrogateescapeerrorhandlerinstead
ofdecodingthem.
Returnapointertoanewlyallocatedwidecharacterstring,usePyMem_RawFree()tofreethememory. If
sizeisnotNULL,writethenumberofwidecharactersexcludingthenullcharacterinto*size
ReturnNULLondecodingerrorormemoryallocationerror. IfsizeisnotNULL,*sizeissetto(size_t)-1
onmemoryerrororsetto(size_t)-2ondecodingerror.
ThefilesystemencodinganderrorhandlerareselectedbyPyConfig_Read(): seefilesystem_encoding
andfilesystem_errorsmembersofPyConfig.
Decodingerrorsshouldneverhappen,unlessthereisabugintheClibrary.
UsethePy_EncodeLocale()functiontoencodethecharacterstringbacktoabytestring.
(cid:181) Seealso
ThePyUnicode_DecodeFSDefaultAndSize()andPyUnicode_DecodeLocaleAndSize()func-
tions.
Addedinversion3.5.
Changedinversion3.7: ThefunctionnowusestheUTF-8encodinginthePythonUTF-8Mode.
Changed in version 3.8: The function now uses the UTF-8 encoding on Windows if PyPreConfig.
legacy_windows_fs_encodingiszero;
char*Py_EncodeLocale(constwchar_t*text,size_t*error_pos)
Part of the Stable ABI since version 3.7. Encode a wide character string to the filesystem encoding and
error handler. If the error handler is surrogateescape error handler, surrogate characters in the range
U+DC80..U+DCFFareconvertedtobytes0x80..0xFF.
Returnapointertoanewlyallocatedbytestring,usePyMem_Free()tofreethememory. ReturnNULLon
encodingerrorormemoryallocationerror.
If error_pos is not NULL, *error_pos is set to (size_t)-1 on success, or set to the index of the invalid
characteronencodingerror.
ThefilesystemencodinganderrorhandlerareselectedbyPyConfig_Read(): seefilesystem_encoding
andfilesystem_errorsmembersofPyConfig.
UsethePy_DecodeLocale()functiontodecodethebytesstringbacktoawidecharacterstring.
(cid:193) Warning
ThisfunctionmustnotbecalledbeforePythonispreinitializedandsothattheLC_CTYPElocaleisproperly
configured: seethePy_PreInitialize()function.
(cid:181) Seealso
ThePyUnicode_EncodeFSDefault()andPyUnicode_EncodeLocale()functions.
Addedinversion3.5.
Changedinversion3.7: ThefunctionnowusestheUTF-8encodinginthePythonUTF-8Mode.
Changed in version 3.8: The function now uses the UTF-8 encoding on Windows if PyPreConfig.
legacy_windows_fs_encodingiszero.
7.1. OperatingSystemUtilities 77

| (cid:181) Seealso |
| --- |
| ThePyUnicode_DecodeFSDefaultAndSize()andPyUnicode_DecodeLocaleAndSize()func-
tions. |


| (cid:193) Warning |
| --- |
| ThisfunctionmustnotbecalledbeforePythonispreinitializedandsothattheLC_CTYPElocaleisproperly
configured: seethePy_PreInitialize()function. |


| (cid:181) Seealso |
| --- |
| ThePyUnicode_EncodeFSDefault()andPyUnicode_EncodeLocale()functions. |

### 第86页

FILE*Py_fopen(PyObject*path,constchar*mode)
Similartofopen(),butpathisaPythonobjectandanexceptionissetonerror.
pathmustbeastrobject,abytesobject,orapath-likeobject.
Onsuccess,returnthenewfilepointer. Onerror,setanexceptionandreturnNULL.
ThefilemustbeclosedbyPy_fclose()ratherthancallingdirectlyfclose().
Thefiledescriptoriscreatednon-inheritable(PEP446).
Thecallermusthaveanattachedthreadstate.
Addedinversion3.14.
intPy_fclose(FILE*file)
CloseafilethatwasopenedbyPy_fopen().
Onsuccess,return0. Onerror,returnEOFanderrnoissettoindicatetheerror. Ineithercase,anyfurther
access(includinganothercalltoPy_fclose())tothestreamresultsinundefinedbehavior.
Addedinversion3.14.
7.2 System Functions
TheseareutilityfunctionsthatmakefunctionalityfromthesysmoduleaccessibletoCcode. Theyallworkwith
thecurrentinterpreterthread’ssysmodule’sdict,whichiscontainedintheinternalthreadstatestructure.
PyObject*PySys_GetObject(constchar*name)
Returnvalue: Borrowedreference. PartoftheStableABI.Returntheobjectnamefromthesysmoduleor
NULLifitdoesnotexist,withoutsettinganexception.
intPySys_SetObject(constchar*name,PyObject*v)
PartoftheStableABI.SetnameinthesysmoduletovunlessvisNULL,inwhichcasenameisdeletedfrom
thesysmodule. Returns0onsuccess,-1onerror.
voidPySys_ResetWarnOptions()
Part of the Stable ABI. Reset sys.warnoptions to an empty list. This function may be called prior to
Py_Initialize().
Deprecatedsinceversion3.13,willberemovedinversion3.15: Clearsys.warnoptionsandwarnings.
filtersinstead.
voidPySys_WriteStdout(constchar*format,...)
PartoftheStableABI.Writetheoutputstringdescribedbyformattosys.stdout. Noexceptionsareraised,
eveniftruncationoccurs(seebelow).
format shouldlimitthetotalsizeoftheformattedoutputstringto1000bytesorless–after1000bytes,the
outputstringistruncated. Inparticular,thismeansthatnounrestricted“%s”formatsshouldoccur;theseshould
belimitedusing“%.<N>s”where<N>isadecimalnumbercalculatedsothat<N>plusthemaximumsizeof
otherformattedtextdoesnotexceed1000bytes. Alsowatchoutfor“%f”,whichcanprinthundredsofdigits
forverylargenumbers.
Ifaproblemoccurs,orsys.stdoutisunset,theformattedmessageiswrittentothereal(Clevel)stdout.
voidPySys_WriteStderr(constchar*format,...)
PartoftheStableABI.AsPySys_WriteStdout(),butwritetosys.stderrorstderrinstead.
voidPySys_FormatStdout(constchar*format,...)
Part of the Stable ABI. Function similar to PySys_WriteStdout() but format the message using
PyUnicode_FromFormatV()anddon’ttruncatethemessagetoanarbitrarylength.
Addedinversion3.2.
78 Chapter7. Utilities

### 第87页

voidPySys_FormatStderr(constchar*format,...)
PartoftheStableABI.AsPySys_FormatStdout(),butwritetosys.stderrorstderrinstead.
Addedinversion3.2.
PyObject*PySys_GetXOptions()
Returnvalue: Borrowedreference. PartoftheStableABIsinceversion3.7. Returnthecurrentdictionaryof
-Xoptions,similarlytosys._xoptions. Onerror,NULLisreturnedandanexceptionisset.
Addedinversion3.2.
intPySys_Audit(constchar*event,constchar*format,...)
Part of the Stable ABI since version 3.13. Raise an auditing event with any active hooks. Return zero for
successandnon-zerowithanexceptionsetonfailure.
TheeventstringargumentmustnotbeNULL.
If any hooks have been added, format and other arguments will be used to construct a tuple to pass. Apart
from N, the same format characters as used in Py_BuildValue() are available. If the built value is not a
tuple,itwillbeaddedintoasingle-elementtuple.
The N format option must not be used. It consumes a reference, but since there is no way to know whether
argumentstothisfunctionwillbeconsumed,usingitmaycausereferenceleaks.
Note that # format characters should always be treated as Py_ssize_t, regardless of whether
PY_SSIZE_T_CLEANwasdefined.
sys.audit()performsthesamefunctionfromPythoncode.
SeealsoPySys_AuditTuple().
Addedinversion3.8.
Changedinversion3.8.2: RequirePy_ssize_tfor#formatcharacters. Previously,anunavoidabledepre-
cationwarningwasraised.
intPySys_AuditTuple(constchar*event,PyObject*args)
PartoftheStableABIsinceversion3.13. SimilartoPySys_Audit(),butpassargumentsasaPythonobject.
argsmustbeatuple. Topassnoarguments,argscanbeNULL.
Addedinversion3.13.
intPySys_AddAuditHook(Py_AuditHookFunctionhook,void*userData)
Appendthecallablehooktothelistofactiveauditinghooks. Returnzeroonsuccessandnon-zeroonfailure.
Iftheruntimehasbeeninitialized,alsosetanerroronfailure. HooksaddedthroughthisAPIarecalledforall
interpreterscreatedbytheruntime.
The userData pointer is passed into the hook function. Since hook functions may be called from different
runtimes,thispointershouldnotreferdirectlytoPythonstate.
ThisfunctionissafetocallbeforePy_Initialize(). Whencalledafterruntimeinitialization,existingaudit
hooksarenotifiedandmaysilentlyaborttheoperationbyraisinganerrorsubclassedfromException(other
errorswillnotbesilenced).
ThehookfunctionisalwayscalledwithanattachedthreadstatebythePythoninterpreterthatraisedtheevent.
SeePEP578foradetaileddescriptionofauditing. Functionsintheruntimeandstandardlibrarythatraise
eventsarelistedintheauditeventstable. Detailsareineachfunction’sdocumentation.
Iftheinterpreterisinitialized,thisfunctionraisesanauditingeventsys.addaudithookwithnoarguments.
IfanyexistinghooksraiseanexceptionderivedfromException, thenewhookwillnotbeaddedandthe
exceptioniscleared. Asaresult,callerscannotassumethattheirhookhasbeenaddedunlesstheycontrolall
existinghooks.
7.2. SystemFunctions 79

### 第88页

typedefint(*Py_AuditHookFunction)(constchar*event,PyObject*args,void*userData)
The type of the hook function. event is the C string event argument passed to PySys_Audit() or
PySys_AuditTuple(). argsisguaranteedtobeaPyTupleObject. userDataistheargumentpassed
toPySys_AddAuditHook().
Addedinversion3.8.
7.3 Process Control
voidPy_FatalError(constchar*message)
PartoftheStableABI.Printafatalerrormessageandkilltheprocess. Nocleanupisperformed. Thisfunction
shouldonlybeinvokedwhenaconditionisdetectedthatwouldmakeitdangeroustocontinueusingthePython
interpreter; e.g., when the object administration appears to be corrupted. On Unix, the standard C library
functionabort()iscalledwhichwillattempttoproduceacorefile.
ThePy_FatalError()functionisreplacedwithamacrowhichlogsautomaticallythenameofthecurrent
function,unlessthePy_LIMITED_APImacroisdefined.
Changedinversion3.9: Logthefunctionnameautomatically.
voidPy_Exit(intstatus)
PartoftheStableABI.Exitthecurrentprocess. ThiscallsPy_FinalizeEx()andthencallsthestandardC
libraryfunctionexit(status). IfPy_FinalizeEx()indicatesanerror,theexitstatusissetto120.
Changedinversion3.6: Errorsfromfinalizationnolongerignored.
intPy_AtExit(void(*func)())
PartoftheStableABI.RegisteracleanupfunctiontobecalledbyPy_FinalizeEx(). Thecleanupfunction
willbecalledwithnoargumentsandshouldreturnnovalue. Atmost32cleanupfunctionscanberegistered.
When the registration is successful, Py_AtExit() returns 0; on failure, it returns -1. The cleanup func-
tionregisteredlastiscalledfirst. Eachcleanupfunctionwillbecalledatmostonce. SincePython’sinternal
finalizationwillhavecompletedbeforethecleanupfunction,noPythonAPIsshouldbecalledbyfunc.
(cid:181) Seealso
PyUnstable_AtExit()forpassingavoid *dataargument.
7.4 Importing Modules
PyObject*PyImport_ImportModule(constchar*name)
Returnvalue: Newreference. PartoftheStableABI.ThisisawrapperaroundPyImport_Import()which
takesaconst char*asanargumentinsteadofaPyObject*.
PyObject*PyImport_ImportModuleNoBlock(constchar*name)
Return value: New reference. Part of the Stable ABI. This function is a deprecated alias of
PyImport_ImportModule().
Changed in version 3.3: This function used to fail immediately when the import lock was held by another
thread. In Python 3.3 though, the locking scheme switched to per-module locks for most purposes, so this
function’sspecialbehaviourisn’tneededanymore.
Deprecatedsinceversion3.13,willberemovedinversion3.15: UsePyImport_ImportModule()instead.
PyObject*PyImport_ImportModuleEx(constchar*name,PyObject*globals,PyObject*locals,PyObject
*fromlist)
Return value: New reference. Import a module. This is best described by referring to the built-in Python
function__import__().
80 Chapter7. Utilities

| (cid:181) Seealso |
| --- |
| PyUnstable_AtExit()forpassingavoid *dataargument. |

### 第89页

Thereturnvalueisanewreferencetotheimportedmoduleortop-levelpackage,orNULLwithanexception
set on failure. Like for __import__(), the return value when a submodule of a package was requested is
normallythetop-levelpackage,unlessanon-emptyfromlistwasgiven.
Failingimportsremoveincompletemoduleobjects,likewithPyImport_ImportModule().
PyObject*PyImport_ImportModuleLevelObject(PyObject*name,PyObject*globals,PyObject*locals,
PyObject*fromlist,intlevel)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.7. Importamodule. Thisisbestdescribed
by referring to the built-in Python function __import__(), as the standard __import__() function calls
thisfunctiondirectly.
Thereturnvalueisanewreferencetotheimportedmoduleortop-levelpackage,orNULLwithanexception
set on failure. Like for __import__(), the return value when a submodule of a package was requested is
normallythetop-levelpackage,unlessanon-emptyfromlistwasgiven.
Addedinversion3.3.
PyObject*PyImport_ImportModuleLevel(constchar*name,PyObject*globals,PyObject*locals,PyObject
*fromlist,intlevel)
Returnvalue:Newreference. PartoftheStableABI.SimilartoPyImport_ImportModuleLevelObject(),
butthenameisaUTF-8encodedstringinsteadofaUnicodeobject.
Changedinversion3.3: Negativevaluesforlevelarenolongeraccepted.
PyObject*PyImport_Import(PyObject*name)
Return value: New reference. Part of the Stable ABI. This is a higher-level interface that calls the current
“importhookfunction”(withanexplicitlevelof0,meaningabsoluteimport). Itinvokesthe__import__()
functionfromthe__builtins__ofthecurrentglobals. Thismeansthattheimportisdoneusingwhatever
importhooksareinstalledinthecurrentenvironment.
Thisfunctionalwaysusesabsoluteimports.
PyObject*PyImport_ReloadModule(PyObject*m)
Returnvalue: Newreference. PartoftheStableABI.Reloadamodule. Returnanewreferencetothereloaded
module,orNULLwithanexceptionsetonfailure(themodulestillexistsinthiscase).
PyObject*PyImport_AddModuleRef(constchar*name)
Returnvalue:Newreference. PartoftheStableABIsinceversion3.13. Returnthemoduleobjectcorresponding
toamodulename.
Thenameargumentmaybeoftheformpackage.module. Firstcheckthemodulesdictionaryifthere’sone
there,andifnot,createanewoneandinsertitinthemodulesdictionary.
Returnastrongreferencetothemoduleonsuccess. ReturnNULLwithanexceptionsetonfailure.
ThemodulenamenameisdecodedfromUTF-8.
Thisfunctiondoesnotloadorimportthemodule;ifthemodulewasn’talreadyloaded,youwillgetanempty
moduleobject. UsePyImport_ImportModule()oroneofitsvariantstoimportamodule. Packagestruc-
turesimpliedbyadottednamefornamearenotcreatedifnotalreadypresent.
Addedinversion3.13.
PyObject*PyImport_AddModuleObject(PyObject*name)
Return value: Borrowed reference. Part of the Stable ABI since version 3.7. Similar to
PyImport_AddModuleRef(),butreturnaborrowedreferenceandnameisaPythonstrobject.
Addedinversion3.3.
PyObject*PyImport_AddModule(constchar*name)
Return value: Borrowed reference. Part of the Stable ABI. Similar to PyImport_AddModuleRef(), but
returnaborrowedreference.
7.4. ImportingModules 81

### 第90页

PyObject*PyImport_ExecCodeModule(constchar*name,PyObject*co)
Returnvalue: Newreference. PartoftheStableABI.Givenamodulename(possiblyoftheformpackage.
module)andacodeobjectreadfromaPythonbytecodefileorobtainedfromthebuilt-infunctioncompile(),
load the module. Return a new reference to the module object, or NULL with an exception set if an error
occurred. nameisremovedfromsys.modulesinerrorcases,evenifnamewasalreadyinsys.modules
on entry to PyImport_ExecCodeModule(). Leaving incompletely initialized modules in sys.modules
is dangerous, as imports of such modules have no way to know that the module object is an unknown (and
probablydamagedwithrespecttothemoduleauthor’sintents)state.
The module’s __spec__ and __loader__ will be set, if not set already, with the appropriate values. The
spec’s loader will be set to the module’s __loader__ (if set) and to an instance of SourceFileLoader
otherwise.
Themodule’s__file__attributewillbesettothecodeobject’sco_filename. Ifapplicable,__cached__
willalsobeset.
Thisfunctionwillreloadthemoduleifitwasalreadyimported. SeePyImport_ReloadModule()forthe
intendedwaytoreloadamodule.
Ifnamepointstoadottednameoftheformpackage.module,anypackagestructuresnotalreadycreated
willstillnotbecreated.
SeealsoPyImport_ExecCodeModuleEx()andPyImport_ExecCodeModuleWithPathnames().
Changedinversion3.12: Thesettingof__cached__and__loader__isdeprecated. SeeModuleSpecfor
alternatives.
PyObject*PyImport_ExecCodeModuleEx(constchar*name,PyObject*co,constchar*pathname)
Return value: New reference. Part of the Stable ABI. Like PyImport_ExecCodeModule(), but the
__file__attributeofthemoduleobjectissettopathnameifitisnon-NULL.
SeealsoPyImport_ExecCodeModuleWithPathnames().
PyObject*PyImport_ExecCodeModuleObject(PyObject*name,PyObject*co,PyObject*pathname,PyObject
*cpathname)
Return value: New reference. Part of the Stable ABI since version 3.7. Like
PyImport_ExecCodeModuleEx(), but the __cached__ attribute of the module object is set to
cpathnameifitisnon-NULL.Ofthethreefunctions,thisisthepreferredonetouse.
Addedinversion3.3.
Changedinversion3.12: Setting__cached__isdeprecated. SeeModuleSpecforalternatives.
PyObject*PyImport_ExecCodeModuleWithPathnames(constchar*name,PyObject*co,constchar
*pathname,constchar*cpathname)
Return value: New reference. Part of the Stable ABI. Like PyImport_ExecCodeModuleObject(), but
name, pathname and cpathname are UTF-8 encodedstrings. Attemptsare also madeto figureout whatthe
valueforpathnameshouldbefromcpathnameiftheformerissettoNULL.
Addedinversion3.2.
Changedinversion3.3: Usesimp.source_from_cache()incalculatingthesourcepathifonlythebyte-
codepathisprovided.
Changedinversion3.12: Nolongerusestheremovedimpmodule.
longPyImport_GetMagicNumber()
Part of the Stable ABI. Return the magic number for Python bytecode files (a.k.a. .pyc file). The magic
numbershouldbepresentinthefirstfourbytesofthebytecodefile,inlittle-endianbyteorder. Returns-1on
error.
Changedinversion3.3: Returnvalueof-1uponfailure.
82 Chapter7. Utilities

### 第91页

constchar*PyImport_GetMagicTag()
PartoftheStableABI.ReturnthemagictagstringforPEP3147formatPythonbytecodefilenames. Keep
inmindthatthevalueatsys.implementation.cache_tagisauthoritativeandshouldbeusedinsteadof
thisfunction.
Addedinversion3.2.
PyObject*PyImport_GetModuleDict()
Returnvalue: Borrowedreference. PartoftheStableABI.Returnthedictionaryusedforthemoduleadmin-
istration(a.k.a. sys.modules). Notethatthisisaper-interpretervariable.
PyObject*PyImport_GetModule(PyObject*name)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.8. Returnthealreadyimportedmodule
with the given name. If the module has not been imported yet then returns NULL but does not set an error.
ReturnsNULLandsetsanerrorifthelookupfailed.
Addedinversion3.7.
PyObject*PyImport_GetImporter(PyObject*path)
Returnvalue: Newreference. PartoftheStableABI.Returnafinderobjectforasys.path/pkg.__path__
itempath,possiblybyfetchingitfromthesys.path_importer_cachedict. Ifitwasn’tyetcached,traverse
sys.path_hooksuntilahookisfoundthatcanhandlethepathitem. ReturnNoneifnohookcould; this
tellsourcallerthatthepathbasedfinder couldnotfindafinderforthispathitem. Cachetheresultinsys.
path_importer_cache. Returnanewreferencetothefinderobject.
intPyImport_ImportFrozenModuleObject(PyObject*name)
PartoftheStableABIsinceversion3.7. Loadafrozenmodulenamedname. Return1forsuccess,0ifthe
moduleisnotfound,and-1withanexceptionsetiftheinitializationfailed. Toaccesstheimportedmodule
onasuccessfulload,usePyImport_ImportModule(). (Notethemisnomer—thisfunctionwouldreload
themoduleifitwasalreadyimported.)
Addedinversion3.3.
Changedinversion3.4: The__file__attributeisnolongersetonthemodule.
intPyImport_ImportFrozenModule(constchar*name)
PartoftheStableABI.SimilartoPyImport_ImportFrozenModuleObject(),butthenameisaUTF-8
encodedstringinsteadofaUnicodeobject.
struct_frozen
This is the structure type definition for frozen module descriptors, as generated by the freeze utility (see
Tools/freeze/inthePythonsourcedistribution). Itsdefinition,foundinInclude/import.h,is:
struct _frozen {
const char *name;
const unsigned char *code;
int size;
bool is_package;
};
Changedinversion3.11: Thenewis_packagefieldindicateswhetherthemoduleisapackageornot. This
replacessettingthesizefieldtoanegativevalue.
conststruct_frozen*PyImport_FrozenModules
Thispointerisinitializedtopointtoanarrayof_frozenrecords,terminatedbyonewhosemembersareall
NULL or zero. When a frozen module is imported, it is searched in this table. Third-party code could play
trickswiththistoprovideadynamicallycreatedcollectionoffrozenmodules.
intPyImport_AppendInittab(constchar*name,PyObject*(*initfunc)(void))
PartoftheStableABI.Addasinglemoduletotheexistingtableofbuilt-inmodules. Thisisaconvenience
wrapperaroundPyImport_ExtendInittab(),returning-1ifthetablecouldnotbeextended. Thenew
modulecanbeimportedbythenamename,andusesthefunctioninitfuncastheinitializationfunctioncalled
onthefirstattemptedimport. ThisshouldbecalledbeforePy_Initialize().
7.4. ImportingModules 83

### 第92页

struct_inittab
Structuredescribingasingleentryinthelistofbuilt-inmodules. ProgramswhichembedPythonmayusean
array of these structures in conjunction with PyImport_ExtendInittab() to provide additional built-in
modules. Thestructureconsistsoftwomembers:
constchar*name
Themodulename,asanASCIIencodedstring.
PyObject*(*initfunc)(void)
Initializationfunctionforamodulebuiltintotheinterpreter.
intPyImport_ExtendInittab(struct_inittab*newtab)
Addacollectionofmodulestothetableofbuilt-inmodules. Thenewtabarraymustendwithasentinelentry
which contains NULL for the name field; failure to provide the sentinel value can result in a memory fault.
Returns0onsuccessor-1ifinsufficientmemorycouldbeallocatedtoextendtheinternaltable. Intheevent
offailure,nomodulesareaddedtotheinternaltable. ThismustbecalledbeforePy_Initialize().
IfPythonisinitializedmultipletimes, PyImport_AppendInittab() or PyImport_ExtendInittab()
mustbecalledbeforeeachPythoninitialization.
PyObject*PyImport_ImportModuleAttr(PyObject*mod_name,PyObject*attr_name)
Returnvalue: Newreference. Importthemodulemod_nameandgetitsattributeattr_name.
NamesmustbePythonstrobjects.
Helper function combining PyImport_Import() and PyObject_GetAttr(). For example, it can raise
ImportErrorifthemoduleisnotfound,andAttributeErroriftheattributedoesn’texist.
Addedinversion3.14.
PyObject*PyImport_ImportModuleAttrString(constchar*mod_name,constchar*attr_name)
Returnvalue: Newreference. SimilartoPyImport_ImportModuleAttr(),butnamesareUTF-8encoded
stringsinsteadofPythonstrobjects.
Addedinversion3.14.
7.5 Data marshalling support
These routines allow C code to work with serialized objects using the same data format as the marshal module.
Therearefunctionstowritedataintotheserializationformat,andadditionalfunctionsthatcanbeusedtoreadthe
databack. Filesusedtostoremarshalleddatamustbeopenedinbinarymode.
Numericvaluesarestoredwiththeleastsignificantbytefirst.
Themodulesupportsseveralversionsofthedataformat;seethePython module documentationfordetails.
Py_MARSHAL_VERSION
Thecurrentformatversion. Seemarshal.version.
voidPyMarshal_WriteLongToFile(longvalue,FILE*file,intversion)
Marshalalonginteger,value,tofile. Thiswillonlywritetheleast-significant32bitsofvalue;regardlessof
thesizeofthenativelongtype. versionindicatesthefileformat.
Thisfunctioncanfail,inwhichcaseitsetstheerrorindicator. UsePyErr_Occurred()tocheckforthat.
voidPyMarshal_WriteObjectToFile(PyObject*value,FILE*file,intversion)
MarshalaPythonobject,value,tofile. versionindicatesthefileformat.
Thisfunctioncanfail,inwhichcaseitsetstheerrorindicator. UsePyErr_Occurred()tocheckforthat.
PyObject*PyMarshal_WriteObjectToString(PyObject*value,intversion)
Returnvalue: Newreference. Returnabytesobjectcontainingthemarshalledrepresentationofvalue. version
indicatesthefileformat.
Thefollowingfunctionsallowmarshalledvaluestobereadbackin.
84 Chapter7. Utilities

### 第93页

longPyMarshal_ReadLongFromFile(FILE*file)
ReturnaClongfromthedatastreaminaFILE*openedforreading. Onlya32-bitvaluecanbereadinusing
thisfunction,regardlessofthenativesizeoflong.
Onerror,setstheappropriateexception(EOFError)andreturns-1.
intPyMarshal_ReadShortFromFile(FILE*file)
ReturnaCshortfromthedatastreaminaFILE*openedforreading. Onlya16-bitvaluecanbereadin
usingthisfunction,regardlessofthenativesizeofshort.
Onerror,setstheappropriateexception(EOFError)andreturns-1.
PyObject*PyMarshal_ReadObjectFromFile(FILE*file)
Returnvalue: Newreference. ReturnaPythonobjectfromthedatastreaminaFILE*openedforreading.
Onerror,setstheappropriateexception(EOFError,ValueErrororTypeError)andreturnsNULL.
PyObject*PyMarshal_ReadLastObjectFromFile(FILE*file)
Return value: New reference. Return a Python object from the data stream in a FILE* opened for reading.
Unlike PyMarshal_ReadObjectFromFile(), this function assumes that no further objects will be read
fromthefile,allowingittoaggressivelyloadfiledataintomemorysothatthede-serializationcanoperatefrom
datainmemoryratherthanreadingabyteatatimefromthefile. Onlyusethesevariantifyouarecertainthat
youwon’tbereadinganythingelsefromthefile.
Onerror,setstheappropriateexception(EOFError,ValueErrororTypeError)andreturnsNULL.
PyObject*PyMarshal_ReadObjectFromString(constchar*data,Py_ssize_tlen)
Returnvalue: Newreference. ReturnaPythonobjectfromthedatastreaminabytebuffercontaininglenbytes
pointedtobydata.
Onerror,setstheappropriateexception(EOFError,ValueErrororTypeError)andreturnsNULL.
7.6 Parsing arguments and building values
These functions are useful when creating your own extension functions and methods. Additional information and
examplesareavailableinextending-index.
Thefirstthreeofthesefunctionsdescribed,PyArg_ParseTuple(),PyArg_ParseTupleAndKeywords(),and
PyArg_Parse(),alluseformatstringswhichareusedtotellthefunctionabouttheexpectedarguments. Theformat
stringsusethesamesyntaxforeachofthesefunctions.
7.6.1 Parsing arguments
A format string consists of zero or more “format units.” A format unit describes one Python object; it is usually
a single character or a parenthesized sequence of format units. With a few exceptions, a format unit that is not
a parenthesized sequence normally corresponds to a single address argument to these functions. In the following
description,thequotedformistheformatunit;theentryin(round)parenthesesisthePythonobjecttypethatmatches
theformatunit;andtheentryin[square]bracketsisthetypeoftheCvariable(s)whoseaddressshouldbepassed.
Stringsandbuffers
(cid:174) Note
OnPython3.12andolder,themacroPY_SSIZE_T_CLEANmustbedefinedbeforeincludingPython.htouse
all#variantsofformats(s#,y#,etc.) explainedbelow. ThisisnotnecessaryonPython3.13andlater.
Theseformatsallowaccessinganobjectasacontiguouschunkofmemory. Youdon’thavetoproviderawstorage
forthereturnedunicodeorbytesarea.
Unlessotherwisestated,buffersarenotNUL-terminated.
7.6. Parsingargumentsandbuildingvalues 85

### 第94页

TherearethreewaysstringsandbufferscanbeconvertedtoC:
• Formats such as y* and s* fill a Py_buffer structure. This locks the underlying buffer so that the caller
cansubsequentlyusethebuffereveninsideaPy_BEGIN_ALLOW_THREADSblockwithouttheriskofmutable
databeingresizedordestroyed. Asaresult,youhavetocallPyBuffer_Release()afteryouhavefinished
processingthedata(orinanyearlyabortcase).
• Thees,es#,etandet#formatsallocatetheresultbuffer. YouhavetocallPyMem_Free()afteryouhave
finishedprocessingthedata(orinanyearlyabortcase).
• Otherformatstakeastroraread-onlybytes-likeobject,suchasbytes,andprovideaconst char *pointer
toitsbuffer. Inthiscasethebufferis“borrowed”: itismanagedbythecorrespondingPythonobject,andshares
thelifetimeofthisobject. Youwon’thavetoreleaseanymemoryyourself.
To ensure that the underlying buffer may be safely borrowed, the object’s PyBufferProcs.
bf_releasebufferfieldmustbeNULL.Thisdisallowscommonmutableobjectssuchasbytearray,but
alsosomeread-onlyobjectssuchasmemoryviewofbytes.
Besides this bf_releasebuffer requirement, there is no check to verify whether the input object is im-
mutable(e.g. whetheritwouldhonorarequestforawritablebuffer,orwhetheranotherthreadcanmutatethe
data).
s(str)[constchar*]
ConvertaUnicodeobjecttoaCpointertoacharacterstring. Apointertoanexistingstringisstoredinthe
characterpointervariablewhoseaddressyoupass. TheCstringisNUL-terminated. ThePythonstringmust
not contain embedded null code points; if it does, a ValueError exception is raised. Unicode objects are
convertedtoCstringsusing'utf-8'encoding. Ifthisconversionfails,aUnicodeErrorisraised.
(cid:174) Note
Thisformatdoesnotacceptbytes-likeobjects. Ifyouwanttoacceptfilesystempathsandconvertthemto
Ccharacterstrings,itispreferabletousetheO&formatwithPyUnicode_FSConverter()asconverter.
Changedinversion3.5:Previously,TypeErrorwasraisedwhenembeddednullcodepointswereencountered
inthePythonstring.
s*(strorbytes-likeobject)[Py_buffer]
ThisformatacceptsUnicodeobjectsaswellasbytes-likeobjects. ItfillsaPy_bufferstructureprovidedby
thecaller. InthiscasetheresultingCstringmaycontainembeddedNULbytes. Unicodeobjectsareconverted
toCstringsusing'utf-8'encoding.
s#(str,read-onlybytes-likeobject)[constchar*,Py_ssize_t]
Like s*, except that it provides a borrowed buffer. The result is stored into two C variables, the first one a
pointertoaCstring,thesecondoneitslength. Thestringmaycontainembeddednullbytes. Unicodeobjects
areconvertedtoCstringsusing'utf-8'encoding.
z(strorNone)[constchar*]
Likes,butthePythonobjectmayalsobeNone,inwhichcasetheCpointerissettoNULL.
z*(str,bytes-likeobjectorNone)[Py_buffer]
Likes*,butthePythonobjectmayalsobeNone,inwhichcasethebufmemberofthePy_bufferstructure
issettoNULL.
z#(str,read-onlybytes-likeobjectorNone)[constchar*,Py_ssize_t]
Likes#,butthePythonobjectmayalsobeNone,inwhichcasetheCpointerissettoNULL.
y(read-onlybytes-likeobject)[constchar*]
Thisformatconvertsabytes-likeobjecttoaCpointertoaborrowedcharacterstring;itdoesnotacceptUnicode
objects. Thebytesbuffermustnotcontainembeddednullbytes;ifitdoes,aValueErrorexceptionisraised.
Changedinversion3.5: Previously,TypeErrorwasraisedwhenembeddednullbyteswereencounteredin
thebytesbuffer.
86 Chapter7. Utilities

### 第95页

y*(bytes-likeobject)[Py_buffer]
Thisvariantons*doesn’tacceptUnicodeobjects,onlybytes-likeobjects. Thisistherecommendedwayto
acceptbinarydata.
y#(read-onlybytes-likeobject)[constchar*,Py_ssize_t]
Thisvariantons#doesn’tacceptUnicodeobjects,onlybytes-likeobjects.
S(bytes)[PyBytesObject*]
RequiresthatthePythonobjectisabytesobject,withoutattemptinganyconversion. RaisesTypeErrorif
theobjectisnotabytesobject. TheCvariablemayalsobedeclaredasPyObject*.
Y(bytearray)[PyByteArrayObject*]
Requires that the Python object is a bytearray object, without attempting any conversion. Raises
TypeErroriftheobjectisnotabytearrayobject. TheCvariablemayalsobedeclaredasPyObject*.
U(str)[PyObject*]
RequiresthatthePythonobjectisaUnicodeobject,withoutattemptinganyconversion. RaisesTypeError
iftheobjectisnotaUnicodeobject. TheCvariablemayalsobedeclaredasPyObject*.
w*(read-writebytes-likeobject)[Py_buffer]
This format accepts any object which implements the read-write buffer interface. It fills a Py_buffer
structure provided by the caller. The buffer may contain embedded null bytes. The caller have to call
PyBuffer_Release()whenitisdonewiththebuffer.
es(str)[constchar*encoding,char**buffer]
ThisvariantonsisusedforencodingUnicodeintoacharacterbuffer. Itonlyworksforencodeddatawithout
embeddedNULbytes.
Thisformatrequirestwoarguments. Thefirstisonlyusedasinput,andmustbeaconst char*whichpoints
tothenameofanencodingasaNUL-terminatedstring,orNULL,inwhichcase'utf-8'encodingisused.
AnexceptionisraisedifthenamedencodingisnotknowntoPython. Thesecondargumentmustbeachar**;
thevalueofthepointeritreferenceswillbesettoabufferwiththecontentsoftheargumenttext. Thetext
willbeencodedintheencodingspecifiedbythefirstargument.
PyArg_ParseTuple()willallocateabufferoftheneededsize,copytheencodeddataintothisbufferand
adjust*buffertoreferencethenewlyallocatedstorage. ThecallerisresponsibleforcallingPyMem_Free()to
freetheallocatedbufferafteruse.
et(str,bytesorbytearray)[constchar*encoding,char**buffer]
Sameasesexceptthatbytestringobjectsarepassedthroughwithoutrecodingthem. Instead,theimplemen-
tationassumesthatthebytestringobjectusestheencodingpassedinasparameter.
es#(str)[constchar*encoding,char**buffer,Py_ssize_t*buffer_length]
This variant on s# is used for encoding Unicode into a character buffer. Unlike the es format, this variant
allowsinputdatawhichcontainsNULcharacters.
Itrequiresthreearguments. Thefirstisonlyusedasinput,andmustbeaconst char*whichpointstothe
name of an encoding as a NUL-terminated string, or NULL, in which case 'utf-8' encoding is used. An
exceptionisraisedifthenamedencodingisnotknowntoPython. Thesecondargumentmustbeachar**;
thevalueofthepointeritreferenceswillbesettoabufferwiththecontentsoftheargumenttext. Thetext
willbeencodedintheencodingspecifiedbythefirstargument. Thethirdargumentmustbeapointertoan
integer;thereferencedintegerwillbesettothenumberofbytesintheoutputbuffer.
Therearetwomodesofoperation:
If*bufferpointsaNULLpointer,thefunctionwillallocateabufferoftheneededsize,copytheencodeddata
into this buffer and set *buffer to reference the newly allocated storage. The caller is responsible for calling
PyMem_Free()tofreetheallocatedbufferafterusage.
If *buffer points to a non-NULL pointer (an already allocated buffer), PyArg_ParseTuple() will use this
locationasthebufferandinterprettheinitialvalueof*buffer_lengthasthebuffersize. Itwillthencopythe
encodeddataintothebufferandNUL-terminateit. Ifthebufferisnotlargeenough,aValueErrorwillbe
set.
Inbothcases,*buffer_lengthissettothelengthoftheencodeddatawithoutthetrailingNULbyte.
7.6. Parsingargumentsandbuildingvalues 87

### 第96页

et#(str,bytesorbytearray)[constchar*encoding,char**buffer,Py_ssize_t*buffer_length]
Same as es# except that byte string objects are passed through without recoding them. Instead, the imple-
mentationassumesthatthebytestringobjectusestheencodingpassedinasparameter.
Changedinversion3.12: u,u#,Z,andZ#areremovedbecausetheyusedalegacyPy_UNICODE*representation.
Numbers
These formats allow representing Python numbers or single characters as C numbers. Formats that require
int, float or complex can also use the corresponding special methods __index__(), __float__() or
__complex__()toconvertthePythonobjecttotherequiredtype.
Forsignedintegerformats,OverflowErrorisraisedifthevalueisoutofrangefortheCtype. Forunsignedinteger
formats,norangecheckingisdone—themostsignificantbitsaresilentlytruncatedwhenthereceivingfieldistoo
smalltoreceivethevalue.
b(int)[unsignedchar]
ConvertanonnegativePythonintegertoanunsignedtinyinteger,storedinaCunsigned char.
B(int)[unsignedchar]
ConvertaPythonintegertoatinyintegerwithoutoverflowchecking,storedinaCunsigned char.
h(int)[shortint]
ConvertaPythonintegertoaCshort int.
H(int)[unsignedshortint]
ConvertaPythonintegertoaCunsigned short int,withoutoverflowchecking.
i(int)[int]
ConvertaPythonintegertoaplainCint.
I(int)[unsignedint]
ConvertaPythonintegertoaCunsigned int,withoutoverflowchecking.
l(int)[longint]
ConvertaPythonintegertoaClong int.
k(int)[unsignedlong]
ConvertaPythonintegertoaCunsigned longwithoutoverflowchecking.
Changedinversion3.14: Use__index__()ifavailable.
L(int)[longlong]
ConvertaPythonintegertoaClong long.
K(int)[unsignedlonglong]
ConvertaPythonintegertoaCunsigned long longwithoutoverflowchecking.
Changedinversion3.14: Use__index__()ifavailable.
n(int)[Py_ssize_t]
ConvertaPythonintegertoaCPy_ssize_t.
c(bytesorbytearrayoflength1)[char]
ConvertaPythonbyte,representedasabytesorbytearrayobjectoflength1,toaCchar.
Changedinversion3.3: Allowbytearrayobjects.
C(stroflength1)[int]
ConvertaPythoncharacter,representedasastrobjectoflength1,toaCint.
f(float)[float]
ConvertaPythonfloating-pointnumbertoaCfloat.
d(float)[double]
ConvertaPythonfloating-pointnumbertoaCdouble.
D(complex)[Py_complex]
ConvertaPythoncomplexnumbertoaCPy_complexstructure.
88 Chapter7. Utilities

### 第97页

Otherobjects
O(object)[PyObject*]
StoreaPythonobject(withoutanyconversion)inaCobjectpointer. TheCprogramthusreceivestheactual
object that was passed. A new strong reference to the object is not created (i.e. its reference count is not
increased). ThepointerstoredisnotNULL.
O!(object)[typeobject,PyObject*]
StoreaPythonobjectinaCobjectpointer. ThisissimilartoO,buttakestwoCarguments: thefirstisthe
addressofaPythontypeobject,thesecondistheaddressoftheCvariable(oftypePyObject*)intowhich
theobjectpointerisstored. IfthePythonobjectdoesnothavetherequiredtype,TypeErrorisraised.
O&(object)[converter,address]
ConvertaPythonobjecttoaCvariablethroughaconverter function. Thistakestwoarguments: thefirstis
afunction, thesecondistheaddressofaCvariable(ofarbitrarytype), convertedtovoid*. Theconverter
functioninturniscalledasfollows:
status = converter(object, address);
whereobject isthePythonobjecttobeconvertedandaddressisthevoid*argumentthatwaspassedtothe
PyArg_Parse*function. Thereturnedstatusshouldbe1forasuccessfulconversionand0iftheconversion
hasfailed. Whentheconversionfails,theconverterfunctionshouldraiseanexceptionandleavethecontentof
addressunmodified. Iftheconverter returnsPy_CLEANUP_SUPPORTED,itmaygetcalledasecondtimeif
theargumentparsingeventuallyfails,givingtheconverterachancetoreleaseanymemorythatithadalready
allocated. Inthissecondcall, theobject parameterwillbeNULL;address willhavethesamevalueasinthe
originalcall.
Examplesofconverters: PyUnicode_FSConverter()andPyUnicode_FSDecoder().
Changedinversion3.1: Py_CLEANUP_SUPPORTEDwasadded.
p(bool)[int]
Teststhevaluepassedinfortruth(abooleanpredicate)andconvertstheresulttoitsequivalentCtrue/false
integervalue. Setstheintto1iftheexpressionwastrueand0ifitwasfalse. ThisacceptsanyvalidPython
value. SeetruthformoreinformationabouthowPythontestsvaluesfortruth.
Addedinversion3.3.
(items)(sequence)[matching-items]
TheobjectmustbeaPythonsequence(exceptstr, bytesorbytearray)whoselengthisthenumberof
formatunitsinitems. TheCargumentsmustcorrespondtotheindividualformatunitsinitems. Formatunits
forsequencesmaybenested.
Ifitemscontainsformatunitswhichstoreaborrowedbuffer (s,s#,z,z#,y,ory#)oraborrowedreference
(S,Y,U,O,orO!),theobjectmustbeaPythontuple. TheconverterfortheO&formatunitinitemsmustnot
storeaborrowedbufferoraborrowedreference.
Changedinversion3.14: strandbytearrayobjectsnolongeracceptedasasequence.
Deprecatedsinceversion3.14: Non-tuplesequencesaredeprecatedifitemscontainsformatunitswhichstore
aborrowedbufferoraborrowedreference.
Afewothercharactershaveameaninginaformatstring. Thesemaynotoccurinsidenestedparentheses. Theyare:
|
IndicatesthattheremainingargumentsinthePythonargumentlistareoptional. TheCvariablescorresponding
tooptionalargumentsshouldbeinitializedtotheirdefaultvalue—whenanoptionalargumentisnotspecified,
PyArg_ParseTuple()doesnottouchthecontentsofthecorrespondingCvariable(s).
$
PyArg_ParseTupleAndKeywords()only: IndicatesthattheremainingargumentsinthePythonargument
list are keyword-only. Currently, all keyword-only arguments must also be optional arguments, so | must
alwaysbespecifiedbefore$intheformatstring.
Addedinversion3.3.
7.6. Parsingargumentsandbuildingvalues 89

### 第98页

:
Thelistofformatunitsendshere;thestringafterthecolonisusedasthefunctionnameinerrormessages(the
“associatedvalue”oftheexceptionthatPyArg_ParseTuple()raises).
;
Thelistofformatunitsendshere; thestringafterthesemicolonisusedastheerrormessageinstead ofthe
defaulterrormessage. : and;mutuallyexcludeeachother.
NotethatanyPythonobjectreferenceswhichareprovidedtothecallerareborrowedreferences;donotreleasethem
(i.e. donotdecrementtheirreferencecount)!
Additionalargumentspassedtothesefunctionsmustbeaddressesofvariableswhosetypeisdeterminedbytheformat
string;theseareusedtostorevaluesfromtheinputtuple. Thereareafewcases,asdescribedinthelistofformatunits
above,wheretheseparametersareusedasinputvalues; theyshouldmatchwhatisspecifiedforthecorresponding
formatunitinthatcase.
Fortheconversiontosucceed,theargobjectmustmatchtheformatandtheformatmustbeexhausted. Onsuccess,
thePyArg_Parse*functionsreturntrue,otherwisetheyreturnfalseandraiseanappropriateexception. Whenthe
PyArg_Parse* functions fail due to conversion failure in one of the format units, the variables at the addresses
correspondingtothatandthefollowingformatunitsareleftuntouched.
APIFunctions
intPyArg_ParseTuple(PyObject*args,constchar*format,...)
Part of the Stable ABI. Parse the parameters of a function that takes only positional parameters into local
variables. Returnstrueonsuccess;onfailure,itreturnsfalseandraisestheappropriateexception.
intPyArg_VaParse(PyObject*args,constchar*format,va_listvargs)
Part of the Stable ABI. Identical to PyArg_ParseTuple(), except that it accepts a va_list rather than a
variablenumberofarguments.
intPyArg_ParseTupleAndKeywords(PyObject*args,PyObject*kw,constchar*format,char*const
*keywords,...)
PartoftheStableABI.Parsetheparametersofafunctionthattakesbothpositionalandkeywordparameters
intolocalvariables. ThekeywordsargumentisaNULL-terminatedarrayofkeywordparameternamesspeci-
fiedasnull-terminatedASCIIorUTF-8encodedCstrings. Emptynamesdenotepositional-onlyparameters.
Returnstrueonsuccess;onfailure,itreturnsfalseandraisestheappropriateexception.
(cid:174) Note
Thekeywordsparameterdeclarationischar *const*inCandconst char *const*inC++. This
canbeoverriddenwiththePY_CXX_CONSTmacro.
Changedinversion3.6: Addedsupportforpositional-onlyparameters.
Changed in version 3.13: The keywords parameter has now type char *const* in C and const char
*const*inC++,insteadofchar**. Addedsupportfornon-ASCIIkeywordparameternames.
intPyArg_VaParseTupleAndKeywords(PyObject*args,PyObject*kw,constchar*format,char*const
*keywords,va_listvargs)
Part of the Stable ABI. Identical to PyArg_ParseTupleAndKeywords(), except that it accepts a va_list
ratherthanavariablenumberofarguments.
intPyArg_ValidateKeywordArguments(PyObject*)
Part of the Stable ABI. Ensure that the keys in the keywords argument dictionary are strings. This is only
neededifPyArg_ParseTupleAndKeywords()isnotused,sincethelatteralreadydoesthischeck.
Addedinversion3.2.
90 Chapter7. Utilities

### 第99页

intPyArg_Parse(PyObject*args,constchar*format,...)
PartoftheStableABI.Parsetheparameterofafunctionthattakesasinglepositionalparameterintoalocal
variable. Returnstrueonsuccess;onfailure,itreturnsfalseandraisestheappropriateexception.
Example:
// Function using METH_O calling convention
static PyObject*
my_function(PyObject *module, PyObject *arg)
{
int value;
if (!PyArg_Parse(arg, "i:my_function", &value)) {
return NULL;
}
// ... use value ...
}
intPyArg_UnpackTuple(PyObject*args,constchar*name,Py_ssize_tmin,Py_ssize_tmax,...)
PartoftheStableABI.Asimplerformofparameterretrievalwhichdoesnotuseaformatstringtospecifythe
typesofthearguments. Functionswhichusethismethodtoretrievetheirparametersshouldbedeclaredas
METH_VARARGSinfunctionormethodtables. Thetuplecontainingtheactualparametersshouldbepassedas
args;itmustactuallybeatuple. Thelengthofthetuplemustbeatleastminandnomorethanmax;minand
maxmaybeequal. Additionalargumentsmustbepassedtothefunction,eachofwhichshouldbeapointerto
aPyObject*variable;thesewillbefilledinwiththevaluesfromargs;theywillcontainborrowedreferences.
Thevariableswhichcorrespondtooptionalparametersnotgivenbyargswillnotbefilledin;theseshouldbe
initializedbythecaller. Thisfunctionreturnstrueonsuccessandfalseifargs isnotatupleorcontainsthe
wrongnumberofelements;anexceptionwillbesetiftherewasafailure.
Thisisanexampleoftheuseofthisfunction, takenfromthesourcesforthe_weakrefhelpermodulefor
weakreferences:
static PyObject *
weakref_ref(PyObject *self, PyObject *args)
{
PyObject *object;
PyObject *callback = NULL;
PyObject *result = NULL;
if (PyArg_UnpackTuple(args, "ref", 1, 2, &object, &callback)) {
result = PyWeakref_NewRef(object, callback);
}
return result;
}
The call to PyArg_UnpackTuple() in this example is entirely equivalent to this call to
PyArg_ParseTuple():
PyArg_ParseTuple(args, "O|O:ref", &object, &callback)
PY_CXX_CONST
The value to be inserted, if any, before char *const* in the keywords parameter declaration of
PyArg_ParseTupleAndKeywords()andPyArg_VaParseTupleAndKeywords(). DefaultemptyforC
and const for C++ (const char *const*). To override, define it to the desired value before including
Python.h.
Addedinversion3.13.
7.6. Parsingargumentsandbuildingvalues 91

### 第100页

7.6.2 Building values
PyObject*Py_BuildValue(constchar*format,...)
Returnvalue: Newreference. PartoftheStableABI.Createanewvaluebasedonaformatstringsimilarto
those accepted by the PyArg_Parse* family of functions and a sequence of values. Returns the value or
NULLinthecaseofanerror;anexceptionwillberaisedifNULLisreturned.
Py_BuildValue()doesnotalwaysbuildatuple. Itbuildsatupleonlyifitsformatstringcontainstwoor
moreformatunits. Iftheformatstringisempty,itreturnsNone;ifitcontainsexactlyoneformatunit,itreturns
whateverobjectisdescribedbythatformatunit. Toforceittoreturnatupleofsize0orone,parenthesizethe
formatstring.
Whenmemorybuffersarepassedasparameterstosupplydatatobuildobjects,asforthesands#formats,
the required data is copied. Buffers provided by the caller are never referenced by the objects created by
Py_BuildValue(). In other words, if your code invokes malloc() and passes the allocated memory to
Py_BuildValue(),yourcodeisresponsibleforcallingfree()forthatmemoryoncePy_BuildValue()
returns.
Inthefollowingdescription,thequotedformistheformatunit;theentryin(round)parenthesesisthePython
objecttypethattheformatunitwillreturn;andtheentryin[square]bracketsisthetypeoftheCvalue(s)to
bepassed.
Thecharactersspace,tab,colonandcommaareignoredinformatstrings(butnotwithinformatunitssuchas
s#). Thiscanbeusedtomakelongformatstringsatadmorereadable.
s(strorNone)[constchar*]
Convert a null-terminated C string to a Python str object using 'utf-8' encoding. If the C string
pointerisNULL,Noneisused.
s#(strorNone)[constchar*,Py_ssize_t]
ConvertaCstringanditslengthtoaPythonstrobjectusing'utf-8'encoding. IftheCstringpointer
isNULL,thelengthisignoredandNoneisreturned.
y(bytes)[constchar*]
ThisconvertsaCstringtoaPythonbytesobject. IftheCstringpointerisNULL,Noneisreturned.
y#(bytes)[constchar*,Py_ssize_t]
This converts a C string and its lengths to a Python object. If the C string pointer is NULL, None is
returned.
z(strorNone)[constchar*]
Sameass.
z#(strorNone)[constchar*,Py_ssize_t]
Sameass#.
u(str)[constwchar_t*]
Convert a null-terminated wchar_t buffer of Unicode (UTF-16 or UCS-4) data to a Python Unicode
object. IftheUnicodebufferpointerisNULL,Noneisreturned.
u#(str)[constwchar_t*,Py_ssize_t]
Convert a Unicode (UTF-16 or UCS-4) data buffer and its length to a Python Unicode object. If the
UnicodebufferpointerisNULL,thelengthisignoredandNoneisreturned.
U(strorNone)[constchar*]
Sameass.
U#(strorNone)[constchar*,Py_ssize_t]
Sameass#.
i(int)[int]
ConvertaplainCinttoaPythonintegerobject.
b(int)[char]
ConvertaplainCchartoaPythonintegerobject.
92 Chapter7. Utilities

### 第101页

h(int)[shortint]
ConvertaplainCshort inttoaPythonintegerobject.
l(int)[longint]
ConvertaClong inttoaPythonintegerobject.
B(int)[unsignedchar]
ConvertaCunsigned chartoaPythonintegerobject.
H(int)[unsignedshortint]
ConvertaCunsigned short inttoaPythonintegerobject.
I(int)[unsignedint]
ConvertaCunsigned inttoaPythonintegerobject.
k(int)[unsignedlong]
ConvertaCunsigned longtoaPythonintegerobject.
L(int)[longlong]
ConvertaClong longtoaPythonintegerobject.
K(int)[unsignedlonglong]
ConvertaCunsigned long longtoaPythonintegerobject.
n(int)[Py_ssize_t]
ConvertaCPy_ssize_ttoaPythoninteger.
p(bool)[int]
ConvertaCinttoaPythonboolobject.
Beawarethatthisformatrequiresanintargument. UnlikemostothercontextsinC,variadicarguments
arenotcoercedtoasuitabletypeautomatically. Youcanconvertanothertype(forexample,apointeror
afloat)toasuitableintvalueusing(x) ? 1 : 0or!!x.
Addedinversion3.14.
c(bytesoflength1)[char]
ConvertaCintrepresentingabytetoaPythonbytesobjectoflength1.
C(stroflength1)[int]
ConvertaCintrepresentingacharactertoPythonstrobjectoflength1.
d(float)[double]
ConvertaCdoubletoaPythonfloating-pointnumber.
f(float)[float]
ConvertaCfloattoaPythonfloating-pointnumber.
D(complex)[Py_complex*]
ConvertaCPy_complexstructuretoaPythoncomplexnumber.
O(object)[PyObject*]
PassaPythonobjectuntouchedbutcreateanewstrongreferencetoit(i.e. itsreferencecountisincre-
mentedbyone). IftheobjectpassedinisaNULLpointer,itisassumedthatthiswascausedbecausethe
callproducingtheargumentfoundan errorandsetan exception. Therefore, Py_BuildValue() will
returnNULLbutwon’traiseanexception. Ifnoexceptionhasbeenraisedyet,SystemErrorisset.
S(object)[PyObject*]
SameasO.
N(object)[PyObject*]
SameasO,exceptitdoesn’tcreateanewstrongreference. Usefulwhentheobjectiscreatedbyacallto
anobjectconstructorintheargumentlist.
O&(object)[converter,anything]
ConvertanythingtoaPythonobjectthroughaconverter function. Thefunctioniscalledwithanything
(whichshouldbecompatiblewithvoid*)asitsargumentandshouldreturna“new”Pythonobject,or
NULLifanerroroccurred.
7.6. Parsingargumentsandbuildingvalues 93

### 第102页

(items)(tuple)[matching-items]
ConvertasequenceofCvaluestoaPythontuplewiththesamenumberofitems.
[items](list)[matching-items]
ConvertasequenceofCvaluestoaPythonlistwiththesamenumberofitems.
{items}(dict)[matching-items]
ConvertasequenceofCvaluestoaPythondictionary. EachpairofconsecutiveCvaluesaddsoneitem
tothedictionary,servingaskeyandvalue,respectively.
Ifthereisanerrorintheformatstring,theSystemErrorexceptionissetandNULLreturned.
PyObject*Py_VaBuildValue(constchar*format,va_listvargs)
Returnvalue: Newreference. PartoftheStableABI.IdenticaltoPy_BuildValue(),exceptthatitacceptsa
va_listratherthanavariablenumberofarguments.
7.7 String conversion and formatting
Functionsfornumberconversionandformattedstringoutput.
intPyOS_snprintf(char*str,size_tsize,constchar*format,...)
PartoftheStableABI.Outputnotmorethansizebytestostr accordingtotheformatstringformat andthe
extraarguments. SeetheUnixmanpagesnprintf(3).
intPyOS_vsnprintf(char*str,size_tsize,constchar*format,va_listva)
PartoftheStableABI.Outputnotmorethansizebytestostr accordingtotheformatstringformat andthe
variableargumentlistva. Unixmanpagevsnprintf(3).
PyOS_snprintf() and PyOS_vsnprintf() wrap the Standard C library functions snprintf() and
vsnprintf(). Theirpurposeistoguaranteeconsistentbehaviorincornercases,whichtheStandardCfunctions
donot.
Thewrappersensurethatstr[size-1]isalways'\0'uponreturn. Theyneverwritemorethansizebytes(including
thetrailing'\0')intostr. Bothfunctionsrequirethatstr != NULL,size > 0,format != NULLandsize <
INT_MAX.NotethatthismeansthereisnoequivalenttotheC99n = snprintf(NULL, 0, ...)whichwould
determinethenecessarybuffersize.
Thereturnvalue(rv)forthesefunctionsshouldbeinterpretedasfollows:
• When0 <= rv < size,theoutputconversionwassuccessfulandrvcharacterswerewrittentostr(excluding
thetrailing'\0'byteatstr[rv]).
• Whenrv >= size, theoutputconversionwastruncatedandabufferwithrv + 1byteswouldhavebeen
neededtosucceed. str[size-1]is'\0'inthiscase.
• When rv < 0, “something bad happened.” str[size-1] is '\0' in this case too, but the rest of str is
undefined. Theexactcauseoftheerrordependsontheunderlyingplatform.
Thefollowingfunctionsprovidelocale-independentstringtonumberconversions.
unsignedlongPyOS_strtoul(constchar*str,char**ptr,intbase)
PartoftheStableABI.Converttheinitialpartofthestringinstrtoanunsigned longvalueaccordingto
thegivenbase,whichmustbebetween2and36inclusive,orbethespecialvalue0.
Leadingwhitespaceandcaseofcharactersareignored. Ifbaseiszeroitlooksforaleading0b,0oor0xto
tellwhichbase. Iftheseareabsentitdefaultsto10. Basemustbe0orbetween2and36(inclusive). Ifptr
isnon-NULLitwillcontainapointertotheendofthescan.
If the converted value falls out of range of corresponding return type, range error occurs (errno is set to
ERANGE)andULONG_MAXisreturned. Ifnoconversioncanbeperformed,0isreturned.
SeealsotheUnixmanpagestrtoul(3).
Addedinversion3.2.
94 Chapter7. Utilities

### 第103页

longPyOS_strtol(constchar*str,char**ptr,intbase)
PartoftheStableABI.Converttheinitialpartofthestringinstrtoanlongvalueaccordingtothegiven
base,whichmustbebetween2and36inclusive,orbethespecialvalue0.
SameasPyOS_strtoul(),butreturnalongvalueinsteadandLONG_MAXonoverflows.
SeealsotheUnixmanpagestrtol(3).
Addedinversion3.2.
doublePyOS_string_to_double(constchar*s,char**endptr,PyObject*overflow_exception)
Part of the Stable ABI. Convert a string s to a double, raising a Python exception on failure. The set of
accepted strings corresponds to the set of strings accepted by Python’s float() constructor, except that s
mustnothaveleadingortrailingwhitespace. Theconversionisindependentofthecurrentlocale.
IfendptrisNULL,convertthewholestring. RaiseValueErrorandreturn-1.0ifthestringisnotavalid
representationofafloating-pointnumber.
IfendptrisnotNULL,convertasmuchofthestringaspossibleandset*endptrtopointtothefirstunconverted
character. Ifnoinitialsegmentofthestringisthevalidrepresentationofafloating-pointnumber,set*endptr
topointtothebeginningofthestring,raiseValueError,andreturn-1.0.
If s represents a value that is too large to store in a float (for example, "1e500" is such a string on many
platforms)thenifoverflow_exceptionisNULLreturnPy_INFINITY(withanappropriatesign)anddon’t
set any exception. Otherwise, overflow_exception must point to a Python exception object; raise that
exceptionandreturn-1.0. Inbothcases,set*endptrtopointtothefirstcharacteraftertheconvertedvalue.
If any other error occurs during the conversion (for example an out-of-memory error), set the appropriate
Pythonexceptionandreturn-1.0.
Addedinversion3.1.
char*PyOS_double_to_string(doubleval,charformat_code,intprecision,intflags,int*ptype)
PartoftheStableABI.Convertadoublevaltoastringusingsuppliedformat_code,precision,andflags.
format_codemustbeoneof'e','E','f','F','g','G'or'r'. For'r',thesuppliedprecisionmustbe
0andisignored. The'r'formatcodespecifiesthestandardrepr()format.
flags can be zero or more of the values Py_DTSF_SIGN, Py_DTSF_ADD_DOT_0, or Py_DTSF_ALT, or-ed
together:
• Py_DTSF_SIGNmeanstoalwaysprecedethereturnedstringwithasigncharacter, evenifval isnon-
negative.
• Py_DTSF_ADD_DOT_0meanstoensurethatthereturnedstringwillnotlooklikeaninteger.
• Py_DTSF_ALT means to apply “alternate” formatting rules. See the documentation for the
PyOS_snprintf()'#'specifierfordetails.
Ifptypeisnon-NULL,thenthevalueitpointstowillbesettooneofPy_DTST_FINITE,Py_DTST_INFINITE,
orPy_DTST_NAN,signifyingthatvalisafinitenumber,aninfinitenumber,ornotanumber,respectively.
ThereturnvalueisapointertobufferwiththeconvertedstringorNULLiftheconversionfailed. Thecalleris
responsibleforfreeingthereturnedstringbycallingPyMem_Free().
Addedinversion3.1.
intPyOS_stricmp(constchar*s1,constchar*s2)
Case insensitive comparison of strings. The function works almost identically to strcmp() except that it
ignoresthecase.
intPyOS_strnicmp(constchar*s1,constchar*s2,Py_ssize_tsize)
Case insensitive comparison of strings. The function works almost identically to strncmp() except that it
ignoresthecase.
7.7. Stringconversionandformatting 95

### 第104页

7.8 PyHash API
SeealsothePyTypeObject.tp_hashmemberandnumeric-hash.
typePy_hash_t
Hashvaluetype: signedinteger.
Addedinversion3.2.
typePy_uhash_t
Hashvaluetype: unsignedinteger.
Addedinversion3.2.
PyHASH_MODULUS
TheMersenneprimeP = 2**n -1,usedfornumerichashscheme.
Addedinversion3.13.
PyHASH_BITS
TheexponentnofPinPyHASH_MODULUS.
Addedinversion3.13.
PyHASH_MULTIPLIER
Primemultiplierusedinstringandvariousotherhashes.
Addedinversion3.13.
PyHASH_INF
Thehashvaluereturnedforapositiveinfinity.
Addedinversion3.13.
PyHASH_IMAG
Themultiplierusedfortheimaginarypartofacomplexnumber.
Addedinversion3.13.
typePyHash_FuncDef
HashfunctiondefinitionusedbyPyHash_GetFuncDef().
Py_hash_t(*consthash)(constvoid*,Py_ssize_t)
Hashfunction.
constchar*name
Hashfunctionname(UTF-8encodedstring).
constinthash_bits
Internalsizeofthehashvalueinbits.
constintseed_bits
Sizeofseedinputinbits.
Addedinversion3.4.
PyHash_FuncDef *PyHash_GetFuncDef(void)
Getthehashfunctiondefinition.
(cid:181) Seealso
PEP456“Secureandinterchangeablehashalgorithm”.
Addedinversion3.4.
96 Chapter7. Utilities

| (cid:181) Seealso |
| --- |
| PEP456“Secureandinterchangeablehashalgorithm”. |

### 第105页

Py_hash_tPy_HashPointer(constvoid*ptr)
Hashapointervalue: processthepointervalueasaninteger(castittouintptr_tinternally). Thepointeris
notdereferenced.
Thefunctioncannotfail: itcannotreturn-1.
Addedinversion3.13.
Py_hash_tPy_HashBuffer(constvoid*ptr,Py_ssize_tlen)
Computeandreturnthehashvalueofabufferoflenbytesstartingataddressptr. Thehashisguaranteedto
matchthatofbytes,memoryview,andotherbuilt-inobjectsthatimplementthebufferprotocol.
Usethisfunctiontoimplementhashingforimmutableobjectswhosetp_richcomparefunctioncompares
toanotherobject’sbuffer.
lenmustbegreaterthanorequalto0.
Thisfunctionalwayssucceeds.
Addedinversion3.14.
Py_hash_tPyObject_GenericHash(PyObject*obj)
Generichashingfunctionthatismeanttobeputintoatypeobject’stp_hashslot. Itsresultonlydependson
theobject’sidentity.
CPythonimplementationdetail: InCPython,itisequivalenttoPy_HashPointer().
Addedinversion3.13.
7.9 Reflection
PyObject*PyEval_GetBuiltins(void)
Return value: Borrowed reference. Part of the Stable ABI. Deprecated since version 3.13: Use
PyEval_GetFrameBuiltins()instead.
Returnadictionaryofthebuiltinsinthecurrentexecutionframe,ortheinterpreterofthethreadstateifno
frameiscurrentlyexecuting.
PyObject*PyEval_GetLocals(void)
Return value: Borrowed reference. Part of the Stable ABI. Deprecated since version 3.13: Use either
PyEval_GetFrameLocals() to obtain the same behaviour as calling locals() in Python code, or else
call PyFrame_GetLocals() on the result of PyEval_GetFrame() to access the f_locals attribute of
thecurrentlyexecutingframe.
Returnamappingprovidingaccesstothelocalvariablesinthecurrentexecutionframe,orNULLifnoframe
iscurrentlyexecuting.
Refertolocals()fordetailsofthemappingreturnedatdifferentscopes.
As this function returns a borrowed reference, the dictionary returned for optimized scopes is cached on the
frameobjectandwillremainaliveaslongastheframeobjectdoes. UnlikePyEval_GetFrameLocals()
and locals(), subsequent calls to this function in the same frame will update the contents of the cached
dictionarytoreflectchangesinthestateofthelocalvariablesratherthanreturninganewsnapshot.
Changed in version 3.13: As part of PEP 667, PyFrame_GetLocals(), locals(), and FrameType.
f_localsnolongermakeuseofthesharedcachedictionary. RefertotheWhat’sNewentryforadditional
details.
PyObject*PyEval_GetGlobals(void)
Return value: Borrowed reference. Part of the Stable ABI. Deprecated since version 3.13: Use
PyEval_GetFrameGlobals()instead.
Return a dictionary of the global variables in the current execution frame, or NULL if no frame is currently
executing.
7.9. Reflection 97

### 第106页

PyFrameObject*PyEval_GetFrame(void)
Returnvalue: Borrowedreference. PartoftheStableABI.Returntheattachedthreadstate’sframe,whichis
NULLifnoframeiscurrentlyexecuting.
SeealsoPyThreadState_GetFrame().
PyObject*PyEval_GetFrameBuiltins(void)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.13. Returnadictionaryofthebuiltinsin
thecurrentexecutionframe,ortheinterpreterofthethreadstateifnoframeiscurrentlyexecuting.
Addedinversion3.13.
PyObject*PyEval_GetFrameLocals(void)
Returnvalue:Newreference. PartoftheStableABIsinceversion3.13. Returnadictionaryofthelocalvariables
inthecurrentexecutionframe,orNULLifnoframeiscurrentlyexecuting. Equivalenttocallinglocals()in
Pythoncode.
Toaccessf_localsonthecurrentframewithoutmakinganindependentsnapshotinoptimizedscopes,call
PyFrame_GetLocals()ontheresultofPyEval_GetFrame().
Addedinversion3.13.
PyObject*PyEval_GetFrameGlobals(void)
Return value: New reference. Part of the Stable ABI since version 3.13. Return a dictionary of the global
variables in the current execution frame, or NULL if no frame is currently executing. Equivalent to calling
globals()inPythoncode.
Addedinversion3.13.
constchar*PyEval_GetFuncName(PyObject*func)
PartoftheStableABI.Returnthenameoffuncifitisafunction,classorinstanceobject,elsethenameof
funcstype.
constchar*PyEval_GetFuncDesc(PyObject*func)
Part of the Stable ABI. Return a description string, depending on the type of func. Return values include
“()” for functions and methods, “ constructor”, “ instance”, and “ object”. Concatenated with the result of
PyEval_GetFuncName(),theresultwillbeadescriptionoffunc.
7.10 Codec registry and support functions
intPyCodec_Register(PyObject*search_function)
PartoftheStableABI.Registeranewcodecsearchfunction.
Assideeffect,thistriestoloadtheencodingspackage,ifnotyetdone,tomakesurethatitisalwaysfirstin
thelistofsearchfunctions.
intPyCodec_Unregister(PyObject*search_function)
Partofthe StableABI sinceversion3.10. Unregisteracodecsearchfunctionandcleartheregistry’scache.
Ifthesearchfunctionisnotregistered,donothing. Return0onsuccess. Raiseanexceptionandreturn-1on
error.
Addedinversion3.10.
intPyCodec_KnownEncoding(constchar*encoding)
PartoftheStableABI.Return1or0dependingonwhetherthereisaregisteredcodecforthegivenencoding.
Thisfunctionalwayssucceeds.
PyObject*PyCodec_Encode(PyObject*object,constchar*encoding,constchar*errors)
Returnvalue: Newreference. PartoftheStableABI.GenericcodecbasedencodingAPI.
object is passed through the encoder function found for the given encoding using the error handling method
definedbyerrors. errorsmaybeNULLtousethedefaultmethoddefinedforthecodec. RaisesaLookupError
ifnoencodercanbefound.
98 Chapter7. Utilities

### 第107页

PyObject*PyCodec_Decode(PyObject*object,constchar*encoding,constchar*errors)
Returnvalue: Newreference. PartoftheStableABI.GenericcodecbaseddecodingAPI.
object is passed through the decoder function found for the given encoding using the error handling method
definedbyerrors. errorsmaybeNULLtousethedefaultmethoddefinedforthecodec. RaisesaLookupError
ifnoencodercanbefound.
7.10.1 Codec lookup API
In the following functions, the encoding string is looked up converted to all lower-case characters, which makes
encodingslookedupthroughthismechanismeffectivelycase-insensitive. Ifnocodecisfound, aKeyErrorisset
andNULLreturned.
PyObject*PyCodec_Encoder(constchar*encoding)
Returnvalue: Newreference. PartoftheStableABI.Getanencoderfunctionforthegivenencoding.
PyObject*PyCodec_Decoder(constchar*encoding)
Returnvalue: Newreference. PartoftheStableABI.Getadecoderfunctionforthegivenencoding.
PyObject*PyCodec_IncrementalEncoder(constchar*encoding,constchar*errors)
Return value: New reference. Part of the Stable ABI. Get an IncrementalEncoder object for the given
encoding.
PyObject*PyCodec_IncrementalDecoder(constchar*encoding,constchar*errors)
Return value: New reference. Part of the Stable ABI. Get an IncrementalDecoder object for the given
encoding.
PyObject*PyCodec_StreamReader(constchar*encoding,PyObject*stream,constchar*errors)
Return value: New reference. Part of the Stable ABI. Get a StreamReader factory function for the given
encoding.
PyObject*PyCodec_StreamWriter(constchar*encoding,PyObject*stream,constchar*errors)
Return value: New reference. Part of the Stable ABI. Get a StreamWriter factory function for the given
encoding.
7.10.2 Registry API for Unicode encoding error handlers
intPyCodec_RegisterError(constchar*name,PyObject*error)
PartoftheStableABI.Registertheerrorhandlingcallbackfunctionerrorunderthegivenname. Thiscallback
functionwillbecalledbyacodecwhenitencountersunencodablecharacters/undecodablebytesandnameis
specifiedastheerrorparameterinthecalltotheencode/decodefunction.
The callback gets a single argument, an instance of UnicodeEncodeError, UnicodeDecodeError or
UnicodeTranslateError that holds information about the problematic sequence of characters or bytes
andtheiroffsetintheoriginalstring(seeUnicodeExceptionObjectsforfunctionstoextractthisinformation).
Thecallbackmusteitherraisethegivenexception,orreturnatwo-itemtuplecontainingthereplacementfor
the problematicsequence, andan integergivingtheoffset intheoriginalstringatwhichencoding/decoding
shouldberesumed.
Return0onsuccess,-1onerror.
PyObject*PyCodec_LookupError(constchar*name)
Returnvalue: Newreference. PartoftheStableABI.Lookuptheerrorhandlingcallbackfunctionregistered
undername. AsaspecialcaseNULLcanbepassed,inwhichcasetheerrorhandlingcallbackfor“strict”will
bereturned.
PyObject*PyCodec_StrictErrors(PyObject*exc)
Returnvalue: AlwaysNULL.PartoftheStableABI.Raiseexcasanexception.
PyObject*PyCodec_IgnoreErrors(PyObject*exc)
Returnvalue: Newreference. PartoftheStableABI.Ignoretheunicodeerror,skippingthefaultyinput.
7.10. Codecregistryandsupportfunctions 99

### 第108页

PyObject*PyCodec_ReplaceErrors(PyObject*exc)
Returnvalue: Newreference. PartoftheStableABI.Replacetheunicodeencodeerrorwith?orU+FFFD.
PyObject*PyCodec_XMLCharRefReplaceErrors(PyObject*exc)
Returnvalue: Newreference. PartoftheStableABI.ReplacetheunicodeencodeerrorwithXMLcharacter
references.
PyObject*PyCodec_BackslashReplaceErrors(PyObject*exc)
Returnvalue: Newreference. PartoftheStableABI.Replacetheunicodeencodeerrorwithbackslashescapes
(\x,\uand\U).
PyObject*PyCodec_NameReplaceErrors(PyObject*exc)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.7. Replacetheunicodeencodeerrorwith
\N{...}escapes.
Addedinversion3.5.
7.11 PyTime C API
Addedinversion3.13.
TheclockCAPIprovidesaccesstosystemclocks. ItissimilartothePythontimemodule.
ForCAPIrelatedtothedatetimemodule,seeDateTimeObjects.
7.11.1 Types
typePyTime_t
Atimestampordurationinnanoseconds,representedasasigned64-bitinteger.
Thereferencepointfortimestampsdependsontheclockused. Forexample,PyTime_Time()returnstimes-
tampsrelativetotheUNIXepoch.
The supported range is around [-292.3 years; +292.3 years]. Using the Unix epoch (January 1st, 1970) as
reference, the supported date range is around [1677-09-21; 2262-04-11]. The exact limits are exposed as
constants:
PyTime_tPyTime_MIN
MinimumvalueofPyTime_t.
PyTime_tPyTime_MAX
MaximumvalueofPyTime_t.
7.11.2 Clock Functions
ThefollowingfunctionstakeapointertoaPyTime_tthattheysettothevalueofaparticularclock. Detailsofeach
clockaregiveninthedocumentationofthecorrespondingPythonfunction.
Thefunctionsreturn0onsuccess,or-1(withanexceptionset)onfailure.
Onintegeroverflow,theysetthePyExc_OverflowErrorexceptionandset*resulttothevalueclampedtothe
[PyTime_MIN; PyTime_MAX]range. (Oncurrentsystems,integeroverflowsarelikelycausedbymisconfigured
systemtime.)
AsanyotherCAPI(unlessotherwisespecified),thefunctionsmustbecalledwithanattachedthreadstate.
intPyTime_Monotonic(PyTime_t*result)
Readthemonotonicclock. Seetime.monotonic()forimportantdetailsonthisclock.
intPyTime_PerfCounter(PyTime_t*result)
Readtheperformancecounter. Seetime.perf_counter()forimportantdetailsonthisclock.
intPyTime_Time(PyTime_t*result)
Readthe“wallclock”time. Seetime.time()fordetailsimportantonthisclock.
100 Chapter7. Utilities

### 第109页

7.11.3 Raw Clock Functions
Similartoclockfunctions,butdon’tsetanexceptiononerroranddon’trequirethecallertohaveanattachedthread
state.
Onsuccess,thefunctionsreturn0.
Onfailure,theyset*resultto0andreturn-1,withoutsettinganexception. Togetthecauseoftheerror,attacha
threadstate,andcalltheregular(non-Raw)function. NotethattheregularfunctionmaysucceedaftertheRawone
failed.
intPyTime_MonotonicRaw(PyTime_t*result)
SimilartoPyTime_Monotonic(), butdon’tsetanexceptiononerroranddon’trequireanattachedthread
state.
intPyTime_PerfCounterRaw(PyTime_t*result)
SimilartoPyTime_PerfCounter(),butdon’tsetanexceptiononerroranddon’trequireanattachedthread
state.
intPyTime_TimeRaw(PyTime_t*result)
SimilartoPyTime_Time(),butdon’tsetanexceptiononerroranddon’trequireanattachedthreadstate.
7.11.4 Conversion functions
doublePyTime_AsSecondsDouble(PyTime_tt)
ConvertatimestamptoanumberofsecondsasaCdouble.
Thefunctioncannotfail,butnotethatdoublehaslimitedaccuracyforlargevalues.
7.12 Support for Perf Maps
Onsupportedplatforms(asofthiswriting, onlyLinux),theruntimecantakeadvantageofperfmapfilestomake
Pythonfunctionsvisibletoanexternalprofilingtool(suchasperf). Arunningprocessmaycreateafileinthe/tmp
directory,whichcontainsentriesthatcanmapasectionofexecutablecodetoaname. Thisinterfaceisdescribedin
thedocumentationoftheLinuxPerftool.
InPython,thesehelperAPIscanbeusedbylibrariesandfeaturesthatrelyongeneratingmachinecodeonthefly.
NotethatholdinganattachedthreadstateisnotrequiredfortheseAPIs.
intPyUnstable_PerfMapState_Init(void)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Openthe/tmp/perf-$pid.mapfile,unlessit’salreadyopened,andcreatealocktoensurethread-safewrites
tothefile(providedthewritesaredonethroughPyUnstable_WritePerfMapEntry()). Normally,there’s
noneedtocallthisexplicitly;justusePyUnstable_WritePerfMapEntry()anditwillinitializethestate
onfirstcall.
Returns0onsuccess,-1onfailuretocreate/opentheperfmapfile,or-2onfailuretocreatealock. Check
errnoformoreinformationaboutthecauseofafailure.
intPyUnstable_WritePerfMapEntry(constvoid*code_addr,unsignedintcode_size,constchar
*entry_name)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
7.12. SupportforPerfMaps 101

### 第110页

Write one single entry to the /tmp/perf-$pid.map file. This function is thread safe. Here is what an
exampleentrylookslike:
# address size name
7f3529fcf759 b py::bar:/run/t.py
WillcallPyUnstable_PerfMapState_Init()beforewritingtheentry,iftheperfmapfileisnotalready
opened. Returns0onsuccess,orthesameerrorcodesasPyUnstable_PerfMapState_Init()onfailure.
voidPyUnstable_PerfMapState_Fini(void)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Close the perf map file opened by PyUnstable_PerfMapState_Init(). This is called by the runtime
itself during interpreter shut-down. In general, there shouldn’t be a reason to explicitly call this, except to
handlespecificscenariossuchasforking.
102 Chapter7. Utilities

### 第111页

CHAPTER
EIGHT
ABSTRACT OBJECTS LAYER
ThefunctionsinthischapterinteractwithPythonobjectsregardlessoftheirtype,orwithwideclassesofobjecttypes
(e.g. allnumericaltypes,orallsequencetypes). Whenusedonobjecttypesforwhichtheydonotapply,theywill
raiseaPythonexception.
Itisnotpossibletousethesefunctionsonobjectsthatarenotproperlyinitialized,suchasalistobjectthathasbeen
createdbyPyList_New(),butwhoseitemshavenotbeensettosomenon-NULLvalueyet.
8.1 Object Protocol
PyObject*Py_GetConstant(unsignedintconstant_id)
PartoftheStableABIsinceversion3.13. Getastrongreferencetoaconstant.
SetanexceptionandreturnNULLifconstant_idisinvalid.
constant_idmustbeoneoftheseconstantidentifiers:
103

### 第112页

ConstantIdentifier Value Returnedobject
0 None
Py_CONSTANT_NONE
1 False
Py_CONSTANT_FALSE
2 True
Py_CONSTANT_TRUE
3 Ellipsis
Py_CONSTANT_ELLIPSIS
4 NotImplemented
Py_CONSTANT_NOT_IMPLEMENTED
5 0
Py_CONSTANT_ZERO
6 1
Py_CONSTANT_ONE
7 ''
Py_CONSTANT_EMPTY_STR
8 b''
Py_CONSTANT_EMPTY_BYTES
9 ()
Py_CONSTANT_EMPTY_TUPLE
Numericvaluesareonlygivenforprojectswhichcannotusetheconstantidentifiers.
Addedinversion3.13.
CPythonimplementationdetail: InCPython,alloftheseconstantsareimmortal.
PyObject*Py_GetConstantBorrowed(unsignedintconstant_id)
PartoftheStableABIsinceversion3.13. SimilartoPy_GetConstant(),butreturnaborrowedreference.
Thisfunctionisprimarilyintendedforbackwardscompatibility: usingPy_GetConstant()isrecommended
fornewcode.
Thereferenceisborrowedfromtheinterpreter,andisvaliduntiltheinterpreterfinalization.
Addedinversion3.13.
PyObject*Py_NotImplemented
TheNotImplementedsingleton,usedtosignalthatanoperationisnotimplementedforthegiventypecom-
bination.
Py_RETURN_NOTIMPLEMENTED
ProperlyhandlereturningPy_NotImplementedfromwithinaCfunction(thatis,createanewstrongrefer-
encetoNotImplementedandreturnit).
Py_PRINT_RAW
Flag to be used with multiple functions that print the object (like PyObject_Print() and
PyFile_WriteObject()). If passed, these function would use the str() of the object instead of the
repr().
104 Chapter8. AbstractObjectsLayer

| ConstantIdentifier | Value | Returnedobject |
| --- | --- | --- |
| Py_CONSTANT_NONE | 0 | None |
| Py_CONSTANT_FALSE | 1 | False |
| Py_CONSTANT_TRUE | 2 | True |
| Py_CONSTANT_ELLIPSIS | 3 | Ellipsis |
| Py_CONSTANT_NOT_IMPLEMENT | 4
ED | NotImplemented |
| Py_CONSTANT_ZERO | 5 | 0 |
| Py_CONSTANT_ONE | 6 | 1 |
| Py_CONSTANT_EMPTY_STR | 7 | '' |
| Py_CONSTANT_EMPTY_BYTES | 8 | b'' |
| Py_CONSTANT_EMPTY_TUPLE | 9 | () |

### 第113页

intPyObject_Print(PyObject*o,FILE*fp,intflags)
Printanobjecto,onfilefp. Returns-1onerror. Theflagsargumentisusedtoenablecertainprintingoptions.
TheonlyoptioncurrentlysupportedisPy_PRINT_RAW;ifgiven,thestr()oftheobjectiswritteninsteadof
therepr().
intPyObject_HasAttrWithError(PyObject*o,PyObject*attr_name)
PartoftheStableABIsinceversion3.13. Returns1ifohastheattributeattr_name,and0otherwise. Thisis
equivalenttothePythonexpressionhasattr(o, attr_name). Onfailure,return-1.
Addedinversion3.13.
intPyObject_HasAttrStringWithError(PyObject*o,constchar*attr_name)
Part of the Stable ABI since version 3.13. This is the same as PyObject_HasAttrWithError(), but
attr_nameisspecifiedasaconst char*UTF-8encodedbytesstring,ratherthanaPyObject*.
Addedinversion3.13.
intPyObject_HasAttr(PyObject*o,PyObject*attr_name)
Part of the Stable ABI. Returns 1 if o has the attribute attr_name, and 0 otherwise. This function always
succeeds.
(cid:174) Note
Exceptions that occur when this calls __getattr__() and __getattribute__() methods aren’t
propagated, but instead given to sys.unraisablehook(). For proper error handling, use
PyObject_HasAttrWithError(),PyObject_GetOptionalAttr()orPyObject_GetAttr()in-
stead.
intPyObject_HasAttrString(PyObject*o,constchar*attr_name)
Part ofthe StableABI. This isthe sameas PyObject_HasAttr(), but attr_name is specifiedas a const
char*UTF-8encodedbytesstring,ratherthanaPyObject*.
(cid:174) Note
Exceptions that occur when this calls __getattr__() and __getattribute__() methods
or while creating the temporary str object are silently ignored. For proper error han-
dling, use PyObject_HasAttrStringWithError(), PyObject_GetOptionalAttrString() or
PyObject_GetAttrString()instead.
PyObject*PyObject_GetAttr(PyObject*o,PyObject*attr_name)
Return value: New reference. Part of the Stable ABI. Retrieve an attribute named attr_name from object o.
Returns the attribute value on success, or NULL on failure. This is the equivalent of the Python expression
o.attr_name.
If the missing attribute should not be treated as a failure, you can use PyObject_GetOptionalAttr()
instead.
PyObject*PyObject_GetAttrString(PyObject*o,constchar*attr_name)
Return value: New reference. Part of the Stable ABI. This is the same as PyObject_GetAttr(), but
attr_nameisspecifiedasaconst char*UTF-8encodedbytesstring,ratherthanaPyObject*.
If the missing attribute should not be treated as a failure, you can use
PyObject_GetOptionalAttrString()instead.
intPyObject_GetOptionalAttr(PyObject*obj,PyObject*attr_name,PyObject**result);
Part of the Stable ABI since version 3.13. Variant of PyObject_GetAttr() which doesn’t raise
AttributeErroriftheattributeisnotfound.
8.1. ObjectProtocol 105

### 第114页

If the attribute is found, return 1 and set *result to a new strong reference to the attribute. If the attribute
is not found, return 0 and set *result to NULL; the AttributeError is silenced. If an error other than
AttributeErrorisraised,return-1andset*resulttoNULL.
Addedinversion3.13.
intPyObject_GetOptionalAttrString(PyObject*obj,constchar*attr_name,PyObject**result);
Part of the Stable ABI since version 3.13. This is the same as PyObject_GetOptionalAttr(), but
attr_nameisspecifiedasaconst char*UTF-8encodedbytesstring,ratherthanaPyObject*.
Addedinversion3.13.
PyObject*PyObject_GenericGetAttr(PyObject*o,PyObject*name)
Returnvalue: Newreference. PartoftheStableABI.Genericattributegetterfunctionthatismeanttobeput
into a type object’s tp_getattro slot. It looks for a descriptor in the dictionary of classes in the object’s
MROaswellasanattributeintheobject’s__dict__(ifpresent). Asoutlinedindescriptors,datadescriptors
takepreferenceoverinstanceattributes,whilenon-datadescriptorsdon’t. Otherwise,anAttributeErroris
raised.
intPyObject_SetAttr(PyObject*o,PyObject*attr_name,PyObject*v)
Part of the Stable ABI. Set the value of the attribute named attr_name, for object o, to the value v. Raise
an exception and return -1 on failure; return 0 on success. This is the equivalent of the Python statement
o.attr_name = v.
IfvisNULL,theattributeisdeleted. ThisbehaviourisdeprecatedinfavourofusingPyObject_DelAttr(),
buttherearecurrentlynoplanstoremoveit.
intPyObject_SetAttrString(PyObject*o,constchar*attr_name,PyObject*v)
Part ofthe StableABI. This isthe sameas PyObject_SetAttr(), but attr_name is specifiedas a const
char*UTF-8encodedbytesstring,ratherthanaPyObject*.
If v is NULL, the attribute is deleted, but this feature is deprecated in favour of using
PyObject_DelAttrString().
The number of different attribute names passed to this function should be kept small, usually by us-
ing a statically allocated string as attr_name. For attribute names that aren’t known at compile time,
prefer calling PyUnicode_FromString() and PyObject_SetAttr() directly. For more details, see
PyUnicode_InternFromString(),whichmaybeusedinternallytocreateakeyobject.
intPyObject_GenericSetAttr(PyObject*o,PyObject*name,PyObject*value)
PartoftheStableABI.Genericattributesetteranddeleterfunctionthatismeanttobeputintoatypeobject’s
tp_setattroslot. Itlooksforadatadescriptorinthedictionaryofclassesintheobject’sMRO,andiffound
ittakespreferenceoversettingordeletingtheattributeintheinstancedictionary. Otherwise,theattributeisset
ordeletedintheobject’s__dict__(ifpresent). Onsuccess,0isreturned,otherwiseanAttributeError
israisedand-1isreturned.
intPyObject_DelAttr(PyObject*o,PyObject*attr_name)
Part of the Stable ABI since version 3.13. Delete attribute named attr_name, for object o. Returns -1 on
failure. ThisistheequivalentofthePythonstatementdel o.attr_name.
intPyObject_DelAttrString(PyObject*o,constchar*attr_name)
Part of the Stable ABI since version 3.13. This is the same as PyObject_DelAttr(), but attr_name is
specifiedasaconst char*UTF-8encodedbytesstring,ratherthanaPyObject*.
The number of different attribute names passed to this function should be kept small, usually by us-
ing a statically allocated string as attr_name. For attribute names that aren’t known at compile time,
prefer calling PyUnicode_FromString() and PyObject_DelAttr() directly. For more details, see
PyUnicode_InternFromString(),whichmaybeusedinternallytocreateakeyobjectforlookup.
PyObject*PyObject_GenericGetDict(PyObject*o,void*context)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.10. Agenericimplementationforthegetter
ofa__dict__descriptor. Itcreatesthedictionaryifnecessary.
106 Chapter8. AbstractObjectsLayer

### 第115页

This function may also be called to get the __dict__ of the object o. Pass NULL for context when call-
ing it. Since this function may need to allocate memory for the dictionary, it may be more efficient to call
PyObject_GetAttr()whenaccessinganattributeontheobject.
Onfailure,returnsNULLwithanexceptionset.
Addedinversion3.3.
intPyObject_GenericSetDict(PyObject*o,PyObject*value,void*context)
PartoftheStableABIsinceversion3.7. Agenericimplementationforthesetterofa__dict__descriptor.
Thisimplementationdoesnotallowthedictionarytobedeleted.
Addedinversion3.3.
PyObject**_PyObject_GetDictPtr(PyObject*obj)
Return a pointer to __dict__ of the object obj. If there is no __dict__, return NULL without setting an
exception.
This function may need to allocate memory for the dictionary, so it may be more efficient to call
PyObject_GetAttr()whenaccessinganattributeontheobject.
PyObject*PyObject_RichCompare(PyObject*o1,PyObject*o2,intopid)
Return value: New reference. Part of the Stable ABI. Compare the values of o1 and o2 using the operation
specifiedbyopid,whichmustbeoneofPy_LT,Py_LE,Py_EQ,Py_NE,Py_GT,orPy_GE,correspondingto
<,<=,==,!=,>,or>=respectively. ThisistheequivalentofthePythonexpressiono1 op o2,whereopis
theoperatorcorrespondingtoopid. Returnsthevalueofthecomparisononsuccess,orNULLonfailure.
intPyObject_RichCompareBool(PyObject*o1,PyObject*o2,intopid)
Part of the Stable ABI. Compare the values of o1 and o2 using the operation specified by opid, like
PyObject_RichCompare(),butreturns-1onerror,0iftheresultisfalse,1otherwise.
(cid:174) Note
Ifo1ando2arethesameobject,PyObject_RichCompareBool()willalwaysreturn1forPy_EQand0for
Py_NE.
PyObject*PyObject_Format(PyObject*obj,PyObject*format_spec)
Part of the Stable ABI. Format obj using format_spec. This is equivalent to the Python expression
format(obj, format_spec).
format_specmaybeNULL.Inthiscasethecallisequivalenttoformat(obj). Returnstheformattedstring
onsuccess,NULLonfailure.
PyObject*PyObject_Repr(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.Computeastringrepresentationofobjecto. Returnsthe
stringrepresentationonsuccess,NULLonfailure. ThisistheequivalentofthePythonexpressionrepr(o).
Calledbytherepr()built-infunction.
Changedinversion3.4: Thisfunctionnowincludesadebugassertiontohelpensurethatitdoesnotsilently
discardanactiveexception.
PyObject*PyObject_ASCII(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.AsPyObject_Repr(),computeastringrepresentation
ofobjecto,butescapethenon-ASCIIcharactersinthestringreturnedbyPyObject_Repr()with\x,\uor
\Uescapes. ThisgeneratesastringsimilartothatreturnedbyPyObject_Repr()inPython2. Calledbythe
ascii()built-infunction.
PyObject*PyObject_Str(PyObject*o)
Return value: New reference. Part of the Stable ABI. Compute a string representation of object o. Returns
thestringrepresentationonsuccess,NULLonfailure. ThisistheequivalentofthePythonexpressionstr(o).
Calledbythestr()built-infunctionand,therefore,bytheprint()function.
8.1. ObjectProtocol 107

### 第116页

Changedinversion3.4: Thisfunctionnowincludesadebugassertiontohelpensurethatitdoesnotsilently
discardanactiveexception.
PyObject*PyObject_Bytes(PyObject*o)
Return value: New reference. Part of the Stable ABI. Compute a bytes representation of object o. NULL is
returnedonfailureandabytesobjectonsuccess. ThisisequivalenttothePythonexpressionbytes(o),when
oisnotaninteger. Unlikebytes(o),aTypeErrorisraisedwhenoisanintegerinsteadofazero-initialized
bytesobject.
intPyObject_IsSubclass(PyObject*derived,PyObject*cls)
Part of the Stable ABI. Return 1 if the class derived is identical to or derived from the class cls, otherwise
return0. Incaseofanerror,return-1.
Ifclsisatuple,thecheckwillbedoneagainsteveryentryincls. Theresultwillbe1whenatleastoneofthe
checksreturns1,otherwiseitwillbe0.
Ifclshasa__subclasscheck__()method,itwillbecalledtodeterminethesubclassstatusasdescribed
in PEP 3119. Otherwise, derived is a subclass of cls if it is a direct or indirect subclass, i.e. contained in
cls.__mro__.
Normallyonlyclassobjects,i.e. instancesoftypeoraderivedclass,areconsideredclasses. However,objects
canoverridethisbyhavinga__bases__attribute(whichmustbeatupleofbaseclasses).
intPyObject_IsInstance(PyObject*inst,PyObject*cls)
PartoftheStableABI.Return1ifinstisaninstanceoftheclassclsorasubclassofcls,or0ifnot. Onerror,
returns-1andsetsanexception.
Ifclsisatuple,thecheckwillbedoneagainsteveryentryincls. Theresultwillbe1whenatleastoneofthe
checksreturns1,otherwiseitwillbe0.
Ifclshasa__instancecheck__()method,itwillbecalledtodeterminethesubclassstatusasdescribedin
PEP3119. Otherwise,instisaninstanceofclsifitsclassisasubclassofcls.
Aninstanceinstcanoverridewhatisconsidereditsclassbyhavinga__class__attribute.
An object cls can override if it is considered a class, and what its base classes are, by having a __bases__
attribute(whichmustbeatupleofbaseclasses).
Py_hash_tPyObject_Hash(PyObject*o)
PartoftheStableABI.Computeandreturnthehashvalueofanobjecto. Onfailure,return-1. Thisisthe
equivalentofthePythonexpressionhash(o).
Changed in version 3.2: The return type is now Py_hash_t. This is a signed integer the same size as
Py_ssize_t.
Py_hash_tPyObject_HashNotImplemented(PyObject*o)
PartoftheStableABI.SetaTypeErrorindicatingthattype(o)isnothashableandreturn-1. Thisfunction
receivesspecialtreatmentwhenstoredinatp_hashslot,allowingatypetoexplicitlyindicatetotheinterpreter
thatitisnothashable.
intPyObject_IsTrue(PyObject*o)
PartoftheStableABI.Returns1iftheobjectoisconsideredtobetrue,and0otherwise. Thisisequivalent
tothePythonexpressionnot not o. Onfailure,return-1.
intPyObject_Not(PyObject*o)
PartoftheStableABI.Returns0iftheobjectoisconsideredtobetrue,and1otherwise. Thisisequivalent
tothePythonexpressionnot o. Onfailure,return-1.
PyObject*PyObject_Type(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.Whenoisnon-NULL,returnsatypeobjectcorrespond-
ing to the objecttype ofobject o. On failure, raises SystemError and returns NULL. Thisis equivalentto
the Python expression type(o). This function creates a new strong reference to the return value. There’s
really no reason to use this function instead of the Py_TYPE() function, which returns a pointer of type
PyTypeObject*,exceptwhenanewstrongreferenceisneeded.
108 Chapter8. AbstractObjectsLayer

### 第117页

intPyObject_TypeCheck(PyObject*o,PyTypeObject*type)
Returnnon-zeroiftheobjectoisoftypetypeorasubtypeoftype,and0otherwise. Bothparametersmustbe
non-NULL.
Py_ssize_tPyObject_Size(PyObject*o)
Py_ssize_tPyObject_Length(PyObject*o)
PartoftheStableABI.Returnthelengthofobjecto. Iftheobjectoprovideseitherthesequenceandmapping
protocols, the sequence length is returned. On error, -1 is returned. This is the equivalent to the Python
expressionlen(o).
Py_ssize_tPyObject_LengthHint(PyObject*o,Py_ssize_tdefaultvalue)
Return an estimated length for the object o. First try to return its actual length, then an estimate using
__length_hint__(), and finally return the default value. On error return -1. This is the equivalent to
thePythonexpressionoperator.length_hint(o, defaultvalue).
Addedinversion3.4.
PyObject*PyObject_GetItem(PyObject*o,PyObject*key)
Returnvalue: Newreference. PartoftheStableABI.Returnelementofocorrespondingtotheobjectkeyor
NULLonfailure. ThisistheequivalentofthePythonexpressiono[key].
intPyObject_SetItem(PyObject*o,PyObject*key,PyObject*v)
PartoftheStableABI.Maptheobjectkeytothevaluev. Raiseanexceptionandreturn-1onfailure;return
0 on success. This is the equivalent of the Python statement o[key] = v. This function does not steal a
referencetov.
intPyObject_DelItem(PyObject*o,PyObject*key)
PartoftheStableABI.Removethemappingfortheobjectkeyfromtheobjecto. Return-1onfailure. This
isequivalenttothePythonstatementdel o[key].
intPyObject_DelItemString(PyObject*o,constchar*key)
PartoftheStableABI.ThisisthesameasPyObject_DelItem(),butkeyisspecifiedasaconst char*
UTF-8encodedbytesstring,ratherthanaPyObject*.
PyObject*PyObject_Dir(PyObject*o)
Return value: New reference. Part of the Stable ABI. This is equivalent to the Python expression dir(o),
returninga(possiblyempty)listofstringsappropriatefortheobjectargument,orNULLiftherewasanerror.
IftheargumentisNULL,thisislikethePythondir(),returningthenamesofthecurrentlocals;inthiscase,
ifnoexecutionframeisactivethenNULLisreturnedbutPyErr_Occurred()willreturnfalse.
PyObject*PyObject_GetIter(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.ThisisequivalenttothePythonexpressioniter(o). It
returnsanewiteratorfortheobjectargument, ortheobjectitselfiftheobjectisalreadyaniterator. Raises
TypeErrorandreturnsNULLiftheobjectcannotbeiterated.
PyObject*PyObject_SelfIter(PyObject*obj)
Return value: New reference. Part of the Stable ABI. This is equivalent to the Python __iter__(self):
return selfmethod. Itisintendedforiteratortypes,tobeusedinthePyTypeObject.tp_iterslot.
PyObject*PyObject_GetAIter(PyObject*o)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.10. ThisistheequivalenttothePython
expression aiter(o). Takes an AsyncIterable object and returns an AsyncIterator for it. This is
typicallyanewiteratorbutiftheargumentisanAsyncIterator,thisreturnsitself. RaisesTypeErrorand
returnsNULLiftheobjectcannotbeiterated.
Addedinversion3.10.
void*PyObject_GetTypeData(PyObject*o,PyTypeObject*cls)
PartoftheStableABIsinceversion3.12. Getapointertosubclass-specificdatareservedforcls.
The object o must be an instance of cls, and cls must have been created using negative PyType_Spec.
basicsize. Pythondoesnotcheckthis.
8.1. ObjectProtocol 109

### 第118页

Onerror,setanexceptionandreturnNULL.
Addedinversion3.12.
Py_ssize_tPyType_GetTypeDataSize(PyTypeObject*cls)
PartoftheStableABIsinceversion3.12. Returnthesizeoftheinstancememoryspacereservedforcls,i.e.
thesizeofthememoryPyObject_GetTypeData()returns.
Thismaybelargerthanrequestedusing-PyType_Spec.basicsize; itissafetousethislargersize(e.g.
withmemset()).
ThetypeclsmusthavebeencreatedusingnegativePyType_Spec.basicsize. Pythondoesnotcheckthis.
Onerror,setanexceptionandreturnanegativevalue.
Addedinversion3.12.
void*PyObject_GetItemData(PyObject*o)
Getapointertoper-itemdataforaclasswithPy_TPFLAGS_ITEMS_AT_END.
On error, set an exception and return NULL. TypeError is raised if o does not have
Py_TPFLAGS_ITEMS_AT_ENDset.
Addedinversion3.12.
intPyObject_VisitManagedDict(PyObject*obj,visitprocvisit,void*arg)
Visitthemanageddictionaryofobj.
This function must only be called in a traverse function of the type which has the
Py_TPFLAGS_MANAGED_DICTflagset.
Addedinversion3.13.
voidPyObject_ClearManagedDict(PyObject*obj)
Clearthemanageddictionaryofobj.
This function must only be called in a traverse function of the type which has the
Py_TPFLAGS_MANAGED_DICTflagset.
Addedinversion3.13.
intPyUnstable_Object_EnableDeferredRefcount(PyObject*obj)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Enabledeferredreferencecountingonobj,ifsupportedbytheruntime. Inthefree-threadedbuild,thisallows
theinterpretertoavoidreferencecountadjustmentstoobj,whichmayimprovemulti-threadedperformance.
Thetradeoffisthatobjwillonlybedeallocatedbythetracinggarbagecollector,andnotwhentheinterpreter
nolongerhasanyreferencestoit.
Thisfunctionreturns1ifdeferredreferencecountingisenabledonobj,and0ifdeferredreferencecountingis
notsupportedorifthehintwasignoredbytheinterpreter,suchaswhendeferredreferencecountingisalready
enabledonobj. Thisfunctionisthread-safe,andcannotfail.
ThisfunctiondoesnothingonbuildswiththeGILenabled,whichdonotsupportdeferredreferencecounting.
Thisalsodoesnothingifobj isnotanobjecttrackedbythegarbagecollector(seegc.is_tracked()and
PyObject_GC_IsTracked()).
Thisfunctionisintendedtobeusedsoonafterobjiscreated,bythecodethatcreatesit,suchasintheobject’s
tp_newslot.
Addedinversion3.14.
110 Chapter8. AbstractObjectsLayer

### 第119页

intPyUnstable_Object_IsUniqueReferencedTemporary(PyObject*obj)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Checkifobjisauniquetemporaryobject. Returns1ifobjisknowntobeauniquetemporaryobject,and0
otherwise. Thisfunctioncannotfail,butthecheckisconservative,andmayreturn0insomecasesevenifobj
isauniquetemporaryobject.
Ifanobjectisauniquetemporary,itisguaranteedthatthecurrentcodehastheonlyreferencetotheobject.
ForargumentstoCfunctions,thisshouldbeusedinsteadofcheckingifthereferencecountis1. Startingwith
Python3.14, theinterpreterinternallyavoidssomereferencecountmodificationswhenloadingobjectsonto
theoperandsstackbyborrowingreferenceswhenpossible,whichmeansthatareferencecountof1byitself
doesnotguaranteethatafunctionargumentuniquelyreferenced.
Intheexamplebelow,my_funciscalledwithauniquetemporaryobjectasitsargument:
my_func([1, 2, 3])
In the example below, my_func is not called with a unique temporary object as its argument, even if its
refcountis1:
my_list = [1, 2, 3]
my_func(my_list)
SeealsothefunctionPy_REFCNT().
Addedinversion3.14.
intPyUnstable_IsImmortal(PyObject*obj)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Thisfunctionreturnsnon-zeroifobjisimmortal,andzerootherwise. Thisfunctioncannotfail.
(cid:174) Note
ObjectsthatareimmortalinoneCPythonversionarenotguaranteedtobeimmortalinanother.
Addedinversion3.14.
intPyUnstable_TryIncRef(PyObject*obj)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Incrementsthereferencecountofobjifitisnotzero. Returns1iftheobject’sreferencecountwassuccessfully
incremented. Otherwise,thisfunctionreturns0.
PyUnstable_EnableTryIncRef() must have been called earlier on obj or this function may spuriously
return0inthefreethreadingbuild.
This function is logically equivalent to the following C code, except that it behaves atomically in the free
threadingbuild:
8.1. ObjectProtocol 111

### 第120页

if (Py_REFCNT(op) > 0) {
Py_INCREF(op);
return 1;
}
return 0;
This is intended as a building block for managing weak references without the overhead of a Python weak
referenceobject.
Typically, correctuseofthisfunctionrequiressupportfromobj’sdeallocator(tp_dealloc). Forexample,
thefollowingsketchcouldbeadaptedtoimplementa“weakmap”thatworkslikeaWeakValueDictionary
foraspecifictype:
PyMutex mutex;
PyObject *
add_entry(weakmap_key_type *key, PyObject *value)
{
PyUnstable_EnableTryIncRef(value);
weakmap_type weakmap = ...;
PyMutex_Lock(&mutex);
weakmap_add_entry(weakmap, key, value);
PyMutex_Unlock(&mutex);
Py_RETURN_NONE;
}
PyObject *
get_value(weakmap_key_type *key)
{
weakmap_type weakmap = ...;
PyMutex_Lock(&mutex);
PyObject *result = weakmap_find(weakmap, key);
if (PyUnstable_TryIncRef(result)) {
// `result` is safe to use
PyMutex_Unlock(&mutex);
return result;
}
// if we get here, `result` is starting to be garbage-collected,
// but has not been removed from the weakmap yet
PyMutex_Unlock(&mutex);
return NULL;
}
// tp_dealloc function for weakmap values
void
value_dealloc(PyObject *value)
{
weakmap_type weakmap = ...;
PyMutex_Lock(&mutex);
weakmap_remove_value(weakmap, value);
...
PyMutex_Unlock(&mutex);
}
Addedinversion3.14.
voidPyUnstable_EnableTryIncRef(PyObject*obj)
112 Chapter8. AbstractObjectsLayer

### 第121页

(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
EnablessubsequentusesofPyUnstable_TryIncRef()onobj. Thecallermustholdastrongreferenceto
objwhencallingthis.
Addedinversion3.14.
intPyUnstable_Object_IsUniquelyReferenced(PyObject*op)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Determineifoponlyhasonereference.
OnGIL-enabledbuilds,thisfunctionisequivalenttoPy_REFCNT(op) == 1.
Onafreethreadedbuild,thischecksifop’sreferencecountisequaltooneandadditionallychecksifopisonly
usedbythisthread. Py_REFCNT(op) == 1isnotthread-safeonfreethreadedbuilds;preferthisfunction.
The caller must hold an attached thread state, despite the fact that this function doesn’t call into the Python
interpreter. Thisfunctioncannotfail.
Addedinversion3.14.
8.2 Call Protocol
CPythonsupportstwodifferentcallingprotocols: tp_callandvectorcall.
8.2.1 The tp_call Protocol
Instancesofclassesthatsettp_callarecallable. Thesignatureoftheslotis:
PyObject *tp_call(PyObject *callable, PyObject *args, PyObject *kwargs);
A call is made using a tuple for the positional arguments and a dict for the keyword arguments, similarly to
callable(*args, **kwargs) in Python code. args must be non-NULL (use an empty tuple if there are no
arguments)butkwargsmaybeNULLiftherearenokeywordarguments.
Thisconventionisnotonlyusedbytp_call: tp_newandtp_initalsopassargumentsthisway.
Tocallanobject,usePyObject_Call()oranothercallAPI.
8.2.2 The Vectorcall Protocol
Addedinversion3.9.
ThevectorcallprotocolwasintroducedinPEP590asanadditionalprotocolformakingcallsmoreefficient.
Asruleofthumb,CPythonwillpreferthevectorcallforinternalcallsifthecallablesupportsit. However,thisisnot
ahardrule. Additionally,somethird-partyextensionsusetp_call directly(ratherthanusingPyObject_Call()).
Therefore, a class supporting vectorcall must also implement tp_call. Moreover, the callable must behave the
same regardless of which protocol is used. The recommended way to achieve this is by setting tp_call to
PyVectorcall_Call(). Thisbearsrepeating:
8.2. CallProtocol 113

### 第122页

(cid:193) Warning
Aclasssupportingvectorcallmustalsoimplementtp_callwiththesamesemantics.
Changedinversion3.12: ThePy_TPFLAGS_HAVE_VECTORCALLflagisnowremovedfromaclasswhentheclass’s
__call__() method is reassigned. (This internally sets tp_call only, and thus may make it behave differently
thanthevectorcallfunction.) InearlierPythonversions, vectorcallshouldonlybeusedwithimmutableorstatic
types.
A class should not implement vectorcall if that would be slower than tp_call. For example, if the callee needs to
converttheargumentstoanargstupleandkwargsdictanyway,thenthereisnopointinimplementingvectorcall.
ClassescanimplementthevectorcallprotocolbyenablingthePy_TPFLAGS_HAVE_VECTORCALLflagandsetting
tp_vectorcall_offsettotheoffsetinsidetheobjectstructurewhereavectorcallfuncappears. Thisisapointer
toafunctionwiththefollowingsignature:
typedefPyObject*(*vectorcallfunc)(PyObject*callable,PyObject*const*args,size_tnargsf,PyObject
*kwnames)
PartoftheStableABIsinceversion3.12.
• callableistheobjectbeingcalled.
• argsisaCarrayconsistingofthepositionalargumentsfollowedbythe
valuesofthekeywordarguments. ThiscanbeNULLiftherearenoarguments.
• nargsfisthenumberofpositionalargumentspluspossiblythe
PY_VECTORCALL_ARGUMENTS_OFFSET flag. To get the actual number of positional arguments from
nargsf,usePyVectorcall_NARGS().
• kwnamesisatuplecontainingthenamesofthekeywordarguments;
inotherwords,thekeysofthekwargsdict. Thesenamesmustbestrings(instancesofstrorasubclass)
andtheymustbeunique. Iftherearenokeywordarguments,thenkwnamescaninsteadbeNULL.
PY_VECTORCALL_ARGUMENTS_OFFSET
PartoftheStableABIsinceversion3.12. Ifthisflagissetinavectorcallnargsfargument,thecalleeisallowed
totemporarilychangeargs[-1]. Inotherwords,argspointstoargument1(not0)intheallocatedvector.
Thecalleemustrestorethevalueofargs[-1]beforereturning.
ForPyObject_VectorcallMethod(),thisflagmeansinsteadthatargs[0]maybechanged.
Whenever they can do so cheaply (without additional allocation), callers are encouraged to use
PY_VECTORCALL_ARGUMENTS_OFFSET.Doingsowillallowcallablessuchasboundmethodstomaketheir
onwardcalls(whichincludeaprependedself argument)veryefficiently.
Addedinversion3.8.
To call an object that implements vectorcall, use a call API function as with any other callable.
PyObject_Vectorcall()willusuallybemostefficient.
RecursionControl
Whenusingtp_call,calleesdonotneedtoworryaboutrecursion: CPythonusesPy_EnterRecursiveCall()and
Py_LeaveRecursiveCall()forcallsmadeusingtp_call.
Forefficiency, thisisnotthecaseforcallsdoneusingvectorcall: thecalleeshoulduse Py_EnterRecursiveCall and
Py_LeaveRecursiveCallifneeded.
VectorcallSupportAPI
Py_ssize_tPyVectorcall_NARGS(size_tnargsf)
Part of the Stable ABI since version 3.12. Given a vectorcall nargsf argument, return the actual number of
arguments. Currentlyequivalentto:
114 Chapter8. AbstractObjectsLayer

|  |
| --- |
| (cid:193) Warning |
| Aclasssupportingvectorcallmustalsoimplementtp_callwiththesamesemantics. |

### 第123页

(Py_ssize_t)(nargsf & ~PY_VECTORCALL_ARGUMENTS_OFFSET)
However,thefunctionPyVectorcall_NARGSshouldbeusedtoallowforfutureextensions.
Addedinversion3.8.
vectorcallfuncPyVectorcall_Function(PyObject*op)
Ifopdoesnotsupportthevectorcallprotocol(eitherbecausethetypedoesnotorbecausethespecificinstance
does not), return NULL. Otherwise, return the vectorcall function pointer stored in op. This function never
raisesanexception.
This is mostly useful to check whether or not op supports vectorcall, which can be done by checking
PyVectorcall_Function(op) != NULL.
Addedinversion3.9.
PyObject*PyVectorcall_Call(PyObject*callable,PyObject*tuple,PyObject*dict)
Part of the Stable ABI since version 3.12. Call callable’s vectorcallfunc with positional and keyword
argumentsgiveninatupleanddict,respectively.
This is a specialized function, intended to be put in the tp_call slot or be used in an implementation of
tp_call. ItdoesnotcheckthePy_TPFLAGS_HAVE_VECTORCALLflaganditdoesnotfallbacktotp_call.
Addedinversion3.8.
8.2.3 Object Calling API
VariousfunctionsareavailableforcallingaPythonobject. Eachconvertsitsargumentstoaconventionsupported
bythecalledobject–eithertp_callorvectorcall. Inordertodoaslittleconversionaspossible,pickonethatbestfits
theformatofdatayouhaveavailable.
Thefollowingtablesummarizestheavailablefunctions;pleaseseeindividualdocumentationfordetails.
Function callable args kwargs
PyObject_Call() PyObject * tuple dict/NULL
PyObject_CallNoArgs() PyObject * — —
PyObject_CallOneArg() PyObject * 1object —
PyObject_CallObject() PyObject * tuple/NULL —
PyObject_CallFunction() PyObject * format —
PyObject_CallMethod() obj+char* format —
PyObject_CallFunctionObjArgs() PyObject * variadic —
PyObject_CallMethodObjArgs() obj+name variadic —
PyObject_CallMethodNoArgs() obj+name — —
PyObject_CallMethodOneArg() obj+name 1object —
PyObject_Vectorcall() PyObject * vectorcall vectorcall
PyObject_VectorcallDict() PyObject * vectorcall dict/NULL
PyObject_VectorcallMethod() arg+name vectorcall vectorcall
PyObject*PyObject_Call(PyObject*callable,PyObject*args,PyObject*kwargs)
Returnvalue: Newreference. PartoftheStableABI.CallacallablePythonobjectcallable, witharguments
givenbythetupleargs,andnamedargumentsgivenbythedictionarykwargs.
argsmustnotbeNULL;useanemptytupleifnoargumentsareneeded. Ifnonamedargumentsareneeded,
kwargscanbeNULL.
Returntheresultofthecallonsuccess,orraiseanexceptionandreturnNULLonfailure.
ThisistheequivalentofthePythonexpression: callable(*args, **kwargs).
8.2. CallProtocol 115

| Function | callable | args | kwargs |
| --- | --- | --- | --- |
| PyObject_Call() | PyObject * | tuple | dict/NULL |
| PyObject_CallNoArgs() | PyObject * | — | — |
| PyObject_CallOneArg() | PyObject * | 1object | — |
| PyObject_CallObject() | PyObject * | tuple/NULL | — |
| PyObject_CallFunction() | PyObject * | format | — |
| PyObject_CallMethod() | obj+char* | format | — |
| PyObject_CallFunctionObjArgs() | PyObject * | variadic | — |
| PyObject_CallMethodObjArgs() | obj+name | variadic | — |
| PyObject_CallMethodNoArgs() | obj+name | — | — |
| PyObject_CallMethodOneArg() | obj+name | 1object | — |
| PyObject_Vectorcall() | PyObject * | vectorcall | vectorcall |
| PyObject_VectorcallDict() | PyObject * | vectorcall | dict/NULL |
| PyObject_VectorcallMethod() | arg+name | vectorcall | vectorcall |

### 第124页

PyObject*PyObject_CallNoArgs(PyObject*callable)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.10. CallacallablePythonobjectcallable
withoutanyarguments. ItisthemostefficientwaytocallacallablePythonobjectwithoutanyargument.
Returntheresultofthecallonsuccess,orraiseanexceptionandreturnNULLonfailure.
Addedinversion3.9.
PyObject*PyObject_CallOneArg(PyObject*callable,PyObject*arg)
Returnvalue: Newreference. CallacallablePythonobjectcallablewithexactly1positionalargumentargand
nokeywordarguments.
Returntheresultofthecallonsuccess,orraiseanexceptionandreturnNULLonfailure.
Addedinversion3.9.
PyObject*PyObject_CallObject(PyObject*callable,PyObject*args)
Returnvalue: Newreference. PartoftheStableABI.CallacallablePythonobjectcallable, witharguments
givenbythetupleargs. Ifnoargumentsareneeded,thenargscanbeNULL.
Returntheresultofthecallonsuccess,orraiseanexceptionandreturnNULLonfailure.
ThisistheequivalentofthePythonexpression: callable(*args).
PyObject*PyObject_CallFunction(PyObject*callable,constchar*format,...)
Return value: New reference. Part of the Stable ABI. Call a callable Python object callable, with a variable
numberofCarguments. TheCargumentsaredescribedusingaPy_BuildValue()styleformatstring. The
formatcanbeNULL,indicatingthatnoargumentsareprovided.
Returntheresultofthecallonsuccess,orraiseanexceptionandreturnNULLonfailure.
ThisistheequivalentofthePythonexpression: callable(*args).
NotethatifyouonlypassPyObject*args,PyObject_CallFunctionObjArgs()isafasteralternative.
Changedinversion3.4: Thetypeofformatwaschangedfromchar *.
PyObject*PyObject_CallMethod(PyObject*obj,constchar*name,constchar*format,...)
Returnvalue: Newreference. PartoftheStableABI.Callthemethodnamednameofobjectobjwithavariable
numberofCarguments. TheCargumentsaredescribedbyaPy_BuildValue()formatstringthatshould
produceatuple.
TheformatcanbeNULL,indicatingthatnoargumentsareprovided.
Returntheresultofthecallonsuccess,orraiseanexceptionandreturnNULLonfailure.
ThisistheequivalentofthePythonexpression: obj.name(arg1, arg2, ...).
NotethatifyouonlypassPyObject*args,PyObject_CallMethodObjArgs()isafasteralternative.
Changedinversion3.4: Thetypesofnameandformatwerechangedfromchar *.
PyObject*PyObject_CallFunctionObjArgs(PyObject*callable,...)
Return value: New reference. Part of the Stable ABI. Call a callable Python object callable, with a variable
numberofPyObject*arguments. Theargumentsareprovidedasavariablenumberofparametersfollowed
byNULL.
Returntheresultofthecallonsuccess,orraiseanexceptionandreturnNULLonfailure.
ThisistheequivalentofthePythonexpression: callable(arg1, arg2, ...).
PyObject*PyObject_CallMethodObjArgs(PyObject*obj,PyObject*name,...)
Returnvalue: Newreference. PartoftheStableABI.CallamethodofthePythonobjectobj,wherethename
ofthemethodisgivenasaPythonstringobjectinname. ItiscalledwithavariablenumberofPyObject*
arguments. TheargumentsareprovidedasavariablenumberofparametersfollowedbyNULL.
Returntheresultofthecallonsuccess,orraiseanexceptionandreturnNULLonfailure.
116 Chapter8. AbstractObjectsLayer

### 第125页

PyObject*PyObject_CallMethodNoArgs(PyObject*obj,PyObject*name)
CallamethodofthePythonobjectobjwithoutarguments,wherethenameofthemethodisgivenasaPython
stringobjectinname.
Returntheresultofthecallonsuccess,orraiseanexceptionandreturnNULLonfailure.
Addedinversion3.9.
PyObject*PyObject_CallMethodOneArg(PyObject*obj,PyObject*name,PyObject*arg)
CallamethodofthePythonobjectobjwithasinglepositionalargumentarg,wherethenameofthemethod
isgivenasaPythonstringobjectinname.
Returntheresultofthecallonsuccess,orraiseanexceptionandreturnNULLonfailure.
Addedinversion3.9.
PyObject*PyObject_Vectorcall(PyObject*callable,PyObject*const*args,size_tnargsf,PyObject
*kwnames)
PartoftheStableABIsinceversion3.12. CallacallablePythonobjectcallable. Theargumentsarethesame
as for vectorcallfunc. If callable supports vectorcall, this directly calls the vectorcall function stored in
callable.
Returntheresultofthecallonsuccess,orraiseanexceptionandreturnNULLonfailure.
Addedinversion3.9.
PyObject*PyObject_VectorcallDict(PyObject*callable,PyObject*const*args,size_tnargsf,PyObject
*kwdict)
Callcallablewithpositionalargumentspassedexactlyasinthevectorcallprotocol,butwithkeywordarguments
passedasadictionarykwdict. Theargsarraycontainsonlythepositionalarguments.
Regardlessofwhichprotocolisusedinternally,aconversionofargumentsneedstobedone. Therefore,this
functionshouldonlybeusedifthecalleralreadyhasadictionaryreadytouseforthekeywordarguments,but
notatupleforthepositionalarguments.
Addedinversion3.9.
PyObject*PyObject_VectorcallMethod(PyObject*name,PyObject*const*args,size_tnargsf,PyObject
*kwnames)
Partofthe StableABI sinceversion3.12. Callamethodusingthevectorcallcallingconvention. Thename
ofthemethodisgivenasaPythonstringname. Theobjectwhosemethodiscalledisargs[0], andtheargs
arraystartingatargs[1]representstheargumentsofthecall. Theremustbeatleastonepositionalargument.
nargsfisthenumberofpositionalargumentsincludingargs[0],plusPY_VECTORCALL_ARGUMENTS_OFFSET
if the value of args[0] may temporarily be changed. Keyword arguments can be passed just like in
PyObject_Vectorcall().
IftheobjecthasthePy_TPFLAGS_METHOD_DESCRIPTORfeature,thiswillcalltheunboundmethodobject
withthefullargsvectorasarguments.
Returntheresultofthecallonsuccess,orraiseanexceptionandreturnNULLonfailure.
Addedinversion3.9.
8.2.4 Call Support API
intPyCallable_Check(PyObject*o)
PartoftheStableABI.Determineiftheobjectoiscallable. Return1iftheobjectiscallableand0otherwise.
Thisfunctionalwayssucceeds.
8.2. CallProtocol 117

### 第126页

8.3 Number Protocol
intPyNumber_Check(PyObject*o)
PartoftheStableABI.Returns1iftheobjectoprovidesnumericprotocols,andfalseotherwise. Thisfunction
alwayssucceeds.
Changedinversion3.8: Returns1ifoisanindexinteger.
PyObject*PyNumber_Add(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnstheresultofaddingo1ando2,orNULLonfailure.
ThisistheequivalentofthePythonexpressiono1 + o2.
PyObject*PyNumber_Subtract(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnstheresultofsubtractingo2fromo1,orNULLon
failure. ThisistheequivalentofthePythonexpressiono1 - o2.
PyObject*PyNumber_Multiply(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnstheresultofmultiplyingo1ando2,orNULLon
failure. ThisistheequivalentofthePythonexpressiono1 * o2.
PyObject*PyNumber_MatrixMultiply(PyObject*o1,PyObject*o2)
Returnvalue:Newreference. PartoftheStableABIsinceversion3.7. Returnstheresultofmatrixmultiplication
ono1ando2,orNULLonfailure. ThisistheequivalentofthePythonexpressiono1 @ o2.
Addedinversion3.5.
PyObject*PyNumber_FloorDivide(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnthefloorofo1dividedbyo2,orNULLonfailure.
ThisistheequivalentofthePythonexpressiono1 // o2.
PyObject*PyNumber_TrueDivide(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnareasonableapproximationforthemathematical
valueofo1dividedbyo2,orNULLonfailure. Thereturnvalueis“approximate”becausebinaryfloating-point
numbersareapproximate;itisnotpossibletorepresentallrealnumbersinbasetwo. Thisfunctioncanreturn
afloating-pointvaluewhenpassedtwointegers. ThisistheequivalentofthePythonexpressiono1 / o2.
PyObject*PyNumber_Remainder(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnstheremainderofdividingo1byo2,orNULLon
failure. ThisistheequivalentofthePythonexpressiono1 % o2.
PyObject*PyNumber_Divmod(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Seethebuilt-infunctiondivmod(). ReturnsNULLon
failure. ThisistheequivalentofthePythonexpressiondivmod(o1, o2).
PyObject*PyNumber_Power(PyObject*o1,PyObject*o2,PyObject*o3)
Return value: New reference. Part of the Stable ABI. See the built-in function pow(). Returns NULL on
failure. ThisistheequivalentofthePythonexpressionpow(o1, o2, o3),whereo3isoptional. Ifo3isto
beignored,passPy_Noneinitsplace(passingNULLforo3wouldcauseanillegalmemoryaccess).
PyObject*PyNumber_Negative(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.Returnsthenegationofoonsuccess,orNULLonfailure.
ThisistheequivalentofthePythonexpression-o.
PyObject*PyNumber_Positive(PyObject*o)
Return value: New reference. Part of the Stable ABI. Returns o on success, or NULL on failure. This is the
equivalentofthePythonexpression+o.
PyObject*PyNumber_Absolute(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.Returnstheabsolutevalueofo,orNULLonfailure. This
istheequivalentofthePythonexpressionabs(o).
118 Chapter8. AbstractObjectsLayer

### 第127页

PyObject*PyNumber_Invert(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.Returnsthebitwisenegationofoonsuccess,orNULLon
failure. ThisistheequivalentofthePythonexpression~o.
PyObject*PyNumber_Lshift(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnstheresultofleftshiftingo1byo2onsuccess,or
NULLonfailure. ThisistheequivalentofthePythonexpressiono1 << o2.
PyObject*PyNumber_Rshift(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnstheresultofrightshiftingo1byo2onsuccess,
orNULLonfailure. ThisistheequivalentofthePythonexpressiono1 >> o2.
PyObject*PyNumber_And(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnsthe“bitwiseand”ofo1ando2onsuccessand
NULLonfailure. ThisistheequivalentofthePythonexpressiono1 & o2.
PyObject*PyNumber_Xor(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnsthe“bitwiseexclusiveor”ofo1byo2onsuccess,
orNULLonfailure. ThisistheequivalentofthePythonexpressiono1 ^ o2.
PyObject*PyNumber_Or(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnsthe“bitwiseor”ofo1ando2onsuccess,orNULL
onfailure. ThisistheequivalentofthePythonexpressiono1 | o2.
PyObject*PyNumber_InPlaceAdd(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnstheresultofaddingo1ando2,orNULLonfailure.
Theoperationisdonein-placewheno1supportsit. ThisistheequivalentofthePythonstatemento1 += o2.
PyObject*PyNumber_InPlaceSubtract(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnstheresultofsubtractingo2fromo1,orNULLon
failure. Theoperationisdonein-placewheno1supportsit. ThisistheequivalentofthePythonstatemento1
-= o2.
PyObject*PyNumber_InPlaceMultiply(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnstheresultofmultiplyingo1ando2,orNULLon
failure. Theoperationisdonein-placewheno1supportsit. ThisistheequivalentofthePythonstatemento1
*= o2.
PyObject*PyNumber_InPlaceMatrixMultiply(PyObject*o1,PyObject*o2)
Returnvalue:Newreference. PartoftheStableABIsinceversion3.7. Returnstheresultofmatrixmultiplication
ono1ando2,orNULLonfailure. Theoperationisdonein-placewheno1supportsit. Thisistheequivalent
ofthePythonstatemento1 @= o2.
Addedinversion3.5.
PyObject*PyNumber_InPlaceFloorDivide(PyObject*o1,PyObject*o2)
Return value: New reference. Part of the Stable ABI. Returns the mathematical floor of dividing o1 by o2,
orNULLonfailure. Theoperationisdonein-placewheno1supportsit. ThisistheequivalentofthePython
statemento1 //= o2.
PyObject*PyNumber_InPlaceTrueDivide(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnareasonableapproximationforthemathematical
valueofo1dividedbyo2,orNULLonfailure. Thereturnvalueis“approximate”becausebinaryfloating-point
numbersareapproximate;itisnotpossibletorepresentallrealnumbersinbasetwo. Thisfunctioncanreturn
afloating-pointvaluewhenpassedtwointegers. Theoperationisdonein-placewheno1supportsit. Thisis
theequivalentofthePythonstatemento1 /= o2.
PyObject*PyNumber_InPlaceRemainder(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnstheremainderofdividingo1byo2,orNULLon
failure. Theoperationisdonein-placewheno1supportsit. ThisistheequivalentofthePythonstatemento1
%= o2.
8.3. NumberProtocol 119

### 第128页

PyObject*PyNumber_InPlacePower(PyObject*o1,PyObject*o2,PyObject*o3)
Returnvalue: Newreference. PartoftheStableABI.Seethebuilt-infunctionpow(). ReturnsNULLonfailure.
Theoperationisdonein-placewheno1supportsit. ThisistheequivalentofthePythonstatemento1 **=
o2wheno3isPy_None,oranin-placevariantofpow(o1, o2, o3)otherwise. Ifo3istobeignored,pass
Py_Noneinitsplace(passingNULLforo3wouldcauseanillegalmemoryaccess).
PyObject*PyNumber_InPlaceLshift(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnstheresultofleftshiftingo1byo2onsuccess,
orNULLonfailure. Theoperationisdonein-placewheno1supportsit. ThisistheequivalentofthePython
statemento1 <<= o2.
PyObject*PyNumber_InPlaceRshift(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnstheresultofrightshiftingo1byo2onsuccess,
orNULLonfailure. Theoperationisdonein-placewheno1supportsit. ThisistheequivalentofthePython
statemento1 >>= o2.
PyObject*PyNumber_InPlaceAnd(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnsthe“bitwiseand”ofo1ando2onsuccessand
NULL on failure. The operation is done in-place when o1 supports it. This is the equivalent of the Python
statemento1 &= o2.
PyObject*PyNumber_InPlaceXor(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnsthe“bitwiseexclusiveor”ofo1byo2onsuccess,
orNULLonfailure. Theoperationisdonein-placewheno1supportsit. ThisistheequivalentofthePython
statemento1 ^= o2.
PyObject*PyNumber_InPlaceOr(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returnsthe“bitwiseor”ofo1ando2onsuccess,orNULL
onfailure. Theoperationisdonein-placewheno1supportsit. ThisistheequivalentofthePythonstatement
o1 |= o2.
PyObject*PyNumber_Long(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.Returnstheoconvertedtoanintegerobjectonsuccess,
orNULLonfailure. ThisistheequivalentofthePythonexpressionint(o).
PyObject*PyNumber_Float(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.Returnstheoconvertedtoafloatobjectonsuccess,or
NULLonfailure. ThisistheequivalentofthePythonexpressionfloat(o).
PyObject*PyNumber_Index(PyObject*o)
Return value: New reference. Part of the Stable ABI. Returns the o converted to a Python int on success or
NULLwithaTypeErrorexceptionraisedonfailure.
Changed in version 3.10: The result always has exact type int. Previously, the result could have been an
instanceofasubclassofint.
PyObject*PyNumber_ToBase(PyObject*n,intbase)
Returnvalue: Newreference. PartoftheStableABI.Returnstheintegernconvertedtobasebaseasastring.
Thebaseargumentmustbeoneof2,8,10,or16. Forbase2,8,or16,thereturnedstringisprefixedwithabase
markerof'0b','0o',or'0x',respectively. IfnisnotaPythonint,itisconvertedwithPyNumber_Index()
first.
Py_ssize_tPyNumber_AsSsize_t(PyObject*o,PyObject*exc)
PartoftheStableABI.ReturnsoconvertedtoaPy_ssize_tvalueifocanbeinterpretedasaninteger. If
thecallfails,anexceptionisraisedand-1isreturned.
If o can be converted to a Python int but the attempt to convert to a Py_ssize_t value would raise an
OverflowError,thentheexcargumentisthetypeofexceptionthatwillberaised(usuallyIndexErroror
OverflowError). IfexcisNULL,thentheexceptionisclearedandthevalueisclippedtoPY_SSIZE_T_MIN
foranegativeintegerorPY_SSIZE_T_MAXforapositiveinteger.
120 Chapter8. AbstractObjectsLayer

### 第129页

intPyIndex_Check(PyObject*o)
Part of the Stable ABI since version 3.8. Returns 1 if o is an index integer (has the nb_index slot of the
tp_as_numberstructurefilledin),and0otherwise. Thisfunctionalwayssucceeds.
8.4 Sequence Protocol
intPySequence_Check(PyObject*o)
PartoftheStableABI.Return1iftheobjectprovidesthesequenceprotocol,and0otherwise. Notethatit
returns1forPythonclasseswitha__getitem__()method,unlesstheyaredictsubclasses,sinceingeneral
itisimpossibletodeterminewhattypeofkeystheclasssupports. Thisfunctionalwayssucceeds.
Py_ssize_tPySequence_Size(PyObject*o)
Py_ssize_tPySequence_Length(PyObject*o)
Part of the Stable ABI. Returns the number of objects in sequence o on success, and -1 on failure. This is
equivalenttothePythonexpressionlen(o).
PyObject*PySequence_Concat(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returntheconcatenationofo1ando2onsuccess,and
NULLonfailure. ThisistheequivalentofthePythonexpressiono1 + o2.
PyObject*PySequence_Repeat(PyObject*o,Py_ssize_tcount)
Returnvalue: Newreference. PartoftheStableABI.Returntheresultofrepeatingsequenceobjectocount
times,orNULLonfailure. ThisistheequivalentofthePythonexpressiono * count.
PyObject*PySequence_InPlaceConcat(PyObject*o1,PyObject*o2)
Returnvalue: Newreference. PartoftheStableABI.Returntheconcatenationofo1ando2onsuccess,and
NULL on failure. The operation is done in-place when o1 supports it. This is the equivalent of the Python
expressiono1 += o2.
PyObject*PySequence_InPlaceRepeat(PyObject*o,Py_ssize_tcount)
Returnvalue: Newreference. PartoftheStableABI.Returntheresultofrepeatingsequenceobjectocount
times, or NULL on failure. The operation is done in-place when o supports it. This is the equivalent of the
Pythonexpressiono *= count.
PyObject*PySequence_GetItem(PyObject*o,Py_ssize_ti)
Returnvalue: Newreference. PartoftheStableABI.Returntheithelementofo,orNULLonfailure. Thisis
theequivalentofthePythonexpressiono[i].
PyObject*PySequence_GetSlice(PyObject*o,Py_ssize_ti1,Py_ssize_ti2)
Returnvalue: Newreference. PartoftheStableABI.Returnthesliceofsequenceobjectobetweeni1andi2,
orNULLonfailure. ThisistheequivalentofthePythonexpressiono[i1:i2].
intPySequence_SetItem(PyObject*o,Py_ssize_ti,PyObject*v)
PartoftheStableABI.Assignobjectvtotheithelementofo. Raiseanexceptionandreturn-1onfailure;
return0onsuccess. ThisistheequivalentofthePythonstatemento[i] = v. Thisfunctiondoesnotsteala
referencetov.
IfvisNULL,theelementisdeleted,butthisfeatureisdeprecatedinfavourofusingPySequence_DelItem().
intPySequence_DelItem(PyObject*o,Py_ssize_ti)
PartoftheStableABI.Deletetheithelementofobjecto. Returns-1onfailure. Thisistheequivalentofthe
Pythonstatementdel o[i].
intPySequence_SetSlice(PyObject*o,Py_ssize_ti1,Py_ssize_ti2,PyObject*v)
PartoftheStableABI.Assignthesequenceobjectvtothesliceinsequenceobjectofromi1toi2. Thisisthe
equivalentofthePythonstatemento[i1:i2] = v.
intPySequence_DelSlice(PyObject*o,Py_ssize_ti1,Py_ssize_ti2)
PartoftheStableABI.Deletethesliceinsequenceobjectofromi1toi2. Returns-1onfailure. Thisisthe
equivalentofthePythonstatementdel o[i1:i2].
8.4. SequenceProtocol 121

### 第130页

Py_ssize_tPySequence_Count(PyObject*o,PyObject*value)
Part of the Stable ABI. Return the number of occurrences of value in o, that is, return the number of
keys for which o[key] == value. On failure, return -1. This is equivalent to the Python expression o.
count(value).
intPySequence_Contains(PyObject*o,PyObject*value)
PartoftheStableABI.Determineifocontainsvalue. Ifaniteminoisequaltovalue, return1, otherwise
return0. Onerror,return-1. ThisisequivalenttothePythonexpressionvalue in o.
intPySequence_In(PyObject*o,PyObject*value)
PartoftheStableABI.AliasforPySequence_Contains().
Deprecatedsinceversion3.14: Thefunctionissoftdeprecatedandshouldnolongerbeusedtowritenewcode.
Py_ssize_tPySequence_Index(PyObject*o,PyObject*value)
Part of the Stable ABI. Return the first index i for which o[i] == value. On error, return -1. This is
equivalenttothePythonexpressiono.index(value).
PyObject*PySequence_List(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.Returnalistobjectwiththesamecontentsasthesequence
oriterableo,orNULLonfailure. Thereturnedlistisguaranteedtobenew. ThisisequivalenttothePython
expressionlist(o).
PyObject*PySequence_Tuple(PyObject*o)
Return value: New reference. Part of the Stable ABI. Return a tuple object with the same contents as the
sequenceoriterableo,orNULLonfailure. Ifoisatuple,anewreferencewillbereturned,otherwiseatuple
willbeconstructedwiththeappropriatecontents. ThisisequivalenttothePythonexpressiontuple(o).
PyObject*PySequence_Fast(PyObject*o,constchar*m)
Returnvalue:Newreference. PartoftheStableABI.Returnthesequenceoriterableoasanobjectusablebythe
otherPySequence_Fast*familyoffunctions. Iftheobjectisnotasequenceoriterable,raisesTypeError
withmasthemessagetext. ReturnsNULLonfailure.
The PySequence_Fast* functions are thus named because they assume o is a PyTupleObject or a
PyListObjectandaccessthedatafieldsofodirectly.
AsaCPythonimplementationdetail,ifoisalreadyasequenceorlist,itwillbereturned.
Py_ssize_tPySequence_Fast_GET_SIZE(PyObject*o)
Returnsthelengthofo,assumingthatowasreturnedbyPySequence_Fast()andthatoisnotNULL.The
sizecanalsoberetrievedbycallingPySequence_Size()ono, butPySequence_Fast_GET_SIZE()is
fasterbecauseitcanassumeoisalistortuple.
PyObject*PySequence_Fast_GET_ITEM(PyObject*o,Py_ssize_ti)
Return value: Borrowed reference. Return the ith element of o, assuming that o was returned by
PySequence_Fast(),oisnotNULL,andthatiiswithinbounds.
PyObject**PySequence_Fast_ITEMS(PyObject*o)
ReturntheunderlyingarrayofPyObjectpointers. AssumesthatowasreturnedbyPySequence_Fast()and
oisnotNULL.
Note, if a list gets resized, the reallocation may relocate the items array. So, only use the underlying array
pointerincontextswherethesequencecannotchange.
PyObject*PySequence_ITEM(PyObject*o,Py_ssize_ti)
Return value: New reference. Return the ith element of o or NULL on failure. Faster form of
PySequence_GetItem() but without checking that PySequence_Check() on o is true and without ad-
justmentfornegativeindices.
122 Chapter8. AbstractObjectsLayer

### 第131页

8.5 Mapping Protocol
SeealsoPyObject_GetItem(),PyObject_SetItem()andPyObject_DelItem().
intPyMapping_Check(PyObject*o)
PartoftheStableABI.Return1iftheobjectprovidesthemappingprotocolorsupportsslicing,and0otherwise.
Notethatitreturns1forPythonclasseswitha__getitem__()method,sinceingeneralitisimpossibleto
determinewhattypeofkeystheclasssupports. Thisfunctionalwayssucceeds.
Py_ssize_tPyMapping_Size(PyObject*o)
Py_ssize_tPyMapping_Length(PyObject*o)
PartoftheStableABI.Returnsthenumberofkeysinobjectoonsuccess,and-1onfailure. Thisisequivalent
tothePythonexpressionlen(o).
PyObject*PyMapping_GetItemString(PyObject*o,constchar*key)
Returnvalue: Newreference. PartoftheStableABI.ThisisthesameasPyObject_GetItem(),butkeyis
specifiedasaconst char*UTF-8encodedbytesstring,ratherthanaPyObject*.
intPyMapping_GetOptionalItem(PyObject*obj,PyObject*key,PyObject**result)
PartoftheStableABIsinceversion3.13. VariantofPyObject_GetItem()whichdoesn’traiseKeyError
ifthekeyisnotfound.
Ifthekeyisfound,return1andset*result toanewstrongreferencetothecorrespondingvalue. Ifthekeyis
not found, return 0 and set *result to NULL; the KeyError is silenced. If an error other than KeyError is
raised,return-1andset*resulttoNULL.
Addedinversion3.13.
intPyMapping_GetOptionalItemString(PyObject*obj,constchar*key,PyObject**result)
PartoftheStableABIsinceversion3.13. ThisisthesameasPyMapping_GetOptionalItem(),butkeyis
specifiedasaconst char*UTF-8encodedbytesstring,ratherthanaPyObject*.
Addedinversion3.13.
intPyMapping_SetItemString(PyObject*o,constchar*key,PyObject*v)
PartoftheStableABI.ThisisthesameasPyObject_SetItem(),butkeyisspecifiedasaconst char*
UTF-8encodedbytesstring,ratherthanaPyObject*.
intPyMapping_DelItem(PyObject*o,PyObject*key)
ThisisanaliasofPyObject_DelItem().
intPyMapping_DelItemString(PyObject*o,constchar*key)
This isthesameas PyObject_DelItem(), but key is specifiedas a const char* UTF-8 encodedbytes
string,ratherthanaPyObject*.
intPyMapping_HasKeyWithError(PyObject*o,PyObject*key)
Part of the Stable ABI since version 3.13. Return 1 if the mapping object has the key key and 0 otherwise.
ThisisequivalenttothePythonexpressionkey in o. Onfailure,return-1.
Addedinversion3.13.
intPyMapping_HasKeyStringWithError(PyObject*o,constchar*key)
PartoftheStableABIsinceversion3.13. ThisisthesameasPyMapping_HasKeyWithError(),butkeyis
specifiedasaconst char*UTF-8encodedbytesstring,ratherthanaPyObject*.
Addedinversion3.13.
intPyMapping_HasKey(PyObject*o,PyObject*key)
PartoftheStableABI.Return1ifthemappingobjecthasthekeykeyand0otherwise. Thisisequivalentto
thePythonexpressionkey in o. Thisfunctionalwayssucceeds.
8.5. MappingProtocol 123

### 第132页

(cid:174) Note
Exceptions which occur when this calls __getitem__() method are silently ignored. For
propererrorhandling,usePyMapping_HasKeyWithError(),PyMapping_GetOptionalItem()or
PyObject_GetItem()instead.
intPyMapping_HasKeyString(PyObject*o,constchar*key)
PartoftheStableABI.ThisisthesameasPyMapping_HasKey(),butkeyisspecifiedasaconst char*
UTF-8encodedbytesstring,ratherthanaPyObject*.
(cid:174) Note
Exceptionsthatoccurwhenthiscalls__getitem__()methodorwhilecreatingthetemporarystrob-
ject are silently ignored. For proper error handling, use PyMapping_HasKeyStringWithError(),
PyMapping_GetOptionalItemString()orPyMapping_GetItemString()instead.
PyObject*PyMapping_Keys(PyObject*o)
Return value: New reference. Part of the Stable ABI. On success, return a list of the keys in object o. On
failure,returnNULL.
Changedinversion3.7: Previously,thefunctionreturnedalistoratuple.
PyObject*PyMapping_Values(PyObject*o)
Returnvalue: Newreference. Partofthe StableABI. Onsuccess, returnalistofthevaluesinobject o. On
failure,returnNULL.
Changedinversion3.7: Previously,thefunctionreturnedalistoratuple.
PyObject*PyMapping_Items(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.Onsuccess,returnalistoftheitemsinobjecto,where
eachitemisatuplecontainingakey-valuepair. Onfailure,returnNULL.
Changedinversion3.7: Previously,thefunctionreturnedalistoratuple.
8.6 Iterator Protocol
Therearetwofunctionsspecificallyforworkingwithiterators.
intPyIter_Check(PyObject*o)
Part of the Stable ABI since version 3.8. Return non-zero if the object o can be safely passed to
PyIter_NextItem()and0otherwise. Thisfunctionalwayssucceeds.
intPyAIter_Check(PyObject*o)
Part of the Stable ABI since version 3.10. Return non-zero if the object o provides the AsyncIterator
protocol,and0otherwise. Thisfunctionalwayssucceeds.
Addedinversion3.10.
intPyIter_NextItem(PyObject*iter,PyObject**item)
PartoftheStableABIsinceversion3.14. Return1andsetitemtoastrongreferenceofthenextvalueofthe
iteratoriteronsuccess. Return0andsetitemtoNULLiftherearenoremainingvalues. Return-1,setitemto
NULLandsetanexceptiononerror.
Addedinversion3.14.
PyObject*PyIter_Next(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.ThisisanolderversionofPyIter_NextItem(),which
isretainedforbackwardscompatibility. PreferPyIter_NextItem().
124 Chapter8. AbstractObjectsLayer

### 第133页

Returnthenextvaluefromtheiteratoro. TheobjectmustbeaniteratoraccordingtoPyIter_Check()(it
isuptothecallertocheckthis). Iftherearenoremainingvalues,returnsNULLwithnoexceptionset. Ifan
erroroccurswhileretrievingtheitem,returnsNULLandpassesalongtheexception.
typePySendResult
TheenumvalueusedtorepresentdifferentresultsofPyIter_Send().
Addedinversion3.10.
PySendResultPyIter_Send(PyObject*iter,PyObject*arg,PyObject**presult)
PartoftheStableABIsinceversion3.10. Sendstheargvalueintotheiteratoriter. Returns:
• PYGEN_RETURNifiteratorreturns. Returnvalueisreturnedviapresult.
• PYGEN_NEXTifiteratoryields. Yieldedvalueisreturnedviapresult.
• PYGEN_ERRORifiteratorhasraisedandexception. presultissettoNULL.
Addedinversion3.10.
8.7 Buffer Protocol
CertainobjectsavailableinPythonwrapaccesstoanunderlyingmemoryarrayorbuffer. Suchobjectsincludethe
built-in bytes and bytearray, and some extension types like array.array. Third-party libraries may define
theirowntypesforspecialpurposes,suchasimageprocessingornumericanalysis.
While each of these types have their own semantics, they share the common characteristic of being backed by a
possibly large memory buffer. It is then desirable, in some situations, to access that buffer directly and without
intermediatecopying.
PythonprovidessuchafacilityattheCandPythonlevelintheformofthebufferprotocol. Thisprotocolhastwo
sides:
• on the producer side, a type can export a “buffer interface” which allows objects of that type to expose in-
formationabouttheirunderlyingbuffer. ThisinterfaceisdescribedinthesectionBufferObjectStructures;for
Pythonseepython-buffer-protocol.
• ontheconsumerside,severalmeansareavailabletoobtainapointertotherawunderlyingdataofanobject
(forexampleamethodparameter). ForPythonseememoryview.
Simpleobjectssuchasbytesandbytearrayexposetheirunderlyingbufferinbyte-orientedform. Otherforms
arepossible;forexample,theelementsexposedbyanarray.arraycanbemulti-bytevalues.
An example consumer of the bufferinterface is the write() method of file objects: any object thatcan export a
seriesofbytesthroughthebufferinterfacecanbewrittentoafile. Whilewrite()onlyneedsread-onlyaccesstothe
internalcontentsoftheobjectpassedtoit,othermethodssuchasreadinto()needwriteaccesstothecontentsof
theirargument. Thebufferinterfaceallowsobjectstoselectivelyalloworrejectexportingofread-writeandread-only
buffers.
Therearetwowaysforaconsumerofthebufferinterfacetoacquireabufferoveratargetobject:
• callPyObject_GetBuffer()withtherightparameters;
• callPyArg_ParseTuple()(oroneofitssiblings)withoneofthey*,w*ors*formatcodes.
Inbothcases,PyBuffer_Release()mustbecalledwhenthebufferisn’tneededanymore. Failuretodosocould
leadtovariousissuessuchasresourceleaks.
Addedinversion3.12:ThebufferprotocolisnowaccessibleinPython,seepython-buffer-protocolandmemoryview.
8.7.1 Buffer structure
Bufferstructures(orsimply“buffers”)areusefulasawaytoexposethebinarydatafromanotherobjecttothePython
programmer. Theycanalsobeusedasazero-copyslicingmechanism. Usingtheirabilitytoreferenceablockof
memory, it is possible to expose any data to the Python programmer quite easily. The memory could be a large,
8.7. BufferProtocol 125

### 第134页

constantarrayinaCextension,itcouldbearawblockofmemoryformanipulationbeforepassingtoanoperating
systemlibrary,oritcouldbeusedtopassaroundstructureddatainitsnative,in-memoryformat.
ContrarytomostdatatypesexposedbythePythoninterpreter,buffersarenotPyObjectpointersbutrathersimple
C structures. This allows them to be created and copied very simply. When a generic wrapper around a buffer is
needed,amemoryviewobjectcanbecreated.
For short instructions how to write an exporting object, see Buffer Object Structures. For obtaining a buffer, see
PyObject_GetBuffer().
typePy_buffer
PartoftheStableABI(includingallmembers)sinceversion3.11.
void*buf
A pointer to the start of the logical structure described by the buffer fields. This can be any location
withintheunderlyingphysicalmemoryblockoftheexporter. Forexample,withnegativestridesthe
valuemaypointtotheendofthememoryblock.
Forcontiguousarrays,thevaluepointstothebeginningofthememoryblock.
PyObject*obj
A new reference to the exporting object. The reference is owned by the consumer and automatically
released(i.e. referencecountdecremented)andsettoNULLbyPyBuffer_Release(). Thefieldisthe
equivalentofthereturnvalueofanystandardC-APIfunction.
As a special case, for temporary buffers that are wrapped by PyMemoryView_FromBuffer() or
PyBuffer_FillInfo()thisfieldisNULL.Ingeneral,exportingobjectsMUSTNOTusethisscheme.
Py_ssize_tlen
product(shape) * itemsize. Forcontiguousarrays, thisisthelengthoftheunderlyingmemory
block. Fornon-contiguousarrays,itisthelengththatthelogicalstructurewouldhaveifitwerecopied
toacontiguousrepresentation.
Accessing((char *)buf)[0] up to ((char *)buf)[len-1]isonlyvalidifthebufferhasbeen
obtainedbyarequestthatguaranteescontiguity. InmostcasessucharequestwillbePyBUF_SIMPLE
orPyBUF_WRITABLE.
intreadonly
Anindicatorofwhetherthebufferisread-only. ThisfieldiscontrolledbythePyBUF_WRITABLEflag.
Py_ssize_titemsize
Itemsizeinbytesofasingleelement. Sameasthevalueofstruct.calcsize()calledonnon-NULL
formatvalues.
Importantexception: IfaconsumerrequestsabufferwithoutthePyBUF_FORMAT flag,formatwillbe
settoNULL,butitemsizestillhasthevaluefortheoriginalformat.
Ifshapeispresent,theequalityproduct(shape) * itemsize == lenstillholdsandtheconsumer
canuseitemsizetonavigatethebuffer.
IfshapeisNULLasaresultofaPyBUF_SIMPLEoraPyBUF_WRITABLErequest,theconsumermust
disregarditemsizeandassumeitemsize == 1.
char*format
ANULLterminatedstringinstructmodulestylesyntaxdescribingthecontentsofasingleitem. If
thisisNULL,"B"(unsignedbytes)isassumed.
ThisfieldiscontrolledbythePyBUF_FORMATflag.
intndim
Thenumberofdimensionsthememoryrepresentsasann-dimensionalarray. Ifitis0,buf pointstoa
singleitemrepresentingascalar. Inthiscase,shape,stridesandsuboffsetsMUSTbeNULL.The
maximumnumberofdimensionsisgivenbyPyBUF_MAX_NDIM.
126 Chapter8. AbstractObjectsLayer

### 第135页

Py_ssize_t*shape
AnarrayofPy_ssize_toflengthndimindicatingtheshapeofthememoryasann-dimensionalarray.
Notethatshape[0] * ... * shape[ndim-1] * itemsizeMUSTbeequaltolen.
Shapevaluesarerestrictedtoshape[n] >= 0. Thecaseshape[n] == 0requiresspecialattention.
Seecomplexarraysforfurtherinformation.
Theshapearrayisread-onlyfortheconsumer.
Py_ssize_t*strides
AnarrayofPy_ssize_toflengthndimgivingthenumberofbytestoskiptogettoanewelementin
eachdimension.
Stridevaluescanbeanyinteger. Forregulararrays,stridesareusuallypositive,butaconsumerMUST
beabletohandlethecasestrides[n] <= 0. Seecomplexarraysforfurtherinformation.
Thestridesarrayisread-onlyfortheconsumer.
Py_ssize_t*suboffsets
AnarrayofPy_ssize_toflengthndim. Ifsuboffsets[n] >= 0,thevaluesstoredalongthenth
dimensionarepointersandthesuboffsetvaluedictateshowmanybytestoaddtoeachpointerafterde-
referencing. Asuboffsetvaluethatisnegativeindicatesthatnode-referencingshouldoccur(stridingin
acontiguousmemoryblock).
Ifallsuboffsetsarenegative(i.e. node-referencingisneeded),thenthisfieldmustbeNULL(thedefault
value).
ThistypeofarrayrepresentationisusedbythePythonImagingLibrary(PIL).Seecomplexarraysfor
furtherinformationhowtoaccesselementsofsuchanarray.
Thesuboffsetsarrayisread-onlyfortheconsumer.
void*internal
Thisisforuseinternallybytheexportingobject. Forexample,thismightbere-castasanintegerbythe
exporter and used to store flags about whether or not the shape, strides, and suboffsets arrays must be
freedwhenthebufferisreleased. TheconsumerMUSTNOTalterthisvalue.
Constants:
PyBUF_MAX_NDIM
Themaximumnumberofdimensionsthememoryrepresents. ExportersMUSTrespectthislimit,consumers
ofmulti-dimensionalbuffersSHOULDbeabletohandleuptoPyBUF_MAX_NDIMdimensions. Currentlyset
to64.
8.7.2 Buffer request types
BuffersareusuallyobtainedbysendingabufferrequesttoanexportingobjectviaPyObject_GetBuffer(). Since
thecomplexityofthelogicalstructureofthememorycanvarydrastically,theconsumerusestheflagsargumentto
specifytheexactbuffertypeitcanhandle.
AllPy_bufferfieldsareunambiguouslydefinedbytherequesttype.
request-independentfields
Thefollowingfieldsarenotinfluencedbyflagsandmustalwaysbefilledinwiththecorrectvalues: obj,buf,len,
itemsize,ndim.
readonly,format
PyBUF_WRITABLE
Controlsthereadonly field. Ifset,theexporterMUSTprovideawritablebufferorelsereport
failure. Otherwise,theexporterMAYprovideeitheraread-onlyorwritablebuffer,butthechoice
MUSTbeconsistentforallconsumers. Forexample,PyBUF_SIMPLE | PyBUF_WRITABLEcan
beusedtorequestasimplewritablebuffer.
8.7. BufferProtocol 127

### 第136页

PyBUF_FORMAT
Controls the format field. If set, this field MUST be filled in correctly. Otherwise, this field
MUSTbeNULL.
PyBUF_WRITABLE can be |’d to any of the flags in the next section. Since PyBUF_SIMPLE is defined as 0,
PyBUF_WRITABLEcanbeusedasastand-aloneflagtorequestasimplewritablebuffer.
PyBUF_FORMAT mustbe|’dtoanyoftheflagsexceptPyBUF_SIMPLE,becausethelatteralreadyimpliesformatB
(unsignedbytes). PyBUF_FORMATcannotbeusedonitsown.
shape,strides,suboffsets
Theflagsthatcontrolthelogicalstructureofthememoryarelistedindecreasingorderofcomplexity. Notethateach
flagcontainsallbitsoftheflagsbelowit.
Request shape strides suboffsets
yes yes ifneeded
PyBUF_INDIRECT
yes yes NULL
PyBUF_STRIDES
yes NULL NULL
PyBUF_ND
NULL NULL NULL
PyBUF_SIMPLE
contiguityrequests
CorFortrancontiguitycanbeexplicitlyrequested,withandwithoutstrideinformation. Withoutstrideinformation,
thebuffermustbeC-contiguous.
Request shape strides suboffsets contig
yes yes NULL C
PyBUF_C_CONTIGUOUS
yes yes NULL F
PyBUF_F_CONTIGUOUS
yes yes NULL CorF
PyBUF_ANY_CONTIGUOUS
PyBUF_ND yes NULL NULL C
compoundrequests
Allpossiblerequestsarefullydefinedbysomecombinationoftheflagsintheprevioussection. Forconvenience,the
bufferprotocolprovidesfrequentlyusedcombinationsassingleflags.
In the following table U stands for undefined contiguity. The consumer would have to call
PyBuffer_IsContiguous()todeterminecontiguity.
128 Chapter8. AbstractObjectsLayer

| Request | shape | strides | suboffsets |
| --- | --- | --- | --- |
| PyBUF_INDIRECT | yes | yes | ifneeded |
| PyBUF_STRIDES | yes | yes | NULL |
| PyBUF_ND | yes | NULL | NULL |
| PyBUF_SIMPLE | NULL | NULL | NULL |


| Request | shape | strides | suboffsets | contig |
| --- | --- | --- | --- | --- |
| PyBUF_C_CONTIGUOUS | yes | yes | NULL | C |
| PyBUF_F_CONTIGUOUS | yes | yes | NULL | F |
| PyBUF_ANY_CONTIGUOUS | yes | yes | NULL | CorF |
| PyBUF_ND | yes | NULL | NULL | C |

### 第137页

Request shape strides suboffsets contig readonly format
yes yes ifneeded U 0 yes
PyBUF_FULL
yes yes ifneeded U 1or0 yes
PyBUF_FULL_RO
yes yes NULL U 0 yes
PyBUF_RECORDS
yes yes NULL U 1or0 yes
PyBUF_RECORDS_RO
yes yes NULL U 0 NULL
PyBUF_STRIDED
yes yes NULL U 1or0 NULL
PyBUF_STRIDED_RO
yes NULL NULL C 0 NULL
PyBUF_CONTIG
yes NULL NULL C 1or0 NULL
PyBUF_CONTIG_RO
8.7.3 Complex arrays
NumPy-style: shapeandstrides
ThelogicalstructureofNumPy-stylearraysisdefinedbyitemsize,ndim,shapeandstrides.
If ndim == 0, thememorylocationpointedtobybuf isinterpretedasa scalarofsizeitemsize. Inthatcase,
bothshapeandstridesareNULL.
If strides is NULL, the array is interpreted as a standard n-dimensional C-array. Otherwise, the consumer must
accessann-dimensionalarrayasfollows:
ptr = (char *)buf + indices[0] * strides[0] + ... + indices[n-1] * strides[n-1];
item = *((typeof(item) *)ptr);
Asnotedabove,buf canpointtoanylocationwithintheactualmemoryblock. Anexportercancheckthevalidity
ofabufferwiththisfunction:
def verify_structure(memlen, itemsize, ndim, shape, strides, offset):
"""Verify that the parameters represent a valid array within
the bounds of the allocated memory:
char *mem: start of the physical memory block
memlen: length of the physical memory block
offset: (char *)buf - mem
"""
if offset % itemsize:
return False
if offset < 0 or offset+itemsize > memlen:
return False
if any(v % itemsize for v in strides):
return False
(continuesonnextpage)
8.7. BufferProtocol 129

| Request | shape | strides | suboffsets | contig | readonly | format |
| --- | --- | --- | --- | --- | --- | --- |
| PyBUF_FULL | yes | yes | ifneeded | U | 0 | yes |
| PyBUF_FULL_RO | yes | yes | ifneeded | U | 1or0 | yes |
| PyBUF_RECORDS | yes | yes | NULL | U | 0 | yes |
| PyBUF_RECORDS_RO | yes | yes | NULL | U | 1or0 | yes |
| PyBUF_STRIDED | yes | yes | NULL | U | 0 | NULL |
| PyBUF_STRIDED_RO | yes | yes | NULL | U | 1or0 | NULL |
| PyBUF_CONTIG | yes | NULL | NULL | C | 0 | NULL |
| PyBUF_CONTIG_RO | yes | NULL | NULL | C | 1or0 | NULL |

### 第138页

(continuedfrompreviouspage)
if ndim <= 0:
return ndim == 0 and not shape and not strides
if 0 in shape:
return True
imin = sum(strides[j]*(shape[j]-1) for j in range(ndim)
if strides[j] <= 0)
imax = sum(strides[j]*(shape[j]-1) for j in range(ndim)
if strides[j] > 0)
return 0 <= offset+imin and offset+imax+itemsize <= memlen
PIL-style: shape,stridesandsuboffsets
In addition to the regular items, PIL-style arrays can contain pointers that must be followed in order to get to the
nextelementinadimension. Forexample,theregularthree-dimensionalC-arraychar v[2][2][3]canalsobe
viewedasanarrayof2pointersto2two-dimensionalarrays: char (*v[2])[2][3]. Insuboffsetsrepresentation,
thosetwopointerscanbeembeddedatthestartofbuf,pointingtotwochar x[2][3]arraysthatcanbelocated
anywhereinmemory.
HereisafunctionthatreturnsapointertotheelementinanN-DarraypointedtobyanN-dimensionalindexwhen
therearebothnon-NULLstridesandsuboffsets:
void *get_item_pointer(int ndim, void *buf, Py_ssize_t *strides,
Py_ssize_t *suboffsets, Py_ssize_t *indices) {
char *pointer = (char*)buf;
int i;
for (i = 0; i < ndim; i++) {
pointer += strides[i] * indices[i];
if (suboffsets[i] >=0 ) {
pointer = *((char**)pointer) + suboffsets[i];
}
}
return (void*)pointer;
}
8.7.4 Buffer-related functions
intPyObject_CheckBuffer(PyObject*obj)
PartoftheStableABIsinceversion3.11. Return1ifobjsupportsthebufferinterfaceotherwise0. When1is
returned,itdoesn’tguaranteethatPyObject_GetBuffer()willsucceed. Thisfunctionalwayssucceeds.
intPyObject_GetBuffer(PyObject*exporter,Py_buffer*view,intflags)
PartoftheStableABIsinceversion3.11. Sendarequesttoexportertofillinviewasspecifiedbyflags. Ifthe
exporter cannot provide a buffer of the exact type, it MUST raise BufferError, set view->obj to NULL
andreturn-1.
Onsuccess, fillinview, setview->objtoanewreferencetoexporter andreturn0. Inthecaseofchained
buffer providers that redirect requests to a single object, view->obj MAY refer to this object instead of
exporter(SeeBufferObjectStructures).
SuccessfulcallstoPyObject_GetBuffer()mustbepairedwithcallstoPyBuffer_Release(),similar
tomalloc()andfree(). Thus,aftertheconsumerisdonewiththebuffer,PyBuffer_Release()must
becalledexactlyonce.
voidPyBuffer_Release(Py_buffer*view)
PartoftheStableABIsinceversion3.11. Releasethebufferviewandreleasethestrongreference(i.e. decrement
130 Chapter8. AbstractObjectsLayer

### 第139页

the reference count) to the view’s supporting object, view->obj. This function MUST be called when the
bufferisnolongerbeingused,otherwisereferenceleaksmayoccur.
ItisanerrortocallthisfunctiononabufferthatwasnotobtainedviaPyObject_GetBuffer().
Py_ssize_tPyBuffer_SizeFromFormat(constchar*format)
Part of the Stable ABI since version 3.11. Return the implied itemsize from format. On error, raise an
exceptionandreturn-1.
Addedinversion3.9.
intPyBuffer_IsContiguous(constPy_buffer*view,charorder)
Part of the Stable ABI since version 3.11. Return 1 if the memory defined by the view is C-style (order is
'C')orFortran-style(orderis'F')contiguousoreitherone(orderis'A').Return0otherwise. Thisfunction
alwayssucceeds.
void*PyBuffer_GetPointer(constPy_buffer*view,constPy_ssize_t*indices)
PartoftheStableABIsinceversion3.11. Getthememoryareapointedtobytheindicesinsidethegivenview.
indicesmustpointtoanarrayofview->ndimindices.
intPyBuffer_FromContiguous(constPy_buffer*view,constvoid*buf,Py_ssize_tlen,charfort)
PartoftheStableABIsinceversion3.11. Copycontiguouslenbytesfrombuftoview. fortcanbe'C'or'F'
(forC-styleorFortran-styleordering). 0isreturnedonsuccess,-1onerror.
intPyBuffer_ToContiguous(void*buf,constPy_buffer*src,Py_ssize_tlen,charorder)
PartoftheStableABIsinceversion3.11. Copylenbytesfromsrctoitscontiguousrepresentationinbuf. order
canbe'C'or'F'or'A'(forC-styleorFortran-styleorderingoreitherone). 0isreturnedonsuccess,-1
onerror.
Thisfunctionfailsiflen!=src->len.
intPyObject_CopyData(PyObject*dest,PyObject*src)
PartoftheStableABIsinceversion3.11. Copydatafromsrctodestbuffer. CanconvertbetweenC-styleand
orFortran-stylebuffers.
0isreturnedonsuccess,-1onerror.
voidPyBuffer_FillContiguousStrides(intndims,Py_ssize_t*shape,Py_ssize_t*strides,intitemsize,char
order)
PartoftheStableABIsinceversion3.11. Fillthestridesarraywithbyte-stridesofacontiguous(C-styleiforder
is'C'orFortran-styleiforderis'F')arrayofthegivenshapewiththegivennumberofbytesperelement.
intPyBuffer_FillInfo(Py_buffer*view,PyObject*exporter,void*buf,Py_ssize_tlen,intreadonly,intflags)
PartoftheStableABIsinceversion3.11. Handlebufferrequestsforanexporterthatwantstoexposebuf of
sizelenwithwritabilitysetaccordingtoreadonly. buf isinterpretedasasequenceofunsignedbytes.
Theflagsargumentindicatestherequesttype. Thisfunctionalwaysfillsinviewasspecifiedbyflags, unless
buf hasbeendesignatedasread-onlyandPyBUF_WRITABLEissetinflags.
Onsuccess,setview->objtoanewreferencetoexporterandreturn0. Otherwise,raiseBufferError,set
view->objtoNULLandreturn-1;
Ifthisfunctionisusedaspartofagetbufferproc,exporterMUSTbesettotheexportingobjectandflagsmust
bepassedunmodified. Otherwise,exporterMUSTbeNULL.
8.7. BufferProtocol 131

### 第140页

132 Chapter8. AbstractObjectsLayer

### 第141页

CHAPTER
NINE
CONCRETE OBJECTS LAYER
ThefunctionsinthischapterarespecifictocertainPythonobjecttypes. Passingthemanobjectofthewrongtypeis
notagoodidea;ifyoureceiveanobjectfromaPythonprogramandyouarenotsurethatithastherighttype,you
mustperformatypecheckfirst; forexample, tocheckthatanobjectisadictionary, usePyDict_Check(). The
chapterisstructuredlikethe“familytree”ofPythonobjecttypes.
(cid:193) Warning
Whilethefunctionsdescribedinthischaptercarefullycheckthetypeoftheobjectswhicharepassedin,many
ofthemdonotcheckforNULLbeingpassedinsteadofavalidobject. AllowingNULLtobepassedincancause
memoryaccessviolationsandimmediateterminationoftheinterpreter.
9.1 Fundamental Objects
ThissectiondescribesPythontypeobjectsandthesingletonobjectNone.
9.1.1 Type Objects
typePyTypeObject
PartoftheLimitedAPI(asanopaquestruct). TheCstructureoftheobjectsusedtodescribebuilt-intypes.
PyTypeObjectPyType_Type
Part of the Stable ABI. This is the type object for type objects; it is the same object as type in the Python
layer.
intPyType_Check(PyObject*o)
Returnnon-zeroiftheobjectoisatypeobject, includinginstancesoftypesderivedfromthestandardtype
object. Return0inallothercases. Thisfunctionalwayssucceeds.
intPyType_CheckExact(PyObject*o)
Returnnon-zeroiftheobjectoisatypeobject,butnotasubtypeofthestandardtypeobject. Return0inall
othercases. Thisfunctionalwayssucceeds.
unsignedintPyType_ClearCache()
PartoftheStableABI.Cleartheinternallookupcache. Returnthecurrentversiontag.
unsignedlongPyType_GetFlags(PyTypeObject*type)
PartoftheStableABI.Returnthetp_flagsmemberoftype. Thisfunctionisprimarilymeantforusewith
Py_LIMITED_API;theindividualflagbitsareguaranteedtobestableacrossPythonreleases, butaccessto
tp_flagsitselfisnotpartofthelimitedAPI.
Addedinversion3.2.
Changedinversion3.4: Thereturntypeisnowunsigned longratherthanlong.
133

| (cid:193) Warning |
| --- |
| Whilethefunctionsdescribedinthischaptercarefullycheckthetypeoftheobjectswhicharepassedin,many
ofthemdonotcheckforNULLbeingpassedinsteadofavalidobject. AllowingNULLtobepassedincancause
memoryaccessviolationsandimmediateterminationoftheinterpreter. |

### 第142页

PyObject*PyType_GetDict(PyTypeObject*type)
Return the type object’s internal namespace, which is otherwise only exposed via a read-only proxy (cls.
__dict__). Thisisareplacementforaccessingtp_dictdirectly. Thereturneddictionarymustbetreated
asread-only.
Thisfunctionismeantforspecificembeddingandlanguage-bindingcases,wheredirectaccesstothedictis
necessaryandindirectaccess(e.g. viatheproxyorPyObject_GetAttr())isn’tadequate.
Extensionmodulesshouldcontinuetousetp_dict,directlyorindirectly,whensettinguptheirowntypes.
Addedinversion3.12.
voidPyType_Modified(PyTypeObject*type)
PartoftheStableABI.Invalidatetheinternallookupcacheforthetypeandallofitssubtypes. Thisfunction
mustbecalledafteranymanualmodificationoftheattributesorbaseclassesofthetype.
intPyType_AddWatcher(PyType_WatchCallbackcallback)
Registercallbackasatypewatcher. Returnanon-negativeintegerIDwhichmustbepassedtofuturecallsto
PyType_Watch(). Incaseoferror(e.g. nomorewatcherIDsavailable),return-1andsetanexception.
In free-threaded builds, PyType_AddWatcher() is not thread-safe, so it must be called at start up (before
spawningthefirstthread).
Addedinversion3.12.
intPyType_ClearWatcher(intwatcher_id)
Clear watcher identified by watcher_id (previously returned from PyType_AddWatcher()). Return 0 on
success,-1onerror(e.g. ifwatcher_idwasneverregistered.)
AnextensionshouldnevercallPyType_ClearWatcherwithawatcher_id thatwasnotreturnedtoitbya
previouscalltoPyType_AddWatcher().
Addedinversion3.12.
intPyType_Watch(intwatcher_id,PyObject*type)
Marktypeaswatched. Thecallbackgrantedwatcher_idbyPyType_AddWatcher()willbecalledwhenever
PyType_Modified()reportsachangetotype. (Thecallbackmaybecalledonlyonceforaseriesofcon-
secutivemodificationstotype,if_PyType_Lookup()isnotcalledontypebetweenthemodifications;thisis
animplementationdetailandsubjecttochange.)
AnextensionshouldnevercallPyType_Watchwithawatcher_idthatwasnotreturnedtoitbyapreviouscall
toPyType_AddWatcher().
Addedinversion3.12.
typedefint(*PyType_WatchCallback)(PyObject*type)
Typeofatype-watchercallbackfunction.
ThecallbackmustnotmodifytypeorcausePyType_Modified()tobecalledontypeoranytypeinitsMRO;
violatingthisrulecouldcauseinfiniterecursion.
Addedinversion3.12.
intPyType_HasFeature(PyTypeObject*o,intfeature)
Returnnon-zeroifthetypeobjectosetsthefeaturefeature. Typefeaturesaredenotedbysinglebitflags.
intPyType_IS_GC(PyTypeObject*o)
Return true if the type object includes support for the cycle detector; this tests the type flag
Py_TPFLAGS_HAVE_GC.
intPyType_IsSubtype(PyTypeObject*a,PyTypeObject*b)
PartoftheStableABI.Returntrueifaisasubtypeofb.
Thisfunctiononlychecksforactualsubtypes,whichmeansthat__subclasscheck__()isnotcalledonb.
CallPyObject_IsSubclass()todothesamecheckthatissubclass()woulddo.
134 Chapter9. ConcreteObjectsLayer

### 第143页

PyObject*PyType_GenericAlloc(PyTypeObject*type,Py_ssize_tnitems)
Returnvalue: Newreference. PartoftheStableABI.Generichandlerforthetp_allocslotofatypeobject.
UsesPython’sdefaultmemoryallocationmechanismtoallocatememoryforanewinstance,zerosthememory,
theninitializesthememoryasifbycallingPyObject_Init()orPyObject_InitVar().
Donotcallthisdirectlytoallocatememoryforanobject;callthetype’stp_allocslotinstead.
Fortypesthatsupportgarbagecollection(i.e.,thePy_TPFLAGS_HAVE_GC flagisset),thisfunctionbehaves
likePyObject_GC_New orPyObject_GC_NewVar (exceptthememoryisguaranteedtobezeroedbefore
initialization), and should be paired with PyObject_GC_Del() in tp_free. Otherwise, it behaves like
PyObject_NeworPyObject_NewVar(exceptthememoryisguaranteedtobezeroedbeforeinitialization)
andshouldbepairedwithPyObject_Free()intp_free.
PyObject*PyType_GenericNew(PyTypeObject*type,PyObject*args,PyObject*kwds)
Returnvalue: Newreference. Partofthe StableABI. Generichandlerforthetp_new slotofa typeobject.
Createsanewinstanceusingthetype’stp_allocslotandreturnstheresultingobject.
intPyType_Ready(PyTypeObject*type)
PartoftheStableABI.Finalizeatypeobject. Thisshouldbecalledonalltypeobjectstofinishtheirinitial-
ization. Thisfunctionisresponsibleforaddinginheritedslotsfromatype’sbaseclass. Return0onsuccess,
orreturn-1andsetsanexceptiononerror.
(cid:174) Note
If some of the base classes implements the GC protocol and the provided type does not include the
Py_TPFLAGS_HAVE_GC in its flags, then the GC protocol will be automatically implemented from its
parents. Onthecontrary,ifthetypebeingcreateddoesincludePy_TPFLAGS_HAVE_GC initsflagsthen
itmustimplementtheGCprotocolitselfbyatleastimplementingthetp_traversehandle.
PyObject*PyType_GetName(PyTypeObject*type)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.11. Returnthetype’sname. Equivalentto
gettingthetype’s__name__attribute.
Addedinversion3.11.
PyObject*PyType_GetQualName(PyTypeObject*type)
Return value: New reference. Part of the Stable ABI since version 3.11. Return the type’s qualified name.
Equivalenttogettingthetype’s__qualname__attribute.
Addedinversion3.11.
PyObject*PyType_GetFullyQualifiedName(PyTypeObject*type)
Part of the Stable ABI since version 3.13. Return the type’s fully qualified name. Equivalent to f"{type.
__module__}.{type.__qualname__}",ortype.__qualname__iftype.__module__isnotastring
orisequalto"builtins".
Addedinversion3.13.
PyObject*PyType_GetModuleName(PyTypeObject*type)
PartoftheStableABIsinceversion3.13. Returnthetype’smodulename. Equivalenttogettingthetype.
__module__attribute.
Addedinversion3.13.
void*PyType_GetSlot(PyTypeObject*type,intslot)
PartoftheStableABIsinceversion3.4. Returnthefunctionpointerstoredinthegivenslot. Iftheresultis
NULL,thisindicatesthateithertheslotisNULL,orthatthefunctionwascalledwithinvalidparameters. Callers
willtypicallycasttheresultpointerintotheappropriatefunctiontype.
SeePyType_Slot.slotforpossiblevaluesoftheslotargument.
Addedinversion3.4.
9.1. FundamentalObjects 135

### 第144页

Changedinversion3.10: PyType_GetSlot()cannowacceptalltypes. Previously,itwaslimitedtoheap
types.
PyObject*PyType_GetModule(PyTypeObject*type)
PartoftheStableABIsinceversion3.10. Returnthemoduleobjectassociatedwiththegiventypewhenthe
typewascreatedusingPyType_FromModuleAndSpec().
Ifnomoduleisassociatedwiththegiventype,setsTypeErrorandreturnsNULL.
This function is usually used to get the module in which a method is defined. Note that in such a method,
PyType_GetModule(Py_TYPE(self)) may not return the intended result. Py_TYPE(self) may be a
subclassoftheintendedclass,andsubclassesarenotnecessarilydefinedinthesamemoduleastheirsuperclass.
SeePyCMethodtogettheclassthatdefinesthemethod. SeePyType_GetModuleByDef()forcaseswhen
PyCMethodcannotbeused.
Addedinversion3.9.
void*PyType_GetModuleState(PyTypeObject*type)
PartoftheStableABIsinceversion3.10. Returnthestateofthemoduleobjectassociatedwiththegiventype.
ThisisashortcutforcallingPyModule_GetState()ontheresultofPyType_GetModule().
Ifnomoduleisassociatedwiththegiventype,setsTypeErrorandreturnsNULL.
IfthetypehasanassociatedmodulebutitsstateisNULL,returnsNULLwithoutsettinganexception.
Addedinversion3.9.
PyObject*PyType_GetModuleByDef(PyTypeObject*type,structPyModuleDef *def)
Returnvalue: Borrowedreference. PartoftheStableABIsinceversion3.13. Findthefirstsuperclasswhose
modulewascreatedfromthegivenPyModuleDef def,andreturnthatmodule.
Ifnomoduleisfound,raisesaTypeErrorandreturnsNULL.
This function is intended to be used together with PyModule_GetState() to get module state from slot
methods (such as tp_init or nb_add) and other places where a method’s defining class cannot be passed
usingthePyCMethodcallingconvention.
Thereturnedreferenceisborrowedfromtype,andwillbevalidaslongasyouholdareferencetotype. Donot
releaseitwithPy_DECREF()orsimilar.
Addedinversion3.11.
intPyType_GetBaseByToken(PyTypeObject*type,void*token,PyTypeObject**result)
Part of the Stable ABI since version 3.14. Find the first superclass in type’s method resolution order whose
Py_tp_tokentokenisequaltothegivenone.
• Iffound,set*resulttoanewstrongreferencetoitandreturn1.
• Ifnotfound,set*resulttoNULLandreturn0.
• Onerror,set*resulttoNULLandreturn-1withanexceptionset.
TheresultargumentmaybeNULL,inwhichcase*resultisnotset. Usethisifyouneedonlythereturnvalue.
ThetokenargumentmaynotbeNULL.
Addedinversion3.14.
intPyUnstable_Type_AssignVersionTag(PyTypeObject*type)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Attempttoassignaversiontagtothegiventype.
136 Chapter9. ConcreteObjectsLayer

### 第145页

Returns1ifthetypealreadyhadavalidversiontagoranewonewasassigned,or0ifanewtagcouldnotbe
assigned.
Addedinversion3.12.
CreatingHeap-AllocatedTypes
Thefollowingfunctionsandstructsareusedtocreateheaptypes.
PyObject*PyType_FromMetaclass(PyTypeObject*metaclass,PyObject*module,PyType_Spec*spec,PyObject
*bases)
Part of the Stable ABI since version 3.12. Create and return a heap type from the spec (see
Py_TPFLAGS_HEAPTYPE).
Themetaclassmetaclassisusedtoconstructtheresultingtypeobject. WhenmetaclassisNULL,themetaclass
isderivedfrombases(orPy_tp_base[s]slotsifbasesisNULL,seebelow).
Metaclassesthatoverridetp_newarenotsupported,exceptiftp_newisNULL.
Thebasesargumentcanbeusedtospecifybaseclasses;itcaneitherbeonlyoneclassoratupleofclasses. If
basesisNULL,thePy_tp_basesslotisusedinstead. IfthatalsoisNULL,thePy_tp_baseslotisusedinstead. If
thatalsoisNULL,thenewtypederivesfromobject.
The module argument can be used to record the module in which the new class is defined. It must be a
module object or NULL. If not NULL, the module is associated with the new type and can later be retrieved
withPyType_GetModule(). Theassociatedmoduleisnotinheritedbysubclasses;itmustbespecifiedfor
eachclassindividually.
ThisfunctioncallsPyType_Ready()onthenewtype.
Note that this function does not fully match the behavior of calling type() or using the class statement.
With user-provided base types or metaclasses, prefer calling type (or the metaclass) over PyType_From*
functions. Specifically:
• __new__()isnotcalledonthenewclass(anditmustbesettotype.__new__).
• __init__()isnotcalledonthenewclass.
• __init_subclass__()isnotcalledonanybases.
• __set_name__()isnotcalledonnewdescriptors.
Addedinversion3.12.
PyObject*PyType_FromModuleAndSpec(PyObject*module,PyType_Spec*spec,PyObject*bases)
Return value: New reference. Part of the Stable ABI since version 3.10. Equivalent to
PyType_FromMetaclass(NULL, module, spec, bases).
Addedinversion3.9.
Changed in version 3.10: The function now accepts a single class as the bases argument and NULL as the
tp_docslot.
Changed in version 3.12: The function now finds and uses a metaclass corresponding to the provided base
classes. Previously,onlytypeinstanceswerereturned.
Thetp_newofthemetaclassisignored. whichmayresultinincompleteinitialization. Creatingclasseswhose
metaclassoverridestp_newisdeprecated.
Changedinversion3.14: Creatingclasseswhosemetaclassoverridestp_newisnolongerallowed.
PyObject*PyType_FromSpecWithBases(PyType_Spec*spec,PyObject*bases)
Return value: New reference. Part of the Stable ABI since version 3.3. Equivalent to
PyType_FromMetaclass(NULL, NULL, spec, bases).
Addedinversion3.3.
Changed in version 3.12: The function now finds and uses a metaclass corresponding to the provided base
classes. Previously,onlytypeinstanceswerereturned.
9.1. FundamentalObjects 137

### 第146页

Thetp_newofthemetaclassisignored. whichmayresultinincompleteinitialization. Creatingclasseswhose
metaclassoverridestp_newisdeprecated.
Changedinversion3.14: Creatingclasseswhosemetaclassoverridestp_newisnolongerallowed.
PyObject*PyType_FromSpec(PyType_Spec*spec)
Returnvalue:Newreference. PartoftheStableABI.EquivalenttoPyType_FromMetaclass(NULL, NULL,
spec, NULL).
Changed in version 3.12: The function now finds and uses a metaclass corresponding to the base classes
providedinPy_tp_base[s]slots. Previously,onlytypeinstanceswerereturned.
Thetp_newofthemetaclassisignored. whichmayresultinincompleteinitialization. Creatingclasseswhose
metaclassoverridestp_newisdeprecated.
Changedinversion3.14: Creatingclasseswhosemetaclassoverridestp_newisnolongerallowed.
intPyType_Freeze(PyTypeObject*type)
PartoftheStableABIsinceversion3.14. Makeatypeimmutable: setthePy_TPFLAGS_IMMUTABLETYPE
flag.
Allbaseclassesoftypemustbeimmutable.
Onsuccess,return0. Onerror,setanexceptionandreturn-1.
Thetypemustnotbeusedbeforeit’smadeimmutable. Forexample,typeinstancesmustnotbecreatedbefore
thetypeismadeimmutable.
Addedinversion3.14.
typePyType_Spec
PartoftheStableABI(includingallmembers). Structuredefiningatype’sbehavior.
constchar*name
Nameofthetype,usedtosetPyTypeObject.tp_name.
intbasicsize
Ifpositive,specifiesthesizeoftheinstanceinbytes. ItisusedtosetPyTypeObject.tp_basicsize.
Ifzero,specifiesthattp_basicsizeshouldbeinherited.
If negative, the absolute value specifies how much space instances of the class need in addition to the
superclass. Use PyObject_GetTypeData() to get a pointer to subclass-specific memory reserved
thisway. Fornegativebasicsize,Pythonwillinsertpaddingwhenneededtomeettp_basicsize’s
alignmentrequirements.
Changedinversion3.12: Previously,thisfieldcouldnotbenegative.
intitemsize
Sizeofoneelementofavariable-sizetype,inbytes. UsedtosetPyTypeObject.tp_itemsize. See
tp_itemsizedocumentationforcaveats.
Ifzero,tp_itemsizeisinherited. Extendingarbitraryvariable-sizedclassesisdangerous,sincesome
typesuseafixedoffsetforvariable-sizedmemory,whichcanthenoverlapfixed-sizedmemoryusedbya
subclass. Tohelppreventmistakes,inheritingitemsizeisonlypossibleinthefollowingsituations:
• Thebaseisnotvariable-sized(itstp_itemsize).
• The requested PyType_Spec.basicsize is positive, suggesting that the memory layout of the
baseclassisknown.
• TherequestedPyType_Spec.basicsizeiszero,suggestingthatthesubclassdoesnotaccessthe
instance’smemorydirectly.
• WiththePy_TPFLAGS_ITEMS_AT_ENDflag.
138 Chapter9. ConcreteObjectsLayer

### 第147页

unsignedintflags
Typeflags,usedtosetPyTypeObject.tp_flags.
IfthePy_TPFLAGS_HEAPTYPEflagisnotset,PyType_FromSpecWithBases()setsitautomatically.
PyType_Slot*slots
ArrayofPyType_Slotstructures. Terminatedbythespecialslotvalue{0, NULL}.
EachslotIDshouldbespecifiedatmostonce.
typePyType_Slot
PartoftheStableABI(includingallmembers). Structuredefiningoptionalfunctionalityofatype,containing
aslotIDandavaluepointer.
intslot
AslotID.
Slot IDs are named like the field names of the structures PyTypeObject, PyNumberMethods,
PySequenceMethods, PyMappingMethods and PyAsyncMethods with an added Py_ prefix. For
example,use:
• Py_tp_dealloctosetPyTypeObject.tp_dealloc
• Py_nb_addtosetPyNumberMethods.nb_add
• Py_sq_lengthtosetPySequenceMethods.sq_length
AnadditionalslotissupportedthatdoesnotcorrespondtoaPyTypeObjectstructfield:
• Py_tp_token
Thefollowing“offset”fieldscannotbesetusingPyType_Slot:
• tp_weaklistoffset(usePy_TPFLAGS_MANAGED_WEAKREFinsteadifpossible)
• tp_dictoffset(usePy_TPFLAGS_MANAGED_DICTinsteadifpossible)
• tp_vectorcall_offset(use"__vectorcalloffset__"inPyMemberDef)
IfitisnotpossibletoswitchtoaMANAGEDflag(forexample,forvectorcallortosupportPythonolder
than3.12),specifytheoffsetinPy_tp_members. SeePyMemberDefdocumentationfordetails.
Thefollowinginternalfieldscannotbesetatallwhencreatingaheaptype:
• tp_dict,tp_mro,tp_cache,tp_subclasses,andtp_weaklist.
SettingPy_tp_basesorPy_tp_basemaybeproblematiconsomeplatforms. Toavoidissues,usethe
basesargumentofPyType_FromSpecWithBases()instead.
Changedinversion3.9: SlotsinPyBufferProcsmaybesetintheunlimitedAPI.
Changedinversion3.11: bf_getbufferandbf_releasebufferarenowavailableunderthelimited
API.
Changedinversion3.14: Thefieldtp_vectorcallcannowsetusingPy_tp_vectorcall. Seethe
field’sdocumentationfordetails.
void*pfunc
Thedesiredvalueoftheslot. Inmostcases,thisisapointertoafunction.
pfuncvaluesmaynotbeNULL,exceptforthefollowingslots:
• Py_tp_doc
• Py_tp_token(forclarity,preferPy_TP_USE_SPECratherthanNULL)
Py_tp_token
AslotthatrecordsastaticmemorylayoutIDforaclass.
IfthePyType_Specoftheclassisstaticallyallocated,thetokencanbesettothespecusingthespecialvalue
Py_TP_USE_SPEC:
9.1. FundamentalObjects 139

### 第148页

static PyType_Slot foo_slots[] = {
{Py_tp_token, Py_TP_USE_SPEC},
Itcanalsobesettoanarbitrarypointer,butyoumustensurethat:
• Thepointeroutlivestheclass,soit’snotreusedforsomethingelsewhiletheclassexists.
• It“belongs”totheextensionmodulewheretheclasslives,soitwillnotclashwithotherextensions.
UsePyType_GetBaseByToken()tocheckifaclass’ssuperclasshasagiventoken–thatis,checkwhether
thememorylayoutiscompatible.
To get the token for a given class (without considering superclasses), use PyType_GetSlot() with
Py_tp_token.
Addedinversion3.14.
Py_TP_USE_SPEC
UsedasavaluewithPy_tp_tokentosetthetokentotheclass’sPyType_Spec. ExpandstoNULL.
Addedinversion3.14.
9.1.2 The None Object
Note that the PyTypeObject for None is not directly exposed in the Python/C API. Since None is a singleton,
testingforobjectidentity(using==inC)issufficient. ThereisnoPyNone_Check()functionforthesamereason.
PyObject*Py_None
ThePythonNoneobject,denotinglackofvalue. Thisobjecthasnomethodsandisimmortal.
Changedinversion3.12: Py_Noneisimmortal.
Py_RETURN_NONE
ReturnPy_Nonefromafunction.
9.2 Numeric Objects
9.2.1 Integer Objects
Allintegersareimplementedas“long”integerobjectsofarbitrarysize.
Onerror,mostPyLong_As*APIsreturn(return type)-1whichcannotbedistinguishedfromanumber. Use
PyErr_Occurred()todisambiguate.
typePyLongObject
PartoftheLimitedAPI(asanopaquestruct). ThissubtypeofPyObjectrepresentsaPythonintegerobject.
PyTypeObjectPyLong_Type
PartoftheStableABI.ThisinstanceofPyTypeObjectrepresentsthePythonintegertype. Thisisthesame
objectasintinthePythonlayer.
intPyLong_Check(PyObject*p)
ReturntrueifitsargumentisaPyLongObjectorasubtypeofPyLongObject. Thisfunctionalwayssuc-
ceeds.
intPyLong_CheckExact(PyObject*p)
ReturntrueifitsargumentisaPyLongObject,butnotasubtypeofPyLongObject. Thisfunctionalways
succeeds.
PyObject*PyLong_FromLong(longv)
Returnvalue: Newreference. PartoftheStableABI.ReturnanewPyLongObjectobjectfromv,orNULLon
failure.
140 Chapter9. ConcreteObjectsLayer

### 第149页

CPythonimplementationdetail: CPythonkeepsanarrayofintegerobjectsforallintegersbetween-5and
256. Whenyoucreateanintinthatrangeyouactuallyjustgetbackareferencetotheexistingobject.
PyObject*PyLong_FromUnsignedLong(unsignedlongv)
Returnvalue: Newreference. PartoftheStableABI.ReturnanewPyLongObjectobjectfromaCunsigned
long,orNULLonfailure.
PyObject*PyLong_FromSsize_t(Py_ssize_tv)
Return value: New reference. Part of the Stable ABI. Return a new PyLongObject object from a C
Py_ssize_t,orNULLonfailure.
PyObject*PyLong_FromSize_t(size_tv)
Returnvalue: Newreference. PartoftheStableABI.ReturnanewPyLongObjectobjectfromaCsize_t,
orNULLonfailure.
PyObject*PyLong_FromLongLong(longlongv)
Return value: New reference. Part of the Stable ABI. Return a new PyLongObject object from a C long
long,orNULLonfailure.
PyObject*PyLong_FromInt32(int32_tvalue)
PyObject*PyLong_FromInt64(int64_tvalue)
PartoftheStableABIsinceversion3.14. ReturnanewPyLongObjectobjectfromasignedCint32_tor
int64_t,orNULLwithanexceptionsetonfailure.
Addedinversion3.14.
PyObject*PyLong_FromUnsignedLongLong(unsignedlonglongv)
Returnvalue: Newreference. PartoftheStableABI.ReturnanewPyLongObjectobjectfromaCunsigned
long long,orNULLonfailure.
PyObject*PyLong_FromUInt32(uint32_tvalue)
PyObject*PyLong_FromUInt64(uint64_tvalue)
PartoftheStableABIsinceversion3.14. ReturnanewPyLongObjectobjectfromanunsignedCuint32_t
oruint64_t,orNULLwithanexceptionsetonfailure.
Addedinversion3.14.
PyObject*PyLong_FromDouble(doublev)
Returnvalue: Newreference. PartoftheStableABI.ReturnanewPyLongObjectobjectfromtheinteger
partofv,orNULLonfailure.
PyObject*PyLong_FromString(constchar*str,char**pend,intbase)
Returnvalue: Newreference. PartoftheStableABI.ReturnanewPyLongObjectbasedonthestringvalue
instr,whichisinterpretedaccordingtotheradixinbase,orNULLonfailure. Ifpendisnon-NULL,*pendwill
pointtotheendofstr onsuccessortothefirstcharacterthatcouldnotbeprocessedonerror. Ifbaseis0,
strisinterpretedusingtheintegersdefinition;inthiscase,leadingzerosinanon-zerodecimalnumberraises
a ValueError. If base is not 0, it must be between 2 and 36, inclusive. Leading and trailing whitespace
andsingleunderscoresafterabasespecifierandbetweendigitsareignored. Iftherearenodigitsorstrisnot
NULL-terminatedfollowingthedigitsandtrailingwhitespace,ValueErrorwillberaised.
(cid:181) Seealso
PyLong_AsNativeBytes() and PyLong_FromNativeBytes() functions can be used to convert a
PyLongObjectto/fromanarrayofbytesinbase256.
PyObject*PyLong_FromUnicodeObject(PyObject*u,intbase)
Returnvalue: Newreference. ConvertasequenceofUnicodedigitsinthestringutoaPythonintegervalue.
Addedinversion3.3.
9.2. NumericObjects 141

| (cid:181) Seealso |
| --- |
| PyLong_AsNativeBytes() and PyLong_FromNativeBytes() functions can be used to convert a
PyLongObjectto/fromanarrayofbytesinbase256. |

### 第150页

PyObject*PyLong_FromVoidPtr(void*p)
Returnvalue: Newreference. PartoftheStableABI.CreateaPythonintegerfromthepointerp. Thepointer
valuecanberetrievedfromtheresultingvalueusingPyLong_AsVoidPtr().
PyObject*PyLong_FromNativeBytes(constvoid*buffer,size_tn_bytes,intflags)
PartoftheStableABIsinceversion3.14. CreateaPythonintegerfromthevaluecontainedinthefirstn_bytes
ofbuffer,interpretedasatwo’s-complementsignednumber.
flags are as for PyLong_AsNativeBytes(). Passing -1 will select the native endian
that CPython was compiled with and assume that the most-significant bit is a sign bit.
Passing Py_ASNATIVEBYTES_UNSIGNED_BUFFER will produce the same result as calling
PyLong_FromUnsignedNativeBytes(). Otherflagsareignored.
Addedinversion3.13.
PyObject*PyLong_FromUnsignedNativeBytes(constvoid*buffer,size_tn_bytes,intflags)
PartoftheStableABIsinceversion3.14. CreateaPythonintegerfromthevaluecontainedinthefirstn_bytes
ofbuffer,interpretedasanunsignednumber.
flags are as for PyLong_AsNativeBytes(). Passing -1 will select the native endian that CPython was
compiledwithandassumethatthemost-significantbitisnotasignbit. Flagsotherthanendianareignored.
Addedinversion3.13.
longPyLong_AsLong(PyObject*obj)
PartoftheStableABI.ReturnaClongrepresentationofobj. Ifobj isnotaninstanceofPyLongObject,
firstcallits__index__()method(ifpresent)toconvertittoaPyLongObject.
RaiseOverflowErrorifthevalueofobjisoutofrangeforalong.
Returns-1onerror. UsePyErr_Occurred()todisambiguate.
Changedinversion3.8: Use__index__()ifavailable.
Changedinversion3.10: Thisfunctionwillnolongeruse__int__().
longPyLong_AS_LONG(PyObject*obj)
Asoftdeprecated alias. ExactlyequivalenttothepreferredPyLong_AsLong. Inparticular, itcanfail
withOverflowErrororanotherexception.
Deprecatedsinceversion3.14: Thefunctionissoftdeprecated.
intPyLong_AsInt(PyObject*obj)
Part of the Stable ABI since version 3.13. Similar to PyLong_AsLong(), but store the result in a C int
insteadofaClong.
Addedinversion3.13.
longPyLong_AsLongAndOverflow(PyObject*obj,int*overflow)
PartoftheStableABI.ReturnaClongrepresentationofobj. Ifobj isnotaninstanceofPyLongObject,
firstcallits__index__()method(ifpresent)toconvertittoaPyLongObject.
Ifthevalueofobj isgreaterthanLONG_MAXorlessthanLONG_MIN,set*overflowto1or-1, respectively,
andreturn-1;otherwise,set*overflowto0. Ifanyotherexceptionoccursset*overflowto0andreturn-1as
usual.
Returns-1onerror. UsePyErr_Occurred()todisambiguate.
Changedinversion3.8: Use__index__()ifavailable.
Changedinversion3.10: Thisfunctionwillnolongeruse__int__().
longlongPyLong_AsLongLong(PyObject*obj)
Part of the Stable ABI. Return a C long long representation of obj. If obj is not an instance of
PyLongObject,firstcallits__index__()method(ifpresent)toconvertittoaPyLongObject.
RaiseOverflowErrorifthevalueofobjisoutofrangeforalong long.
142 Chapter9. ConcreteObjectsLayer

### 第151页

Returns-1onerror. UsePyErr_Occurred()todisambiguate.
Changedinversion3.8: Use__index__()ifavailable.
Changedinversion3.10: Thisfunctionwillnolongeruse__int__().
longlongPyLong_AsLongLongAndOverflow(PyObject*obj,int*overflow)
Part of the Stable ABI. Return a C long long representation of obj. If obj is not an instance of
PyLongObject,firstcallits__index__()method(ifpresent)toconvertittoaPyLongObject.
IfthevalueofobjisgreaterthanLLONG_MAXorlessthanLLONG_MIN,set*overflowto1or-1,respectively,
andreturn-1;otherwise,set*overflowto0. Ifanyotherexceptionoccursset*overflowto0andreturn-1as
usual.
Returns-1onerror. UsePyErr_Occurred()todisambiguate.
Addedinversion3.2.
Changedinversion3.8: Use__index__()ifavailable.
Changedinversion3.10: Thisfunctionwillnolongeruse__int__().
Py_ssize_tPyLong_AsSsize_t(PyObject*pylong)
Part of the Stable ABI. Return a C Py_ssize_t representation of pylong. pylong must be an instance of
PyLongObject.
RaiseOverflowErrorifthevalueofpylongisoutofrangeforaPy_ssize_t.
Returns-1onerror. UsePyErr_Occurred()todisambiguate.
unsignedlongPyLong_AsUnsignedLong(PyObject*pylong)
PartoftheStableABI.ReturnaCunsigned longrepresentationofpylong. pylongmustbeaninstanceof
PyLongObject.
RaiseOverflowErrorifthevalueofpylongisoutofrangeforaunsigned long.
Returns(unsigned long)-1onerror. UsePyErr_Occurred()todisambiguate.
size_tPyLong_AsSize_t(PyObject*pylong)
Part of the Stable ABI. Return a C size_t representation of pylong. pylong must be an instance of
PyLongObject.
RaiseOverflowErrorifthevalueofpylongisoutofrangeforasize_t.
Returns(size_t)-1onerror. UsePyErr_Occurred()todisambiguate.
unsignedlonglongPyLong_AsUnsignedLongLong(PyObject*pylong)
Part of the Stable ABI. Return a C unsigned long long representation of pylong. pylong must be an
instanceofPyLongObject.
RaiseOverflowErrorifthevalueofpylongisoutofrangeforanunsigned long long.
Returns(unsigned long long)-1onerror. UsePyErr_Occurred()todisambiguate.
Changedinversion3.1: AnegativepylongnowraisesOverflowError,notTypeError.
unsignedlongPyLong_AsUnsignedLongMask(PyObject*obj)
Part of the Stable ABI. Return a C unsigned long representation of obj. If obj is not an instance of
PyLongObject,firstcallits__index__()method(ifpresent)toconvertittoaPyLongObject.
If the value of obj is out of range for an unsigned long, return the reduction of that value modulo
ULONG_MAX + 1.
Returns(unsigned long)-1onerror. UsePyErr_Occurred()todisambiguate.
Changedinversion3.8: Use__index__()ifavailable.
Changedinversion3.10: Thisfunctionwillnolongeruse__int__().
9.2. NumericObjects 143

### 第152页

unsignedlonglongPyLong_AsUnsignedLongLongMask(PyObject*obj)
PartoftheStableABI.ReturnaCunsigned long longrepresentationofobj. Ifobjisnotaninstanceof
PyLongObject,firstcallits__index__()method(ifpresent)toconvertittoaPyLongObject.
Ifthevalueofobj isoutofrangeforanunsigned long long,returnthereductionofthatvaluemodulo
ULLONG_MAX + 1.
Returns(unsigned long long)-1onerror. UsePyErr_Occurred()todisambiguate.
Changedinversion3.8: Use__index__()ifavailable.
Changedinversion3.10: Thisfunctionwillnolongeruse__int__().
intPyLong_AsInt32(PyObject*obj,int32_t*value)
intPyLong_AsInt64(PyObject*obj,int64_t*value)
PartoftheStableABIsinceversion3.14. Set*valuetoasignedCint32_torint64_trepresentationof
obj.
IfobjisnotaninstanceofPyLongObject,firstcallits__index__()method(ifpresent)toconvertittoa
PyLongObject.
Iftheobjvalueisoutofrange,raiseanOverflowError.
Set*valueandreturn0onsuccess. Setanexceptionandreturn-1onerror.
valuemustnotbeNULL.
Addedinversion3.14.
intPyLong_AsUInt32(PyObject*obj,uint32_t*value)
intPyLong_AsUInt64(PyObject*obj,uint64_t*value)
PartoftheStableABIsinceversion3.14. Set*valuetoanunsignedCuint32_toruint64_trepresentation
ofobj.
IfobjisnotaninstanceofPyLongObject,firstcallits__index__()method(ifpresent)toconvertittoa
PyLongObject.
• Ifobjisnegative,raiseaValueError.
• Iftheobjvalueisoutofrange,raiseanOverflowError.
Set*valueandreturn0onsuccess. Setanexceptionandreturn-1onerror.
valuemustnotbeNULL.
Addedinversion3.14.
doublePyLong_AsDouble(PyObject*pylong)
Part of the Stable ABI. Return a C double representation of pylong. pylong must be an instance of
PyLongObject.
RaiseOverflowErrorifthevalueofpylongisoutofrangeforadouble.
Returns-1.0onerror. UsePyErr_Occurred()todisambiguate.
void*PyLong_AsVoidPtr(PyObject*pylong)
PartoftheStableABI.ConvertaPythonintegerpylongtoaCvoidpointer. Ifpylongcannotbeconverted,
anOverflowErrorwillberaised. Thisisonlyassuredtoproduceausablevoidpointerforvaluescreated
withPyLong_FromVoidPtr().
ReturnsNULLonerror. UsePyErr_Occurred()todisambiguate.
Py_ssize_tPyLong_AsNativeBytes(PyObject*pylong,void*buffer,Py_ssize_tn_bytes,intflags)
Part of the Stable ABI since version 3.14. Copy the Python integer value pylong to a native buffer of size
n_bytes. Theflagscanbesetto-1tobehavesimilarlytoaCcast,ortovaluesdocumentedbelowtocontrol
thebehavior.
144 Chapter9. ConcreteObjectsLayer

### 第153页

Returns-1withanexceptionraisedonerror. Thismayhappenifpylongcannotbeinterpretedasaninteger,
orifpylongwasnegativeandthePy_ASNATIVEBYTES_REJECT_NEGATIVEflagwasset.
Otherwise,returnsthenumberofbytesrequiredtostorethevalue. Ifthisisequaltoorlessthann_bytes,the
entirevaluewascopied. Alln_bytesofthebufferarewritten: largebuffersarepaddedwithzeroes.
Ifthereturnedvalueisgreaterthann_bytes,thevaluewastruncated: asmanyofthelowestbitsofthevalueas
couldfitarewritten,andthehigherbitsareignored. ThismatchesthetypicalbehaviorofaC-styledowncast.
(cid:174) Note
Overflowisnotconsideredanerror. Ifthereturnedvalueislargerthann_bytes,mostsignificantbitswere
discarded.
0willneverbereturned.
Valuesarealwayscopiedastwo’s-complement.
Usageexample:
int32_t value;
Py_ssize_t bytes = PyLong_AsNativeBytes(pylong, &value, sizeof(value), -1);
if (bytes < 0) {
// Failed. A Python exception was set with the reason.
return NULL;
}
else if (bytes <= (Py_ssize_t)sizeof(value)) {
// Success!
}
else {
// Overflow occurred, but 'value' contains the truncated
// lowest bits of pylong.
}
Passingzeroton_byteswillreturnthesizeofabufferthatwouldbelargeenoughtoholdthevalue. Thismay
belargerthantechnicallynecessary,butnotunreasonablyso. Ifn_bytes=0,buffermaybeNULL.
(cid:174) Note
Passingn_bytes=0tothisfunctionisnotanaccuratewaytodeterminethebitlengthofthevalue.
TogetattheentirePythonvalueofanunknownsize,thefunctioncanbecalledtwice: firsttodeterminethe
buffersize,thentofillit:
// Ask how much space we need.
Py_ssize_t expected = PyLong_AsNativeBytes(pylong, NULL, 0, -1);
if (expected < 0) {
// Failed. A Python exception was set with the reason.
return NULL;
}
assert(expected != 0); // Impossible per the API definition.
uint8_t *bignum = malloc(expected);
if (!bignum) {
PyErr_SetString(PyExc_MemoryError, "bignum malloc failed.");
return NULL;
}
// Safely get the entire value.
Py_ssize_t bytes = PyLong_AsNativeBytes(pylong, bignum, expected, -1);
(continuesonnextpage)
9.2. NumericObjects 145

### 第154页

(continuedfrompreviouspage)
if (bytes < 0) { // Exception has been set.
free(bignum);
return NULL;
}
else if (bytes > expected) { // This should not be possible.
PyErr_SetString(PyExc_RuntimeError,
"Unexpected bignum truncation after a size check.");
free(bignum);
return NULL;
}
// The expected success given the above pre-check.
// ... use bignum ...
free(bignum);
flags is either -1 (Py_ASNATIVEBYTES_DEFAULTS) to select defaults that behave most like a C cast, or a
combinationoftheotherflagsinthetablebelow. Notethat-1cannotbecombinedwithotherflags.
Currently, -1 corresponds to Py_ASNATIVEBYTES_NATIVE_ENDIAN |
Py_ASNATIVEBYTES_UNSIGNED_BUFFER.
Flag Value
-1
Py_ASNATIVEBYTES_DEFAULTS
0
Py_ASNATIVEBYTES_BIG_ENDIAN
1
Py_ASNATIVEBYTES_LITTLE_ENDIAN
3
Py_ASNATIVEBYTES_NATIVE_ENDIAN
4
Py_ASNATIVEBYTES_UNSIGNED_BUFFER
8
Py_ASNATIVEBYTES_REJECT_NEGATIVE
16
Py_ASNATIVEBYTES_ALLOW_INDEX
SpecifyingPy_ASNATIVEBYTES_NATIVE_ENDIANwilloverrideanyotherendianflags. Passing2isreserved.
By default, sufficient buffer will be requested to include a sign bit. For example, when converting 128 with
n_bytes=1,thefunctionwillreturn2(ormore)inordertostoreazerosignbit.
IfPy_ASNATIVEBYTES_UNSIGNED_BUFFERisspecified, azerosignbitwillbeomittedfromsizecalcula-
tions. Thisallows, forexample, 128tofitinasingle-bytebuffer. Ifthedestinationbufferislatertreatedas
signed, a positive input value may become negative. Note that the flag does not affect handling of negative
values: forthose,spaceforasignbitisalwaysrequested.
Specifying Py_ASNATIVEBYTES_REJECT_NEGATIVE causes an exception to be set if pylong is negative.
Withoutthisflag, negativevalueswillbecopiedprovidedthereisenoughspaceforatleastonesignbit, re-
gardlessofwhetherPy_ASNATIVEBYTES_UNSIGNED_BUFFERwasspecified.
If Py_ASNATIVEBYTES_ALLOW_INDEX is specified and a non-integer value is passed, its __index__()
146 Chapter9. ConcreteObjectsLayer

| Flag | Value |
| --- | --- |
| Py_ASNATIVEBYTES_DEFAULTS | -1 |
| Py_ASNATIVEBYTES_BIG_ENDIAN | 0 |
| Py_ASNATIVEBYTES_LITTLE_ENDIAN | 1 |
| Py_ASNATIVEBYTES_NATIVE_ENDIAN | 3 |
| Py_ASNATIVEBYTES_UNSIGNED_BUFFER | 4 |
| Py_ASNATIVEBYTES_REJECT_NEGATIVE | 8 |
| Py_ASNATIVEBYTES_ALLOW_INDEX | 16 |

### 第155页

methodwillbecalledfirst. ThismayresultinPythoncodeexecutingandotherthreadsbeingallowedtorun,
which could cause changes to other objects or values in use. When flags is -1, this option is not set, and
non-integervalueswillraiseTypeError.
(cid:174) Note
Withthedefaultflags(-1,orUNSIGNED_BUFFERwithoutREJECT_NEGATIVE),multiplePythoninte-
gerscanmaptoasinglevaluewithoutoverflow. Forexample,both255and-1fitasingle-bytebufferand
setallitsbits. ThismatchestypicalCcastbehavior.
Addedinversion3.13.
intPyLong_GetSign(PyObject*obj,int*sign)
Getthesignoftheintegerobjectobj.
On success, set *sign to the integer sign (0, -1 or +1 for zero, negative or positive integer, respectively) and
return0.
On failure, return -1 with an exception set. This function always succeeds if obj is a PyLongObject or its
subtype.
Addedinversion3.14.
intPyLong_IsPositive(PyObject*obj)
Checkiftheintegerobjectobjispositive(obj > 0).
IfobjisaninstanceofPyLongObjectoritssubtype,return1whenit’spositiveand0otherwise. Elsesetan
exceptionandreturn-1.
Addedinversion3.14.
intPyLong_IsNegative(PyObject*obj)
Checkiftheintegerobjectobjisnegative(obj < 0).
IfobjisaninstanceofPyLongObjectoritssubtype,return1whenit’snegativeand0otherwise. Elsesetan
exceptionandreturn-1.
Addedinversion3.14.
intPyLong_IsZero(PyObject*obj)
Checkiftheintegerobjectobjiszero.
If obj is an instance of PyLongObject or its subtype, return 1 when it’s zero and 0 otherwise. Else set an
exceptionandreturn-1.
Addedinversion3.14.
PyObject*PyLong_GetInfo(void)
Part of the Stable ABI. On success, return a read only named tuple, that holds information about Python’s
internalrepresentationofintegers. Seesys.int_infofordescriptionofindividualfields.
Onfailure,returnNULLwithanexceptionset.
Addedinversion3.1.
intPyUnstable_Long_IsCompact(constPyLongObject*op)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Return1ifopiscompact,0otherwise.
9.2. NumericObjects 147

### 第156页

Thisfunctionmakesitpossibleforperformance-criticalcodetoimplementa“fastpath”forsmallintegers. For
compactvaluesusePyUnstable_Long_CompactValue();forothersfallbacktoaPyLong_As*function
orPyLong_AsNativeBytes().
Thespeedupisexpectedtobenegligibleformostusers.
Exactlywhatvaluesareconsideredcompactisanimplementationdetailandissubjecttochange.
Addedinversion3.12.
Py_ssize_tPyUnstable_Long_CompactValue(constPyLongObject*op)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Ifopiscompact,asdeterminedbyPyUnstable_Long_IsCompact(),returnitsvalue.
Otherwise,thereturnvalueisundefined.
Addedinversion3.12.
ExportAPI
Addedinversion3.14.
structPyLongLayout
Layoutofanarrayof“digits”(“limbs”intheGMPterminology),usedtorepresentabsolutevalueforarbitrary
precisionintegers.
UsePyLong_GetNativeLayout()togetthenativelayoutofPythonintobjects,usedinternallyforintegers
with“bigenough”absolutevalue.
Seealsosys.int_infowhichexposessimilarinformationinPython.
uint8_tbits_per_digit
Bitsperdigit. Forexample,a15bitdigitmeansthatbits0-14containmeaningfulinformation.
uint8_tdigit_size
Digitsizeinbytes. Forexample,a15bitdigitwillrequireatleast2bytes.
int8_tdigits_order
Digitsorder:
• 1formostsignificantdigitfirst
• -1forleastsignificantdigitfirst
int8_tdigit_endianness
Digitendianness:
• 1formostsignificantbytefirst(bigendian)
• -1forleastsignificantbytefirst(littleendian)
constPyLongLayout*PyLong_GetNativeLayout(void)
GetthenativelayoutofPythonintobjects.
SeethePyLongLayoutstructure.
ThefunctionmustnotbecalledbeforePythoninitializationnorafterPythonfinalization. Thereturnedlayout
isvaliduntilPythonisfinalized. ThelayoutisthesameforallPythonsub-interpretersinaprocess,andsoit
canbecached.
148 Chapter9. ConcreteObjectsLayer

### 第157页

structPyLongExport
ExportofaPythonintobject.
Therearetwocases:
• IfdigitsisNULL,onlyusethevaluemember.
• IfdigitsisnotNULL,usenegative,ndigitsanddigitsmembers.
int64_tvalue
Thenativeintegervalueoftheexportedintobject. OnlyvalidifdigitsisNULL.
uint8_tnegative
1ifthenumberisnegative,0otherwise. OnlyvalidifdigitsisnotNULL.
Py_ssize_tndigits
Numberofdigitsindigitsarray. OnlyvalidifdigitsisnotNULL.
constvoid*digits
Read-onlyarrayofunsigneddigits. CanbeNULL.
intPyLong_Export(PyObject*obj,PyLongExport*export_long)
ExportaPythonintobject.
export_longmustpointtoaPyLongExportstructureallocatedbythecaller. ItmustnotbeNULL.
Onsuccess,fillin*export_longandreturn0. Onerror,setanexceptionandreturn-1.
PyLong_FreeExport()mustbecalledwhentheexportisnolongerneeded.
CPythonimplementationdetail: ThisfunctionalwayssucceedsifobjisaPythonintobjector
asubclass.
voidPyLong_FreeExport(PyLongExport*export_long)
Releasetheexportexport_longcreatedbyPyLong_Export().
CPython implementation detail: Calling PyLong_FreeExport() is optional if export_long->digits is
NULL.
PyLongWriterAPI
ThePyLongWriterAPIcanbeusedtoimportaninteger.
Addedinversion3.14.
structPyLongWriter
APythonintwriterinstance.
TheinstancemustbedestroyedbyPyLongWriter_Finish()orPyLongWriter_Discard().
PyLongWriter*PyLongWriter_Create(intnegative,Py_ssize_tndigits,void**digits)
CreateaPyLongWriter.
Onsuccess,allocate*digitsandreturnawriter. Onerror,setanexceptionandreturnNULL.
negativeis1ifthenumberisnegative,or0otherwise.
ndigitsisthenumberofdigitsinthedigitsarray. Itmustbegreaterthan0.
digitsmustnotbeNULL.
After a successful call to this function, the caller should fill in the array of digits digits and
then call PyLongWriter_Finish() to get a Python int. The layout of digits is described by
PyLong_GetNativeLayout().
Digitsmustbeintherange[0;(1 << bits_per_digit) - 1](wherethebits_per_digitisthenum-
berofbitsperdigit). Anyunusedmostsignificantdigitsmustbesetto0.
Alternately,callPyLongWriter_Discard()todestroythewriterinstancewithoutcreatinganintobject.
9.2. NumericObjects 149

### 第158页

PyObject*PyLongWriter_Finish(PyLongWriter*writer)
Returnvalue: Newreference. FinishaPyLongWritercreatedbyPyLongWriter_Create().
Onsuccess,returnaPythonintobject. Onerror,setanexceptionandreturnNULL.
Thefunctiontakescareofnormalizingthedigitsandconvertstheobjecttoacompactintegerifneeded.
Thewriterinstanceandthedigitsarrayareinvalidafterthecall.
voidPyLongWriter_Discard(PyLongWriter*writer)
DiscardaPyLongWritercreatedbyPyLongWriter_Create().
IfwriterisNULL,nooperationisperformed.
Thewriterinstanceandthedigitsarrayareinvalidafterthecall.
9.2.2 Boolean Objects
BooleansinPythonareimplementedasasubclassofintegers. Thereareonlytwobooleans,Py_FalseandPy_True.
As such, the normal creation and deletion functions don’t apply to booleans. The following macros are available,
however.
PyTypeObjectPyBool_Type
PartoftheStableABI.ThisinstanceofPyTypeObjectrepresentsthePythonbooleantype; itisthesame
objectasboolinthePythonlayer.
intPyBool_Check(PyObject*o)
ReturntrueifoisoftypePyBool_Type. Thisfunctionalwayssucceeds.
PyObject*Py_False
ThePythonFalseobject. Thisobjecthasnomethodsandisimmortal.
Changedinversion3.12: Py_Falseisimmortal.
PyObject*Py_True
ThePythonTrueobject. Thisobjecthasnomethodsandisimmortal.
Changedinversion3.12: Py_Trueisimmortal.
Py_RETURN_FALSE
ReturnPy_Falsefromafunction.
Py_RETURN_TRUE
ReturnPy_Truefromafunction.
PyObject*PyBool_FromLong(longv)
Returnvalue: Newreference. PartoftheStableABI.ReturnPy_TrueorPy_False,dependingonthetruth
valueofv.
9.2.3 Floating-Point Objects
typePyFloatObject
ThissubtypeofPyObjectrepresentsaPythonfloating-pointobject.
PyTypeObjectPyFloat_Type
PartoftheStableABI.ThisinstanceofPyTypeObjectrepresentsthePythonfloating-pointtype. Thisisthe
sameobjectasfloatinthePythonlayer.
intPyFloat_Check(PyObject*p)
Return true if its argument is a PyFloatObject or a subtype of PyFloatObject. This function always
succeeds.
150 Chapter9. ConcreteObjectsLayer

### 第159页

intPyFloat_CheckExact(PyObject*p)
ReturntrueifitsargumentisaPyFloatObject,butnotasubtypeofPyFloatObject. Thisfunctionalways
succeeds.
PyObject*PyFloat_FromString(PyObject*str)
Return value: New reference. Part of the Stable ABI. Create a PyFloatObject object based on the string
valueinstr,orNULLonfailure.
PyObject*PyFloat_FromDouble(doublev)
Returnvalue: Newreference. PartoftheStableABI.CreateaPyFloatObjectobjectfromv, orNULLon
failure.
doublePyFloat_AsDouble(PyObject*pyfloat)
PartoftheStableABI.ReturnaCdoublerepresentationofthecontentsofpyfloat. IfpyfloatisnotaPython
floating-pointobjectbuthasa__float__()method,thismethodwillfirstbecalledtoconvertpyfloat into
afloat. If__float__()isnotdefinedthenitfallsbackto__index__(). Thismethodreturns-1.0upon
failure,sooneshouldcallPyErr_Occurred()tocheckforerrors.
Changedinversion3.8: Use__index__()ifavailable.
doublePyFloat_AS_DOUBLE(PyObject*pyfloat)
ReturnaCdoublerepresentationofthecontentsofpyfloat,butwithouterrorchecking.
PyObject*PyFloat_GetInfo(void)
Returnvalue: Newreference. PartoftheStableABI.Returnastructseqinstancewhichcontainsinformation
about the precision, minimum and maximum values of a float. It’s a thin wrapper around the header file
float.h.
doublePyFloat_GetMax()
PartoftheStableABI.ReturnthemaximumrepresentablefinitefloatDBL_MAXasCdouble.
doublePyFloat_GetMin()
PartoftheStableABI.ReturntheminimumnormalizedpositivefloatDBL_MIN asCdouble.
PackandUnpackfunctions
Thepackandunpackfunctionsprovideanefficientplatform-independentwaytostorefloating-pointvaluesasbyte
strings. ThePackroutinesproduceabytesstringfromaCdouble,andtheUnpackroutinesproduceaCdouble
fromsuchabytesstring. Thesuffix(2,4or8)specifiesthenumberofbytesinthebytesstring.
On platforms that appear to use IEEE 754 formats these functions work by copying bits. On other platforms, the
2-byteformatisidenticaltotheIEEE754binary16half-precisionformat,the4-byteformat(32-bit)isidenticalto
theIEEE754binary32singleprecisionformat, andthe8-byteformattotheIEEE754binary64doubleprecision
format, although the packing of INFs and NaNs (if such things exist on the platform) isn’t handled correctly, and
attemptingtounpackabytesstringcontaininganIEEEINForNaNwillraiseanexception.
NotethatNaNstypemaynotbepreservedonIEEEplatforms(silentNaNbecomequiet),forexampleonx86systems
in32-bitmode.
Onnon-IEEEplatformswithmoreprecision,orlargerdynamicrange,thanIEEE754supports,notallvaluescanbe
packed;onnon-IEEEplatformswithlessprecision,orsmallerdynamicrange,notallvaluescanbeunpacked. What
happensinsuchcasesispartlyaccidental(alas).
Addedinversion3.11.
Packfunctions
Thepackroutineswrite2,4or8bytes,startingatp. leisanintargument,non-zeroifyouwantthebytesstringin
little-endianformat(exponentlast,atp+1,p+3,orp+6p+7),zeroifyouwantbig-endianformat(exponentfirst,at
p). ThePY_BIG_ENDIANconstantcanbeusedtousethenativeendian: itisequalto1onbigendianprocessor,or
0onlittleendianprocessor.
Returnvalue: 0ifallisOK,-1iferror(andanexceptionisset,mostlikelyOverflowError).
9.2. NumericObjects 151

### 第160页

Therearetwoproblemsonnon-IEEEplatforms:
• WhatthisdoesisundefinedifxisaNaNorinfinity.
• -0.0and+0.0producethesamebytesstring.
intPyFloat_Pack2(doublex,char*p,intle)
PackaCdoubleastheIEEE754binary16half-precisionformat.
intPyFloat_Pack4(doublex,char*p,intle)
PackaCdoubleastheIEEE754binary32singleprecisionformat.
intPyFloat_Pack8(doublex,char*p,intle)
PackaCdoubleastheIEEE754binary64doubleprecisionformat.
Unpackfunctions
The unpack routines read 2, 4 or 8 bytes, starting at p. le is an int argument, non-zero if the bytes string is in
little-endian format (exponent last, at p+1, p+3 or p+6 and p+7), zero if big-endian (exponent first, at p). The
PY_BIG_ENDIANconstantcanbeusedtousethenativeendian: itisequalto1onbigendianprocessor,or0onlittle
endianprocessor.
Returnvalue: Theunpackeddouble. Onerror,thisis-1.0andPyErr_Occurred()istrue(andanexceptionis
set,mostlikelyOverflowError).
Notethatonanon-IEEEplatformthiswillrefusetounpackabytesstringthatrepresentsaNaNorinfinity.
doublePyFloat_Unpack2(constchar*p,intle)
UnpacktheIEEE754binary16half-precisionformatasaCdouble.
doublePyFloat_Unpack4(constchar*p,intle)
UnpacktheIEEE754binary32singleprecisionformatasaCdouble.
doublePyFloat_Unpack8(constchar*p,intle)
UnpacktheIEEE754binary64doubleprecisionformatasaCdouble.
9.2.4 Complex Number Objects
Python’s complex number objects are implemented as two distinct types when viewed from the C API: one is the
PythonobjectexposedtoPythonprograms,andtheotherisaCstructurewhichrepresentstheactualcomplexnumber
value. TheAPIprovidesfunctionsforworkingwithboth.
ComplexNumbersasCStructures
Notethatthefunctionswhichacceptthesestructuresasparametersandreturnthemasresultsdosobyvaluerather
thandereferencingthemthroughpointers. ThisisconsistentthroughouttheAPI.
typePy_complex
The C structure which corresponds to the value portion of a Python complex number object. Most of the
functions for dealing with complex number objects use structures of this type as input or output values, as
appropriate.
doublereal
doubleimag
Thestructureisdefinedas:
typedef struct {
double real;
double imag;
} Py_complex;
152 Chapter9. ConcreteObjectsLayer

### 第161页

Py_complex_Py_c_sum(Py_complexleft,Py_complexright)
Returnthesumoftwocomplexnumbers,usingtheCPy_complexrepresentation.
Py_complex_Py_c_diff(Py_complexleft,Py_complexright)
Returnthedifferencebetweentwocomplexnumbers,usingtheCPy_complexrepresentation.
Py_complex_Py_c_neg(Py_complexnum)
Returnthenegationofthecomplexnumbernum,usingtheCPy_complexrepresentation.
Py_complex_Py_c_prod(Py_complexleft,Py_complexright)
Returntheproductoftwocomplexnumbers,usingtheCPy_complexrepresentation.
Py_complex_Py_c_quot(Py_complexdividend,Py_complexdivisor)
Returnthequotientoftwocomplexnumbers,usingtheCPy_complexrepresentation.
Ifdivisorisnull,thismethodreturnszeroandsetserrnotoEDOM.
Py_complex_Py_c_pow(Py_complexnum,Py_complexexp)
Returntheexponentiationofnumbyexp,usingtheCPy_complexrepresentation.
Ifnumisnullandexpisnotapositiverealnumber,thismethodreturnszeroandsetserrnotoEDOM.
SeterrnotoERANGEonoverflows.
ComplexNumbersasPythonObjects
typePyComplexObject
ThissubtypeofPyObjectrepresentsaPythoncomplexnumberobject.
PyTypeObjectPyComplex_Type
PartoftheStableABI.ThisinstanceofPyTypeObjectrepresentsthePythoncomplexnumbertype. Itisthe
sameobjectascomplexinthePythonlayer.
intPyComplex_Check(PyObject*p)
ReturntrueifitsargumentisaPyComplexObjectorasubtypeofPyComplexObject. Thisfunctionalways
succeeds.
intPyComplex_CheckExact(PyObject*p)
ReturntrueifitsargumentisaPyComplexObject,butnotasubtypeofPyComplexObject. Thisfunction
alwayssucceeds.
PyObject*PyComplex_FromCComplex(Py_complexv)
Return value: New reference. Create a new Python complex number object from a C Py_complex value.
ReturnNULLwithanexceptionsetonerror.
PyObject*PyComplex_FromDoubles(doublereal,doubleimag)
Returnvalue: Newreference. PartoftheStableABI.ReturnanewPyComplexObjectobjectfromrealand
imag. ReturnNULLwithanexceptionsetonerror.
doublePyComplex_RealAsDouble(PyObject*op)
PartoftheStableABI.ReturntherealpartofopasaCdouble.
If op is not a Python complex number object but has a __complex__() method, this method will first be
calledtoconvertoptoaPythoncomplexnumberobject. If__complex__()isnotdefinedthenitfallsback
tocallPyFloat_AsDouble()andreturnsitsresult.
Upon failure, this method returns -1.0 with an exception set, so one should call PyErr_Occurred() to
checkforerrors.
Changedinversion3.13: Use__complex__()ifavailable.
9.2. NumericObjects 153

### 第162页

doublePyComplex_ImagAsDouble(PyObject*op)
PartoftheStableABI.ReturntheimaginarypartofopasaCdouble.
If op is not a Python complex number object but has a __complex__() method, this method will first be
calledtoconvertoptoaPythoncomplexnumberobject. If__complex__()isnotdefinedthenitfallsback
tocallPyFloat_AsDouble()andreturns0.0onsuccess.
Upon failure, this method returns -1.0 with an exception set, so one should call PyErr_Occurred() to
checkforerrors.
Changedinversion3.13: Use__complex__()ifavailable.
Py_complexPyComplex_AsCComplex(PyObject*op)
ReturnthePy_complexvalueofthecomplexnumberop.
If op is not a Python complex number object but has a __complex__() method, this method will first be
calledtoconvertoptoaPythoncomplexnumberobject. If__complex__()isnotdefinedthenitfallsback
to__float__(). If__float__()isnotdefinedthenitfallsbackto__index__().
Uponfailure,thismethodreturnsPy_complexwithrealsetto-1.0andwithanexceptionset,sooneshould
callPyErr_Occurred()tocheckforerrors.
Changedinversion3.8: Use__index__()ifavailable.
9.3 Sequence Objects
Genericoperationsonsequenceobjectswerediscussedinthepreviouschapter; thissectiondealswiththespecific
kindsofsequenceobjectsthatareintrinsictothePythonlanguage.
9.3.1 Bytes Objects
ThesefunctionsraiseTypeErrorwhenexpectingabytesparameterandcalledwithanon-bytesparameter.
typePyBytesObject
ThissubtypeofPyObjectrepresentsaPythonbytesobject.
PyTypeObjectPyBytes_Type
PartoftheStableABI.ThisinstanceofPyTypeObjectrepresentsthePythonbytestype;itisthesameobject
asbytesinthePythonlayer.
intPyBytes_Check(PyObject*o)
Returntrueiftheobjectoisabytesobjectoraninstanceofasubtypeofthebytestype. Thisfunctionalways
succeeds.
intPyBytes_CheckExact(PyObject*o)
Returntrueiftheobjectoisabytesobject,butnotaninstanceofasubtypeofthebytestype. Thisfunction
alwayssucceeds.
PyObject*PyBytes_FromString(constchar*v)
Returnvalue: Newreference. PartoftheStableABI.Returnanewbytesobjectwithacopyofthestringvas
valueonsuccess,andNULLonfailure. TheparametervmustnotbeNULL;itwillnotbechecked.
PyObject*PyBytes_FromStringAndSize(constchar*v,Py_ssize_tlen)
Return value: New reference. Part of the Stable ABI. Return a new bytes object with a copy of the string v
as value and length len on success, and NULL on failure. If v is NULL, the contents of the bytes object are
uninitialized.
PyObject*PyBytes_FromFormat(constchar*format,...)
Returnvalue: Newreference. PartoftheStableABI.TakeaCprintf()-styleformat stringandavariable
numberofarguments,calculatethesizeoftheresultingPythonbytesobjectandreturnabytesobjectwiththe
valuesformattedintoit. ThevariableargumentsmustbeCtypesandmustcorrespondexactlytotheformat
charactersintheformatstring. Thefollowingformatcharactersareallowed:
154 Chapter9. ConcreteObjectsLayer

### 第163页

FormatCharacters Type Comment
%% n/a Theliteral%character.
%c int Asinglebyte,representedasaCint.
%d int Equivalenttoprintf("%d").1
%u unsignedint Equivalenttoprintf("%u").1
%ld long Equivalenttoprintf("%ld").1
%lu unsignedlong Equivalenttoprintf("%lu").1
%zd Py_ssize_t Equivalenttoprintf("%zd").1
%zu size_t Equivalenttoprintf("%zu").1
%i int Equivalenttoprintf("%i").1
%x int Equivalenttoprintf("%x").1
%s constchar* Anull-terminatedCcharacterarray.
%p constvoid* ThehexrepresentationofaCpointer. Mostlyequivalentto
printf("%p")exceptthatitisguaranteedtostartwiththe
literal0xregardlessofwhattheplatform’sprintfyields.
Anunrecognizedformatcharactercausesalltherestoftheformatstringtobecopiedas-istotheresultobject,
andanyextraargumentsdiscarded.
PyObject*PyBytes_FromFormatV(constchar*format,va_listvargs)
Return value: New reference. Part of the Stable ABI. Identical to PyBytes_FromFormat() except that it
takesexactlytwoarguments.
PyObject*PyBytes_FromObject(PyObject*o)
Returnvalue:Newreference. PartoftheStableABI.Returnthebytesrepresentationofobjectothatimplements
thebufferprotocol.
Py_ssize_tPyBytes_Size(PyObject*o)
PartoftheStableABI.Returnthelengthofthebytesinbytesobjecto.
Py_ssize_tPyBytes_GET_SIZE(PyObject*o)
SimilartoPyBytes_Size(),butwithouterrorchecking.
char*PyBytes_AsString(PyObject*o)
Part of the Stable ABI. Return a pointer to the contents of o. The pointer refers to the internal buffer of o,
whichconsistsoflen(o) + 1bytes. Thelastbyteinthebufferisalwaysnull, regardlessofwhetherthere
areanyothernullbytes. Thedatamustnotbemodifiedinanyway,unlesstheobjectwasjustcreatedusing
PyBytes_FromStringAndSize(NULL, size). Itmustnotbedeallocated. Ifoisnotabytesobjectatall,
PyBytes_AsString()returnsNULLandraisesTypeError.
char*PyBytes_AS_STRING(PyObject*string)
SimilartoPyBytes_AsString(),butwithouterrorchecking.
intPyBytes_AsStringAndSize(PyObject*obj,char**buffer,Py_ssize_t*length)
PartoftheStableABI.Returnthenull-terminatedcontentsoftheobjectobjthroughtheoutputvariablesbuffer
andlength. Returns0onsuccess.
IflengthisNULL,thebytesobjectmaynotcontainembeddednullbytes;ifitdoes,thefunctionreturns-1and
aValueErrorisraised.
The buffer refers to an internal buffer of obj, which includes an additional null byte at the end (not
counted in length). The data must not be modified in any way, unless the object was just created using
PyBytes_FromStringAndSize(NULL, size). It must not be deallocated. If obj is not a bytes object
atall,PyBytes_AsStringAndSize()returns-1andraisesTypeError.
Changedinversion3.5: Previously,TypeErrorwasraisedwhenembeddednullbyteswereencounteredin
thebytesobject.
1Forintegerspecifiers(d,u,ld,lu,zd,zu,i,x):the0-conversionflaghaseffectevenwhenaprecisionisgiven.
9.3. SequenceObjects 155

| FormatCharacters | Type | Comment |
| --- | --- | --- |
| %% | n/a | Theliteral%character. |
| %c | int | Asinglebyte,representedasaCint. |
| %d | int | Equivalenttoprintf("%d").1 |
| %u | unsignedint | Equivalenttoprintf("%u").1 |
| %ld | long | Equivalenttoprintf("%ld").1 |
| %lu | unsignedlong | Equivalenttoprintf("%lu").1 |
| %zd | Py_ssize_t | Equivalenttoprintf("%zd").1 |
| %zu | size_t | Equivalenttoprintf("%zu").1 |
| %i | int | Equivalenttoprintf("%i").1 |
| %x | int | Equivalenttoprintf("%x").1 |
| %s | constchar* | Anull-terminatedCcharacterarray. |
| %p | constvoid* | ThehexrepresentationofaCpointer. Mostlyequivalentto
printf("%p")exceptthatitisguaranteedtostartwiththe
literal0xregardlessofwhattheplatform’sprintfyields. |

### 第164页

voidPyBytes_Concat(PyObject**bytes,PyObject*newpart)
Partofthe StableABI.Createanewbytesobjectin*bytes containingthecontentsofnewpart appendedto
bytes;thecallerwillownthenewreference. Thereferencetotheoldvalueofbyteswillbestolen. Ifthenew
objectcannotbecreated,theoldreferencetobyteswillstillbediscardedandthevalueof*byteswillbesetto
NULL;theappropriateexceptionwillbeset.
voidPyBytes_ConcatAndDel(PyObject**bytes,PyObject*newpart)
Partofthe StableABI.Createanewbytesobjectin*bytes containingthecontentsofnewpart appendedto
bytes. Thisversionreleasesthestrongreferencetonewpart(i.e. decrementsitsreferencecount).
PyObject*PyBytes_Join(PyObject*sep,PyObject*iterable)
Similartosep.join(iterable)inPython.
sepmustbePythonbytesobject. (NotethatPyUnicode_Join()acceptsNULLseparatorandtreatsitasa
space,whereasPyBytes_Join()doesn’tacceptNULLseparator.)
iterablemustbeaniterableobjectyieldingobjectsthatimplementthebufferprotocol.
Onsuccess,returnanewbytesobject. Onerror,setanexceptionandreturnNULL.
Addedinversion3.14.
int_PyBytes_Resize(PyObject**bytes,Py_ssize_tnewsize)
Resizeabytesobject. newsizewillbethenewlengthofthebytesobject. Youcanthinkofitascreatinganew
bytesobjectanddestroyingtheoldone,onlymoreefficiently. Passtheaddressofanexistingbytesobjectas
anlvalue(itmaybewritteninto),andthenewsizedesired. Onsuccess,*bytesholdstheresizedbytesobject
and0isreturned; theaddressin*bytesmaydifferfromitsinputvalue. Ifthereallocationfails, theoriginal
bytesobjectat*bytesisdeallocated,*bytesissettoNULL,MemoryErrorisset,and-1isreturned.
9.3.2 Byte Array Objects
typePyByteArrayObject
ThissubtypeofPyObjectrepresentsaPythonbytearrayobject.
PyTypeObjectPyByteArray_Type
PartoftheStableABI.ThisinstanceofPyTypeObjectrepresentsthePythonbytearraytype;itisthesame
objectasbytearrayinthePythonlayer.
Typecheckmacros
intPyByteArray_Check(PyObject*o)
Returntrueiftheobjectoisabytearrayobjectoraninstanceofasubtypeofthebytearraytype. Thisfunction
alwayssucceeds.
intPyByteArray_CheckExact(PyObject*o)
Returntrueiftheobjectoisabytearrayobject,butnotaninstanceofasubtypeofthebytearraytype. This
functionalwayssucceeds.
DirectAPIfunctions
PyObject*PyByteArray_FromObject(PyObject*o)
Returnvalue: Newreference. PartoftheStableABI.Returnanewbytearrayobjectfromanyobject,o,that
implementsthebufferprotocol.
Onfailure,returnNULLwithanexceptionset.
PyObject*PyByteArray_FromStringAndSize(constchar*string,Py_ssize_tlen)
Returnvalue: Newreference. PartoftheStableABI.Createanewbytearrayobjectfromstringanditslength,
len.
Onfailure,returnNULLwithanexceptionset.
156 Chapter9. ConcreteObjectsLayer

### 第165页

PyObject*PyByteArray_Concat(PyObject*a,PyObject*b)
Returnvalue: Newreference. Partofthe StableABI. Concatbytearrays a and b andreturnanewbytearray
withtheresult.
Onfailure,returnNULLwithanexceptionset.
Py_ssize_tPyByteArray_Size(PyObject*bytearray)
PartoftheStableABI.ReturnthesizeofbytearrayaftercheckingforaNULLpointer.
char*PyByteArray_AsString(PyObject*bytearray)
PartoftheStableABI.ReturnthecontentsofbytearrayasachararrayaftercheckingforaNULLpointer. The
returnedarrayalwayshasanextranullbyteappended.
intPyByteArray_Resize(PyObject*bytearray,Py_ssize_tlen)
PartoftheStableABI.Resizetheinternalbufferofbytearraytolen. Failureisa-1returnwithanexception
set.
Changedinversion3.14: Anegativelenwillnowresultinanexceptionbeingsetand-1returned.
Macros
Thesemacrostradesafetyforspeedandtheydon’tcheckpointers.
char*PyByteArray_AS_STRING(PyObject*bytearray)
SimilartoPyByteArray_AsString(),butwithouterrorchecking.
Py_ssize_tPyByteArray_GET_SIZE(PyObject*bytearray)
SimilartoPyByteArray_Size(),butwithouterrorchecking.
9.3.3 Unicode Objects and Codecs
UnicodeObjects
SincetheimplementationofPEP393inPython3.3,Unicodeobjectsinternallyuseavarietyofrepresentations,in
ordertoallowhandlingthecompleterangeofUnicodecharacterswhilestayingmemoryefficient. Therearespecial
casesforstringswhereallcodepointsarebelow128,256,or65536;otherwise,codepointsmustbebelow1114112
(whichisthefullUnicoderange).
UTF-8representationiscreatedondemandandcachedintheUnicodeobject.
(cid:174) Note
ThePy_UNICODErepresentationhasbeenremovedsincePython3.12withdeprecatedAPIs. SeePEP623for
moreinformation.
UnicodeType
ThesearethebasicUnicodeobjecttypesusedfortheUnicodeimplementationinPython:
PyTypeObjectPyUnicode_Type
PartoftheStableABI.ThisinstanceofPyTypeObjectrepresentsthePythonUnicodetype. Itisexposedto
Pythoncodeasstr.
PyTypeObjectPyUnicodeIter_Type
Part of the Stable ABI. This instance of PyTypeObject represents the Python Unicode iterator type. It is
usedtoiterateoverUnicodestringobjects.
typePy_UCS4
typePy_UCS2
9.3. SequenceObjects 157

### 第166页

typePy_UCS1
PartoftheStableABI.Thesetypesaretypedefsforunsignedintegertypeswideenoughtocontaincharacters
of32bits,16bitsand8bits,respectively. WhendealingwithsingleUnicodecharacters,usePy_UCS4.
Addedinversion3.3.
typePyASCIIObject
typePyCompactUnicodeObject
typePyUnicodeObject
ThesesubtypesofPyObjectrepresentaPythonUnicodeobject. Inalmostallcases,theyshouldn’tbeused
directly,sinceallAPIfunctionsthatdealwithUnicodeobjectstakeandreturnPyObjectpointers.
Addedinversion3.3.
ThefollowingAPIsareCmacrosandstaticinlinedfunctionsforfastchecksandaccesstointernalread-onlydataof
Unicodeobjects:
intPyUnicode_Check(PyObject*obj)
Returntrue iftheobject obj isa UnicodeobjectoraninstanceofaUnicodesubtype. Thisfunctionalways
succeeds.
intPyUnicode_CheckExact(PyObject*obj)
Return true if the object obj is a Unicode object, but not an instance of a subtype. This function always
succeeds.
Py_ssize_tPyUnicode_GET_LENGTH(PyObject*unicode)
ReturnthelengthoftheUnicodestring,incodepoints. unicodehastobeaUnicodeobjectinthe“canonical”
representation(notchecked).
Addedinversion3.3.
Py_UCS1*PyUnicode_1BYTE_DATA(PyObject*unicode)
Py_UCS2*PyUnicode_2BYTE_DATA(PyObject*unicode)
Py_UCS4*PyUnicode_4BYTE_DATA(PyObject*unicode)
ReturnapointertothecanonicalrepresentationcasttoUCS1,UCS2orUCS4integertypesfordirectchar-
acter access. No checks are performed if the canonical representation has the correct character size; use
PyUnicode_KIND()toselecttherightfunction.
Addedinversion3.3.
PyUnicode_1BYTE_KIND
PyUnicode_2BYTE_KIND
PyUnicode_4BYTE_KIND
ReturnvaluesofthePyUnicode_KIND()macro.
Addedinversion3.3.
Changedinversion3.12: PyUnicode_WCHAR_KINDhasbeenremoved.
intPyUnicode_KIND(PyObject*unicode)
Return one of the PyUnicode kind constants (see above) that indicate how many bytes per character this
Unicodeobjectusestostoreitsdata. unicodehastobeaUnicodeobjectinthe“canonical”representation(not
checked).
Addedinversion3.3.
void*PyUnicode_DATA(PyObject*unicode)
ReturnavoidpointertotherawUnicodebuffer. unicodehastobeaUnicodeobjectinthe“canonical”repre-
sentation(notchecked).
Addedinversion3.3.
158 Chapter9. ConcreteObjectsLayer

### 第167页

voidPyUnicode_WRITE(intkind,void*data,Py_ssize_tindex,Py_UCS4value)
Writethecodepointvaluetothegivenzero-basedindexinastring.
The kind value and data pointer must have been obtained from a string using PyUnicode_KIND()
and PyUnicode_DATA() respectively. You must hold a reference to that string while calling
PyUnicode_WRITE(). AllrequirementsofPyUnicode_WriteChar()alsoapply.
Thefunctionperformsnochecksforanyofitsrequirements,andisintendedforusageinloops.
Addedinversion3.3.
Py_UCS4PyUnicode_READ(intkind,void*data,Py_ssize_tindex)
Readacodepointfromacanonicalrepresentationdata(asobtainedwithPyUnicode_DATA()). Nochecks
orreadycallsareperformed.
Addedinversion3.3.
Py_UCS4PyUnicode_READ_CHAR(PyObject*unicode,Py_ssize_tindex)
ReadacharacterfromaUnicodeobjectunicode,whichmustbeinthe“canonical”representation. Thisisless
efficientthanPyUnicode_READ()ifyoudomultipleconsecutivereads.
Addedinversion3.3.
Py_UCS4PyUnicode_MAX_CHAR_VALUE(PyObject*unicode)
Returnthemaximumcodepointthatissuitableforcreatinganotherstringbasedonunicode,whichmustbe
inthe“canonical”representation. Thisisalwaysanapproximationbutmoreefficientthaniteratingoverthe
string.
Addedinversion3.3.
intPyUnicode_IsIdentifier(PyObject*unicode)
PartoftheStableABI.Return1ifthestringisavalididentifieraccordingtothelanguagedefinition,section
identifiers. Return0otherwise.
Changedinversion3.9: ThefunctiondoesnotcallPy_FatalError()anymoreifthestringisnotready.
unsignedintPyUnicode_IS_ASCII(PyObject*unicode)
ReturntrueifthestringonlycontainsASCIIcharacters. Equivalenttostr.isascii().
Addedinversion3.2.
UnicodeCharacterProperties
Unicodeprovidesmanydifferentcharacterproperties. Themostoftenneededonesareavailablethroughthesemacros
whicharemappedtoCfunctionsdependingonthePythonconfiguration.
intPy_UNICODE_ISSPACE(Py_UCS4ch)
Return1or0dependingonwhetherchisawhitespacecharacter.
intPy_UNICODE_ISLOWER(Py_UCS4ch)
Return1or0dependingonwhetherchisalowercasecharacter.
intPy_UNICODE_ISUPPER(Py_UCS4ch)
Return1or0dependingonwhetherchisanuppercasecharacter.
intPy_UNICODE_ISTITLE(Py_UCS4ch)
Return1or0dependingonwhetherchisatitlecasecharacter.
intPy_UNICODE_ISLINEBREAK(Py_UCS4ch)
Return1or0dependingonwhetherchisalinebreakcharacter.
intPy_UNICODE_ISDECIMAL(Py_UCS4ch)
Return1or0dependingonwhetherchisadecimalcharacter.
9.3. SequenceObjects 159

### 第168页

intPy_UNICODE_ISDIGIT(Py_UCS4ch)
Return1or0dependingonwhetherchisadigitcharacter.
intPy_UNICODE_ISNUMERIC(Py_UCS4ch)
Return1or0dependingonwhetherchisanumericcharacter.
intPy_UNICODE_ISALPHA(Py_UCS4ch)
Return1or0dependingonwhetherchisanalphabeticcharacter.
intPy_UNICODE_ISALNUM(Py_UCS4ch)
Return1or0dependingonwhetherchisanalphanumericcharacter.
intPy_UNICODE_ISPRINTABLE(Py_UCS4ch)
Return1or0dependingonwhetherchisaprintablecharacter,inthesenseofstr.isprintable().
TheseAPIscanbeusedforfastdirectcharacterconversions:
Py_UCS4Py_UNICODE_TOLOWER(Py_UCS4ch)
Returnthecharacterchconvertedtolowercase.
Py_UCS4Py_UNICODE_TOUPPER(Py_UCS4ch)
Returnthecharacterchconvertedtouppercase.
Py_UCS4Py_UNICODE_TOTITLE(Py_UCS4ch)
Returnthecharacterchconvertedtotitlecase.
intPy_UNICODE_TODECIMAL(Py_UCS4ch)
Returnthecharacterchconvertedtoadecimalpositiveinteger. Return-1ifthisisnotpossible. Thisfunction
doesnotraiseexceptions.
intPy_UNICODE_TODIGIT(Py_UCS4ch)
Returnthecharacterchconvertedtoasingledigitinteger. Return-1ifthisisnotpossible. Thisfunctiondoes
notraiseexceptions.
doublePy_UNICODE_TONUMERIC(Py_UCS4ch)
Returnthecharacterchconvertedtoadouble. Return-1.0ifthisisnotpossible. Thisfunctiondoesnotraise
exceptions.
TheseAPIscanbeusedtoworkwithsurrogates:
intPy_UNICODE_IS_SURROGATE(Py_UCS4ch)
Checkifchisasurrogate(0xD800 <= ch <= 0xDFFF).
intPy_UNICODE_IS_HIGH_SURROGATE(Py_UCS4ch)
Checkifchisahighsurrogate(0xD800 <= ch <= 0xDBFF).
intPy_UNICODE_IS_LOW_SURROGATE(Py_UCS4ch)
Checkifchisalowsurrogate(0xDC00 <= ch <= 0xDFFF).
Py_UCS4Py_UNICODE_JOIN_SURROGATES(Py_UCS4high,Py_UCS4low)
JointwosurrogatecodepointsandreturnasinglePy_UCS4value. highandlowarerespectivelytheleading
andtrailingsurrogatesinasurrogatepair. highmustbeintherange[0xD800;0xDBFF]andlowmustbein
therange[0xDC00;0xDFFF].
CreatingandaccessingUnicodestrings
TocreateUnicodeobjectsandaccesstheirbasicsequenceproperties,usetheseAPIs:
PyObject*PyUnicode_New(Py_ssize_tsize,Py_UCS4maxchar)
Returnvalue: Newreference. CreateanewUnicodeobject. maxcharshouldbethetruemaximumcodepoint
tobeplacedinthestring. Asanapproximation,itcanberoundeduptothenearestvalueinthesequence127,
255,65535,1114111.
160 Chapter9. ConcreteObjectsLayer

### 第169页

Onerror,setanexceptionandreturnNULL.
Aftercreation, thestringcanbefilledbyPyUnicode_WriteChar(), PyUnicode_CopyCharacters(),
PyUnicode_Fill(), PyUnicode_WRITE() or similar. Since strings are supposed to be immutable, take
caretonot“use”theresultwhileitisbeingmodified. Inparticular,beforeit’sfilledwithitsfinalcontents,a
string:
• mustnotbehashed,
• mustnotbeconverted to UTF-8,oranothernon-“canonical”representation,
• mustnothaveitsreferencecountchanged,
• mustnotbesharedwithcodethatmightdooneoftheabove.
This list is not exhaustive. Avoiding these uses is your responsibility; Python does not always check these
requirements.
Toavoidaccidentallyexposingapartially-writtenstringobject,preferusingthePyUnicodeWriterAPI,or
oneofthePyUnicode_From*functionsbelow.
Addedinversion3.3.
PyObject*PyUnicode_FromKindAndData(intkind,constvoid*buffer,Py_ssize_tsize)
Return value: New reference. Create a new Unicode object with the given kind (possible values are
PyUnicode_1BYTE_KIND etc., as returned by PyUnicode_KIND()). The buffer must point to an array
ofsizeunitsof1,2or4bytespercharacter,asgivenbythekind.
Ifnecessary,theinputbufferiscopiedandtransformedintothecanonicalrepresentation. Forexample,ifthe
bufferisaUCS4string(PyUnicode_4BYTE_KIND)anditconsistsonlyofcodepointsintheUCS1range,it
willbetransformedintoUCS1(PyUnicode_1BYTE_KIND).
Addedinversion3.3.
PyObject*PyUnicode_FromStringAndSize(constchar*str,Py_ssize_tsize)
Returnvalue: Newreference. PartoftheStableABI.CreateaUnicodeobjectfromthecharbufferstr. The
byteswillbeinterpretedasbeingUTF-8encoded. Thebufferiscopiedintothenewobject. Thereturnvalue
mightbeasharedobject,i.e. modificationofthedataisnotallowed.
ThisfunctionraisesSystemErrorwhen:
• size<0,
• strisNULLandsize>0
Changedinversion3.12: str==NULLwithsize>0isnotallowedanymore.
PyObject*PyUnicode_FromString(constchar*str)
Return value: New reference. Part of the Stable ABI. Create a Unicode object from a UTF-8 encoded null-
terminatedcharbufferstr.
PyObject*PyUnicode_FromFormat(constchar*format,...)
Returnvalue: Newreference. PartoftheStableABI.TakeaCprintf()-styleformat stringandavariable
number of arguments, calculate the size of the resulting Python Unicode string and return a string with the
valuesformattedintoit. ThevariableargumentsmustbeCtypesandmustcorrespondexactlytotheformat
charactersintheformatASCII-encodedstring.
Aconversionspecifiercontainstwoormorecharactersandhasthefollowingcomponents,whichmustoccur
inthisorder:
1. The'%'character,whichmarksthestartofthespecifier.
2. Conversionflags(optional),whichaffecttheresultofsomeconversiontypes.
3. Minimumfieldwidth(optional). Ifspecifiedasan'*'(asterisk),theactualwidthisgiveninthenext
argument, whichmustbeoftypeint, andtheobjecttoconvertcomesaftertheminimumfieldwidth
andoptionalprecision.
9.3. SequenceObjects 161

### 第170页

4. Precision (optional), given as a '.' (dot) followed by the precision. If specified as '*' (an asterisk),
theactualprecisionisgiveninthenextargument,whichmustbeoftypeint,andthevaluetoconvert
comesaftertheprecision.
5. Lengthmodifier(optional).
6. Conversiontype.
Theconversionflagcharactersare:
Flag Meaning
0 Theconversionwillbezeropaddedfornumericvalues.
- Theconvertedvalueisleftadjusted(overridesthe0flagifbotharegiven).
Thelengthmodifiersforfollowingintegerconversions(d, i, o, u, x, orX)specifythetypeoftheargument
(intbydefault):
Modifier Types
l longorunsigned long
ll long longorunsigned long long
j intmax_toruintmax_t
z size_torssize_t
t ptrdiff_t
The length modifier l for following conversions s or V specify that the type of the argument is const
wchar_t*.
Theconversionspecifiersare:
162 Chapter9. ConcreteObjectsLayer

| Flag | Meaning |
| --- | --- |
| 0 | Theconversionwillbezeropaddedfornumericvalues. |
| - | Theconvertedvalueisleftadjusted(overridesthe0flagifbotharegiven). |


| Modifier | Types |
| --- | --- |
| l | longorunsigned long |
| ll | long longorunsigned long long |
| j | intmax_toruintmax_t |
| z | size_torssize_t |
| t | ptrdiff_t |

### 第171页

Con- Type Comment
version
Speci-
fier
% n/a Theliteral%character.
d,i Specified by the ThedecimalrepresentationofasignedCinteger.
lengthmodifier
u Specified by the ThedecimalrepresentationofanunsignedCinteger.
lengthmodifier
o Specified by the TheoctalrepresentationofanunsignedCinteger.
lengthmodifier
x Specified by the ThehexadecimalrepresentationofanunsignedCinteger(lowercase).
lengthmodifier
X Specified by the ThehexadecimalrepresentationofanunsignedCinteger(uppercase).
lengthmodifier
c int Asinglecharacter.
s const char* or Anull-terminatedCcharacterarray.
const wchar_t*
p const void* The hex representation of a C pointer. Mostly equivalent to
printf("%p")exceptthatitisguaranteedtostartwiththeliteral0x
regardlessofwhattheplatform’sprintfyields.
A PyObject* Theresultofcallingascii().
U PyObject* AUnicodeobject.
V PyObject*, AUnicodeobject(whichmaybeNULL)andanull-terminatedCchar-
const char* or acter array as a second parameter (which will be used, if the first pa-
const wchar_t* rameterisNULL).
S PyObject* TheresultofcallingPyObject_Str().
R PyObject* TheresultofcallingPyObject_Repr().
T PyObject* Get the fully qualified name of an object type; call
PyType_GetFullyQualifiedName().
#T PyObject* SimilartoTformat,butuseacolon(:)asseparatorbetweenthemodule
nameandthequalifiedname.
N PyTypeObject* Get the fully qualified name of a type; call
PyType_GetFullyQualifiedName().
#N PyTypeObject* SimilartoNformat,butuseacolon(:)asseparatorbetweenthemodule
nameandthequalifiedname.
(cid:174) Note
Thewidthformatterunitisnumberofcharactersratherthanbytes. Theprecisionformatterunitisnumber
of bytes or wchar_t items (if the length modifier l is used) for "%s" and "%V" (if the PyObject*
argumentisNULL),andanumberofcharactersfor"%A","%U","%S","%R"and"%V"(ifthePyObject*
argumentisnotNULL).
(cid:174) Note
UnliketoCprintf()the0flaghaseffectevenwhenaprecisionisgivenforintegerconversions(d,i,u,
o,x,orX).
Changedinversion3.2: Supportfor"%lld"and"%llu"added.
Changedinversion3.3: Supportfor"%li","%lli"and"%zi"added.
Changed in version 3.4: Support width and precision formatter for "%s", "%A", "%U", "%V", "%S", "%R"
9.3. SequenceObjects 163

| Con-
version
Speci-
fier | Type | Comment |
| --- | --- | --- |
| % | n/a | Theliteral%character. |
| d,i | Specified by the
lengthmodifier | ThedecimalrepresentationofasignedCinteger. |
| u | Specified by the
lengthmodifier | ThedecimalrepresentationofanunsignedCinteger. |
| o | Specified by the
lengthmodifier | TheoctalrepresentationofanunsignedCinteger. |
| x | Specified by the
lengthmodifier | ThehexadecimalrepresentationofanunsignedCinteger(lowercase). |
| X | Specified by the
lengthmodifier | ThehexadecimalrepresentationofanunsignedCinteger(uppercase). |
| c | int | Asinglecharacter. |
| s | const char* or
const wchar_t* | Anull-terminatedCcharacterarray. |
| p | const void* | The hex representation of a C pointer. Mostly equivalent to
printf("%p")exceptthatitisguaranteedtostartwiththeliteral0x
regardlessofwhattheplatform’sprintfyields. |
| A | PyObject* | Theresultofcallingascii(). |
| U | PyObject* | AUnicodeobject. |
| V | PyObject*,
const char* or
const wchar_t* | AUnicodeobject(whichmaybeNULL)andanull-terminatedCchar-
acter array as a second parameter (which will be used, if the first pa-
rameterisNULL). |
| S | PyObject* | TheresultofcallingPyObject_Str(). |
| R | PyObject* | TheresultofcallingPyObject_Repr(). |
| T | PyObject* | Get the fully qualified name of an object type; call
PyType_GetFullyQualifiedName(). |
| #T | PyObject* | SimilartoTformat,butuseacolon(:)asseparatorbetweenthemodule
nameandthequalifiedname. |
| N | PyTypeObject* | Get the fully qualified name of a type; call
PyType_GetFullyQualifiedName(). |
| #N | PyTypeObject* | SimilartoNformat,butuseacolon(:)asseparatorbetweenthemodule
nameandthequalifiedname. |

### 第172页

added.
Changed in version 3.12: Support for conversion specifiers o and X. Support for length modifiers j and t.
Lengthmodifiersarenowappliedtoallintegerconversions. Lengthmodifierlisnowappliedtoconversion
specifierssandV.Supportforvariablewidthandprecision*. Supportforflag-.
AnunrecognizedformatcharacternowsetsaSystemError. Inpreviousversionsitcausedalltherestofthe
formatstringtobecopiedas-istotheresultstring,andanyextraargumentsdiscarded.
Changedinversion3.13: Supportfor%T,%#T,%Nand%#Nformatsadded.
PyObject*PyUnicode_FromFormatV(constchar*format,va_listvargs)
Returnvalue: Newreference. PartoftheStableABI.IdenticaltoPyUnicode_FromFormat()exceptthatit
takesexactlytwoarguments.
PyObject*PyUnicode_FromObject(PyObject*obj)
Return value: New reference. Part of the Stable ABI. Copy an instance of a Unicode subtype to a new true
Unicodeobjectifnecessary. IfobjisalreadyatrueUnicodeobject(notasubtype),returnanewstrongreference
totheobject.
ObjectsotherthanUnicodeoritssubtypeswillcauseaTypeError.
PyObject*PyUnicode_FromOrdinal(intordinal)
Returnvalue: Newreference. PartoftheStableABI.CreateaUnicodeObjectfromthegivenUnicodecode
pointordinal.
Theordinalmustbeinrange(0x110000). AValueErrorisraisedinthecaseitisnot.
PyObject*PyUnicode_FromEncodedObject(PyObject*obj,constchar*encoding,constchar*errors)
Returnvalue: Newreference. PartoftheStableABI.DecodeanencodedobjectobjtoaUnicodeobject.
bytes, bytearray and other bytes-like objects are decoded according to the given encoding and using the
errorhandlingdefinedbyerrors. BothcanbeNULLtohavetheinterfaceusethedefaultvalues(seeBuilt-in
Codecsfordetails).
Allotherobjects,includingUnicodeobjects,causeaTypeErrortobeset.
TheAPIreturnsNULLiftherewasanerror. Thecallerisresponsiblefordecref’ingthereturnedobjects.
voidPyUnicode_Append(PyObject**p_left,PyObject*right)
PartoftheStableABI.Appendthestringrighttotheendofp_left. p_leftmustpointtoastrongreferencetoa
Unicodeobject;PyUnicode_Append()releases(“steals”)thisreference.
Onerror,set*p_lefttoNULLandsetanexception.
Onsuccess,set*p_lefttoanewstrongreferencetotheresult.
voidPyUnicode_AppendAndDel(PyObject**p_left,PyObject*right)
PartoftheStableABI.ThefunctionissimilartoPyUnicode_Append(),withtheonlydifferencebeingthat
itdecrementsthereferencecountofrightbyone.
PyObject*PyUnicode_BuildEncodingMap(PyObject*string)
Returnvalue: Newreference. PartoftheStableABI.Returnamappingsuitablefordecodingacustomsingle-
byteencoding. GivenaUnicodestringstringofupto256charactersrepresentinganencodingtable,returns
eitheracompactinternalmappingobjectoradictionarymappingcharacterordinalstobytevalues. Raisesa
TypeErrorandreturnNULLoninvalidinput.
Addedinversion3.2.
constchar*PyUnicode_GetDefaultEncoding(void)
Part of the Stable ABI. Return the name of the default string encoding, "utf-8". See sys.
getdefaultencoding().
Thereturnedstringdoesnotneedtobefreed,andisvaliduntilinterpretershutdown.
164 Chapter9. ConcreteObjectsLayer

### 第173页

Py_ssize_tPyUnicode_GetLength(PyObject*unicode)
PartoftheStableABIsinceversion3.7. ReturnthelengthoftheUnicodeobject,incodepoints.
Onerror,setanexceptionandreturn-1.
Addedinversion3.3.
Py_ssize_tPyUnicode_CopyCharacters(PyObject*to,Py_ssize_tto_start,PyObject*from,Py_ssize_t
from_start,Py_ssize_thow_many)
Copy characters from one Unicode object into another. This function performs character conversion when
necessaryandfallsbacktomemcpy()ifpossible. Returns-1andsetsanexceptiononerror,otherwisereturns
thenumberofcopiedcharacters.
Thestringmustnothavebeen“used”yet. SeePyUnicode_New()fordetails.
Addedinversion3.3.
intPyUnicode_Resize(PyObject**unicode,Py_ssize_tlength);
PartoftheStableABI.ResizeaUnicodeobject*unicodetothenewlengthincodepoints.
Trytoresizethestringinplace(whichisusuallyfasterthanallocatinganewstringandcopyingcharacters),
orcreateanewstring.
*unicodeismodifiedtopointtothenew(resized)objectand0isreturnedonsuccess. Otherwise,-1isreturned
andanexceptionisset,and*unicodeisleftuntouched.
Thefunctiondoesn’tcheckstringcontent,theresultmaynotbeastringincanonicalrepresentation.
Py_ssize_tPyUnicode_Fill(PyObject*unicode,Py_ssize_tstart,Py_ssize_tlength,Py_UCS4fill_char)
Fillastringwithacharacter: writefill_charintounicode[start:start+length].
Failiffill_charisbiggerthanthestringmaximumcharacter,orifthestringhasmorethan1reference.
Thestringmustnothavebeen“used”yet. SeePyUnicode_New()fordetails.
Returnthenumberofwrittencharacter,orreturn-1andraiseanexceptiononerror.
Addedinversion3.3.
intPyUnicode_WriteChar(PyObject*unicode,Py_ssize_tindex,Py_UCS4character)
PartoftheStableABIsinceversion3.7. Writeacharactertothestringunicodeatthezero-basedindex. Return
0onsuccess,-1onerrorwithanexceptionset.
ThisfunctionchecksthatunicodeisaUnicodeobject,thattheindexisnotoutofbounds,andthattheobject’s
referencecountisone). SeePyUnicode_WRITE()foraversionthatskipsthesechecks,makingthemyour
responsibility.
Thestringmustnothavebeen“used”yet. SeePyUnicode_New()fordetails.
Addedinversion3.3.
Py_UCS4PyUnicode_ReadChar(PyObject*unicode,Py_ssize_tindex)
PartoftheStableABIsinceversion3.7. Readacharacterfromastring. Thisfunctionchecksthatunicodeisa
Unicodeobjectandtheindexisnotoutofbounds,incontrasttoPyUnicode_READ_CHAR(),whichperforms
noerrorchecking.
Returncharacteronsuccess,-1onerrorwithanexceptionset.
Addedinversion3.3.
PyObject*PyUnicode_Substring(PyObject*unicode,Py_ssize_tstart,Py_ssize_tend)
Return value: New reference. Part of the Stable ABI since version 3.7. Return a substring of unicode, from
character index start (included) to character index end (excluded). Negative indices are not supported. On
error,setanexceptionandreturnNULL.
Addedinversion3.3.
9.3. SequenceObjects 165

### 第174页

Py_UCS4*PyUnicode_AsUCS4(PyObject*unicode,Py_UCS4*buffer,Py_ssize_tbuflen,intcopy_null)
PartoftheStableABIsinceversion3.7. CopythestringunicodeintoaUCS4buffer,includinganullcharacter,
if copy_null isset. Returns NULL andsetsan exceptiononerror(inparticular, a SystemError ifbuflen is
smallerthanthelengthofunicode). bufferisreturnedonsuccess.
Addedinversion3.3.
Py_UCS4*PyUnicode_AsUCS4Copy(PyObject*unicode)
PartoftheStableABIsinceversion3.7. CopythestringunicodeintoanewUCS4bufferthatisallocatedusing
PyMem_Malloc(). Ifthisfails,NULLisreturnedwithaMemoryErrorset. Thereturnedbufferalwayshas
anextranullcodepointappended.
Addedinversion3.3.
LocaleEncoding
Thecurrentlocaleencodingcanbeusedtodecodetextfromtheoperatingsystem.
PyObject*PyUnicode_DecodeLocaleAndSize(constchar*str,Py_ssize_tlength,constchar*errors)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.7. DecodeastringfromUTF-8onAndroid
and VxWorks, or from the current locale encoding on other platforms. The supported error handlers are
"strict" and "surrogateescape" (PEP 383). The decoder uses "strict" error handler if errors is
NULL.strmustendwithanullcharacterbutcannotcontainembeddednullcharacters.
UsePyUnicode_DecodeFSDefaultAndSize()todecodeastringfromthefilesystemencodinganderror
handler.
ThisfunctionignoresthePythonUTF-8Mode.
(cid:181) Seealso
ThePy_DecodeLocale()function.
Addedinversion3.3.
Changedinversion3.7: Thefunctionnowalsousesthecurrentlocaleencodingforthesurrogateescape
errorhandler,exceptonAndroid. Previously,Py_DecodeLocale()wasusedforthesurrogateescape,
andthecurrentlocaleencodingwasusedforstrict.
PyObject*PyUnicode_DecodeLocale(constchar*str,constchar*errors)
Return value: New reference. Part of the Stable ABI since version 3.7. Similar to
PyUnicode_DecodeLocaleAndSize(),butcomputethestringlengthusingstrlen().
Addedinversion3.3.
PyObject*PyUnicode_EncodeLocale(PyObject*unicode,constchar*errors)
Return value: New reference. Part of the Stable ABI since version 3.7. Encode a Unicode object to UTF-8
onAndroidandVxWorks,ortothecurrentlocaleencodingonotherplatforms. Thesupportederrorhandlers
are"strict"and"surrogateescape"(PEP383). Theencoderuses"strict"errorhandleriferrors
isNULL.Returnabytesobject. unicodecannotcontainembeddednullcharacters.
UsePyUnicode_EncodeFSDefault()toencodeastringtothefilesystemencodinganderrorhandler.
ThisfunctionignoresthePythonUTF-8Mode.
(cid:181) Seealso
ThePy_EncodeLocale()function.
Addedinversion3.3.
166 Chapter9. ConcreteObjectsLayer

| (cid:181) Seealso |
| --- |
| ThePy_DecodeLocale()function. |


| (cid:181) Seealso |
| --- |
| ThePy_EncodeLocale()function. |

### 第175页

Changedinversion3.7: Thefunctionnowalsousesthecurrentlocaleencodingforthesurrogateescape
errorhandler,exceptonAndroid. Previously,Py_EncodeLocale()wasusedforthesurrogateescape,
andthecurrentlocaleencodingwasusedforstrict.
FileSystemEncoding
Functionsencodingtoanddecodingfromthefilesystemencodinganderrorhandler(PEP383andPEP529).
To encode file names to bytes during argument parsing, the "O&" converter should be used, passing
PyUnicode_FSConverter()astheconversionfunction:
intPyUnicode_FSConverter(PyObject*obj,void*result)
PartoftheStableABI.PyArg_Parse*converter: encodestrobjects–obtaineddirectlyorthroughtheos.
PathLikeinterface–tobytesusingPyUnicode_EncodeFSDefault();bytesobjectsareoutputas-is.
result must be an address of a C variable of type PyObject* (or PyBytesObject*). On success, set the
variabletoanewstrongreferencetoabytesobjectwhichmustbereleasedwhenitisnolongerusedandreturn
anon-zerovalue(Py_CLEANUP_SUPPORTED).Embeddednullbytesarenotallowedintheresult. Onfailure,
return0withanexceptionset.
IfobjisNULL,thefunctionreleasesastrongreferencestoredinthevariablereferredbyresultandreturns1.
Addedinversion3.1.
Changedinversion3.6: Acceptsapath-likeobject.
To decode file names to str during argument parsing, the "O&" converter should be used, passing
PyUnicode_FSDecoder()astheconversionfunction:
intPyUnicode_FSDecoder(PyObject*obj,void*result)
PartoftheStableABI.PyArg_Parse*converter: decodebytesobjects–obtainedeitherdirectlyorindirectly
throughtheos.PathLikeinterface–tostrusingPyUnicode_DecodeFSDefaultAndSize();strob-
jectsareoutputas-is. resultmustbeanaddressofaCvariableoftypePyObject*(orPyUnicodeObject*).
On success, set the variable to a new strong reference to a Unicode object whichmust be released when it is
nolongerusedandreturnanon-zerovalue(Py_CLEANUP_SUPPORTED).Embeddednullcharactersarenot
allowedintheresult. Onfailure,return0withanexceptionset.
IfobjisNULL,releasethestrongreferencetotheobjectreferredtobyresultandreturn1.
Addedinversion3.2.
Changedinversion3.6: Acceptsapath-likeobject.
PyObject*PyUnicode_DecodeFSDefaultAndSize(constchar*str,Py_ssize_tsize)
Returnvalue: Newreference. PartoftheStableABI.Decodeastringfromthefilesystemencodinganderror
handler.
Ifyouneedtodecodeastringfromthecurrentlocaleencoding,usePyUnicode_DecodeLocaleAndSize().
(cid:181) Seealso
ThePy_DecodeLocale()function.
Changedinversion3.6: Thefilesystemerrorhandlerisnowused.
PyObject*PyUnicode_DecodeFSDefault(constchar*str)
Return value: New reference. Part of the Stable ABI. Decode a null-terminated string from the filesystem
encodinganderrorhandler.
Ifthestringlengthisknown,usePyUnicode_DecodeFSDefaultAndSize().
Changedinversion3.6: Thefilesystemerrorhandlerisnowused.
9.3. SequenceObjects 167

| (cid:181) Seealso |
| --- |
| ThePy_DecodeLocale()function. |

### 第176页

PyObject*PyUnicode_EncodeFSDefault(PyObject*unicode)
Returnvalue: Newreference. PartoftheStableABI.EncodeaUnicodeobjecttothefilesystemencodingand
errorhandler,andreturnbytes. Notethattheresultingbytesobjectcancontainnullbytes.
Ifyouneedtoencodeastringtothecurrentlocaleencoding,usePyUnicode_EncodeLocale().
(cid:181) Seealso
ThePy_EncodeLocale()function.
Addedinversion3.2.
Changedinversion3.6: Thefilesystemerrorhandlerisnowused.
wchar_tSupport
wchar_tsupportforplatformswhichsupportit:
PyObject*PyUnicode_FromWideChar(constwchar_t*wstr,Py_ssize_tsize)
Returnvalue: Newreference. PartoftheStableABI.CreateaUnicodeobjectfromthewchar_tbufferwstrof
thegivensize. Passing-1asthesizeindicatesthatthefunctionmustitselfcomputethelength,usingwcslen().
ReturnNULLonfailure.
Py_ssize_tPyUnicode_AsWideChar(PyObject*unicode,wchar_t*wstr,Py_ssize_tsize)
PartoftheStableABI.CopytheUnicodeobjectcontentsintothewchar_tbufferwstr. Atmostsizewchar_t
charactersarecopied(excludingapossiblytrailingnullterminationcharacter). Returnthenumberofwchar_t
characterscopiedor-1incaseofanerror.
WhenwstrisNULL,insteadreturnthesizethatwouldberequiredtostoreallofunicodeincludingaterminating
null.
Notethattheresultingwchar_t*stringmayormaynotbenull-terminated. Itistheresponsibilityofthecaller
tomakesurethatthewchar_t*stringisnull-terminatedincasethisisrequiredbytheapplication. Also,note
that the wchar_t* string might contain null characters, which would cause the string to be truncated when
usedwithmostCfunctions.
wchar_t*PyUnicode_AsWideCharString(PyObject*unicode,Py_ssize_t*size)
PartoftheStableABIsinceversion3.7. ConverttheUnicodeobjecttoawidecharacterstring. Theoutput
stringalwaysendswithanullcharacter. IfsizeisnotNULL,writethenumberofwidecharacters(excluding
thetrailingnullterminationcharacter)into*size. Notethattheresultingwchar_tstringmightcontainnull
characters,whichwouldcausethestringtobetruncatedwhenusedwithmostCfunctions. IfsizeisNULLand
thewchar_t*stringcontainsnullcharactersaValueErrorisraised.
ReturnsabufferallocatedbyPyMem_New(usePyMem_Free()tofreeit)onsuccess. Onerror,returnsNULL
and*sizeisundefined. RaisesaMemoryErrorifmemoryallocationisfailed.
Addedinversion3.2.
Changedinversion3.7:RaisesaValueErrorifsizeisNULLandthewchar_t*stringcontainsnullcharacters.
Built-inCodecs
Pythonprovidesasetofbuilt-incodecswhicharewritteninCforspeed. Allofthesecodecsaredirectlyusablevia
thefollowingfunctions.
ManyofthefollowingAPIstaketwoargumentsencodinganderrors,andtheyhavethesamesemanticsastheones
ofthebuilt-instr()stringobjectconstructor.
Setting encoding to NULL causes the default encoding to be used which is UTF-8. The file system calls should
use PyUnicode_FSConverter() for encoding file names. This uses the filesystem encoding and error handler
internally.
168 Chapter9. ConcreteObjectsLayer

| (cid:181) Seealso |
| --- |
| ThePy_EncodeLocale()function. |

### 第177页

Errorhandling is set by errors whichmay also be set to NULL meaningto use the default handling defined forthe
codec. Defaulterrorhandlingforallbuilt-incodecsis“strict”(ValueErrorisraised).
Thecodecsalluseasimilarinterface. Onlydeviationsfromthefollowinggenericonesaredocumentedforsimplicity.
GenericCodecs
Thefollowingmacroisprovided:
Py_UNICODE_REPLACEMENT_CHARACTER
TheUnicodecodepointU+FFFD(replacementcharacter).
ThisUnicodecharacterisusedasthereplacementcharacterduringdecodingiftheerrorsargumentissetto
“replace”.
ThesearethegenericcodecAPIs:
PyObject*PyUnicode_Decode(constchar*str,Py_ssize_tsize,constchar*encoding,constchar*errors)
Returnvalue: Newreference. PartoftheStableABI.CreateaUnicodeobjectbydecodingsizebytesofthe
encoded string str. encoding and errors have the same meaning as the parameters of the same name in the
str()built-infunction. ThecodectobeusedislookedupusingthePythoncodecregistry. ReturnNULLif
anexceptionwasraisedbythecodec.
PyObject*PyUnicode_AsEncodedString(PyObject*unicode,constchar*encoding,constchar*errors)
Returnvalue: Newreference. PartoftheStableABI.EncodeaUnicodeobjectandreturntheresultasPython
bytesobject. encodinganderrorshavethesamemeaningastheparametersofthesamenameintheUnicode
encode()method. ThecodectobeusedislookedupusingthePythoncodecregistry. ReturnNULLifan
exceptionwasraisedbythecodec.
UTF-8Codecs
ThesearetheUTF-8codecAPIs:
PyObject*PyUnicode_DecodeUTF8(constchar*str,Py_ssize_tsize,constchar*errors)
Returnvalue: Newreference. PartoftheStableABI.CreateaUnicodeobjectbydecodingsizebytesofthe
UTF-8encodedstringstr. ReturnNULLifanexceptionwasraisedbythecodec.
PyObject*PyUnicode_DecodeUTF8Stateful(constchar*str,Py_ssize_tsize,constchar*errors,Py_ssize_t
*consumed)
Return value: New reference. Part of the Stable ABI. If consumed is NULL, behave like
PyUnicode_DecodeUTF8(). Ifconsumed isnotNULL,trailingincompleteUTF-8bytesequenceswillnot
betreatedasanerror. Thosebyteswillnotbedecodedandthenumberofbytesthathavebeendecodedwill
bestoredinconsumed.
PyObject*PyUnicode_AsUTF8String(PyObject*unicode)
Return value: New reference. Part of the Stable ABI. Encode a Unicode object using UTF-8 and return the
resultasPythonbytesobject. Errorhandlingis“strict”. ReturnNULLifanexceptionwasraisedbythecodec.
Thefunctionfailsifthestringcontainssurrogatecodepoints(U+D800-U+DFFF).
constchar*PyUnicode_AsUTF8AndSize(PyObject*unicode,Py_ssize_t*size)
PartoftheStableABIsinceversion3.10. ReturnapointertotheUTF-8encodingoftheUnicodeobject,and
storethesizeoftheencodedrepresentation(inbytes)insize. ThesizeargumentcanbeNULL;inthiscaseno
sizewillbestored. Thereturnedbufferalwayshasanextranullbyteappended(notincludedinsize),regardless
ofwhetherthereareanyothernullcodepoints.
Onerror,setanexception,setsizeto-1(ifit’snotNULL)andreturnNULL.
Thefunctionfailsifthestringcontainssurrogatecodepoints(U+D800-U+DFFF).
ThiscachestheUTF-8representationofthestringintheUnicodeobject, andsubsequentcallswillreturna
pointertothesamebuffer. Thecallerisnotresponsiblefordeallocatingthebuffer. Thebufferisdeallocated
andpointerstoitbecomeinvalidwhentheUnicodeobjectisgarbagecollected.
9.3. SequenceObjects 169

### 第178页

Addedinversion3.3.
Changedinversion3.7: Thereturntypeisnowconst char *ratherofchar *.
Changedinversion3.10: ThisfunctionisapartofthelimitedAPI.
constchar*PyUnicode_AsUTF8(PyObject*unicode)
AsPyUnicode_AsUTF8AndSize(),butdoesnotstorethesize.
(cid:193) Warning
Thisfunctiondoesnothaveanyspecialbehaviorfornullcharactersembeddedwithinunicode. Asare-
sult, strings containing null characters will remain in the returned string, which some C functions might
interpretastheendofthestring,leadingtotruncation. Iftruncationisanissue,itisrecommendedtouse
PyUnicode_AsUTF8AndSize()instead.
Addedinversion3.3.
Changedinversion3.7: Thereturntypeisnowconst char *ratherofchar *.
UTF-32Codecs
ThesearetheUTF-32codecAPIs:
PyObject*PyUnicode_DecodeUTF32(constchar*str,Py_ssize_tsize,constchar*errors,int*byteorder)
Returnvalue: Newreference. PartoftheStableABI.DecodesizebytesfromaUTF-32encodedbufferstring
andreturnthecorrespondingUnicodeobject. errors(ifnon-NULL)definestheerrorhandling. Itdefaultsto
“strict”.
Ifbyteorderisnon-NULL,thedecoderstartsdecodingusingthegivenbyteorder:
*byteorder == -1: little endian
*byteorder == 0: native order
*byteorder == 1: big endian
If*byteorderiszero,andthefirstfourbytesoftheinputdataareabyteordermark(BOM),thedecoder
switchestothisbyteorderandtheBOMisnotcopiedintotheresultingUnicodestring. If*byteorderis-1
or1,anybyteordermarkiscopiedtotheoutput.
Aftercompletion,*byteorderissettothecurrentbyteorderattheendofinputdata.
IfbyteorderisNULL,thecodecstartsinnativeordermode.
ReturnNULLifanexceptionwasraisedbythecodec.
PyObject*PyUnicode_DecodeUTF32Stateful(constchar*str,Py_ssize_tsize,constchar*errors,int
*byteorder,Py_ssize_t*consumed)
Return value: New reference. Part of the Stable ABI. If consumed is NULL, behave like
PyUnicode_DecodeUTF32(). IfconsumedisnotNULL,PyUnicode_DecodeUTF32Stateful()willnot
treattrailingincompleteUTF-32bytesequences(suchasanumberofbytesnotdivisiblebyfour)asanerror.
Thosebyteswillnotbedecodedandthenumberofbytesthathavebeendecodedwillbestoredinconsumed.
PyObject*PyUnicode_AsUTF32String(PyObject*unicode)
Returnvalue: Newreference. PartoftheStableABI.ReturnaPythonbytestringusingtheUTF-32encoding
innativebyteorder. ThestringalwaysstartswithaBOMmark. Errorhandlingis“strict”. ReturnNULLifan
exceptionwasraisedbythecodec.
170 Chapter9. ConcreteObjectsLayer

| (cid:193) Warning |
| --- |
| Thisfunctiondoesnothaveanyspecialbehaviorfornullcharactersembeddedwithinunicode. Asare-
sult, strings containing null characters will remain in the returned string, which some C functions might
interpretastheendofthestring,leadingtotruncation. Iftruncationisanissue,itisrecommendedtouse
PyUnicode_AsUTF8AndSize()instead. |

### 第179页

UTF-16Codecs
ThesearetheUTF-16codecAPIs:
PyObject*PyUnicode_DecodeUTF16(constchar*str,Py_ssize_tsize,constchar*errors,int*byteorder)
Returnvalue: Newreference. PartoftheStableABI.DecodesizebytesfromaUTF-16encodedbufferstring
andreturnthecorrespondingUnicodeobject. errors(ifnon-NULL)definestheerrorhandling. Itdefaultsto
“strict”.
Ifbyteorderisnon-NULL,thedecoderstartsdecodingusingthegivenbyteorder:
*byteorder == -1: little endian
*byteorder == 0: native order
*byteorder == 1: big endian
If*byteorderiszero,andthefirsttwobytesoftheinputdataareabyteordermark(BOM),thedecoder
switchestothisbyteorderandtheBOMisnotcopiedintotheresultingUnicodestring. If*byteorderis
-1 or 1, any byte order mark is copied to the output (where it will result in either a \ufeff or a \ufffe
character).
Aftercompletion,*byteorderissettothecurrentbyteorderattheendofinputdata.
IfbyteorderisNULL,thecodecstartsinnativeordermode.
ReturnNULLifanexceptionwasraisedbythecodec.
PyObject*PyUnicode_DecodeUTF16Stateful(constchar*str,Py_ssize_tsize,constchar*errors,int
*byteorder,Py_ssize_t*consumed)
Return value: New reference. Part of the Stable ABI. If consumed is NULL, behave like
PyUnicode_DecodeUTF16(). IfconsumedisnotNULL,PyUnicode_DecodeUTF16Stateful()willnot
treattrailingincompleteUTF-16bytesequences(suchasanoddnumberofbytesorasplitsurrogatepair)as
anerror. Thosebyteswillnotbedecodedandthenumberofbytesthathavebeendecodedwillbestoredin
consumed.
PyObject*PyUnicode_AsUTF16String(PyObject*unicode)
Returnvalue: Newreference. PartoftheStableABI.ReturnaPythonbytestringusingtheUTF-16encoding
innativebyteorder. ThestringalwaysstartswithaBOMmark. Errorhandlingis“strict”. ReturnNULLifan
exceptionwasraisedbythecodec.
UTF-7Codecs
ThesearetheUTF-7codecAPIs:
PyObject*PyUnicode_DecodeUTF7(constchar*str,Py_ssize_tsize,constchar*errors)
Returnvalue: Newreference. PartoftheStableABI.CreateaUnicodeobjectbydecodingsizebytesofthe
UTF-7encodedstringstr. ReturnNULLifanexceptionwasraisedbythecodec.
PyObject*PyUnicode_DecodeUTF7Stateful(constchar*str,Py_ssize_tsize,constchar*errors,Py_ssize_t
*consumed)
Return value: New reference. Part of the Stable ABI. If consumed is NULL, behave like
PyUnicode_DecodeUTF7(). If consumed is not NULL, trailing incomplete UTF-7 base-64 sections will
notbetreatedasanerror. Thosebyteswillnotbedecodedandthenumberofbytesthathavebeendecoded
willbestoredinconsumed.
Unicode-EscapeCodecs
Thesearethe“UnicodeEscape”codecAPIs:
PyObject*PyUnicode_DecodeUnicodeEscape(constchar*str,Py_ssize_tsize,constchar*errors)
Returnvalue: Newreference. PartoftheStableABI.CreateaUnicodeobjectbydecodingsizebytesofthe
Unicode-Escapeencodedstringstr. ReturnNULLifanexceptionwasraisedbythecodec.
9.3. SequenceObjects 171

### 第180页

PyObject*PyUnicode_AsUnicodeEscapeString(PyObject*unicode)
Return value: New reference. Part of the Stable ABI. Encode a Unicode object using Unicode-Escape and
returntheresultasabytesobject. Errorhandlingis“strict”. ReturnNULLifanexceptionwasraisedbythe
codec.
Raw-Unicode-EscapeCodecs
Thesearethe“RawUnicodeEscape”codecAPIs:
PyObject*PyUnicode_DecodeRawUnicodeEscape(constchar*str,Py_ssize_tsize,constchar*errors)
Returnvalue: Newreference. PartoftheStableABI.CreateaUnicodeobjectbydecodingsizebytesofthe
Raw-Unicode-Escapeencodedstringstr. ReturnNULLifanexceptionwasraisedbythecodec.
PyObject*PyUnicode_AsRawUnicodeEscapeString(PyObject*unicode)
Return value: New reference. Part of the Stable ABI. Encode a Unicode object using Raw-Unicode-Escape
andreturntheresultasabytesobject. Errorhandlingis“strict”. ReturnNULLifanexceptionwasraisedby
thecodec.
Latin-1Codecs
ThesearetheLatin-1codecAPIs: Latin-1correspondstothefirst256Unicodeordinalsandonlytheseareaccepted
bythecodecsduringencoding.
PyObject*PyUnicode_DecodeLatin1(constchar*str,Py_ssize_tsize,constchar*errors)
Returnvalue: Newreference. PartoftheStableABI.CreateaUnicodeobjectbydecodingsizebytesofthe
Latin-1encodedstringstr. ReturnNULLifanexceptionwasraisedbythecodec.
PyObject*PyUnicode_AsLatin1String(PyObject*unicode)
Returnvalue: Newreference. PartoftheStableABI.EncodeaUnicodeobjectusingLatin-1andreturnthe
resultasPythonbytesobject. Errorhandlingis“strict”. ReturnNULLifanexceptionwasraisedbythecodec.
ASCIICodecs
ThesearetheASCIIcodecAPIs. Only7-bitASCIIdataisaccepted. Allothercodesgenerateerrors.
PyObject*PyUnicode_DecodeASCII(constchar*str,Py_ssize_tsize,constchar*errors)
Returnvalue: Newreference. PartoftheStableABI.CreateaUnicodeobjectbydecodingsizebytesofthe
ASCIIencodedstringstr. ReturnNULLifanexceptionwasraisedbythecodec.
PyObject*PyUnicode_AsASCIIString(PyObject*unicode)
Return value: New reference. Part of the Stable ABI. Encode a Unicode object using ASCII and return the
resultasPythonbytesobject. Errorhandlingis“strict”. ReturnNULLifanexceptionwasraisedbythecodec.
CharacterMapCodecs
Thiscodecisspecialinthatitcanbeusedtoimplementmanydifferentcodecs(andthisisinfactwhatwasdoneto
obtainmostofthestandardcodecsincludedintheencodingspackage). Thecodecusesmappingstoencodeand
decodecharacters. Themappingobjectsprovidedmustsupportthe__getitem__()mappinginterface;dictionaries
andsequencesworkwell.
ThesearethemappingcodecAPIs:
PyObject*PyUnicode_DecodeCharmap(constchar*str,Py_ssize_tlength,PyObject*mapping,constchar
*errors)
Returnvalue: Newreference. PartoftheStableABI.CreateaUnicodeobjectbydecodingsizebytesofthe
encodedstringstrusingthegivenmappingobject. ReturnNULLifanexceptionwasraisedbythecodec.
IfmappingisNULL,Latin-1decodingwillbeapplied. Elsemappingmustmapbytesordinals(integersinthe
rangefrom0to255)toUnicodestrings,integers(whicharetheninterpretedasUnicodeordinals)orNone.
Unmappeddatabytes–oneswhichcauseaLookupError,aswellasoneswhichgetmappedtoNone,0xFFFE
or'\ufffe',aretreatedasundefinedmappingsandcauseanerror.
172 Chapter9. ConcreteObjectsLayer

### 第181页

PyObject*PyUnicode_AsCharmapString(PyObject*unicode,PyObject*mapping)
Returnvalue: Newreference. PartoftheStableABI.EncodeaUnicodeobjectusingthegivenmappingobject
andreturntheresultasabytesobject. Errorhandlingis“strict”. ReturnNULLifanexceptionwasraisedby
thecodec.
ThemappingobjectmustmapUnicodeordinalintegerstobytesobjects,integersintherangefrom0to255
orNone. Unmappedcharacterordinals(oneswhichcauseaLookupError)aswellasmappedtoNoneare
treatedas“undefinedmapping”andcauseanerror.
ThefollowingcodecAPIisspecialinthatmapsUnicodetoUnicode.
PyObject*PyUnicode_Translate(PyObject*unicode,PyObject*table,constchar*errors)
Returnvalue: Newreference. PartoftheStableABI.Translateastringbyapplyingacharactermappingtable
toitandreturntheresultingUnicodeobject. ReturnNULLifanexceptionwasraisedbythecodec.
ThemappingtablemustmapUnicodeordinalintegerstoUnicodeordinalintegersorNone(causingdeletion
ofthecharacter).
Mappingtablesneedonlyprovidethe__getitem__()interface;dictionariesandsequencesworkwell. Un-
mappedcharacterordinals(oneswhichcauseaLookupError)areleftuntouchedandarecopiedas-is.
errorshastheusualmeaningforcodecs. ItmaybeNULLwhichindicatestousethedefaulterrorhandling.
MBCScodecsforWindows
ThesearetheMBCScodecAPIs. TheyarecurrentlyonlyavailableonWindowsandusetheWin32MBCSconverters
toimplementtheconversions. NotethatMBCS(orDBCS)isaclassofencodings,notjustone. Thetargetencoding
isdefinedbytheusersettingsonthemachinerunningthecodec.
PyObject*PyUnicode_DecodeMBCS(constchar*str,Py_ssize_tsize,constchar*errors)
Returnvalue: Newreference. PartoftheStableABIonWindowssinceversion3.7. CreateaUnicodeobject
bydecodingsizebytesoftheMBCSencodedstringstr. ReturnNULLifanexceptionwasraisedbythecodec.
PyObject*PyUnicode_DecodeMBCSStateful(constchar*str,Py_ssize_tsize,constchar*errors,Py_ssize_t
*consumed)
Returnvalue:Newreference. PartoftheStableABIonWindowssinceversion3.7. IfconsumedisNULL,behave
like PyUnicode_DecodeMBCS(). If consumed is not NULL, PyUnicode_DecodeMBCSStateful() will
notdecodetrailingleadbyteandthenumberofbytesthathavebeendecodedwillbestoredinconsumed.
PyObject*PyUnicode_DecodeCodePageStateful(intcode_page,constchar*str,Py_ssize_tsize,constchar
*errors,Py_ssize_t*consumed)
Return value: New reference. Part of the Stable ABI on Windows since version 3.7. Similar to
PyUnicode_DecodeMBCSStateful(),exceptusesthecodepagespecifiedbycode_page.
PyObject*PyUnicode_AsMBCSString(PyObject*unicode)
Returnvalue: Newreference. PartoftheStableABIonWindowssinceversion3.7. EncodeaUnicodeobject
using MBCS and return the result as Python bytes object. Error handling is “strict”. Return NULL if an
exceptionwasraisedbythecodec.
PyObject*PyUnicode_EncodeCodePage(intcode_page,PyObject*unicode,constchar*errors)
Returnvalue: Newreference. PartoftheStableABIonWindowssinceversion3.7. EncodetheUnicodeobject
usingthespecifiedcodepageandreturnaPythonbytesobject. ReturnNULLifanexceptionwasraisedbythe
codec. UseCP_ACPcodepagetogettheMBCSencoder.
Addedinversion3.3.
MethodsandSlotFunctions
ThefollowingAPIsarecapableofhandlingUnicodeobjectsandstringsoninput(werefertothemasstringsinthe
descriptions)andreturnUnicodeobjectsorintegersasappropriate.
TheyallreturnNULLor-1ifanexceptionoccurs.
9.3. SequenceObjects 173

### 第182页

PyObject*PyUnicode_Concat(PyObject*left,PyObject*right)
Returnvalue: Newreference. PartoftheStableABI.ConcattwostringsgivinganewUnicodestring.
PyObject*PyUnicode_Split(PyObject*unicode,PyObject*sep,Py_ssize_tmaxsplit)
Returnvalue: Newreference. PartoftheStableABI.SplitastringgivingalistofUnicodestrings. Ifsepis
NULL, splitting will be done at all whitespace substrings. Otherwise, splits occur at the given separator. At
mostmaxsplitsplitswillbedone. Ifnegative,nolimitisset. Separatorsarenotincludedintheresultinglist.
Onerror,returnNULLwithanexceptionset.
Equivalenttostr.split().
PyObject*PyUnicode_RSplit(PyObject*unicode,PyObject*sep,Py_ssize_tmaxsplit)
Returnvalue: Newreference. PartoftheStableABI.SimilartoPyUnicode_Split(),butsplittingwillbe
donebeginningattheendofthestring.
Onerror,returnNULLwithanexceptionset.
Equivalenttostr.rsplit().
PyObject*PyUnicode_Splitlines(PyObject*unicode,intkeepends)
Returnvalue: Newreference. PartoftheStableABI.SplitaUnicodestringatlinebreaks,returningalistof
Unicodestrings. CRLFisconsideredtobeonelinebreak. Ifkeependsis0,theLinebreakcharactersarenot
includedintheresultingstrings.
PyObject*PyUnicode_Partition(PyObject*unicode,PyObject*sep)
Returnvalue: Newreference. PartoftheStableABI.SplitaUnicodestringatthefirstoccurrenceofsep,and
returna3-tuplecontainingthepartbeforetheseparator,theseparatoritself,andthepartaftertheseparator.
Iftheseparatorisnotfound,returna3-tuplecontainingthestringitself,followedbytwoemptystrings.
sepmustnotbeempty.
Onerror,returnNULLwithanexceptionset.
Equivalenttostr.partition().
PyObject*PyUnicode_RPartition(PyObject*unicode,PyObject*sep)
Returnvalue: Newreference. PartoftheStableABI.SimilartoPyUnicode_Partition(),butsplitaUni-
codestringatthelastoccurrenceofsep. Iftheseparatorisnotfound,returna3-tuplecontainingtwoempty
strings,followedbythestringitself.
sepmustnotbeempty.
Onerror,returnNULLwithanexceptionset.
Equivalenttostr.rpartition().
PyObject*PyUnicode_Join(PyObject*separator,PyObject*seq)
Returnvalue: Newreference. PartoftheStableABI.Joinasequenceofstringsusingthegivenseparatorand
returntheresultingUnicodestring.
Py_ssize_tPyUnicode_Tailmatch(PyObject*unicode,PyObject*substr,Py_ssize_tstart,Py_ssize_tend,int
direction)
PartoftheStableABI.Return1ifsubstrmatchesunicode[start:end]atthegiventailend(direction==
-1meanstodoaprefixmatch,direction==1asuffixmatch),0otherwise. Return-1ifanerroroccurred.
Py_ssize_tPyUnicode_Find(PyObject*unicode,PyObject*substr,Py_ssize_tstart,Py_ssize_tend,intdirection)
PartoftheStableABI.Returnthefirstpositionofsubstrinunicode[start:end]usingthegivendirection
(direction==1meanstodoaforwardsearch,direction==-1abackwardsearch). Thereturnvalueistheindex
ofthefirstmatch;avalueof-1indicatesthatnomatchwasfound,and-2indicatesthatanerroroccurredand
anexceptionhasbeenset.
Py_ssize_tPyUnicode_FindChar(PyObject*unicode,Py_UCS4ch,Py_ssize_tstart,Py_ssize_tend,int
direction)
174 Chapter9. ConcreteObjectsLayer

### 第183页

PartoftheStableABIsinceversion3.7. Returnthefirstpositionofthecharacterchinunicode[start:end]
usingthegivendirection(direction==1meanstodoaforwardsearch,direction==-1abackwardsearch). The
returnvalueistheindexofthefirstmatch;avalueof-1indicatesthatnomatchwasfound,and-2indicates
thatanerroroccurredandanexceptionhasbeenset.
Addedinversion3.3.
Changedinversion3.7: startandendarenowadjustedtobehavelikeunicode[start:end].
Py_ssize_tPyUnicode_Count(PyObject*unicode,PyObject*substr,Py_ssize_tstart,Py_ssize_tend)
Part of the Stable ABI. Return the number of non-overlapping occurrences of substr in
unicode[start:end]. Return-1ifanerroroccurred.
PyObject*PyUnicode_Replace(PyObject*unicode,PyObject*substr,PyObject*replstr,Py_ssize_tmaxcount)
Returnvalue:Newreference. PartoftheStableABI.Replaceatmostmaxcountoccurrencesofsubstrinunicode
withreplstrandreturntheresultingUnicodeobject. maxcount==-1meansreplacealloccurrences.
intPyUnicode_Compare(PyObject*left,PyObject*right)
PartoftheStableABI.Comparetwostringsandreturn-1,0,1forlessthan,equal,andgreaterthan,respec-
tively.
Thisfunctionreturns-1uponfailure,sooneshouldcallPyErr_Occurred()tocheckforerrors.
(cid:181) Seealso
ThePyUnicode_Equal()function.
intPyUnicode_Equal(PyObject*a,PyObject*b)
PartoftheStableABIsinceversion3.14. Testiftwostringsareequal:
• Return1ifaisequaltob.
• Return0ifaisnotequaltob.
• SetaTypeErrorexceptionandreturn-1ifaorbisnotastrobject.
Thefunctionalwayssucceedsifaandbarestrobjects.
Thefunctionworksforstrsubclasses,butdoesnothonorcustom__eq__()method.
(cid:181) Seealso
ThePyUnicode_Compare()function.
Addedinversion3.14.
intPyUnicode_EqualToUTF8AndSize(PyObject*unicode,constchar*string,Py_ssize_tsize)
PartoftheStableABIsinceversion3.13. CompareaUnicodeobjectwithacharbufferwhichisinterpreted
asbeingUTF-8orASCIIencodedandreturntrue(1)iftheyareequal,orfalse(0)otherwise. IftheUnicode
object contains surrogate code points (U+D800 - U+DFFF) or the C string is not valid UTF-8, false (0) is
returned.
Thisfunctiondoesnotraiseexceptions.
Addedinversion3.13.
intPyUnicode_EqualToUTF8(PyObject*unicode,constchar*string)
PartoftheStableABIsinceversion3.13. SimilartoPyUnicode_EqualToUTF8AndSize(),butcompute
stringlengthusingstrlen(). IftheUnicodeobjectcontainsnullcharacters,false(0)isreturned.
Addedinversion3.13.
9.3. SequenceObjects 175

| (cid:181) Seealso |
| --- |
| ThePyUnicode_Equal()function. |


| (cid:181) Seealso |
| --- |
| ThePyUnicode_Compare()function. |

### 第184页

intPyUnicode_CompareWithASCIIString(PyObject*unicode,constchar*string)
PartoftheStableABI.CompareaUnicodeobject,unicode,withstringandreturn-1,0,1forlessthan,equal,
and greater than, respectively. It is best to pass only ASCII-encoded strings, but the function interprets the
inputstringasISO-8859-1ifitcontainsnon-ASCIIcharacters.
Thisfunctiondoesnotraiseexceptions.
PyObject*PyUnicode_RichCompare(PyObject*left,PyObject*right,intop)
Returnvalue: Newreference. PartoftheStableABI.RichcomparetwoUnicodestringsandreturnoneofthe
following:
• NULLincaseanexceptionwasraised
• Py_TrueorPy_Falseforsuccessfulcomparisons
• Py_NotImplementedincasethetypecombinationisunknown
PossiblevaluesforoparePy_GT,Py_GE,Py_EQ,Py_NE,Py_LT,andPy_LE.
PyObject*PyUnicode_Format(PyObject*format,PyObject*args)
Returnvalue: Newreference. PartoftheStableABI.Returnanewstringobjectfromformatandargs;thisis
analogoustoformat % args.
intPyUnicode_Contains(PyObject*unicode,PyObject*substr)
PartoftheStableABI.Checkwhethersubstriscontainedinunicodeandreturntrueorfalseaccordingly.
substrhastocoercetoaoneelementUnicodestring. -1isreturnediftherewasanerror.
voidPyUnicode_InternInPlace(PyObject**p_unicode)
PartoftheStableABI.Interntheargument*p_unicodeinplace. Theargumentmustbetheaddressofa
pointervariablepointingtoaPythonUnicodestringobject. Ifthereisanexistinginternedstringthatisthe
sameas*p_unicode,itsets*p_unicodetoit(releasingthereferencetotheoldstringobjectandcreating
anewstrongreferencetotheinternedstringobject),otherwiseitleaves*p_unicodealoneandinternsit.
(Clarification: eventhoughthereisalotoftalkaboutreferences,thinkofthisfunctionasreference-neutral.
Youmustowntheobjectyoupassin;afterthecallyounolongerownthepassed-inreference,butyounewly
owntheresult.)
Thisfunctionneverraisesanexception. Onerror,itleavesitsargumentunchangedwithoutinterningit.
Instancesofsubclassesofstrmaynotbeinterned,thatis,PyUnicode_CheckExact(*p_unicode)must
betrue. Ifitisnot,then–aswithanyothererror–theargumentisleftunchanged.
Notethatinternedstringsarenot“immortal”. Youmustkeepareferencetotheresulttobenefitfrominterning.
PyObject*PyUnicode_InternFromString(constchar*str)
Return value: New reference. Part of the Stable ABI. A combination of PyUnicode_FromString() and
PyUnicode_InternInPlace(),meantforstaticallyallocatedstrings.
Returnanew(“owned”)referencetoeitheranewUnicodestringobjectthathasbeeninterned,oranearlier
internedstringobjectwiththesamevalue.
Python may keep a reference to the result, or make it immortal, preventing it from being garbage-collected
promptly. For interning an unbounded number of different strings, such as ones coming from user input,
prefercallingPyUnicode_FromString()andPyUnicode_InternInPlace()directly.
unsignedintPyUnicode_CHECK_INTERNED(PyObject*str)
Returnanon-zerovalueifstrisinterned,zeroifnot. Thestrargumentmustbeastring;thisisnotchecked.
Thisfunctionalwayssucceeds.
CPythonimplementationdetail: Anon-zeroreturnvaluemaycarryadditionalinformationabouthowthe
stringisinterned. Themeaningofsuchnon-zerovalues,aswellaseachspecificstring’sintern-relateddetails,
maychangebetweenCPythonversions.
176 Chapter9. ConcreteObjectsLayer

### 第185页

PyUnicodeWriter
ThePyUnicodeWriterAPIcanbeusedtocreateaPythonstrobject.
Addedinversion3.14.
typePyUnicodeWriter
AUnicodewriterinstance.
The instance must be destroyed by PyUnicodeWriter_Finish() on success, or
PyUnicodeWriter_Discard()onerror.
PyUnicodeWriter*PyUnicodeWriter_Create(Py_ssize_tlength)
CreateaUnicodewriterinstance.
lengthmustbegreaterthanorequalto0.
Iflengthisgreaterthan0,preallocateaninternalbufferoflengthcharacters.
SetanexceptionandreturnNULLonerror.
PyObject*PyUnicodeWriter_Finish(PyUnicodeWriter*writer)
ReturnthefinalPythonstrobjectanddestroythewriterinstance.
SetanexceptionandreturnNULLonerror.
Thewriterinstanceisinvalidafterthiscall.
voidPyUnicodeWriter_Discard(PyUnicodeWriter*writer)
DiscardtheinternalUnicodebufferanddestroythewriterinstance.
IfwriterisNULL,nooperationisperformed.
Thewriterinstanceisinvalidafterthiscall.
intPyUnicodeWriter_WriteChar(PyUnicodeWriter*writer,Py_UCS4ch)
WritethesingleUnicodecharacterchintowriter.
Onsuccess,return0. Onerror,setanexception,leavethewriterunchanged,andreturn-1.
intPyUnicodeWriter_WriteUTF8(PyUnicodeWriter*writer,constchar*str,Py_ssize_tsize)
DecodethestringstrfromUTF-8instrictmodeandwritetheoutputintowriter.
sizeisthestringlengthinbytes. Ifsizeisequalto-1,callstrlen(str)togetthestringlength.
Onsuccess,return0. Onerror,setanexception,leavethewriterunchanged,andreturn-1.
SeealsoPyUnicodeWriter_DecodeUTF8Stateful().
intPyUnicodeWriter_WriteASCII(PyUnicodeWriter*writer,constchar*str,Py_ssize_tsize)
WritetheASCIIstringstrintowriter.
sizeisthestringlengthinbytes. Ifsizeisequalto-1,callstrlen(str)togetthestringlength.
strmustonlycontainASCIIcharacters. Thebehaviorisundefinedifstrcontainsnon-ASCIIcharacters.
Onsuccess,return0. Onerror,setanexception,leavethewriterunchanged,andreturn-1.
Addedinversion3.14.
intPyUnicodeWriter_WriteWideChar(PyUnicodeWriter*writer,constwchar_t*str,Py_ssize_tsize)
Writethewidestringstrintowriter.
sizeisanumberofwidecharacters. Ifsizeisequalto-1,callwcslen(str)togetthestringlength.
Onsuccess,return0. Onerror,setanexception,leavethewriterunchanged,andreturn-1.
9.3. SequenceObjects 177

### 第186页

intPyUnicodeWriter_WriteUCS4(PyUnicodeWriter*writer,Py_UCS4*str,Py_ssize_tsize)
WritertheUCS4stringstrintowriter.
sizeisanumberofUCS4characters.
Onsuccess,return0. Onerror,setanexception,leavethewriterunchanged,andreturn-1.
intPyUnicodeWriter_WriteStr(PyUnicodeWriter*writer,PyObject*obj)
CallPyObject_Str()onobjandwritetheoutputintowriter.
Onsuccess,return0. Onerror,setanexception,leavethewriterunchanged,andreturn-1.
intPyUnicodeWriter_WriteRepr(PyUnicodeWriter*writer,PyObject*obj)
CallPyObject_Repr()onobjandwritetheoutputintowriter.
Onsuccess,return0. Onerror,setanexception,leavethewriterunchanged,andreturn-1.
intPyUnicodeWriter_WriteSubstring(PyUnicodeWriter*writer,PyObject*str,Py_ssize_tstart,Py_ssize_t
end)
Writethesubstringstr[start:end]intowriter.
strmustbePythonstrobject. startmustbegreaterthanorequalto0,andlessthanorequaltoend. endmust
belessthanorequaltostrlength.
Onsuccess,return0. Onerror,setanexception,leavethewriterunchanged,andreturn-1.
intPyUnicodeWriter_Format(PyUnicodeWriter*writer,constchar*format,...)
SimilartoPyUnicode_FromFormat(),butwritetheoutputdirectlyintowriter.
Onsuccess,return0. Onerror,setanexception,leavethewriterunchanged,andreturn-1.
intPyUnicodeWriter_DecodeUTF8Stateful(PyUnicodeWriter*writer,constchar*string,Py_ssize_tlength,
constchar*errors,Py_ssize_t*consumed)
DecodethestringstrfromUTF-8witherrorserrorhandlerandwritetheoutputintowriter.
sizeisthestringlengthinbytes. Ifsizeisequalto-1,callstrlen(str)togetthestringlength.
errorsisanerrorhandlername,suchas"replace". IferrorsisNULL,usethestricterrorhandler.
Ifconsumed isnotNULL,set*consumed tothenumberofdecodedbytesonsuccess. If consumed isNULL,
treattrailingincompleteUTF-8bytesequencesasanerror.
Onsuccess,return0. Onerror,setanexception,leavethewriterunchanged,andreturn-1.
SeealsoPyUnicodeWriter_WriteUTF8().
DeprecatedAPI
ThefollowingAPIisdeprecated.
typePy_UNICODE
This is a typedef of wchar_t, which is a 16-bit type or 32-bit type depending on the platform. Please use
wchar_tdirectlyinstead.
Changedinversion3.3: Inpreviousversions,thiswasa16-bittypeora32-bittypedependingonwhetheryou
selecteda“narrow”or“wide”UnicodeversionofPythonatbuildtime.
Deprecatedsinceversion3.13,willberemovedinversion3.15.
intPyUnicode_READY(PyObject*unicode)
Donothingandreturn0. ThisAPIiskeptonlyforbackwardcompatibility,buttherearenoplanstoremove
it.
Addedinversion3.3.
Deprecatedsinceversion3.10: ThisAPIdoesnothingsincePython3.12. Previously,thisneededtobecalled
foreachstringcreatedusingtheoldAPI(PyUnicode_FromUnicode()orsimilar).
178 Chapter9. ConcreteObjectsLayer

### 第187页

unsignedintPyUnicode_IS_READY(PyObject*unicode)
Donothingandreturn1. ThisAPIiskeptonlyforbackwardcompatibility,buttherearenoplanstoremove
it.
Addedinversion3.3.
Deprecatedsinceversion3.14: ThisAPIdoesnothingsincePython3.12. Previously,thiscouldbecalledto
checkifPyUnicode_READY()isnecessary.
9.3.4 Tuple Objects
typePyTupleObject
ThissubtypeofPyObjectrepresentsaPythontupleobject.
PyTypeObjectPyTuple_Type
PartoftheStableABI.ThisinstanceofPyTypeObjectrepresentsthePythontupletype;itisthesameobject
astupleinthePythonlayer.
intPyTuple_Check(PyObject*p)
Returntrueifpisatupleobjectoraninstanceofasubtypeofthetupletype. Thisfunctionalwayssucceeds.
intPyTuple_CheckExact(PyObject*p)
Return true if p is a tuple object, but not an instance of a subtype of the tuple type. This function always
succeeds.
PyObject*PyTuple_New(Py_ssize_tlen)
Returnvalue: Newreference. PartoftheStableABI.Returnanewtupleobjectofsizelen,orNULLwithan
exceptionsetonfailure.
PyObject*PyTuple_Pack(Py_ssize_tn,...)
Return value: New reference. Part of the Stable ABI. Return a new tuple object of size n, or NULL with an
exceptionsetonfailure. ThetuplevaluesareinitializedtothesubsequentnCargumentspointingtoPython
objects. PyTuple_Pack(2, a, b)isequivalenttoPy_BuildValue("(OO)", a, b).
Py_ssize_tPyTuple_Size(PyObject*p)
PartoftheStableABI.Takeapointertoatupleobject,andreturnthesizeofthattuple. Onerror,return-1
andwithanexceptionset.
Py_ssize_tPyTuple_GET_SIZE(PyObject*p)
LikePyTuple_Size(),butwithouterrorchecking.
PyObject*PyTuple_GetItem(PyObject*p,Py_ssize_tpos)
Returnvalue: Borrowedreference. PartoftheStableABI.Returntheobjectatpositionposinthetuplepointed
tobyp. Ifposisnegativeoroutofbounds,returnNULLandsetanIndexErrorexception.
Thereturnedreferenceisborrowedfromthetuplep(thatis: itisonlyvalidaslongasyouholdareferenceto
p). Togetastrongreference,usePy_NewRef(PyTuple_GetItem(...))orPySequence_GetItem().
PyObject*PyTuple_GET_ITEM(PyObject*p,Py_ssize_tpos)
Returnvalue: Borrowedreference. LikePyTuple_GetItem(),butdoesnocheckingofitsarguments.
PyObject*PyTuple_GetSlice(PyObject*p,Py_ssize_tlow,Py_ssize_thigh)
Returnvalue: Newreference. PartoftheStableABI.Returnthesliceofthetuplepointedtobypbetweenlow
andhigh,orNULLwithanexceptionsetonfailure.
This is the equivalent of the Python expression p[low:high]. Indexing from the end of the tuple is not
supported.
intPyTuple_SetItem(PyObject*p,Py_ssize_tpos,PyObject*o)
PartoftheStableABI.Insertareferencetoobjectoatpositionposofthetuplepointedtobyp. Return0on
success. Ifposisoutofbounds,return-1andsetanIndexErrorexception.
9.3. SequenceObjects 179

### 第188页

(cid:174) Note
Thisfunction“steals”areferencetooanddiscardsareferencetoanitemalreadyinthetupleattheaffected
position.
voidPyTuple_SET_ITEM(PyObject*p,Py_ssize_tpos,PyObject*o)
LikePyTuple_SetItem(),butdoesnoerrorchecking,andshouldonlybeusedtofillinbrandnewtuples.
BoundscheckingisperformedasanassertionifPythonisbuiltindebugmodeorwith assertions.
(cid:174) Note
Thisfunction“steals”areferencetoo,and,unlikePyTuple_SetItem(),doesnotdiscardareferenceto
anyitemthatisbeingreplaced;anyreferenceinthetupleatpositionposwillbeleaked.
(cid:193) Warning
Thismacroshouldonlybeusedontuplesthatarenewlycreated. Usingthismacroonatuplethatisalready
inuse(orinotherwords,hasarefcount>1)couldleadtoundefinedbehavior.
int_PyTuple_Resize(PyObject**p,Py_ssize_tnewsize)
Canbeusedtoresizeatuple. newsizewillbethenewlengthofthetuple. Becausetuplesaresupposed tobe
immutable, thisshouldonlybeusedifthereisonlyonereferencetotheobject. Donot usethisifthetuple
mayalreadybeknowntosomeotherpartofthecode. Thetuplewillalwaysgroworshrinkattheend. Think
ofthisasdestroyingtheoldtupleandcreatinganewone,onlymoreefficiently. Returns0onsuccess. Client
codeshouldneverassumethattheresultingvalueof*pwillbethesameasbeforecallingthisfunction. Ifthe
objectreferencedby*pisreplaced,theoriginal*pisdestroyed. Onfailure,returns-1andsets*ptoNULL,
andraisesMemoryErrororSystemError.
9.3.5 Struct Sequence Objects
Struct sequence objects are the C equivalent of namedtuple() objects, i.e. a sequence whose items can also be
accessedthroughattributes. Tocreateastructsequence,youfirsthavetocreateaspecificstructsequencetype.
PyTypeObject*PyStructSequence_NewType(PyStructSequence_Desc*desc)
Returnvalue: Newreference. PartoftheStableABI.Createanewstructsequencetypefromthedataindesc,
describedbelow. InstancesoftheresultingtypecanbecreatedwithPyStructSequence_New().
ReturnNULLwithanexceptionsetonfailure.
voidPyStructSequence_InitType(PyTypeObject*type,PyStructSequence_Desc*desc)
Initializesastructsequencetypetypefromdescinplace.
intPyStructSequence_InitType2(PyTypeObject*type,PyStructSequence_Desc*desc)
LikePyStructSequence_InitType(),butreturns0onsuccessand-1withanexceptionsetonfailure.
Addedinversion3.4.
typePyStructSequence_Desc
Part of the Stable ABI (including all members). Contains the meta information of a struct sequence type to
create.
constchar*name
Fullyqualifiednameofthetype;null-terminatedUTF-8encoded. Thenamemustcontainthemodule
name.
180 Chapter9. ConcreteObjectsLayer

| (cid:193) Warning |
| --- |
| Thismacroshouldonlybeusedontuplesthatarenewlycreated. Usingthismacroonatuplethatisalready
inuse(orinotherwords,hasarefcount>1)couldleadtoundefinedbehavior. |

### 第189页

constchar*doc
PointertodocstringforthetypeorNULLtoomit.
PyStructSequence_Field*fields
PointertoNULL-terminatedarraywithfieldnamesofthenewtype.
intn_in_sequence
NumberoffieldsvisibletothePythonside(ifusedastuple).
typePyStructSequence_Field
Part of the Stable ABI (including all members). Describes a field of a struct sequence. As a struct se-
quence is modeled as a tuple, all fields are typed as PyObject*. The index in the fields array of the
PyStructSequence_Descdetermineswhichfieldofthestructsequenceisdescribed.
constchar*name
NameforthefieldorNULLtoendthelistofnamedfields,settoPyStructSequence_UnnamedField
toleaveunnamed.
constchar*doc
FielddocstringorNULLtoomit.
constchar*constPyStructSequence_UnnamedField
PartoftheStableABIsinceversion3.11. Specialvalueforafieldnametoleaveitunnamed.
Changedinversion3.9: Thetypewaschangedfromchar *.
PyObject*PyStructSequence_New(PyTypeObject*type)
Returnvalue: Newreference. PartoftheStableABI.Createsaninstanceoftype,whichmusthavebeencreated
withPyStructSequence_NewType().
ReturnNULLwithanexceptionsetonfailure.
PyObject*PyStructSequence_GetItem(PyObject*p,Py_ssize_tpos)
Return value: Borrowed reference. Part of the Stable ABI. Return the object at position pos in the struct
sequencepointedtobyp.
BoundscheckingisperformedasanassertionifPythonisbuiltindebugmodeorwith assertions.
PyObject*PyStructSequence_GET_ITEM(PyObject*p,Py_ssize_tpos)
Returnvalue: Borrowedreference. AliastoPyStructSequence_GetItem().
Changedinversion3.13: NowimplementedasanaliastoPyStructSequence_GetItem().
voidPyStructSequence_SetItem(PyObject*p,Py_ssize_tpos,PyObject*o)
Part of the Stable ABI. Sets the field at index pos of the struct sequence p to value o. Like
PyTuple_SET_ITEM(),thisshouldonlybeusedtofillinbrandnewinstances.
BoundscheckingisperformedasanassertionifPythonisbuiltindebugmodeorwith assertions.
(cid:174) Note
Thisfunction“steals”areferencetoo.
voidPyStructSequence_SET_ITEM(PyObject*p,Py_ssize_t*pos,PyObject*o)
AliastoPyStructSequence_SetItem().
Changedinversion3.13: NowimplementedasanaliastoPyStructSequence_SetItem().
9.3. SequenceObjects 181

### 第190页

9.3.6 List Objects
typePyListObject
ThissubtypeofPyObjectrepresentsaPythonlistobject.
PyTypeObjectPyList_Type
Part of the Stable ABI. This instance of PyTypeObject represents the Python list type. This is the same
objectaslistinthePythonlayer.
intPyList_Check(PyObject*p)
Returntrueifpisalistobjectoraninstanceofasubtypeofthelisttype. Thisfunctionalwayssucceeds.
intPyList_CheckExact(PyObject*p)
Returntrueifpisalistobject,butnotaninstanceofasubtypeofthelisttype. Thisfunctionalwayssucceeds.
PyObject*PyList_New(Py_ssize_tlen)
Returnvalue: Newreference. PartoftheStableABI.Returnanewlistoflengthlenonsuccess,orNULLon
failure.
(cid:174) Note
Iflenisgreaterthanzero,thereturnedlistobject’sitemsaresettoNULL.ThusyoucannotuseabstractAPI
functionssuchasPySequence_SetItem()orexposetheobjecttoPythoncodebeforesettingallitems
toarealobjectwithPyList_SetItem()orPyList_SET_ITEM(). ThefollowingAPIsaresafeAPIs
beforethelistisfullyinitialized: PyList_SetItem()andPyList_SET_ITEM().
Py_ssize_tPyList_Size(PyObject*list)
Part of the Stable ABI. Return the length of the list object in list; this is equivalent to len(list) on a list
object.
Py_ssize_tPyList_GET_SIZE(PyObject*list)
SimilartoPyList_Size(),butwithouterrorchecking.
PyObject*PyList_GetItemRef(PyObject*list,Py_ssize_tindex)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.13. Returntheobjectatpositionindexin
thelistpointedtobylist. Thepositionmustbenon-negative;indexingfromtheendofthelistisnotsupported.
Ifindexisoutofbounds(<0 or >=len(list)),returnNULLandsetanIndexErrorexception.
Addedinversion3.13.
PyObject*PyList_GetItem(PyObject*list,Py_ssize_tindex)
Returnvalue: Borrowedreference. PartoftheStableABI.LikePyList_GetItemRef(),butreturnsabor-
rowedreferenceinsteadofastrongreference.
PyObject*PyList_GET_ITEM(PyObject*list,Py_ssize_ti)
Returnvalue: Borrowedreference. SimilartoPyList_GetItem(),butwithouterrorchecking.
intPyList_SetItem(PyObject*list,Py_ssize_tindex,PyObject*item)
PartoftheStableABI.Settheitematindexindexinlisttoitem. Return0onsuccess. Ifindexisoutofbounds,
return-1andsetanIndexErrorexception.
(cid:174) Note
Thisfunction“steals”areferencetoitemanddiscardsareferencetoanitemalreadyinthelistattheaffected
position.
182 Chapter9. ConcreteObjectsLayer

### 第191页

voidPyList_SET_ITEM(PyObject*list,Py_ssize_ti,PyObject*o)
Macro form of PyList_SetItem() without error checking. This is normally only used to fill in new lists
wherethereisnopreviouscontent.
BoundscheckingisperformedasanassertionifPythonisbuiltindebugmodeorwith assertions.
(cid:174) Note
Thismacro“steals”areferencetoitem,and,unlikePyList_SetItem(),doesnotdiscardareferenceto
anyitemthatisbeingreplaced;anyreferenceinlistatpositioniwillbeleaked.
intPyList_Insert(PyObject*list,Py_ssize_tindex,PyObject*item)
PartoftheStableABI.Inserttheitemitemintolistlist infrontofindexindex. Return0ifsuccessful;return
-1andsetanexceptionifunsuccessful. Analogoustolist.insert(index, item).
intPyList_Append(PyObject*list,PyObject*item)
PartoftheStableABI.Appendtheobjectitemattheendoflistlist. Return0ifsuccessful;return-1andset
anexceptionifunsuccessful. Analogoustolist.append(item).
PyObject*PyList_GetSlice(PyObject*list,Py_ssize_tlow,Py_ssize_thigh)
Returnvalue: Newreference. PartoftheStableABI.Returnalistoftheobjectsinlist containingtheobjects
betweenlowandhigh. ReturnNULLandsetanexceptionifunsuccessful. Analogoustolist[low:high].
Indexingfromtheendofthelistisnotsupported.
intPyList_SetSlice(PyObject*list,Py_ssize_tlow,Py_ssize_thigh,PyObject*itemlist)
Part of the Stable ABI. Set the slice of list between low and high to the contents of itemlist. Analogous to
list[low:high] = itemlist. TheitemlistmaybeNULL,indicatingtheassignmentofanemptylist(slice
deletion). Return0onsuccess,-1onfailure. Indexingfromtheendofthelistisnotsupported.
intPyList_Extend(PyObject*list,PyObject*iterable)
Extendlistwiththecontentsofiterable. ThisisthesameasPyList_SetSlice(list, PY_SSIZE_T_MAX,
PY_SSIZE_T_MAX, iterable)andanalogoustolist.extend(iterable)orlist += iterable.
Raiseanexceptionandreturn-1iflistisnotalistobject. Return0onsuccess.
Addedinversion3.13.
intPyList_Clear(PyObject*list)
Removeallitemsfromlist. ThisisthesameasPyList_SetSlice(list, 0, PY_SSIZE_T_MAX, NULL)
andanalogoustolist.clear()ordel list[:].
Raiseanexceptionandreturn-1iflistisnotalistobject. Return0onsuccess.
Addedinversion3.13.
intPyList_Sort(PyObject*list)
PartoftheStableABI.Sorttheitemsoflistinplace. Return0onsuccess,-1onfailure. Thisisequivalentto
list.sort().
intPyList_Reverse(PyObject*list)
Part of the Stable ABI. Reverse the items of list in place. Return 0 on success, -1 on failure. This is the
equivalentoflist.reverse().
PyObject*PyList_AsTuple(PyObject*list)
Returnvalue: Newreference. PartoftheStableABI.Returnanewtupleobjectcontainingthecontentsoflist;
equivalenttotuple(list).
9.3. SequenceObjects 183

### 第192页

9.4 Container Objects
9.4.1 Dictionary Objects
typePyDictObject
ThissubtypeofPyObjectrepresentsaPythondictionaryobject.
PyTypeObjectPyDict_Type
Part of the Stable ABI. This instance of PyTypeObject represents the Python dictionary type. This is the
sameobjectasdictinthePythonlayer.
intPyDict_Check(PyObject*p)
Returntrueifpisadictobjectoraninstanceofasubtypeofthedicttype. Thisfunctionalwayssucceeds.
intPyDict_CheckExact(PyObject*p)
Returntrueifpisadictobject,butnotaninstanceofasubtypeofthedicttype. Thisfunctionalwayssucceeds.
PyObject*PyDict_New()
Returnvalue: Newreference. PartoftheStableABI.Returnanewemptydictionary,orNULLonfailure.
PyObject*PyDictProxy_New(PyObject*mapping)
Return value: New reference. Part of the Stable ABI. Return a types.MappingProxyType object for a
mappingwhichenforcesread-onlybehavior. Thisisnormallyusedtocreateaviewtopreventmodificationof
thedictionaryfornon-dynamicclasstypes.
voidPyDict_Clear(PyObject*p)
PartoftheStableABI.Emptyanexistingdictionaryofallkey-valuepairs.
intPyDict_Contains(PyObject*p,PyObject*key)
Part of the Stable ABI. Determine if dictionary p contains key. If an item in p is matches key, return 1,
otherwisereturn0. Onerror,return-1. ThisisequivalenttothePythonexpressionkey in p.
intPyDict_ContainsString(PyObject*p,constchar*key)
This is the same as PyDict_Contains(), but key is specified as a const char* UTF-8 encoded bytes
string,ratherthanaPyObject*.
Addedinversion3.13.
PyObject*PyDict_Copy(PyObject*p)
Returnvalue: Newreference. PartoftheStableABI.Returnanewdictionarythatcontainsthesamekey-value
pairsasp.
intPyDict_SetItem(PyObject*p,PyObject*key,PyObject*val)
Part of the Stable ABI. Insert val into the dictionary p with a key of key. key must be hashable; if it isn’t,
TypeErrorwillberaised. Return0onsuccessor-1onfailure. Thisfunctiondoesnot stealareferenceto
val.
intPyDict_SetItemString(PyObject*p,constchar*key,PyObject*val)
Part of the Stable ABI. This is the same as PyDict_SetItem(), but key is specified as a const char*
UTF-8encodedbytesstring,ratherthanaPyObject*.
intPyDict_DelItem(PyObject*p,PyObject*key)
Part of the Stable ABI. Remove the entry in dictionary p with key key. key must be hashable; if it isn’t,
TypeError is raised. If key is not in the dictionary, KeyError is raised. Return 0 on success or -1 on
failure.
intPyDict_DelItemString(PyObject*p,constchar*key)
Part of the Stable ABI. This is the same as PyDict_DelItem(), but key is specified as a const char*
UTF-8encodedbytesstring,ratherthanaPyObject*.
184 Chapter9. ConcreteObjectsLayer

### 第193页

intPyDict_GetItemRef(PyObject*p,PyObject*key,PyObject**result)
PartoftheStableABIsinceversion3.13. Returnanewstrongreferencetotheobjectfromdictionarypwhich
hasakeykey:
• Ifthekeyispresent,set*resulttoanewstrongreferencetothevalueandreturn1.
• Ifthekeyismissing,set*resulttoNULLandreturn0.
• Onerror,raiseanexceptionandreturn-1.
Addedinversion3.13.
SeealsothePyObject_GetItem()function.
PyObject*PyDict_GetItem(PyObject*p,PyObject*key)
Return value: Borrowed reference. Part of the Stable ABI. Return a borrowed reference to the object from
dictionarypwhichhasakeykey. ReturnNULLifthekeykeyismissingwithoutsettinganexception.
(cid:174) Note
Exceptionsthatoccurwhilethiscalls__hash__()and__eq__()methodsaresilentlyignored. Prefer
thePyDict_GetItemWithError()functioninstead.
Changed in version 3.10: Calling this API without an attached thread state had been allowed for historical
reason. Itisnolongerallowed.
PyObject*PyDict_GetItemWithError(PyObject*p,PyObject*key)
Return value: Borrowed reference. Part of the Stable ABI. Variant of PyDict_GetItem() that does not
suppressexceptions. ReturnNULLwithanexceptionsetifanexceptionoccurred. ReturnNULLwithoutan
exceptionsetifthekeywasn’tpresent.
PyObject*PyDict_GetItemString(PyObject*p,constchar*key)
Returnvalue: Borrowedreference. PartoftheStableABI.ThisisthesameasPyDict_GetItem(),butkey
isspecifiedasaconst char*UTF-8encodedbytesstring,ratherthanaPyObject*.
(cid:174) Note
Exceptions that occur while this calls __hash__() and __eq__() methods or while creating the tem-
porarystrobjectaresilentlyignored. PreferusingthePyDict_GetItemWithError()functionwith
yourownPyUnicode_FromString()keyinstead.
intPyDict_GetItemStringRef(PyObject*p,constchar*key,PyObject**result)
PartoftheStableABIsinceversion3.13. SimilartoPyDict_GetItemRef(),butkeyisspecifiedasaconst
char*UTF-8encodedbytesstring,ratherthanaPyObject*.
Addedinversion3.13.
PyObject*PyDict_SetDefault(PyObject*p,PyObject*key,PyObject*defaultobj)
Returnvalue: Borrowedreference. ThisisthesameasthePython-leveldict.setdefault(). Ifpresent,it
returnsthevaluecorrespondingtokeyfromthedictionaryp. Ifthekeyisnotinthedict, itisinsertedwith
valuedefaultobjanddefaultobjisreturned. Thisfunctionevaluatesthehashfunctionofkeyonlyonce,instead
ofevaluatingitindependentlyforthelookupandtheinsertion.
Addedinversion3.4.
intPyDict_SetDefaultRef(PyObject*p,PyObject*key,PyObject*default_value,PyObject**result)
Insertsdefault_valueintothedictionarypwithakeyofkeyifthekeyisnotalreadypresentinthedictionary. If
resultisnotNULL,then*resultissettoastrongreferencetoeitherdefault_value,ifthekeywasnotpresent,orthe
existingvalue,ifkeywasalreadypresentinthedictionary. Returns1ifthekeywaspresentanddefault_value
wasnotinserted,or0ifthekeywasnotpresentanddefault_valuewasinserted. Onfailure,returns-1,sets
anexception,andsets*resulttoNULL.
9.4. ContainerObjects 185

### 第194页

Forclarity: ifyouhaveastrongreferencetodefault_valuebeforecallingthisfunction, thenafteritreturns,
youholdastrongreferencetobothdefault_valueand*result (ifit’snotNULL).Thesemayrefertothesame
object: inthatcaseyouholdtwoseparatereferencestoit.
Addedinversion3.13.
intPyDict_Pop(PyObject*p,PyObject*key,PyObject**result)
Remove key from dictionary p and optionally return the removed value. Do not raise KeyError if the key
missing.
• Ifthekeyispresent,set*resulttoanewreferencetotheremovedvalueifresultisnotNULL,andreturn
1.
• Ifthekeyismissing,set*resulttoNULLifresultisnotNULL,andreturn0.
• Onerror,raiseanexceptionandreturn-1.
Similartodict.pop(),butwithoutthedefaultvalueandnotraisingKeyErrorifthekeymissing.
Addedinversion3.13.
intPyDict_PopString(PyObject*p,constchar*key,PyObject**result)
SimilartoPyDict_Pop(),butkeyisspecifiedasaconst char*UTF-8encodedbytesstring,ratherthan
aPyObject*.
Addedinversion3.13.
PyObject*PyDict_Items(PyObject*p)
Returnvalue: Newreference. PartoftheStableABI.ReturnaPyListObjectcontainingalltheitemsfrom
thedictionary.
PyObject*PyDict_Keys(PyObject*p)
Returnvalue: Newreference. PartoftheStableABI.ReturnaPyListObjectcontainingallthekeysfrom
thedictionary.
PyObject*PyDict_Values(PyObject*p)
Returnvalue: Newreference. PartoftheStableABI.ReturnaPyListObjectcontainingallthevaluesfrom
thedictionaryp.
Py_ssize_tPyDict_Size(PyObject*p)
Part of the Stable ABI. Return the number of items in the dictionary. This is equivalent to len(p) on a
dictionary.
intPyDict_Next(PyObject*p,Py_ssize_t*ppos,PyObject**pkey,PyObject**pvalue)
PartoftheStableABI.Iterateoverallkey-valuepairsinthedictionaryp. ThePy_ssize_treferredtoby
pposmustbeinitializedto0priortothefirstcalltothisfunctiontostarttheiteration;thefunctionreturnstrue
foreachpairinthedictionary,andfalseonceallpairshavebeenreported. Theparameterspkeyandpvalue
shouldeitherpointtoPyObject*variablesthatwillbefilledinwitheachkeyandvalue,respectively,ormay
beNULL.Anyreferencesreturnedthroughthemareborrowed. pposshouldnotbealteredduringiteration. Its
valuerepresentsoffsetswithintheinternaldictionarystructure,andsincethestructureissparse,theoffsetsare
notconsecutive.
Forexample:
PyObject *key, *value;
Py_ssize_t pos = 0;
while (PyDict_Next(self->dict, &pos, &key, &value)) {
/* do something interesting with the values... */
...
}
The dictionary p should not be mutated during iteration. It is safe to modify the values of the keys as you
iterateoverthedictionary,butonlysolongasthesetofkeysdoesnotchange. Forexample:
186 Chapter9. ConcreteObjectsLayer

### 第195页

PyObject *key, *value;
Py_ssize_t pos = 0;
while (PyDict_Next(self->dict, &pos, &key, &value)) {
long i = PyLong_AsLong(value);
if (i == -1 && PyErr_Occurred()) {
return -1;
}
PyObject *o = PyLong_FromLong(i + 1);
if (o == NULL)
return -1;
if (PyDict_SetItem(self->dict, key, o) < 0) {
Py_DECREF(o);
return -1;
}
Py_DECREF(o);
}
The function is not thread-safe in the free-threaded build without external synchronization. You can use
Py_BEGIN_CRITICAL_SECTION tolockthedictionarywhileiteratingoverit:
Py_BEGIN_CRITICAL_SECTION(self->dict);
while (PyDict_Next(self->dict, &pos, &key, &value)) {
...
}
Py_END_CRITICAL_SECTION();
(cid:174) Note
Onthefree-threadedbuild,thisfunctioncanbeusedsafelyinsideacriticalsection. However,thereferences
returnedforpkeyandpvalueareborrowedandareonlyvalidwhilethecriticalsectionisheld. Ifyouneed
tousetheseobjectsoutsidethecriticalsectionorwhenthecriticalsectioncanbesuspended,createastrong
reference(forexample,usingPy_NewRef()).
intPyDict_Merge(PyObject*a,PyObject*b,intoverride)
Part of the Stable ABI. Iterate over mapping object b adding key-value pairs to dictionary a. b may be a
dictionary, oranyobjectsupporting PyMapping_Keys() and PyObject_GetItem(). If override istrue,
existingpairsinawillbereplacedifamatchingkeyisfoundinb,otherwisepairswillonlybeaddedifthere
isnotamatchingkeyina. Return0onsuccessor-1ifanexceptionwasraised.
intPyDict_Update(PyObject*a,PyObject*b)
PartoftheStableABI.ThisisthesameasPyDict_Merge(a, b, 1)inC,andissimilartoa.update(b)
inPythonexceptthatPyDict_Update()doesn’tfallbacktotheiteratingoverasequenceofkeyvaluepairs
ifthesecondargumenthasno“keys”attribute. Return0onsuccessor-1ifanexceptionwasraised.
intPyDict_MergeFromSeq2(PyObject*a,PyObject*seq2,intoverride)
PartoftheStableABI.Updateormergeintodictionarya,fromthekey-valuepairsinseq2. seq2mustbean
iterableobjectproducingiterableobjectsoflength2,viewedaskey-valuepairs. Incaseofduplicatekeys,the
lastwinsifoverrideistrue,elsethefirstwins. Return0onsuccessor-1ifanexceptionwasraised. Equivalent
Python(exceptforthereturnvalue):
def PyDict_MergeFromSeq2(a, seq2, override):
for key, value in seq2:
if override or key not in a:
a[key] = value
9.4. ContainerObjects 187

### 第196页

intPyDict_AddWatcher(PyDict_WatchCallbackcallback)
Registercallbackasadictionarywatcher. Returnanon-negativeintegeridwhichmustbepassedtofuturecalls
toPyDict_Watch(). Incaseoferror(e.g. nomorewatcherIDsavailable),return-1andsetanexception.
Addedinversion3.12.
intPyDict_ClearWatcher(intwatcher_id)
Clearwatcheridentifiedbywatcher_idpreviouslyreturnedfromPyDict_AddWatcher(). Return0onsuc-
cess,-1onerror(e.g. ifthegivenwatcher_idwasneverregistered.)
Addedinversion3.12.
intPyDict_Watch(intwatcher_id,PyObject*dict)
Markdictionarydictaswatched. Thecallbackgrantedwatcher_idbyPyDict_AddWatcher()willbecalled
whendictismodifiedordeallocated. Return0onsuccessor-1onerror.
Addedinversion3.12.
intPyDict_Unwatch(intwatcher_id,PyObject*dict)
Markdictionarydictasnolongerwatched. Thecallbackgrantedwatcher_idbyPyDict_AddWatcher()will
nolongerbecalledwhendictismodifiedordeallocated. Thedictmustpreviouslyhavebeenwatchedbythis
watcher. Return0onsuccessor-1onerror.
Addedinversion3.12.
typePyDict_WatchEvent
Enumeration of possible dictionary watcher events: PyDict_EVENT_ADDED, PyDict_EVENT_MODIFIED,
PyDict_EVENT_DELETED, PyDict_EVENT_CLONED, PyDict_EVENT_CLEARED, or
PyDict_EVENT_DEALLOCATED.
Addedinversion3.12.
typedefint(*PyDict_WatchCallback)(PyDict_WatchEventevent,PyObject*dict,PyObject*key,PyObject
*new_value)
Typeofadictwatchercallbackfunction.
If event is PyDict_EVENT_CLEARED or PyDict_EVENT_DEALLOCATED, both key and new_value will be
NULL.Ifevent isPyDict_EVENT_ADDEDorPyDict_EVENT_MODIFIED,new_valuewillbethenewvalue
forkey. IfeventisPyDict_EVENT_DELETED,keyisbeingdeletedfromthedictionaryandnew_valuewillbe
NULL.
PyDict_EVENT_CLONEDoccurswhendictwaspreviouslyemptyandanotherdictismergedintoit. Tomain-
tainefficiencyofthisoperation,per-keyPyDict_EVENT_ADDEDeventsarenotissuedinthiscase;insteada
singlePyDict_EVENT_CLONEDisissued,andkeywillbethesourcedictionary.
Thecallbackmayinspectbutmustnotmodifydict;doingsocouldhaveunpredictableeffects,includinginfinite
recursion. DonottriggerPythoncodeexecutioninthecallback,asitcouldmodifythedictasasideeffect.
IfeventisPyDict_EVENT_DEALLOCATED,takinganewreferenceinthecallbacktotheabout-to-be-destroyed
dictionarywillresurrectitandpreventitfrombeingfreedatthistime. Whentheresurrectedobjectisdestroyed
later,anywatchercallbacksactiveatthattimewillbecalledagain.
Callbacksoccurbeforethenotifiedmodificationtodicttakesplace,sothepriorstateofdictcanbeinspected.
Ifthecallbacksetsanexception,itmustreturn-1;thisexceptionwillbeprintedasanunraisableexception
usingPyErr_WriteUnraisable(). Otherwiseitshouldreturn0.
Theremayalreadybeapendingexceptionsetonentrytothecallback. Inthiscase,thecallbackshouldreturn0
withthesameexceptionstillset. ThismeansthecallbackmaynotcallanyotherAPIthatcansetanexception
unlessitsavesandclearstheexceptionstatefirst,andrestoresitbeforereturning.
Addedinversion3.12.
188 Chapter9. ConcreteObjectsLayer

### 第197页

9.4.2 Set Objects
This section details the public API for set and frozenset objects. Any functionality not listed be-
low is best accessed using either the abstract object protocol (including PyObject_CallMethod(),
PyObject_RichCompareBool(), PyObject_Hash(), PyObject_Repr(), PyObject_IsTrue(),
PyObject_Print(),andPyObject_GetIter())ortheabstractnumberprotocol(includingPyNumber_And(),
PyNumber_Subtract(), PyNumber_Or(), PyNumber_Xor(), PyNumber_InPlaceAnd(),
PyNumber_InPlaceSubtract(),PyNumber_InPlaceOr(),andPyNumber_InPlaceXor()).
typePySetObject
ThissubtypeofPyObjectisusedtoholdtheinternaldataforbothsetandfrozensetobjects. Itislike
aPyDictObjectinthatitisafixedsizeforsmallsets(muchliketuplestorage)andwillpointtoaseparate,
variablesizedblockofmemoryformediumandlargesizedsets(muchlikeliststorage). Noneofthefieldsof
thisstructureshouldbeconsideredpublicandallaresubjecttochange. Allaccessshouldbedonethroughthe
documentedAPIratherthanbymanipulatingthevaluesinthestructure.
PyTypeObjectPySet_Type
PartoftheStableABI.ThisisaninstanceofPyTypeObjectrepresentingthePythonsettype.
PyTypeObjectPyFrozenSet_Type
PartoftheStableABI.ThisisaninstanceofPyTypeObjectrepresentingthePythonfrozensettype.
ThefollowingtypecheckmacrosworkonpointerstoanyPythonobject. Likewise,theconstructorfunctionswork
withanyiterablePythonobject.
intPySet_Check(PyObject*p)
Returntrueifpisasetobjectoraninstanceofasubtype. Thisfunctionalwayssucceeds.
intPyFrozenSet_Check(PyObject*p)
Returntrueifpisafrozensetobjectoraninstanceofasubtype. Thisfunctionalwayssucceeds.
intPyAnySet_Check(PyObject*p)
Return true if p is a set object, a frozenset object, or an instance of a subtype. This function always
succeeds.
intPySet_CheckExact(PyObject*p)
Returntrueifpisasetobjectbutnotaninstanceofasubtype. Thisfunctionalwayssucceeds.
Addedinversion3.10.
intPyAnySet_CheckExact(PyObject*p)
Returntrueifpisasetobjectorafrozensetobjectbutnotaninstanceofasubtype. Thisfunctionalways
succeeds.
intPyFrozenSet_CheckExact(PyObject*p)
Returntrueifpisafrozensetobjectbutnotaninstanceofasubtype. Thisfunctionalwayssucceeds.
PyObject*PySet_New(PyObject*iterable)
Return value: New reference. Part of the Stable ABI. Return a new set containing objects returned by the
iterable. The iterable may be NULL to create a new empty set. Return the new set on success or NULL on
failure. RaiseTypeErrorifiterableisnotactuallyiterable. Theconstructorisalsousefulforcopyingaset
(c=set(s)).
PyObject*PyFrozenSet_New(PyObject*iterable)
Returnvalue: Newreference. PartoftheStableABI.Returnanewfrozensetcontainingobjectsreturned
bytheiterable. TheiterablemaybeNULLtocreateanewemptyfrozenset. Returnthenewsetonsuccessor
NULLonfailure. RaiseTypeErrorifiterableisnotactuallyiterable.
Thefollowingfunctionsandmacrosareavailableforinstancesofsetorfrozensetorinstancesoftheirsubtypes.
Py_ssize_tPySet_Size(PyObject*anyset)
PartoftheStableABI.Returnthelengthofasetorfrozensetobject. Equivalenttolen(anyset). Raises
aSystemErrorifanysetisnotaset,frozenset,oraninstanceofasubtype.
9.4. ContainerObjects 189

### 第198页

Py_ssize_tPySet_GET_SIZE(PyObject*anyset)
MacroformofPySet_Size()withouterrorchecking.
intPySet_Contains(PyObject*anyset,PyObject*key)
Part of the Stable ABI. Return 1 if found, 0 if not found, and -1 if an error is encountered. Unlike the
Python__contains__()method,thisfunctiondoesnotautomaticallyconvertunhashablesetsintotempo-
rary frozensets. Raise a TypeError if the key is unhashable. Raise SystemError if anyset is not a set,
frozenset,oraninstanceofasubtype.
intPySet_Add(PyObject*set,PyObject*key)
Part of the Stable ABI. Add key to a set instance. Also works with frozenset instances (like
PyTuple_SetItem() it can be used to fill in the values of brand new frozensets before they are exposed
to other code). Return 0 on success or -1 on failure. Raise a TypeError if the key is unhashable. Raise
a MemoryError if there is no room to grow. Raise a SystemError if set is not an instance of set or its
subtype.
Thefollowingfunctionsareavailableforinstancesofsetoritssubtypesbutnotforinstancesoffrozensetorits
subtypes.
intPySet_Discard(PyObject*set,PyObject*key)
PartoftheStableABI.Return1iffoundandremoved,0ifnotfound(noactiontaken),and-1ifanerroris
encountered. DoesnotraiseKeyErrorformissingkeys. RaiseaTypeErrorifthekeyisunhashable. Unlike
thePythondiscard()method,thisfunctiondoesnotautomaticallyconvertunhashablesetsintotemporary
frozensets. RaiseSystemErrorifsetisnotaninstanceofsetoritssubtype.
PyObject*PySet_Pop(PyObject*set)
Returnvalue: Newreference. PartoftheStableABI.Returnanewreferencetoanarbitraryobjectintheset,
andremovestheobjectfromtheset. ReturnNULLonfailure. RaiseKeyErrorifthesetisempty. Raisea
SystemErrorifsetisnotaninstanceofsetoritssubtype.
intPySet_Clear(PyObject*set)
Part of the Stable ABI. Empty an existing set of all elements. Return 0 on success. Return -1 and raise
SystemErrorifsetisnotaninstanceofsetoritssubtype.
9.5 Function Objects
9.5.1 Function Objects
ThereareafewfunctionsspecifictoPythonfunctions.
typePyFunctionObject
TheCstructureusedforfunctions.
PyTypeObjectPyFunction_Type
ThisisaninstanceofPyTypeObjectandrepresentsthePythonfunctiontype. ItisexposedtoPythonpro-
grammersastypes.FunctionType.
intPyFunction_Check(PyObject*o)
Returntrueifoisafunctionobject(hastypePyFunction_Type). TheparametermustnotbeNULL.This
functionalwayssucceeds.
PyObject*PyFunction_New(PyObject*code,PyObject*globals)
Returnvalue: Newreference. Returnanewfunctionobjectassociatedwiththecodeobjectcode. globalsmust
beadictionarywiththeglobalvariablesaccessibletothefunction.
Thefunction’sdocstringandnameareretrievedfromthecodeobject. __module__isretrievedfromglobals.
Theargumentdefaults, annotationsandclosurearesettoNULL.__qualname__issettothesamevalueas
thecodeobject’sco_qualnamefield.
190 Chapter9. ConcreteObjectsLayer

### 第199页

PyObject*PyFunction_NewWithQualName(PyObject*code,PyObject*globals,PyObject*qualname)
Return value: New reference. As PyFunction_New(), but also allows setting the function object’s
__qualname__ attribute. qualname should be a unicode object or NULL; if NULL, the __qualname__ at-
tributeissettothesamevalueasthecodeobject’sco_qualnamefield.
Addedinversion3.3.
PyObject*PyFunction_GetCode(PyObject*op)
Returnvalue: Borrowedreference. Returnthecodeobjectassociatedwiththefunctionobjectop.
PyObject*PyFunction_GetGlobals(PyObject*op)
Returnvalue: Borrowedreference. Returntheglobalsdictionaryassociatedwiththefunctionobjectop.
PyObject*PyFunction_GetModule(PyObject*op)
Returnvalue: Borrowedreference. Returnaborrowedreferencetothe__module__attributeofthefunction
objectop. ItcanbeNULL.
Thisisnormallyastringcontainingthemodulename,butcanbesettoanyotherobjectbyPythoncode.
PyObject*PyFunction_GetDefaults(PyObject*op)
Returnvalue: Borrowedreference. Returntheargumentdefaultvaluesofthefunctionobjectop. Thiscanbe
atupleofargumentsorNULL.
intPyFunction_SetDefaults(PyObject*op,PyObject*defaults)
Settheargumentdefaultvaluesforthefunctionobjectop. defaultsmustbePy_Noneoratuple.
RaisesSystemErrorandreturns-1onfailure.
voidPyFunction_SetVectorcall(PyFunctionObject*func,vectorcallfuncvectorcall)
Setthevectorcallfieldofagivenfunctionobjectfunc.
Warning: extensionsusingthisAPImustpreservethebehavioroftheunaltered(default)vectorcallfunction!
Addedinversion3.12.
PyObject*PyFunction_GetKwDefaults(PyObject*op)
Returnvalue: Borrowedreference. Returnthekeyword-onlyargumentdefaultvaluesofthefunctionobjectop.
ThiscanbeadictionaryofargumentsorNULL.
PyObject*PyFunction_GetClosure(PyObject*op)
Returnvalue: Borrowedreference. Returntheclosureassociatedwiththefunctionobjectop. ThiscanbeNULL
oratupleofcellobjects.
intPyFunction_SetClosure(PyObject*op,PyObject*closure)
Settheclosureassociatedwiththefunctionobjectop. closuremustbePy_Noneoratupleofcellobjects.
RaisesSystemErrorandreturns-1onfailure.
PyObject*PyFunction_GetAnnotations(PyObject*op)
Return value: Borrowed reference. Return the annotations of the function object op. This can be a mutable
dictionaryorNULL.
intPyFunction_SetAnnotations(PyObject*op,PyObject*annotations)
Settheannotationsforthefunctionobjectop. annotationsmustbeadictionaryorPy_None.
RaisesSystemErrorandreturns-1onfailure.
PyObject*PyFunction_GET_CODE(PyObject*op)
PyObject*PyFunction_GET_GLOBALS(PyObject*op)
PyObject*PyFunction_GET_MODULE(PyObject*op)
PyObject*PyFunction_GET_DEFAULTS(PyObject*op)
PyObject*PyFunction_GET_KW_DEFAULTS(PyObject*op)
PyObject*PyFunction_GET_CLOSURE(PyObject*op)
9.5. FunctionObjects 191

### 第200页

PyObject*PyFunction_GET_ANNOTATIONS(PyObject*op)
Returnvalue: Borrowedreference. ThesefunctionsaresimilartotheirPyFunction_Get*counterparts,but
donotdotypechecking. PassinganythingotherthananinstanceofPyFunction_Typeisundefinedbehavior.
intPyFunction_AddWatcher(PyFunction_WatchCallbackcallback)
Register callback as a function watcher for the current interpreter. Return an ID which may be passed to
PyFunction_ClearWatcher(). Incaseoferror(e.g. nomorewatcherIDsavailable),return-1andsetan
exception.
Addedinversion3.12.
intPyFunction_ClearWatcher(intwatcher_id)
Clearwatcheridentifiedbywatcher_idpreviouslyreturnedfromPyFunction_AddWatcher()forthecur-
rentinterpreter. Return0onsuccess, or-1andsetanexceptiononerror(e.g. ifthegivenwatcher_id was
neverregistered.)
Addedinversion3.12.
typePyFunction_WatchEvent
Enumerationofpossiblefunctionwatcherevents:
• PyFunction_EVENT_CREATE
• PyFunction_EVENT_DESTROY
• PyFunction_EVENT_MODIFY_CODE
• PyFunction_EVENT_MODIFY_DEFAULTS
• PyFunction_EVENT_MODIFY_KWDEFAULTS
Addedinversion3.12.
typedefint(*PyFunction_WatchCallback)(PyFunction_WatchEventevent,PyFunctionObject*func,PyObject
*new_value)
Typeofafunctionwatchercallbackfunction.
IfeventisPyFunction_EVENT_CREATEorPyFunction_EVENT_DESTROYthennew_valuewillbeNULL.
Otherwise,new_valuewillholdaborrowedreferencetothenewvaluethatisabouttobestoredinfuncforthe
attributethatisbeingmodified.
Thecallbackmayinspectbutmustnotmodifyfunc;doingsocouldhaveunpredictableeffects,includinginfinite
recursion.
Ifevent isPyFunction_EVENT_CREATE,thenthecallbackisinvokedafterfunc hasbeenfullyinitialized.
Otherwise,thecallbackisinvokedbeforethemodificationtofunctakesplace,sothepriorstateoffunccanbe
inspected. Theruntimeispermittedtooptimizeawaythecreationoffunctionobjectswhenpossible. Insuch
cases no event will be emitted. Although this creates the possibility of an observable difference of runtime
behavior depending on optimization decisions, it does not change the semantics of the Python code being
executed.
Ifevent isPyFunction_EVENT_DESTROY,Takingareferenceinthecallbacktotheabout-to-be-destroyed
functionwillresurrectit,preventingitfrombeingfreedatthistime. Whentheresurrectedobjectisdestroyed
later,anywatchercallbacksactiveatthattimewillbecalledagain.
Ifthecallbacksetsanexception,itmustreturn-1;thisexceptionwillbeprintedasanunraisableexception
usingPyErr_WriteUnraisable(). Otherwiseitshouldreturn0.
Theremayalreadybeapendingexceptionsetonentrytothecallback. Inthiscase,thecallbackshouldreturn0
withthesameexceptionstillset. ThismeansthecallbackmaynotcallanyotherAPIthatcansetanexception
unlessitsavesandclearstheexceptionstatefirst,andrestoresitbeforereturning.
Addedinversion3.12.
192 Chapter9. ConcreteObjectsLayer

### 第201页

9.5.2 Instance Method Objects
AninstancemethodisawrapperforaPyCFunctionandthenewwaytobindaPyCFunctiontoaclassobject. It
replacestheformercallPyMethod_New(func, NULL, class).
PyTypeObjectPyInstanceMethod_Type
This instance of PyTypeObject represents the Python instance method type. It is not exposed to Python
programs.
intPyInstanceMethod_Check(PyObject*o)
Returntrueifoisaninstancemethodobject(hastypePyInstanceMethod_Type). Theparametermustnot
beNULL.Thisfunctionalwayssucceeds.
PyObject*PyInstanceMethod_New(PyObject*func)
Returnvalue: Newreference. Returnanewinstancemethodobject,withfuncbeinganycallableobject. func
isthefunctionthatwillbecalledwhentheinstancemethodiscalled.
PyObject*PyInstanceMethod_Function(PyObject*im)
Returnvalue: Borrowedreference. Returnthefunctionobjectassociatedwiththeinstancemethodim.
PyObject*PyInstanceMethod_GET_FUNCTION(PyObject*im)
Returnvalue: Borrowedreference. MacroversionofPyInstanceMethod_Function()whichavoidserror
checking.
9.5.3 Method Objects
Methods are bound function objects. Methods are always bound to an instance of a user-defined class. Unbound
methods(methodsboundtoaclassobject)arenolongeravailable.
PyTypeObjectPyMethod_Type
ThisinstanceofPyTypeObjectrepresentsthePythonmethodtype. ThisisexposedtoPythonprogramsas
types.MethodType.
intPyMethod_Check(PyObject*o)
Return true if o is a method object (has type PyMethod_Type). The parameter must not be NULL. This
functionalwayssucceeds.
PyObject*PyMethod_New(PyObject*func,PyObject*self)
Return value: New reference. Return a new method object, with func being any callable object and self the
instancethemethodshouldbebound. funcisthefunctionthatwillbecalledwhenthemethodiscalled. self
mustnotbeNULL.
PyObject*PyMethod_Function(PyObject*meth)
Returnvalue: Borrowedreference. Returnthefunctionobjectassociatedwiththemethodmeth.
PyObject*PyMethod_GET_FUNCTION(PyObject*meth)
Returnvalue: Borrowedreference. MacroversionofPyMethod_Function()whichavoidserrorchecking.
PyObject*PyMethod_Self(PyObject*meth)
Returnvalue: Borrowedreference. Returntheinstanceassociatedwiththemethodmeth.
PyObject*PyMethod_GET_SELF(PyObject*meth)
Returnvalue: Borrowedreference. MacroversionofPyMethod_Self()whichavoidserrorchecking.
9.5.4 Cell Objects
“Cell”objectsareusedtoimplementvariablesreferencedbymultiplescopes. Foreachsuchvariable,acellobjectis
createdtostorethevalue;thelocalvariablesofeachstackframethatreferencesthevaluecontainsareferencetothe
cellsfromouterscopeswhichalsousethatvariable. Whenthevalueisaccessed,thevaluecontainedinthecellisused
insteadofthecellobjectitself. Thisde-referencingofthecellobjectrequiressupportfromthegeneratedbyte-code;
thesearenotautomaticallyde-referencedwhenaccessed. Cellobjectsarenotlikelytobeusefulelsewhere.
9.5. FunctionObjects 193

### 第202页

typePyCellObject
TheCstructureusedforcellobjects.
PyTypeObjectPyCell_Type
Thetypeobjectcorrespondingtocellobjects.
intPyCell_Check(PyObject*ob)
Returntrueifobisacellobject;obmustnotbeNULL.Thisfunctionalwayssucceeds.
PyObject*PyCell_New(PyObject*ob)
Returnvalue: Newreference. Createandreturnanewcellobjectcontainingthevalueob. Theparametermay
beNULL.
PyObject*PyCell_Get(PyObject*cell)
Returnvalue: Newreference. Returnthecontentsofthecellcell,whichcanbeNULL.Ifcellisnotacellobject,
returnsNULLwithanexceptionset.
PyObject*PyCell_GET(PyObject*cell)
Returnvalue: Borrowedreference. Returnthecontentsofthecellcell,butwithoutcheckingthatcell isnon-
NULLandacellobject.
intPyCell_Set(PyObject*cell,PyObject*value)
Setthecontentsofthecellobjectcelltovalue. Thisreleasesthereferencetoanycurrentcontentofthecell.
valuemaybeNULL.cellmustbenon-NULL.
Onsuccess,return0. Ifcellisnotacellobject,setanexceptionandreturn-1.
voidPyCell_SET(PyObject*cell,PyObject*value)
Setsthevalueofthecellobjectcell tovalue. Noreferencecountsareadjusted,andnochecksaremadefor
safety;cellmustbenon-NULLandmustbeacellobject.
9.5.5 Code Objects
Codeobjectsarealow-leveldetailoftheCPythonimplementation. Eachonerepresentsachunkofexecutablecode
thathasn’tyetbeenboundintoafunction.
typePyCodeObject
TheCstructureoftheobjectsusedtodescribecodeobjects. Thefieldsofthistypearesubjecttochangeat
anytime.
PyTypeObjectPyCode_Type
ThisisaninstanceofPyTypeObjectrepresentingthePythoncodeobject.
intPyCode_Check(PyObject*co)
Returntrueifcoisacodeobject. Thisfunctionalwayssucceeds.
Py_ssize_tPyCode_GetNumFree(PyCodeObject*co)
Returnthenumberoffree(closure)variablesinacodeobject.
intPyUnstable_Code_GetFirstFree(PyCodeObject*co)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Returnthepositionofthefirstfree(closure)variableinacodeobject.
Changedinversion3.13: RenamedfromPyCode_GetFirstFreeaspartofUnstableCAPI.Theoldname
isdeprecated,butwillremainavailableuntilthesignaturechangesagain.
194 Chapter9. ConcreteObjectsLayer

### 第203页

PyCodeObject*PyUnstable_Code_New(intargcount,intkwonlyargcount,intnlocals,intstacksize,intflags,
PyObject*code,PyObject*consts,PyObject*names,PyObject
*varnames,PyObject*freevars,PyObject*cellvars,PyObject*filename,
PyObject*name,PyObject*qualname,intfirstlineno,PyObject
*linetable,PyObject*exceptiontable)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Returnanewcodeobject. Ifyouneedadummycodeobjecttocreateaframe, usePyCode_NewEmpty()
instead.
Sincethedefinitionofthebytecodechangesoften,callingPyUnstable_Code_New()directlycanbindyou
toaprecisePythonversion.
The many arguments of this function are inter-dependent in complex ways, meaning that subtle changes to
valuesarelikelytoresultinincorrectexecutionorVMcrashes. Usethisfunctiononlywithextremecare.
Changedinversion3.11: Addedqualnameandexceptiontableparameters.
Changedinversion3.12: RenamedfromPyCode_NewaspartofUnstableCAPI.Theoldnameisdeprecated,
butwillremainavailableuntilthesignaturechangesagain.
PyCodeObject*PyUnstable_Code_NewWithPosOnlyArgs(intargcount,intposonlyargcount,int
kwonlyargcount,intnlocals,intstacksize,intflags,
PyObject*code,PyObject*consts,PyObject
*names,PyObject*varnames,PyObject*freevars,
PyObject*cellvars,PyObject*filename,PyObject
*name,PyObject*qualname,intfirstlineno,
PyObject*linetable,PyObject*exceptiontable)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Similar to PyUnstable_Code_New(), but with an extra “posonlyargcount” for positional-only arguments.
ThesamecaveatsthatapplytoPyUnstable_Code_Newalsoapplytothisfunction.
Addedinversion3.8: asPyCode_NewWithPosOnlyArgs
Changedinversion3.11: Addedqualnameandexceptiontableparameters.
Changedinversion3.12: RenamedtoPyUnstable_Code_NewWithPosOnlyArgs. Theoldnameisdep-
recated,butwillremainavailableuntilthesignaturechangesagain.
PyCodeObject*PyCode_NewEmpty(constchar*filename,constchar*funcname,intfirstlineno)
Returnvalue: Newreference. Returnanewemptycodeobjectwiththespecifiedfilename,functionname,and
firstlinenumber. TheresultingcodeobjectwillraiseanExceptionifexecuted.
intPyCode_Addr2Line(PyCodeObject*co,intbyte_offset)
Returnthelinenumberoftheinstructionthatoccursonorbeforebyte_offsetandendsafterit. Ifyoujust
needthelinenumberofaframe,usePyFrame_GetLineNumber()instead.
Forefficientlyiteratingoverthelinenumbersinacodeobject,usetheAPIdescribedinPEP626.
intPyCode_Addr2Location(PyObject*co,intbyte_offset,int*start_line,int*start_column,int*end_line,int
*end_column)
Setsthepassedintpointerstothesourcecodelineandcolumnnumbersfortheinstructionatbyte_offset.
Setsthevalueto0wheninformationisnotavailableforanyparticularelement.
9.5. FunctionObjects 195

### 第204页

Returns1ifthefunctionsucceedsand0otherwise.
Addedinversion3.11.
PyObject*PyCode_GetCode(PyCodeObject*co)
Equivalent to the Python code getattr(co, 'co_code'). Returns a strong reference to a
PyBytesObjectrepresentingthebytecodeinacodeobject. Onerror,NULLisreturnedandanexceptionis
raised.
This PyBytesObject may be created on-demand by the interpreter and does not necessarily represent the
bytecodeactuallyexecutedbyCPython. Theprimaryusecaseforthisfunctionisdebuggersandprofilers.
Addedinversion3.11.
PyObject*PyCode_GetVarnames(PyCodeObject*co)
Equivalent to the Python code getattr(co, 'co_varnames'). Returns a new reference to a
PyTupleObjectcontainingthenamesofthelocalvariables. Onerror,NULLisreturnedandanexceptionis
raised.
Addedinversion3.11.
PyObject*PyCode_GetCellvars(PyCodeObject*co)
Equivalent to the Python code getattr(co, 'co_cellvars'). Returns a new reference to a
PyTupleObject containing the names of the local variables that are referenced by nested functions. On
error,NULLisreturnedandanexceptionisraised.
Addedinversion3.11.
PyObject*PyCode_GetFreevars(PyCodeObject*co)
Equivalent to the Python code getattr(co, 'co_freevars'). Returns a new reference to a
PyTupleObject containing the names of the free (closure) variables. On error, NULL is returned and an
exceptionisraised.
Addedinversion3.11.
intPyCode_AddWatcher(PyCode_WatchCallbackcallback)
Register callback as a code object watcher for the current interpreter. Return an ID which may be passed
toPyCode_ClearWatcher(). Incaseoferror(e.g. nomorewatcherIDsavailable),return-1andsetan
exception.
Addedinversion3.12.
intPyCode_ClearWatcher(intwatcher_id)
Clear watcher identified by watcher_id previously returned from PyCode_AddWatcher() for the current
interpreter. Return0onsuccess,or-1andsetanexceptiononerror(e.g. ifthegivenwatcher_id wasnever
registered.)
Addedinversion3.12.
typePyCodeEvent
Enumeration of possible code object watcher events: - PY_CODE_EVENT_CREATE -
PY_CODE_EVENT_DESTROY
Addedinversion3.12.
typedefint(*PyCode_WatchCallback)(PyCodeEventevent,PyCodeObject*co)
Typeofacodeobjectwatchercallbackfunction.
Ifevent isPY_CODE_EVENT_CREATE,thenthecallbackisinvokedaftercohasbeenfullyinitialized. Other-
wise,thecallbackisinvokedbeforethedestructionofcotakesplace,sothepriorstateofcocanbeinspected.
Ifevent isPY_CODE_EVENT_DESTROY,takingareferenceinthecallbacktotheabout-to-be-destroyedcode
objectwillresurrectitandpreventitfrombeingfreedatthistime. Whentheresurrectedobjectisdestroyed
later,anywatchercallbacksactiveatthattimewillbecalledagain.
196 Chapter9. ConcreteObjectsLayer

### 第205页

UsersofthisAPIshouldnotrelyoninternalruntimeimplementationdetails. Suchdetailsmayinclude, but
arenotlimitedto, theexactorderandtimingofcreationanddestructionofcodeobjects. Whilechangesin
thesedetailsmayresultindifferencesobservablebywatchers(includingwhetheracallbackisinvokedornot),
itdoesnotchangethesemanticsofthePythoncodebeingexecuted.
Ifthecallbacksetsanexception,itmustreturn-1;thisexceptionwillbeprintedasanunraisableexception
usingPyErr_WriteUnraisable(). Otherwiseitshouldreturn0.
Theremayalreadybeapendingexceptionsetonentrytothecallback. Inthiscase,thecallbackshouldreturn0
withthesameexceptionstillset. ThismeansthecallbackmaynotcallanyotherAPIthatcansetanexception
unlessitsavesandclearstheexceptionstatefirst,andrestoresitbeforereturning.
Addedinversion3.12.
9.5.6 Code Object Flags
Code objects contain a bit-field of flags, which can be retrieved as the co_flags Python attribute (for example
usingPyObject_GetAttrString()),andsetusingaflagsargumenttoPyUnstable_Code_New()andsimilar
functions.
FlagswhosenamesstartwithCO_FUTURE_correspondtofeaturesnormallyselectablebyfuturestatements. These
flagscanbeusedinPyCompilerFlags.cf_flags. NotethatmanyCO_FUTURE_flagsaremandatoryincurrent
versionsofPython,andsettingthemhasnoeffect.
Thefollowingflagsareavailable. Fortheirmeaning,seethelinkeddocumentationoftheirPythonequivalents.
9.5. FunctionObjects 197

### 第206页

Flag Meaning
inspect.CO_OPTIMIZED
CO_OPTIMIZED
inspect.CO_NEWLOCALS
CO_NEWLOCALS
inspect.CO_VARARGS
CO_VARARGS
inspect.CO_VARKEYWORDS
CO_VARKEYWORDS
inspect.CO_NESTED
CO_NESTED
inspect.CO_GENERATOR
CO_GENERATOR
inspect.CO_COROUTINE
CO_COROUTINE
inspect.CO_ITERABLE_COROUTINE
CO_ITERABLE_COROUTINE
inspect.CO_ASYNC_GENERATOR
CO_ASYNC_GENERATOR
inspect.CO_HAS_DOCSTRING
CO_HAS_DOCSTRING
inspect.CO_METHOD
CO_METHOD
noeffect(__future__.division)
CO_FUTURE_DIVISION
noeffect(__future__.absolute_import)
CO_FUTURE_ABSOLUTE_IMPORT
noeffect(__future__.with_statement)
CO_FUTURE_WITH_STATEMENT
noeffect(__future__.print_function)
CO_FUTURE_PRINT_FUNCTION
noeffect(__future__.unicode_literals)
CO_FUTURE_UNICODE_LITERALS
noeffect(__future__.generator_stop)
CO_FUTURE_GENERATOR_STOP
__future__.annotations
CO_FUTURE_ANNOTATIONS
198 Chapter9. ConcreteObjectsLayer

| Flag | Meaning |
| --- | --- |
| CO_OPTIMIZED | inspect.CO_OPTIMIZED |
| CO_NEWLOCALS | inspect.CO_NEWLOCALS |
| CO_VARARGS | inspect.CO_VARARGS |
| CO_VARKEYWORDS | inspect.CO_VARKEYWORDS |
| CO_NESTED | inspect.CO_NESTED |
| CO_GENERATOR | inspect.CO_GENERATOR |
| CO_COROUTINE | inspect.CO_COROUTINE |
| CO_ITERABLE_COROUTINE | inspect.CO_ITERABLE_COROUTINE |
| CO_ASYNC_GENERATOR | inspect.CO_ASYNC_GENERATOR |
| CO_HAS_DOCSTRING | inspect.CO_HAS_DOCSTRING |
| CO_METHOD | inspect.CO_METHOD |
| CO_FUTURE_DIVISION | noeffect(__future__.division) |
| CO_FUTURE_ABSOLUTE_IMPORT | noeffect(__future__.absolute_import) |
| CO_FUTURE_WITH_STATEMENT | noeffect(__future__.with_statement) |
| CO_FUTURE_PRINT_FUNCTION | noeffect(__future__.print_function) |
| CO_FUTURE_UNICODE_LITERALS | noeffect(__future__.unicode_literals) |
| CO_FUTURE_GENERATOR_STOP | noeffect(__future__.generator_stop) |
| CO_FUTURE_ANNOTATIONS | __future__.annotations |

### 第207页

9.5.7 Extra information
Tosupportlow-levelextensionstoframeevaluation,suchasexternaljust-in-timecompilers,itispossibletoattach
arbitraryextradatatocodeobjects.
ThesefunctionsarepartoftheunstableCAPItier: thisfunctionalityisaCPythonimplementationdetail,andthe
APImaychangewithoutdeprecationwarnings.
Py_ssize_tPyUnstable_Eval_RequestCodeExtraIndex(freefuncfree)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Returnanewanopaqueindexvalueusedtoaddingdatatocodeobjects.
You generally call this function once (per interpreter) and use the result with PyCode_GetExtra and
PyCode_SetExtratomanipulatedataonindividualcodeobjects.
IffreeisnotNULL:whenacodeobjectisdeallocated,freewillbecalledonnon-NULLdatastoredunderthe
newindex. UsePy_DecRef()whenstoringPyObject.
Addedinversion3.6: as_PyEval_RequestCodeExtraIndex
Changed in version 3.12: Renamed to PyUnstable_Eval_RequestCodeExtraIndex. The old private
nameisdeprecated,butwillbeavailableuntiltheAPIchanges.
intPyUnstable_Code_GetExtra(PyObject*code,Py_ssize_tindex,void**extra)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Setextratotheextradatastoredunderthegivenindex. Return0onsuccess. Setanexceptionandreturn-1
onfailure.
Ifnodatawassetundertheindex,setextratoNULLandreturn0withoutsettinganexception.
Addedinversion3.6: as_PyCode_GetExtra
Changedinversion3.12: RenamedtoPyUnstable_Code_GetExtra. Theoldprivatenameisdeprecated,
butwillbeavailableuntiltheAPIchanges.
intPyUnstable_Code_SetExtra(PyObject*code,Py_ssize_tindex,void*extra)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Settheextradatastoredunderthegivenindextoextra. Return0onsuccess. Setanexceptionandreturn-1
onfailure.
Addedinversion3.6: as_PyCode_SetExtra
Changedinversion3.12: RenamedtoPyUnstable_Code_SetExtra. Theoldprivatenameisdeprecated,
butwillbeavailableuntiltheAPIchanges.
9.5. FunctionObjects 199

### 第208页

9.6 Other Objects
9.6.1 File Objects
These APIs are a minimal emulation of the Python 2 C API for built-in file objects, which used to rely on the
bufferedI/O(FILE*)supportfromtheCstandardlibrary. InPython3, filesandstreamsusethenewiomodule,
whichdefinesseverallayersoverthelow-levelunbufferedI/Ooftheoperatingsystem. Thefunctionsdescribedbelow
areconvenienceCwrappersoverthesenewAPIs, andmeantmostlyforinternalerrorreportingintheinterpreter;
third-partycodeisadvisedtoaccesstheioAPIsinstead.
PyObject*PyFile_FromFd(intfd,constchar*name,constchar*mode,intbuffering,constchar*encoding,const
char*errors,constchar*newline,intclosefd)
Returnvalue: Newreference. PartoftheStableABI.CreateaPythonfileobjectfromthefiledescriptorofan
already opened file fd. The arguments name, encoding, errors and newline can be NULL to use the defaults;
buffering can be -1 to use the default. name is ignored and kept for backward compatibility. Return NULL
onfailure. Foramorecomprehensivedescriptionofthearguments,pleaserefertotheio.open()function
documentation.
(cid:193) Warning
SincePythonstreamshavetheirownbufferinglayer,mixingthemwithOS-levelfiledescriptorscanpro-
ducevariousissues(suchasunexpectedorderingofdata).
Changedinversion3.2: Ignorenameattribute.
intPyObject_AsFileDescriptor(PyObject*p)
PartoftheStableABI.Returnthefiledescriptorassociatedwithpasanint. Iftheobjectisaninteger,its
valueisreturned. Ifnot,theobject’sfileno()methodiscalledifitexists;themethodmustreturnaninteger,
whichisreturnedasthefiledescriptorvalue. Setsanexceptionandreturns-1onfailure.
PyObject*PyFile_GetLine(PyObject*p,intn)
Returnvalue: Newreference. PartoftheStableABI.Equivalenttop.readline([n]), thisfunctionreads
onelinefromtheobjectp. pmaybeafileobjectoranyobjectwithareadline()method. Ifnis0,exactly
onelineisread,regardlessofthelengthoftheline. Ifnisgreaterthan0,nomorethannbyteswillberead
fromthefile;apartiallinecanbereturned. Inbothcases,anemptystringisreturnediftheendofthefileis
reachedimmediately. Ifnislessthan0,however,onelineisreadregardlessoflength,butEOFErrorisraised
iftheendofthefileisreachedimmediately.
intPyFile_SetOpenCodeHook(Py_OpenCodeHookFunctionhandler)
Overridesthenormalbehaviorofio.open_code()topassitsparameterthroughtheprovidedhandler.
Thehandlerisafunctionoftype:
typedefPyObject*(*Py_OpenCodeHookFunction)(PyObject*,void*)
Equivalent of PyObject *(*)(PyObject *path, void *userData), where path is guaranteed
tobePyUnicodeObject.
The userData pointer is passed into the hook function. Since hook functions may be called from different
runtimes,thispointershouldnotreferdirectlytoPythonstate.
Asthishookisintentionallyusedduringimport,avoidimportingnewmodulesduringitsexecutionunlessthey
areknowntobefrozenoravailableinsys.modules.
Onceahookhasbeenset,itcannotberemovedorreplaced,andlatercallstoPyFile_SetOpenCodeHook()
willfail. Onfailure,thefunctionreturns-1andsetsanexceptioniftheinterpreterhasbeeninitialized.
ThisfunctionissafetocallbeforePy_Initialize().
Raisesanauditingeventsetopencodehookwithnoarguments.
Addedinversion3.8.
200 Chapter9. ConcreteObjectsLayer

| (cid:193) Warning |
| --- |
| SincePythonstreamshavetheirownbufferinglayer,mixingthemwithOS-levelfiledescriptorscanpro-
ducevariousissues(suchasunexpectedorderingofdata). |

### 第209页

intPyFile_WriteObject(PyObject*obj,PyObject*p,intflags)
PartoftheStableABI.Writeobjectobjtofileobjectp. TheonlysupportedflagforflagsisPy_PRINT_RAW;
ifgiven,thestr()oftheobjectiswritteninsteadoftherepr(). Return0onsuccessor-1onfailure;the
appropriateexceptionwillbeset.
intPyFile_WriteString(constchar*s,PyObject*p)
PartoftheStableABI.Writestrings tofileobjectp. Return0onsuccessor-1onfailure; theappropriate
exceptionwillbeset.
9.6.2 Module Objects
PyTypeObjectPyModule_Type
PartoftheStableABI.ThisinstanceofPyTypeObjectrepresentsthePythonmoduletype. Thisisexposed
toPythonprogramsastypes.ModuleType.
intPyModule_Check(PyObject*p)
Returntrueifpisamoduleobject,orasubtypeofamoduleobject. Thisfunctionalwayssucceeds.
intPyModule_CheckExact(PyObject*p)
Returntrueifpisamoduleobject,butnotasubtypeofPyModule_Type. Thisfunctionalwayssucceeds.
PyObject*PyModule_NewObject(PyObject*name)
Return value: New reference. Part of the Stable ABI since version 3.7. Return a new module object with
module.__name__ set to name. The module’s __name__, __doc__, __package__ and __loader__
attributesarefilledin(allbut__name__aresettoNone). Thecallerisresponsibleforsettinga__file__
attribute.
ReturnNULLwithanexceptionsetonerror.
Addedinversion3.3.
Changedinversion3.4: __package__and__loader__arenowsettoNone.
PyObject*PyModule_New(constchar*name)
Returnvalue: Newreference. PartoftheStableABI.SimilartoPyModule_NewObject(),butthenameisa
UTF-8encodedstringinsteadofaUnicodeobject.
PyObject*PyModule_GetDict(PyObject*module)
Returnvalue: Borrowedreference. PartoftheStableABI.Returnthedictionaryobjectthatimplementsmod-
ule’snamespace; thisobjectisthesameasthe__dict__attributeofthemoduleobject. Ifmoduleisnota
moduleobject(orasubtypeofamoduleobject),SystemErrorisraisedandNULLisreturned.
ItisrecommendedextensionsuseotherPyModule_*andPyObject_*functionsratherthandirectlymanip-
ulateamodule’s__dict__.
PyObject*PyModule_GetNameObject(PyObject*module)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.7. Returnmodule’s__name__value. If
themoduledoesnotprovideone,orifitisnotastring,SystemErrorisraisedandNULLisreturned.
Addedinversion3.3.
constchar*PyModule_GetName(PyObject*module)
PartoftheStableABI.SimilartoPyModule_GetNameObject()butreturnthenameencodedto'utf-8'.
void*PyModule_GetState(PyObject*module)
PartoftheStableABI.Returnthe“state”ofthemodule,thatis,apointertotheblockofmemoryallocatedat
modulecreationtime,orNULL.SeePyModuleDef.m_size.
PyModuleDef *PyModule_GetDef(PyObject*module)
PartoftheStableABI.ReturnapointertothePyModuleDef structfromwhichthemodulewascreated,or
NULLifthemodulewasn’tcreatedfromadefinition.
9.6. OtherObjects 201

### 第210页

PyObject*PyModule_GetFilenameObject(PyObject*module)
Return value: New reference. Part of the Stable ABI. Return the name of the file from which module was
loadedusingmodule’s__file__attribute. Ifthisisnotdefined,orifitisnotastring,raiseSystemError
andreturnNULL;otherwisereturnareferencetoaUnicodeobject.
Addedinversion3.2.
constchar*PyModule_GetFilename(PyObject*module)
PartoftheStableABI.SimilartoPyModule_GetFilenameObject()butreturnthefilenameencodedto
‘utf-8’.
Deprecatedsinceversion3.2: PyModule_GetFilename()raisesUnicodeEncodeErroronunencodable
filenames,usePyModule_GetFilenameObject()instead.
9.6.3 Module definitions
Thefunctionsintheprevioussectionworkonanymoduleobject,includingmodulesimportedfromPythoncode.
ModulesdefinedusingtheCAPItypicallyuseamoduledefinition,PyModuleDef –astaticallyallocated,constant
“description”ofhowamoduleshouldbecreated.
The definition is usually used to define an extension’s “main” module object (see Defining extension modules for
details). Itisalsousedtocreateextensionmodulesdynamically.
UnlikePyModule_New(),thedefinitionallowsmanagementofmodulestate–apieceofmemorythatisallocated
andclearedtogetherwiththemoduleobject. Unlikethemodule’sPythonattributes,Pythoncodecannotreplaceor
deletedatastoredinmodulestate.
typePyModuleDef
Part of the Stable ABI (including all members). The module definition struct, which holds all information
neededtocreateamoduleobject. Thisstructuremustbestaticallyallocated(orbeotherwiseguaranteedto
be valid while any modules created from it exist). Usually, there is only one variable of this type for each
extensionmodule.
PyModuleDef_Basem_base
AlwaysinitializethismembertoPyModuleDef_HEAD_INIT.
constchar*m_name
Nameforthenewmodule.
constchar*m_doc
Docstringforthemodule;usuallyadocstringvariablecreatedwithPyDoc_STRVARisused.
Py_ssize_tm_size
Module state may be kept in a per-module memory area that can be retrieved with
PyModule_GetState(), rather than in static globals. This makes modules safe for use in mul-
tiplesub-interpreters.
Thismemoryareaisallocatedbasedonm_sizeonmodulecreation,andfreedwhenthemoduleobjectis
deallocated,afterthem_freefunctionhasbeencalled,ifpresent.
Settingittoanon-negativevaluemeansthatthemodulecanbere-initializedandspecifiestheadditional
amountofmemoryitrequiresforitsstate.
Setting m_size to -1 means that the module does not support sub-interpreters, because it has global
state. Negative m_size is only allowed when using legacy single-phase initialization or when creating
modulesdynamically.
SeePEP3121formoredetails.
PyMethodDef *m_methods
Apointertoatableofmodule-levelfunctions,describedbyPyMethodDef values. CanbeNULLifno
functionsarepresent.
202 Chapter9. ConcreteObjectsLayer

### 第211页

PyModuleDef_Slot*m_slots
Anarrayofslotdefinitionsformulti-phaseinitialization,terminatedbya{0, NULL}entry. Whenusing
legacysingle-phaseinitialization,m_slotsmustbeNULL.
Changedinversion3.5: Priortoversion3.5,thismemberwasalwayssettoNULL,andwasdefinedas:
inquirym_reload
traverseprocm_traverse
AtraversalfunctiontocallduringGCtraversalofthemoduleobject,orNULLifnotneeded.
This function is not called if the module state was requested but is not allocated yet. This is the case
immediately after the module is created and before the module is executed (Py_mod_exec function).
Moreprecisely,thisfunctionisnotcalledifm_sizeisgreaterthan0andthemodulestate(asreturned
byPyModule_GetState())isNULL.
Changedinversion3.9: Nolongercalledbeforethemodulestateisallocated.
inquirym_clear
AclearfunctiontocallduringGCclearingofthemoduleobject,orNULLifnotneeded.
This function is not called if the module state was requested but is not allocated yet. This is the case
immediately after the module is created and before the module is executed (Py_mod_exec function).
Moreprecisely,thisfunctionisnotcalledifm_sizeisgreaterthan0andthemodulestate(asreturned
byPyModule_GetState())isNULL.
LikePyTypeObject.tp_clear,thisfunctionisnotalwayscalledbeforeamoduleisdeallocated. For
example, when reference counting is enough to determine that an object is no longer used, the cyclic
garbagecollectorisnotinvolvedandm_freeiscalleddirectly.
Changedinversion3.9: Nolongercalledbeforethemodulestateisallocated.
freefuncm_free
Afunctiontocallduringdeallocationofthemoduleobject,orNULLifnotneeded.
This function is not called if the module state was requested but is not allocated yet. This is the case
immediately after the module is created and before the module is executed (Py_mod_exec function).
Moreprecisely,thisfunctionisnotcalledifm_sizeisgreaterthan0andthemodulestate(asreturned
byPyModule_GetState())isNULL.
Changedinversion3.9: Nolongercalledbeforethemodulestateisallocated.
Moduleslots
typePyModuleDef_Slot
intslot
AslotID,chosenfromtheavailablevaluesexplainedbelow.
void*value
Valueoftheslot,whosemeaningdependsontheslotID.
Addedinversion3.5.
Theavailableslottypesare:
Py_mod_create
Specifiesafunctionthatiscalledtocreatethemoduleobjectitself. Thevaluepointerofthisslotmustpoint
toafunctionofthesignature:
PyObject*create_module(PyObject*spec,PyModuleDef *def)
ThefunctionreceivesaModuleSpecinstance,asdefinedinPEP451,andthemoduledefinition. Itshould
returnanewmoduleobject,orsetanerrorandreturnNULL.
9.6. OtherObjects 203

### 第212页

Thisfunctionshouldbekeptminimal. Inparticular,itshouldnotcallarbitraryPythoncode,astryingtoimport
thesamemoduleagainmayresultinaninfiniteloop.
MultiplePy_mod_createslotsmaynotbespecifiedinonemoduledefinition.
If Py_mod_create is not specified, the import machinery will create a normal module object using
PyModule_New(). Thenameistakenfromspec,notthedefinition,toallowextensionmodulestodynami-
callyadjusttotheirplaceinthemodulehierarchyandbeimportedunderdifferentnamesthroughsymlinks,
allwhilesharingasinglemoduledefinition.
ThereisnorequirementforthereturnedobjecttobeaninstanceofPyModule_Type. Anytypecanbeused,
aslongasitsupportssettingandgettingimport-relatedattributes. However,onlyPyModule_Typeinstances
maybereturnedifthePyModuleDefhasnon-NULLm_traverse,m_clear,m_free;non-zerom_size;or
slotsotherthanPy_mod_create.
Py_mod_exec
Specifiesafunctionthatiscalledtoexecutethemodule. ThisisequivalenttoexecutingthecodeofaPython
module: typically,thisfunctionaddsclassesandconstantstothemodule. Thesignatureofthefunctionis:
intexec_module(PyObject*module)
IfmultiplePy_mod_execslotsarespecified,theyareprocessedintheordertheyappearinthem_slotsarray.
Py_mod_multiple_interpreters
Specifiesoneofthefollowingvalues:
Py_MOD_MULTIPLE_INTERPRETERS_NOT_SUPPORTED
Themoduledoesnotsupportbeingimportedinsubinterpreters.
Py_MOD_MULTIPLE_INTERPRETERS_SUPPORTED
Themodulesupportsbeingimportedinsubinterpreters,butonlywhentheysharethemaininterpreter’s
GIL.(Seeisolating-extensions-howto.)
Py_MOD_PER_INTERPRETER_GIL_SUPPORTED
The module supports being imported in subinterpreters, even when they have their own GIL. (See
isolating-extensions-howto.)
Thisslotdetermineswhetherornotimportingthismoduleinasubinterpreterwillfail.
MultiplePy_mod_multiple_interpretersslotsmaynotbespecifiedinonemoduledefinition.
If Py_mod_multiple_interpreters is not specified, the import machinery defaults to
Py_MOD_MULTIPLE_INTERPRETERS_SUPPORTED.
Addedinversion3.12.
Py_mod_gil
Specifiesoneofthefollowingvalues:
Py_MOD_GIL_USED
Themoduledependsonthepresenceoftheglobalinterpreterlock(GIL),andmayaccessglobalstate
withoutsynchronization.
Py_MOD_GIL_NOT_USED
ThemoduleissafetorunwithoutanactiveGIL.
ThisslotisignoredbyPythonbuildsnotconfiguredwith--disable-gil. Otherwise,itdetermineswhether
ornotimportingthismodulewillcausetheGILtobeautomaticallyenabled. Seewhatsnew313-free-threaded-
cpythonformoredetail.
MultiplePy_mod_gilslotsmaynotbespecifiedinonemoduledefinition.
IfPy_mod_gilisnotspecified,theimportmachinerydefaultstoPy_MOD_GIL_USED.
Addedinversion3.13.
204 Chapter9. ConcreteObjectsLayer

### 第213页

9.6.4 Creating extension modules dynamically
The following functions may be used to create a module outside of an extension’s initialization function. They are
alsousedinsingle-phaseinitialization.
PyObject*PyModule_Create(PyModuleDef *def)
Return value: New reference. Create a new module object, given the definition in def. This is a
macro that calls PyModule_Create2() with module_api_version set to PYTHON_API_VERSION, or to
PYTHON_ABI_VERSION ifusingthelimitedAPI.
PyObject*PyModule_Create2(PyModuleDef *def,intmodule_api_version)
Return value: New reference. Part of the Stable ABI. Create a new module object, given the definition in
def,assumingtheAPIversionmodule_api_version. Ifthatversiondoesnotmatchtheversionoftherunning
interpreter,aRuntimeWarningisemitted.
ReturnNULLwithanexceptionsetonerror.
Thisfunctiondoesnotsupportslots. Them_slotsmemberofdef mustbeNULL.
(cid:174) Note
MostusesofthisfunctionshouldbeusingPyModule_Create()instead;onlyusethisifyouaresureyou
needit.
PyObject*PyModule_FromDefAndSpec(PyModuleDef *def,PyObject*spec)
Returnvalue: Newreference. ThismacrocallsPyModule_FromDefAndSpec2()withmodule_api_version
settoPYTHON_API_VERSION,ortoPYTHON_ABI_VERSION ifusingthelimitedAPI.
Addedinversion3.5.
PyObject*PyModule_FromDefAndSpec2(PyModuleDef *def,PyObject*spec,intmodule_api_version)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.7. Createanewmoduleobject,giventhe
definitionindefandtheModuleSpecspec,assumingtheAPIversionmodule_api_version. Ifthatversiondoes
notmatchtheversionoftherunninginterpreter,aRuntimeWarningisemitted.
ReturnNULLwithanexceptionsetonerror.
Note that this does not process execution slots (Py_mod_exec). Both PyModule_FromDefAndSpec and
PyModule_ExecDefmustbecalledtofullyinitializeamodule.
(cid:174) Note
MostusesofthisfunctionshouldbeusingPyModule_FromDefAndSpec()instead;onlyusethisifyou
aresureyouneedit.
Addedinversion3.5.
intPyModule_ExecDef(PyObject*module,PyModuleDef *def)
PartoftheStableABIsinceversion3.7. Processanyexecutionslots(Py_mod_exec)givenindef.
Addedinversion3.5.
PYTHON_API_VERSION
TheCAPIversion. Definedforbackwardscompatibility.
Currently, this constant is not updated in new Python versions, and is not useful for versioning. This may
changeinthefuture.
PYTHON_ABI_VERSION
Definedas3forbackwardscompatibility.
9.6. OtherObjects 205

### 第214页

Currently, this constant is not updated in new Python versions, and is not useful for versioning. This may
changeinthefuture.
9.6.5 Support functions
Thefollowingfunctionsareprovidedtohelpinitializeamodulestate. Theyareintendedforamodule’sexecution
slots(Py_mod_exec), theinitializationfunctionforlegacysingle-phaseinitialization,orcodethatcreatesmodules
dynamically.
intPyModule_AddObjectRef(PyObject*module,constchar*name,PyObject*value)
PartoftheStableABIsinceversion3.10. Addanobjecttomoduleasname. Thisisaconveniencefunction
whichcanbeusedfromthemodule’sinitializationfunction.
Onsuccess,return0. Onerror,raiseanexceptionandreturn-1.
Exampleusage:
static int
add_spam(PyObject *module, int value)
{
PyObject *obj = PyLong_FromLong(value);
if (obj == NULL) {
return -1;
}
int res = PyModule_AddObjectRef(module, "spam", obj);
Py_DECREF(obj);
return res;
}
Tobeconvenient,thefunctionacceptsNULLvaluewithanexceptionset. Inthiscase,return-1andjustleave
theraisedexceptionunchanged.
TheexamplecanalsobewrittenwithoutcheckingexplicitlyifobjisNULL:
static int
add_spam(PyObject *module, int value)
{
PyObject *obj = PyLong_FromLong(value);
int res = PyModule_AddObjectRef(module, "spam", obj);
Py_XDECREF(obj);
return res;
}
NotethatPy_XDECREF()shouldbeusedinsteadofPy_DECREF()inthiscase,sinceobjcanbeNULL.
The number of different name strings passed to this function should be kept small, usually by
only using statically allocated strings as name. For names that aren’t known at compile time, pre-
fer calling PyUnicode_FromString() and PyObject_SetAttr() directly. For more details, see
PyUnicode_InternFromString(),whichmaybeusedinternallytocreateakeyobject.
Addedinversion3.10.
intPyModule_Add(PyObject*module,constchar*name,PyObject*value)
PartoftheStableABIsinceversion3.13. SimilartoPyModule_AddObjectRef(),but“steals”areference
tovalue. Itcanbecalledwitharesultoffunctionthatreturnsanewreferencewithoutbotheringtocheckits
resultorevensavingittoavariable.
Exampleusage:
if (PyModule_Add(module, "spam", PyBytes_FromString(value)) < 0) {
goto error;
}
206 Chapter9. ConcreteObjectsLayer

### 第215页

Addedinversion3.13.
intPyModule_AddObject(PyObject*module,constchar*name,PyObject*value)
PartoftheStableABI.SimilartoPyModule_AddObjectRef(),butstealsareferencetovalueonsuccess
(ifitreturns0).
ThenewPyModule_Add() orPyModule_AddObjectRef() functionsarerecommended, sinceitiseasy
tointroducereferenceleaksbymisusingthePyModule_AddObject()function.
(cid:174) Note
Unlikeotherfunctionsthatstealreferences,PyModule_AddObject()onlyreleasesthereferencetovalue
onsuccess.
Thismeansthatitsreturnvaluemustbechecked,andcallingcodemustPy_XDECREF()valuemanually
onerror.
Exampleusage:
PyObject *obj = PyBytes_FromString(value);
if (PyModule_AddObject(module, "spam", obj) < 0) {
// If 'obj' is not NULL and PyModule_AddObject() failed,
// 'obj' strong reference must be deleted with Py_XDECREF().
// If 'obj' is NULL, Py_XDECREF() does nothing.
Py_XDECREF(obj);
goto error;
}
// PyModule_AddObject() stole a reference to obj:
// Py_XDECREF(obj) is not needed here.
Deprecatedsinceversion3.13: PyModule_AddObject()issoftdeprecated.
intPyModule_AddIntConstant(PyObject*module,constchar*name,longvalue)
PartoftheStableABI.Addanintegerconstanttomoduleasname. Thisconveniencefunctioncanbeused
fromthemodule’sinitializationfunction. Return-1withanexceptionsetonerror,0onsuccess.
ThisisaconveniencefunctionthatcallsPyLong_FromLong()andPyModule_AddObjectRef();seetheir
documentationfordetails.
intPyModule_AddStringConstant(PyObject*module,constchar*name,constchar*value)
PartoftheStableABI.Addastringconstanttomoduleasname. Thisconveniencefunctioncanbeusedfrom
themodule’sinitializationfunction. ThestringvaluemustbeNULL-terminated. Return-1withanexception
setonerror,0onsuccess.
This is a convenience function that calls PyUnicode_InternFromString() and
PyModule_AddObjectRef();seetheirdocumentationfordetails.
PyModule_AddIntMacro(module,macro)
Add an int constant to module. The name and the value are taken from macro. For example
PyModule_AddIntMacro(module, AF_INET)addstheintconstantAF_INETwiththevalueofAF_INET
tomodule. Return-1withanexceptionsetonerror,0onsuccess.
PyModule_AddStringMacro(module,macro)
Addastringconstanttomodule.
intPyModule_AddType(PyObject*module,PyTypeObject*type)
PartoftheStableABIsinceversion3.10. Addatypeobjecttomodule. Thetypeobjectisfinalizedbycalling
internallyPyType_Ready(). Thenameofthetypeobjectistakenfromthelastcomponentoftp_nameafter
dot. Return-1withanexceptionsetonerror,0onsuccess.
Addedinversion3.9.
9.6. OtherObjects 207

### 第216页

intPyModule_AddFunctions(PyObject*module,PyMethodDef *functions)
PartoftheStableABIsinceversion3.7. AddthefunctionsfromtheNULLterminatedfunctionsarraytomodule.
RefertothePyMethodDefdocumentationfordetailsonindividualentries(duetothelackofasharedmodule
namespace,modulelevel“functions”implementedinCtypicallyreceivethemoduleastheirfirstparameter,
makingthemsimilartoinstancemethodsonPythonclasses).
ThisfunctioniscalledautomaticallywhencreatingamodulefromPyModuleDef(suchaswhenusingMulti-
phaseinitialization,PyModule_Create,orPyModule_FromDefAndSpec). Somemoduleauthorsmaypre-
ferdefiningfunctionsinmultiplePyMethodDef arrays;inthatcasetheyshouldcallthisfunctiondirectly.
Addedinversion3.5.
intPyModule_SetDocString(PyObject*module,constchar*docstring)
Part of the Stable ABI since version 3.7. Set the docstring for module to docstring. This function is called
automatically when creating a module from PyModuleDef (such as when using Multi-phase initialization,
PyModule_Create,orPyModule_FromDefAndSpec).
Addedinversion3.5.
intPyUnstable_Module_SetGIL(PyObject*module,void*gil)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Indicate that module does or does not support running without the global interpreter lock (GIL), using one
ofthevaluesfromPy_mod_gil. Itmustbecalledduringmodule’sinitializationfunctionwhenusingLegacy
single-phase initialization. If this function is not called during module initialization, the import machinery
assumesthemoduledoesnotsupportrunningwithouttheGIL.ThisfunctionisonlyavailableinPythonbuilds
configuredwith--disable-gil. Return-1withanexceptionsetonerror,0onsuccess.
Addedinversion3.13.
Modulelookup(single-phaseinitialization)
The legacy single-phase initialization initialization scheme creates singleton modules that can be looked up in the
context of the current interpreter. This allows the module object to be retrieved later with only a reference to the
moduledefinition.
Thesefunctionswillnotworkonmodulescreatedusingmulti-phaseinitialization,sincemultiplesuchmodulescan
becreatedfromasingledefinition.
PyObject*PyState_FindModule(PyModuleDef *def)
Returnvalue: Borrowedreference. PartoftheStableABI.Returnsthemoduleobjectthatwascreatedfromdef
forthecurrentinterpreter. Thismethodrequiresthatthemoduleobjecthasbeenattachedtotheinterpreter
statewithPyState_AddModule()beforehand. Incasethecorrespondingmoduleobjectisnotfoundorhas
notbeenattachedtotheinterpreterstateyet,itreturnsNULL.
intPyState_AddModule(PyObject*module,PyModuleDef *def)
PartoftheStableABIsinceversion3.3. Attachesthemoduleobjectpassedtothefunctiontotheinterpreter
state. ThisallowsthemoduleobjecttobeaccessibleviaPyState_FindModule().
Onlyeffectiveonmodulescreatedusingsingle-phaseinitialization.
PythoncallsPyState_AddModuleautomaticallyafterimportingamodulethatusessingle-phaseinitializa-
tion,soitisunnecessary(butharmless)tocallitfrommoduleinitializationcode. Anexplicitcallisneededonly
ifthemodule’sowninitcodesubsequentlycallsPyState_FindModule. Thefunctionismainlyintendedfor
implementingalternativeimportmechanisms(eitherbycallingitdirectly,orbyreferringtoitsimplementation
fordetailsoftherequiredstateupdates).
Ifamodulewasattachedpreviouslyusingthesamedef,itisreplacedbythenewmodule.
Thecallermusthaveanattachedthreadstate.
208 Chapter9. ConcreteObjectsLayer

### 第217页

Return-1withanexceptionsetonerror,0onsuccess.
Addedinversion3.3.
intPyState_RemoveModule(PyModuleDef *def)
Part of the Stable ABI since version 3.3. Removes the module object created from def from the interpreter
state. Return-1withanexceptionsetonerror,0onsuccess.
Thecallermusthaveanattachedthreadstate.
Addedinversion3.3.
9.6.6 Iterator Objects
Pythonprovidestwogeneral-purposeiteratorobjects. Thefirst,asequenceiterator,workswithanarbitrarysequence
supportingthe__getitem__()method. Thesecondworkswithacallableobjectandasentinelvalue,callingthe
callableforeachiteminthesequence,andendingtheiterationwhenthesentinelvalueisreturned.
PyTypeObjectPySeqIter_Type
PartoftheStableABI.TypeobjectforiteratorobjectsreturnedbyPySeqIter_New()andtheone-argument
formoftheiter()built-infunctionforbuilt-insequencetypes.
intPySeqIter_Check(PyObject*op)
ReturntrueifthetypeofopisPySeqIter_Type. Thisfunctionalwayssucceeds.
PyObject*PySeqIter_New(PyObject*seq)
Return value: New reference. Part of the Stable ABI. Return an iterator that works with a general sequence
object,seq. TheiterationendswhenthesequenceraisesIndexErrorforthesubscriptingoperation.
PyTypeObjectPyCallIter_Type
PartoftheStableABI.TypeobjectforiteratorobjectsreturnedbyPyCallIter_New()andthetwo-argument
formoftheiter()built-infunction.
intPyCallIter_Check(PyObject*op)
ReturntrueifthetypeofopisPyCallIter_Type. Thisfunctionalwayssucceeds.
PyObject*PyCallIter_New(PyObject*callable,PyObject*sentinel)
Returnvalue: Newreference. PartoftheStableABI.Returnanewiterator. Thefirstparameter,callable,can
beanyPythoncallableobjectthatcanbecalledwithnoparameters;eachcalltoitshouldreturnthenextitem
intheiteration. Whencallablereturnsavalueequaltosentinel,theiterationwillbeterminated.
9.6.7 Descriptor Objects
“Descriptors”areobjectsthatdescribesomeattributeofanobject. Theyarefoundinthedictionaryoftypeobjects.
PyTypeObjectPyProperty_Type
PartoftheStableABI.Thetypeobjectforthebuilt-indescriptortypes.
PyObject*PyDescr_NewGetSet(PyTypeObject*type,structPyGetSetDef *getset)
Returnvalue: Newreference. PartoftheStableABI.
PyObject*PyDescr_NewMember(PyTypeObject*type,structPyMemberDef *meth)
Returnvalue: Newreference. PartoftheStableABI.
PyObject*PyDescr_NewMethod(PyTypeObject*type,structPyMethodDef *meth)
Returnvalue: Newreference. PartoftheStableABI.
PyObject*PyDescr_NewWrapper(PyTypeObject*type,structwrapperbase*wrapper,void*wrapped)
Returnvalue: Newreference.
PyObject*PyDescr_NewClassMethod(PyTypeObject*type,PyMethodDef *method)
Returnvalue: Newreference. PartoftheStableABI.
9.6. OtherObjects 209

### 第218页

intPyDescr_IsData(PyObject*descr)
Returnnon-zeroifthedescriptorobjectsdescrdescribesadataattribute,or0ifitdescribesamethod. descr
mustbeadescriptorobject;thereisnoerrorchecking.
PyObject*PyWrapper_New(PyObject*,PyObject*)
Returnvalue: Newreference. PartoftheStableABI.
9.6.8 Slice Objects
PyTypeObjectPySlice_Type
PartoftheStableABI.Thetypeobjectforsliceobjects. ThisisthesameassliceinthePythonlayer.
intPySlice_Check(PyObject*ob)
Returntrueifobisasliceobject;obmustnotbeNULL.Thisfunctionalwayssucceeds.
PyObject*PySlice_New(PyObject*start,PyObject*stop,PyObject*step)
Returnvalue: Newreference. PartoftheStableABI.Returnanewsliceobjectwiththegivenvalues. Thestart,
stop,andstepparametersareusedasthevaluesofthesliceobjectattributesofthesamenames. Anyofthe
valuesmaybeNULL,inwhichcasetheNonewillbeusedforthecorrespondingattribute.
ReturnNULLwithanexceptionsetifthenewobjectcouldnotbeallocated.
intPySlice_GetIndices(PyObject*slice,Py_ssize_tlength,Py_ssize_t*start,Py_ssize_t*stop,Py_ssize_t
*step)
PartoftheStableABI.Retrievethestart,stopandstepindicesfromthesliceobjectslice,assumingasequence
oflengthlength. Treatsindicesgreaterthanlengthaserrors.
Returns0onsuccessand-1onerrorwithnoexceptionset(unlessoneoftheindiceswasnotNoneandfailed
tobeconvertedtoaninteger,inwhichcase-1isreturnedwithanexceptionset).
Youprobablydonotwanttousethisfunction.
Changedinversion3.2: TheparametertypeforthesliceparameterwasPySliceObject*before.
intPySlice_GetIndicesEx(PyObject*slice,Py_ssize_tlength,Py_ssize_t*start,Py_ssize_t*stop,Py_ssize_t
*step,Py_ssize_t*slicelength)
PartoftheStableABI.UsablereplacementforPySlice_GetIndices(). Retrievethestart,stop,andstep
indices from the slice object slice assuming a sequence of length length, and store the length of the slice in
slicelength. Outofboundsindicesareclippedinamannerconsistentwiththehandlingofnormalslices.
Return0onsuccessand-1onerrorwithanexceptionset.
(cid:174) Note
Thisfunctionisconsiderednotsafeforresizablesequences. Itsinvocationshouldbereplacedbyacombi-
nationofPySlice_Unpack()andPySlice_AdjustIndices()where
if (PySlice_GetIndicesEx(slice, length, &start, &stop, &step, &slicelength)
,→< 0) {
// return error
}
isreplacedby
if (PySlice_Unpack(slice, &start, &stop, &step) < 0) {
// return error
}
slicelength = PySlice_AdjustIndices(length, &start, &stop, step);
Changedinversion3.2: TheparametertypeforthesliceparameterwasPySliceObject*before.
210 Chapter9. ConcreteObjectsLayer

### 第219页

Changed in version 3.6.1: If Py_LIMITED_API is not set or set to the value between 0x03050400 and
0x03060000 (not including) or 0x03060100 or higher PySlice_GetIndicesEx() is implemented as a
macro using PySlice_Unpack() and PySlice_AdjustIndices(). Arguments start, stop and step are
evaluatedmorethanonce.
Deprecatedsinceversion3.6.1: IfPy_LIMITED_APIissettothevaluelessthan0x03050400orbetween
0x03060000and0x03060100(notincluding)PySlice_GetIndicesEx()isadeprecatedfunction.
intPySlice_Unpack(PyObject*slice,Py_ssize_t*start,Py_ssize_t*stop,Py_ssize_t*step)
PartoftheStableABIsinceversion3.7. Extractthestart,stopandstepdatamembersfromasliceobjectasC
integers. SilentlyreducevalueslargerthanPY_SSIZE_T_MAXtoPY_SSIZE_T_MAX,silentlyboostthestart
andstopvalueslessthanPY_SSIZE_T_MINtoPY_SSIZE_T_MIN,andsilentlyboostthestepvalueslessthan
-PY_SSIZE_T_MAXto-PY_SSIZE_T_MAX.
Return-1withanexceptionsetonerror,0onsuccess.
Addedinversion3.6.1.
Py_ssize_tPySlice_AdjustIndices(Py_ssize_tlength,Py_ssize_t*start,Py_ssize_t*stop,Py_ssize_tstep)
PartoftheStableABIsinceversion3.7. Adjuststart/endsliceindicesassumingasequenceofthespecified
length. Outofboundsindicesareclippedinamannerconsistentwiththehandlingofnormalslices.
Returnthelengthoftheslice. Alwayssuccessful. Doesn’tcallPythoncode.
Addedinversion3.6.1.
EllipsisObject
PyTypeObjectPyEllipsis_Type
PartoftheStableABI.ThetypeofPythonEllipsisobject. Sameastypes.EllipsisTypeinthePython
layer.
PyObject*Py_Ellipsis
ThePythonEllipsisobject. Thisobjecthasnomethods. LikePy_None,itisanimmortalsingletonobject.
Changedinversion3.12: Py_Ellipsisisimmortal.
9.6.9 MemoryView objects
AmemoryviewobjectexposestheClevelbufferinterfaceasaPythonobjectwhichcanthenbepassedaroundlike
anyotherobject.
PyObject*PyMemoryView_FromObject(PyObject*obj)
Return value: New reference. Part of the Stable ABI. Create a memoryview object from an object that pro-
videsthebufferinterface. Ifobj supportswritablebufferexports,thememoryviewobjectwillberead/write,
otherwiseitmaybeeitherread-onlyorread/writeatthediscretionoftheexporter.
PyBUF_READ
Flagtorequestareadonlybuffer.
PyBUF_WRITE
Flagtorequestawritablebuffer.
PyObject*PyMemoryView_FromMemory(char*mem,Py_ssize_tsize,intflags)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.7. Createamemoryviewobjectusingmem
astheunderlyingbuffer. flagscanbeoneofPyBUF_READorPyBUF_WRITE.
Addedinversion3.3.
PyObject*PyMemoryView_FromBuffer(constPy_buffer*view)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.11. Createamemoryviewobjectwrapping
the given buffer structure view. For simple byte buffers, PyMemoryView_FromMemory() is the preferred
function.
9.6. OtherObjects 211

### 第220页

PyObject*PyMemoryView_GetContiguous(PyObject*obj,intbuffertype,charorder)
Returnvalue: Newreference. PartoftheStableABI.Createamemoryviewobjecttoacontiguouschunkof
memory(ineither‘C’or‘F’ortranorder)fromanobjectthatdefinesthebufferinterface. Ifmemoryiscontigu-
ous,thememoryviewobjectpointstotheoriginalmemory. Otherwise,acopyismadeandthememoryview
pointstoanewbytesobject.
buffertypecanbeoneofPyBUF_READorPyBUF_WRITE.
intPyMemoryView_Check(PyObject*obj)
Return true if the object obj is a memoryview object. It is not currently allowed to create subclasses of
memoryview. Thisfunctionalwayssucceeds.
Py_buffer*PyMemoryView_GET_BUFFER(PyObject*mview)
Return a pointer to the memoryview’s private copy of the exporter’s buffer. mview must be a memoryview
instance;thismacrodoesn’tcheckitstype,youmustdoityourselforyouwillriskcrashes.
PyObject*PyMemoryView_GET_BASE(PyObject*mview)
ReturneitherapointertotheexportingobjectthatthememoryviewisbasedonorNULLifthememoryviewhas
beencreatedbyoneofthefunctionsPyMemoryView_FromMemory()orPyMemoryView_FromBuffer().
mviewmustbeamemoryviewinstance.
9.6.10 Weak Reference Objects
Pythonsupportsweakreferencesasfirst-classobjects. Therearetwospecificobjecttypeswhichdirectlyimplement
weakreferences. Thefirstisasimplereferenceobject,andthesecondactsasaproxyfortheoriginalobjectasmuch
asitcan.
intPyWeakref_Check(PyObject*ob)
Returnnon-zeroifobiseitherareferenceorproxyobject. Thisfunctionalwayssucceeds.
intPyWeakref_CheckRef(PyObject*ob)
Returnnon-zeroifobisareferenceobject. Thisfunctionalwayssucceeds.
intPyWeakref_CheckProxy(PyObject*ob)
Returnnon-zeroifobisaproxyobject. Thisfunctionalwayssucceeds.
PyObject*PyWeakref_NewRef(PyObject*ob,PyObject*callback)
Returnvalue: Newreference. PartoftheStableABI.Returnaweakreferenceobjectfortheobjectob. This
willalwaysreturnanewreference,butisnotguaranteedtocreateanewobject; anexistingreferenceobject
maybereturned. Thesecondparameter,callback,canbeacallableobjectthatreceivesnotificationwhenobis
garbagecollected;itshouldacceptasingleparameter,whichwillbetheweakreferenceobjectitself. callback
mayalsobeNoneorNULL.Ifobisnotaweaklyreferenceableobject,orifcallbackisnotcallable,None,or
NULL,thiswillreturnNULLandraiseTypeError.
PyObject*PyWeakref_NewProxy(PyObject*ob,PyObject*callback)
Returnvalue: Newreference. PartoftheStableABI.Returnaweakreferenceproxyobjectfortheobjectob.
Thiswillalwaysreturnanewreference,butisnotguaranteedtocreateanewobject;anexistingproxyobject
maybereturned. Thesecondparameter,callback,canbeacallableobjectthatreceivesnotificationwhenobis
garbagecollected;itshouldacceptasingleparameter,whichwillbetheweakreferenceobjectitself. callback
mayalsobeNoneorNULL.Ifobisnotaweaklyreferenceableobject,orifcallbackisnotcallable,None,or
NULL,thiswillreturnNULLandraiseTypeError.
intPyWeakref_GetRef(PyObject*ref,PyObject**pobj)
PartoftheStableABIsinceversion3.13. Getastrongreferencetothereferencedobjectfromaweakreference,
ref,into*pobj.
• Onsuccess,set*pobjtoanewstrongreferencetothereferencedobjectandreturn1.
• Ifthereferenceisdead,set*pobjtoNULLandreturn0.
• Onerror,raiseanexceptionandreturn-1.
Addedinversion3.13.
212 Chapter9. ConcreteObjectsLayer

### 第221页

PyObject*PyWeakref_GetObject(PyObject*ref)
Returnvalue: Borrowedreference. PartoftheStableABI.Returnaborrowedreferencetothereferencedobject
fromaweakreference,ref. Ifthereferentisnolongerlive,returnsPy_None.
(cid:174) Note
This function returns a borrowed reference to the referenced object. This means that you should always
callPy_INCREF()ontheobjectexceptwhenitcannotbedestroyedbeforethelastusageoftheborrowed
reference.
Deprecatedsinceversion3.13,willberemovedinversion3.15: UsePyWeakref_GetRef()instead.
PyObject*PyWeakref_GET_OBJECT(PyObject*ref)
Returnvalue: Borrowedreference. SimilartoPyWeakref_GetObject(),butdoesnoerrorchecking.
Deprecatedsinceversion3.13,willberemovedinversion3.15: UsePyWeakref_GetRef()instead.
intPyWeakref_IsDead(PyObject*ref)
Testiftheweakreferenceref isdead. Returns1ifthereferenceisdead,0ifitisalive,and-1withanerror
setifref isnotaweakreferenceobject.
Addedinversion3.14.
voidPyObject_ClearWeakRefs(PyObject*object)
PartoftheStableABI.Thisfunctioniscalledbythetp_deallochandlertoclearweakreferences.
Thisiteratesthroughtheweakreferencesforobjectandcallscallbacksforthosereferenceswhichhaveone. It
returnswhenallcallbackshavebeenattempted.
voidPyUnstable_Object_ClearWeakRefsNoCallbacks(PyObject*object)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Clearstheweakrefsforobjectwithoutcallingthecallbacks.
Thisfunctioniscalledbythetp_deallochandlerfortypeswithfinalizers(i.e.,__del__()). Thehandler
forthoseobjectsfirstcallsPyObject_ClearWeakRefs()toclearweakrefsandcalltheircallbacks,thenthe
finalizer,andfinallythisfunctiontoclearanyweakrefsthatmayhavebeencreatedbythefinalizer.
Inmostcircumstances,it’smoreappropriatetousePyObject_ClearWeakRefs()toclearweakrefsinstead
ofthisfunction.
Addedinversion3.13.
9.6.11 Capsules
Refertousing-capsulesformoreinformationonusingtheseobjects.
Addedinversion3.1.
typePyCapsule
ThissubtypeofPyObjectrepresentsanopaquevalue,usefulforCextensionmoduleswhoneedtopassan
opaquevalue(asavoid*pointer)throughPythoncodetootherCcode. ItisoftenusedtomakeaCfunction
pointer defined in one module available to other modules, so the regular import mechanism can be used to
accessCAPIsdefinedindynamicallyloadedmodules.
typePyCapsule_Destructor
PartoftheStableABI.Thetypeofadestructorcallbackforacapsule. Definedas:
9.6. OtherObjects 213

### 第222页

typedef void (*PyCapsule_Destructor)(PyObject *);
SeePyCapsule_New()forthesemanticsofPyCapsule_Destructorcallbacks.
intPyCapsule_CheckExact(PyObject*p)
ReturntrueifitsargumentisaPyCapsule. Thisfunctionalwayssucceeds.
PyObject*PyCapsule_New(void*pointer,constchar*name,PyCapsule_Destructordestructor)
Return value: New reference. Part of the Stable ABI. Create a PyCapsule encapsulating the pointer. The
pointerargumentmaynotbeNULL.
Onfailure,setanexceptionandreturnNULL.
ThenamestringmayeitherbeNULLorapointertoavalidCstring. Ifnon-NULL,thisstringmustoutlivethe
capsule. (Thoughitispermittedtofreeitinsidethedestructor.)
IfthedestructorargumentisnotNULL,itwillbecalledwiththecapsuleasitsargumentwhenitisdestroyed.
If this capsule will be stored as an attribute of a module, the name should be specified as modulename.
attributename. ThiswillenableothermodulestoimportthecapsuleusingPyCapsule_Import().
void*PyCapsule_GetPointer(PyObject*capsule,constchar*name)
PartoftheStableABI.Retrievethepointerstoredinthecapsule. Onfailure,setanexceptionandreturnNULL.
Thenameparametermustcompareexactlytothenamestoredinthecapsule. Ifthenamestoredinthecapsule
isNULL,thenamepassedinmustalsobeNULL.PythonusestheCfunctionstrcmp()tocomparecapsule
names.
PyCapsule_DestructorPyCapsule_GetDestructor(PyObject*capsule)
PartoftheStableABI.Returnthecurrentdestructorstoredinthecapsule. Onfailure, setanexceptionand
returnNULL.
ItislegalforacapsuletohaveaNULLdestructor. ThismakesaNULLreturncodesomewhatambiguous;use
PyCapsule_IsValid()orPyErr_Occurred()todisambiguate.
void*PyCapsule_GetContext(PyObject*capsule)
PartoftheStableABI.Returnthecurrentcontextstoredinthecapsule. Onfailure,setanexceptionandreturn
NULL.
It is legal for a capsule to have a NULL context. This makes a NULL return code somewhat ambiguous; use
PyCapsule_IsValid()orPyErr_Occurred()todisambiguate.
constchar*PyCapsule_GetName(PyObject*capsule)
PartoftheStableABI.Returnthecurrentnamestoredinthecapsule. Onfailure,setanexceptionandreturn
NULL.
It is legal for a capsule to have a NULL name. This makes a NULL return code somewhat ambiguous; use
PyCapsule_IsValid()orPyErr_Occurred()todisambiguate.
void*PyCapsule_Import(constchar*name,intno_block)
PartoftheStableABI.ImportapointertoaCobjectfromacapsuleattributeinamodule. Thenameparameter
shouldspecifythefullnametotheattribute,asinmodule.attribute. Thenamestoredinthecapsulemust
matchthisstringexactly.
Thisfunctionsplitsnameonthe.character,andimportsthefirstelement. Itthenprocessesfurtherelements
usingattributelookups.
Returnthecapsule’sinternalpointeronsuccess. Onfailure,setanexceptionandreturnNULL.
(cid:174) Note
Ifnamepointstoanattributeofsomesubmoduleorsubpackage,thissubmoduleorsubpackagemustbe
previously imported using other means (for example, by using PyImport_ImportModule()) for the
attributelookupstosucceed.
214 Chapter9. ConcreteObjectsLayer

### 第223页

Changedinversion3.3: no_blockhasnoeffectanymore.
intPyCapsule_IsValid(PyObject*capsule,constchar*name)
Part of the Stable ABI. Determines whether or not capsule is a valid capsule. A valid capsule is non-NULL,
passesPyCapsule_CheckExact(),hasanon-NULLpointerstoredinit,anditsinternalnamematchesthe
nameparameter. (SeePyCapsule_GetPointer()forinformationonhowcapsulenamesarecompared.)
Inotherwords, ifPyCapsule_IsValid() returnsatruevalue, callstoanyoftheaccessors(anyfunction
startingwithPyCapsule_Get)areguaranteedtosucceed.
Returnanonzerovalueiftheobjectisvalidandmatchesthenamepassedin. Return0otherwise. Thisfunction
willnotfail.
intPyCapsule_SetContext(PyObject*capsule,void*context)
PartoftheStableABI.Setthecontextpointerinsidecapsuletocontext.
Return0onsuccess. Returnnonzeroandsetanexceptiononfailure.
intPyCapsule_SetDestructor(PyObject*capsule,PyCapsule_Destructordestructor)
PartoftheStableABI.Setthedestructorinsidecapsuletodestructor.
Return0onsuccess. Returnnonzeroandsetanexceptiononfailure.
intPyCapsule_SetName(PyObject*capsule,constchar*name)
PartoftheStableABI.Setthenameinsidecapsuletoname. Ifnon-NULL,thenamemustoutlivethecapsule.
IfthepreviousnamestoredinthecapsulewasnotNULL,noattemptismadetofreeit.
Return0onsuccess. Returnnonzeroandsetanexceptiononfailure.
intPyCapsule_SetPointer(PyObject*capsule,void*pointer)
PartoftheStableABI.Setthevoidpointerinsidecapsuletopointer. ThepointermaynotbeNULL.
Return0onsuccess. Returnnonzeroandsetanexceptiononfailure.
9.6.12 Frame Objects
typePyFrameObject
PartoftheLimitedAPI(asanopaquestruct). TheCstructureoftheobjectsusedtodescribeframeobjects.
Therearenopublicmembersinthisstructure.
Changedinversion3.11: ThemembersofthisstructurewereremovedfromthepublicCAPI.Refertothe
What’sNewentryfordetails.
ThePyEval_GetFrame()andPyThreadState_GetFrame()functionscanbeusedtogetaframeobject.
SeealsoReflection.
PyTypeObjectPyFrame_Type
Thetypeofframeobjects. Itisthesameobjectastypes.FrameTypeinthePythonlayer.
Changedinversion3.11: Previously,thistypewasonlyavailableafterincluding<frameobject.h>.
intPyFrame_Check(PyObject*obj)
Returnnon-zeroifobjisaframeobject.
Changedinversion3.11: Previously,thisfunctionwasonlyavailableafterincluding<frameobject.h>.
PyFrameObject*PyFrame_GetBack(PyFrameObject*frame)
Returnvalue: Newreference. Gettheframenextouterframe.
Returnastrongreference,orNULLifframehasnoouterframe.
Addedinversion3.9.
9.6. OtherObjects 215

### 第224页

PyObject*PyFrame_GetBuiltins(PyFrameObject*frame)
Returnvalue: Newreference. Gettheframe’sf_builtinsattribute.
Returnastrongreference. TheresultcannotbeNULL.
Addedinversion3.11.
PyCodeObject*PyFrame_GetCode(PyFrameObject*frame)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.10. Gettheframecode.
Returnastrongreference.
Theresult(framecode)cannotbeNULL.
Addedinversion3.9.
PyObject*PyFrame_GetGenerator(PyFrameObject*frame)
Returnvalue: Newreference. Getthegenerator,coroutine,orasyncgeneratorthatownsthisframe,orNULLif
thisframeisnotownedbyagenerator. Doesnotraiseanexception,evenifthereturnvalueisNULL.
Returnastrongreference,orNULL.
Addedinversion3.11.
PyObject*PyFrame_GetGlobals(PyFrameObject*frame)
Returnvalue: Newreference. Gettheframe’sf_globalsattribute.
Returnastrongreference. TheresultcannotbeNULL.
Addedinversion3.11.
intPyFrame_GetLasti(PyFrameObject*frame)
Gettheframe’sf_lastiattribute.
Returns-1ifframe.f_lastiisNone.
Addedinversion3.11.
PyObject*PyFrame_GetVar(PyFrameObject*frame,PyObject*name)
Returnvalue: Newreference. Getthevariablenameofframe.
• Returnastrongreferencetothevariablevalueonsuccess.
• RaiseNameErrorandreturnNULLifthevariabledoesnotexist.
• RaiseanexceptionandreturnNULLonerror.
nametypemustbeastr.
Addedinversion3.12.
PyObject*PyFrame_GetVarString(PyFrameObject*frame,constchar*name)
Returnvalue: Newreference. SimilartoPyFrame_GetVar(),butthevariablenameisaCstringencodedin
UTF-8.
Addedinversion3.12.
PyObject*PyFrame_GetLocals(PyFrameObject*frame)
Returnvalue: Newreference. Gettheframe’sf_localsattribute. Iftheframereferstoanoptimizedscope,
thisreturnsawrite-throughproxyobjectthatallowsmodifyingthelocals. Inallothercases(classes,modules,
exec(),eval())itreturnsthemappingrepresentingtheframelocalsdirectly(asdescribedforlocals()).
Returnastrongreference.
Addedinversion3.11.
Changedinversion3.13: AspartofPEP667,returnaninstanceofPyFrameLocalsProxy_Type.
intPyFrame_GetLineNumber(PyFrameObject*frame)
PartoftheStableABIsinceversion3.10. Returnthelinenumberthatframeiscurrentlyexecuting.
216 Chapter9. ConcreteObjectsLayer

### 第225页

FrameLocalsProxies
Addedinversion3.13.
The f_locals attribute on a frame object is an instance of a “frame-locals proxy”. The proxy object exposes a
write-through view of the underlying locals dictionary for the frame. This ensures that the variables exposed by
f_localsarealwaysuptodatewiththelivelocalvariablesintheframeitself.
SeePEP667formoreinformation.
PyTypeObjectPyFrameLocalsProxy_Type
Thetypeofframelocals()proxyobjects.
intPyFrameLocalsProxy_Check(PyObject*obj)
Returnnon-zeroifobjisaframelocals()proxy.
InternalFrames
UnlessusingPEP523,youwillnotneedthis.
struct_PyInterpreterFrame
Theinterpreter’sinternalframerepresentation.
Addedinversion3.11.
PyObject*PyUnstable_InterpreterFrame_GetCode(struct_PyInterpreterFrame*frame);
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Returnastrongreferencetothecodeobjectfortheframe.
Addedinversion3.12.
intPyUnstable_InterpreterFrame_GetLasti(struct_PyInterpreterFrame*frame);
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Returnthebyteoffsetintothelastexecutedinstruction.
Addedinversion3.12.
intPyUnstable_InterpreterFrame_GetLine(struct_PyInterpreterFrame*frame);
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Returnthecurrentlyexecutinglinenumber,or-1ifthereisnolinenumber.
Addedinversion3.12.
9.6.13 Generator Objects
GeneratorobjectsarewhatPythonusestoimplementgeneratoriterators. Theyarenormallycreatedbyiteratingover
afunctionthatyieldsvalues,ratherthanexplicitlycallingPyGen_New()orPyGen_NewWithQualName().
9.6. OtherObjects 217

### 第226页

typePyGenObject
TheCstructureusedforgeneratorobjects.
PyTypeObjectPyGen_Type
Thetypeobjectcorrespondingtogeneratorobjects.
intPyGen_Check(PyObject*ob)
Returntrueifobisageneratorobject;obmustnotbeNULL.Thisfunctionalwayssucceeds.
intPyGen_CheckExact(PyObject*ob)
Returntrueifob’stypeisPyGen_Type;obmustnotbeNULL.Thisfunctionalwayssucceeds.
PyObject*PyGen_New(PyFrameObject*frame)
Returnvalue: Newreference. Createandreturnanewgeneratorobjectbasedontheframeobject. Areference
toframeisstolenbythisfunction. TheargumentmustnotbeNULL.
PyObject*PyGen_NewWithQualName(PyFrameObject*frame,PyObject*name,PyObject*qualname)
Return value: New reference. Create and return a new generator object based on the frame object, with
__name__and__qualname__settonameandqualname. Areferencetoframeisstolenbythisfunction.
TheframeargumentmustnotbeNULL.
9.6.14 Coroutine Objects
Addedinversion3.5.
Coroutineobjectsarewhatfunctionsdeclaredwithanasynckeywordreturn.
typePyCoroObject
TheCstructureusedforcoroutineobjects.
PyTypeObjectPyCoro_Type
Thetypeobjectcorrespondingtocoroutineobjects.
intPyCoro_CheckExact(PyObject*ob)
Returntrueifob’stypeisPyCoro_Type;obmustnotbeNULL.Thisfunctionalwayssucceeds.
PyObject*PyCoro_New(PyFrameObject*frame,PyObject*name,PyObject*qualname)
Return value: New reference. Create and return a new coroutine object based on the frame object, with
__name__and__qualname__settonameandqualname. Areferencetoframeisstolenbythisfunction.
TheframeargumentmustnotbeNULL.
9.6.15 Context Variables Objects
Addedinversion3.7.
Changedinversion3.7.1:
(cid:174) Note
InPython3.7.1thesignaturesofallcontextvariablesCAPIswerechangedtousePyObjectpointersinstead
ofPyContext,PyContextVar,andPyContextToken,e.g.:
// in 3.7.0:
PyContext *PyContext_New(void);
// in 3.7.1+:
PyObject *PyContext_New(void);
Seebpo-34762formoredetails.
ThissectiondetailsthepublicCAPIforthecontextvarsmodule.
218 Chapter9. ConcreteObjectsLayer

### 第227页

typePyContext
TheCstructureusedtorepresentacontextvars.Contextobject.
typePyContextVar
TheCstructureusedtorepresentacontextvars.ContextVarobject.
typePyContextToken
TheCstructureusedtorepresentacontextvars.Tokenobject.
PyTypeObjectPyContext_Type
Thetypeobjectrepresentingthecontexttype.
PyTypeObjectPyContextVar_Type
Thetypeobjectrepresentingthecontextvariabletype.
PyTypeObjectPyContextToken_Type
Thetypeobjectrepresentingthecontextvariabletokentype.
Type-checkmacros:
intPyContext_CheckExact(PyObject*o)
ReturntrueifoisoftypePyContext_Type. omustnotbeNULL.Thisfunctionalwayssucceeds.
intPyContextVar_CheckExact(PyObject*o)
ReturntrueifoisoftypePyContextVar_Type. omustnotbeNULL.Thisfunctionalwayssucceeds.
intPyContextToken_CheckExact(PyObject*o)
ReturntrueifoisoftypePyContextToken_Type. omustnotbeNULL.Thisfunctionalwayssucceeds.
Contextobjectmanagementfunctions:
PyObject*PyContext_New(void)
Returnvalue: Newreference. Createanewemptycontextobject. ReturnsNULLifanerrorhasoccurred.
PyObject*PyContext_Copy(PyObject*ctx)
Returnvalue: Newreference. Createashallowcopyofthepassedctxcontextobject. ReturnsNULLifanerror
hasoccurred.
PyObject*PyContext_CopyCurrent(void)
Returnvalue: Newreference. Createashallowcopyofthecurrentthreadcontext. ReturnsNULLifanerror
hasoccurred.
intPyContext_Enter(PyObject*ctx)
Setctxasthecurrentcontextforthecurrentthread. Returns0onsuccess,and-1onerror.
intPyContext_Exit(PyObject*ctx)
Deactivatethectxcontextandrestorethepreviouscontextasthecurrentcontextforthecurrentthread. Returns
0onsuccess,and-1onerror.
intPyContext_AddWatcher(PyContext_WatchCallbackcallback)
Registercallbackasacontextobjectwatcherforthecurrentinterpreter. ReturnanIDwhichmaybepassedto
PyContext_ClearWatcher(). Incaseoferror(e.g. nomorewatcherIDsavailable),return-1andsetan
exception.
Addedinversion3.14.
intPyContext_ClearWatcher(intwatcher_id)
Clearwatcheridentifiedbywatcher_idpreviouslyreturnedfromPyContext_AddWatcher()forthecurrent
interpreter. Return0onsuccess,or-1andsetanexceptiononerror(e.g. ifthegivenwatcher_id wasnever
registered.)
Addedinversion3.14.
9.6. OtherObjects 219

### 第228页

typePyContextEvent
Enumerationofpossiblecontextobjectwatcherevents:
• Py_CONTEXT_SWITCHED:Thecurrentcontexthasswitchedtoadifferentcontext. Theobjectpassedto
thewatchcallbackisthenow-currentcontextvars.Contextobject,orNoneifnocontextiscurrent.
Addedinversion3.14.
typedefint(*PyContext_WatchCallback)(PyContextEventevent,PyObject*obj)
Context object watcher callback function. The object passed to the callback is event-specific; see
PyContextEventfordetails.
Ifthecallbackreturnswithanexceptionset,itmustreturn-1;thisexceptionwillbeprintedasanunraisable
exceptionusingPyErr_FormatUnraisable(). Otherwiseitshouldreturn0.
Theremayalreadybeapendingexceptionsetonentrytothecallback. Inthiscase,thecallbackshouldreturn0
withthesameexceptionstillset. ThismeansthecallbackmaynotcallanyotherAPIthatcansetanexception
unlessitsavesandclearstheexceptionstatefirst,andrestoresitbeforereturning.
Addedinversion3.14.
Contextvariablefunctions:
PyObject*PyContextVar_New(constchar*name,PyObject*def)
Returnvalue: Newreference. CreateanewContextVarobject. Thenameparameterisusedforintrospection
anddebugpurposes. Thedefparameterspecifiesadefaultvalueforthecontextvariable,orNULLfornodefault.
Ifanerrorhasoccurred,thisfunctionreturnsNULL.
intPyContextVar_Get(PyObject*var,PyObject*default_value,PyObject**value)
Get the value of a context variable. Returns -1 if an error has occurred during lookup, and 0 if no error
occurred,whetherornotavaluewasfound.
Ifthecontextvariablewasfound,valuewillbeapointertoit. Ifthecontextvariablewasnotfound,valuewill
pointto:
• default_value,ifnotNULL;
• thedefaultvalueofvar,ifnotNULL;
• NULL
ExceptforNULL,thefunctionreturnsanewreference.
PyObject*PyContextVar_Set(PyObject*var,PyObject*value)
Returnvalue: Newreference. Setthevalueofvartovalueinthecurrentcontext. Returnsanewtokenobject
forthischange,orNULLifanerrorhasoccurred.
intPyContextVar_Reset(PyObject*var,PyObject*token)
Resetthestateofthevar contextvariabletothatitwasinbeforePyContextVar_Set()thatreturnedthe
tokenwascalled. Thisfunctionreturns0onsuccessand-1onerror.
9.6.16 DateTime Objects
Variousdateandtimeobjectsaresuppliedbythedatetimemodule. Beforeusinganyofthesefunctions,theheader
file datetime.h must be included in your source (note that this is not included by Python.h), and the macro
PyDateTime_IMPORT must be invoked, usually as part of the module initialisation function. The macro puts a
pointertoaCstructureintoastaticvariable,PyDateTimeAPI,thatisusedbythefollowingmacros.
typePyDateTime_Date
ThissubtypeofPyObjectrepresentsaPythondateobject.
typePyDateTime_DateTime
ThissubtypeofPyObjectrepresentsaPythondatetimeobject.
220 Chapter9. ConcreteObjectsLayer

### 第229页

typePyDateTime_Time
ThissubtypeofPyObjectrepresentsaPythontimeobject.
typePyDateTime_Delta
ThissubtypeofPyObjectrepresentsthedifferencebetweentwodatetimevalues.
PyTypeObjectPyDateTime_DateType
ThisinstanceofPyTypeObjectrepresentsthePythondatetype; itisthesameobjectasdatetime.date
inthePythonlayer.
PyTypeObjectPyDateTime_DateTimeType
This instance of PyTypeObject represents the Python datetime type; it is the same object as datetime.
datetimeinthePythonlayer.
PyTypeObjectPyDateTime_TimeType
ThisinstanceofPyTypeObjectrepresentsthePythontimetype;itisthesameobjectasdatetime.time
inthePythonlayer.
PyTypeObjectPyDateTime_DeltaType
ThisinstanceofPyTypeObjectrepresentsPythontypeforthedifferencebetweentwodatetimevalues;itis
thesameobjectasdatetime.timedeltainthePythonlayer.
PyTypeObjectPyDateTime_TZInfoType
ThisinstanceofPyTypeObjectrepresentsthePythontimezoneinfotype;itisthesameobjectasdatetime.
tzinfointhePythonlayer.
MacroforaccesstotheUTCsingleton:
PyObject*PyDateTime_TimeZone_UTC
ReturnsthetimezonesingletonrepresentingUTC,thesameobjectasdatetime.timezone.utc.
Addedinversion3.7.
Type-checkmacros:
intPyDate_Check(PyObject*ob)
ReturntrueifobisoftypePyDateTime_DateTypeorasubtypeofPyDateTime_DateType. obmustnot
beNULL.Thisfunctionalwayssucceeds.
intPyDate_CheckExact(PyObject*ob)
ReturntrueifobisoftypePyDateTime_DateType. obmustnotbeNULL.Thisfunctionalwayssucceeds.
intPyDateTime_Check(PyObject*ob)
ReturntrueifobisoftypePyDateTime_DateTimeTypeorasubtypeofPyDateTime_DateTimeType.
obmustnotbeNULL.Thisfunctionalwayssucceeds.
intPyDateTime_CheckExact(PyObject*ob)
ReturntrueifobisoftypePyDateTime_DateTimeType. obmustnotbeNULL.Thisfunctionalwayssuc-
ceeds.
intPyTime_Check(PyObject*ob)
ReturntrueifobisoftypePyDateTime_TimeTypeorasubtypeofPyDateTime_TimeType. obmustnot
beNULL.Thisfunctionalwayssucceeds.
intPyTime_CheckExact(PyObject*ob)
ReturntrueifobisoftypePyDateTime_TimeType. obmustnotbeNULL.Thisfunctionalwayssucceeds.
intPyDelta_Check(PyObject*ob)
ReturntrueifobisoftypePyDateTime_DeltaTypeorasubtypeofPyDateTime_DeltaType. obmust
notbeNULL.Thisfunctionalwayssucceeds.
intPyDelta_CheckExact(PyObject*ob)
ReturntrueifobisoftypePyDateTime_DeltaType. obmustnotbeNULL.Thisfunctionalwayssucceeds.
9.6. OtherObjects 221

### 第230页

intPyTZInfo_Check(PyObject*ob)
ReturntrueifobisoftypePyDateTime_TZInfoTypeorasubtypeofPyDateTime_TZInfoType. obmust
notbeNULL.Thisfunctionalwayssucceeds.
intPyTZInfo_CheckExact(PyObject*ob)
ReturntrueifobisoftypePyDateTime_TZInfoType. obmustnotbeNULL.Thisfunctionalwayssucceeds.
Macrostocreateobjects:
PyObject*PyDate_FromDate(intyear,intmonth,intday)
Returnvalue: Newreference. Returnadatetime.dateobjectwiththespecifiedyear,monthandday.
PyObject*PyDateTime_FromDateAndTime(intyear,intmonth,intday,inthour,intminute,intsecond,int
usecond)
Returnvalue: Newreference. Returnadatetime.datetimeobjectwiththespecifiedyear,month,day,hour,
minute,secondandmicrosecond.
PyObject*PyDateTime_FromDateAndTimeAndFold(intyear,intmonth,intday,inthour,intminute,int
second,intusecond,intfold)
Returnvalue: Newreference. Returnadatetime.datetimeobjectwiththespecifiedyear,month,day,hour,
minute,second,microsecondandfold.
Addedinversion3.6.
PyObject*PyTime_FromTime(inthour,intminute,intsecond,intusecond)
Returnvalue: Newreference. Returnadatetime.timeobjectwiththespecifiedhour,minute,secondand
microsecond.
PyObject*PyTime_FromTimeAndFold(inthour,intminute,intsecond,intusecond,intfold)
Return value: New reference. Return a datetime.time object with the specified hour, minute, second,
microsecondandfold.
Addedinversion3.6.
PyObject*PyDelta_FromDSU(intdays,intseconds,intuseconds)
Returnvalue: Newreference. Returnadatetime.timedeltaobjectrepresentingthegivennumberofdays,
seconds and microseconds. Normalization is performed so that the resulting number of microseconds and
secondslieintherangesdocumentedfordatetime.timedeltaobjects.
PyObject*PyTimeZone_FromOffset(PyObject*offset)
Returnvalue: Newreference. Returnadatetime.timezoneobjectwithanunnamedfixedoffsetrepresented
bytheoffsetargument.
Addedinversion3.7.
PyObject*PyTimeZone_FromOffsetAndName(PyObject*offset,PyObject*name)
Return value: New reference. Return a datetime.timezone object with a fixed offset represented by the
offsetargumentandwithtznamename.
Addedinversion3.7.
Macros to extract fields from date objects. The argument must be an instance of PyDateTime_Date, including
subclasses(suchasPyDateTime_DateTime). TheargumentmustnotbeNULL,andthetypeisnotchecked:
intPyDateTime_GET_YEAR(PyDateTime_Date*o)
Returntheyear,asapositiveint.
intPyDateTime_GET_MONTH(PyDateTime_Date*o)
Returnthemonth,asanintfrom1through12.
intPyDateTime_GET_DAY(PyDateTime_Date*o)
Returntheday,asanintfrom1through31.
Macros to extract fields from datetime objects. The argument must be an instance of PyDateTime_DateTime,
includingsubclasses. TheargumentmustnotbeNULL,andthetypeisnotchecked:
222 Chapter9. ConcreteObjectsLayer

### 第231页

intPyDateTime_DATE_GET_HOUR(PyDateTime_DateTime*o)
Returnthehour,asanintfrom0through23.
intPyDateTime_DATE_GET_MINUTE(PyDateTime_DateTime*o)
Returntheminute,asanintfrom0through59.
intPyDateTime_DATE_GET_SECOND(PyDateTime_DateTime*o)
Returnthesecond,asanintfrom0through59.
intPyDateTime_DATE_GET_MICROSECOND(PyDateTime_DateTime*o)
Returnthemicrosecond,asanintfrom0through999999.
intPyDateTime_DATE_GET_FOLD(PyDateTime_DateTime*o)
Returnthefold,asanintfrom0through1.
Addedinversion3.6.
PyObject*PyDateTime_DATE_GET_TZINFO(PyDateTime_DateTime*o)
Returnthetzinfo(whichmaybeNone).
Addedinversion3.10.
Macros to extract fields from time objects. The argument must be an instance of PyDateTime_Time, including
subclasses. TheargumentmustnotbeNULL,andthetypeisnotchecked:
intPyDateTime_TIME_GET_HOUR(PyDateTime_Time*o)
Returnthehour,asanintfrom0through23.
intPyDateTime_TIME_GET_MINUTE(PyDateTime_Time*o)
Returntheminute,asanintfrom0through59.
intPyDateTime_TIME_GET_SECOND(PyDateTime_Time*o)
Returnthesecond,asanintfrom0through59.
intPyDateTime_TIME_GET_MICROSECOND(PyDateTime_Time*o)
Returnthemicrosecond,asanintfrom0through999999.
intPyDateTime_TIME_GET_FOLD(PyDateTime_Time*o)
Returnthefold,asanintfrom0through1.
Addedinversion3.6.
PyObject*PyDateTime_TIME_GET_TZINFO(PyDateTime_Time*o)
Returnthetzinfo(whichmaybeNone).
Addedinversion3.10.
Macros to extract fields from time delta objects. The argument must be an instance of PyDateTime_Delta, in-
cludingsubclasses. TheargumentmustnotbeNULL,andthetypeisnotchecked:
intPyDateTime_DELTA_GET_DAYS(PyDateTime_Delta*o)
Returnthenumberofdays,asanintfrom-999999999to999999999.
Addedinversion3.3.
intPyDateTime_DELTA_GET_SECONDS(PyDateTime_Delta*o)
Returnthenumberofseconds,asanintfrom0through86399.
Addedinversion3.3.
intPyDateTime_DELTA_GET_MICROSECONDS(PyDateTime_Delta*o)
Returnthenumberofmicroseconds,asanintfrom0through999999.
Addedinversion3.3.
MacrosfortheconvenienceofmodulesimplementingtheDBAPI:
9.6. OtherObjects 223

### 第232页

PyObject*PyDateTime_FromTimestamp(PyObject*args)
Returnvalue: Newreference. Createandreturnanewdatetime.datetimeobjectgivenanargumenttuple
suitableforpassingtodatetime.datetime.fromtimestamp().
PyObject*PyDate_FromTimestamp(PyObject*args)
Returnvalue:Newreference. Createandreturnanewdatetime.dateobjectgivenanargumenttuplesuitable
forpassingtodatetime.date.fromtimestamp().
9.6.17 Objects for Type Hinting
Various built-in types for type hinting are provided. Currently, two types exist – GenericAlias and Union. Only
GenericAliasisexposedtoC.
PyObject*Py_GenericAlias(PyObject*origin,PyObject*args)
Part of the Stable ABI since version 3.9. Create a GenericAlias object. Equivalent to calling the Python
class types.GenericAlias. The origin and args arguments set the GenericAlias‘s __origin__ and
__args__attributesrespectively. originshouldbeaPyTypeObject*,andargscanbeaPyTupleObject*
oranyPyObject*. Ifargspassedisnotatuple,a1-tupleisautomaticallyconstructedand__args__isset
to(args,). Minimalcheckingisdoneforthearguments, sothefunctionwillsucceedeveniforiginisnot
atype. TheGenericAlias‘s__parameters__attributeisconstructedlazilyfrom__args__. Onfailure,
anexceptionisraisedandNULLisreturned.
Here’sanexampleofhowtomakeanextensiontypegeneric:
...
static PyMethodDef my_obj_methods[] = {
// Other methods.
...
{"__class_getitem__", Py_GenericAlias, METH_O|METH_CLASS, "See PEP 585"}
...
}
(cid:181) Seealso
Thedatamodelmethod__class_getitem__().
Addedinversion3.9.
PyTypeObjectPy_GenericAliasType
PartoftheStableABIsinceversion3.9. TheCtypeoftheobjectreturnedbyPy_GenericAlias(). Equiv-
alenttotypes.GenericAliasinPython.
Addedinversion3.9.
224 Chapter9. ConcreteObjectsLayer

| (cid:181) Seealso |
| --- |
| Thedatamodelmethod__class_getitem__(). |

### 第233页

CHAPTER
TEN
INITIALIZATION, FINALIZATION, AND THREADS
SeePythonInitializationConfigurationfordetailsonhowtoconfiguretheinterpreterpriortoinitialization.
10.1 Before Python Initialization
In an application embedding Python, the Py_Initialize() function must be called before using any other
Python/CAPIfunctions;withtheexceptionofafewfunctionsandtheglobalconfigurationvariables.
ThefollowingfunctionscanbesafelycalledbeforePythonisinitialized:
• Functionsthatinitializetheinterpreter:
– Py_Initialize()
– Py_InitializeEx()
– Py_InitializeFromConfig()
– Py_BytesMain()
– Py_Main()
– theruntimepre-initializationfunctionscoveredinPythonInitializationConfiguration
• Configurationfunctions:
– PyImport_AppendInittab()
– PyImport_ExtendInittab()
– PyInitFrozenExtensions()
– PyMem_SetAllocator()
– PyMem_SetupDebugHooks()
– PyObject_SetArenaAllocator()
– Py_SetProgramName()
– Py_SetPythonHome()
– PySys_ResetWarnOptions()
– theconfigurationfunctionscoveredinPythonInitializationConfiguration
• Informativefunctions:
– Py_IsInitialized()
– PyMem_GetAllocator()
– PyObject_GetArenaAllocator()
– Py_GetBuildInfo()
– Py_GetCompiler()
225

### 第234页

– Py_GetCopyright()
– Py_GetPlatform()
– Py_GetVersion()
– Py_IsInitialized()
• Utilities:
– Py_DecodeLocale()
– thestatusreportingandutilityfunctionscoveredinPythonInitializationConfiguration
• Memoryallocators:
– PyMem_RawMalloc()
– PyMem_RawRealloc()
– PyMem_RawCalloc()
– PyMem_RawFree()
• Synchronization:
– PyMutex_Lock()
– PyMutex_Unlock()
(cid:174) Note
Despite their apparent similarity to some of the functions listed above, the following functions should not be
calledbeforetheinterpreterhasbeeninitialized: Py_EncodeLocale(),Py_GetPath(),Py_GetPrefix(),
Py_GetExecPrefix(),Py_GetProgramFullPath(),Py_GetPythonHome(),Py_GetProgramName(),
PyEval_InitThreads(),andPy_RunMain().
10.2 Global configuration variables
Pythonhasvariablesfortheglobalconfigurationtocontroldifferentfeaturesandoptions. Bydefault,theseflagsare
controlledbycommandlineoptions.
Whenaflagissetbyanoption,thevalueoftheflagisthenumberoftimesthattheoptionwasset. Forexample,-b
setsPy_BytesWarningFlagto1and-bbsetsPy_BytesWarningFlagto2.
intPy_BytesWarningFlag
This API is kept for backward compatibility: setting PyConfig.bytes_warning should be used instead,
seePythonInitializationConfiguration.
Issueawarningwhencomparingbytesorbytearraywithstrorbyteswithint. Issueanerrorifgreater
orequalto2.
Setbythe-boption.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_DebugFlag
ThisAPIiskeptforbackwardcompatibility: settingPyConfig.parser_debugshouldbeusedinstead,see
PythonInitializationConfiguration.
Turnonparserdebuggingoutput(forexpertonly,dependingoncompilationoptions).
Setbythe-doptionandthePYTHONDEBUGenvironmentvariable.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
226 Chapter10. Initialization,Finalization,andThreads

### 第235页

intPy_DontWriteBytecodeFlag
ThisAPIiskeptforbackwardcompatibility: settingPyConfig.write_bytecodeshouldbeusedinstead,
seePythonInitializationConfiguration.
Ifsettonon-zero,Pythonwon’ttrytowrite.pycfilesontheimportofsourcemodules.
Setbythe-BoptionandthePYTHONDONTWRITEBYTECODEenvironmentvariable.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_FrozenFlag
This API is kept for backward compatibility: setting PyConfig.pathconfig_warnings should be used
instead,seePythonInitializationConfiguration.
SuppresserrormessageswhencalculatingthemodulesearchpathinPy_GetPath().
Privateflagusedby_freeze_moduleandfrozenmainprograms.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_HashRandomizationFlag
This API is kept for backward compatibility: setting PyConfig.hash_seed and PyConfig.
use_hash_seedshouldbeusedinstead,seePythonInitializationConfiguration.
Setto1ifthePYTHONHASHSEEDenvironmentvariableissettoanon-emptystring.
Iftheflagisnon-zero,readthePYTHONHASHSEEDenvironmentvariabletoinitializethesecrethashseed.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_IgnoreEnvironmentFlag
ThisAPIiskeptforbackwardcompatibility: settingPyConfig.use_environmentshouldbeusedinstead,
seePythonInitializationConfiguration.
IgnoreallPYTHON*environmentvariables,e.g. PYTHONPATHandPYTHONHOME,thatmightbeset.
Setbythe-Eand-Ioptions.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_InspectFlag
ThisAPIiskeptforbackwardcompatibility: settingPyConfig.inspectshouldbeusedinstead,seePython
InitializationConfiguration.
Whenascriptispassedasfirstargumentorthe-coptionisused,enterinteractivemodeafterexecutingthe
scriptorthecommand,evenwhensys.stdindoesnotappeartobeaterminal.
Setbythe-ioptionandthePYTHONINSPECTenvironmentvariable.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_InteractiveFlag
ThisAPIiskeptforbackwardcompatibility: settingPyConfig.interactiveshouldbeusedinstead,see
PythonInitializationConfiguration.
Setbythe-ioption.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_IsolatedFlag
ThisAPIiskeptforbackwardcompatibility:settingPyConfig.isolatedshouldbeusedinstead,seePython
InitializationConfiguration.
RunPythoninisolatedmode. Inisolatedmodesys.pathcontainsneitherthescript’sdirectorynortheuser’s
site-packagesdirectory.
Setbythe-Ioption.
Addedinversion3.4.
10.2. Globalconfigurationvariables 227

### 第236页

Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_LegacyWindowsFSEncodingFlag
This API is kept for backward compatibility: setting PyPreConfig.legacy_windows_fs_encoding
shouldbeusedinstead,seePythonInitializationConfiguration.
Iftheflagisnon-zero, usethembcsencodingwithreplaceerrorhandler, insteadoftheUTF-8encoding
withsurrogatepasserrorhandler,forthefilesystemencodinganderrorhandler.
Setto1ifthePYTHONLEGACYWINDOWSFSENCODINGenvironmentvariableissettoanon-emptystring.
SeePEP529formoredetails.
Availability: Windows.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_LegacyWindowsStdioFlag
ThisAPIiskeptforbackwardcompatibility: settingPyConfig.legacy_windows_stdioshouldbeused
instead,seePythonInitializationConfiguration.
Iftheflagisnon-zero,useio.FileIOinsteadofio._WindowsConsoleIOforsysstandardstreams.
Setto1ifthePYTHONLEGACYWINDOWSSTDIOenvironmentvariableissettoanon-emptystring.
SeePEP528formoredetails.
Availability: Windows.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_NoSiteFlag
ThisAPIiskeptforbackwardcompatibility: settingPyConfig.site_importshouldbeusedinstead,see
PythonInitializationConfiguration.
Disable the import of the module site and the site-dependent manipulations of sys.path that it entails.
Alsodisablethesemanipulationsifsiteisexplicitlyimportedlater(callsite.main()ifyouwantthemto
betriggered).
Setbythe-Soption.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_NoUserSiteDirectory
This API is kept for backward compatibility: setting PyConfig.user_site_directory should be used
instead,seePythonInitializationConfiguration.
Don’taddtheuser site-packages directorytosys.path.
Setbythe-sand-Ioptions,andthePYTHONNOUSERSITEenvironmentvariable.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_OptimizeFlag
This API is kept for backward compatibility: setting PyConfig.optimization_level should be used
instead,seePythonInitializationConfiguration.
Setbythe-OoptionandthePYTHONOPTIMIZEenvironmentvariable.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_QuietFlag
ThisAPIiskeptforbackwardcompatibility: settingPyConfig.quietshouldbeusedinstead, seePython
InitializationConfiguration.
Don’tdisplaythecopyrightandversionmessagesevenininteractivemode.
Setbythe-qoption.
Addedinversion3.2.
228 Chapter10. Initialization,Finalization,andThreads

### 第237页

Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_UnbufferedStdioFlag
ThisAPIiskeptforbackwardcompatibility: settingPyConfig.buffered_stdioshouldbeusedinstead,
seePythonInitializationConfiguration.
Forcethestdoutandstderrstreamstobeunbuffered.
Setbythe-uoptionandthePYTHONUNBUFFEREDenvironmentvariable.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
intPy_VerboseFlag
ThisAPIiskeptforbackwardcompatibility: settingPyConfig.verboseshouldbeusedinstead,seePython
InitializationConfiguration.
Printamessageeachtimeamoduleisinitialized,showingtheplace(filenameorbuilt-inmodule)fromwhich
it is loaded. If greater or equal to 2, print a message for each file that is checked for when searching for a
module. Alsoprovidesinformationonmodulecleanupatexit.
Setbythe-voptionandthePYTHONVERBOSEenvironmentvariable.
Deprecatedsinceversion3.12,willberemovedinversion3.15.
10.3 Initializing and finalizing the interpreter
voidPy_Initialize()
PartoftheStableABI.InitializethePythoninterpreter. InanapplicationembeddingPython,thisshouldbe
calledbeforeusinganyotherPython/CAPIfunctions;seeBeforePythonInitializationforthefewexceptions.
Thisinitializesthetableofloadedmodules(sys.modules),andcreatesthefundamentalmodulesbuiltins,
__main__andsys. Italsoinitializesthemodulesearchpath(sys.path). Itdoesnotsetsys.argv;usethe
PythonInitializationConfigurationAPIforthat. Thisisano-opwhencalledforasecondtime(withoutcalling
Py_FinalizeEx()first). Thereisnoreturnvalue;itisafatalerroriftheinitializationfails.
UsePy_InitializeFromConfig()tocustomizethePythonInitializationConfiguration.
(cid:174) Note
OnWindows,changestheconsolemodefromO_TEXTtoO_BINARY,whichwillalsoaffectnon-Python
usesoftheconsoleusingtheCRuntime.
voidPy_InitializeEx(intinitsigs)
Part ofthe StableABI. This functionworks like Py_Initialize() if initsigs is 1. If initsigs is 0, it skips
initializationregistrationofsignalhandlers,whichmaybeusefulwhenCPythonisembeddedaspartofalarger
application.
UsePy_InitializeFromConfig()tocustomizethePythonInitializationConfiguration.
PyStatusPy_InitializeFromConfig(constPyConfig*config)
InitializePythonfromconfigconfiguration,asdescribedinInitializationwithPyConfig.
SeethePythonInitializationConfigurationsectionfordetailsonpre-initializingtheinterpreter,populatingthe
runtimeconfigurationstructure,andqueryingthereturnedstatusstructure.
intPy_IsInitialized()
PartoftheStableABI.Returntrue(nonzero)whenthePythoninterpreterhasbeeninitialized,false(zero)if
not. AfterPy_FinalizeEx()iscalled,thisreturnsfalseuntilPy_Initialize()iscalledagain.
10.3. Initializingandfinalizingtheinterpreter 229

### 第238页

intPy_IsFinalizing()
Part of the Stable ABI since version 3.13. Return true (non-zero) if the main Python interpreter is shutting
down. Returnfalse(zero)otherwise.
Addedinversion3.13.
intPy_FinalizeEx()
PartoftheStableABIsinceversion3.6. UndoallinitializationsmadebyPy_Initialize()andsubsequent
use of Python/C API functions, and destroy all sub-interpreters (see Py_NewInterpreter() below) that
werecreatedandnotyetdestroyedsincethelastcalltoPy_Initialize(). Thisisano-opwhencalledfor
asecondtime(withoutcallingPy_Initialize()againfirst).
SincethisisthereverseofPy_Initialize(),itshouldbecalledinthesamethreadwiththesameinterpreter
active. Thatmeansthemainthreadandthemaininterpreter. ThisshouldneverbecalledwhilePy_RunMain()
isrunning.
Normallythereturnvalueis0. Iftherewereerrorsduringfinalization(flushingbuffereddata),-1isreturned.
Note that Python will do a best effort at freeing all memory allocated by the Python interpreter. Therefore,
anyC-ExtensionshouldmakesuretocorrectlycleanupallofthepreveiouslyallocatedPyObjectsbeforeusing
them in subsequent calls to Py_Initialize(). Otherwise it could introduce vulnerabilities and incorrect
behavior.
This function is provided for a number of reasons. An embedding application might want to restart Python
withouthavingtorestarttheapplicationitself. AnapplicationthathasloadedthePythoninterpreterfroma
dynamicallyloadablelibrary(orDLL)mightwanttofreeallmemoryallocatedbyPythonbeforeunloadingthe
DLL.Duringahuntformemoryleaksinanapplicationadevelopermightwanttofreeallmemoryallocated
byPythonbeforeexitingfromtheapplication.
Bugs and caveats: The destruction of modules and objects in modules is done in random order; this may
causedestructors(__del__()methods)tofailwhentheydependonotherobjects(evenfunctions)ormod-
ules. DynamicallyloadedextensionmodulesloadedbyPythonarenotunloaded. Smallamountsofmemory
allocated by the Python interpreter may not be freed (if you find a leak, please report it). Memory tied up
incircularreferencesbetweenobjectsisnotfreed. Internedstringswillallbedeallocatedregardlessoftheir
referencecount. Somememoryallocatedbyextensionmodulesmaynotbefreed. Someextensionsmaynot
work properly if their initialization routine is called more than once; this can happen if an application calls
Py_Initialize()andPy_FinalizeEx()morethanonce. Py_FinalizeEx()mustnotbecalledrecur-
sivelyfromwithinitself. Therefore,itmustnotbecalledbyanycodethatmayberunaspartoftheinterpreter
shutdownprocess,suchasatexithandlers,objectfinalizers,oranycodethatmayberunwhileflushingthe
stdoutandstderrfiles.
Raisesanauditingeventcpython._PySys_ClearAuditHookswithnoarguments.
Addedinversion3.6.
voidPy_Finalize()
Part of the Stable ABI. This is a backwards-compatible version of Py_FinalizeEx() that disregards the
returnvalue.
intPy_BytesMain(intargc,char**argv)
PartoftheStableABIsinceversion3.8. SimilartoPy_Main()butargvisanarrayofbytesstrings,allowing
thecallingapplicationtodelegatethetextdecodingsteptotheCPythonruntime.
Addedinversion3.8.
intPy_Main(intargc,wchar_t**argv)
Part of the Stable ABI. The main program for the standard interpreter, encapsulating a full initializa-
tion/finalizationcycle, as wellas additionalbehaviourto implementreadingconfigurationssettingsfromthe
environmentandcommandline,andthenexecuting__main__inaccordancewithusing-on-cmdline.
ThisismadeavailableforprogramswhichwishtosupportthefullCPythoncommandlineinterface, rather
thanjustembeddingaPythonruntimeinalargerapplication.
TheargcandargvparametersaresimilartothosewhicharepassedtoaCprogram’smain()function,except
thattheargventriesarefirstconvertedtowchar_tusingPy_DecodeLocale(). Itisalsoimportanttonote
230 Chapter10. Initialization,Finalization,andThreads

### 第239页

that the argument list entries may be modified to point to strings other than those passed in (however, the
contentsofthestringspointedtobytheargumentlistarenotmodified).
Thereturnvalueis2iftheargumentlistdoesnotrepresentavalidPythoncommandline,andotherwisethe
sameasPy_RunMain().
In terms of the CPython runtime configuration APIs documented in the runtime configuration section (and
withoutaccountingforerrorhandling),Py_Mainisapproximatelyequivalentto:
PyConfig config;
PyConfig_InitPythonConfig(&config);
PyConfig_SetArgv(&config, argc, argv);
Py_InitializeFromConfig(&config);
PyConfig_Clear(&config);
Py_RunMain();
In normal usage, an embedding application will call this function instead of calling Py_Initialize(),
Py_InitializeEx() or Py_InitializeFromConfig() directly, and all settings will be applied as de-
scribed elsewhere in this documentation. If this function is instead called after a preceding runtime initial-
izationAPIcall,thenexactlywhichenvironmentalandcommandlineconfigurationsettingswillbeupdated
isversiondependent(asitdependsonwhichsettingscorrectlysupportbeingmodifiedaftertheyhavealready
beensetoncewhentheruntimewasfirstinitialized).
intPy_RunMain(void)
ExecutesthemainmoduleinafullyconfiguredCPythonruntime.
Executesthecommand(PyConfig.run_command),thescript(PyConfig.run_filename)orthemodule
(PyConfig.run_module)specifiedonthecommandlineorintheconfiguration. Ifnoneofthesevaluesare
set,runstheinteractivePythonprompt(REPL)usingthe__main__module’sglobalnamespace.
IfPyConfig.inspectisnotset(thedefault),thereturnvaluewillbe0iftheinterpreterexitsnormally(that
is,withoutraisinganexception),theexitstatusofanunhandledSystemExit,or1foranyotherunhandled
exception.
IfPyConfig.inspectisset(suchaswhenthe-ioptionisused),ratherthanreturningwhentheinterpreter
exits, execution will instead resume in an interactive Python prompt (REPL) using the __main__ module’s
globalnamespace. Iftheinterpreterexitedwithanexception, itisimmediatelyraisedintheREPLsession.
ThefunctionreturnvalueisthendeterminedbythewaytheREPLsessionterminates: 0,1,orthestatusofa
SystemExit,asspecifiedabove.
ThisfunctionalwaysfinalizesthePythoninterpreterbeforeitreturns.
See Python Configuration for an example of a customized Python that always runs in isolated mode using
Py_RunMain().
intPyUnstable_AtExit(PyInterpreterState*interp,void(*func)(void*),void*data)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Registeranatexitcallbackforthetargetinterpreterinterp. ThisissimilartoPy_AtExit(),buttakesan
explicitinterpreteranddatapointerforthecallback.
Theremustbeanattachedthreadstateforinterp.
Addedinversion3.13.
10.3. Initializingandfinalizingtheinterpreter 231

### 第240页

10.4 Process-wide parameters
voidPy_SetProgramName(constwchar_t*name)
Part of the Stable ABI. This API is kept for backward compatibility: setting PyConfig.program_name
shouldbeusedinstead,seePythonInitializationConfiguration.
This function should be called before Py_Initialize() is called for the first time, if it is called at all. It
tellstheinterpreterthevalueoftheargv[0]argumenttothemain()functionoftheprogram(convertedto
widecharacters). ThisisusedbyPy_GetPath()andsomeotherfunctionsbelowtofindthePythonrun-time
librariesrelativetotheinterpreterexecutable. Thedefaultvalueis'python'. Theargumentshouldpointto
azero-terminatedwidecharacterstringinstaticstoragewhosecontentswillnotchangeforthedurationofthe
program’sexecution. NocodeinthePythoninterpreterwillchangethecontentsofthisstorage.
UsePy_DecodeLocale()todecodeabytesstringtogetawchar_t*string.
Deprecatedsinceversion3.11,willberemovedinversion3.15.
wchar_t*Py_GetProgramName()
PartoftheStableABI.ReturntheprogramnamesetwithPyConfig.program_name,orthedefault. The
returnedstringpointsintostaticstorage;thecallershouldnotmodifyitsvalue.
ThisfunctionshouldnotbecalledbeforePy_Initialize(),otherwiseitreturnsNULL.
Changedinversion3.10: ItnowreturnsNULLifcalledbeforePy_Initialize().
Deprecated since version 3.13, will be removed in version 3.15: Use PyConfig_Get("executable")
(sys.executable)instead.
wchar_t*Py_GetPrefix()
PartoftheStableABI.Returntheprefixforinstalledplatform-independentfiles. Thisisderivedthroughanum-
berofcomplicatedrulesfromtheprogramnamesetwithPyConfig.program_nameandsomeenvironment
variables;forexample,iftheprogramnameis'/usr/local/bin/python',theprefixis'/usr/local'.
Thereturnedstringpointsintostaticstorage; thecallershouldnotmodifyitsvalue. Thiscorrespondstothe
prefixvariableinthetop-levelMakefileandthe--prefixargumenttotheconfigurescriptatbuild
time. ThevalueisavailabletoPythoncodeassys.base_prefix. ItisonlyusefulonUnix. Seealsothe
nextfunction.
ThisfunctionshouldnotbecalledbeforePy_Initialize(),otherwiseitreturnsNULL.
Changedinversion3.10: ItnowreturnsNULLifcalledbeforePy_Initialize().
Deprecated since version 3.13, will be removed in version 3.15: Use PyConfig_Get("base_prefix")
(sys.base_prefix) instead. Use PyConfig_Get("prefix") (sys.prefix) if virtual environments
needtobehandled.
wchar_t*Py_GetExecPrefix()
PartoftheStableABI.Returntheexec-prefix forinstalledplatform-dependent files. Thisisderivedthrough
a number of complicated rules from the program name set with PyConfig.program_name and some en-
vironmentvariables; forexample, iftheprogramnameis'/usr/local/bin/python', theexec-prefixis
'/usr/local'. The returned string points into static storage; the caller should not modify its value. This
correspondstotheexec_prefixvariableinthetop-levelMakefileandthe--exec-prefixargumentto
theconfigurescriptatbuildtime. ThevalueisavailabletoPythoncodeassys.base_exec_prefix. It
isonlyusefulonUnix.
Background: Theexec-prefixdiffersfromtheprefixwhenplatformdependentfiles(suchasexecutablesand
sharedlibraries)areinstalledinadifferentdirectorytree. Inatypicalinstallation,platformdependentfilesmay
beinstalledinthe/usr/local/platsubtreewhileplatformindependentmaybeinstalledin/usr/local.
Generallyspeaking,aplatformisacombinationofhardwareandsoftwarefamilies,e.g. Sparcmachinesrun-
ningtheSolaris2.xoperatingsystemareconsideredthesameplatform,butIntelmachinesrunningSolaris2.x
areanotherplatform,andIntelmachinesrunningLinuxareyetanotherplatform. Differentmajorrevisionsof
thesameoperatingsystemgenerallyalsoformdifferentplatforms. Non-Unixoperatingsystemsareadifferent
232 Chapter10. Initialization,Finalization,andThreads

### 第241页

story;theinstallationstrategiesonthosesystemsaresodifferentthattheprefixandexec-prefixaremeaning-
less,andsettotheemptystring. NotethatcompiledPythonbytecodefilesareplatformindependent(butnot
independentfromthePythonversionbywhichtheywerecompiled!).
Systemadministratorswillknowhowtoconfigurethemountorautomountprogramstoshare/usr/local
betweenplatformswhilehaving/usr/local/platbeadifferentfilesystemforeachplatform.
ThisfunctionshouldnotbecalledbeforePy_Initialize(),otherwiseitreturnsNULL.
Changedinversion3.10: ItnowreturnsNULLifcalledbeforePy_Initialize().
Deprecated since version 3.13, will be removed in version 3.15: Use
PyConfig_Get("base_exec_prefix") (sys.base_exec_prefix) instead. Use
PyConfig_Get("exec_prefix")(sys.exec_prefix)ifvirtualenvironmentsneedtobehandled.
wchar_t*Py_GetProgramFullPath()
PartoftheStableABI.ReturnthefullprogramnameofthePythonexecutable;thisiscomputedasaside-effect
ofderivingthedefaultmodulesearchpathfromtheprogramname(setbyPyConfig.program_name). The
returnedstringpointsintostaticstorage;thecallershouldnotmodifyitsvalue. ThevalueisavailabletoPython
codeassys.executable.
ThisfunctionshouldnotbecalledbeforePy_Initialize(),otherwiseitreturnsNULL.
Changedinversion3.10: ItnowreturnsNULLifcalledbeforePy_Initialize().
Deprecated since version 3.13, will be removed in version 3.15: Use PyConfig_Get("executable")
(sys.executable)instead.
wchar_t*Py_GetPath()
PartoftheStableABI.Returnthedefaultmodulesearchpath;thisiscomputedfromtheprogramname(set
byPyConfig.program_name)andsomeenvironmentvariables. Thereturnedstringconsistsofaseriesof
directory names separated by a platform dependent delimiter character. The delimiter character is ':' on
UnixandmacOS,';'onWindows. Thereturnedstringpointsintostaticstorage;thecallershouldnotmodify
its value. The list sys.path is initialized with this value on interpreter startup; it can be (and usually is)
modifiedlatertochangethesearchpathforloadingmodules.
ThisfunctionshouldnotbecalledbeforePy_Initialize(),otherwiseitreturnsNULL.
Changedinversion3.10: ItnowreturnsNULLifcalledbeforePy_Initialize().
Deprecated since version 3.13, will be removed in version 3.15: Use
PyConfig_Get("module_search_paths")(sys.path)instead.
constchar*Py_GetVersion()
PartoftheStableABI.ReturntheversionofthisPythoninterpreter. Thisisastringthatlookssomethinglike
"3.0a5+ (py3k:63103M, May 12 2008, 00:53:55) \n[GCC 4.2.3]"
Thefirstword(uptothefirstspacecharacter)isthecurrentPythonversion;thefirstcharactersarethemajor
andminorversionseparatedbyaperiod. Thereturnedstringpointsintostaticstorage; thecallershouldnot
modifyitsvalue. ThevalueisavailabletoPythoncodeassys.version.
SeealsothePy_Versionconstant.
constchar*Py_GetPlatform()
PartoftheStableABI.Returntheplatformidentifierforthecurrentplatform. OnUnix,thisisformedfrom
the“official”nameoftheoperatingsystem,convertedtolowercase,followedbythemajorrevisionnumber;
e.g.,forSolaris2.x,whichisalsoknownasSunOS5.x,thevalueis'sunos5'. OnmacOS,itis'darwin'.
OnWindows,itis'win'. Thereturnedstringpointsintostaticstorage;thecallershouldnotmodifyitsvalue.
ThevalueisavailabletoPythoncodeassys.platform.
constchar*Py_GetCopyright()
PartoftheStableABI.ReturntheofficialcopyrightstringforthecurrentPythonversion,forexample
'Copyright 1991-1995 Stichting Mathematisch Centrum, Amsterdam'
10.4. Process-wideparameters 233

### 第242页

Thereturnedstringpointsintostaticstorage;thecallershouldnotmodifyitsvalue. Thevalueisavailableto
Pythoncodeassys.copyright.
constchar*Py_GetCompiler()
PartoftheStableABI.ReturnanindicationofthecompilerusedtobuildthecurrentPythonversion,insquare
brackets,forexample:
"[GCC 2.7.2.2]"
Thereturnedstringpointsintostaticstorage;thecallershouldnotmodifyitsvalue. Thevalueisavailableto
Pythoncodeaspartofthevariablesys.version.
constchar*Py_GetBuildInfo()
PartoftheStableABI.Returninformationaboutthesequencenumberandbuilddateandtimeofthecurrent
Pythoninterpreterinstance,forexample
"#67, Aug 1 1997, 22:34:28"
Thereturnedstringpointsintostaticstorage;thecallershouldnotmodifyitsvalue. Thevalueisavailableto
Pythoncodeaspartofthevariablesys.version.
voidPySys_SetArgvEx(intargc,wchar_t**argv,intupdatepath)
PartoftheStableABI.ThisAPIiskeptforbackwardcompatibility: settingPyConfig.argv,PyConfig.
parse_argvandPyConfig.safe_pathshouldbeusedinstead,seePythonInitializationConfiguration.
Set sys.argv based on argc and argv. These parameters are similar to those passed to the program’s
main() function with the difference that the first entry should refer to the script file to be executed rather
than the executable hosting the Python interpreter. If there isn’t a script that will be run, the first entry in
argvcanbeanemptystring. Ifthisfunctionfailstoinitializesys.argv,afatalconditionissignalledusing
Py_FatalError().
Ifupdatepathiszero,thisisallthefunctiondoes. Ifupdatepathisnon-zero,thefunctionalsomodifiessys.
pathaccordingtothefollowingalgorithm:
• Ifthenameofanexistingscriptispassedinargv[0],theabsolutepathofthedirectorywherethescript
islocatedisprependedtosys.path.
• Otherwise (that is, if argc is 0 or argv[0] doesn’t point to an existing file name), an empty string is
prependedtosys.path,whichisthesameasprependingthecurrentworkingdirectory(".").
UsePy_DecodeLocale()todecodeabytesstringtogetawchar_t*string.
SeealsoPyConfig.orig_argvandPyConfig.argvmembersofthePythonInitializationConfiguration.
(cid:174) Note
ItisrecommendedthatapplicationsembeddingthePythoninterpreterforpurposesotherthanexecutinga
singlescriptpass0asupdatepath,andupdatesys.paththemselvesifdesired. SeeCVE2008-5983.
Onversionsbefore3.1.3,youcanachievethesameeffectbymanuallypoppingthefirstsys.pathelement
afterhavingcalledPySys_SetArgv(),forexampleusing:
PyRun_SimpleString("import sys; sys.path.pop(0)\n");
Addedinversion3.1.3.
Deprecatedsinceversion3.11,willberemovedinversion3.15.
voidPySys_SetArgv(intargc,wchar_t**argv)
PartoftheStableABI.ThisAPIiskeptforbackwardcompatibility:settingPyConfig.argvandPyConfig.
parse_argvshouldbeusedinstead,seePythonInitializationConfiguration.
234 Chapter10. Initialization,Finalization,andThreads

### 第243页

ThisfunctionworkslikePySys_SetArgvEx()withupdatepathsetto1unlessthepythoninterpreterwas
startedwiththe-I.
UsePy_DecodeLocale()todecodeabytesstringtogetawchar_t*string.
SeealsoPyConfig.orig_argvandPyConfig.argvmembersofthePythonInitializationConfiguration.
Changedinversion3.4: Theupdatepathvaluedependson-I.
Deprecatedsinceversion3.11,willberemovedinversion3.15.
voidPy_SetPythonHome(constwchar_t*home)
PartoftheStableABI.ThisAPIiskeptforbackwardcompatibility: settingPyConfig.homeshouldbeused
instead,seePythonInitializationConfiguration.
Setthedefault“home”directory,thatis,thelocationofthestandardPythonlibraries. SeePYTHONHOMEfor
themeaningoftheargumentstring.
Theargumentshouldpointtoazero-terminatedcharacterstringinstaticstoragewhosecontentswillnotchange
forthedurationoftheprogram’sexecution. NocodeinthePythoninterpreterwillchangethecontentsofthis
storage.
UsePy_DecodeLocale()todecodeabytesstringtogetawchar_t*string.
Deprecatedsinceversion3.11,willberemovedinversion3.15.
wchar_t*Py_GetPythonHome()
PartoftheStableABI.Returnthedefault“home”,thatis,thevaluesetbyPyConfig.home,orthevalueof
thePYTHONHOMEenvironmentvariableifitisset.
ThisfunctionshouldnotbecalledbeforePy_Initialize(),otherwiseitreturnsNULL.
Changedinversion3.10: ItnowreturnsNULLifcalledbeforePy_Initialize().
Deprecated since version 3.13, will be removed in version 3.15: Use PyConfig_Get("home") or the
PYTHONHOMEenvironmentvariableinstead.
10.5 Thread State and the Global Interpreter Lock
Unlessonafree-threadedbuildofCPython,thePythoninterpreterisnotfullythread-safe. Inordertosupportmulti-
threadedPythonprograms, there’sagloballock, calledtheglobalinterpreterlock orGIL,thatmustbeheldbythe
currentthreadbeforeitcansafelyaccessPythonobjects. Withoutthelock,eventhesimplestoperationscouldcause
problemsinamulti-threadedprogram: forexample,whentwothreadssimultaneouslyincrementthereferencecount
ofthesameobject,thereferencecountcouldendupbeingincrementedonlyonceinsteadoftwice.
Therefore,theruleexiststhatonlythethreadthathasacquiredtheGILmayoperateonPythonobjectsorcallPython/C
API functions. In order to emulate concurrency of execution, the interpreter regularly tries to switch threads (see
sys.setswitchinterval()). ThelockisalsoreleasedaroundpotentiallyblockingI/Ooperationslikereading
orwritingafile,sothatotherPythonthreadscanruninthemeantime.
The Python interpreter keeps some thread-specific bookkeeping information inside a data structure called
PyThreadState, known as a thread state. Each OS thread has a thread-local pointer to a PyThreadState; a
threadstatereferencedbythispointerisconsideredtobeattached.
A thread can only have one attached thread state at a time. An attached thread state is typically analogous with
holdingtheGIL,exceptonfree-threadedbuilds. OnbuildswiththeGILenabled,attachingathreadstatewillblock
untiltheGILcanbeacquired. However,evenonbuildswiththeGILdisabled,itisstillrequiredtohaveanattached
threadstatetocallmostoftheCAPI.
Ingeneral,therewillalwaysbeanattachedthreadstatewhenusingPython’sCAPI.Onlyinsomespecificcases(such
asinaPy_BEGIN_ALLOW_THREADSblock)willthethreadnothaveanattachedthreadstate. Ifuncertain,checkif
PyThreadState_GetUnchecked()returnsNULL.
10.5. ThreadStateandtheGlobalInterpreterLock 235

### 第244页

10.5.1 Detaching the thread state from extension code
Mostextensioncodemanipulatingthethreadstatehasthefollowingsimplestructure:
Save the thread state in a local variable.
... Do some blocking I/O operation ...
Restore the thread state from the local variable.
Thisissocommonthatapairofmacrosexiststosimplifyit:
Py_BEGIN_ALLOW_THREADS
... Do some blocking I/O operation ...
Py_END_ALLOW_THREADS
The Py_BEGIN_ALLOW_THREADS macro opens a new block and declares a hidden local variable; the
Py_END_ALLOW_THREADSmacroclosestheblock.
Theblockaboveexpandstothefollowingcode:
PyThreadState *_save;
_save = PyEval_SaveThread();
... Do some blocking I/O operation ...
PyEval_RestoreThread(_save);
Hereishowthesefunctionswork:
The attached thread state holds the GIL for the entire interpreter. When detaching the attached thread state, the
GIL is released, allowing other threads to attach a thread state to their own thread, thus getting the GIL and
can start executing. The pointer to the prior attached thread state is stored as a local variable. Upon reaching
Py_END_ALLOW_THREADS,thethreadstatethatwaspreviouslyattachedispassedtoPyEval_RestoreThread().
This function will block until another releases its thread state, thus allowing the old thread state to get re-attached
andtheCAPIcanbecalledagain.
Forfree-threaded builds,theGILisnormallyoutofthequestion,butdetachingthethreadstateisstillrequiredfor
blockingI/Oandlongoperations. Thedifferenceisthatthreadsdon’thavetowaitfortheGILtobereleasedtoattach
theirthreadstate,allowingtruemulti-coreparallelism.
(cid:174) Note
CallingsystemI/Ofunctionsisthemostcommonusecasefordetachingthethreadstate,butitcanalsobeuseful
before calling long-running computations which don’t need access to Python objects, such as compression or
cryptographicfunctionsoperatingovermemorybuffers. Forexample,thestandardzlibandhashlibmodules
detachthethreadstatewhencompressingorhashingdata.
10.5.2 Non-Python created threads
When threads are created using the dedicated Python APIs (such as the threading module), a thread state is
automaticallyassociatedtothemandthecodeshowedaboveisthereforecorrect. However,whenthreadsarecreated
fromC(forexamplebyathird-partylibrarywithitsownthreadmanagement),theydon’tholdtheGIL,becausethey
don’thaveanattachedthreadstate.
IfyouneedtocallPythoncodefromthesethreads(oftenthiswillbepartofacallbackAPIprovidedbytheafore-
mentionedthird-partylibrary),youmustfirstregisterthesethreadswiththeinterpreterbycreatinganattachedthread
statebeforeyoucanstartusingthePython/CAPI.Whenyouaredone,youshoulddetachthethreadstate,andfinally
freeit.
The PyGILState_Ensure() and PyGILState_Release() functions do all of the above automatically. The
typicalidiomforcallingintoPythonfromaCthreadis:
236 Chapter10. Initialization,Finalization,andThreads

### 第245页

PyGILState_STATE gstate;
gstate = PyGILState_Ensure();
/* Perform Python actions here. */
result = CallSomeFunction();
/* evaluate result or handle exception */
/* Release the thread. No Python API allowed beyond this point. */
PyGILState_Release(gstate);
Note that the PyGILState_* functions assume there is only one global interpreter (created automatically by
Py_Initialize()). Pythonsupportsthecreationofadditionalinterpreters(usingPy_NewInterpreter()),but
mixingmultipleinterpretersandthePyGILState_*APIisunsupported. ThisisbecausePyGILState_Ensure()
andsimilarfunctionsdefaulttoattachingathreadstateforthemaininterpreter,meaningthatthethreadcan’tsafely
interactwiththecallingsubinterpreter.
10.5.3 Supporting subinterpreters in non-Python threads
Ifyouwouldliketosupportsubinterpreterswithnon-Pythoncreatedthreads,youmustusethePyThreadState_*
APIinsteadofthetraditionalPyGILState_*API.
Inparticular,youmuststoretheinterpreterstatefromthecallingfunctionandpassittoPyThreadState_New(),
whichwillensurethatthethreadstateistargetingthecorrectinterpreter:
/* The return value of PyInterpreterState_Get() from the
function that created this thread. */
PyInterpreterState *interp = ThreadData->interp;
PyThreadState *tstate = PyThreadState_New(interp);
PyThreadState_Swap(tstate);
/* GIL of the subinterpreter is now held.
Perform Python actions here. */
result = CallSomeFunction();
/* evaluate result or handle exception */
/* Destroy the thread state. No Python API allowed beyond this point. */
PyThreadState_Clear(tstate);
PyThreadState_DeleteCurrent();
10.5.4 Cautions about fork()
AnotherimportantthingtonoteaboutthreadsistheirbehaviourinthefaceoftheCfork()call. Onmostsystems
withfork(),afteraprocessforksonlythethreadthatissuedtheforkwillexist. Thishasaconcreteimpactbothon
howlocksmustbehandledandonallstoredstateinCPython’sruntime.
Thefactthatonlythe“current”threadremainsmeansanylocksheldbyotherthreadswillneverbereleased. Python
solvesthisforos.fork()byacquiringthelocksitusesinternallybeforethefork,andreleasingthemafterwards.
Inaddition,itresetsanylock-objectsinthechild. WhenextendingorembeddingPython,thereisnowaytoinform
Python of additional (non-Python) locks that need to be acquired before or reset after a fork. OS facilities such
as pthread_atfork() would need to be used to accomplish the same thing. Additionally, when extending or
embeddingPython,callingfork()directlyratherthanthroughos.fork()(andreturningtoorcallingintoPython)
may result in a deadlock by one of Python’s internal locks being held by a thread that is defunct after the fork.
PyOS_AfterFork_Child()triestoresetthenecessarylocks,butisnotalwaysableto.
ThefactthatallotherthreadsgoawayalsomeansthatCPython’sruntimestatetheremustbecleanedupproperly,
whichos.fork()does. ThismeansfinalizingallotherPyThreadStateobjectsbelongingtothecurrentinterpreter
andallotherPyInterpreterStateobjects. Duetothisandthespecialnatureofthe“main”interpreter,fork()
shouldonlybecalledinthatinterpreter’s“main”thread,wheretheCPythonglobalruntimewasoriginallyinitialized.
Theonlyexceptionisifexec()willbecalledimmediatelyafter.
10.5. ThreadStateandtheGlobalInterpreterLock 237

### 第246页

10.5.5 Cautions regarding runtime finalization
In the late stage of interpreter shutdown, after attempting to wait for non-daemon threads to exit (though this can
beinterruptedbyKeyboardInterrupt)andrunningtheatexitfunctions, theruntimeismarkedasfinalizing:
Py_IsFinalizing() and sys.is_finalizing() return true. At this point, only the finalization thread that
initiatedfinalization(typicallythemainthread)isallowedtoacquiretheGIL.
Ifanythread,otherthanthefinalizationthread,attemptstoattachathreadstateduringfinalization,eitherexplicitly
orimplicitly,thethreadentersapermanentlyblockedstatewhereitremainsuntiltheprogramexits. Inmostcases
thisisharmless,butthiscanresultindeadlockifalaterstageoffinalizationattemptstoacquirealockownedbythe
blockedthread,orotherwisewaitsontheblockedthread.
Gross? Yes. Thispreventsrandomcrashesand/orunexpectedlyskippedC++finalizationsfurtherupthecallstack
whensuchthreadswereforciblyexitedhereinCPython3.13andearlier. TheCPythonruntimethreadstateCAPIs
have never had any error reporting or handling expectations at thread state attachment time that would’ve allowed
forgracefulexitfromthissituation. ChangingthatwouldrequirenewstableCAPIsandrewritingthemajorityofC
codeintheCPythonecosystemtousethosewitherrorhandling.
10.5.6 High-level API
These are the most commonly used types and functions when writing C extension code, or when embedding the
Pythoninterpreter:
typePyInterpreterState
PartoftheLimitedAPI(asanopaquestruct). Thisdatastructurerepresentsthestatesharedbyanumberof
cooperatingthreads. Threadsbelongingtothesameinterpretersharetheirmoduleadministrationandafew
otherinternalitems. Therearenopublicmembersinthisstructure.
Threadsbelongingtodifferentinterpretersinitiallysharenothing,exceptprocessstatelikeavailablememory,
openfiledescriptorsandsuch. Theglobalinterpreterlockisalsosharedbyallthreads,regardlessoftowhich
interpretertheybelong.
Changed in version 3.12: PEP 684 introduced the possibility of a per-interpreter GIL. See
Py_NewInterpreterFromConfig().
typePyThreadState
PartoftheLimitedAPI(asanopaquestruct). Thisdatastructurerepresentsthestateofasinglethread. The
onlypublicdatamemberis:
PyInterpreterState*interp
Thisthread’sinterpreterstate.
voidPyEval_InitThreads()
PartoftheStableABI.Deprecatedfunctionwhichdoesnothing.
InPython3.6andolder,thisfunctioncreatedtheGILifitdidn’texist.
Changedinversion3.9: Thefunctionnowdoesnothing.
Changedinversion3.7:ThisfunctionisnowcalledbyPy_Initialize(),soyoudon’thavetocallityourself
anymore.
Changedinversion3.2: ThisfunctioncannotbecalledbeforePy_Initialize()anymore.
Deprecatedsinceversion3.9.
PyThreadState*PyEval_SaveThread()
PartoftheStableABI.Detachtheattachedthreadstateandreturnit. Thethreadwillhavenothreadstateupon
returning.
voidPyEval_RestoreThread(PyThreadState*tstate)
PartoftheStableABI.Settheattachedthreadstatetotstate. Thepassedthreadstateshouldnotbeattached,
otherwisedeadlockensues. tstatewillbeattacheduponreturning.
238 Chapter10. Initialization,Finalization,andThreads

### 第247页

(cid:174) Note
Callingthisfunctionfromathreadwhentheruntimeisfinalizingwillhangthethreaduntiltheprogram
exits, even if the thread was not created by Python. Refer to Cautions regarding runtime finalization for
moredetails.
Changedinversion3.14: Hangsthecurrentthread,ratherthanterminatingit,ifcalledwhiletheinterpreteris
finalizing.
PyThreadState*PyThreadState_Get()
PartoftheStableABI.Returntheattachedthreadstate. Ifthethreadhasnoattachedthreadstate, (suchas
when inside of Py_BEGIN_ALLOW_THREADS block), then this issues a fatal error (so that the caller needn’t
checkforNULL).
SeealsoPyThreadState_GetUnchecked().
PyThreadState*PyThreadState_GetUnchecked()
SimilartoPyThreadState_Get(),butdon’tkilltheprocesswithafatalerrorifitisNULL.Thecalleris
responsibletocheckiftheresultisNULL.
Added in version 3.13: In Python 3.5 to 3.12, the function was private and known as
_PyThreadState_UncheckedGet().
PyThreadState*PyThreadState_Swap(PyThreadState*tstate)
PartoftheStableABI.Settheattachedthreadstatetotstate,andreturnthethreadstatethatwasattachedprior
tocalling.
Thisfunctionissafetocallwithoutanattachedthreadstate; itwillsimplyreturnNULLindicatingthatthere
wasnopriorthreadstate.
(cid:174) Note
SimilartoPyGILState_Ensure(),thisfunctionwillhangthethreadiftheruntimeisfinalizing.
Thefollowingfunctionsusethread-localstorage,andarenotcompatiblewithsub-interpreters:
PyGILState_STATEPyGILState_Ensure()
Part of the Stable ABI. Ensure that the current thread is ready to call the Python C API regardless of the
current state of Python, or of the attached thread state. This may be called as many times as desired by a
thread as long as each call is matched with a call to PyGILState_Release(). In general, other thread-
related APIs may be used between PyGILState_Ensure() and PyGILState_Release() calls as long
as the thread state is restored to its previous state before the Release(). For example, normal usage of the
Py_BEGIN_ALLOW_THREADSandPy_END_ALLOW_THREADSmacrosisacceptable.
Thereturnvalueisanopaque“handle”totheattachedthreadstatewhenPyGILState_Ensure()wascalled,
and must be passed to PyGILState_Release() to ensure Python is left in the same state. Even though
recursive calls are allowed, these handles cannot be shared - each unique call to PyGILState_Ensure()
mustsavethehandleforitscalltoPyGILState_Release().
Whenthefunctionreturns,therewillbeanattachedthreadstateandthethreadwillbeabletocallarbitrary
Pythoncode. Failureisafatalerror.
(cid:193) Warning
Callingthisfunctionwhentheruntimeisfinalizingisunsafe. Doingsowilleitherhangthethreaduntilthe
programends,orfullycrashtheinterpreterinrarecases. RefertoCautionsregardingruntimefinalization
formoredetails.
10.5. ThreadStateandtheGlobalInterpreterLock 239

| (cid:193) Warning |
| --- |
| Callingthisfunctionwhentheruntimeisfinalizingisunsafe. Doingsowilleitherhangthethreaduntilthe
programends,orfullycrashtheinterpreterinrarecases. RefertoCautionsregardingruntimefinalization
formoredetails. |

### 第248页

Changedinversion3.14: Hangsthecurrentthread,ratherthanterminatingit,ifcalledwhiletheinterpreteris
finalizing.
voidPyGILState_Release(PyGILState_STATE)
PartoftheStableABI.Releaseanyresourcespreviouslyacquired. Afterthiscall,Python’sstatewillbethesame
asitwaspriortothecorrespondingPyGILState_Ensure()call(butgenerallythisstatewillbeunknownto
thecaller,hencetheuseoftheGILStateAPI).
EverycalltoPyGILState_Ensure()mustbematchedbyacalltoPyGILState_Release()onthesame
thread.
PyThreadState*PyGILState_GetThisThreadState()
Part of the Stable ABI. Get the attached thread state for this thread. May return NULL if no GILState API
has been used on the current thread. Note that the main thread always has such a thread-state, even if no
auto-thread-statecallhasbeenmadeonthemainthread. Thisismainlyahelper/diagnosticfunction.
(cid:174) Note
This function does not account for thread states created by something other than
PyGILState_Ensure() (such as PyThreadState_New()). Prefer PyThreadState_Get() or
PyThreadState_GetUnchecked()formostcases.
intPyGILState_Check()
Return1ifthecurrentthreadisholdingtheGILand0otherwise. Thisfunctioncanbecalledfromanythread
atanytime. OnlyifithashaditsthreadstateinitializedviaPyGILState_Ensure()willitreturn1. This
ismainlyahelper/diagnosticfunction. Itcanbeusefulforexampleincallbackcontextsormemoryallocation
functionswhenknowingthattheGILislockedcanallowthecallertoperformsensitiveactionsorotherwise
behavedifferently.
(cid:174) Note
IfthecurrentPythonprocesshasevercreatedasubinterpreter,thisfunctionwillalwaysreturn1. Prefer
PyThreadState_GetUnchecked()formostcases.
Addedinversion3.4.
Thefollowingmacrosarenormallyusedwithoutatrailingsemicolon;lookforexampleusageinthePythonsource
distribution.
Py_BEGIN_ALLOW_THREADS
Part of the Stable ABI. This macro expands to { PyThreadState *_save; _save =
PyEval_SaveThread();. Note that it contains an opening brace; it must be matched with a follow-
ingPy_END_ALLOW_THREADSmacro. Seeaboveforfurtherdiscussionofthismacro.
Py_END_ALLOW_THREADS
PartoftheStableABI.ThismacroexpandstoPyEval_RestoreThread(_save); }. Notethatitcontains
aclosingbrace;itmustbematchedwithanearlierPy_BEGIN_ALLOW_THREADSmacro. Seeaboveforfurther
discussionofthismacro.
Py_BLOCK_THREADS
Part of the Stable ABI. This macro expands to PyEval_RestoreThread(_save);: it is equivalent to
Py_END_ALLOW_THREADSwithouttheclosingbrace.
Py_UNBLOCK_THREADS
Part of the Stable ABI. This macro expands to _save = PyEval_SaveThread();: it is equivalent to
Py_BEGIN_ALLOW_THREADSwithouttheopeningbraceandvariabledeclaration.
240 Chapter10. Initialization,Finalization,andThreads

### 第249页

10.5.7 Low-level API
AllofthefollowingfunctionsmustbecalledafterPy_Initialize().
Changedinversion3.7: Py_Initialize()nowinitializestheGILandsetsanattachedthreadstate.
PyInterpreterState*PyInterpreterState_New()
PartoftheStableABI.Createanewinterpreterstateobject. Anattachedthreadstateisnotneeded,butmay
optionallyexistifitisnecessarytoserializecallstothisfunction.
Raisesanauditingeventcpython.PyInterpreterState_Newwithnoarguments.
voidPyInterpreterState_Clear(PyInterpreterState*interp)
PartoftheStableABI.Resetallinformationinaninterpreterstateobject. Theremustbeanattachedthread
statefortheinterpreter.
Raisesanauditingeventcpython.PyInterpreterState_Clearwithnoarguments.
voidPyInterpreterState_Delete(PyInterpreterState*interp)
Part of the Stable ABI. Destroy an interpreter state object. There should not be an attached thread
state for the target interpreter. The interpreter state must have been reset with a previous call to
PyInterpreterState_Clear().
PyThreadState*PyThreadState_New(PyInterpreterState*interp)
PartoftheStableABI.Createanewthreadstateobjectbelongingtothegiveninterpreterobject. Anattached
threadstateisnotneeded.
voidPyThreadState_Clear(PyThreadState*tstate)
PartoftheStableABI.Resetallinformationinathreadstateobject. tstatemustbeattached
Changedinversion3.9: ThisfunctionnowcallsthePyThreadState.on_deletecallback. Previously,that
happenedinPyThreadState_Delete().
Changedinversion3.13: ThePyThreadState.on_deletecallbackwasremoved.
voidPyThreadState_Delete(PyThreadState*tstate)
PartoftheStableABI.Destroyathreadstateobject. tstateshouldnotbeattached toanythread. tstatemust
havebeenresetwithapreviouscalltoPyThreadState_Clear().
voidPyThreadState_DeleteCurrent(void)
Detach the attached thread state (which must have been reset with a previous call to
PyThreadState_Clear())andthendestroyit.
Nothreadstatewillbeattacheduponreturning.
PyFrameObject*PyThreadState_GetFrame(PyThreadState*tstate)
PartoftheStableABIsinceversion3.10. GetthecurrentframeofthePythonthreadstatetstate.
Returnastrongreference. ReturnNULLifnoframeiscurrentlyexecuting.
SeealsoPyEval_GetFrame().
tstatemustnotbeNULL,andmustbeattached.
Addedinversion3.9.
uint64_tPyThreadState_GetID(PyThreadState*tstate)
PartoftheStableABIsinceversion3.10. GettheuniquethreadstateidentifierofthePythonthreadstatetstate.
tstatemustnotbeNULL,andmustbeattached.
Addedinversion3.9.
PyInterpreterState*PyThreadState_GetInterpreter(PyThreadState*tstate)
PartoftheStableABIsinceversion3.10. GettheinterpreterofthePythonthreadstatetstate.
tstatemustnotbeNULL,andmustbeattached.
Addedinversion3.9.
10.5. ThreadStateandtheGlobalInterpreterLock 241

### 第250页

voidPyThreadState_EnterTracing(PyThreadState*tstate)
SuspendtracingandprofilinginthePythonthreadstatetstate.
ResumethemusingthePyThreadState_LeaveTracing()function.
Addedinversion3.11.
voidPyThreadState_LeaveTracing(PyThreadState*tstate)
Resume tracing and profiling in the Python thread state tstate suspended by the
PyThreadState_EnterTracing()function.
SeealsoPyEval_SetTrace()andPyEval_SetProfile()functions.
Addedinversion3.11.
PyInterpreterState*PyInterpreterState_Get(void)
PartoftheStableABIsinceversion3.9. Getthecurrentinterpreter.
Issueafatalerroriftherenoattachedthreadstate. ItcannotreturnNULL.
Addedinversion3.9.
int64_tPyInterpreterState_GetID(PyInterpreterState*interp)
PartoftheStableABIsinceversion3.7. Returntheinterpreter’suniqueID.Iftherewasanyerrorindoingso
then-1isreturnedandanerrorisset.
Thecallermusthaveanattachedthreadstate.
Addedinversion3.7.
PyObject*PyInterpreterState_GetDict(PyInterpreterState*interp)
Return value: Borrowed reference. Part of the Stable ABI since version 3.8. Return a dictionary in which
interpreter-specificdatamaybestored. IfthisfunctionreturnsNULLthennoexceptionhasbeenraisedand
thecallershouldassumenointerpreter-specificdictisavailable.
This is not a replacement for PyModule_GetState(), which extensions should use to store interpreter-
specificstateinformation.
Thereturneddictionaryisborrowedfromtheinterpreterandisvaliduntilinterpretershutdown.
Addedinversion3.8.
typedefPyObject*(*_PyFrameEvalFunction)(PyThreadState*tstate,_PyInterpreterFrame*frame,int
throwflag)
Typeofaframeevaluationfunction.
Thethrowflagparameterisusedbythethrow()methodofgenerators: ifnon-zero, handlethecurrentex-
ception.
Changedinversion3.9: Thefunctionnowtakesatstateparameter.
Changed in version 3.11: The frame parameter changed from PyFrameObject* to
_PyInterpreterFrame*.
_PyFrameEvalFunction_PyInterpreterState_GetEvalFrameFunc(PyInterpreterState*interp)
Gettheframeevaluationfunction.
SeethePEP523“AddingaframeevaluationAPItoCPython”.
Addedinversion3.9.
void_PyInterpreterState_SetEvalFrameFunc(PyInterpreterState*interp,_PyFrameEvalFunction
eval_frame)
Settheframeevaluationfunction.
SeethePEP523“AddingaframeevaluationAPItoCPython”.
Addedinversion3.9.
242 Chapter10. Initialization,Finalization,andThreads

### 第251页

PyObject*PyThreadState_GetDict()
Returnvalue: Borrowedreference. PartoftheStableABI.Returnadictionaryinwhichextensionscanstore
thread-specificstateinformation. Eachextensionshoulduseauniquekeytousetostorestateinthedictionary.
Itisokaytocallthisfunctionwhennothreadstateisattached. IfthisfunctionreturnsNULL,noexceptionhas
beenraisedandthecallershouldassumenothreadstateisattached.
intPyThreadState_SetAsyncExc(unsignedlongid,PyObject*exc)
PartoftheStableABI.Asynchronouslyraiseanexceptioninathread. Theidargumentisthethreadidofthe
targetthread; excistheexceptionobjecttoberaised. Thisfunctiondoesnotstealanyreferencestoexc. To
preventnaivemisuse,youmustwriteyourownCextensiontocallthis. Mustbecalledwithanattachedthread
state. Returnsthenumberofthreadstatesmodified;thisisnormallyone,butwillbezeroifthethreadidisn’t
found. IfexcisNULL,thependingexception(ifany)forthethreadiscleared. Thisraisesnoexceptions.
Changedinversion3.7: Thetypeoftheidparameterchangedfromlongtounsigned long.
voidPyEval_AcquireThread(PyThreadState*tstate)
PartoftheStableABI.Attachtstatetothecurrentthread,whichmustnotbeNULLoralreadyattached.
Thecallingthreadmustnotalreadyhaveanattachedthreadstate.
(cid:174) Note
Callingthisfunctionfromathreadwhentheruntimeisfinalizingwillhangthethreaduntiltheprogram
exits, even if the thread was not created by Python. Refer to Cautions regarding runtime finalization for
moredetails.
Changed in version 3.8: Updated to be consistent with PyEval_RestoreThread(),
Py_END_ALLOW_THREADS(), and PyGILState_Ensure(), and terminate the current thread if called
whiletheinterpreterisfinalizing.
Changedinversion3.14: Hangsthecurrentthread,ratherthanterminatingit,ifcalledwhiletheinterpreteris
finalizing.
PyEval_RestoreThread()isahigher-levelfunctionwhichisalwaysavailable(evenwhenthreadshavenot
beeninitialized).
voidPyEval_ReleaseThread(PyThreadState*tstate)
PartoftheStableABI.Detachtheattachedthreadstate. Thetstateargument,whichmustnotbeNULL,isonly
usedtocheckthatitrepresentstheattachedthreadstate—ifitisn’t,afatalerrorisreported.
PyEval_SaveThread() is a higher-level function which is always available (even when threads have not
beeninitialized).
10.6 Sub-interpreter support
Whileinmostuses,youwillonlyembedasinglePythoninterpreter,therearecaseswhereyouneedtocreateseveral
independentinterpretersinthesameprocessandperhapseveninthesamethread. Sub-interpretersallowyoutodo
that.
The“main”interpreteristhefirstonecreatedwhentheruntimeinitializes. ItisusuallytheonlyPythoninterpreterina
process. Unlikesub-interpreters,themaininterpreterhasuniqueprocess-globalresponsibilitieslikesignalhandling.
Itisalsoresponsibleforexecutionduringruntimeinitializationandisusuallytheactiveinterpreterduringruntime
finalization. ThePyInterpreterState_Main()functionreturnsapointertoitsstate.
Youcanswitchbetweensub-interpretersusingthePyThreadState_Swap()function. Youcancreateanddestroy
themusingthefollowingfunctions:
typePyInterpreterConfig
Structure containing most parameters to configure a sub-interpreter. Its values are used only in
Py_NewInterpreterFromConfig()andnevermodifiedbytheruntime.
10.6. Sub-interpretersupport 243

### 第252页

Addedinversion3.12.
Structurefields:
intuse_main_obmalloc
Ifthisis0thenthesub-interpreterwilluseitsown“object”allocatorstate. Otherwiseitwilluse(share)
themaininterpreter’s.
Ifthisis0thencheck_multi_interp_extensionsmustbe1(non-zero). Ifthisis1thengilmust
notbePyInterpreterConfig_OWN_GIL.
intallow_fork
Ifthisis0thentheruntimewillnotsupportforkingtheprocessinanythreadwherethesub-interpreter
iscurrentlyactive. Otherwiseforkisunrestricted.
Notethatthesubprocessmodulestillworkswhenforkisdisallowed.
intallow_exec
Ifthisis0thentheruntimewillnotsupportreplacingthecurrentprocessviaexec(e.g. os.execv())
inanythreadwherethesub-interpreteriscurrentlyactive. Otherwiseexecisunrestricted.
Notethatthesubprocessmodulestillworkswhenexecisdisallowed.
intallow_threads
If this is 0 then the sub-interpreter’s threading module won’t create threads. Otherwise threads are
allowed.
intallow_daemon_threads
Ifthisis0thenthesub-interpreter’sthreadingmodulewon’tcreatedaemonthreads. Otherwisedaemon
threadsareallowed(aslongasallow_threadsisnon-zero).
intcheck_multi_interp_extensions
If this is 0 then all extension modules may be imported, including legacy (single-phase init) modules,
in any thread where the sub-interpreter is currently active. Otherwise only multi-phase init extension
modules(seePEP489)maybeimported. (AlsoseePy_mod_multiple_interpreters.)
Thismustbe1(non-zero)ifuse_main_obmallocis0.
intgil
ThisdeterminestheoperationoftheGILforthesub-interpreter. Itmaybeoneofthefollowing:
PyInterpreterConfig_DEFAULT_GIL
Usethedefaultselection(PyInterpreterConfig_SHARED_GIL).
PyInterpreterConfig_SHARED_GIL
Use(share)themaininterpreter’sGIL.
PyInterpreterConfig_OWN_GIL
Usethesub-interpreter’sownGIL.
If this is PyInterpreterConfig_OWN_GIL then PyInterpreterConfig.use_main_obmalloc
mustbe0.
PyStatusPy_NewInterpreterFromConfig(PyThreadState**tstate_p,constPyInterpreterConfig*config)
Create a new sub-interpreter. This is an (almost) totally separate environment for the execution of Python
code. Inparticular,thenewinterpreterhasseparate,independentversionsofallimportedmodules,including
thefundamentalmodulesbuiltins,__main__andsys. Thetableofloadedmodules(sys.modules)and
themodulesearchpath(sys.path)arealsoseparate. Thenewenvironmenthasnosys.argvvariable. It
hasnewstandardI/Ostreamfileobjectssys.stdin, sys.stdoutandsys.stderr(howevertheserefer
tothesameunderlyingfiledescriptors).
Thegivenconfigcontrolstheoptionswithwhichtheinterpreterisinitialized.
Uponsuccess,tstate_pwillbesettothefirstthreadstatecreatedinthenewsub-interpreter. Thisthreadstate
isattached. Notethatnoactualthreadiscreated;seethediscussionofthreadstatesbelow. Ifcreationofthe
244 Chapter10. Initialization,Finalization,andThreads

### 第253页

newinterpreterisunsuccessful,tstate_pissettoNULL;noexceptionissetsincetheexceptionstateisstoredin
theattachedthreadstate,whichmightnotexist.
LikeallotherPython/CAPIfunctions,anattachedthreadstatemustbepresentbeforecallingthisfunction,
butitmightbedetacheduponreturning. Onsuccess, thereturnedthreadstatewillbeattached. Ifthesub-
interpreteriscreatedwithitsownGILthentheattachedthreadstateofthecallinginterpreterwillbedetached.
When the function returns, the new interpreter’s thread state will be attached to the current thread and the
previousinterpreter’sattachedthreadstatewillremaindetached.
Addedinversion3.12.
Sub-interpretersaremosteffectivewhenisolatedfromeachother,withcertainfunctionalityrestricted:
PyInterpreterConfig config = {
.use_main_obmalloc = 0,
.allow_fork = 0,
.allow_exec = 0,
.allow_threads = 1,
.allow_daemon_threads = 0,
.check_multi_interp_extensions = 1,
.gil = PyInterpreterConfig_OWN_GIL,
};
PyThreadState *tstate = NULL;
PyStatus status = Py_NewInterpreterFromConfig(&tstate, &config);
if (PyStatus_Exception(status)) {
Py_ExitStatusException(status);
}
Notethattheconfigisusedonlybrieflyanddoesnotgetmodified. Duringinitializationtheconfig’svaluesare
convertedintovariousPyInterpreterStatevalues. Aread-onlycopyoftheconfigmaybestoredinternally
onthePyInterpreterState.
Extensionmodulesaresharedbetween(sub-)interpretersasfollows:
• Formodulesusingmulti-phaseinitialization,e.g. PyModule_FromDefAndSpec(),aseparatemodule
objectiscreatedandinitializedforeachinterpreter. OnlyC-levelstaticandglobalvariablesareshared
betweenthesemoduleobjects.
• Formodulesusingsingle-phaseinitialization,e.g. PyModule_Create(),thefirsttimeaparticularex-
tensionisimported,itisinitializednormally,anda(shallow)copyofitsmodule’sdictionaryissquirreled
away. Whenthesameextensionisimportedbyanother(sub-)interpreter,anewmoduleisinitializedand
filledwiththecontentsofthiscopy;theextension’sinitfunctionisnotcalled. Objectsinthemodule’s
dictionarythusendupsharedacross(sub-)interpreters,whichmightcauseunwantedbehavior(seeBugs
andcaveatsbelow).
Note that this is different from what happens when an extension is imported after the interpreter has
beencompletelyre-initializedbycallingPy_FinalizeEx()andPy_Initialize();inthatcase,the
extension’sinitmodulefunctioniscalledagain. Aswithmulti-phaseinitialization,thismeansthatonly
C-levelstaticandglobalvariablesaresharedbetweenthesemodules.
PyThreadState*Py_NewInterpreter(void)
Part of the Stable ABI. Create a new sub-interpreter. This is essentially just a wrapper around
Py_NewInterpreterFromConfig() with a config that preserves the existing behavior. The result is an
unisolatedsub-interpreterthatsharesthemaininterpreter’sGIL,allowsfork/exec,allowsdaemonthreads,and
allowssingle-phaseinitmodules.
voidPy_EndInterpreter(PyThreadState*tstate)
PartoftheStableABI.Destroythe(sub-)interpreterrepresentedbythegiventhreadstate. Thegiventhread
statemustbeattached. Whenthecallreturns,therewillbenoattachedthreadstate. Allthreadstatesassociated
withthisinterpreteraredestroyed.
Py_FinalizeEx()willdestroyallsub-interpretersthathaven’tbeenexplicitlydestroyedatthatpoint.
10.6. Sub-interpretersupport 245

### 第254页

10.6.1 A Per-Interpreter GIL
UsingPy_NewInterpreterFromConfig()youcancreateasub-interpreterthatiscompletelyisolatedfromother
interpreters, including having its own GIL. The most important benefit of this isolation is that such an interpreter
canexecutePythoncodewithoutbeingblockedbyotherinterpretersorblockinganyothers. ThusasinglePython
processcantrulytakeadvantageofmultipleCPUcoreswhenrunningPythoncode. Theisolationalsoencouragesa
differentapproachtoconcurrencythanthatofjustusingthreads. (SeePEP554andPEP684.)
Usinganisolatedinterpreterrequiresvigilanceinpreservingthatisolation. Thatespeciallymeansnotsharingany
objects or mutable state without guarantees about thread-safety. Even objects that are otherwise immutable (e.g.
None, (1, 5)) can’t normally be shared because of the refcount. One simple but less-efficient approach around
thisistouseagloballockaroundalluseofsomestate(orobject). Alternately,effectivelyimmutableobjects(like
integersorstrings)canbemadesafeinspiteoftheirrefcountsbymakingthemimmortal. Infact,thishasbeendone
forthebuiltinsingletons,smallintegers,andanumberofotherbuiltinobjects.
If you preserve isolation then you will have access to proper multi-core computing without the complications that
comewithfree-threading. Failuretopreserveisolationwillexposeyoutothefullconsequencesoffree-threading,
includingracesandhard-to-debugcrashes.
Asidefromthat,oneofthemainchallengesofusingmultipleisolatedinterpretersishowtocommunicatebetween
them safely (not break isolation) and efficiently. The runtime and stdlib do not provide any standard approach to
thisyet. Afuturestdlibmodulewouldhelpmitigatetheeffortofpreservingisolationandexposeeffectivetoolsfor
communicating(andsharing)databetweeninterpreters.
Addedinversion3.12.
10.6.2 Bugs and caveats
Becausesub-interpreters(andthemaininterpreter)arepartofthesameprocess,theinsulationbetweenthemisn’t
perfect—forexample,usinglow-levelfileoperationslikeos.close()theycan(accidentallyormaliciously)affect
eachother’sopenfiles. Becauseofthewayextensionsaresharedbetween(sub-)interpreters,someextensionsmaynot
workproperly;thisisespeciallylikelywhenusingsingle-phaseinitializationor(static)globalvariables. Itispossible
toinsertobjectscreatedinonesub-interpreterintoanamespaceofanother(sub-)interpreter;thisshouldbeavoided
ifpossible.
Special care should be taken to avoid sharing user-defined functions, methods, instances or classes between sub-
interpreters,sinceimportoperationsexecutedbysuchobjectsmayaffectthewrong(sub-)interpreter’sdictionaryof
loadedmodules. Itisequallyimportanttoavoidsharingobjectsfromwhichtheabovearereachable.
AlsonotethatcombiningthisfunctionalitywithPyGILState_*APIsisdelicate,becausetheseAPIsassumeabijec-
tionbetweenPythonthreadstatesandOS-levelthreads,anassumptionbrokenbythepresenceofsub-interpreters. It
ishighlyrecommendedthatyoudon’tswitchsub-interpretersbetweenapairofmatchingPyGILState_Ensure()
andPyGILState_Release()calls. Furthermore,extensions(suchasctypes)usingtheseAPIstoallowcalling
ofPythoncodefromnon-Pythoncreatedthreadswillprobablybebrokenwhenusingsub-interpreters.
10.7 Asynchronous Notifications
Amechanismisprovidedtomakeasynchronousnotificationstothemaininterpreterthread. Thesenotificationstake
theformofafunctionpointerandavoidpointerargument.
intPy_AddPendingCall(int(*func)(void*),void*arg)
Part of the Stable ABI. Schedule a function to be called from the main interpreter thread. On success, 0 is
returnedandfuncisqueuedforbeingcalledinthemainthread. Onfailure,-1isreturnedwithoutsettingany
exception.
Whensuccessfullyqueued,funcwillbeeventuallycalledfromthemaininterpreterthreadwiththeargument
arg. ItwillbecalledasynchronouslywithrespecttonormallyrunningPythoncode,butwithboththesecon-
ditionsmet:
• onabytecodeboundary;
• withthemainthreadholdinganattachedthreadstate(funccanthereforeusethefullCAPI).
246 Chapter10. Initialization,Finalization,andThreads

### 第255页

func mustreturn0onsuccess, or-1onfailurewithanexceptionset. func won’tbeinterruptedtoperform
anotherasynchronousnotificationrecursively,butitcanstillbeinterruptedtoswitchthreadsifthethreadstate
isdetached.
Thisfunctiondoesn’tneedanattachedthreadstate. However,tocallthisfunctioninasubinterpreter,thecaller
musthaveanattachedthreadstate. Otherwise,thefunctionfunccanbescheduledtobecalledfromthewrong
interpreter.
(cid:193) Warning
This is a low-level function, only useful for very special cases. There is no guarantee that func will be
calledasquickaspossible. Ifthemainthreadisbusyexecutingasystemcall,funcwon’tbecalledbefore
the system call returns. This function is generally not suitable for calling Python code from arbitrary C
threads. Instead,usethePyGILStateAPI.
Addedinversion3.1.
Changedinversion3.9: Ifthisfunctioniscalledinasubinterpreter,thefunctionfuncisnowscheduledtobe
calledfromthesubinterpreter,ratherthanbeingcalledfromthemaininterpreter. Eachsubinterpreternowhas
itsownlistofscheduledcalls.
10.8 Profiling and Tracing
ThePythoninterpreterprovidessomelow-levelsupportforattachingprofilingandexecutiontracingfacilities. These
areusedforprofiling,debugging,andcoverageanalysistools.
ThisCinterfaceallowstheprofilingortracingcodetoavoidtheoverheadofcallingthroughPython-levelcallable
objects,makingadirectCfunctioncallinstead. Theessentialattributesofthefacilityhavenotchanged;theinterface
allowstracefunctionstobeinstalledper-thread,andthebasiceventsreportedtothetracefunctionarethesameas
hadbeenreportedtothePython-leveltracefunctionsinpreviousversions.
typedefint(*Py_tracefunc)(PyObject*obj,PyFrameObject*frame,intwhat,PyObject*arg)
The type of the trace function registered using PyEval_SetProfile() and PyEval_SetTrace().
The first parameter is the object passed to the registration function as obj, frame is the frame ob-
ject to which the event pertains, what is one of the constants PyTrace_CALL, PyTrace_EXCEPTION,
PyTrace_LINE,PyTrace_RETURN,PyTrace_C_CALL,PyTrace_C_EXCEPTION,PyTrace_C_RETURN,
orPyTrace_OPCODE,andargdependsonthevalueofwhat:
Valueofwhat Meaningofarg
PyTrace_CALL AlwaysPy_None.
PyTrace_EXCEPTION Exceptioninformationasreturnedbysys.exc_info().
PyTrace_LINE AlwaysPy_None.
PyTrace_RETURN Valuebeingreturnedtothecaller,orNULLifcausedbyanexception.
PyTrace_C_CALL Functionobjectbeingcalled.
PyTrace_C_EXCEPTION Functionobjectbeingcalled.
PyTrace_C_RETURN Functionobjectbeingcalled.
PyTrace_OPCODE AlwaysPy_None.
intPyTrace_CALL
The value of the what parameter to a Py_tracefunc function when a new call to a function or method is
beingreported,oranewentryintoagenerator. Notethatthecreationoftheiteratorforageneratorfunction
isnotreportedasthereisnocontroltransfertothePythonbytecodeinthecorrespondingframe.
intPyTrace_EXCEPTION
The value of the what parameter to a Py_tracefunc function when an exception has been raised. The
callback function is called with this value for what when after any bytecode is processed after which the
exception becomes set within the frame being executed. The effect of this is that as exception propagation
10.8. ProfilingandTracing 247

| (cid:193) Warning |
| --- |
| This is a low-level function, only useful for very special cases. There is no guarantee that func will be
calledasquickaspossible. Ifthemainthreadisbusyexecutingasystemcall,funcwon’tbecalledbefore
the system call returns. This function is generally not suitable for calling Python code from arbitrary C
threads. Instead,usethePyGILStateAPI. |


| Valueofwhat | Meaningofarg |
| --- | --- |
| PyTrace_CALL | AlwaysPy_None. |
| PyTrace_EXCEPTION | Exceptioninformationasreturnedbysys.exc_info(). |
| PyTrace_LINE | AlwaysPy_None. |
| PyTrace_RETURN | Valuebeingreturnedtothecaller,orNULLifcausedbyanexception. |
| PyTrace_C_CALL | Functionobjectbeingcalled. |
| PyTrace_C_EXCEPTION | Functionobjectbeingcalled. |
| PyTrace_C_RETURN | Functionobjectbeingcalled. |
| PyTrace_OPCODE | AlwaysPy_None. |

### 第256页

causesthePythonstacktounwind,thecallbackiscalleduponreturntoeachframeastheexceptionpropagates.
Onlytracefunctionsreceivestheseevents;theyarenotneededbytheprofiler.
intPyTrace_LINE
Thevaluepassedasthewhat parametertoaPy_tracefuncfunction(butnotaprofilingfunction)whena
line-numbereventisbeingreported. Itmaybedisabledforaframebysettingf_trace_linesto0onthat
frame.
intPyTrace_RETURN
ThevalueforthewhatparametertoPy_tracefuncfunctionswhenacallisabouttoreturn.
intPyTrace_C_CALL
ThevalueforthewhatparametertoPy_tracefuncfunctionswhenaCfunctionisabouttobecalled.
intPyTrace_C_EXCEPTION
ThevalueforthewhatparametertoPy_tracefuncfunctionswhenaCfunctionhasraisedanexception.
intPyTrace_C_RETURN
ThevalueforthewhatparametertoPy_tracefuncfunctionswhenaCfunctionhasreturned.
intPyTrace_OPCODE
Thevalueforthewhat parametertoPy_tracefuncfunctions(butnotprofilingfunctions)whenanewop-
codeisabouttobeexecuted. Thiseventisnotemittedbydefault: itmustbeexplicitlyrequestedbysetting
f_trace_opcodesto1ontheframe.
voidPyEval_SetProfile(Py_tracefuncfunc,PyObject*obj)
Settheprofilerfunctiontofunc. Theobj parameterispassedtothefunctionasitsfirstparameter,andmay
beanyPythonobject,orNULL.Iftheprofilefunctionneedstomaintainstate,usingadifferentvalueforobj
for each thread provides a convenient and thread-safe place to store it. The profile function is called for all
monitoredeventsexceptPyTrace_LINEPyTrace_OPCODEandPyTrace_EXCEPTION.
Seealsothesys.setprofile()function.
Thecallermusthaveanattachedthreadstate.
voidPyEval_SetProfileAllThreads(Py_tracefuncfunc,PyObject*obj)
Like PyEval_SetProfile() but sets the profile function in all running threads belonging to the current
interpreterinsteadofthesettingitonlyonthecurrentthread.
Thecallermusthaveanattachedthreadstate.
AsPyEval_SetProfile(),thisfunctionignoresanyexceptionsraisedwhilesettingtheprofilefunctionsin
allthreads.
Addedinversion3.12.
voidPyEval_SetTrace(Py_tracefuncfunc,PyObject*obj)
Setthetracingfunctiontofunc. ThisissimilartoPyEval_SetProfile(),exceptthetracingfunctiondoes
receiveline-numbereventsandper-opcodeevents,butdoesnotreceiveanyeventrelatedtoCfunctionobjects
beingcalled. AnytracefunctionregisteredusingPyEval_SetTrace()willnotreceivePyTrace_C_CALL,
PyTrace_C_EXCEPTION orPyTrace_C_RETURN asavalueforthewhatparameter.
Seealsothesys.settrace()function.
Thecallermusthaveanattachedthreadstate.
voidPyEval_SetTraceAllThreads(Py_tracefuncfunc,PyObject*obj)
LikePyEval_SetTrace()butsetsthetracingfunctioninallrunningthreadsbelongingtothecurrentinter-
preterinsteadofthesettingitonlyonthecurrentthread.
Thecallermusthaveanattachedthreadstate.
AsPyEval_SetTrace(),thisfunctionignoresanyexceptionsraisedwhilesettingthetracefunctionsinall
threads.
Addedinversion3.12.
248 Chapter10. Initialization,Finalization,andThreads

### 第257页

10.9 Reference tracing
Addedinversion3.13.
typedefint(*PyRefTracer)(PyObject*,intevent,void*data)
ThetypeofthetracefunctionregisteredusingPyRefTracer_SetTracer(). ThefirstparameterisaPython
objectthathasbeenjustcreated(wheneventissettoPyRefTracer_CREATE)orabouttobedestroyed(when
eventissettoPyRefTracer_DESTROY).Thedataargumentistheopaquepointerthatwasprovidedwhen
PyRefTracer_SetTracer()wascalled.
Addedinversion3.13.
intPyRefTracer_CREATE
ThevaluefortheeventparametertoPyRefTracerfunctionswhenaPythonobjecthasbeencreated.
intPyRefTracer_DESTROY
ThevaluefortheeventparametertoPyRefTracerfunctionswhenaPythonobjecthasbeendestroyed.
intPyRefTracer_SetTracer(PyRefTracertracer,void*data)
Registerareferencetracerfunction. ThefunctionwillbecalledwhenanewPythonhasbeencreatedorwhen
anobjectisgoingtobedestroyed. Ifdataisprovideditmustbeanopaquepointerthatwillbeprovidedwhen
thetracerfunctioniscalled. Return0onsuccess. Setanexceptionandreturn-1onerror.
NotthattracerfunctionsmustnotcreatePythonobjectsinsideorotherwisethecallwillbere-entrant. The
traceralsomustnotclearanyexistingexceptionorsetanexception. Athreadstatewillbeactiveeverytime
thetracerfunctioniscalled.
Theremustbeanattachedthreadstatewhencallingthisfunction.
Addedinversion3.13.
PyRefTracerPyRefTracer_GetTracer(void**data)
Gettheregisteredreferencetracerfunctionandthevalueoftheopaquedatapointerthatwasregisteredwhen
PyRefTracer_SetTracer()wascalled. IfnotracerwasregisteredthisfunctionwillreturnNULLandwill
setthedatapointertoNULL.
Theremustbeanattachedthreadstatewhencallingthisfunction.
Addedinversion3.13.
10.10 Advanced Debugger Support
Thesefunctionsareonlyintendedtobeusedbyadvanceddebuggingtools.
PyInterpreterState*PyInterpreterState_Head()
Returntheinterpreterstateobjectattheheadofthelistofallsuchobjects.
PyInterpreterState*PyInterpreterState_Main()
Returnthemaininterpreterstateobject.
PyInterpreterState*PyInterpreterState_Next(PyInterpreterState*interp)
Returnthenextinterpreterstateobjectafterinterpfromthelistofallsuchobjects.
PyThreadState*PyInterpreterState_ThreadHead(PyInterpreterState*interp)
Return the pointer to the first PyThreadState object in the list of threads associated with the interpreter
interp.
PyThreadState*PyThreadState_Next(PyThreadState*tstate)
Return the next thread state object after tstate from the list of all such objects belonging to the same
PyInterpreterStateobject.
10.9. Referencetracing 249

### 第258页

10.11 Thread Local Storage Support
ThePythoninterpreterprovideslow-levelsupportforthread-localstorage(TLS)whichwrapstheunderlyingnative
TLSimplementationtosupportthePython-levelthreadlocalstorageAPI(threading.local). TheCPythonC
levelAPIsaresimilartothoseofferedbypthreadsandWindows: useathreadkeyandfunctionstoassociateavoid*
valueperthread.
Athreadstatedoesnotneedtobeattachedwhencallingthesefunctions;theysuppltheirownlocking.
Note that Python.h does not include the declaration of the TLS APIs, you need to include pythread.h to use
thread-localstorage.
(cid:174) Note
NoneoftheseAPIfunctionshandlememorymanagementonbehalfofthevoid*values. Youneedtoallocate
anddeallocatethemyourself. Ifthevoid*valueshappentobePyObject*,thesefunctionsdon’tdorefcount
operationsonthemeither.
10.11.1 Thread Specific Storage (TSS) API
TSSAPIisintroducedtosupersedetheuseoftheexistingTLSAPIwithintheCPythoninterpreter. ThisAPIuses
anewtypePy_tss_tinsteadofinttorepresentthreadkeys.
Addedinversion3.7.
(cid:181) Seealso
“ANewC-APIforThread-LocalStorageinCPython”(PEP539)
typePy_tss_t
Thisdatastructurerepresentsthestateofathreadkey,thedefinitionofwhichmaydependontheunderlying
TLSimplementation,andithasaninternalfieldrepresentingthekey’sinitializationstate. Therearenopublic
membersinthisstructure.
WhenPy_LIMITED_API isnotdefined,staticallocationofthistypebyPy_tss_NEEDS_INITisallowed.
Py_tss_NEEDS_INIT
This macro expands to the initializer for Py_tss_t variables. Note that this macro won’t be defined with
Py_LIMITED_API.
DynamicAllocation
Dynamic allocation of the Py_tss_t, required in extension modules built with Py_LIMITED_API, where static
allocationofthistypeisnotpossibleduetoitsimplementationbeingopaqueatbuildtime.
Py_tss_t*PyThread_tss_alloc()
Part of the Stable ABI since version 3.7. Return a value which is the same state as a value initialized with
Py_tss_NEEDS_INIT,orNULLinthecaseofdynamicallocationfailure.
voidPyThread_tss_free(Py_tss_t*key)
PartoftheStableABIsinceversion3.7. FreethegivenkeyallocatedbyPyThread_tss_alloc(),afterfirst
calling PyThread_tss_delete() to ensure any associated thread locals have been unassigned. This is a
no-opifthekeyargumentisNULL.
(cid:174) Note
Afreedkeybecomesadanglingpointer. YoushouldresetthekeytoNULL.
250 Chapter10. Initialization,Finalization,andThreads

| (cid:181) Seealso |
| --- |
| “ANewC-APIforThread-LocalStorageinCPython”(PEP539) |

### 第259页

Methods
The parameter key of these functions must not be NULL. Moreover, the behaviors of PyThread_tss_set()
and PyThread_tss_get() are undefined if the given Py_tss_t has not been initialized by
PyThread_tss_create().
intPyThread_tss_is_created(Py_tss_t*key)
PartoftheStableABIsinceversion3.7. Returnanon-zerovalueifthegivenPy_tss_thasbeeninitialized
byPyThread_tss_create().
intPyThread_tss_create(Py_tss_t*key)
Part of the Stable ABI since version 3.7. Return a zero value on successful initialization of a TSS key. The
behaviorisundefinedifthevaluepointedtobythekeyargumentisnotinitializedbyPy_tss_NEEDS_INIT.
Thisfunctioncanbecalledrepeatedlyonthesamekey–callingitonanalreadyinitializedkeyisano-opand
immediatelyreturnssuccess.
voidPyThread_tss_delete(Py_tss_t*key)
PartoftheStableABIsinceversion3.7. DestroyaTSSkeytoforgetthevaluesassociatedwiththekeyacross
allthreads, andchangethekey’sinitializationstatetouninitialized. Adestroyedkeyisabletobeinitialized
againbyPyThread_tss_create(). Thisfunctioncanbecalledrepeatedlyonthesamekey–callingiton
analreadydestroyedkeyisano-op.
intPyThread_tss_set(Py_tss_t*key,void*value)
PartoftheStableABIsinceversion3.7. Returnazerovaluetoindicatesuccessfullyassociatingavoid*value
withaTSSkeyinthecurrentthread. Eachthreadhasadistinctmappingofthekeytoavoid*value.
void*PyThread_tss_get(Py_tss_t*key)
Part of the Stable ABI since version 3.7. Return the void* value associated with a TSS key in the current
thread. ThisreturnsNULLifnovalueisassociatedwiththekeyinthecurrentthread.
10.11.2 Thread Local Storage (TLS) API
Deprecatedsinceversion3.7: ThisAPIissupersededbyThreadSpecificStorage(TSS)API.
(cid:174) Note
ThisversionoftheAPIdoesnotsupportplatformswherethenativeTLSkeyisdefinedinawaythatcannotbe
safelycasttoint. Onsuchplatforms,PyThread_create_key()willreturnimmediatelywithafailurestatus,
andtheotherTLSfunctionswillallbeno-opsonsuchplatforms.
Duetothecompatibilityproblemnotedabove,thisversionoftheAPIshouldnotbeusedinnewcode.
intPyThread_create_key()
PartoftheStableABI.
voidPyThread_delete_key(intkey)
PartoftheStableABI.
intPyThread_set_key_value(intkey,void*value)
PartoftheStableABI.
void*PyThread_get_key_value(intkey)
PartoftheStableABI.
voidPyThread_delete_key_value(intkey)
PartoftheStableABI.
voidPyThread_ReInitTLS()
PartoftheStableABI.
10.11. ThreadLocalStorageSupport 251

### 第260页

10.12 Synchronization Primitives
TheC-APIprovidesabasicmutualexclusionlock.
typePyMutex
A mutual exclusion lock. The PyMutex should be initialized to zero to represent the unlocked state. For
example:
PyMutex mutex = {0};
Instances of PyMutex should not be copied or moved. Both the contents and address of a PyMutex are
meaningful,anditmustremainatafixed,writablelocationinmemory.
(cid:174) Note
APyMutexcurrentlyoccupiesonebyte,butthesizeshouldbeconsideredunstable. Thesizemaychange
infuturePythonreleaseswithoutadeprecationperiod.
Addedinversion3.13.
voidPyMutex_Lock(PyMutex*m)
Lockmutexm. Ifanotherthreadhasalreadylockedit,thecallingthreadwillblockuntilthemutexisunlocked.
Whileblocked,thethreadwilltemporarilydetachthethreadstateifoneexists.
Addedinversion3.13.
voidPyMutex_Unlock(PyMutex*m)
Unlockmutexm. Themutexmustbelocked—otherwise,thefunctionwillissueafatalerror.
Addedinversion3.13.
intPyMutex_IsLocked(PyMutex*m)
Returnsnon-zeroifthemutexmiscurrentlylocked,zerootherwise.
(cid:174) Note
Thisfunctionisintendedforuseinassertionsanddebuggingonlyandshouldnotbeusedtomakeconcur-
rencycontroldecisions,asthelockstatemaychangeimmediatelyafterthecheck.
Addedinversion3.14.
10.12.1 Python Critical Section API
ThecriticalsectionAPIprovidesadeadlockavoidancelayerontopofper-objectlocksforfree-threadedCPython.
They are intended to replace reliance on the global interpreter lock, and are no-ops in versions of Python with the
globalinterpreterlock.
CriticalsectionsareintendedtobeusedforcustomtypesimplementedinC-APIextensions. Theyshouldgenerally
notbeusedwithbuilt-intypeslikelistanddictbecausetheirpublicC-APIsalreadyusecriticalsectionsinternally,
withthenotableexceptionofPyDict_Next(),whichrequirescriticalsectiontobeacquiredexternally.
Criticalsectionsavoiddeadlocksbyimplicitlysuspendingactivecriticalsections,hence,theydonotprovideexclusive
accesssuchasprovidedbytraditionallockslikePyMutex. Whenacriticalsectionisstarted,theper-objectlockfor
theobjectisacquired. IfthecodeexecutedinsidethecriticalsectioncallsC-APIfunctionsthenitcansuspendthe
criticalsectiontherebyreleasingtheper-objectlock, sootherthreadscanacquiretheper-objectlockforthesame
object.
Variants that accept PyMutex pointers rather than Python objects are also available. Use these variants to start a
criticalsectioninasituationwherethereisnoPyObject–forexample,whenworkingwithaCtypethatdoesnot
extendorwrapPyObjectbutstillneedstocallintotheCAPIinamannerthatmightleadtodeadlocks.
252 Chapter10. Initialization,Finalization,andThreads

### 第261页

ThefunctionsandstructsusedbythemacrosareexposedforcaseswhereCmacrosarenotavailable. Theyshould
onlybeusedasinthegivenmacroexpansions. Notethatthesizesandcontentsofthestructuresmaychangeinfuture
Pythonversions.
(cid:174) Note
OperationsthatneedtolocktwoobjectsatoncemustusePy_BEGIN_CRITICAL_SECTION2. Youcannot use
nestedcriticalsectionstolockmorethanoneobjectatonce,becausetheinnercriticalsectionmaysuspendthe
outercriticalsections. ThisAPIdoesnotprovideawaytolockmorethantwoobjectsatonce.
Exampleusage:
static PyObject *
set_field(MyObject *self, PyObject *value)
{
Py_BEGIN_CRITICAL_SECTION(self);
Py_SETREF(self->field, Py_XNewRef(value));
Py_END_CRITICAL_SECTION();
Py_RETURN_NONE;
}
In the above example, Py_SETREF calls Py_DECREF, which can call arbitrary code through an object’s dealloca-
tion function. The critical section API avoids potential deadlocks due to reentrancy and lock ordering by allow-
ing the runtime to temporarily suspend the critical section if the code triggered by the finalizer blocks and calls
PyEval_SaveThread().
Py_BEGIN_CRITICAL_SECTION(op)
Acquirestheper-objectlockfortheobjectopandbeginsacriticalsection.
Inthefree-threadedbuild,thismacroexpandsto:
{
PyCriticalSection _py_cs;
PyCriticalSection_Begin(&_py_cs, (PyObject*)(op))
Inthedefaultbuild,thismacroexpandsto{.
Addedinversion3.13.
Py_BEGIN_CRITICAL_SECTION_MUTEX(m)
Locksthemutexmandbeginsacriticalsection.
Inthefree-threadedbuild,thismacroexpandsto:
{
PyCriticalSection _py_cs;
PyCriticalSection_BeginMutex(&_py_cs, m)
NotethatunlikePy_BEGIN_CRITICAL_SECTION,thereisnocastfortheargumentofthemacro-itmust
beaPyMutexpointer.
Onthedefaultbuild,thismacroexpandsto{.
Addedinversion3.14.
Py_END_CRITICAL_SECTION()
Endsthecriticalsectionandreleasestheper-objectlock.
Inthefree-threadedbuild,thismacroexpandsto:
10.12. SynchronizationPrimitives 253

### 第262页

PyCriticalSection_End(&_py_cs);
}
Inthedefaultbuild,thismacroexpandsto}.
Addedinversion3.13.
Py_BEGIN_CRITICAL_SECTION2(a,b)
Acquirestheper-objectslocksfortheobjectsaandbandbeginsacriticalsection. Thelocksareacquiredin
aconsistentorder(lowestaddressfirst)toavoidlockorderingdeadlocks.
Inthefree-threadedbuild,thismacroexpandsto:
{
PyCriticalSection2 _py_cs2;
PyCriticalSection2_Begin(&_py_cs2, (PyObject*)(a), (PyObject*)(b))
Inthedefaultbuild,thismacroexpandsto{.
Addedinversion3.13.
Py_BEGIN_CRITICAL_SECTION2_MUTEX(m1,m2)
Locksthemutexesm1andm2andbeginsacriticalsection.
Inthefree-threadedbuild,thismacroexpandsto:
{
PyCriticalSection2 _py_cs2;
PyCriticalSection2_BeginMutex(&_py_cs2, m1, m2)
Note that unlike Py_BEGIN_CRITICAL_SECTION2, there is no cast for the arguments of the macro - they
mustbePyMutexpointers.
Onthedefaultbuild,thismacroexpandsto{.
Addedinversion3.14.
Py_END_CRITICAL_SECTION2()
Endsthecriticalsectionandreleasestheper-objectlocks.
Inthefree-threadedbuild,thismacroexpandsto:
PyCriticalSection2_End(&_py_cs2);
}
Inthedefaultbuild,thismacroexpandsto}.
Addedinversion3.13.
254 Chapter10. Initialization,Finalization,andThreads

### 第263页

CHAPTER
ELEVEN
PYTHON INITIALIZATION CONFIGURATION
11.1 PyInitConfig C API
Addedinversion3.14.
PythoncanbeinitializedwithPy_InitializeFromInitConfig().
ThePy_RunMain()functioncanbeusedtowriteacustomizedPythonprogram.
SeealsoInitialization,Finalization,andThreads.
(cid:181) Seealso
PEP741“PythonConfigurationCAPI”.
11.1.1 Example
ExampleofcustomizedPythonalwaysrunningwiththePythonDevelopmentModeenabled;return-1onerror:
int init_python(void)
{
PyInitConfig *config = PyInitConfig_Create();
if (config == NULL) {
printf("PYTHON INIT ERROR: memory allocation failed\n");
return -1;
}
// Enable the Python Development Mode
if (PyInitConfig_SetInt(config, "dev_mode", 1) < 0) {
goto error;
}
// Initialize Python with the configuration
if (Py_InitializeFromInitConfig(config) < 0) {
goto error;
}
PyInitConfig_Free(config);
return 0;
error:
{
// Display the error message.
//
// This uncommon braces style is used, because you cannot make
// goto targets point to variable declarations.
const char *err_msg;
(continuesonnextpage)
255

| (cid:181) Seealso |
| --- |
| PEP741“PythonConfigurationCAPI”. |

### 第264页

(continuedfrompreviouspage)
(void)PyInitConfig_GetError(config, &err_msg);
printf("PYTHON INIT ERROR: %s\n", err_msg);
PyInitConfig_Free(config);
return -1;
}
}
11.1.2 Create Config
structPyInitConfig
OpaquestructuretoconfigurethePythoninitialization.
PyInitConfig*PyInitConfig_Create(void)
CreateanewinitializationconfigurationusingIsolatedConfigurationdefaultvalues.
ItmustbefreedbyPyInitConfig_Free().
ReturnNULLonmemoryallocationfailure.
voidPyInitConfig_Free(PyInitConfig*config)
Freememoryoftheinitializationconfigurationconfig.
IfconfigisNULL,nooperationisperformed.
11.1.3 Error Handling
intPyInitConfig_GetError(PyInitConfig*config,constchar**err_msg)
Gettheconfigerrormessage.
• Set*err_msgandreturn1ifanerrorisset.
• Set*err_msgtoNULLandreturn0otherwise.
AnerrormessageisanUTF-8encodedstring.
Ifconfighasanexitcode,formattheexitcodeasanerrormessage.
TheerrormessageremainsvaliduntilanotherPyInitConfigfunctioniscalledwithconfig. Thecallerdoesn’t
havetofreetheerrormessage.
intPyInitConfig_GetExitCode(PyInitConfig*config,int*exitcode)
Gettheconfigexitcode.
• Set*exitcodeandreturn1ifconfighasanexitcodeset.
• Return0ifconfighasnoexitcodeset.
OnlythePy_InitializeFromInitConfig()functioncansetanexitcodeiftheparse_argvoptionis
non-zero.
Anexitcodecanbesetwhenparsingthecommandlinefailed(exitcode2)orwhenacommandlineoption
askstodisplaythecommandlinehelp(exitcode0).
11.1.4 Get Options
Theconfigurationoptionnameparametermustbeanon-NULLnull-terminatedUTF-8encodedstring. SeeConfig-
urationOptions.
intPyInitConfig_HasOption(PyInitConfig*config,constchar*name)
Testiftheconfigurationhasanoptioncalledname.
Return1iftheoptionexists,orreturn0otherwise.
256 Chapter11. PythonInitializationConfiguration

### 第265页

intPyInitConfig_GetInt(PyInitConfig*config,constchar*name,int64_t*value)
Getanintegerconfigurationoption.
• Set*value,andreturn0onsuccess.
• Setanerrorinconfigandreturn-1onerror.
intPyInitConfig_GetStr(PyInitConfig*config,constchar*name,char**value)
Getastringconfigurationoptionasanull-terminatedUTF-8encodedstring.
• Set*value,andreturn0onsuccess.
• Setanerrorinconfigandreturn-1onerror.
*valuecanbesettoNULLiftheoptionisanoptionalstringandtheoptionisunset.
Onsuccess,thestringmustbereleasedwithfree(value)ifit’snotNULL.
intPyInitConfig_GetStrList(PyInitConfig*config,constchar*name,size_t*length,char***items)
Getastringlistconfigurationoptionasanarrayofnull-terminatedUTF-8encodedstrings.
• Set*lengthand*value,andreturn0onsuccess.
• Setanerrorinconfigandreturn-1onerror.
Onsuccess,thestringlistmustbereleasedwithPyInitConfig_FreeStrList(length, items).
voidPyInitConfig_FreeStrList(size_tlength,char**items)
FreememoryofastringlistcreatedbyPyInitConfig_GetStrList().
11.1.5 Set Options
Theconfigurationoptionnameparametermustbeanon-NULLnull-terminatedUTF-8encodedstring. SeeConfig-
urationOptions.
Some configuration options have side effects on other options. This logic is only implemented when
Py_InitializeFromInitConfig()iscalled,notbythe“Set”functionsbelow. Forexample,settingdev_mode
to1doesnotsetfaulthandlerto1.
intPyInitConfig_SetInt(PyInitConfig*config,constchar*name,int64_tvalue)
Setanintegerconfigurationoption.
• Return0onsuccess.
• Setanerrorinconfigandreturn-1onerror.
intPyInitConfig_SetStr(PyInitConfig*config,constchar*name,constchar*value)
Setastringconfigurationoptionfromanull-terminatedUTF-8encodedstring. Thestringiscopied.
• Return0onsuccess.
• Setanerrorinconfigandreturn-1onerror.
intPyInitConfig_SetStrList(PyInitConfig*config,constchar*name,size_tlength,char*const*items)
Setastringlistconfigurationoptionfromanarrayofnull-terminatedUTF-8encodedstrings. Thestringlist
iscopied.
• Return0onsuccess.
• Setanerrorinconfigandreturn-1onerror.
11.1.6 Module
intPyInitConfig_AddModule(PyInitConfig*config,constchar*name,PyObject*(*initfunc)(void))
Addabuilt-inextensionmoduletothetableofbuilt-inmodules.
Thenewmodulecanbeimportedbythenamename,andusesthefunctioninitfuncastheinitializationfunction
calledonthefirstattemptedimport.
11.1. PyInitConfigCAPI 257

### 第266页

• Return0onsuccess.
• Setanerrorinconfigandreturn-1onerror.
IfPythonisinitializedmultipletimes,PyInitConfig_AddModule()mustbecalledateachPythoninitial-
ization.
SimilartothePyImport_AppendInittab()function.
11.1.7 Initialize Python
intPy_InitializeFromInitConfig(PyInitConfig*config)
InitializePythonfromtheinitializationconfiguration.
• Return0onsuccess.
• Setanerrorinconfigandreturn-1onerror.
• Setanexitcodeinconfigandreturn-1ifPythonwantstoexit.
SeePyInitConfig_GetExitcode()fortheexitcodecase.
11.2 Configuration Options
Option PyConfig/PyPreConfigmember Type Visibility
"allocator" allocator int Read-only
"argv" argv list[str] Public
"base_exec_prefix" base_exec_prefix str Public
"base_executable" base_executable str Public
"base_prefix" base_prefix str Public
"buffered_stdio" buffered_stdio bool Read-only
"bytes_warning" bytes_warning int Public
"check_hash_pycs_mode" check_hash_pycs_mode str Read-only
"code_debug_ranges" code_debug_ranges bool Read-only
"coerce_c_locale" coerce_c_locale bool Read-only
"coerce_c_locale_warn" coerce_c_locale_warn bool Read-only
"configure_c_stdio" configure_c_stdio bool Read-only
"configure_locale" configure_locale bool Read-only
"cpu_count" cpu_count int Public
"dev_mode" dev_mode bool Read-only
"dump_refs" dump_refs bool Read-only
"dump_refs_file" dump_refs_file str Read-only
"exec_prefix" exec_prefix str Public
"executable" executable str Public
"faulthandler" faulthandler bool Read-only
"filesystem_encoding" filesystem_encoding str Read-only
"filesystem_errors" filesystem_errors str Read-only
"hash_seed" hash_seed int Read-only
"home" home str Read-only
"import_time" import_time int Read-only
"inspect" inspect bool Public
"install_signal_handlers" install_signal_handlers bool Read-only
"int_max_str_digits" int_max_str_digits int Public
"interactive" interactive bool Public
"isolated" isolated bool Read-only
"legacy_windows_fs_encoding" legacy_windows_fs_encoding bool Read-only
"legacy_windows_stdio" legacy_windows_stdio bool Read-only
"malloc_stats" malloc_stats bool Read-only
continuesonnextpage
258 Chapter11. PythonInitializationConfiguration

| Option | PyConfig/PyPreConfigmember | Type | Visibility |
| --- | --- | --- | --- |
| "allocator" | allocator | int | Read-only |
| "argv" | argv | list[str] | Public |
| "base_exec_prefix" | base_exec_prefix | str | Public |
| "base_executable" | base_executable | str | Public |
| "base_prefix" | base_prefix | str | Public |
| "buffered_stdio" | buffered_stdio | bool | Read-only |
| "bytes_warning" | bytes_warning | int | Public |
| "check_hash_pycs_mode" | check_hash_pycs_mode | str | Read-only |
| "code_debug_ranges" | code_debug_ranges | bool | Read-only |
| "coerce_c_locale" | coerce_c_locale | bool | Read-only |
| "coerce_c_locale_warn" | coerce_c_locale_warn | bool | Read-only |
| "configure_c_stdio" | configure_c_stdio | bool | Read-only |
| "configure_locale" | configure_locale | bool | Read-only |
| "cpu_count" | cpu_count | int | Public |
| "dev_mode" | dev_mode | bool | Read-only |
| "dump_refs" | dump_refs | bool | Read-only |
| "dump_refs_file" | dump_refs_file | str | Read-only |
| "exec_prefix" | exec_prefix | str | Public |
| "executable" | executable | str | Public |
| "faulthandler" | faulthandler | bool | Read-only |
| "filesystem_encoding" | filesystem_encoding | str | Read-only |
| "filesystem_errors" | filesystem_errors | str | Read-only |
| "hash_seed" | hash_seed | int | Read-only |
| "home" | home | str | Read-only |
| "import_time" | import_time | int | Read-only |
| "inspect" | inspect | bool | Public |
| "install_signal_handlers" | install_signal_handlers | bool | Read-only |
| "int_max_str_digits" | int_max_str_digits | int | Public |
| "interactive" | interactive | bool | Public |
| "isolated" | isolated | bool | Read-only |
| "legacy_windows_fs_encoding" | legacy_windows_fs_encoding | bool | Read-only |
| "legacy_windows_stdio" | legacy_windows_stdio | bool | Read-only |
| "malloc_stats" | malloc_stats | bool | Read-only |

### 第267页

Table 1–continuedfrompreviouspage
Option PyConfig/PyPreConfigmember Type Visibility
"module_search_paths" module_search_paths list[str] Public
"optimization_level" optimization_level int Public
"orig_argv" orig_argv list[str] Read-only
"parse_argv" parse_argv bool Read-only
"parser_debug" parser_debug bool Public
"pathconfig_warnings" pathconfig_warnings bool Read-only
"perf_profiling" perf_profiling bool Read-only
"platlibdir" platlibdir str Public
"prefix" prefix str Public
"program_name" program_name str Read-only
"pycache_prefix" pycache_prefix str Public
"quiet" quiet bool Public
"run_command" run_command str Read-only
"run_filename" run_filename str Read-only
"run_module" run_module str Read-only
"run_presite" run_presite str Read-only
"safe_path" safe_path bool Read-only
"show_ref_count" show_ref_count bool Read-only
"site_import" site_import bool Read-only
"skip_source_first_line" skip_source_first_line bool Read-only
"stdio_encoding" stdio_encoding str Read-only
"stdio_errors" stdio_errors str Read-only
"stdlib_dir" stdlib_dir str Public
"tracemalloc" tracemalloc int Read-only
"use_environment" use_environment bool Public
"use_frozen_modules" use_frozen_modules bool Read-only
"use_hash_seed" use_hash_seed bool Read-only
"use_system_logger" use_system_logger bool Read-only
"user_site_directory" user_site_directory bool Read-only
"utf8_mode" utf8_mode bool Read-only
"verbose" verbose int Public
"warn_default_encoding" warn_default_encoding bool Read-only
"warnoptions" warnoptions list[str] Public
"write_bytecode" write_bytecode bool Public
"xoptions" xoptions dict[str, str] Public
"_pystats" _pystats bool Read-only
Visibility:
• Public: CanbygetbyPyConfig_Get()andsetbyPyConfig_Set().
• Read-only: CanbygetbyPyConfig_Get(),butcannotbesetbyPyConfig_Set().
11.3 Runtime Python configuration API
Atruntime,it’spossibletogetandsetconfigurationoptionsusingPyConfig_Get()andPyConfig_Set()func-
tions.
Theconfigurationoptionnameparametermustbeanon-NULLnull-terminatedUTF-8encodedstring. SeeConfig-
urationOptions.
Someoptionsarereadfromthesysattributes. Forexample,theoption"argv"isreadfromsys.argv.
PyObject*PyConfig_Get(constchar*name)
GetthecurrentruntimevalueofaconfigurationoptionasaPythonobject.
• Returnanewreferenceonsuccess.
11.3. RuntimePythonconfigurationAPI 259

| Option | PyConfig/PyPreConfigmember | Type | Visibility |
| --- | --- | --- | --- |
| "module_search_paths" | module_search_paths | list[str] | Public |
| "optimization_level" | optimization_level | int | Public |
| "orig_argv" | orig_argv | list[str] | Read-only |
| "parse_argv" | parse_argv | bool | Read-only |
| "parser_debug" | parser_debug | bool | Public |
| "pathconfig_warnings" | pathconfig_warnings | bool | Read-only |
| "perf_profiling" | perf_profiling | bool | Read-only |
| "platlibdir" | platlibdir | str | Public |
| "prefix" | prefix | str | Public |
| "program_name" | program_name | str | Read-only |
| "pycache_prefix" | pycache_prefix | str | Public |
| "quiet" | quiet | bool | Public |
| "run_command" | run_command | str | Read-only |
| "run_filename" | run_filename | str | Read-only |
| "run_module" | run_module | str | Read-only |
| "run_presite" | run_presite | str | Read-only |
| "safe_path" | safe_path | bool | Read-only |
| "show_ref_count" | show_ref_count | bool | Read-only |
| "site_import" | site_import | bool | Read-only |
| "skip_source_first_line" | skip_source_first_line | bool | Read-only |
| "stdio_encoding" | stdio_encoding | str | Read-only |
| "stdio_errors" | stdio_errors | str | Read-only |
| "stdlib_dir" | stdlib_dir | str | Public |
| "tracemalloc" | tracemalloc | int | Read-only |
| "use_environment" | use_environment | bool | Public |
| "use_frozen_modules" | use_frozen_modules | bool | Read-only |
| "use_hash_seed" | use_hash_seed | bool | Read-only |
| "use_system_logger" | use_system_logger | bool | Read-only |
| "user_site_directory" | user_site_directory | bool | Read-only |
| "utf8_mode" | utf8_mode | bool | Read-only |
| "verbose" | verbose | int | Public |
| "warn_default_encoding" | warn_default_encoding | bool | Read-only |
| "warnoptions" | warnoptions | list[str] | Public |
| "write_bytecode" | write_bytecode | bool | Public |
| "xoptions" | xoptions | dict[str, str] | Public |
| "_pystats" | _pystats | bool | Read-only |

### 第268页

• SetanexceptionandreturnNULLonerror.
Theobjecttypedependsontheconfigurationoption. Itcanbe:
• bool
• int
• str
• list[str]
• dict[str, str]
Thecallermusthaveanattachedthreadstate. ThefunctioncannotbecalledbeforePythoninitializationnor
afterPythonfinalization.
Addedinversion3.14.
intPyConfig_GetInt(constchar*name,int*value)
SimilartoPyConfig_Get(),butgetthevalueasaCint.
• Return0onsuccess.
• Setanexceptionandreturn-1onerror.
Addedinversion3.14.
PyObject*PyConfig_Names(void)
Getallconfigurationoptionnamesasafrozenset.
• Returnanewreferenceonsuccess.
• SetanexceptionandreturnNULLonerror.
Thecallermusthaveanattachedthreadstate. ThefunctioncannotbecalledbeforePythoninitializationnor
afterPythonfinalization.
Addedinversion3.14.
intPyConfig_Set(constchar*name,PyObject*value)
Setthecurrentruntimevalueofaconfigurationoption.
• RaiseaValueErrorifthereisnooptionname.
• RaiseaValueErrorifvalueisaninvalidvalue.
• RaiseaValueErroriftheoptionisread-only(cannotbeset).
• RaiseaTypeErrorifvaluehasnotthepropertype.
Thecallermusthaveanattachedthreadstate. ThefunctioncannotbecalledbeforePythoninitializationnor
afterPythonfinalization.
Raisesanauditingeventcpython.PyConfig_Setwithargumentsname,value.
Addedinversion3.14.
11.4 PyConfig C API
Addedinversion3.8.
PythoncanbeinitializedwithPy_InitializeFromConfig()andthePyConfigstructure. Itcanbepreinitialized
withPy_PreInitialize()andthePyPreConfigstructure.
Therearetwokindsofconfiguration:
• ThePythonConfigurationcanbeusedtobuildacustomizedPythonwhichbehavesastheregularPython. For
example,environmentvariablesandcommandlineargumentsareusedtoconfigurePython.
260 Chapter11. PythonInitializationConfiguration

### 第269页

• TheIsolatedConfigurationcanbeusedtoembedPythonintoanapplication. ItisolatesPythonfromthesystem.
Forexample,environmentvariablesareignored,theLC_CTYPElocaleisleftunchangedandnosignalhandler
isregistered.
ThePy_RunMain()functioncanbeusedtowriteacustomizedPythonprogram.
SeealsoInitialization,Finalization,andThreads.
(cid:181) Seealso
PEP587“PythonInitializationConfiguration”.
11.4.1 Example
ExampleofcustomizedPythonalwaysrunninginisolatedmode:
int main(int argc, char **argv)
{
PyStatus status;
PyConfig config;
PyConfig_InitPythonConfig(&config);
config.isolated = 1;
/* Decode command line arguments.
Implicitly preinitialize Python (in isolated mode). */
status = PyConfig_SetBytesArgv(&config, argc, argv);
if (PyStatus_Exception(status)) {
goto exception;
}
status = Py_InitializeFromConfig(&config);
if (PyStatus_Exception(status)) {
goto exception;
}
PyConfig_Clear(&config);
return Py_RunMain();
exception:
PyConfig_Clear(&config);
if (PyStatus_IsExit(status)) {
return status.exitcode;
}
/* Display the error message and exit the process with
non-zero exit code */
Py_ExitStatusException(status);
}
11.4.2 PyWideStringList
typePyWideStringList
Listofwchar_t*strings.
Iflengthisnon-zero,itemsmustbenon-NULLandallstringsmustbenon-NULL.
Methods:
11.4. PyConfigCAPI 261

| (cid:181) Seealso |
| --- |
| PEP587“PythonInitializationConfiguration”. |

### 第270页

PyStatusPyWideStringList_Append(PyWideStringList*list,constwchar_t*item)
Appenditemtolist.
Pythonmustbepreinitializedtocallthisfunction.
PyStatusPyWideStringList_Insert(PyWideStringList*list,Py_ssize_tindex,constwchar_t*item)
Insertitemintolistatindex.
Ifindexisgreaterthanorequaltolistlength,appenditemtolist.
indexmustbegreaterthanorequalto0.
Pythonmustbepreinitializedtocallthisfunction.
Structurefields:
Py_ssize_tlength
Listlength.
wchar_t**items
Listitems.
11.4.3 PyStatus
typePyStatus
Structuretostoreaninitializationfunctionstatus: success,errororexit.
Foranerror,itcanstoretheCfunctionnamewhichcreatedtheerror.
Structurefields:
intexitcode
Exitcode. Argumentpassedtoexit().
constchar*err_msg
Errormessage.
constchar*func
Nameofthefunctionwhichcreatedanerror,canbeNULL.
Functionstocreateastatus:
PyStatusPyStatus_Ok(void)
Success.
PyStatusPyStatus_Error(constchar*err_msg)
Initializationerrorwithamessage.
err_msgmustnotbeNULL.
PyStatusPyStatus_NoMemory(void)
Memoryallocationfailure(outofmemory).
PyStatusPyStatus_Exit(intexitcode)
ExitPythonwiththespecifiedexitcode.
Functionstohandleastatus:
intPyStatus_Exception(PyStatusstatus)
Is the status an error or an exit? If true, the exception must be handled; by calling
Py_ExitStatusException()forexample.
intPyStatus_IsError(PyStatusstatus)
Istheresultanerror?
262 Chapter11. PythonInitializationConfiguration

### 第271页

intPyStatus_IsExit(PyStatusstatus)
Istheresultanexit?
voidPy_ExitStatusException(PyStatusstatus)
Callexit(exitcode)ifstatusisanexit. Printtheerrormessageandexitwithanon-zeroexitcodeif
statusisanerror. MustonlybecalledifPyStatus_Exception(status)isnon-zero.
(cid:174) Note
Internally, Python uses macros which set PyStatus.func, whereas functions to create a status set func to
NULL.
Example:
PyStatus alloc(void **ptr, size_t size)
{
*ptr = PyMem_RawMalloc(size);
if (*ptr == NULL) {
return PyStatus_NoMemory();
}
return PyStatus_Ok();
}
int main(int argc, char **argv)
{
void *ptr;
PyStatus status = alloc(&ptr, 16);
if (PyStatus_Exception(status)) {
Py_ExitStatusException(status);
}
PyMem_Free(ptr);
return 0;
}
11.4.4 PyPreConfig
typePyPreConfig
StructureusedtopreinitializePython.
Functiontoinitializeapreconfiguration:
voidPyPreConfig_InitPythonConfig(PyPreConfig*preconfig)
InitializethepreconfigurationwithPythonConfiguration.
voidPyPreConfig_InitIsolatedConfig(PyPreConfig*preconfig)
InitializethepreconfigurationwithIsolatedConfiguration.
Structurefields:
intallocator
NameofthePythonmemoryallocators:
• PYMEM_ALLOCATOR_NOT_SET(0): don’tchangememoryallocators(usedefaults).
• PYMEM_ALLOCATOR_DEFAULT(1): defaultmemoryallocators.
• PYMEM_ALLOCATOR_DEBUG(2): defaultmemoryallocatorswithdebughooks.
• PYMEM_ALLOCATOR_MALLOC(3): usemalloc()oftheClibrary.
• PYMEM_ALLOCATOR_MALLOC_DEBUG(4): forceusageofmalloc()withdebughooks.
11.4. PyConfigCAPI 263

### 第272页

• PYMEM_ALLOCATOR_PYMALLOC(5): Pythonpymallocmemoryallocator.
• PYMEM_ALLOCATOR_PYMALLOC_DEBUG(6): Pythonpymallocmemoryallocatorwithdebughooks.
• PYMEM_ALLOCATOR_MIMALLOC(6): usemimalloc,afastmallocreplacement.
• PYMEM_ALLOCATOR_MIMALLOC_DEBUG(7): usemimalloc,afastmallocreplacementwithdebug
hooks.
PYMEM_ALLOCATOR_PYMALLOC and PYMEM_ALLOCATOR_PYMALLOC_DEBUG are not supported if
Pythonisconfigured using --without-pymalloc.
PYMEM_ALLOCATOR_MIMALLOC and PYMEM_ALLOCATOR_MIMALLOC_DEBUG are not supported if
Pythonisconfigured using --without-mimallocoriftheunderlyingatomicsupportisn’tavail-
able.
SeeMemoryManagement.
Default: PYMEM_ALLOCATOR_NOT_SET.
intconfigure_locale
SettheLC_CTYPElocaletotheuserpreferredlocale.
Ifequalsto0,setcoerce_c_localeandcoerce_c_locale_warnmembersto0.
Seethelocaleencoding.
Default: 1inPythonconfig,0inisolatedconfig.
intcoerce_c_locale
Ifequalsto2,coercetheClocale.
Ifequalsto1,readtheLC_CTYPElocaletodecideifitshouldbecoerced.
Seethelocaleencoding.
Default: -1inPythonconfig,0inisolatedconfig.
intcoerce_c_locale_warn
Ifnon-zero,emitawarningiftheClocaleiscoerced.
Default: -1inPythonconfig,0inisolatedconfig.
intdev_mode
PythonDevelopmentMode: seePyConfig.dev_mode.
Default: -1inPythonmode,0inisolatedmode.
intisolated
Isolatedmode: seePyConfig.isolated.
Default: 0inPythonmode,1inisolatedmode.
intlegacy_windows_fs_encoding
Ifnon-zero:
• SetPyPreConfig.utf8_modeto0,
• SetPyConfig.filesystem_encodingto"mbcs",
• SetPyConfig.filesystem_errorsto"replace".
InitializedfromthePYTHONLEGACYWINDOWSFSENCODINGenvironmentvariablevalue.
OnlyavailableonWindows. #ifdef MS_WINDOWSmacrocanbeusedforWindowsspecificcode.
Default: 0.
264 Chapter11. PythonInitializationConfiguration

### 第273页

intparse_argv
If non-zero, Py_PreInitializeFromArgs() and Py_PreInitializeFromBytesArgs() parse
theirargvargumentthesamewaytheregularPythonparsescommandlinearguments: seeCommand
LineArguments.
Default: 1inPythonconfig,0inisolatedconfig.
intuse_environment
Useenvironmentvariables? SeePyConfig.use_environment.
Default: 1inPythonconfigand0inisolatedconfig.
intutf8_mode
Ifnon-zero,enablethePythonUTF-8Mode.
Setto0or1bythe-X utf8commandlineoptionandthePYTHONUTF8environmentvariable.
Alsosetto1iftheLC_CTYPElocaleisCorPOSIX.
Default: -1inPythonconfigand0inisolatedconfig.
11.4.5 Preinitialize Python with PyPreConfig
ThepreinitializationofPython:
• SetthePythonmemoryallocators(PyPreConfig.allocator)
• ConfiguretheLC_CTYPElocale(localeencoding)
• SetthePythonUTF-8Mode(PyPreConfig.utf8_mode)
Thecurrentpreconfiguration(PyPreConfigtype)isstoredin_PyRuntime.preconfig.
FunctionstopreinitializePython:
PyStatusPy_PreInitialize(constPyPreConfig*preconfig)
PreinitializePythonfrompreconfigpreconfiguration.
preconfigmustnotbeNULL.
PyStatusPy_PreInitializeFromBytesArgs(constPyPreConfig*preconfig,intargc,char*const*argv)
PreinitializePythonfrompreconfigpreconfiguration.
Parseargvcommandlinearguments(bytesstrings)ifparse_argvofpreconfigisnon-zero.
preconfigmustnotbeNULL.
PyStatusPy_PreInitializeFromArgs(constPyPreConfig*preconfig,intargc,wchar_t*const*argv)
PreinitializePythonfrompreconfigpreconfiguration.
Parseargvcommandlinearguments(widestrings)ifparse_argvofpreconfigisnon-zero.
preconfigmustnotbeNULL.
The caller is responsible to handle exceptions (error or exit) using PyStatus_Exception() and
Py_ExitStatusException().
For Python Configuration (PyPreConfig_InitPythonConfig()), if Python is initialized with command line
arguments,thecommandlineargumentsmustalsobepassedtopreinitializePython,sincetheyhaveaneffectonthe
pre-configurationlikeencodings. Forexample,the-X utf8commandlineoptionenablesthePythonUTF-8Mode.
PyMem_SetAllocator() can be called after Py_PreInitialize() and before
Py_InitializeFromConfig() to install a custom memory allocator. It can be called before
Py_PreInitialize()ifPyPreConfig.allocatorissettoPYMEM_ALLOCATOR_NOT_SET.
PythonmemoryallocationfunctionslikePyMem_RawMalloc()mustnotbeusedbeforethePythonpreinitialization,
whereas calling directly malloc() and free() is always safe. Py_DecodeLocale() must not be called before
thePythonpreinitialization.
ExampleusingthepreinitializationtoenablethePythonUTF-8Mode:
11.4. PyConfigCAPI 265

### 第274页

PyStatus status;
PyPreConfig preconfig;
PyPreConfig_InitPythonConfig(&preconfig);
preconfig.utf8_mode = 1;
status = Py_PreInitialize(&preconfig);
if (PyStatus_Exception(status)) {
Py_ExitStatusException(status);
}
/* at this point, Python speaks UTF-8 */
Py_Initialize();
/* ... use Python API here ... */
Py_Finalize();
11.4.6 PyConfig
typePyConfig
StructurecontainingmostparameterstoconfigurePython.
Whendone,thePyConfig_Clear()functionmustbeusedtoreleasetheconfigurationmemory.
Structuremethods:
voidPyConfig_InitPythonConfig(PyConfig*config)
InitializeconfigurationwiththePythonConfiguration.
voidPyConfig_InitIsolatedConfig(PyConfig*config)
InitializeconfigurationwiththeIsolatedConfiguration.
PyStatusPyConfig_SetString(PyConfig*config,wchar_t*const*config_str,constwchar_t*str)
Copythewidecharacterstringstrinto*config_str.
PreinitializePythonifneeded.
PyStatusPyConfig_SetBytesString(PyConfig*config,wchar_t*const*config_str,constchar*str)
DecodestrusingPy_DecodeLocale()andsettheresultinto*config_str.
PreinitializePythonifneeded.
PyStatusPyConfig_SetArgv(PyConfig*config,intargc,wchar_t*const*argv)
Setcommandlinearguments(argvmemberofconfig)fromtheargvlistofwidecharacterstrings.
PreinitializePythonifneeded.
PyStatusPyConfig_SetBytesArgv(PyConfig*config,intargc,char*const*argv)
Setcommandlinearguments(argvmemberofconfig)fromtheargvlistofbytesstrings. Decodebytes
usingPy_DecodeLocale().
PreinitializePythonifneeded.
PyStatusPyConfig_SetWideStringList(PyConfig*config,PyWideStringList*list,Py_ssize_tlength,
wchar_t**items)
Setthelistofwidestringslisttolengthanditems.
PreinitializePythonifneeded.
PyStatusPyConfig_Read(PyConfig*config)
ReadallPythonconfiguration.
Fieldswhicharealreadyinitializedareleftunchanged.
266 Chapter11. PythonInitializationConfiguration

### 第275页

Fieldsforpathconfigurationarenolongercalculatedormodifiedwhencallingthisfunction,asofPython
3.11.
The PyConfig_Read() function only parses PyConfig.argv arguments once: PyConfig.
parse_argv is set to 2 after arguments are parsed. Since Python arguments are stripped from
PyConfig.argv,parsingargumentstwicewouldparsetheapplicationoptionsasPythonoptions.
PreinitializePythonifneeded.
Changed in version 3.10: The PyConfig.argv arguments are now only parsed once, PyConfig.
parse_argv is set to 2 after arguments are parsed, and arguments are only parsed if PyConfig.
parse_argvequals1.
Changedinversion3.11: PyConfig_Read()nolongercalculatesallpaths, andsofieldslistedunder
PythonPathConfigurationmaynolongerbeupdateduntilPy_InitializeFromConfig()iscalled.
voidPyConfig_Clear(PyConfig*config)
Releaseconfigurationmemory.
MostPyConfigmethodspreinitializePythonifneeded. Inthatcase,thePythonpreinitializationconfiguration
(PyPreConfig)inbasedonthePyConfig. IfconfigurationfieldswhichareincommonwithPyPreConfig
aretuned,theymustbesetbeforecallingaPyConfigmethod:
• PyConfig.dev_mode
• PyConfig.isolated
• PyConfig.parse_argv
• PyConfig.use_environment
Moreover,ifPyConfig_SetArgv()orPyConfig_SetBytesArgv()isused,thismethodmustbecalled
before other methods, since the preinitialization configuration depends on command line arguments (if
parse_argvisnon-zero).
Thecallerofthesemethodsisresponsibletohandleexceptions(errororexit)usingPyStatus_Exception()
andPy_ExitStatusException().
Structurefields:
PyWideStringListargv
Setsys.argvcommandlineargumentsbasedonargv. Theseparametersaresimilartothosepassed
totheprogram’smain()functionwiththedifferencethatthefirstentryshouldrefertothescriptfileto
beexecutedratherthantheexecutablehostingthePythoninterpreter. Ifthereisn’tascriptthatwillbe
run,thefirstentryinargvcanbeanemptystring.
Set parse_argv to 1 to parse argv the same way the regular Python parses Python command line
argumentsandthentostripPythonargumentsfromargv.
Ifargvisempty,anemptystringisaddedtoensurethatsys.argvalwaysexistsandisneverempty.
Default: NULL.
Seealsotheorig_argvmember.
intsafe_path
Ifequalstozero,Py_RunMain()prependsapotentiallyunsafepathtosys.pathatstartup:
• Ifargv[0]isequaltoL"-m"(python -m module),prependthecurrentworkingdirectory.
• If running a script (python script.py), prepend the script’s directory. If it’s a symbolic link,
resolvesymboliclinks.
• Otherwise (python -c code and python), prepend an empty string, which means the current
workingdirectory.
Setto1bythe-PcommandlineoptionandthePYTHONSAFEPATHenvironmentvariable.
Default: 0inPythonconfig,1inisolatedconfig.
11.4. PyConfigCAPI 267

### 第276页

Addedinversion3.11.
wchar_t*base_exec_prefix
sys.base_exec_prefix.
Default: NULL.
PartofthePythonPathConfigurationoutput.
SeealsoPyConfig.exec_prefix.
wchar_t*base_executable
Pythonbaseexecutable: sys._base_executable.
Setbythe__PYVENV_LAUNCHER__environmentvariable.
SetfromPyConfig.executableifNULL.
Default: NULL.
PartofthePythonPathConfigurationoutput.
SeealsoPyConfig.executable.
wchar_t*base_prefix
sys.base_prefix.
Default: NULL.
PartofthePythonPathConfigurationoutput.
SeealsoPyConfig.prefix.
intbuffered_stdio
If equals to 0 and configure_c_stdio is non-zero, disable buffering on the C streams stdout and
stderr.
Setto0bythe-ucommandlineoptionandthePYTHONUNBUFFEREDenvironmentvariable.
stdinisalwaysopenedinbufferedmode.
Default: 1.
intbytes_warning
Ifequalsto1,issueawarningwhencomparingbytesorbytearraywithstr,orcomparingbytes
withint.
Ifequalorgreaterto2,raiseaBytesWarningexceptioninthesecases.
Incrementedbythe-bcommandlineoption.
Default: 0.
intwarn_default_encoding
Ifnon-zero,emitaEncodingWarningwarningwhenio.TextIOWrapperusesitsdefaultencoding.
Seeio-encoding-warningfordetails.
Default: 0.
Addedinversion3.10.
intcode_debug_ranges
Ifequalsto0,disablestheinclusionoftheendlineandcolumnmappingsincodeobjects. Alsodisables
tracebackprintingcaretstospecificerrorlocations.
Setto0bythePYTHONNODEBUGRANGESenvironmentvariableandbythe-X no_debug_rangescom-
mandlineoption.
Default: 1.
Addedinversion3.11.
268 Chapter11. PythonInitializationConfiguration

### 第277页

wchar_t*check_hash_pycs_mode
Controlthevalidationbehaviorofhash-based.pycfiles: valueofthe--check-hash-based-pycs
commandlineoption.
Validvalues:
• L"always": Hashthesourcefileforinvalidationregardlessofvalueofthe‘check_source’flag.
• L"never": Assumethathash-basedpycsalwaysarevalid.
• L"default": The‘check_source’flaginhash-basedpycsdeterminesinvalidation.
Default: L"default".
SeealsoPEP552“Deterministicpycs”.
intconfigure_c_stdio
Ifnon-zero,configureCstandardstreams:
• OnWindows,setthebinarymode(O_BINARY)onstdin,stdoutandstderr.
• Ifbuffered_stdioequalszero,disablebufferingofstdin,stdoutandstderrstreams.
• Ifinteractiveisnon-zero,enablestreambufferingonstdinandstdout(onlystdoutonWindows).
Default: 1inPythonconfig,0inisolatedconfig.
intdev_mode
Ifnon-zero,enablethePythonDevelopmentMode.
Setto1bythe-X devoptionandthePYTHONDEVMODEenvironmentvariable.
Default: -1inPythonmode,0inisolatedmode.
intdump_refs
DumpPythonreferences?
Ifnon-zero,dumpallobjectswhicharestillaliveatexit.
Setto1bythePYTHONDUMPREFSenvironmentvariable.
Needs a special build of Python with the Py_TRACE_REFS macro defined: see the configure
--with-trace-refs option.
Default: 0.
wchar_t*dump_refs_file
FilenamewheretodumpPythonreferences.
SetbythePYTHONDUMPREFSFILEenvironmentvariable.
Default: NULL.
Addedinversion3.11.
wchar_t*exec_prefix
The site-specific directory prefix where the platform-dependent Python files are installed: sys.
exec_prefix.
Default: NULL.
PartofthePythonPathConfigurationoutput.
SeealsoPyConfig.base_exec_prefix.
wchar_t*executable
TheabsolutepathoftheexecutablebinaryforthePythoninterpreter: sys.executable.
Default: NULL.
PartofthePythonPathConfigurationoutput.
11.4. PyConfigCAPI 269

### 第278页

SeealsoPyConfig.base_executable.
intfaulthandler
Enablefaulthandler?
Ifnon-zero,callfaulthandler.enable()atstartup.
Setto1by-X faulthandlerandthePYTHONFAULTHANDLERenvironmentvariable.
Default: -1inPythonmode,0inisolatedmode.
wchar_t*filesystem_encoding
Filesystemencoding: sys.getfilesystemencoding().
OnmacOS,AndroidandVxWorks: use"utf-8"bydefault.
On Windows: use "utf-8" by default, or "mbcs" if legacy_windows_fs_encoding of
PyPreConfigisnon-zero.
Defaultencodingonotherplatforms:
• "utf-8"ifPyPreConfig.utf8_modeisnon-zero.
• "ascii" if Python detects that nl_langinfo(CODESET) announces the ASCII encoding,
whereasthembstowcs()functiondecodesfromadifferentencoding(usuallyLatin1).
• "utf-8"ifnl_langinfo(CODESET)returnsanemptystring.
• Otherwise,usethelocaleencoding: nl_langinfo(CODESET)result.
AtPythonstartup,theencodingnameisnormalizedtothePythoncodecname. Forexample,"ANSI_X3.
4-1968"isreplacedwith"ascii".
Seealsothefilesystem_errorsmember.
wchar_t*filesystem_errors
Filesystemerrorhandler: sys.getfilesystemencodeerrors().
OnWindows:use"surrogatepass"bydefault,or"replace"iflegacy_windows_fs_encoding
ofPyPreConfigisnon-zero.
Onotherplatforms: use"surrogateescape"bydefault.
Supportederrorhandlers:
• "strict"
• "surrogateescape"
• "surrogatepass"(onlysupportedwiththeUTF-8encoding)
Seealsothefilesystem_encodingmember.
intuse_frozen_modules
Ifnon-zero,usefrozenmodules.
SetbythePYTHON_FROZEN_MODULESenvironmentvariable.
Default: 1inareleasebuild,or0inadebugbuild.
unsignedlonghash_seed
intuse_hash_seed
Randomizedhashfunctionseed.
Ifuse_hash_seediszero,aseedischosenrandomlyatPythonstartup,andhash_seedisignored.
SetbythePYTHONHASHSEEDenvironmentvariable.
Defaultuse_hash_seedvalue: -1inPythonmode,0inisolatedmode.
270 Chapter11. PythonInitializationConfiguration

### 第279页

wchar_t*home
Set the default Python “home” directory, that is, the location of the standard Python libraries (see
PYTHONHOME).
SetbythePYTHONHOMEenvironmentvariable.
Default: NULL.
PartofthePythonPathConfigurationinput.
intimport_time
If1,profileimporttime. If2,includeadditionaloutputthatindicateswhenanimportedmodule
hasalreadybeenloaded.
Setbythe-X importtimeoptionandthePYTHONPROFILEIMPORTTIMEenvironmentvari-
able.
Default: 0.
Changedinversion3.14: Addedsupportforimport_time = 2
intinspect
Enterinteractivemodeafterexecutingascriptoracommand.
Ifgreaterthan0,enableinspect: whenascriptispassedasfirstargumentorthe-coptionisused,enter
interactivemodeafterexecutingthescriptorthecommand,evenwhensys.stdindoesnotappearto
beaterminal.
Incrementedbythe-icommandlineoption. Setto1ifthePYTHONINSPECTenvironmentvariableis
non-empty.
Default: 0.
intinstall_signal_handlers
InstallPythonsignalhandlers?
Default: 1inPythonmode,0inisolatedmode.
intinteractive
Ifgreaterthan0,enabletheinteractivemode(REPL).
Incrementedbythe-icommandlineoption.
Default: 0.
intint_max_str_digits
Configures the integer string conversion length limitation. An initial value of -1 means the value
will be taken from the command line or environment or otherwise default to 4300 (sys.int_info.
default_max_str_digits). Avalueof0disablesthelimitation. Valuesgreaterthanzerobutless
than 640 (sys.int_info.str_digits_check_threshold) are unsupported and will produce an
error.
Configuredbythe-X int_max_str_digitscommandlineflagorthePYTHONINTMAXSTRDIGITS
environmentvariable.
Default: -1inPythonmode. 4300(sys.int_info.default_max_str_digits)inisolatedmode.
Addedinversion3.12.
intcpu_count
Ifthevalueofcpu_countisnot-1thenitwilloverridethereturnvaluesofos.cpu_count(),os.
process_cpu_count(),andmultiprocessing.cpu_count().
Configuredbythe-X cpu_count=n|defaultcommandlineflagorthePYTHON_CPU_COUNTenvi-
ronmentvariable.
Default: -1.
11.4. PyConfigCAPI 271

### 第280页

Addedinversion3.13.
intisolated
Ifgreaterthan0,enableisolatedmode:
• Setsafe_pathto1: don’tprependapotentiallyunsafepathtosys.pathatPythonstartup,such
asthecurrentdirectory,thescript’sdirectoryoranemptystring.
• Setuse_environmentto0: ignorePYTHONenvironmentvariables.
• Setuser_site_directoryto0: don’taddtheusersitedirectorytosys.path.
• Python REPL doesn’t import readline nor enable default readline configuration on interactive
prompts.
Setto1bythe-Icommandlineoption.
Default: 0inPythonmode,1inisolatedmode.
SeealsotheIsolatedConfigurationandPyPreConfig.isolated.
intlegacy_windows_stdio
Ifnon-zero,useio.FileIOinsteadofio._WindowsConsoleIOforsys.stdin,sys.stdoutand
sys.stderr.
Setto1ifthePYTHONLEGACYWINDOWSSTDIOenvironmentvariableissettoanon-emptystring.
OnlyavailableonWindows. #ifdef MS_WINDOWSmacrocanbeusedforWindowsspecificcode.
Default: 0.
SeealsothePEP528(ChangeWindowsconsoleencodingtoUTF-8).
intmalloc_stats
Ifnon-zero,dumpstatisticsonPythonpymallocmemoryallocatoratexit.
Setto1bythePYTHONMALLOCSTATSenvironmentvariable.
TheoptionisignoredifPythonisconfigured using the --without-pymalloc option.
Default: 0.
wchar_t*platlibdir
Platformlibrarydirectoryname: sys.platlibdir.
SetbythePYTHONPLATLIBDIRenvironmentvariable.
Default: value of the PLATLIBDIR macro which is set by the configure --with-platlibdir
option(default: "lib",or"DLLs"onWindows).
PartofthePythonPathConfigurationinput.
Addedinversion3.9.
Changedinversion3.11: ThismacroisnowusedonWindowstolocatethestandardlibraryextension
modules,typicallyunderDLLs. However,forcompatibility,notethatthisvalueisignoredforanynon-
standardlayouts,includingin-treebuildsandvirtualenvironments.
wchar_t*pythonpath_env
Modulesearchpaths(sys.path)asastringseparatedbyDELIM(os.pathsep).
SetbythePYTHONPATHenvironmentvariable.
Default: NULL.
PartofthePythonPathConfigurationinput.
PyWideStringListmodule_search_paths
272 Chapter11. PythonInitializationConfiguration

### 第281页

intmodule_search_paths_set
Modulesearchpaths: sys.path.
If module_search_paths_set is equal to 0, Py_InitializeFromConfig() will replace
module_search_pathsandsetsmodule_search_paths_setto1.
Default: emptylist(module_search_paths)and0(module_search_paths_set).
PartofthePythonPathConfigurationoutput.
intoptimization_level
Compilationoptimizationlevel:
• 0: Peepholeoptimizer,set__debug__toTrue.
• 1: Level0,removeassertions,set__debug__toFalse.
• 2: Level1,stripdocstrings.
Incrementedbythe-Ocommandlineoption. SettothePYTHONOPTIMIZEenvironmentvariablevalue.
Default: 0.
PyWideStringListorig_argv
ThelistoftheoriginalcommandlineargumentspassedtothePythonexecutable: sys.orig_argv.
Iforig_argvlistisemptyandargvisnotalistonlycontaininganemptystring,PyConfig_Read()
copiesargvintoorig_argvbeforemodifyingargv(ifparse_argvisnon-zero).
SeealsotheargvmemberandthePy_GetArgcArgv()function.
Default: emptylist.
Addedinversion3.10.
intparse_argv
Parsecommandlinearguments?
Ifequalsto1,parseargv thesamewaytheregularPythonparsescommandlinearguments,andstrip
Pythonargumentsfromargv.
The PyConfig_Read() function only parses PyConfig.argv arguments once: PyConfig.
parse_argv is set to 2 after arguments are parsed. Since Python arguments are stripped from
PyConfig.argv,parsingargumentstwicewouldparsetheapplicationoptionsasPythonoptions.
Default: 1inPythonmode,0inisolatedmode.
Changed in version 3.10: The PyConfig.argv arguments are now only parsed if PyConfig.
parse_argvequalsto1.
intparser_debug
Parserdebugmode. Ifgreaterthan0, turnonparserdebuggingoutput(forexpertonly, dependingon
compilationoptions).
Incrementedbythe-dcommandlineoption. SettothePYTHONDEBUGenvironmentvariablevalue.
NeedsadebugbuildofPython(thePy_DEBUGmacromustbedefined).
Default: 0.
intpathconfig_warnings
If non-zero, calculation of path configuration is allowed to log warnings into stderr. If equals to 0,
suppressthesewarnings.
Default: 1inPythonmode,0inisolatedmode.
PartofthePythonPathConfigurationinput.
Changedinversion3.11: NowalsoappliesonWindows.
11.4. PyConfigCAPI 273

### 第282页

wchar_t*prefix
The site-specific directory prefix where the platform independent Python files are installed: sys.
prefix.
Default: NULL.
PartofthePythonPathConfigurationoutput.
SeealsoPyConfig.base_prefix.
wchar_t*program_name
ProgramnameusedtoinitializeexecutableandinearlyerrormessagesduringPythoninitialization.
• OnmacOS,usePYTHONEXECUTABLEenvironmentvariableifset.
• IftheWITH_NEXT_FRAMEWORKmacroisdefined,use__PYVENV_LAUNCHER__environmentvari-
ableifset.
• Useargv[0]ofargvifavailableandnon-empty.
• Otherwise,useL"python"onWindows,orL"python3"onotherplatforms.
Default: NULL.
PartofthePythonPathConfigurationinput.
wchar_t*pycache_prefix
Directorywherecached.pycfilesarewritten: sys.pycache_prefix.
Setbythe-X pycache_prefix=PATHcommandlineoptionandthePYTHONPYCACHEPREFIXenvi-
ronmentvariable. Thecommand-lineoptiontakesprecedence.
IfNULL,sys.pycache_prefixissettoNone.
Default: NULL.
intquiet
Quiet mode. If greater than 0, don’t display the copyright and version at Python startup in interactive
mode.
Incrementedbythe-qcommandlineoption.
Default: 0.
wchar_t*run_command
Valueofthe-ccommandlineoption.
UsedbyPy_RunMain().
Default: NULL.
wchar_t*run_filename
Filenamepassedonthecommandline: trailingcommandlineargumentwithout-cor-m. Itisusedby
thePy_RunMain()function.
Forexample,itissettoscript.pybythepython3 script.py argcommandline.
SeealsothePyConfig.skip_source_first_lineoption.
Default: NULL.
wchar_t*run_module
Valueofthe-mcommandlineoption.
UsedbyPy_RunMain().
Default: NULL.
274 Chapter11. PythonInitializationConfiguration

### 第283页

wchar_t*run_presite
package.modulepathtomodulethatshouldbeimportedbeforesite.pyisrun.
Setbythe-X presite=package.modulecommand-lineoptionandthePYTHON_PRESITEenviron-
mentvariable. Thecommand-lineoptiontakesprecedence.
NeedsadebugbuildofPython(thePy_DEBUGmacromustbedefined).
Default: NULL.
intshow_ref_count
Showtotalreferencecountatexit(excludingimmortalobjects)?
Setto1by-X showrefcountcommandlineoption.
NeedsadebugbuildofPython(thePy_REF_DEBUGmacromustbedefined).
Default: 0.
intsite_import
Importthesitemoduleatstartup?
Ifequaltozero,disabletheimportofthemodulesiteandthesite-dependentmanipulationsofsys.path
thatitentails.
Alsodisablethesemanipulationsifthesitemoduleisexplicitlyimportedlater(callsite.main()if
youwantthemtobetriggered).
Setto0bythe-Scommandlineoption.
sys.flags.no_siteissettotheinvertedvalueofsite_import.
Default: 1.
intskip_source_first_line
Ifnon-zero,skipthefirstlineofthePyConfig.run_filenamesource.
Itallowstheusageofnon-Unixformsof#!cmd. ThisisintendedforaDOSspecifichackonly.
Setto1bythe-xcommandlineoption.
Default: 0.
wchar_t*stdio_encoding
wchar_t*stdio_errors
Encoding and encoding errors of sys.stdin, sys.stdout and sys.stderr (but sys.stderr al-
waysuses"backslashreplace"errorhandler).
UsethePYTHONIOENCODINGenvironmentvariableifitisnon-empty.
Defaultencoding:
• "UTF-8"ifPyPreConfig.utf8_modeisnon-zero.
• Otherwise,usethelocaleencoding.
Defaulterrorhandler:
• OnWindows: use"surrogateescape".
• "surrogateescape"ifPyPreConfig.utf8_modeisnon-zero,oriftheLC_CTYPElocaleis
“C”or“POSIX”.
• "strict"otherwise.
SeealsoPyConfig.legacy_windows_stdio.
11.4. PyConfigCAPI 275

### 第284页

inttracemalloc
Enabletracemalloc?
Ifnon-zero,calltracemalloc.start()atstartup.
Setby-X tracemalloc=NcommandlineoptionandbythePYTHONTRACEMALLOCenvironmentvari-
able.
Default: -1inPythonmode,0inisolatedmode.
intperf_profiling
EnabletheLinuxperfprofilersupport?
Ifequalsto1,enablesupportfortheLinuxperfprofiler.
Ifequalsto2,enablesupportfortheLinuxperfprofilerwithDWARFJITsupport.
Setto1by-X perfcommand-lineoptionandthePYTHONPERFSUPPORTenvironmentvariable.
Set to 2 by the -X perf_jit command-line option and the PYTHON_PERF_JIT_SUPPORT environ-
mentvariable.
Default: -1.
(cid:181) Seealso
Seeperf_profilingformoreinformation.
Addedinversion3.12.
wchar_t*stdlib_dir
DirectoryofthePythonstandardlibrary.
Default: NULL.
Addedinversion3.11.
intuse_environment
Useenvironmentvariables?
Ifequalstozero,ignoretheenvironmentvariables.
Setto0bythe-Eenvironmentvariable.
Default: 1inPythonconfigand0inisolatedconfig.
intuse_system_logger
Ifnon-zero,stdoutandstderrwillberedirectedtothesystemlog.
OnlyavailableonmacOS10.12andlater,andoniOS.
Default: 0(don’tusethesystemlog)onmacOS;1oniOS(usethesystemlog).
Addedinversion3.14.
intuser_site_directory
Ifnon-zero,addtheusersitedirectorytosys.path.
Setto0bythe-sand-Icommandlineoptions.
Setto0bythePYTHONNOUSERSITEenvironmentvariable.
Default: 1inPythonmode,0inisolatedmode.
276 Chapter11. PythonInitializationConfiguration

| (cid:181) Seealso |
| --- |
| Seeperf_profilingformoreinformation. |

### 第285页

intverbose
Verbose mode. If greater than 0, print a message each time a module is imported, showing the place
(filenameorbuilt-inmodule)fromwhichitisloaded.
Ifgreaterthanorequalto2,printamessageforeachfilethatischeckedforwhensearchingforamodule.
Alsoprovidesinformationonmodulecleanupatexit.
Incrementedbythe-vcommandlineoption.
SetbythePYTHONVERBOSEenvironmentvariablevalue.
Default: 0.
PyWideStringListwarnoptions
Options of the warnings module to build warnings filters, lowest to highest priority: sys.
warnoptions.
The warnings module adds sys.warnoptions in the reverse order: the last PyConfig.
warnoptionsitembecomesthefirstitemofwarnings.filterswhichischeckedfirst(highestpri-
ority).
The-Wcommandlineoptionsaddsitsvaluetowarnoptions,itcanbeusedmultipletimes.
ThePYTHONWARNINGSenvironmentvariablecanalsobeusedtoaddwarningoptions. Multipleoptions
canbespecified,separatedbycommas(,).
Default: emptylist.
intwrite_bytecode
Ifequalto0,Pythonwon’ttrytowrite.pycfilesontheimportofsourcemodules.
Setto0bythe-BcommandlineoptionandthePYTHONDONTWRITEBYTECODEenvironmentvariable.
sys.dont_write_bytecodeisinitializedtotheinvertedvalueofwrite_bytecode.
Default: 1.
PyWideStringListxoptions
Valuesofthe-Xcommandlineoptions: sys._xoptions.
Default: emptylist.
int_pystats
Ifnon-zero,writeperformancestatisticsatPythonexit.
NeedaspecialbuildwiththePy_STATSmacro: see--enable-pystats.
Default: 0.
If parse_argv is non-zero, argv arguments are parsed the same way the regular Python parses command line
arguments,andPythonargumentsarestrippedfromargv.
Thexoptionsoptionsareparsedtosetotheroptions: seethe-Xcommandlineoption.
Changedinversion3.9: Theshow_alloc_countfieldhasbeenremoved.
11.4.7 Initialization with PyConfig
Initializing the interpreter from a populated configuration struct is handled by calling
Py_InitializeFromConfig().
The caller is responsible to handle exceptions (error or exit) using PyStatus_Exception() and
Py_ExitStatusException().
IfPyImport_FrozenModules(),PyImport_AppendInittab()orPyImport_ExtendInittab()areused,
they must be set or called after Python preinitialization and before the Python initialization. If Python is initial-
izedmultipletimes,PyImport_AppendInittab()orPyImport_ExtendInittab()mustbecalledbeforeeach
Pythoninitialization.
11.4. PyConfigCAPI 277

### 第286页

Thecurrentconfiguration(PyConfigtype)isstoredinPyInterpreterState.config.
Examplesettingtheprogramname:
void init_python(void)
{
PyStatus status;
PyConfig config;
PyConfig_InitPythonConfig(&config);
/* Set the program name. Implicitly preinitialize Python. */
status = PyConfig_SetString(&config, &config.program_name,
L"/path/to/my_program");
if (PyStatus_Exception(status)) {
goto exception;
}
status = Py_InitializeFromConfig(&config);
if (PyStatus_Exception(status)) {
goto exception;
}
PyConfig_Clear(&config);
return;
exception:
PyConfig_Clear(&config);
Py_ExitStatusException(status);
}
Morecompleteexamplemodifyingthedefaultconfiguration,readtheconfiguration,andthenoverridesomeparam-
eters. Notethatsince3.11,manyparametersarenotcalculateduntilinitialization,andsovaluescannotbereadfrom
theconfigurationstructure. Anyvaluessetbeforeinitializeiscalledwillbeleftunchangedbyinitialization:
PyStatus init_python(const char *program_name)
{
PyStatus status;
PyConfig config;
PyConfig_InitPythonConfig(&config);
/* Set the program name before reading the configuration
(decode byte string from the locale encoding).
Implicitly preinitialize Python. */
status = PyConfig_SetBytesString(&config, &config.program_name,
program_name);
if (PyStatus_Exception(status)) {
goto done;
}
/* Read all configuration at once */
status = PyConfig_Read(&config);
if (PyStatus_Exception(status)) {
goto done;
}
/* Specify sys.path explicitly */
(continuesonnextpage)
278 Chapter11. PythonInitializationConfiguration

### 第287页

(continuedfrompreviouspage)
/* If you want to modify the default set of paths, finish
initialization first and then use PySys_GetObject("path") */
config.module_search_paths_set = 1;
status = PyWideStringList_Append(&config.module_search_paths,
L"/path/to/stdlib");
if (PyStatus_Exception(status)) {
goto done;
}
status = PyWideStringList_Append(&config.module_search_paths,
L"/path/to/more/modules");
if (PyStatus_Exception(status)) {
goto done;
}
/* Override executable computed by PyConfig_Read() */
status = PyConfig_SetString(&config, &config.executable,
L"/path/to/my_executable");
if (PyStatus_Exception(status)) {
goto done;
}
status = Py_InitializeFromConfig(&config);
done:
PyConfig_Clear(&config);
return status;
}
11.4.8 Isolated Configuration
PyPreConfig_InitIsolatedConfig()andPyConfig_InitIsolatedConfig()functionscreateaconfigu-
rationtoisolatePythonfromthesystem. Forexample,toembedPythonintoanapplication.
This configuration ignores global configuration variables, environment variables, command line arguments
(PyConfig.argvisnotparsed)andusersitedirectory. TheCstandardstreams(ex: stdout)andtheLC_CTYPE
localeareleftunchanged. Signalhandlersarenotinstalled.
Configurationfilesarestillusedwiththisconfigurationtodeterminepathsthatareunspecified. EnsurePyConfig.
homeisspecifiedtoavoidcomputingthedefaultpathconfiguration.
11.4.9 Python Configuration
PyPreConfig_InitPythonConfig()andPyConfig_InitPythonConfig()functionscreateaconfiguration
tobuildacustomizedPythonwhichbehavesastheregularPython.
Environments variables and command line arguments are used to configure Python, whereas global configuration
variablesareignored.
This function enables C locale coercion (PEP 538) and Python UTF-8 Mode (PEP 540) depending on the
LC_CTYPElocale,PYTHONUTF8andPYTHONCOERCECLOCALEenvironmentvariables.
11.4.10 Python Path Configuration
PyConfigcontainsmultiplefieldsforthepathconfiguration:
• Pathconfigurationinputs:
– PyConfig.home
– PyConfig.platlibdir
11.4. PyConfigCAPI 279

### 第288页

– PyConfig.pathconfig_warnings
– PyConfig.program_name
– PyConfig.pythonpath_env
– currentworkingdirectory: togetabsolutepaths
– PATHenvironmentvariabletogettheprogramfullpath(fromPyConfig.program_name)
– __PYVENV_LAUNCHER__environmentvariable
– (Windowsonly)Applicationpathsintheregistryunder“SoftwarePythonPythonCoreX.YPythonPath”of
HKEY_CURRENT_USERandHKEY_LOCAL_MACHINE(whereX.YisthePythonversion).
• Pathconfigurationoutputfields:
– PyConfig.base_exec_prefix
– PyConfig.base_executable
– PyConfig.base_prefix
– PyConfig.exec_prefix
– PyConfig.executable
– PyConfig.module_search_paths_set,PyConfig.module_search_paths
– PyConfig.prefix
If at least one “output field” is not set, Python calculates the path configuration to fill unset
fields. If module_search_paths_set is equal to 0, module_search_paths is overridden and
module_search_paths_setissetto1.
It is possible to completely ignore the function calculating the default path configuration by setting explic-
itly all path configuration output fields listed above. A string is considered as set even if it is non-empty.
module_search_paths is considered as set if module_search_paths_set is set to 1. In this case,
module_search_pathswillbeusedwithoutmodification.
Setpathconfig_warningsto0tosuppresswarningswhencalculatingthepathconfiguration(Unixonly,Windows
doesnotloganywarning).
Ifbase_prefixorbase_exec_prefixfieldsarenotset,theyinherittheirvaluefromprefixandexec_prefix
respectively.
Py_RunMain()andPy_Main()modifysys.path:
• Ifrun_filenameissetandisadirectorywhichcontainsa__main__.pyscript,prependrun_filename
tosys.path.
• Ifisolatediszero:
– Ifrun_moduleisset,prependthecurrentdirectorytosys.path. Donothingifthecurrentdirectory
cannotberead.
– Ifrun_filenameisset,prependthedirectoryofthefilenametosys.path.
– Otherwise,prependanemptystringtosys.path.
If site_import is non-zero, sys.path can be modified by the site module. If user_site_directory is
non-zeroandtheuser’ssite-packagedirectoryexists,thesitemoduleappendstheuser’ssite-packagedirectoryto
sys.path.
Thefollowingconfigurationfilesareusedbythepathconfiguration:
• pyvenv.cfg
• ._pthfile(ex: python._pth)
• pybuilddir.txt(Unixonly)
Ifa._pthfileispresent:
280 Chapter11. PythonInitializationConfiguration

### 第289页

• Setisolatedto1.
• Setuse_environmentto0.
• Setsite_importto0.
• Setsafe_pathto1.
Ifhomeisnotsetandapyvenv.cfgfileispresentinthesamedirectoryasexecutable,oritsparent,prefix
and exec_prefix are set that location. When this happens, base_prefix and base_exec_prefix still keep
theirvalue,pointingtothebaseinstallation. Seesys-path-init-virtual-environmentsformoreinformation.
The__PYVENV_LAUNCHER__environmentvariableisusedtosetPyConfig.base_executable.
Changedinversion3.14: prefix,andexec_prefix,arenowsettothepyvenv.cfgdirectory. Thiswasprevi-
ouslydonebysite,thereforeaffectedby-S.
11.5 Py_GetArgcArgv()
voidPy_GetArgcArgv(int*argc,wchar_t***argv)
Gettheoriginalcommandlinearguments,beforePythonmodifiedthem.
SeealsoPyConfig.orig_argvmember.
11.6 Delaying main module execution
Insomeembeddingusecases,itmaybedesirabletoseparateinterpreterinitializationfromtheexecutionofthemain
module.
Thisseparationcanbe achievedbysetting PyConfig.run_command totheemptystringduringinitialization(to
preventtheinterpreterfromdroppingintotheinteractiveprompt),andthensubsequentlyexecutingthedesiredmain
modulecodeusing__main__.__dict__astheglobalnamespace.
11.5. Py_GetArgcArgv() 281

### 第290页

282 Chapter11. PythonInitializationConfiguration

### 第291页

CHAPTER
TWELVE
MEMORY MANAGEMENT
12.1 Overview
Memory management in Python involves a private heap containing all Python objects and data structures. The
managementofthisprivateheapisensuredinternallybythePythonmemorymanager. ThePythonmemorymanager
hasdifferentcomponentswhichdealwithvariousdynamicstoragemanagementaspects,likesharing,segmentation,
preallocationorcaching.
At the lowest level, a raw memory allocator ensures that there is enough room in the private heap for storing all
Python-relateddatabyinteractingwiththememorymanageroftheoperatingsystem. Ontopoftherawmemory
allocator,severalobject-specificallocatorsoperateonthesameheapandimplementdistinctmemorymanagement
policiesadaptedtothepeculiaritiesofeveryobjecttype. Forexample,integerobjectsaremanageddifferentlywithin
the heap than strings, tuples or dictionaries because integers imply different storage requirements and speed/space
tradeoffs. ThePythonmemorymanagerthusdelegatessomeoftheworktotheobject-specificallocators,butensures
thatthelatteroperatewithintheboundsoftheprivateheap.
ItisimportanttounderstandthatthemanagementofthePythonheapisperformedbytheinterpreteritselfandthat
theuserhasnocontroloverit,eveniftheyregularlymanipulateobjectpointerstomemoryblocksinsidethatheap.
Theallocation ofheap space forPython objects andother internal buffersis performed ondemand by thePython
memorymanagerthroughthePython/CAPIfunctionslistedinthisdocument.
To avoid memory corruption, extension writers should never try to operate on Python objects with the functions
exported by the C library: malloc(), calloc(), realloc() and free(). This will result in mixed calls be-
tweentheCallocatorandthePythonmemorymanagerwithfatalconsequences,becausetheyimplementdifferent
algorithmsandoperateondifferentheaps. However,onemaysafelyallocateandreleasememoryblockswiththeC
libraryallocatorforindividualpurposes,asshowninthefollowingexample:
PyObject *res;
char *buf = (char *) malloc(BUFSIZ); /* for I/O */
if (buf == NULL)
return PyErr_NoMemory();
...Do some I/O operation involving buf...
res = PyBytes_FromString(buf);
free(buf); /* malloc'ed */
return res;
Inthisexample, thememoryrequestfortheI/ObufferishandledbytheClibraryallocator. ThePythonmemory
managerisinvolvedonlyintheallocationofthebytesobjectreturnedasaresult.
Inmostsituations, however, itisrecommendedtoallocatememoryfromthePythonheapspecificallybecausethe
latterisundercontrolofthePythonmemorymanager. Forexample,thisisrequiredwhentheinterpreterisextended
with new object types written in C. Another reason for using the Python heap is the desire to inform the Python
memory manager about the memory needs of the extension module. Even when the requested memory is used
exclusively for internal, highly specific purposes, delegating all memory requests to the Python memory manager
causestheinterpretertohaveamoreaccurateimageofitsmemoryfootprintasawhole. Consequently,undercertain
circumstances, the Python memory manager may or may not trigger appropriate actions, like garbage collection,
283

### 第292页

memory compaction or other preventive procedures. Note that by using the C library allocator as shown in the
previousexample,theallocatedmemoryfortheI/ObufferescapescompletelythePythonmemorymanager.
(cid:181) Seealso
ThePYTHONMALLOCenvironmentvariablecanbeusedtoconfigurethememoryallocatorsusedbyPython.
ThePYTHONMALLOCSTATSenvironmentvariablecanbeusedtoprintstatisticsofthepymallocmemoryallocator
everytimeanewpymallocobjectarenaiscreated,andonshutdown.
12.2 Allocator Domains
All allocating functions belong to one of three different “domains” (see also PyMemAllocatorDomain). These
domainsrepresentdifferentallocationstrategiesandareoptimizedfordifferentpurposes. Thespecificdetailsonhow
everydomainallocatesmemoryorwhatinternalfunctionseachdomaincallsisconsideredanimplementationdetail,
butfordebuggingpurposesasimplifiedtablecanbefoundathere. TheAPIsusedtoallocateandfreeablockof
memorymustbefromthesamedomain. Forexample,PyMem_Free()mustbeusedtofreememoryallocatedusing
PyMem_Malloc().
Thethreeallocationdomainsare:
• Rawdomain: intendedforallocatingmemoryforgeneral-purposememorybufferswheretheallocationmust
gotothesystemallocatororwheretheallocatorcanoperatewithoutanattachedthreadstate. Thememoryis
requesteddirectlyfromthesystem. SeeRawMemoryInterface.
• “Mem”domain:intendedforallocatingmemoryforPythonbuffersandgeneral-purposememorybufferswhere
theallocationmustbeperformedwithanattachedthreadstate. ThememoryistakenfromthePythonprivate
heap. SeeMemoryInterface.
• Object domain: intended for allocating memory for Python objects. The memory is taken from the Python
privateheap. SeeObjectallocators.
(cid:174) Note
The free-threaded build requires that only Python objects are allocated using the “object” domain and that all
Pythonobjectsareallocatedusingthatdomain. ThisdiffersfromthepriorPythonversions,wherethiswasonly
abestpracticeandnotahardrequirement.
Forexample,buffers(non-Pythonobjects)shouldbeallocatedusingPyMem_Malloc(),PyMem_RawMalloc(),
ormalloc(),butnotPyObject_Malloc().
SeeMemoryAllocationAPIs.
12.3 Raw Memory Interface
Thefollowingfunctionsetsarewrapperstothesystemallocator. Thesefunctionsarethread-safe,soathreadstate
doesnotneedtobeattached.
Thedefaultrawmemoryallocatorusesthefollowingfunctions: malloc(),calloc(),realloc()andfree();
callmalloc(1)(orcalloc(1, 1))whenrequestingzerobytes.
Addedinversion3.4.
void*PyMem_RawMalloc(size_tn)
PartoftheStableABIsinceversion3.13. Allocatesnbytesandreturnsapointeroftypevoid*totheallocated
memory,orNULLiftherequestfails.
Requestingzerobytesreturnsadistinctnon-NULLpointerifpossible,asifPyMem_RawMalloc(1)hadbeen
calledinstead. Thememorywillnothavebeeninitializedinanyway.
284 Chapter12. MemoryManagement

| (cid:181) Seealso |
| --- |
| ThePYTHONMALLOCenvironmentvariablecanbeusedtoconfigurethememoryallocatorsusedbyPython.
ThePYTHONMALLOCSTATSenvironmentvariablecanbeusedtoprintstatisticsofthepymallocmemoryallocator
everytimeanewpymallocobjectarenaiscreated,andonshutdown. |

### 第293页

void*PyMem_RawCalloc(size_tnelem,size_telsize)
PartoftheStableABIsinceversion3.13. Allocatesnelemelementseachwhosesizeinbytesiselsizeandreturns
apointeroftypevoid*totheallocatedmemory,orNULLiftherequestfails. Thememoryisinitializedto
zeros.
Requestingzeroelementsorelementsofsizezerobytesreturnsadistinctnon-NULLpointerifpossible,asif
PyMem_RawCalloc(1, 1)hadbeencalledinstead.
Addedinversion3.5.
void*PyMem_RawRealloc(void*p,size_tn)
PartoftheStableABIsinceversion3.13. Resizesthememoryblockpointedtobyptonbytes. Thecontents
willbeunchangedtotheminimumoftheoldandthenewsizes.
IfpisNULL,thecallisequivalenttoPyMem_RawMalloc(n);elseifnisequaltozero,thememoryblockis
resizedbutisnotfreed,andthereturnedpointerisnon-NULL.
Unless p is NULL, it must have been returned by a previous call to PyMem_RawMalloc(),
PyMem_RawRealloc()orPyMem_RawCalloc().
Iftherequestfails,PyMem_RawRealloc()returnsNULLandpremainsavalidpointertothepreviousmemory
area.
voidPyMem_RawFree(void*p)
Part of the Stable ABI since version 3.13. Frees the memory block pointed to by p, which must have been
returned by a previous call to PyMem_RawMalloc(), PyMem_RawRealloc() or PyMem_RawCalloc().
Otherwise,orifPyMem_RawFree(p)hasbeencalledbefore,undefinedbehavioroccurs.
IfpisNULL,nooperationisperformed.
12.4 Memory Interface
Thefollowingfunctionsets,modeledaftertheANSICstandard,butspecifyingbehaviorwhenrequestingzerobytes,
areavailableforallocatingandreleasingmemoryfromthePythonheap.
Thedefaultmemoryallocatorusesthepymallocmemoryallocator.
(cid:193) Warning
Theremustbeanattachedthreadstatewhenusingthesefunctions.
Changedinversion3.6: Thedefaultallocatorisnowpymallocinsteadofsystemmalloc().
void*PyMem_Malloc(size_tn)
Part of the Stable ABI. Allocates n bytes and returns a pointer of type void* to the allocated memory, or
NULLiftherequestfails.
Requestingzerobytesreturnsadistinctnon-NULLpointerifpossible,asifPyMem_Malloc(1)hadbeencalled
instead. Thememorywillnothavebeeninitializedinanyway.
void*PyMem_Calloc(size_tnelem,size_telsize)
PartoftheStableABIsinceversion3.7. Allocatesnelemelementseachwhosesizeinbytesiselsizeandreturns
apointeroftypevoid*totheallocatedmemory,orNULLiftherequestfails. Thememoryisinitializedto
zeros.
Requestingzeroelementsorelementsofsizezerobytesreturnsadistinctnon-NULLpointerifpossible,asif
PyMem_Calloc(1, 1)hadbeencalledinstead.
Addedinversion3.5.
12.4. MemoryInterface 285

| (cid:193) Warning |
| --- |
| Theremustbeanattachedthreadstatewhenusingthesefunctions. |

### 第294页

void*PyMem_Realloc(void*p,size_tn)
PartoftheStableABI.Resizesthememoryblockpointedtobyptonbytes. Thecontentswillbeunchanged
totheminimumoftheoldandthenewsizes.
IfpisNULL,thecallisequivalenttoPyMem_Malloc(n);elseifnisequaltozero,thememoryblockisresized
butisnotfreed,andthereturnedpointerisnon-NULL.
UnlesspisNULL,itmusthavebeenreturnedbyapreviouscalltoPyMem_Malloc(),PyMem_Realloc()or
PyMem_Calloc().
Iftherequestfails,PyMem_Realloc()returnsNULLandpremainsavalidpointertothepreviousmemory
area.
voidPyMem_Free(void*p)
PartoftheStableABI.Freesthememoryblockpointedtobyp,whichmusthavebeenreturnedbyaprevious
call to PyMem_Malloc(), PyMem_Realloc() or PyMem_Calloc(). Otherwise, or if PyMem_Free(p)
hasbeencalledbefore,undefinedbehavioroccurs.
IfpisNULL,nooperationisperformed.
Thefollowingtype-orientedmacrosareprovidedforconvenience. NotethatTYPE referstoanyCtype.
PyMem_New(TYPE,n)
SameasPyMem_Malloc(),butallocates(n * sizeof(TYPE))bytesofmemory. Returnsapointercast
toTYPE*. Thememorywillnothavebeeninitializedinanyway.
PyMem_Resize(p,TYPE,n)
SameasPyMem_Realloc(),butthememoryblockisresizedto(n * sizeof(TYPE))bytes. Returnsa
pointercasttoTYPE*. Onreturn,pwillbeapointertothenewmemoryarea,orNULLintheeventoffailure.
ThisisaCpreprocessormacro; pisalwaysreassigned. Savetheoriginalvalueofptoavoidlosingmemory
whenhandlingerrors.
voidPyMem_Del(void*p)
SameasPyMem_Free().
Inaddition,thefollowingmacrosetsareprovidedforcallingthePythonmemoryallocatordirectly,withoutinvolving
theCAPIfunctionslistedabove. However,notethattheirusedoesnotpreservebinarycompatibilityacrossPython
versionsandisthereforedeprecatedinextensionmodules.
• PyMem_MALLOC(size)
• PyMem_NEW(type, size)
• PyMem_REALLOC(ptr, size)
• PyMem_RESIZE(ptr, type, size)
• PyMem_FREE(ptr)
• PyMem_DEL(ptr)
12.5 Object allocators
Thefollowingfunctionsets,modeledaftertheANSICstandard,butspecifyingbehaviorwhenrequestingzerobytes,
areavailableforallocatingandreleasingmemoryfromthePythonheap.
(cid:174) Note
ThereisnoguaranteethatthememoryreturnedbytheseallocatorscanbesuccessfullycasttoaPythonobject
when intercepting the allocating functions in this domain by the methods described in the Customize Memory
Allocatorssection.
286 Chapter12. MemoryManagement

### 第295页

Thedefaultobjectallocatorusesthepymallocmemoryallocator.
(cid:193) Warning
Theremustbeanattachedthreadstatewhenusingthesefunctions.
void*PyObject_Malloc(size_tn)
Part of the Stable ABI. Allocates n bytes and returns a pointer of type void* to the allocated memory, or
NULLiftherequestfails.
Requestingzerobytesreturnsadistinctnon-NULLpointerifpossible,asifPyObject_Malloc(1)hadbeen
calledinstead. Thememorywillnothavebeeninitializedinanyway.
void*PyObject_Calloc(size_tnelem,size_telsize)
PartoftheStableABIsinceversion3.7. Allocatesnelemelementseachwhosesizeinbytesiselsizeandreturns
apointeroftypevoid*totheallocatedmemory,orNULLiftherequestfails. Thememoryisinitializedto
zeros.
Requestingzeroelementsorelementsofsizezerobytesreturnsadistinctnon-NULLpointerifpossible,asif
PyObject_Calloc(1, 1)hadbeencalledinstead.
Addedinversion3.5.
void*PyObject_Realloc(void*p,size_tn)
PartoftheStableABI.Resizesthememoryblockpointedtobyptonbytes. Thecontentswillbeunchanged
totheminimumoftheoldandthenewsizes.
IfpisNULL,thecallisequivalenttoPyObject_Malloc(n);elseifnisequaltozero,thememoryblockis
resizedbutisnotfreed,andthereturnedpointerisnon-NULL.
Unless p is NULL, it must have been returned by a previous call to PyObject_Malloc(),
PyObject_Realloc()orPyObject_Calloc().
Iftherequestfails,PyObject_Realloc()returnsNULLandpremainsavalidpointertothepreviousmemory
area.
voidPyObject_Free(void*p)
Part of the Stable ABI. Frees the memory block pointed to by p, which must have been returned by a pre-
vious call to PyObject_Malloc(), PyObject_Realloc() or PyObject_Calloc(). Otherwise, or if
PyObject_Free(p)hasbeencalledbefore,undefinedbehavioroccurs.
IfpisNULL,nooperationisperformed.
Donotcallthisdirectlytofreeanobject’smemory;callthetype’stp_freeslotinstead.
Do not use this for memory allocated by PyObject_GC_New or PyObject_GC_NewVar; use
PyObject_GC_Del()instead.
(cid:181) Seealso
• PyObject_GC_Del()istheequivalentofthisfunctionformemoryallocatedbytypesthatsupport
garbagecollection.
• PyObject_Malloc()
• PyObject_Realloc()
• PyObject_Calloc()
• PyObject_New
• PyObject_NewVar
• PyType_GenericAlloc()
12.5. Objectallocators 287

| (cid:193) Warning |
| --- |
| Theremustbeanattachedthreadstatewhenusingthesefunctions. |


| (cid:181) Seealso |
| --- |
| • PyObject_GC_Del()istheequivalentofthisfunctionformemoryallocatedbytypesthatsupport
garbagecollection.
• PyObject_Malloc()
• PyObject_Realloc()
• PyObject_Calloc()
• PyObject_New
• PyObject_NewVar
• PyType_GenericAlloc() |

### 第296页

• tp_free
12.6 Default Memory Allocators
Defaultmemoryallocators:
Configuration Name PyMem_RawMallocPyMem_Malloc PyOb-
ject_Malloc
Releasebuild "pymalloc" malloc pymalloc pymalloc
Debugbuild "pymalloc_debug"malloc+debug pymalloc+de- pymalloc+de-
bug bug
Release build, without py- "malloc" malloc malloc malloc
malloc
Debug build, without py- "malloc_debug" malloc+debug malloc+debug malloc+debug
malloc
Legend:
• Name: valueforPYTHONMALLOCenvironmentvariable.
• malloc: systemallocatorsfromthestandardClibrary,Cfunctions: malloc(),calloc(),realloc()and
free().
• pymalloc: pymallocmemoryallocator.
• mimalloc: mimallocmemoryallocator. Thepymallocallocatorwillbeusedifmimallocsupportisn’tavail-
able.
• “+debug”: withdebughooksonthePythonmemoryallocators.
• “Debugbuild”: Pythonbuildindebugmode.
12.7 Customize Memory Allocators
Addedinversion3.4.
typePyMemAllocatorEx
Structureusedtodescribeamemoryblockallocator. Thestructurehasthefollowingfields:
Field Meaning
void *ctx usercontextpassedasfirstargument
void* malloc(void *ctx, size_t size) allocateamemoryblock
void* calloc(void *ctx, size_t nelem, size_t allocateamemoryblockinitializedwith
elsize) zeros
void* realloc(void *ctx, void *ptr, size_t allocateorresizeamemoryblock
new_size)
void free(void *ctx, void *ptr) freeamemoryblock
Changedinversion3.5: ThePyMemAllocatorstructurewasrenamedtoPyMemAllocatorEx andanew
callocfieldwasadded.
typePyMemAllocatorDomain
Enumusedtoidentifyanallocatordomain. Domains:
288 Chapter12. MemoryManagement

| Configuration | Name | PyMem_RawMallo | cPyMem_Malloc | PyOb-
ject_Malloc |
| --- | --- | --- | --- | --- |
| Releasebuild | "pymalloc" | malloc | pymalloc | pymalloc |
| Debugbuild | "pymalloc_debug | "malloc+debug | pymalloc+de-
bug | pymalloc+de-
bug |
| Release build, without py-
malloc | "malloc" | malloc | malloc | malloc |
| Debug build, without py-
malloc | "malloc_debug" | malloc+debug | malloc+debug | malloc+debug |


| Field | Meaning |
| --- | --- |
| void *ctx | usercontextpassedasfirstargument |
| void* malloc(void *ctx, size_t size) | allocateamemoryblock |
| void* calloc(void *ctx, size_t nelem, size_t
elsize) | allocateamemoryblockinitializedwith
zeros |
| void* realloc(void *ctx, void *ptr, size_t
new_size) | allocateorresizeamemoryblock |
| void free(void *ctx, void *ptr) | freeamemoryblock |

### 第297页

PYMEM_DOMAIN_RAW
Functions:
• PyMem_RawMalloc()
• PyMem_RawRealloc()
• PyMem_RawCalloc()
• PyMem_RawFree()
PYMEM_DOMAIN_MEM
Functions:
• PyMem_Malloc(),
• PyMem_Realloc()
• PyMem_Calloc()
• PyMem_Free()
PYMEM_DOMAIN_OBJ
Functions:
• PyObject_Malloc()
• PyObject_Realloc()
• PyObject_Calloc()
• PyObject_Free()
voidPyMem_GetAllocator(PyMemAllocatorDomaindomain,PyMemAllocatorEx*allocator)
Getthememoryblockallocatorofthespecifieddomain.
voidPyMem_SetAllocator(PyMemAllocatorDomaindomain,PyMemAllocatorEx*allocator)
Setthememoryblockallocatorofthespecifieddomain.
Thenewallocatormustreturnadistinctnon-NULLpointerwhenrequestingzerobytes.
ForthePYMEM_DOMAIN_RAW domain,theallocatormustbethread-safe: athreadstateisnotattached when
theallocatoriscalled.
For the remaining domains, the allocator must also be thread-safe: the allocator may be called in different
interpretersthatdonotshareaGIL.
If the new allocator is not a hook (does not call the previous allocator), the PyMem_SetupDebugHooks()
functionmustbecalledtoreinstallthedebughooksontoponthenewallocator.
SeealsoPyPreConfig.allocatorandPreinitializePythonwithPyPreConfig.
(cid:193) Warning
PyMem_SetAllocator()doeshavethefollowingcontract:
• ItcanbecalledafterPy_PreInitialize()andbeforePy_InitializeFromConfig()toin-
stallacustommemoryallocator. Therearenorestrictionsovertheinstalledallocatorotherthanthe
onesimposedbythedomain(forinstance,theRawDomainallowstheallocatortobecalledwithout
anattachedthreadstate). Seethesectiononallocatordomainsformoreinformation.
• IfcalledafterPythonhasfinishinitializing(afterPy_InitializeFromConfig()hasbeencalled)
the allocator must wrap the existing allocator. Substituting the current allocator for some other
arbitraryoneisnotsupported.
Changedinversion3.12: Allallocatorsmustbethread-safe.
12.7. CustomizeMemoryAllocators 289

| (cid:193) Warning |
| --- |
| PyMem_SetAllocator()doeshavethefollowingcontract:
• ItcanbecalledafterPy_PreInitialize()andbeforePy_InitializeFromConfig()toin-
stallacustommemoryallocator. Therearenorestrictionsovertheinstalledallocatorotherthanthe
onesimposedbythedomain(forinstance,theRawDomainallowstheallocatortobecalledwithout
anattachedthreadstate). Seethesectiononallocatordomainsformoreinformation.
• IfcalledafterPythonhasfinishinitializing(afterPy_InitializeFromConfig()hasbeencalled)
the allocator must wrap the existing allocator. Substituting the current allocator for some other
arbitraryoneisnotsupported. |

### 第298页

voidPyMem_SetupDebugHooks(void)
SetupdebughooksinthePythonmemoryallocatorstodetectmemoryerrors.
12.8 Debug hooks on the Python memory allocators
WhenPythonisbuiltindebugmode,thePyMem_SetupDebugHooks()functioniscalledatthePythonpreinitial-
izationtosetupdebughooksonPythonmemoryallocatorstodetectmemoryerrors.
ThePYTHONMALLOCenvironmentvariablecanbeusedtoinstalldebughooksonaPythoncompiledinreleasemode
(ex: PYTHONMALLOC=debug).
The PyMem_SetupDebugHooks() function can be used to set debug hooks after calling
PyMem_SetAllocator().
These debug hooks fill dynamically allocated memory blocks with special, recognizable bit patterns. Newly
allocated memory is filled with the byte 0xCD (PYMEM_CLEANBYTE), freed memory is filled with the byte
0xDD (PYMEM_DEADBYTE). Memory blocks are surrounded by “forbidden bytes” filled with the byte 0xFD
(PYMEM_FORBIDDENBYTE).Stringsofthesebytesareunlikelytobevalidaddresses,floats,orASCIIstrings.
Runtimechecks:
• DetectAPIviolations. Forexample,detectifPyObject_Free()iscalledonamemoryblockallocatedby
PyMem_Malloc().
• Detectwritebeforethestartofthebuffer(bufferunderflow).
• Detectwriteaftertheendofthebuffer(bufferoverflow).
• Check that there is an attached thread state when allocator functions of PYMEM_DOMAIN_OBJ (ex:
PyObject_Malloc())andPYMEM_DOMAIN_MEM (ex: PyMem_Malloc())domainsarecalled.
Onerror,thedebughooksusethetracemallocmoduletogetthetracebackwhereamemoryblockwasallocated.
ThetracebackisonlydisplayediftracemallocistracingPythonmemoryallocationsandthememoryblockwas
traced.
LetS=sizeof(size_t). 2*SbytesareaddedateachendofeachblockofNbytesrequested. Thememorylayout
islikeso,whereprepresentstheaddressreturnedbyamalloc-likeorrealloc-likefunction(p[i:j]meanstheslice
ofbytesfrom*(p+i)inclusiveupto*(p+j)exclusive; notethatthetreatmentofnegativeindicesdiffersfroma
Pythonslice):
p[-2*S:-S]
Numberofbytesoriginallyaskedfor. Thisisasize_t,big-endian(easiertoreadinamemorydump).
p[-S]
APIidentifier(ASCIIcharacter):
• 'r'forPYMEM_DOMAIN_RAW.
• 'm'forPYMEM_DOMAIN_MEM.
• 'o'forPYMEM_DOMAIN_OBJ.
p[-S+1:0]
CopiesofPYMEM_FORBIDDENBYTE.Usedtocatchunder-writesandreads.
p[0:N]
The requested memory, filled with copies of PYMEM_CLEANBYTE, used to catch reference to uninitial-
izedmemory. Whenarealloc-likefunctioniscalledrequestingalargermemoryblock,thenewexcessbytes
arealsofilledwithPYMEM_CLEANBYTE.Whenafree-likefunctioniscalled,theseareoverwrittenwith
PYMEM_DEADBYTE,tocatchreferencetofreedmemory. Whenarealloc-likefunctioniscalledrequesting
asmallermemoryblock,theexcessoldbytesarealsofilledwithPYMEM_DEADBYTE.
p[N:N+S]
CopiesofPYMEM_FORBIDDENBYTE.Usedtocatchover-writesandreads.
290 Chapter12. MemoryManagement

### 第299页

p[N+S:N+2*S]
OnlyusedifthePYMEM_DEBUG_SERIALNOmacroisdefined(notdefinedbydefault).
Aserialnumber,incrementedby1oneachcalltoamalloc-likeorrealloc-likefunction. Big-endiansize_t.
If“badmemory”isdetectedlater,theserialnumbergivesanexcellentwaytosetabreakpointonthenextrun,
tocapturetheinstantatwhichthisblockwaspassedout. Thestaticfunctionbumpserialno()inobmalloc.cis
theonlyplacetheserialnumberisincremented,andexistssoyoucansetsuchabreakpointeasily.
Arealloc-likeorfree-likefunctionfirstchecksthatthePYMEM_FORBIDDENBYTEbytesateachendareintact.
Ifthey’vebeenaltered,diagnosticoutputiswrittentostderr,andtheprogramisabortedviaPy_FatalError(). The
othermainfailuremodeisprovokingamemoryerrorwhenaprogramreadsuponeofthespecialbitpatternsand
triestouseitasanaddress. Ifyougetinadebuggerthenandlookattheobject,you’relikelytoseethatit’sentirely
filledwithPYMEM_DEADBYTE(meaningfreedmemoryisgettingused)orPYMEM_CLEANBYTE(meaning
uninitializedmemoryisgettingused).
Changedinversion3.6: ThePyMem_SetupDebugHooks()functionnowalsoworksonPythoncompiledinrelease
mode. Onerror,thedebughooksnowusetracemalloctogetthetracebackwhereamemoryblockwasallocated.
The debug hooks now also check if there is an attached thread state when functions of PYMEM_DOMAIN_OBJ and
PYMEM_DOMAIN_MEM domainsarecalled.
Changed in version 3.8: Byte patterns 0xCB (PYMEM_CLEANBYTE), 0xDB (PYMEM_DEADBYTE) and 0xFB
(PYMEM_FORBIDDENBYTE)havebeenreplacedwith0xCD,0xDDand0xFDtousethesamevaluesthanWindows
CRTdebugmalloc()andfree().
12.9 The pymalloc allocator
Pythonhasapymallocallocatoroptimizedforsmallobjects(smallerorequalto512bytes)withashortlifetime. It
usesmemorymappingscalled“arenas”withafixedsizeofeither256KiBon32-bitplatformsor1MiBon64-bit
platforms. ItfallsbacktoPyMem_RawMalloc()andPyMem_RawRealloc()forallocationslargerthan512bytes.
pymalloc is the default allocator of the PYMEM_DOMAIN_MEM (ex: PyMem_Malloc()) and PYMEM_DOMAIN_OBJ
(ex: PyObject_Malloc())domains.
Thearenaallocatorusesthefollowingfunctions:
• VirtualAlloc()andVirtualFree()onWindows,
• mmap()andmunmap()ifavailable,
• malloc()andfree()otherwise.
ThisallocatorisdisabledifPythonisconfiguredwiththe--without-pymallocoption. Itcanalsobedisabledat
runtimeusingthePYTHONMALLOCenvironmentvariable(ex: PYTHONMALLOC=malloc).
Typically, it makes sense to disable the pymalloc allocator when building Python with AddressSanitizer
(--with-address-sanitizer)whichhelpsuncoverlowlevelbugswithintheCcode.
12.9.1 Customize pymalloc Arena Allocator
Addedinversion3.4.
typePyObjectArenaAllocator
Structureusedtodescribeanarenaallocator. Thestructurehasthreefields:
Field Meaning
void *ctx usercontextpassedasfirstargument
void* alloc(void *ctx, size_t size) allocateanarenaofsizebytes
void free(void *ctx, void *ptr, size_t size) freeanarena
voidPyObject_GetArenaAllocator(PyObjectArenaAllocator*allocator)
Getthearenaallocator.
12.9. Thepymallocallocator 291

| Field | Meaning |
| --- | --- |
| void *ctx | usercontextpassedasfirstargument |
| void* alloc(void *ctx, size_t size) | allocateanarenaofsizebytes |
| void free(void *ctx, void *ptr, size_t size) | freeanarena |

### 第300页

voidPyObject_SetArenaAllocator(PyObjectArenaAllocator*allocator)
Setthearenaallocator.
12.10 The mimalloc allocator
Addedinversion3.13.
Python supports the mimalloc allocator when the underlying platform support is available. mimalloc “is a general
purpose allocator with excellent performance characteristics. Initially developed by Daan Leijen for the runtime
systemsoftheKokaandLeanlanguages.”
12.11 tracemalloc C API
Addedinversion3.7.
intPyTraceMalloc_Track(unsignedintdomain,uintptr_tptr,size_tsize)
Trackanallocatedmemoryblockinthetracemallocmodule.
Return0onsuccess,return-1onerror(failedtoallocatememorytostorethetrace). Return-2iftracemalloc
isdisabled.
Ifmemoryblockisalreadytracked,updatetheexistingtrace.
intPyTraceMalloc_Untrack(unsignedintdomain,uintptr_tptr)
Untrackanallocatedmemoryblockinthetracemallocmodule. Donothingiftheblockwasnottracked.
Return-2iftracemallocisdisabled,otherwisereturn0.
12.12 Examples
Here is the example from section Overview, rewritten so that the I/O buffer is allocated from the Python heap by
usingthefirstfunctionset:
PyObject *res;
char *buf = (char *) PyMem_Malloc(BUFSIZ); /* for I/O */
if (buf == NULL)
return PyErr_NoMemory();
/* ...Do some I/O operation involving buf... */
res = PyBytes_FromString(buf);
PyMem_Free(buf); /* allocated with PyMem_Malloc */
return res;
Thesamecodeusingthetype-orientedfunctionset:
PyObject *res;
char *buf = PyMem_New(char, BUFSIZ); /* for I/O */
if (buf == NULL)
return PyErr_NoMemory();
/* ...Do some I/O operation involving buf... */
res = PyBytes_FromString(buf);
PyMem_Free(buf); /* allocated with PyMem_New */
return res;
Notethatinthetwoexamplesabove,thebufferisalwaysmanipulatedviafunctionsbelongingtothesameset. Indeed,
it is required to use the same memory API family for a given memory block, so that the risk of mixing different
allocators is reduced to a minimum. The following code sequence contains two errors, one of which is labeled as
fatalbecauseitmixestwodifferentallocatorsoperatingondifferentheaps.
292 Chapter12. MemoryManagement

### 第301页

char *buf1 = PyMem_New(char, BUFSIZ);
char *buf2 = (char *) malloc(BUFSIZ);
char *buf3 = (char *) PyMem_Malloc(BUFSIZ);
...
PyMem_Del(buf3); /* Wrong -- should be PyMem_Free() */
free(buf2); /* Right -- allocated via malloc() */
free(buf1); /* Fatal -- should be PyMem_Free() */
In addition to the functions aimed at handling raw memory blocks from the Python heap, objects in Python are
allocatedandreleasedwithPyObject_New,PyObject_NewVarandPyObject_Free().
ThesewillbeexplainedinthenextchapterondefiningandimplementingnewobjecttypesinC.
12.12. Examples 293

### 第302页

294 Chapter12. MemoryManagement

### 第303页

CHAPTER
THIRTEEN
OBJECT IMPLEMENTATION SUPPORT
Thischapterdescribesthefunctions,types,andmacrosusedwhendefiningnewobjecttypes.
13.1 Allocating Objects on the Heap
PyObject*_PyObject_New(PyTypeObject*type)
Returnvalue: Newreference.
PyVarObject*_PyObject_NewVar(PyTypeObject*type,Py_ssize_tsize)
Returnvalue: Newreference.
PyObject*PyObject_Init(PyObject*op,PyTypeObject*type)
Returnvalue:Borrowedreference. PartoftheStableABI.Initializeanewlyallocatedobjectopwithitstypeand
initialreference. Returnstheinitializedobject. Otherfieldsoftheobjectarenotinitialized. Despiteitsname,
thisfunctionisunrelatedtotheobject’s__init__()method(tp_initslot). Specifically,thisfunctiondoes
notcalltheobject’s__init__()method.
Ingeneral,considerthisfunctiontobealow-levelroutine. Usetp_allocwherepossible. Forimplementing
tp_allocforyourtype,preferPyType_GenericAlloc()orPyObject_New().
(cid:174) Note
Thisfunctiononlyinitializestheobject’smemorycorrespondingtotheinitialPyObjectstructure. Itdoes
notzerotherest.
PyVarObject*PyObject_InitVar(PyVarObject*op,PyTypeObject*type,Py_ssize_tsize)
Returnvalue: Borrowedreference. PartoftheStableABI.ThisdoeseverythingPyObject_Init()does,and
alsoinitializesthelengthinformationforavariable-sizeobject.
(cid:174) Note
Thisfunctiononlyinitializessomeoftheobject’smemory. Itdoesnotzerotherest.
PyObject_New(TYPE,typeobj)
Allocates a new Python object using the C structure type TYPE and the Python type object type-
obj (PyTypeObject*) by calling PyObject_Malloc() to allocate memory and initializing it like
PyObject_Init(). The caller will own the only reference to the object (i.e. its reference count will be
one).
Avoidcallingthisdirectlytoallocatememoryforanobject;callthetype’stp_allocslotinstead.
When populating a type’s tp_alloc slot, PyType_GenericAlloc() is preferred over a custom function
thatsimplycallsthismacro.
Thismacrodoesnotcalltp_alloc,tp_new(__new__()),ortp_init(__init__()).
295

### 第304页

This cannot be used for objects with Py_TPFLAGS_HAVE_GC set in tp_flags; use PyObject_GC_New
instead.
Memory allocated by this macro must be freed with PyObject_Free() (usually called via the object’s
tp_freeslot).
(cid:174) Note
Thereturnedmemoryisnotguaranteedtohavebeencompletelyzeroedbeforeitwasinitialized.
(cid:174) Note
Thismacrodoesnotconstructafullyinitializedobjectofthegiventype;itmerelyallocatesmemoryand
preparesitforfurtherinitializationbytp_init. Toconstructafullyinitializedobject,calltypeobjinstead.
Forexample:
PyObject *foo = PyObject_CallNoArgs((PyObject *)&PyFoo_Type);
(cid:181) Seealso
• PyObject_Free()
• PyObject_GC_New
• PyType_GenericAlloc()
• tp_alloc
PyObject_NewVar(TYPE,typeobj,size)
LikePyObject_Newexcept:
• ItallocatesenoughmemoryfortheTYPE structureplussize(Py_ssize_t)fieldsofthesizegivenby
thetp_itemsizefieldoftypeobj.
• ThememoryisinitializedlikePyObject_InitVar().
Thisisusefulforimplementingobjectsliketuples,whichareabletodeterminetheirsizeatconstructiontime.
Embedding the array of fields into the same allocation decreases the number of allocations, improving the
memorymanagementefficiency.
Avoidcallingthisdirectlytoallocatememoryforanobject;callthetype’stp_allocslotinstead.
When populating a type’s tp_alloc slot, PyType_GenericAlloc() is preferred over a custom function
thatsimplycallsthismacro.
ThiscannotbeusedforobjectswithPy_TPFLAGS_HAVE_GCsetintp_flags;usePyObject_GC_NewVar
instead.
Memory allocated by this function must be freed with PyObject_Free() (usually called via the object’s
tp_freeslot).
(cid:174) Note
Thereturnedmemoryisnotguaranteedtohavebeencompletelyzeroedbeforeitwasinitialized.
296 Chapter13. ObjectImplementationSupport

| (cid:181) Seealso |
| --- |
| • PyObject_Free()
• PyObject_GC_New
• PyType_GenericAlloc()
• tp_alloc |

### 第305页

(cid:174) Note
Thismacrodoesnotconstructafullyinitializedobjectofthegiventype;itmerelyallocatesmemoryand
preparesitforfurtherinitializationbytp_init. Toconstructafullyinitializedobject,calltypeobjinstead.
Forexample:
PyObject *list_instance = PyObject_CallNoArgs((PyObject *)&PyList_Type);
(cid:181) Seealso
• PyObject_Free()
• PyObject_GC_NewVar
• PyType_GenericAlloc()
• tp_alloc
voidPyObject_Del(void*op)
SameasPyObject_Free().
PyObject_Py_NoneStruct
Object which is visible in Python as None. This should only be accessed using the Py_None macro, which
evaluatestoapointertothisobject.
(cid:181) Seealso
ModuleObjects
Toallocateandcreateextensionmodules.
13.2 Object Life Cycle
Thissectionexplainshowatype’sslotsrelatetoeachotherthroughoutthelifeofanobject. Itisnotintendedtobea
completecanonicalreferencefortheslots;instead,refertotheslot-specificdocumentationinTypeObjectStructures
fordetailsaboutaparticularslot.
13.2.1 Life Events
The figure below illustrates the order of events that can occur throughout an object’s life. An arrow from A to B
indicatesthateventBcanoccuraftereventAhasoccurred,withthearrow’slabelindicatingtheconditionthatmust
betrueforBtooccurafterA.
13.2. ObjectLifeCycle 297

| (cid:181) Seealso |
| --- |
| • PyObject_Free()
• PyObject_GC_NewVar
• PyType_GenericAlloc()
• tp_alloc |


| (cid:181) Seealso |
| --- |
| ModuleObjects
Toallocateandcreateextensionmodules. |

### 第306页

type call
direct call
tp_new tp_alloc
tp_init
reachable
not in a periodic
cyclic cyclic isolate
isolate detection
tp_traverse no refs
resurrected
cyclic
(maybe remove
isolate
finalized mark)
marked as
finalized?
cyclic
no (mark isolate
as finalized) (no GC
support)
tp_finalize yes no refs
no refs or
cyclic isolate
tp_clear
recommended
cyclic
call (see no refs
isolate
explanation)
uncollectable
no refs
(leaked)
tp_dealloc
direct call
tp_free
298 Chapter13. ObjectImplementationSupport

### 第307页

Explanation:
• Whenanewobjectisconstructedbycallingitstype:
1. tp_newiscalledtocreateanewobject.
2. tp_allocisdirectlycalledbytp_newtoallocatethememoryforthenewobject.
3. tp_initinitializesthenewlycreatedobject. tp_initcanbecalledagaintore-initializeanobject,if
desired. Thetp_initcallcanalsobeskippedentirely,forexamplebyPythoncodecalling__new__().
• Aftertp_initcompletes,theobjectisreadytouse.
• Sometimeafterthelastreferencetoanobjectisremoved:
1. If an object is not marked as finalized, it might be finalized by marking it as finalized and calling its
tp_finalizefunction. Pythondoesnot finalizeanobjectwhenthelastreferencetoitisdeleted;use
PyObject_CallFinalizerFromDealloc()toensurethattp_finalizeisalwayscalled.
2. Iftheobjectismarkedasfinalized,tp_clearmightbecalledbythegarbagecollectortoclearreferences
heldbytheobject. Itisnotcalledwhentheobject’sreferencecountreacheszero.
3. tp_deallociscalledtodestroytheobject. Toavoidcodeduplication,tp_dealloctypicallycallsinto
tp_cleartofreeuptheobject’sreferences.
4. When tp_dealloc finishes object destruction, it directly calls tp_free (usually set to
PyObject_Free()orPyObject_GC_Del()automaticallyasappropriateforthetype)todeallocate
thememory.
• The tp_finalize function is permitted to add a reference to the object if desired. If it does, the object
is resurrected, preventing its pending destruction. (Only tp_finalize is allowed to resurrect an object;
tp_clearandtp_dealloccannotwithoutcallingintotp_finalize.) Resurrectinganobjectmayormay
not cause the object’s finalized mark to be removed. Currently, Python does not remove the finalized mark
from a resurrected object if it supports garbage collection (i.e., the Py_TPFLAGS_HAVE_GC flag is set) but
doesremovethemarkiftheobjectdoesnotsupportgarbagecollection;eitherorbothofthesebehaviorsmay
changeinthefuture.
• tp_dealloc can optionally call tp_finalize via PyObject_CallFinalizerFromDealloc() if it
wishes to reuse that code to help with object destruction. This is recommended because it guarantees that
tp_finalizeisalwayscalledbeforedestruction. Seethetp_deallocdocumentationforexamplecode.
• If the object is a member of a cyclic isolate and either tp_clear fails to break the reference cycle or the
cyclic isolate is not detected (perhaps gc.disable() was called, or the Py_TPFLAGS_HAVE_GC flag was
erroneouslyomittedinoneoftheinvolvedtypes),theobjectsremainindefinitelyuncollectable(they“leak”).
Seegc.garbage.
Iftheobjectismarkedassupportinggarbagecollection(thePy_TPFLAGS_HAVE_GCflagissetintp_flags),the
followingeventsarealsopossible:
• Thegarbagecollectoroccasionallycallstp_traversetoidentifycyclicisolates.
• Whenthegarbagecollectordiscoversacyclicisolate,itfinalizesoneoftheobjectsinthegroupbymarkingit
asfinalized andcallingitstp_finalizefunction,ifithasone. Thisrepeatsuntilthecyclicisolatedoesn’t
existoralloftheobjectshavebeenfinalized.
• tp_finalizeispermittedtoresurrecttheobjectbyaddingareferencefromoutsidethecyclicisolate. The
newreferencecausesthegroupofobjectstonolongerformacyclicisolate(thereferencecyclemaystillexist,
butifitdoestheobjectsarenolongerisolated).
• When the garbage collector discovers a cyclic isolate and all of the objects in the group have already been
markedasfinalized,thegarbagecollectorclearsoneormoreoftheunclearedobjectsinthegroup(possibly
concurrently)bycallingeach’s tp_clear function. Thisrepeatsas longasthecyclicisolatestillexistsand
notalloftheobjectshavebeencleared.
13.2. ObjectLifeCycle 299

### 第308页

13.2.2 Cyclic Isolate Destruction
Listed below are the stages of life of a hypothetical cyclic isolate that continues to exist after each member object
isfinalizedorcleared. Itisamemoryleakifacyclicisolateprogressesthroughallofthesestages;itshouldvanish
onceallobjectsarecleared,ifnotsooner. Acyclicisolatecanvanisheitherbecausethereferencecycleisbrokenor
becausetheobjectsarenolongerisolatedduetofinalizerresurrection(seetp_finalize).
0. Reachable(notyetacyclicisolate): Allobjectsareintheirnormal,reachablestate. Areferencecyclecould
exist,butanexternalreferencemeanstheobjectsarenotyetisolated.
1. Unreachablebutconsistent: Thefinalreferencefromoutsidethecyclicgroupofobjectshasbeenremoved,
causingtheobjectstobecomeisolated(thusacyclicisolateisborn). Noneofthegroup’sobjectshavebeen
finalizedorclearedyet. Thecyclicisolateremainsatthisstageuntilsomefuturerunofthegarbagecollector
(notnecessarilythenextrunbecausethenextrunmightnotscaneveryobject).
2. Mixoffinalizedandnotfinalized: Objectsinacyclicisolatearefinalizedoneatatime,whichmeansthat
thereisaperiodoftimewhenthecyclicisolateiscomposedofamixoffinalizedandnon-finalizedobjects.
Finalizationorderisunspecified,soitcanappearrandom. Afinalizedobjectmustbehaveinasanemanner
whennon-finalizedobjectsinteractwithit,andanon-finalizedobjectmustbeabletotoleratethefinalization
ofanarbitrarysubsetofitsreferents.
3. Allfinalized: Allobjectsinacyclicisolatearefinalizedbeforeanyofthemarecleared.
4. Mix of finalized and cleared: The objects can be cleared serially or concurrently (but with the GIL held);
eitherway,somewillfinishbeforeothers. Afinalizedobjectmustbeabletotoleratetheclearingofasubset
ofitsreferents. PEP442callsthisstage“cyclictrash”.
5. Leaked: Ifacyclicisolatestillexistsafterallobjectsinthegrouphavebeenfinalizedandcleared,thenthe
objectsremainindefinitelyuncollectable(seegc.garbage). Itisabugifacyclicisolatereachesthisstage—it
meansthetp_clearmethodsoftheparticipatingobjectshavefailedtobreakthereferencecycleasrequired.
Iftp_cleardidnotexist,thenPythonwouldhavenowaytosafelybreakareferencecycle. Simplydestroyingan
objectinacyclicisolatewouldresultinadanglingpointer,triggeringundefinedbehaviorwhenanobjectreferenc-
ing the destroyed object is itself destroyed. The clearing step makes object destruction a two-phase process: first
tp_cleariscalledtopartiallydestroytheobjectsenoughtodetanglethemfromeachother,thentp_deallocis
calledtocompletethedestruction.
Unlikeclearing,finalizationisnotaphaseofdestruction. Afinalizedobjectmuststillbehaveproperlybycontinuing
tofulfillitsdesigncontracts. Anobject’sfinalizerisallowedtoexecutearbitraryPythoncode,andisevenallowedto
preventtheimpendingdestructionbyaddingareference. Thefinalizerisonlyrelatedtodestructionbycallorder—if
itruns,itrunsbeforedestruction,whichstartswithtp_clear(ifcalled)andconcludeswithtp_dealloc.
Thefinalizationstepisnotnecessarytosafelyreclaimtheobjectsinacyclicisolate,butitsexistencemakesiteasier
todesigntypesthatbehaveinasanemannerwhenobjectsarecleared. Clearinganobjectmightnecessarilyleaveit
inabroken,partiallydestroyedstate—itmightbeunsafetocallanyoftheclearedobject’smethodsoraccessanyof
itsattributes. Withfinalization,onlyfinalizedobjectscanpossiblyinteractwithclearedobjects;non-finalizedobjects
areguaranteedtointeractwithonlynon-cleared(butpotentiallyfinalized)objects.
Tosummarizethepossibleinteractions:
• Anon-finalizedobjectmighthavereferencestoorfromnon-finalizedandfinalizedobjects,butnottoorfrom
clearedobjects.
• Afinalizedobjectmighthavereferencestoorfromnon-finalized,finalized,andclearedobjects.
• Aclearedobjectmighthavereferencestoorfromfinalizedandclearedobjects,butnottoorfromnon-finalized
objects.
Without any reference cycles, an object can be simply destroyed once its last reference is deleted; the finalization
andclearingstepsarenotnecessarytosafelyreclaimunusedobjects. However,itcanbeusefultoautomaticallycall
tp_finalizeandtp_clearbeforedestructionanywaybecausetypedesignissimplifiedwhenallobjectsalways
experiencethesameseriesofeventsregardlessofwhethertheyparticipatedinacyclicisolate. Pythoncurrentlyonly
callstp_finalizeandtp_clearasneededtodestroyacyclicisolate;thismaychangeinafutureversion.
300 Chapter13. ObjectImplementationSupport

### 第309页

13.2.3 Functions
Toallocateandfreememory,seeAllocatingObjectsontheHeap.
voidPyObject_CallFinalizer(PyObject*op)
Finalizes the object as described in tp_finalize. Call this function (or
PyObject_CallFinalizerFromDealloc()) instead of calling tp_finalize directly because this
functionmaydeduplicatemultiplecallstotp_finalize. Currently, callsareonlydeduplicatedifthetype
supportsgarbagecollection(i.e.,thePy_TPFLAGS_HAVE_GCflagisset);thismaychangeinthefuture.
intPyObject_CallFinalizerFromDealloc(PyObject*op)
Same as PyObject_CallFinalizer() but meant to be called at the beginning of the object’s destructor
(tp_dealloc). Theremustnotbeanyreferencestotheobject. Iftheobject’sfinalizerresurrectstheobject,
thisfunctionreturns-1;nofurtherdestructionshouldhappen. Otherwise,thisfunctionreturns0anddestruction
cancontinuenormally.
(cid:181) Seealso
tp_deallocforexamplecode.
13.3 Common Object Structures
There are a large number of structures which are used in the definition of object types for Python. This section
describesthesestructuresandhowtheyareused.
13.3.1 Base object types and macros
AllPythonobjectsultimatelyshareasmallnumberoffieldsatthebeginningoftheobject’srepresentationinmemory.
ThesearerepresentedbythePyObjectandPyVarObjecttypes,whicharedefined,inturn,bytheexpansionsof
somemacrosalsoused,whetherdirectlyorindirectly,inthedefinitionofallotherPythonobjects. Additionalmacros
canbefoundunderreferencecounting.
typePyObject
PartoftheLimitedAPI.(OnlysomemembersarepartofthestableABI.)Allobjecttypesareextensionsofthis
type. ThisisatypewhichcontainstheinformationPythonneedstotreatapointertoanobjectasanobject. In
anormal“release”build,itcontainsonlytheobject’sreferencecountandapointertothecorrespondingtype
object. NothingisactuallydeclaredtobeaPyObject,buteverypointertoaPythonobjectcanbecasttoa
PyObject*.
Themembersmustnotbeaccesseddirectly;insteadusemacrossuchasPy_REFCNTandPy_TYPE.
Py_ssize_tob_refcnt
PartoftheStableABI.Theobject’sreferencecount,asreturnedbyPy_REFCNT.Donotusethisfield
directly;insteadusefunctionsandmacrossuchasPy_REFCNT,Py_INCREF()andPy_DecRef().
ThefieldtypemaybedifferentfromPy_ssize_t,dependingonbuildconfigurationandplatform.
PyTypeObject*ob_type
Part of the Stable ABI. The object’s type. Do not use this field directly; use Py_TYPE and
Py_SET_TYPE()instead.
typePyVarObject
PartoftheLimitedAPI.(OnlysomemembersarepartofthestableABI.)AnextensionofPyObjectthatadds
theob_sizefield. Thisisintendedforobjectsthathavesomenotionoflength.
As with PyObject, the members must not be accessed directly; instead use macros such as Py_SIZE,
Py_REFCNTandPy_TYPE.
13.3. CommonObjectStructures 301

| (cid:181) Seealso |
| --- |
| tp_deallocforexamplecode. |

### 第310页

Py_ssize_tob_size
PartoftheStableABI.Asizefield,whosecontentsshouldbeconsideredanobject’sinternalimplemen-
tationdetail.
Donotusethisfielddirectly;usePy_SIZEinstead.
ObjectcreationfunctionssuchasPyObject_NewVar()willgenerallysetthisfieldtotherequestedsize
(numberofitems). Aftercreation,arbitraryvaluescanbestoredinob_sizeusingPy_SET_SIZE.
To get an object’s publicly exposed length, as returned by the Python function len(), use
PyObject_Length()instead.
PyObject_HEAD
Thisisamacrousedwhendeclaringnewtypeswhichrepresentobjectswithoutavaryinglength. ThePyOb-
ject_HEADmacroexpandsto:
PyObject ob_base;
SeedocumentationofPyObjectabove.
PyObject_VAR_HEAD
Thisisamacrousedwhendeclaringnewtypeswhichrepresentobjectswithalengththatvariesfrominstance
toinstance. ThePyObject_VAR_HEADmacroexpandsto:
PyVarObject ob_base;
SeedocumentationofPyVarObjectabove.
PyTypeObjectPyBaseObject_Type
PartoftheStableABI.Thebaseclassofallotherobjects,thesameasobjectinPython.
intPy_Is(PyObject*x,PyObject*y)
PartoftheStableABIsinceversion3.10. Testifthexobjectistheyobject,thesameasx is yinPython.
Addedinversion3.10.
intPy_IsNone(PyObject*x)
PartoftheStableABIsinceversion3.10. TestifanobjectistheNonesingleton,thesameasx is Nonein
Python.
Addedinversion3.10.
intPy_IsTrue(PyObject*x)
PartoftheStableABIsinceversion3.10. TestifanobjectistheTruesingleton,thesameasx is Truein
Python.
Addedinversion3.10.
intPy_IsFalse(PyObject*x)
PartoftheStableABIsinceversion3.10. TestifanobjectistheFalsesingleton,thesameasx is False
inPython.
Addedinversion3.10.
PyTypeObject*Py_TYPE(PyObject*o)
Returnvalue: Borrowedreference. PartoftheStableABIsinceversion3.14. GetthetypeofthePythonobject
o.
Thereturnedreferenceisborrowedfromo. DonotreleaseitwithPy_DECREF()orsimilar.
Changedinversion3.11: Py_TYPE()ischangedtoaninlinestaticfunction. Theparametertypeisnolonger
const PyObject*.
302 Chapter13. ObjectImplementationSupport

### 第311页

intPy_IS_TYPE(PyObject*o,PyTypeObject*type)
Returnnon-zeroiftheobjectotypeistype. Returnzerootherwise. Equivalentto: Py_TYPE(o) == type.
Addedinversion3.9.
voidPy_SET_TYPE(PyObject*o,PyTypeObject*type)
Setthetypeofobjectototype,withoutanycheckingorreferencecounting.
This is a very low-level operation. Consider instead setting the Python attribute __class__ using
PyObject_SetAttrString()orsimilar.
Notethatassigninganincompatibletypecanleadtoundefinedbehavior.
Iftypeisaheaptype,thecallermustcreateanewreferencetoit. Similarly,iftheoldtypeofoisaheaptype,
thecallermustreleaseareferencetothattype.
Addedinversion3.9.
Py_ssize_tPy_SIZE(PyVarObject*o)
Gettheob_sizefieldofo.
Changedinversion3.11: Py_SIZE()ischangedtoaninlinestaticfunction. Theparametertypeisnolonger
const PyVarObject*.
voidPy_SET_SIZE(PyVarObject*o,Py_ssize_tsize)
Settheob_sizefieldofotosize.
Addedinversion3.9.
PyObject_HEAD_INIT(type)
ThisisamacrowhichexpandstoinitializationvaluesforanewPyObjecttype. Thismacroexpandsto:
_PyObject_EXTRA_INIT
1, type,
PyVarObject_HEAD_INIT(type,size)
ThisisamacrowhichexpandstoinitializationvaluesforanewPyVarObjecttype,includingtheob_size
field. Thismacroexpandsto:
_PyObject_EXTRA_INIT
1, type, size,
13.3.2 Implementing functions and methods
typePyCFunction
PartoftheStableABI.TypeofthefunctionsusedtoimplementmostPythoncallablesinC.Functionsofthis
type take two PyObject* parameters and return one such value. If the return value is NULL, an exception
shallhavebeenset. IfnotNULL,thereturnvalueisinterpretedasthereturnvalueofthefunctionasexposed
inPython. Thefunctionmustreturnanewreference.
Thefunctionsignatureis:
PyObject *PyCFunction(PyObject *self,
PyObject *args);
typePyCFunctionWithKeywords
Part of the Stable ABI. Type of the functions used to implement Python callables in C with signature
METH_VARARGS|METH_KEYWORDS.Thefunctionsignatureis:
PyObject *PyCFunctionWithKeywords(PyObject *self,
PyObject *args,
PyObject *kwargs);
13.3. CommonObjectStructures 303

### 第312页

typePyCFunctionFast
PartoftheStableABIsinceversion3.13. TypeofthefunctionsusedtoimplementPythoncallablesinCwith
signatureMETH_FASTCALL.Thefunctionsignatureis:
PyObject *PyCFunctionFast(PyObject *self,
PyObject *const *args,
Py_ssize_t nargs);
typePyCFunctionFastWithKeywords
PartoftheStableABIsinceversion3.13. TypeofthefunctionsusedtoimplementPythoncallablesinCwith
signatureMETH_FASTCALL|METH_KEYWORDS.Thefunctionsignatureis:
PyObject *PyCFunctionFastWithKeywords(PyObject *self,
PyObject *const *args,
Py_ssize_t nargs,
PyObject *kwnames);
typePyCMethod
Type of the functions used to implement Python callables in C with signature METH_METHOD |
METH_FASTCALL|METH_KEYWORDS.Thefunctionsignatureis:
PyObject *PyCMethod(PyObject *self,
PyTypeObject *defining_class,
PyObject *const *args,
Py_ssize_t nargs,
PyObject *kwnames)
Addedinversion3.9.
typePyMethodDef
PartoftheStableABI(includingallmembers). Structureusedtodescribeamethodofanextensiontype. This
structurehasfourfields:
constchar*ml_name
Nameofthemethod.
PyCFunctionml_meth
PointertotheCimplementation.
intml_flags
Flagsbitsindicatinghowthecallshouldbeconstructed.
constchar*ml_doc
Pointstothecontentsofthedocstring.
Theml_methisaCfunctionpointer. Thefunctionsmaybeofdifferenttypes,buttheyalwaysreturnPyObject*.
If the function is not of the PyCFunction, the compiler will require a cast in the method table. Even though
PyCFunction defines the first parameter as PyObject*, it is common that the method implementation uses the
specificCtypeoftheself object.
Theml_flagsfieldisabitfieldwhichcanincludethefollowingflags. Theindividualflagsindicateeitheracalling
conventionorabindingconvention.
Therearethesecallingconventions:
METH_VARARGS
Thisisthetypicalcallingconvention,wherethemethodshavethetypePyCFunction. Thefunctionexpects
two PyObject* values. The first one is the self object for methods; for module functions, it is the module
object. Thesecondparameter(oftencalledargs)isatupleobjectrepresentingallarguments. Thisparameter
istypicallyprocessedusingPyArg_ParseTuple()orPyArg_UnpackTuple().
304 Chapter13. ObjectImplementationSupport

### 第313页

METH_KEYWORDS
Can only be used in certain combinations with other flags: METH_VARARGS | METH_KEYWORDS,
METH_FASTCALL|METH_KEYWORDSandMETH_METHOD|METH_FASTCALL|METH_KEYWORDS.
METH_VARARGS | METH_KEYWORDS
MethodswiththeseflagsmustbeoftypePyCFunctionWithKeywords. Thefunctionexpectsthreeparame-
ters: self,args,kwargswherekwargsisadictionaryofallthekeywordargumentsorpossiblyNULLifthereare
nokeywordarguments. TheparametersaretypicallyprocessedusingPyArg_ParseTupleAndKeywords().
METH_FASTCALL
Fastcallingconventionsupportingonlypositionalarguments. ThemethodshavethetypePyCFunctionFast.
Thefirstparameterisself,thesecondparameterisaCarrayofPyObject*valuesindicatingthearguments
andthethirdparameteristhenumberofarguments(thelengthofthearray).
Addedinversion3.7.
Changedinversion3.10: METH_FASTCALLisnowpartofthestableABI.
METH_FASTCALL | METH_KEYWORDS
Extension of METH_FASTCALL supporting also keyword arguments, with methods of type
PyCFunctionFastWithKeywords. Keyword arguments are passed the same way as in the vectorcall
protocol: thereisanadditionalfourthPyObject*parameterwhichisatuplerepresentingthenamesofthe
keyword arguments (which are guaranteed to be strings) or possibly NULL if there are no keywords. The
valuesofthekeywordargumentsarestoredintheargsarray,afterthepositionalarguments.
Addedinversion3.7.
METH_METHOD
Can only be used in the combination with other flags: METH_METHOD | METH_FASTCALL |
METH_KEYWORDS.
METH_METHOD | METH_FASTCALL | METH_KEYWORDS
Extension of METH_FASTCALL | METH_KEYWORDS supporting the defining class, that is, the class that
containsthemethodinquestion. ThedefiningclassmightbeasuperclassofPy_TYPE(self).
The method needs to be of type PyCMethod, the same as for METH_FASTCALL | METH_KEYWORDS with
defining_classargumentaddedafterself.
Addedinversion3.9.
METH_NOARGS
Methods without parameters don’t need to check whether arguments are given if they are listed with the
METH_NOARGSflag. TheyneedtobeoftypePyCFunction. Thefirstparameteristypicallynamedself and
willholdareferencetothemoduleorobjectinstance. InallcasesthesecondparameterwillbeNULL.
The function must have 2 parameters. Since the second parameter is unused, Py_UNUSED can be used to
preventacompilerwarning.
METH_O
Methods with a single object argument can be listed with the METH_O flag, instead of invoking
PyArg_ParseTuple()witha"O"argument. TheyhavethetypePyCFunction,withtheself parameter,
andaPyObject*parameterrepresentingthesingleargument.
Thesetwoconstantsarenotusedtoindicatethecallingconventionbutthebindingwhenusewithmethodsofclasses.
Thesemaynotbeusedforfunctionsdefinedformodules. Atmostoneoftheseflagsmaybesetforanygivenmethod.
METH_CLASS
Themethodwillbepassedthetypeobjectasthefirstparameterratherthananinstanceofthetype. Thisis
usedtocreateclassmethods,similartowhatiscreatedwhenusingtheclassmethod()built-infunction.
METH_STATIC
The method will be passed NULL as the first parameter rather than an instance of the type. This is used to
createstaticmethods,similartowhatiscreatedwhenusingthestaticmethod()built-infunction.
13.3. CommonObjectStructures 305

### 第314页

Oneotherconstantcontrolswhetheramethodisloadedinplaceofanotherdefinitionwiththesamemethodname.
METH_COEXIST
Themethodwillbeloadedinplaceofexistingdefinitions. WithoutMETH_COEXIST,thedefaultistoskip
repeateddefinitions. Sinceslotwrappersareloadedbeforethemethodtable, theexistenceofa sq_contains
slot,forexample,wouldgenerateawrappedmethodnamed__contains__()andprecludetheloadingof
acorrespondingPyCFunctionwiththesamename. Withtheflagdefined,thePyCFunctionwillbeloadedin
placeofthewrapperobjectandwillco-existwiththeslot. ThisishelpfulbecausecallstoPyCFunctionsare
optimizedmorethanwrapperobjectcalls.
PyObject*PyCMethod_New(PyMethodDef *ml,PyObject*self,PyObject*module,PyTypeObject*cls)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.9. TurnmlintoaPythoncallableobject.
Thecallermustensurethatmloutlivesthecallable. Typically,mlisdefinedasastaticvariable.
TheselfparameterwillbepassedastheselfargumenttotheCfunctioninml->ml_methwheninvoked. self
canbeNULL.
Thecallableobject’s__module__attributecanbesetfromthegivenmoduleargument. moduleshouldbea
Pythonstring,whichwillbeusedasnameofthemodulethefunctionisdefinedin. Ifunavailable,itcanbe
settoNoneorNULL.
(cid:181) Seealso
function.__module__
Theclsparameterwillbepassedasthedefining_classargumenttotheCfunction. MustbesetifMETH_METHOD
issetonml->ml_flags.
Addedinversion3.9.
PyObject*PyCFunction_NewEx(PyMethodDef *ml,PyObject*self,PyObject*module)
Returnvalue: Newreference. PartoftheStableABI.EquivalenttoPyCMethod_New(ml, self, module,
NULL).
PyObject*PyCFunction_New(PyMethodDef *ml,PyObject*self)
Returnvalue: Newreference. PartoftheStableABIsinceversion3.4. EquivalenttoPyCMethod_New(ml,
self, NULL, NULL).
13.3.3 Accessing attributes of extension types
typePyMemberDef
PartoftheStableABI(includingallmembers). Structurewhichdescribesanattributeofatypewhichcorre-
spondstoaCstructmember. Whendefiningaclass,putaNULL-terminatedarrayofthesestructuresinthe
tp_membersslot.
Itsfieldsare,inorder:
constchar*name
Nameofthemember. ANULLvaluemarkstheendofaPyMemberDef[]array.
Thestringshouldbestatic,nocopyismadeofit.
inttype
ThetypeofthememberintheCstruct. SeeMembertypesforthepossiblevalues.
Py_ssize_toffset
Theoffsetinbytesthatthememberislocatedonthetype’sobjectstruct.
intflags
ZeroormoreoftheMemberflags,combinedusingbitwiseOR.
306 Chapter13. ObjectImplementationSupport

| (cid:181) Seealso |
| --- |
| function.__module__ |

### 第315页

constchar*doc
Thedocstring,orNULL.Thestringshouldbestatic,nocopyismadeofit. Typically,itisdefinedusing
PyDoc_STR.
By default (when flags is 0), members allow both read and write access. Use the Py_READONLY flag for
read-only access. Certain types, like Py_T_STRING, imply Py_READONLY. Only Py_T_OBJECT_EX (and
legacyT_OBJECT)memberscanbedeleted.
Forheap-allocatedtypes(createdusingPyType_FromSpec()orsimilar),PyMemberDefmaycontainadef-
inition for the special member "__vectorcalloffset__", corresponding to tp_vectorcall_offset
in type objects. This member must be defined with Py_T_PYSSIZET, and either Py_READONLY or
Py_READONLY | Py_RELATIVE_OFFSET.Forexample:
static PyMemberDef spam_type_members[] = {
{"__vectorcalloffset__", Py_T_PYSSIZET,
offsetof(Spam_object, vectorcall), Py_READONLY},
{NULL} /* Sentinel */
};
(Youmayneedto#include <stddef.h>foroffsetof().)
The legacy offsets tp_dictoffset and tp_weaklistoffset can be defined similarly using
"__dictoffset__" and "__weaklistoffset__" members, but extensions are strongly encouraged to
usePy_TPFLAGS_MANAGED_DICTandPy_TPFLAGS_MANAGED_WEAKREFinstead.
Changed in version 3.12: PyMemberDef is always available. Previously, it required including
"structmember.h".
Changed in version 3.14: Py_RELATIVE_OFFSET is now allowed for "__vectorcalloffset__",
"__dictoffset__"and"__weaklistoffset__".
PyObject*PyMember_GetOne(constchar*obj_addr,structPyMemberDef *m)
PartoftheStableABI.Getanattributebelongingtotheobjectataddressobj_addr. Theattributeisdescribed
byPyMemberDefm. ReturnsNULLonerror.
Changed in version 3.12: PyMember_GetOne is always available. Previously, it required including
"structmember.h".
intPyMember_SetOne(char*obj_addr,structPyMemberDef *m,PyObject*o)
PartoftheStableABI.Setanattributebelongingtotheobjectataddressobj_addrtoobjecto. Theattribute
tosetisdescribedbyPyMemberDefm. Returns0ifsuccessfulandanegativevalueonfailure.
Changed in version 3.12: PyMember_SetOne is always available. Previously, it required including
"structmember.h".
Memberflags
ThefollowingflagscanbeusedwithPyMemberDef.flags:
Py_READONLY
Notwritable.
Py_AUDIT_READ
Emitanobject.__getattr__auditeventbeforereading.
Py_RELATIVE_OFFSET
IndicatesthattheoffsetofthisPyMemberDefentryindicatesanoffsetfromthesubclass-specificdata,rather
thanfromPyObject.
CanonlybeusedaspartofPy_tp_membersslotwhencreatingaclassusingnegativebasicsize. Itis
mandatoryinthatcase.
This flag is only used in PyType_Slot. When setting tp_members during class creation, Python clears it
andsetsPyMemberDef.offsettotheoffsetfromthePyObjectstruct.
13.3. CommonObjectStructures 307

### 第316页

Changed in version 3.10: The RESTRICTED, READ_RESTRICTED and WRITE_RESTRICTED macros available
with #include "structmember.h" are deprecated. READ_RESTRICTED and RESTRICTED are equivalent to
Py_AUDIT_READ;WRITE_RESTRICTEDdoesnothing.
Changedinversion3.12: TheREADONLYmacrowasrenamedtoPy_READONLY.ThePY_AUDIT_READmacrowas
renamed with the Py_ prefix. The new names are now always available. Previously, these required #include
"structmember.h". Theheaderisstillavailableanditprovidestheoldnames.
Membertypes
PyMemberDef.typecanbeoneofthefollowingmacroscorrespondingtovariousCtypes. Whenthememberis
accessedinPython,itwillbeconvertedtotheequivalentPythontype. WhenitissetfromPython,itwillbeconverted
backtotheCtype. Ifthatisnotpossible,anexceptionsuchasTypeErrororValueErrorisraised.
Unlessmarked(D),attributesdefinedthiswaycannotbedeletedusinge.g. delordelattr().
308 Chapter13. ObjectImplementationSupport

### 第317页

Macroname Ctype Pythontype
char int
Py_T_BYTE
short int
Py_T_SHORT
int int
Py_T_INT
long int
Py_T_LONG
long long int
Py_T_LONGLONG
unsigned char int
Py_T_UBYTE
unsigned int int
Py_T_UINT
unsigned short int
Py_T_USHORT
unsigned long int
Py_T_ULONG
unsigned long long int
Py_T_ULONGLONG
Py_ssize_t int
Py_T_PYSSIZET
float float
Py_T_FLOAT
double float
Py_T_DOUBLE
char(writtenas0or1) bool
Py_T_BOOL
const char*(*) str(RO)
Py_T_STRING
const char[](*) str(RO)
Py_T_STRING_INPLACE
char(0-127) str(**)
Py_T_CHAR
PyObject* object(D)
Py_T_OBJECT_EX
(*): Zero-terminated,UTF8-encodedCstring. WithPy_T_STRINGtheCrepresentationisapointer;
withPy_T_STRING_INPLACEthestringisstoreddirectlyinthestructure.
13.3. CommonObjectStructures 309

| Macroname | Ctype | Pythontype |
| --- | --- | --- |
| Py_T_BYTE | char | int |
| Py_T_SHORT | short | int |
| Py_T_INT | int | int |
| Py_T_LONG | long | int |
| Py_T_LONGLONG | long long | int |
| Py_T_UBYTE | unsigned char | int |
| Py_T_UINT | unsigned int | int |
| Py_T_USHORT | unsigned short | int |
| Py_T_ULONG | unsigned long | int |
| Py_T_ULONGLONG | unsigned long long | int |
| Py_T_PYSSIZET | Py_ssize_t | int |
| Py_T_FLOAT | float | float |
| Py_T_DOUBLE | double | float |
| Py_T_BOOL | char(writtenas0or1) | bool |
| Py_T_STRING | const char*(*) | str(RO) |
| Py_T_STRING_INPLACE | const char[](*) | str(RO) |
| Py_T_CHAR | char(0-127) | str(**) |
| Py_T_OBJECT_EX | PyObject* | object(D) |

### 第318页

(**): Stringoflength1. OnlyASCIIisaccepted.
(RO):ImpliesPy_READONLY.
(D): Can be deleted, in which case the pointer is set to NULL. Reading a NULL pointer raises
AttributeError.
Addedinversion3.12: Inpreviousversions,themacroswereonlyavailablewith#include "structmember.h"
and were named without the Py_ prefix (e.g. as T_INT). The header is still available and contains the old names,
alongwiththefollowingdeprecatedtypes:
T_OBJECT
LikePy_T_OBJECT_EX,butNULLisconvertedtoNone. ThisresultsinsurprisingbehaviorinPython:deleting
theattributeeffectivelysetsittoNone.
T_NONE
AlwaysNone. MustbeusedwithPy_READONLY.
DefiningGettersandSetters
typePyGetSetDef
PartoftheStableABI(includingallmembers). Structuretodefineproperty-likeaccessforatype. Seealso
descriptionofthePyTypeObject.tp_getsetslot.
constchar*name
attributename
getterget
Cfunctiontogettheattribute.
setterset
OptionalCfunctiontosetordeletetheattribute. IfNULL,theattributeisread-only.
constchar*doc
optionaldocstring
void*closure
Optionaluserdatapointer,providingadditionaldataforgetterandsetter.
typedefPyObject*(*getter)(PyObject*,void*)
Part of the Stable ABI. The get function takes one PyObject* parameter (the instance) and a user data
pointer(theassociatedclosure):
ItshouldreturnanewreferenceonsuccessorNULLwithasetexceptiononfailure.
typedefint(*setter)(PyObject*,PyObject*,void*)
PartoftheStableABI.setfunctionstaketwoPyObject*parameters(theinstanceandthevaluetobeset)
andauserdatapointer(theassociatedclosure):
IncasetheattributeshouldbedeletedthesecondparameterisNULL.Shouldreturn0onsuccessor-1witha
setexceptiononfailure.
13.4 Type Object Structures
PerhapsoneofthemostimportantstructuresofthePythonobjectsystemisthestructurethatdefinesanewtype:
thePyTypeObjectstructure. TypeobjectscanbehandledusinganyofthePyObject_*orPyType_*functions,
butdonotoffermuchthat’sinterestingtomostPythonapplications. Theseobjectsarefundamentaltohowobjects
behave,sotheyareveryimportanttotheinterpreteritselfandtoanyextensionmodulethatimplementsnewtypes.
Typeobjectsarefairlylargecomparedtomostofthestandardtypes. Thereasonforthesizeisthateachtypeobject
stores a large number of values, mostly C function pointers, each of which implements a small part of the type’s
functionality. Thefieldsofthetypeobjectareexaminedindetailinthissection. Thefieldswillbedescribedinthe
orderinwhichtheyoccurinthestructure.
310 Chapter13. ObjectImplementationSupport

### 第319页

Inadditiontothefollowingquickreference,theExamplessectionprovidesat-a-glanceinsightintothemeaningand
useofPyTypeObject.
13.4.1 Quick Reference
“tpslots”
PyTypeObjectSlotPage312,1 Type specialmethods/attrs InfoPage31
O T D I
<R>tp_name constchar* __name__ X X
tp_basicsize Py_ssize_t X X X
tp_itemsize Py_ssize_t X X
tp_dealloc destructor X X X
tp_vectorcall_offset Py_ssize_t X X
(tp_getattr) getattrfunc __getattribute__,__getattr__ G
(tp_setattr) setattrfunc __setattr__,__delattr__ G
tp_as_async PyAsyncMethods* sub-slots %
tp_repr reprfunc __repr__ X X X
tp_as_number PyNumberMethods* sub-slots %
tp_as_sequence PySequenceMethods* sub-slots %
tp_as_mapping PyMappingMethods* sub-slots %
tp_hash hashfunc __hash__ X G
tp_call ternaryfunc __call__ X X
tp_str reprfunc __str__ X X
tp_getattro getattrofunc __getattribute__,__getattr__ X X G
tp_setattro setattrofunc __setattr__,__delattr__ X X G
tp_as_buffer PyBufferProcs* sub-slots %
tp_flags unsignedlong X X ?
tp_doc constchar* __doc__ X X
tp_traverse traverseproc X G
tp_clear inquiry X G
tp_richcompare richcmpfunc __lt__,__le__,__eq__,__ne__, X G
__gt__,__ge__
(tp_weaklistoffset) Py_ssize_t X ?
tp_iter getiterfunc __iter__ X
tp_iternext iternextfunc __next__ X
tp_methods PyMethodDef [] X X
tp_members PyMemberDef [] X
tp_getset PyGetSetDef [] X X
tp_base PyTypeObject* __base__ X
tp_dict PyObject* __dict__ ?
tp_descr_get descrgetfunc __get__ X
tp_descr_set descrsetfunc __set__,__delete__ X
(tp_dictoffset) Py_ssize_t X ?
tp_init initproc __init__ X X X
tp_alloc allocfunc X ? ?
tp_new newfunc __new__ X X ? ?
tp_free freefunc X X ? ?
tp_is_gc inquiry X X
<tp_bases> PyObject* __bases__ ~
<tp_mro> PyObject* __mro__ ~
[tp_cache] PyObject*
[tp_subclasses] void* __subclasses__
[tp_weaklist] PyObject*
(tp_del) destructor
[tp_version_tag] unsignedint
continuesonnextpage
13.4. TypeObjectStructures 311

|  | In | fo | Page |
| --- | --- | --- | --- |


| <R>tp_name | constchar* | __name__ | X | X |  |  |
| --- | --- | --- | --- | --- | --- | --- |
| tp_basicsize | Py_ssize_t |  | X | X |  | X |
| tp_itemsize | Py_ssize_t |  |  | X |  | X |
| tp_dealloc | destructor |  | X | X |  | X |
| tp_vectorcall_offset | Py_ssize_t |  |  | X |  | X |
| (tp_getattr) | getattrfunc | __getattribute__,__getattr__ |  |  |  | G |
| (tp_setattr) | setattrfunc | __setattr__,__delattr__ |  |  |  | G |
| tp_as_async | PyAsyncMethods* | sub-slots |  |  |  | % |
| tp_repr | reprfunc | __repr__ | X | X |  | X |
| tp_as_number | PyNumberMethods* | sub-slots |  |  |  | % |
| tp_as_sequence | PySequenceMethods* | sub-slots |  |  |  | % |
| tp_as_mapping | PyMappingMethods* | sub-slots |  |  |  | % |
| tp_hash | hashfunc | __hash__ | X |  |  | G |
| tp_call | ternaryfunc | __call__ |  | X |  | X |
| tp_str | reprfunc | __str__ | X |  |  | X |
| tp_getattro | getattrofunc | __getattribute__,__getattr__ | X | X |  | G |
| tp_setattro | setattrofunc | __setattr__,__delattr__ | X | X |  | G |
| tp_as_buffer | PyBufferProcs* | sub-slots |  |  |  | % |
| tp_flags | unsignedlong |  | X | X |  | ? |
| tp_doc | constchar* | __doc__ | X | X |  |  |
| tp_traverse | traverseproc |  |  | X |  | G |
| tp_clear | inquiry |  |  | X |  | G |
| tp_richcompare | richcmpfunc | __lt__,__le__,__eq__,__ne__,
__gt__,__ge__ | X |  |  | G |
| (tp_weaklistoffset) | Py_ssize_t |  |  | X |  | ? |
| tp_iter | getiterfunc | __iter__ |  |  |  | X |
| tp_iternext | iternextfunc | __next__ |  |  |  | X |
| tp_methods | PyMethodDef [] |  | X | X |  |  |
| tp_members | PyMemberDef [] |  |  | X |  |  |
| tp_getset | PyGetSetDef [] |  | X | X |  |  |
| tp_base | PyTypeObject* | __base__ |  |  | X |  |
| tp_dict | PyObject* | __dict__ |  |  | ? |  |
| tp_descr_get | descrgetfunc | __get__ |  |  |  | X |
| tp_descr_set | descrsetfunc | __set__,__delete__ |  |  |  | X |
| (tp_dictoffset) | Py_ssize_t |  |  | X |  | ? |
| tp_init | initproc | __init__ | X | X |  | X |
| tp_alloc | allocfunc |  | X |  | ? | ? |
| tp_new | newfunc | __new__ | X | X | ? | ? |
| tp_free | freefunc |  | X | X | ? | ? |
| tp_is_gc | inquiry |  |  | X |  | X |
| <tp_bases> | PyObject* | __bases__ |  |  | ~ |  |
| <tp_mro> | PyObject* | __mro__ |  |  | ~ |  |
| [tp_cache] | PyObject* |  |  |  |  |  |
| [tp_subclasses] | void* | __subclasses__ |  |  |  |  |
| [tp_weaklist] | PyObject* |  |  |  |  |  |
| (tp_del) | destructor |  |  |  |  |  |
| [tp_version_tag] | unsignedint |  |  |  |  |  |

### 第320页

Table 1–continuedfrompreviouspage
PyTypeObjectSlot1 Type specialmethods/attrs Info2
O T D I
tp_finalize destructor __del__ X
tp_vectorcall vectorcallfunc
[tp_watched] unsignedchar
sub-slots
Slot Type specialmethods
am_await unaryfunc __await__
am_aiter unaryfunc __aiter__
am_anext unaryfunc __anext__
am_send sendfunc
nb_add binaryfunc __add____radd__
nb_inplace_add binaryfunc __iadd__
nb_subtract binaryfunc __sub____rsub__
nb_inplace_subtract binaryfunc __isub__
nb_multiply binaryfunc __mul____rmul__
nb_inplace_multiply binaryfunc __imul__
nb_remainder binaryfunc __mod____rmod__
nb_inplace_remainder binaryfunc __imod__
nb_divmod binaryfunc __divmod__ __rdiv-
mod__
nb_power ternaryfunc __pow____rpow__
nb_inplace_power ternaryfunc __ipow__
nb_negative unaryfunc __neg__
nb_positive unaryfunc __pos__
nb_absolute unaryfunc __abs__
nb_bool inquiry __bool__
nb_invert unaryfunc __invert__
nb_lshift binaryfunc __lshift____rlshift__
nb_inplace_lshift binaryfunc __ilshift__
nb_rshift binaryfunc __rshift__
__rrshift__
nb_inplace_rshift binaryfunc __irshift__
continuesonnextpage
1():Aslotnameinparenthesesindicatesitis(effectively)deprecated.
<>:NamesinanglebracketsshouldbeinitiallysettoNULLandtreatedasread-only.
[]:Namesinsquarebracketsareforinternaluseonly.
<R>(asaprefix)meansthefieldisrequired(mustbenon-NULL).
2Columns:
“O”:setonPyBaseObject_Type
“T”:setonPyType_Type
“D”:default(ifslotissettoNULL)
X - PyType_Ready sets this value if it is NULL
~ - PyType_Ready always sets this value (it should be NULL)
? - PyType_Ready may set this value depending on other slots
Also see the inheritance column ("I").
“I”:inheritance
X - type slot is inherited via *PyType_Ready* if defined with a *NULL* value
% - the slots of the sub-struct are inherited individually
G - inherited, but only in combination with other slots; see the slot's description
? - it's complicated; see the slot's description
Notethatsomeslotsareeffectivelyinheritedthroughthenormalattributelookupchain.
312 Chapter13. ObjectImplementationSupport

|  | In | fo | 2 |
| --- | --- | --- | --- |


| tp_finalize | destructor | __del__ |  |  |  | X |
| --- | --- | --- | --- | --- | --- | --- |
| tp_vectorcall | vectorcallfunc |  |  |  |  |  |
| [tp_watched] | unsignedchar |  |  |  |  |  |


| Slot | Type | specialmethods |
| --- | --- | --- |
| am_await | unaryfunc | __await__ |
| am_aiter | unaryfunc | __aiter__ |
| am_anext | unaryfunc | __anext__ |
| am_send | sendfunc |  |
|  |  |  |
| nb_add | binaryfunc | __add____radd__ |
| nb_inplace_add | binaryfunc | __iadd__ |
| nb_subtract | binaryfunc | __sub____rsub__ |
| nb_inplace_subtract | binaryfunc | __isub__ |
| nb_multiply | binaryfunc | __mul____rmul__ |
| nb_inplace_multiply | binaryfunc | __imul__ |
| nb_remainder | binaryfunc | __mod____rmod__ |
| nb_inplace_remainder | binaryfunc | __imod__ |
| nb_divmod | binaryfunc | __divmod__ __rdiv-
mod__ |
| nb_power | ternaryfunc | __pow____rpow__ |
| nb_inplace_power | ternaryfunc | __ipow__ |
| nb_negative | unaryfunc | __neg__ |
| nb_positive | unaryfunc | __pos__ |
| nb_absolute | unaryfunc | __abs__ |
| nb_bool | inquiry | __bool__ |
| nb_invert | unaryfunc | __invert__ |
| nb_lshift | binaryfunc | __lshift____rlshift__ |
| nb_inplace_lshift | binaryfunc | __ilshift__ |
| nb_rshift | binaryfunc | __rshift__
__rrshift__ |
| nb_inplace_rshift | binaryfunc | __irshift__ |

### 第321页

Table 2–continuedfrompreviouspage
Slot Type specialmethods
nb_and binaryfunc __and____rand__
nb_inplace_and binaryfunc __iand__
nb_xor binaryfunc __xor____rxor__
nb_inplace_xor binaryfunc __ixor__
nb_or binaryfunc __or____ror__
nb_inplace_or binaryfunc __ior__
nb_int unaryfunc __int__
nb_reserved void*
nb_float unaryfunc __float__
nb_floor_divide binaryfunc __floordiv__
nb_inplace_floor_divide binaryfunc __ifloordiv__
nb_true_divide binaryfunc __truediv__
nb_inplace_true_divide binaryfunc __itruediv__
nb_index unaryfunc __index__
nb_matrix_multiply binaryfunc __matmul__ __rmat-
mul__
nb_inplace_matrix_multiply binaryfunc __imatmul__
mp_length lenfunc __len__
mp_subscript binaryfunc __getitem__
mp_ass_subscript objobjargproc __setitem__,
__delitem__
sq_length lenfunc __len__
sq_concat binaryfunc __add__
sq_repeat ssizeargfunc __mul__
sq_item ssizeargfunc __getitem__
sq_ass_item ssizeobjargproc __setitem__
__delitem__
sq_contains objobjproc __contains__
sq_inplace_concat binaryfunc __iadd__
sq_inplace_repeat ssizeargfunc __imul__
bf_getbuffer getbufferproc() __buffer__
bf_releasebuffer releasebufferproc() __release_buffer__
13.4. TypeObjectStructures 313

| Slot | Type | specialmethods |
| --- | --- | --- |
| nb_and | binaryfunc | __and____rand__ |
| nb_inplace_and | binaryfunc | __iand__ |
| nb_xor | binaryfunc | __xor____rxor__ |
| nb_inplace_xor | binaryfunc | __ixor__ |
| nb_or | binaryfunc | __or____ror__ |
| nb_inplace_or | binaryfunc | __ior__ |
| nb_int | unaryfunc | __int__ |
| nb_reserved | void* |  |
| nb_float | unaryfunc | __float__ |
| nb_floor_divide | binaryfunc | __floordiv__ |
| nb_inplace_floor_divide | binaryfunc | __ifloordiv__ |
| nb_true_divide | binaryfunc | __truediv__ |
| nb_inplace_true_divide | binaryfunc | __itruediv__ |
| nb_index | unaryfunc | __index__ |
| nb_matrix_multiply | binaryfunc | __matmul__ __rmat-
mul__ |
| nb_inplace_matrix_multiply | binaryfunc | __imatmul__ |
|  |  |  |
| mp_length | lenfunc | __len__ |
| mp_subscript | binaryfunc | __getitem__ |
| mp_ass_subscript | objobjargproc | __setitem__,
__delitem__ |
|  |  |  |
| sq_length | lenfunc | __len__ |
| sq_concat | binaryfunc | __add__ |
| sq_repeat | ssizeargfunc | __mul__ |
| sq_item | ssizeargfunc | __getitem__ |
| sq_ass_item | ssizeobjargproc | __setitem__
__delitem__ |
| sq_contains | objobjproc | __contains__ |
| sq_inplace_concat | binaryfunc | __iadd__ |
| sq_inplace_repeat | ssizeargfunc | __imul__ |
|  |  |  |
| bf_getbuffer | getbufferproc() | __buffer__ |
| bf_releasebuffer | releasebufferproc() | __release_buffer__ |

### 第322页

slottypedefs
typedef ParameterTypes ReturnType
allocfunc PyObject*
PyTypeObject*
Py_ssize_t
destructor PyObject* void
freefunc void* void
traverseproc int
PyObject*
visitproc
void*
newfunc PyObject*
PyTypeObject*
PyObject*
PyObject*
initproc int
PyObject*
PyObject*
PyObject*
reprfunc PyObject* PyObject*
getattrfunc PyObject*
PyObject*
constchar*
setattrfunc int
PyObject*
constchar*
PyObject*
getattrofunc PyObject*
PyObject*
PyObject*
setattrofunc int
PyObject*
PyObject*
PyObject*
descrgetfunc PyObject*
PyObject*
PyObject*
PyObject*
descrsetfunc int
PyObject*
PyObject*
314 Chapter13. ObjectImplementationSupport

| typedef | ParameterTypes | ReturnType |
| --- | --- | --- |
| allocfunc | PyTypeObject*
Py_ssize_t | PyObject* |
| destructor | PyObject* | void |
| freefunc | void* | void |
| traverseproc | PyObject*
visitproc
void* | int |
| newfunc | PyTypeObject*
PyObject*
PyObject* | PyObject* |
| initproc | PyObject*
PyObject*
PyObject* | int |
| reprfunc | PyObject* | PyObject* |
| getattrfunc | PyObject*
constchar* | PyObject* |
| setattrfunc | PyObject*
constchar*
PyObject* | int |
| getattrofunc | PyObject*
PyObject* | PyObject* |
| setattrofunc | PyObject*
PyObject*
PyObject* | int |
| descrgetfunc | PyObject*
PyObject*
PyObject* | PyObject* |
| descrsetfunc | PyObject*
PyObject* | int |
| 314 | Chapter13. | ObjectImplementationSupport |

### 第323页

SeeSlotTypetypedefsbelowformoredetail.
13.4.2 PyTypeObject Definition
ThestructuredefinitionforPyTypeObjectcanbefoundinInclude/cpython/object.h. Forconvenienceof
reference,thisrepeatsthedefinitionfoundthere:
typedef struct _typeobject {
PyObject_VAR_HEAD
const char *tp_name; /* For printing, in format "<module>.<name>" */
Py_ssize_t tp_basicsize, tp_itemsize; /* For allocation */
/* Methods to implement standard operations */
destructor tp_dealloc;
Py_ssize_t tp_vectorcall_offset;
getattrfunc tp_getattr;
setattrfunc tp_setattr;
PyAsyncMethods *tp_as_async; /* formerly known as tp_compare (Python 2)
or tp_reserved (Python 3) */
reprfunc tp_repr;
/* Method suites for standard classes */
PyNumberMethods *tp_as_number;
PySequenceMethods *tp_as_sequence;
PyMappingMethods *tp_as_mapping;
/* More standard operations (here for binary compatibility) */
hashfunc tp_hash;
ternaryfunc tp_call;
reprfunc tp_str;
getattrofunc tp_getattro;
setattrofunc tp_setattro;
/* Functions to access object as input/output buffer */
PyBufferProcs *tp_as_buffer;
/* Flags to define presence of optional/expanded features */
unsigned long tp_flags;
const char *tp_doc; /* Documentation string */
/* Assigned meaning in release 2.0 */
/* call function for all accessible objects */
traverseproc tp_traverse;
/* delete references to contained objects */
inquiry tp_clear;
/* Assigned meaning in release 2.1 */
/* rich comparisons */
richcmpfunc tp_richcompare;
/* weak reference enabler */
Py_ssize_t tp_weaklistoffset;
(continuesonnextpage)
13.4. TypeObjectStructures 315

### 第324页

(continuedfrompreviouspage)
/* Iterators */
getiterfunc tp_iter;
iternextfunc tp_iternext;
/* Attribute descriptor and subclassing stuff */
PyMethodDef *tp_methods;
PyMemberDef *tp_members;
PyGetSetDef *tp_getset;
// Strong reference on a heap type, borrowed reference on a static type
PyTypeObject *tp_base;
PyObject *tp_dict;
descrgetfunc tp_descr_get;
descrsetfunc tp_descr_set;
Py_ssize_t tp_dictoffset;
initproc tp_init;
allocfunc tp_alloc;
newfunc tp_new;
freefunc tp_free; /* Low-level free-memory routine */
inquiry tp_is_gc; /* For PyObject_IS_GC */
PyObject *tp_bases;
PyObject *tp_mro; /* method resolution order */
PyObject *tp_cache; /* no longer used */
void *tp_subclasses; /* for static builtin types this is an index */
PyObject *tp_weaklist; /* not used for static builtin types */
destructor tp_del;
/* Type attribute cache version tag. Added in version 2.6.
* If zero, the cache is invalid and must be initialized.
*/
unsigned int tp_version_tag;
destructor tp_finalize;
vectorcallfunc tp_vectorcall;
/* bitset of which type-watchers care about this type */
unsigned char tp_watched;
/* Number of tp_version_tag values used.
* Set to _Py_ATTR_CACHE_UNUSED if the attribute cache is
* disabled for this type (e.g. due to custom MRO entries).
* Otherwise, limited to MAX_VERSIONS_PER_CLASS (defined elsewhere).
*/
uint16_t tp_versions_used;
} PyTypeObject;
13.4.3 PyObject Slots
ThetypeobjectstructureextendsthePyVarObjectstructure. Theob_sizefieldisusedfordynamictypes(cre-
ated by type_new(), usually called from a class statement). Note that PyType_Type (the metatype) initializes
tp_itemsize,whichmeansthatitsinstances(i.e. typeobjects)musthavetheob_sizefield.
PyObject.ob_refcnt
Thetypeobject’sreferencecountisinitializedto1bythePyObject_HEAD_INITmacro. Notethatfor
staticallyallocatedtypeobjects,thetype’sinstances(objectswhoseob_typepointsbacktothetype)do
notcountasreferences. Butfordynamicallyallocatedtypeobjects,theinstancesdocountasreferences.
Inheritance:
316 Chapter13. ObjectImplementationSupport

### 第325页

Thisfieldisnotinheritedbysubtypes.
PyObject.ob_type
This is the type’s type, in other words its metatype. It is initialized by the argument to the
PyObject_HEAD_INIT macro, and its value should normally be &PyType_Type. However, for
dynamically loadable extension modules that must be usable on Windows (at least), the compiler
complains that this is not a valid initializer. Therefore, the convention is to pass NULL to the
PyObject_HEAD_INITmacroandtoinitializethisfieldexplicitlyatthestartofthemodule’sinitial-
izationfunction,beforedoinganythingelse. Thisistypicallydonelikethis:
Foo_Type.ob_type = &PyType_Type;
Thisshouldbedonebeforeanyinstancesofthetypearecreated. PyType_Ready()checksifob_type
isNULL,andifso,initializesittotheob_typefieldofthebaseclass. PyType_Ready()willnotchange
thisfieldifitisnon-zero.
Inheritance:
Thisfieldisinheritedbysubtypes.
13.4.4 PyVarObject Slots
PyVarObject.ob_size
For statically allocated type objects, this should be initialized to zero. For dynamically allocated type
objects,thisfieldhasaspecialinternalmeaning.
ThisfieldshouldbeaccessedusingthePy_SIZE()macro.
Inheritance:
Thisfieldisnotinheritedbysubtypes.
13.4.5 PyTypeObject Slots
Eachslothasasectiondescribinginheritance. IfPyType_Ready()maysetavaluewhenthefieldissettoNULL
thentherewillalsobea“Default”section. (NotethatmanyfieldssetonPyBaseObject_TypeandPyType_Type
effectivelyactasdefaults.)
constchar*PyTypeObject.tp_name
PointertoaNUL-terminatedstringcontainingthenameofthetype. Fortypesthatareaccessibleasmodule
globals,thestringshouldbethefullmodulename,followedbyadot,followedbythetypename;forbuilt-in
types, itshouldbejustthetypename. Ifthemoduleisasubmoduleofapackage, thefullpackagenameis
partofthefullmodulename. Forexample,atypenamedTdefinedinmoduleMinsubpackageQinpackage
Pshouldhavethetp_nameinitializer"P.Q.M.T".
Fordynamicallyallocatedtypeobjects,thisshouldjustbethetypename,andthemodulenameexplicitlystored
inthetypedictasthevalueforkey'__module__'.
For statically allocated type objects, the tp_name field should contain a dot. Everything before the last dot
is made accessible as the __module__ attribute, and everything after the last dot is made accessible as the
__name__attribute.
If no dot is present, the entire tp_name field is made accessible as the __name__ attribute, and the
__module__attributeisundefined(unlessexplicitlysetinthedictionary, asexplainedabove). Thismeans
your type will be impossible to pickle. Additionally, it will not be listed in module documentations created
withpydoc.
This field must not be NULL. It is the only required field in PyTypeObject() (other than potentially
tp_itemsize).
Inheritance:
Thisfieldisnotinheritedbysubtypes.
13.4. TypeObjectStructures 317

### 第326页

Py_ssize_tPyTypeObject.tp_basicsize
Py_ssize_tPyTypeObject.tp_itemsize
Thesefieldsallowcalculatingthesizeinbytesofinstancesofthetype.
There are two kinds of types: types with fixed-length instances have a zero tp_itemsize field, types
with variable-length instances have a non-zero tp_itemsize field. For a type with fixed-length instances,
all instances have the same size, given in tp_basicsize. (Exceptions to this rule can be made using
PyUnstable_Object_GC_NewWithExtraData().)
Foratypewithvariable-lengthinstances,theinstancesmusthaveanob_sizefield,andtheinstancesizeis
tp_basicsizeplusNtimestp_itemsize,whereNisthe“length”oftheobject.
Functions like PyObject_NewVar() will take the value of N as an argument, and store in the instance’s
ob_sizefield. Notethattheob_sizefieldmaylaterbeusedforotherpurposes. Forexample,intinstances
use the bits of ob_size in an implementation-defined way; the underlying storage and its size should be
accessedusingPyLong_Export().
(cid:174) Note
Theob_sizefieldshouldbeaccessedusingthePy_SIZE()andPy_SET_SIZE()macros.
Also,thepresenceofanob_sizefieldintheinstancelayoutdoesn’tmeanthattheinstancestructureisvariable-
length. Forexample,thelisttypehasfixed-lengthinstances,yetthoseinstanceshaveaob_sizefield. (As
withint,avoidreadinglists’ob_sizedirectly. CallPyList_Size()instead.)
Thetp_basicsizeincludessizeneededfordataofthetype’stp_base,plusanyextradataneededbyeach
instance.
Thecorrectwaytosettp_basicsizeistousethesizeofoperatoronthestructusedtodeclaretheinstance
layout. Thisstructmustincludethestructusedtodeclarethebasetype. Inotherwords,tp_basicsizemust
begreaterthanorequaltothebase’stp_basicsize.
Since every type is a subtype of object, this struct must include PyObject or PyVarObject (depend-
ingonwhetherob_sizeshouldbeincluded). TheseareusuallydefinedbythemacroPyObject_HEADor
PyObject_VAR_HEAD,respectively.
ThebasicsizedoesnotincludetheGCheadersize,asthatheaderisnotpartofPyObject_HEAD.
For cases where struct used to declare the base type is unknown, see PyType_Spec.basicsize and
PyType_FromMetaclass().
Notesaboutalignment:
• tp_basicsizemustbeamultipleof_Alignof(PyObject). Whenusingsizeofonastructthat
includesPyObject_HEAD,asrecommended,thecompilerensuresthis. WhennotusingaCstruct,
orwhenusingcompilerextensionslike__attribute__((packed)),itisuptoyou.
• Ifthevariableitemsrequireaparticularalignment,tp_basicsizeandtp_itemsizemusteachbea
multipleofthatalignment. Forexample,ifatype’svariablepartstoresadouble,itisyourresponsibility
thatbothfieldsareamultipleof_Alignof(double).
Inheritance:
Thesefieldsareinheritedseparatelybysubtypes. (Thatis, ifthefieldissettozero, PyType_Ready()will
copythevaluefromthebasetype,indicatingthattheinstancesdonotneedadditionalstorage.)
If the base type has a non-zero tp_itemsize, it is generally not safe to set tp_itemsize to a different
non-zerovalueinasubtype(thoughthisdependsontheimplementationofthebasetype).
destructorPyTypeObject.tp_dealloc
Apointertotheinstancedestructorfunction. Thefunctionsignatureis:
void tp_dealloc(PyObject *self);
318 Chapter13. ObjectImplementationSupport

### 第327页

Thedestructorfunctionshouldremoveallreferenceswhichtheinstanceowns(e.g.,callPy_CLEAR()),free
allmemorybuffersownedbytheinstance,andcallthetype’stp_freefunctiontofreetheobjectitself.
Ifyoumaycallfunctionsthatmaysettheerrorindicator,youmustusePyErr_GetRaisedException()and
PyErr_SetRaisedException()toensureyoudon’tclobberapreexistingerrorindicator(thedeallocation
couldhaveoccurredwhileprocessingadifferenterror):
static void
foo_dealloc(foo_object *self)
{
PyObject *et, *ev, *etb;
PyObject *exc = PyErr_GetRaisedException();
...
PyErr_SetRaisedException(exc);
}
The dealloc handler itself must not raise an exception; if it hits an error case it should call
PyErr_FormatUnraisable()tolog(andclear)anunraisableexception.
Noguaranteesaremadeaboutwhenanobjectisdestroyed,except:
• Pythonwilldestroyanobjectimmediatelyorsometimeafterthefinalreferencetotheobjectisdeleted,
unlessitsfinalizer(tp_finalize)subsequentlyresurrectstheobject.
• Anobjectwillnotbedestroyedwhileitisbeingautomaticallyfinalized(tp_finalize)orautomatically
cleared(tp_clear).
CPythoncurrentlydestroysanobjectimmediatelyfromPy_DECREF()whenthenewreferencecountiszero,
butthismaychangeinafutureversion.
ItisrecommendedtocallPyObject_CallFinalizerFromDealloc()atthebeginningoftp_dealloc
toguaranteethattheobjectisalwaysfinalizedbeforedestruction.
If the type supports garbage collection (the Py_TPFLAGS_HAVE_GC flag is set), the destructor should call
PyObject_GC_UnTrack()beforeclearinganymemberfields.
It is permissible to call tp_clear from tp_dealloc to reduce code duplication and to guarantee that the
objectisalwaysclearedbeforedestruction. Bewarethattp_clearmighthavealreadybeencalled.
Ifthetypeisheapallocated(Py_TPFLAGS_HEAPTYPE),thedeallocatorshouldreleasetheownedreference
toitstypeobject(viaPy_DECREF())aftercallingthetypedeallocator. Seetheexamplecodebelow.:
static void
foo_dealloc(PyObject *op)
{
foo_object *self = (foo_object *) op;
PyObject_GC_UnTrack(self);
Py_CLEAR(self->ref);
Py_TYPE(self)->tp_free(self);
}
tp_dealloc must leave the exception status unchanged. If it needs to call something that might raise an
exception, the exception state must be backed up first and restored later (after logging any exceptions with
PyErr_WriteUnraisable()).
Example:
static void
foo_dealloc(PyObject *self)
{
PyObject *exc = PyErr_GetRaisedException();
if (PyObject_CallFinalizerFromDealloc(self) < 0) {
(continuesonnextpage)
13.4. TypeObjectStructures 319

### 第328页

(continuedfrompreviouspage)
// self was resurrected.
goto done;
}
PyTypeObject *tp = Py_TYPE(self);
if (tp->tp_flags & Py_TPFLAGS_HAVE_GC) {
PyObject_GC_UnTrack(self);
}
// Optional, but convenient to avoid code duplication.
if (tp->tp_clear && tp->tp_clear(self) < 0) {
PyErr_WriteUnraisable(self);
}
// Any additional destruction goes here.
tp->tp_free(self);
self = NULL; // In case PyErr_WriteUnraisable() is called below.
if (tp->tp_flags & Py_TPFLAGS_HEAPTYPE) {
Py_CLEAR(tp);
}
done:
// Optional, if something was called that might have raised an
// exception.
if (PyErr_Occurred()) {
PyErr_WriteUnraisable(self);
}
PyErr_SetRaisedException(exc);
}
tp_deallocmaybecalledfromanyPythonthread,notjustthethreadwhichcreatedtheobject(iftheobject
becomespartofarefcountcycle,thatcyclemightbecollectedbyagarbagecollectiononanythread). Thisis
notaproblemforPythonAPIcalls,sincethethreadonwhichtp_deallociscalledwithanattachedthread
state. However,iftheobjectbeingdestroyedinturndestroysobjectsfromsomeotherClibrary,careshould
betakentoensurethatdestroyingthoseobjectsonthethreadwhichcalledtp_deallocwillnotviolateany
assumptionsofthelibrary.
Inheritance:
Thisfieldisinheritedbysubtypes.
(cid:181) Seealso
ObjectLifeCyclefordetailsabouthowthisslotrelatestootherslots.
Py_ssize_tPyTypeObject.tp_vectorcall_offset
Anoptionaloffsettoaper-instancefunctionthatimplementscallingtheobjectusingthevectorcallprotocol,a
moreefficientalternativeofthesimplertp_call.
ThisfieldisonlyusediftheflagPy_TPFLAGS_HAVE_VECTORCALLisset. Ifso,thismustbeapositiveinteger
containingtheoffsetintheinstanceofavectorcallfuncpointer.
The vectorcallfunc pointer may be NULL, in which case the instance behaves as if
Py_TPFLAGS_HAVE_VECTORCALLwasnotset: callingtheinstancefallsbacktotp_call.
320 Chapter13. ObjectImplementationSupport

| (cid:181) Seealso |
| --- |
| ObjectLifeCyclefordetailsabouthowthisslotrelatestootherslots. |

### 第329页

AnyclassthatsetsPy_TPFLAGS_HAVE_VECTORCALLmustalsosettp_callandmakesureitsbehaviouris
consistentwiththevectorcallfuncfunction. Thiscanbedonebysettingtp_calltoPyVectorcall_Call().
Changed inversion3.8: Beforeversion3.8, this slotwasnamed tp_print. In Python2.x, itwasused for
printingtoafile. InPython3.0to3.7,itwasunused.
Changedinversion3.12: Beforeversion3.12,itwasnotrecommendedformutableheaptypestoimplement
thevectorcallprotocol. Whenausersets__call__inPythoncode,onlytp_callisupdated,likelymakingit
inconsistentwiththevectorcallfunction. Since3.12,setting__call__willdisablevectorcalloptimizationby
clearingthePy_TPFLAGS_HAVE_VECTORCALLflag.
Inheritance:
Thisfieldisalwaysinherited. However,thePy_TPFLAGS_HAVE_VECTORCALLflagisnotalwaysinherited. If
it’snotset,thenthesubclasswon’tusevectorcall,exceptwhenPyVectorcall_Call()isexplicitlycalled.
getattrfuncPyTypeObject.tp_getattr
Anoptionalpointertotheget-attribute-stringfunction.
Thisfieldisdeprecated. Whenitisdefined,itshouldpointtoafunctionthatactsthesameasthetp_getattro
function,buttakingaCstringinsteadofaPythonstringobjecttogivetheattributename.
Inheritance:
Group: tp_getattr,tp_getattro
This field is inherited by subtypes together with tp_getattro: a subtype inherits both tp_getattr and
tp_getattrofromitsbasetypewhenthesubtype’stp_getattrandtp_getattroarebothNULL.
setattrfuncPyTypeObject.tp_setattr
Anoptionalpointertothefunctionforsettinganddeletingattributes.
Thisfieldisdeprecated. Whenitisdefined,itshouldpointtoafunctionthatactsthesameasthetp_setattro
function,buttakingaCstringinsteadofaPythonstringobjecttogivetheattributename.
Inheritance:
Group: tp_setattr,tp_setattro
This field is inherited by subtypes together with tp_setattro: a subtype inherits both tp_setattr and
tp_setattrofromitsbasetypewhenthesubtype’stp_setattrandtp_setattroarebothNULL.
PyAsyncMethods*PyTypeObject.tp_as_async
Pointertoanadditionalstructurethatcontainsfieldsrelevantonlytoobjectswhichimplementawaitableand
asynchronousiteratorprotocolsattheC-level. SeeAsyncObjectStructuresfordetails.
Addedinversion3.5: Formerlyknownastp_compareandtp_reserved.
Inheritance:
Thetp_as_asyncfieldisnotinherited,butthecontainedfieldsareinheritedindividually.
reprfuncPyTypeObject.tp_repr
Anoptionalpointertoafunctionthatimplementsthebuilt-infunctionrepr().
ThesignatureisthesameasforPyObject_Repr():
PyObject *tp_repr(PyObject *self);
ThefunctionmustreturnastringoraUnicodeobject. Ideally,thisfunctionshouldreturnastringthat,when
passedtoeval(),givenasuitableenvironment,returnsanobjectwiththesamevalue. Ifthisisnotfeasible,
itshouldreturnastringstartingwith'<'andendingwith'>'fromwhichboththetypeandthevalueofthe
objectcanbededuced.
Inheritance:
Thisfieldisinheritedbysubtypes.
Default:
13.4. TypeObjectStructures 321

### 第330页

Whenthisfieldisnotset,astringoftheform<%s object at %p>isreturned,where%sisreplacedbythe
typename,and%pbytheobject’smemoryaddress.
PyNumberMethods*PyTypeObject.tp_as_number
Pointer to an additional structure that contains fields relevant only to objects which implement the number
protocol. ThesefieldsaredocumentedinNumberObjectStructures.
Inheritance:
Thetp_as_numberfieldisnotinherited,butthecontainedfieldsareinheritedindividually.
PySequenceMethods*PyTypeObject.tp_as_sequence
Pointertoanadditionalstructurethatcontainsfieldsrelevantonlytoobjectswhichimplementthesequence
protocol. ThesefieldsaredocumentedinSequenceObjectStructures.
Inheritance:
Thetp_as_sequencefieldisnotinherited,butthecontainedfieldsareinheritedindividually.
PyMappingMethods*PyTypeObject.tp_as_mapping
Pointer to an additional structure that contains fields relevant only to objects which implement the mapping
protocol. ThesefieldsaredocumentedinMappingObjectStructures.
Inheritance:
Thetp_as_mappingfieldisnotinherited,butthecontainedfieldsareinheritedindividually.
hashfuncPyTypeObject.tp_hash
Anoptionalpointertoafunctionthatimplementsthebuilt-infunctionhash().
ThesignatureisthesameasforPyObject_Hash():
Py_hash_t tp_hash(PyObject *);
Thevalue-1shouldnotbereturnedasanormalreturnvalue;whenanerroroccursduringthecomputation
ofthehashvalue,thefunctionshouldsetanexceptionandreturn-1.
Whenthisfieldisnotset(andtp_richcompareisnotset),anattempttotakethehashoftheobjectraises
TypeError. ThisisthesameassettingittoPyObject_HashNotImplemented().
This field can be set explicitly to PyObject_HashNotImplemented() to block inheritance of the hash
methodfromaparenttype. Thisisinterpretedastheequivalentof__hash__ = NoneatthePythonlevel,
causingisinstance(o, collections.Hashable)tocorrectlyreturnFalse. Notethattheconverseis
alsotrue-setting__hash__ = NoneonaclassatthePythonlevelwillresultinthetp_hashslotbeingset
toPyObject_HashNotImplemented().
Inheritance:
Group: tp_hash,tp_richcompare
This field is inherited by subtypes together with tp_richcompare: a subtype inherits both of
tp_richcompareandtp_hash,whenthesubtype’stp_richcompareandtp_hasharebothNULL.
Default:
PyBaseObject_TypeusesPyObject_GenericHash().
ternaryfuncPyTypeObject.tp_call
Anoptionalpointertoafunctionthatimplementscallingtheobject. ThisshouldbeNULLiftheobjectisnot
callable. ThesignatureisthesameasforPyObject_Call():
PyObject *tp_call(PyObject *self, PyObject *args, PyObject *kwargs);
Inheritance:
Thisfieldisinheritedbysubtypes.
322 Chapter13. ObjectImplementationSupport

### 第331页

reprfuncPyTypeObject.tp_str
Anoptionalpointertoafunctionthatimplementsthebuilt-inoperationstr(). (Notethatstrisatypenow,
andstr()callstheconstructorforthattype. ThisconstructorcallsPyObject_Str()todotheactualwork,
andPyObject_Str()willcallthishandler.)
ThesignatureisthesameasforPyObject_Str():
PyObject *tp_str(PyObject *self);
The function must return a string or a Unicodeobject. It should be a “friendly” string representation ofthe
object,asthisistherepresentationthatwillbeused,amongotherthings,bytheprint()function.
Inheritance:
Thisfieldisinheritedbysubtypes.
Default:
Whenthisfieldisnotset,PyObject_Repr()iscalledtoreturnastringrepresentation.
getattrofuncPyTypeObject.tp_getattro
Anoptionalpointertotheget-attributefunction.
ThesignatureisthesameasforPyObject_GetAttr():
PyObject *tp_getattro(PyObject *self, PyObject *attr);
It is usually convenient to set this field to PyObject_GenericGetAttr(), which implements the normal
wayoflookingforobjectattributes.
Inheritance:
Group: tp_getattr,tp_getattro
This field is inherited by subtypes together with tp_getattr: a subtype inherits both tp_getattr and
tp_getattrofromitsbasetypewhenthesubtype’stp_getattrandtp_getattroarebothNULL.
Default:
PyBaseObject_TypeusesPyObject_GenericGetAttr().
setattrofuncPyTypeObject.tp_setattro
Anoptionalpointertothefunctionforsettinganddeletingattributes.
ThesignatureisthesameasforPyObject_SetAttr():
int tp_setattro(PyObject *self, PyObject *attr, PyObject *value);
Inaddition,settingvaluetoNULLtodeleteanattributemustbesupported. Itisusuallyconvenienttosetthis
fieldtoPyObject_GenericSetAttr(),whichimplementsthenormalwayofsettingobjectattributes.
Inheritance:
Group: tp_setattr,tp_setattro
This field is inherited by subtypes together with tp_setattr: a subtype inherits both tp_setattr and
tp_setattrofromitsbasetypewhenthesubtype’stp_setattrandtp_setattroarebothNULL.
Default:
PyBaseObject_TypeusesPyObject_GenericSetAttr().
PyBufferProcs*PyTypeObject.tp_as_buffer
Pointertoanadditionalstructurethatcontainsfieldsrelevantonlytoobjectswhichimplementthebufferin-
terface. ThesefieldsaredocumentedinBufferObjectStructures.
Inheritance:
Thetp_as_bufferfieldisnotinherited,butthecontainedfieldsareinheritedindividually.
13.4. TypeObjectStructures 323

### 第332页

unsignedlongPyTypeObject.tp_flags
This field is a bit mask of various flags. Some flags indicate variant semantics for certain situations; oth-
ers are used to indicate that certain fields in the type object (or in the extension structures referenced via
tp_as_number, tp_as_sequence, tp_as_mapping, andtp_as_buffer)thatwerehistoricallynotal-
ways present are valid; if such a flag bit is clear, the type fields it guards must not be accessed and must be
consideredtohaveazeroorNULLvalueinstead.
Inheritance:
Inheritanceofthisfieldiscomplicated. Mostflagbitsareinheritedindividually,i.e. ifthebasetypehasaflag
bitset,thesubtypeinheritsthisflagbit. Theflagbitsthatpertaintoextensionstructuresarestrictlyinheritedif
theextensionstructureisinherited,i.e. thebasetype’svalueoftheflagbitiscopiedintothesubtypetogether
withapointertotheextensionstructure. ThePy_TPFLAGS_HAVE_GC flagbitisinheritedtogetherwiththe
tp_traverseandtp_clear fields, i.e. ifthePy_TPFLAGS_HAVE_GC flagbitisclearinthesubtypeand
thetp_traverseandtp_clearfieldsinthesubtypeexistandhaveNULLvalues.
Default:
PyBaseObject_TypeusesPy_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE.
BitMasks:
Thefollowingbitmasksarecurrentlydefined; thesecanbeORedtogetherusingthe|operatortoformthe
valueofthetp_flagsfield. ThemacroPyType_HasFeature()takesatypeandaflagsvalue, tpandf,
andcheckswhethertp->tp_flags & fisnon-zero.
Py_TPFLAGS_HEAPTYPE
Thisbitissetwhenthetypeobjectitselfisallocatedontheheap,forexample,typescreateddynamically
usingPyType_FromSpec(). Inthiscase,theob_typefieldofitsinstancesisconsideredareference
to the type, and the type object is INCREF’ed when a new instance is created, and DECREF’ed when
an instance is destroyed (this does not apply to instances of subtypes; only the type referenced by the
instance’sob_typegetsINCREF’edorDECREF’ed). Heaptypesshouldalsosupportgarbagecollection
astheycanformareferencecyclewiththeirownmoduleobject.
Inheritance:
???
Py_TPFLAGS_BASETYPE
Thisbitissetwhenthetypecanbeusedasthebasetypeofanothertype. Ifthisbitisclear, thetype
cannotbesubtyped(similartoa“final”classinJava).
Inheritance:
???
Py_TPFLAGS_READY
ThisbitissetwhenthetypeobjecthasbeenfullyinitializedbyPyType_Ready().
Inheritance:
???
Py_TPFLAGS_READYING
ThisbitissetwhilePyType_Ready()isintheprocessofinitializingthetypeobject.
Inheritance:
???
Py_TPFLAGS_HAVE_GC
Thisbitissetwhentheobjectsupportsgarbagecollection. Ifthisbitisset,memoryfornewinstances
(seetp_alloc)mustbeallocatedusingPyObject_GC_NeworPyType_GenericAlloc()anddeal-
located (see tp_free) using PyObject_GC_Del(). More information in section Supporting Cyclic
GarbageCollection.
Inheritance:
324 Chapter13. ObjectImplementationSupport

### 第333页

Group: Py_TPFLAGS_HAVE_GC,tp_traverse,tp_clear
ThePy_TPFLAGS_HAVE_GCflagbitisinheritedtogetherwiththetp_traverseandtp_clearfields,
i.e. ifthePy_TPFLAGS_HAVE_GCflagbitisclearinthesubtypeandthetp_traverseandtp_clear
fieldsinthesubtypeexistandhaveNULLvalues.
Py_TPFLAGS_DEFAULT
This is a bitmask of all the bits that pertain to the existence of certain fields in the
type object and its extension structures. Currently, it includes the following bits:
Py_TPFLAGS_HAVE_STACKLESS_EXTENSION.
Inheritance:
???
Py_TPFLAGS_METHOD_DESCRIPTOR
Thisbitindicatesthatobjectsbehavelikeunboundmethods.
Ifthisflagissetfortype(meth),then:
• meth.__get__(obj, cls)(*args, **kwds) (with obj not None) must be equivalent to
meth(obj, *args, **kwds).
• meth.__get__(None, cls)(*args, **kwds) must be equivalent to meth(*args,
**kwds).
Thisflagenablesanoptimizationfortypicalmethodcallslikeobj.meth(): itavoidscreatingatempo-
rary“boundmethod”objectforobj.meth.
Addedinversion3.8.
Inheritance:
ThisflagisneverinheritedbytypeswithoutthePy_TPFLAGS_IMMUTABLETYPEflagset. Forextension
types,itisinheritedwhenevertp_descr_getisinherited.
Py_TPFLAGS_MANAGED_DICT
Thisbitindicatesthatinstancesoftheclasshavea__dict__attribute,andthatthespaceforthedic-
tionaryismanagedbytheVM.
Ifthisflagisset,Py_TPFLAGS_HAVE_GCshouldalsobeset.
ThetypetraversefunctionmustcallPyObject_VisitManagedDict()anditsclearfunctionmustcall
PyObject_ClearManagedDict().
Addedinversion3.12.
Inheritance:
Thisflagisinheritedunlessthetp_dictoffsetfieldissetinasuperclass.
Py_TPFLAGS_MANAGED_WEAKREF
Thisbitindicatesthatinstancesoftheclassshouldbeweaklyreferenceable.
Addedinversion3.12.
Inheritance:
Thisflagisinheritedunlessthetp_weaklistoffsetfieldissetinasuperclass.
Py_TPFLAGS_ITEMS_AT_END
Onlyusablewithvariable-sizetypes,i.e. oneswithnon-zerotp_itemsize.
Indicatesthatthevariable-sizedportionofaninstanceofthistypeisattheendoftheinstance’smemory
area,atanoffsetofPy_TYPE(obj)->tp_basicsize(whichmaybedifferentineachsubclass).
When setting this flag, be sure that all superclasses either use this memory layout, or are not variable-
sized. Pythondoesnotcheckthis.
Addedinversion3.12.
13.4. TypeObjectStructures 325

### 第334页

Inheritance:
Thisflagisinherited.
Py_TPFLAGS_LONG_SUBCLASS
Py_TPFLAGS_LIST_SUBCLASS
Py_TPFLAGS_TUPLE_SUBCLASS
Py_TPFLAGS_BYTES_SUBCLASS
Py_TPFLAGS_UNICODE_SUBCLASS
Py_TPFLAGS_DICT_SUBCLASS
Py_TPFLAGS_BASE_EXC_SUBCLASS
Py_TPFLAGS_TYPE_SUBCLASS
TheseflagsareusedbyfunctionssuchasPyLong_Check()toquicklydetermineifatypeisasubclass
ofabuilt-intype;suchspecificchecksarefasterthanagenericcheck,likePyObject_IsInstance().
Customtypesthatinheritfrombuilt-insshouldhavetheirtp_flagssetappropriately,orthecodethat
interactswithsuchtypeswillbehavedifferentlydependingonwhatkindofcheckisused.
Py_TPFLAGS_HAVE_FINALIZE
Thisbitissetwhenthetp_finalizeslotispresentinthetypestructure.
Addedinversion3.4.
Deprecated since version 3.8: This flag isn’t necessary anymore, as the interpreter assumes the
tp_finalizeslotisalwayspresentinthetypestructure.
Py_TPFLAGS_HAVE_VECTORCALL
This bit is set when the class implements the vectorcall protocol. See tp_vectorcall_offset for
details.
Inheritance:
Thisbitisinheritediftp_callisalsoinherited.
Addedinversion3.9.
Changedinversion3.12: Thisflagisnowremovedfromaclasswhentheclass’s__call__()method
isreassigned.
Thisflagcannowbeinheritedbymutableclasses.
Py_TPFLAGS_IMMUTABLETYPE
Thisbitissetfortypeobjectsthatareimmutable: typeattributescannotbesetnordeleted.
PyType_Ready()automaticallyappliesthisflagtostatictypes.
Inheritance:
Thisflagisnotinherited.
Addedinversion3.10.
Py_TPFLAGS_DISALLOW_INSTANTIATION
Disallowcreatinginstancesofthetype: settp_new toNULLanddon’tcreatethe__new__keyinthe
typedictionary.
The flag must be set before creating the type, not after. For example, it must be set before
PyType_Ready()iscalledonthetype.
Theflagissetautomaticallyonstatictypesiftp_baseisNULLor&PyBaseObject_Typeandtp_new
isNULL.
Inheritance:
326 Chapter13. ObjectImplementationSupport

### 第335页

Thisflagisnotinherited. However,subclasseswillnotbeinstantiableunlesstheyprovideanon-NULL
tp_new(whichisonlypossibleviatheCAPI).
(cid:174) Note
Todisallowinstantiatingaclassdirectlybutallowinstantiatingitssubclasses(e.g. foranabstractbase
class),donotusethisflag. Instead,maketp_newonlysucceedforsubclasses.
Addedinversion3.10.
Py_TPFLAGS_MAPPING
This bit indicates that instances of the class may match mapping patterns when used as the subject of
amatchblock. Itisautomaticallysetwhenregisteringorsubclassingcollections.abc.Mapping,
andunsetwhenregisteringcollections.abc.Sequence.
(cid:174) Note
Py_TPFLAGS_MAPPING andPy_TPFLAGS_SEQUENCEaremutuallyexclusive;itisanerrortoen-
ablebothflagssimultaneously.
Inheritance:
ThisflagisinheritedbytypesthatdonotalreadysetPy_TPFLAGS_SEQUENCE.
(cid:181) Seealso
PEP634–StructuralPatternMatching: Specification
Addedinversion3.10.
Py_TPFLAGS_SEQUENCE
Thisbitindicatesthatinstancesoftheclassmaymatchsequencepatternswhenusedasthesubjectof
amatchblock. Itisautomaticallysetwhenregisteringorsubclassingcollections.abc.Sequence,
andunsetwhenregisteringcollections.abc.Mapping.
(cid:174) Note
Py_TPFLAGS_MAPPING andPy_TPFLAGS_SEQUENCEaremutuallyexclusive;itisanerrortoen-
ablebothflagssimultaneously.
Inheritance:
ThisflagisinheritedbytypesthatdonotalreadysetPy_TPFLAGS_MAPPING.
(cid:181) Seealso
PEP634–StructuralPatternMatching: Specification
Addedinversion3.10.
Py_TPFLAGS_VALID_VERSION_TAG
Internal. Donotsetorunsetthisflag. ToindicatethataclasshaschangedcallPyType_Modified()
13.4. TypeObjectStructures 327

| (cid:181) Seealso |
| --- |
| PEP634–StructuralPatternMatching: Specification |


| (cid:181) Seealso |
| --- |
| PEP634–StructuralPatternMatching: Specification |

### 第336页

(cid:193) Warning
Thisflagispresentinheaderfiles,butisnotbeused. ItwillberemovedinafutureversionofCPython
constchar*PyTypeObject.tp_doc
AnoptionalpointertoaNUL-terminatedCstringgivingthedocstringforthistypeobject. Thisisexposedas
the__doc__attributeonthetypeandinstancesofthetype.
Inheritance:
Thisfieldisnotinheritedbysubtypes.
traverseprocPyTypeObject.tp_traverse
An optional pointer to a traversal function for the garbage collector. This is only used if the
Py_TPFLAGS_HAVE_GCflagbitisset. Thesignatureis:
int tp_traverse(PyObject *self, visitproc visit, void *arg);
MoreinformationaboutPython’sgarbagecollectionschemecanbefoundinsectionSupportingCyclicGarbage
Collection.
Thetp_traversepointerisusedbythegarbagecollectortodetectreferencecycles. Atypicalimplemen-
tation of a tp_traverse function simply calls Py_VISIT() on each of the instance’s members that are
Pythonobjectsthattheinstanceowns. Forexample,thisisfunctionlocal_traverse()fromthe_thread
extensionmodule:
static int
local_traverse(PyObject *op, visitproc visit, void *arg)
{
localobject *self = (localobject *) op;
Py_VISIT(self->args);
Py_VISIT(self->kw);
Py_VISIT(self->dict);
return 0;
}
Note that Py_VISIT() is called only on those members that can participate in reference cycles. Although
thereisalsoaself->keymember,itcanonlybeNULLoraPythonstringandthereforecannotbepartofa
referencecycle.
Ontheotherhand,evenifyouknowamembercanneverbepartofacycle,asadebuggingaidyoumaywant
tovisititanywayjustsothegcmodule’sget_referents()functionwillincludeit.
Heaptypes(Py_TPFLAGS_HEAPTYPE)mustvisittheirtypewith:
Py_VISIT(Py_TYPE(self));
ItisonlyneededsincePython3.9. TosupportPython3.8andolder,thislinemustbeconditional:
#if PY_VERSION_HEX >= 0x03090000
Py_VISIT(Py_TYPE(self));
#endif
If the Py_TPFLAGS_MANAGED_DICT bit is set in the tp_flags field, the traverse function must call
PyObject_VisitManagedDict()likethis:
PyObject_VisitManagedDict((PyObject*)self, visit, arg);
328 Chapter13. ObjectImplementationSupport

### 第337页

(cid:193) Warning
Whenimplementingtp_traverse,onlythemembersthattheinstanceowns(byhavingstrongreferences
tothem)mustbevisited. Forinstance,ifanobjectsupportsweakreferencesviathetp_weaklistslot,
thepointersupportingthelinkedlist(whattp_weaklistpointsto)mustnotbevisitedastheinstancedoes
notdirectlyowntheweakreferencestoitself(theweakreferencelististheretosupporttheweakreference
machinery, but the instance has no strong reference to the elements inside it, as they are allowed to be
removedeveniftheinstanceisstillalive).
NotethatPy_VISIT()requiresthevisit andargparameterstolocal_traverse()tohavethesespecific
names;don’tnamethemjustanything.
Instancesofheap-allocatedtypesholdareferencetotheirtype. Theirtraversalfunctionmustthereforeeither
visitPy_TYPE(self),ordelegatethisresponsibilitybycallingtp_traverseofanotherheap-allocatedtype
(suchasaheap-allocatedsuperclass). Iftheydonot,thetypeobjectmaynotbegarbage-collected.
(cid:174) Note
Thetp_traversefunctioncanbecalledfromanythread.
Changed in version 3.9: Heap-allocated types are expected to visit Py_TYPE(self) in tp_traverse. In
earlierversionsofPython,duetobug40217,doingthismayleadtocrashesinsubclasses.
Inheritance:
Group: Py_TPFLAGS_HAVE_GC,tp_traverse,tp_clear
Thisfieldisinheritedbysubtypestogetherwithtp_clearandthePy_TPFLAGS_HAVE_GCflagbit: theflag
bit,tp_traverse,andtp_clearareallinheritedfromthebasetypeiftheyareallzerointhesubtype.
inquiryPyTypeObject.tp_clear
Anoptionalpointertoaclearfunction. Thesignatureis:
int tp_clear(PyObject *);
Thepurposeofthisfunctionistobreakreferencecyclesthatarecausingacyclicisolatesothattheobjectscan
besafelydestroyed. Aclearedobjectisapartiallydestroyedobject;theobjectisnotobligatedtosatisfydesign
invariantsheldduringnormaluse.
tp_clear does not need to delete references to objects that can’t participate in reference cycles, such as
PythonstringsorPythonintegers. However,itmaybeconvenienttoclearallreferences,andwritethetype’s
tp_deallocfunctiontoinvoketp_cleartoavoidcodeduplication. (Bewarethattp_clearmighthave
alreadybeencalled. PrefercallingidempotentfunctionslikePy_CLEAR().)
Anynon-trivialcleanupshouldbeperformedintp_finalizeinsteadoftp_clear.
(cid:174) Note
Iftp_clearfailstobreakareferencecyclethentheobjectsinthecyclicisolatemayremainindefinitely
uncollectable(“leak”). Seegc.garbage.
(cid:174) Note
Referents(directandindirect)mighthavealreadybeencleared;theyarenotguaranteedtobeinaconsistent
state.
13.4. TypeObjectStructures 329

| (cid:193) Warning |
| --- |
| Whenimplementingtp_traverse,onlythemembersthattheinstanceowns(byhavingstrongreferences
tothem)mustbevisited. Forinstance,ifanobjectsupportsweakreferencesviathetp_weaklistslot,
thepointersupportingthelinkedlist(whattp_weaklistpointsto)mustnotbevisitedastheinstancedoes
notdirectlyowntheweakreferencestoitself(theweakreferencelististheretosupporttheweakreference
machinery, but the instance has no strong reference to the elements inside it, as they are allowed to be
removedeveniftheinstanceisstillalive). |

### 第338页

(cid:174) Note
Thetp_clearfunctioncanbecalledfromanythread.
(cid:174) Note
Anobjectisnotguaranteedtobeautomaticallyclearedbeforeitsdestructor(tp_dealloc)iscalled.
Thisfunctiondiffersfromthedestructor(tp_dealloc)inthefollowingways:
• Thepurposeofclearinganobjectistoremovereferencestootherobjectsthatmightparticipateinaref-
erencecycle. Thepurposeofthedestructor,ontheotherhand,isasuperset: itmustreleaseallresources
itowns,includingreferencestoobjectsthatcannotparticipateinareferencecycle(e.g.,integers)aswell
astheobject’sownmemory(bycallingtp_free).
• Whentp_cleariscalled,otherobjectsmightstillholdreferencestotheobjectbeingcleared. Because
of this, tp_clear must not deallocate the object’s own memory (tp_free). The destructor, on the
otherhand,isonlycalledwhenno(strong)referencesexist,andassuch,mustsafelydestroytheobject
itselfbydeallocatingit.
• tp_clearmightneverbeautomaticallycalled. Anobject’sdestructor,ontheotherhand,willbeauto-
maticallycalledsometimeaftertheobjectbecomesunreachable(i.e.,eithertherearenoreferencesto
theobjectortheobjectisamemberofacyclicisolate).
Noguaranteesaremadeaboutwhen,if,orhowoftenPythonautomaticallyclearsanobject,except:
• Pythonwillnotautomaticallyclearanobjectifitisreachable,i.e.,thereisareferencetoitanditisnot
amemberofacyclicisolate.
• Python will not automatically clear an object if it has not been automatically finalized (see
tp_finalize). (If the finalizer resurrected the object, the object may or may not be automatically
finalizedagainbeforeitiscleared.)
• Ifanobjectisamemberofacyclicisolate,Pythonwillnotautomaticallyclearitifanymemberofthe
cyclicisolatehasnotyetbeenautomaticallyfinalized(tp_finalize).
• Python will not destroy an object until after any automatic calls to its tp_clear function have re-
turned. Thisensuresthattheactofbreakingareferencecycledoesnotinvalidatetheselfpointerwhile
tp_clearisstillexecuting.
• Pythonwillnotautomaticallycalltp_clearmultipletimesconcurrently.
CPythoncurrentlyonlyautomaticallyclearsobjectsasneededtobreakreferencecyclesinacyclicisolate,but
futureversionsmightclearobjectsregularlybeforetheirdestruction.
Taken together, all tp_clear functions in the system must combine to break all reference cycles. This is
subtle, andifinanydoubtsupplyatp_clear function. Forexample, thetupletypedoesnotimplementa
tp_clearfunction,becauseit’spossibletoprovethatnoreferencecyclecanbecomposedentirelyoftuples.
Therefore the tp_clear functions of other types are responsible for breaking any cycle containing a tuple.
Thisisn’timmediatelyobvious,andthere’srarelyagoodreasontoavoidimplementingtp_clear.
Implementations of tp_clear should drop the instance’s references to those of its members that may be
Pythonobjects,andsetitspointerstothosememberstoNULL,asinthefollowingexample:
static int
local_clear(PyObject *op)
{
localobject *self = (localobject *) op;
Py_CLEAR(self->key);
Py_CLEAR(self->args);
Py_CLEAR(self->kw);
(continuesonnextpage)
330 Chapter13. ObjectImplementationSupport

### 第339页

(continuedfrompreviouspage)
Py_CLEAR(self->dict);
return 0;
}
ThePy_CLEAR()macroshouldbeused,becauseclearingreferencesisdelicate: thereferencetothecontained
objectmustnotbereleased(viaPy_DECREF())untilafterthepointertothecontainedobjectissettoNULL.
Thisisbecausereleasingthereferencemaycausethecontainedobjecttobecometrash,triggeringachainof
reclamationactivitythatmayincludeinvokingarbitraryPythoncode(duetofinalizers,orweakrefcallbacks,
associatedwiththecontainedobject). Ifit’spossibleforsuchcodetoreferenceself again,it’simportantthat
thepointertothecontainedobjectbeNULLatthattime,sothatself knowsthecontainedobjectcannolonger
beused. ThePy_CLEAR()macroperformstheoperationsinasafeorder.
If the Py_TPFLAGS_MANAGED_DICT bit is set in the tp_flags field, the traverse function must call
PyObject_ClearManagedDict()likethis:
PyObject_ClearManagedDict((PyObject*)self);
MoreinformationaboutPython’sgarbagecollectionschemecanbefoundinsectionSupportingCyclicGarbage
Collection.
Inheritance:
Group: Py_TPFLAGS_HAVE_GC,tp_traverse,tp_clear
Thisfieldisinheritedbysubtypestogetherwithtp_traverseandthePy_TPFLAGS_HAVE_GCflagbit: the
flagbit,tp_traverse,andtp_clearareallinheritedfromthebasetypeiftheyareallzerointhesubtype.
(cid:181) Seealso
ObjectLifeCyclefordetailsabouthowthisslotrelatestootherslots.
richcmpfuncPyTypeObject.tp_richcompare
Anoptionalpointertotherichcomparisonfunction,whosesignatureis:
PyObject *tp_richcompare(PyObject *self, PyObject *other, int op);
ThefirstparameterisguaranteedtobeaninstanceofthetypethatisdefinedbyPyTypeObject.
Thefunctionshouldreturntheresultofthecomparison(usuallyPy_TrueorPy_False). Ifthecomparison
isundefined,itmustreturnPy_NotImplemented,ifanothererroroccurreditmustreturnNULLandsetan
exceptioncondition.
The following constants are defined to be used as the third argument for tp_richcompare and for
PyObject_RichCompare():
13.4. TypeObjectStructures 331

| (cid:181) Seealso |
| --- |
| ObjectLifeCyclefordetailsabouthowthisslotrelatestootherslots. |

### 第340页

Constant Comparison
<
Py_LT
<=
Py_LE
==
Py_EQ
!=
Py_NE
>
Py_GT
>=
Py_GE
Thefollowingmacroisdefinedtoeasewritingrichcomparisonfunctions:
Py_RETURN_RICHCOMPARE(VAL_A,VAL_B,op)
Return Py_True or Py_False from the function, depending on the result of a comparison. VAL_A
andVAL_BmustbeorderablebyCcomparisonoperators(forexample,theymaybeCintsorfloats).
Thethirdargumentspecifiestherequestedoperation,asforPyObject_RichCompare().
Thereturnedvalueisanewstrongreference.
Onerror,setsanexceptionandreturnsNULLfromthefunction.
Addedinversion3.7.
Inheritance:
Group: tp_hash,tp_richcompare
Thisfieldisinheritedbysubtypestogetherwithtp_hash:asubtypeinheritstp_richcompareandtp_hash
whenthesubtype’stp_richcompareandtp_hasharebothNULL.
Default:
PyBaseObject_Typeprovidesatp_richcompareimplementation,whichmaybeinherited. However,if
onlytp_hashisdefined,noteventheinheritedfunctionisusedandinstancesofthetypewillnotbeableto
participateinanycomparisons.
Py_ssize_tPyTypeObject.tp_weaklistoffset
Whilethisfieldisstillsupported,Py_TPFLAGS_MANAGED_WEAKREFshouldbeusedinstead,ifatallpossible.
Iftheinstancesofthistypeareweaklyreferenceable,thisfieldisgreaterthanzeroandcontainstheoffsetin
theinstancestructureoftheweakreferencelisthead(ignoringtheGCheader,ifpresent);thisoffsetisusedby
PyObject_ClearWeakRefs()andthePyWeakref_*functions. Theinstancestructureneedstoincludea
fieldoftypePyObject*whichisinitializedtoNULL.
Donotconfusethisfieldwithtp_weaklist;thatisthelistheadforweakreferencestothetypeobjectitself.
ItisanerrortosetboththePy_TPFLAGS_MANAGED_WEAKREFbitandtp_weaklistoffset.
Inheritance:
Thisfieldisinheritedbysubtypes,butseetheruleslistedbelow. Asubtypemayoverridethisoffset;thismeans
thatthesubtypeusesadifferentweakreferencelistheadthanthebasetype. Sincethelistheadisalwaysfound
viatp_weaklistoffset,thisshouldnotbeaproblem.
332 Chapter13. ObjectImplementationSupport

| Constant | Comparison |
| --- | --- |
| Py_LT | < |
| Py_LE | <= |
| Py_EQ | == |
| Py_NE | != |
| Py_GT | > |
| Py_GE | >= |

### 第341页

Default:
IfthePy_TPFLAGS_MANAGED_WEAKREF bitissetinthetp_flagsfield,thentp_weaklistoffsetwill
besettoanegativevalue,toindicatethatitisunsafetousethisfield.
getiterfuncPyTypeObject.tp_iter
Anoptionalpointertoafunctionthatreturnsaniteratorfortheobject. Itspresencenormallysignalsthatthe
instancesofthistypeareiterable(althoughsequencesmaybeiterablewithoutthisfunction).
ThisfunctionhasthesamesignatureasPyObject_GetIter():
PyObject *tp_iter(PyObject *self);
Inheritance:
Thisfieldisinheritedbysubtypes.
iternextfuncPyTypeObject.tp_iternext
Anoptionalpointertoafunctionthatreturnsthenextiteminaniterator. Thesignatureis:
PyObject *tp_iternext(PyObject *self);
When the iterator is exhausted, it must return NULL; a StopIteration exception may or may not be set.
When another error occurs, it must return NULL too. Its presence signals that the instances of this type are
iterators.
Iteratortypesshouldalsodefinethetp_iter function, andthatfunctionshouldreturntheiteratorinstance
itself(notanewiteratorinstance).
ThisfunctionhasthesamesignatureasPyIter_Next().
Inheritance:
Thisfieldisinheritedbysubtypes.
structPyMethodDef *PyTypeObject.tp_methods
AnoptionalpointertoastaticNULL-terminatedarrayofPyMethodDefstructures,declaringregularmethods
ofthistype.
Foreachentryinthearray,anentryisaddedtothetype’sdictionary(seetp_dictbelow)containingamethod
descriptor.
Inheritance:
Thisfieldisnotinheritedbysubtypes(methodsareinheritedthroughadifferentmechanism).
structPyMemberDef *PyTypeObject.tp_members
An optional pointer to a static NULL-terminated array of PyMemberDef structures, declaring regular data
members(fieldsorslots)ofinstancesofthistype.
Foreachentryinthearray,anentryisaddedtothetype’sdictionary(seetp_dictbelow)containingamember
descriptor.
Inheritance:
Thisfieldisnotinheritedbysubtypes(membersareinheritedthroughadifferentmechanism).
structPyGetSetDef *PyTypeObject.tp_getset
An optional pointer to a static NULL-terminated array of PyGetSetDef structures, declaring computed at-
tributesofinstancesofthistype.
Foreachentryinthearray,anentryisaddedtothetype’sdictionary(seetp_dictbelow)containingagetset
descriptor.
Inheritance:
Thisfieldisnotinheritedbysubtypes(computedattributesareinheritedthroughadifferentmechanism).
13.4. TypeObjectStructures 333

### 第342页

PyTypeObject*PyTypeObject.tp_base
Anoptionalpointertoabasetypefromwhichtypepropertiesareinherited. Atthislevel,onlysingleinheritance
issupported;multipleinheritancerequiredynamicallycreatingatypeobjectbycallingthemetatype.
(cid:174) Note
Slotinitializationissubjecttotherulesofinitializingglobals. C99requirestheinitializerstobe“address
constants”. FunctiondesignatorslikePyType_GenericNew(),withimplicitconversiontoapointer,are
validC99addressconstants.
However,theunary‘&’operatorappliedtoanon-staticvariablelikePyBaseObject_Typeisnotrequired
toproduceanaddressconstant. Compilersmaysupportthis(gccdoes),MSVCdoesnot. Bothcompilers
arestrictlystandardconforminginthisparticularbehavior.
Consequently,tp_baseshouldbesetintheextensionmodule’sinitfunction.
Inheritance:
Thisfieldisnotinheritedbysubtypes(obviously).
Default:
Thisfielddefaultsto&PyBaseObject_Type(whichtoPythonprogrammersisknownasthetypeobject).
PyObject*PyTypeObject.tp_dict
Thetype’sdictionaryisstoredherebyPyType_Ready().
ThisfieldshouldnormallybeinitializedtoNULLbeforePyType_Readyiscalled;itmayalsobeinitializedto
adictionarycontaininginitialattributesforthetype. OncePyType_Ready()hasinitializedthetype,extra
attributesforthetypemaybeaddedtothisdictionaryonlyiftheydon’tcorrespondtooverloadedoperations
(like__add__()). Onceinitializationforthetypehasfinished,thisfieldshouldbetreatedasread-only.
Sometypesmaynotstoretheirdictionaryinthisslot. UsePyType_GetDict()toretrievethedictionaryfor
anarbitrarytype.
Changedinversion3.12: Internalsdetail: Forstaticbuiltintypes,thisisalwaysNULL.Instead,thedictforsuch
typesisstoredonPyInterpreterState. UsePyType_GetDict()togetthedictforanarbitrarytype.
Inheritance:
Thisfieldisnotinheritedbysubtypes(thoughtheattributesdefinedinhereareinheritedthroughadifferent
mechanism).
Default:
IfthisfieldisNULL,PyType_Ready()willassignanewdictionarytoit.
(cid:193) Warning
ItisnotsafetousePyDict_SetItem()onorotherwisemodifytp_dictwiththedictionaryC-API.
descrgetfuncPyTypeObject.tp_descr_get
Anoptionalpointertoa“descriptorget”function.
Thefunctionsignatureis:
PyObject * tp_descr_get(PyObject *self, PyObject *obj, PyObject *type);
Inheritance:
Thisfieldisinheritedbysubtypes.
334 Chapter13. ObjectImplementationSupport

| (cid:193) Warning |
| --- |
| ItisnotsafetousePyDict_SetItem()onorotherwisemodifytp_dictwiththedictionaryC-API. |

### 第343页

descrsetfuncPyTypeObject.tp_descr_set
Anoptionalpointertoafunctionforsettinganddeletingadescriptor’svalue.
Thefunctionsignatureis:
int tp_descr_set(PyObject *self, PyObject *obj, PyObject *value);
ThevalueargumentissettoNULLtodeletethevalue.
Inheritance:
Thisfieldisinheritedbysubtypes.
Py_ssize_tPyTypeObject.tp_dictoffset
Whilethisfieldisstillsupported,Py_TPFLAGS_MANAGED_DICTshouldbeusedinstead,ifatallpossible.
If the instances of this type have a dictionary containing instance variables, this field is non-zero and
contains the offset in the instances of the type of the instance variable dictionary; this offset is used by
PyObject_GenericGetAttr().
Donotconfusethisfieldwithtp_dict;thatisthedictionaryforattributesofthetypeobjectitself.
Thevaluespecifiestheoffsetofthedictionaryfromthestartoftheinstancestructure.
The tp_dictoffset should be regarded as write-only. To get the pointer to the dictionary call
PyObject_GenericGetDict(). CallingPyObject_GenericGetDict()mayneedtoallocatememory
forthedictionary,soitismaybemoreefficienttocallPyObject_GetAttr()whenaccessinganattribute
ontheobject.
ItisanerrortosetboththePy_TPFLAGS_MANAGED_DICTbitandtp_dictoffset.
Inheritance:
This field is inherited by subtypes. A subtype should not override this offset; doing so could be un-
safe, if C code tries to access the dictionary at the previous offset. To properly support inheritance, use
Py_TPFLAGS_MANAGED_DICT.
Default:
Thisslothasnodefault. Forstatictypes,ifthefieldisNULLthenno__dict__getscreatedforinstances.
IfthePy_TPFLAGS_MANAGED_DICT bitissetinthetp_flagsfield, thentp_dictoffsetwillbesetto
-1,toindicatethatitisunsafetousethisfield.
initprocPyTypeObject.tp_init
Anoptionalpointertoaninstanceinitializationfunction.
Thisfunctioncorrespondstothe__init__()methodofclasses. Like__init__(),itispossibletocreatean
instancewithoutcalling__init__(),anditispossibletoreinitializeaninstancebycallingits__init__()
methodagain.
Thefunctionsignatureis:
int tp_init(PyObject *self, PyObject *args, PyObject *kwds);
Theselfargumentistheinstancetobeinitialized;theargsandkwdsargumentsrepresentpositionalandkey-
wordargumentsofthecallto__init__().
Thetp_initfunction, ifnotNULL,iscalledwhenaninstanceiscreatednormallybycallingitstype, after
thetype’stp_new functionhasreturnedaninstanceofthetype. Ifthetp_new functionreturnsaninstance
ofsomeothertypethatisnotasubtypeoftheoriginaltype,notp_initfunctioniscalled;iftp_newreturns
aninstanceofasubtypeoftheoriginaltype,thesubtype’stp_initiscalled.
Returns0onsuccess,-1andsetsanexceptiononerror.
Inheritance:
Thisfieldisinheritedbysubtypes.
13.4. TypeObjectStructures 335

### 第344页

Default:
Forstatictypesthisfielddoesnothaveadefault.
allocfuncPyTypeObject.tp_alloc
Anoptionalpointertoaninstanceallocationfunction.
Thefunctionsignatureis:
PyObject *tp_alloc(PyTypeObject *self, Py_ssize_t nitems);
Inheritance:
Staticsubtypesinheritthisslot,whichwillbePyType_GenericAlloc()ifinheritedfromobject.
Heapsubtypesdonotinheritthisslot.
Default:
Forheapsubtypes,thisfieldisalwayssettoPyType_GenericAlloc().
Forstaticsubtypes,thisslotisinherited(seeabove).
newfuncPyTypeObject.tp_new
Anoptionalpointertoaninstancecreationfunction.
Thefunctionsignatureis:
PyObject *tp_new(PyTypeObject *subtype, PyObject *args, PyObject *kwds);
Thesubtypeargumentisthetypeoftheobjectbeingcreated;theargsandkwdsargumentsrepresentpositional
andkeywordargumentsofthecalltothetype. Notethatsubtypedoesn’thavetoequalthetypewhosetp_new
functioniscalled;itmaybeasubtypeofthattype(butnotanunrelatedtype).
Thetp_new functionshouldcallsubtype->tp_alloc(subtype, nitems)toallocatespacefortheob-
ject,andthendoonlyasmuchfurtherinitializationasisabsolutelynecessary. Initializationthatcansafelybe
ignored or repeated should be placed in the tp_init handler. A good rule of thumb is that for immutable
types, all initialization should take place in tp_new, while for mutable types, most initialization should be
deferredtotp_init.
SetthePy_TPFLAGS_DISALLOW_INSTANTIATION flagtodisallowcreatinginstancesofthetypeinPython.
Inheritance:
This field is inherited by subtypes, except it is not inherited by static types whose tp_base is NULL or
&PyBaseObject_Type.
Default:
Forstatictypesthisfieldhasnodefault. ThismeansiftheslotisdefinedasNULL,thetypecannotbecalledto
createnewinstances;presumablythereissomeotherwaytocreateinstances,likeafactoryfunction.
freefuncPyTypeObject.tp_free
Anoptionalpointertoaninstancedeallocationfunction. Itssignatureis:
void tp_free(void *self);
Thisfunctionmustfreethememoryallocatedbytp_alloc.
Inheritance:
Staticsubtypesinheritthisslot,whichwillbePyObject_Free()ifinheritedfromobject. Exception: If
thetypesupportsgarbagecollection(i.e.,thePy_TPFLAGS_HAVE_GC flagissetintp_flags)anditwould
inheritPyObject_Free(),thenthisslotisnotinheritedbutinsteaddefaultstoPyObject_GC_Del().
Heapsubtypesdonotinheritthisslot.
Default:
336 Chapter13. ObjectImplementationSupport

### 第345页

For heap subtypes, this slot defaults to a deallocator suitable to match PyType_GenericAlloc() and the
valueofthePy_TPFLAGS_HAVE_GCflag.
Forstaticsubtypes,thisslotisinherited(seeabove).
inquiryPyTypeObject.tp_is_gc
Anoptionalpointertoafunctioncalledbythegarbagecollector.
Thegarbagecollectorneedstoknowwhetheraparticularobjectiscollectibleornot. Normally,itissufficient
tolookattheobject’stype’stp_flagsfield,andcheckthePy_TPFLAGS_HAVE_GCflagbit. Butsometypes
haveamixtureofstaticallyanddynamicallyallocatedinstances,andthestaticallyallocatedinstancesarenot
collectible. Such types should define this function; it should return 1 for a collectible instance, and 0 for a
non-collectibleinstance. Thesignatureis:
int tp_is_gc(PyObject *self);
(Theonlyexampleofthisaretypesthemselves. Themetatype,PyType_Type,definesthisfunctiontodistin-
guishbetweenstaticallyanddynamicallyallocatedtypes.)
Inheritance:
Thisfieldisinheritedbysubtypes.
Default:
Thisslothasnodefault. IfthisfieldisNULL,Py_TPFLAGS_HAVE_GCisusedasthefunctionalequivalent.
PyObject*PyTypeObject.tp_bases
Tupleofbasetypes.
ThisfieldshouldbesettoNULLandtreatedasread-only. Pythonwillfillitinwhenthetypeisinitialized.
For dynamically created classes, the Py_tp_bases slot can be used instead of the bases argument of
PyType_FromSpecWithBases(). Theargumentformispreferred.
(cid:193) Warning
Multipleinheritancedoesnotworkwellforstaticallydefinedtypes. Ifyousettp_basestoatuple,Python
willnotraiseanerror,butsomeslotswillonlybeinheritedfromthefirstbase.
Inheritance:
Thisfieldisnotinherited.
PyObject*PyTypeObject.tp_mro
Tuple containing the expanded set of base types, starting with the type itself and ending with object, in
MethodResolutionOrder.
ThisfieldshouldbesettoNULLandtreatedasread-only. Pythonwillfillitinwhenthetypeisinitialized.
Inheritance:
Thisfieldisnotinherited;itiscalculatedfreshbyPyType_Ready().
PyObject*PyTypeObject.tp_cache
Unused. Internaluseonly.
Inheritance:
Thisfieldisnotinherited.
void*PyTypeObject.tp_subclasses
Acollectionofsubclasses. Internaluseonly. Maybeaninvalidpointer.
Togetalistofsubclasses,callthePythonmethod__subclasses__().
13.4. TypeObjectStructures 337

| (cid:193) Warning |
| --- |
| Multipleinheritancedoesnotworkwellforstaticallydefinedtypes. Ifyousettp_basestoatuple,Python
willnotraiseanerror,butsomeslotswillonlybeinheritedfromthefirstbase. |

### 第346页

Changedinversion3.12: Forsometypes,thisfielddoesnotholdavalidPyObject*. Thetypewaschanged
tovoid*toindicatethis.
Inheritance:
Thisfieldisnotinherited.
PyObject*PyTypeObject.tp_weaklist
Weakreferencelisthead,forweakreferencestothistypeobject. Notinherited. Internaluseonly.
Changedinversion3.12: Internalsdetail: ForthestaticbuiltintypesthisisalwaysNULL,evenifweakrefsare
added. Instead, the weakrefs for each are stored on PyInterpreterState. Use the public C-API or the
internal_PyObject_GET_WEAKREFS_LISTPTR()macrotoavoidthedistinction.
Inheritance:
Thisfieldisnotinherited.
destructorPyTypeObject.tp_del
Thisfieldisdeprecated. Usetp_finalizeinstead.
unsignedintPyTypeObject.tp_version_tag
Usedtoindexintothemethodcache. Internaluseonly.
Inheritance:
Thisfieldisnotinherited.
destructorPyTypeObject.tp_finalize
An optional pointer to an instance finalization function. This is the C implementation of the __del__()
specialmethod. Itssignatureis:
void tp_finalize(PyObject *self);
Theprimarypurposeoffinalizationistoperformanynon-trivialcleanupthatmustbeperformedbeforethe
object is destroyed, while the object and any other objects it directly or indirectly references are still in a
consistentstate. ThefinalizerisallowedtoexecutearbitraryPythoncode.
Before Python automatically finalizes an object, some of the object’s direct or indirect referents might have
themselvesbeenautomaticallyfinalized. However,noneofthereferentswillhavebeenautomaticallycleared
(tp_clear)yet.
Other non-finalized objects might still be using a finalized object, so the finalizer must leave the object in a
sanestate(e.g.,invariantsarestillmet).
(cid:174) Note
AfterPythonautomaticallyfinalizesanobject,Pythonmightstartautomaticallyclearing(tp_clear)the
objectanditsreferents(directandindirect). Clearedobjectsarenotguaranteedtobeinaconsistentstate;
afinalizedobjectmustbeabletotolerateclearedreferents.
(cid:174) Note
Anobjectisnotguaranteedtobeautomaticallyfinalizedbeforeitsdestructor(tp_dealloc)iscalled. It
isrecommendedtocallPyObject_CallFinalizerFromDealloc()atthebeginningoftp_dealloc
toguaranteethattheobjectisalwaysfinalizedbeforedestruction.
(cid:174) Note
Thetp_finalizefunctioncanbecalledfromanythread,althoughtheGILwillbeheld.
338 Chapter13. ObjectImplementationSupport

### 第347页

(cid:174) Note
Thetp_finalizefunctioncanbecalledduringshutdown,aftersomeglobalvariableshavebeendeleted.
Seethedocumentationofthe__del__()methodfordetails.
WhenPythonfinalizesanobject,itbehaveslikethefollowingalgorithm:
1. Pythonmightmarktheobjectasfinalized. Currently,Pythonalwaysmarksobjectswhosetypesupports
garbage collection (i.e., the Py_TPFLAGS_HAVE_GC flag is set in tp_flags) and never marks other
typesofobjects;thismightchangeinafutureversion.
2. Iftheobjectisnotmarkedasfinalizedanditstp_finalizefinalizerfunctionisnon-NULL,thefinalizer
functioniscalled.
3. Ifthefinalizerfunctionwascalledandthefinalizermadetheobjectreachable(i.e.,thereisareference
totheobjectanditisnotamemberofacyclicisolate),thenthefinalizerissaidtohaveresurrected the
object. Itisunspecifiedwhetherthefinalizercanalsoresurrecttheobjectbyaddinganewreferenceto
theobjectthatdoesnotmakeitreachable,i.e.,theobjectis(still)amemberofacyclicisolate.
4. Ifthefinalizerresurrectedtheobject,theobject’spendingdestructioniscanceledandtheobject’sfinalized
markmightberemovedifpresent. Currently,Pythonneverremovesthefinalizedmark;thismightchange
inafutureversion.
Automatic finalization refers to any finalization performed by Python except via calls to
PyObject_CallFinalizer() or PyObject_CallFinalizerFromDealloc(). No guarantees
aremadeaboutwhen,if,orhowoftenanobjectisautomaticallyfinalized,except:
• Pythonwillnotautomaticallyfinalizeanobjectifitisreachable,i.e.,thereisareferencetoitanditis
notamemberofacyclicisolate.
• Python will not automatically finalize an object if finalizing it would not mark the object as fi-
nalized. Currently, this applies to objects whose type does not support garbage collection, i.e.,
the Py_TPFLAGS_HAVE_GC flag is not set. Such objects can still be manually finalized by calling
PyObject_CallFinalizer()orPyObject_CallFinalizerFromDealloc().
• Pythonwillnotautomaticallyfinalizeanytwomembersofacyclicisolateconcurrently.
• Pythonwillnotautomaticallyfinalizeanobjectafterithasautomaticallycleared(tp_clear)theobject.
• Ifanobjectisamemberofacyclicisolate,Pythonwillnotautomaticallyfinalizeitafterautomatically
clearing(seetp_clear)anyothermember.
• Python will automatically finalize every member of a cyclic isolate before it automatically clears (see
tp_clear)anyofthem.
• IfPythonisgoingtoautomaticallyclearanobject(tp_clear),itwillautomaticallyfinalizetheobject
first.
Pythoncurrentlyonlyautomaticallyfinalizesobjectsthataremembersofacyclicisolate,butfutureversions
mightfinalizeobjectsregularlybeforetheirdestruction.
To manually finalize an object, do not call this function directly; call PyObject_CallFinalizer() or
PyObject_CallFinalizerFromDealloc()instead.
tp_finalizeshouldleavethecurrentexceptionstatusunchanged. Therecommendedwaytowriteanon-
trivial finalizer is to back up the exception at the beginning by calling PyErr_GetRaisedException()
and restore the exception at the end by calling PyErr_SetRaisedException(). If an exception
is encountered in the middle of the finalizer, log and clear it with PyErr_WriteUnraisable() or
PyErr_FormatUnraisable(). Forexample:
static void
foo_finalize(PyObject *self)
{
// Save the current exception, if any.
(continuesonnextpage)
13.4. TypeObjectStructures 339

### 第348页

(continuedfrompreviouspage)
PyObject *exc = PyErr_GetRaisedException();
// ...
if (do_something_that_might_raise() != success_indicator) {
PyErr_WriteUnraisable(self);
goto done;
}
done:
// Restore the saved exception. This silently discards any exception
// raised above, so be sure to call PyErr_WriteUnraisable first if
// necessary.
PyErr_SetRaisedException(exc);
}
Inheritance:
Thisfieldisinheritedbysubtypes.
Addedinversion3.4.
Changedinversion3.8: Beforeversion3.8itwasnecessarytosetthePy_TPFLAGS_HAVE_FINALIZEflags
bitinorderforthisfieldtobeused. Thisisnolongerrequired.
(cid:181) Seealso
• PEP442: “Safeobjectfinalization”
• ObjectLifeCyclefordetailsabouthowthisslotrelatestootherslots.
• PyObject_CallFinalizer()
• PyObject_CallFinalizerFromDealloc()
vectorcallfuncPyTypeObject.tp_vectorcall
A vectorcall function to use for calls of this type object (rather than instances). In other words,
tp_vectorcallcanbeusedtooptimizetype.__call__,whichtypicallyreturnsanewinstanceoftype.
As with any vectorcall function, if tp_vectorcall is NULL, the tp_call protocol
(Py_TYPE(type)->tp_call)isusedinstead.
(cid:174) Note
The vectorcall protocol requires that the vectorcall function has the same behavior as the cor-
responding tp_call. This means that type->tp_vectorcall must match the behavior of
Py_TYPE(type)->tp_call.
Specifically, if type uses the default metaclass, type->tp_vectorcall must behave the same as
PyType_Type->tp_call,which:
• callstype->tp_new,
• iftheresultisasubclassoftype,callstype->tp_initontheresultoftp_new,and
• returnstheresultoftp_new.
Typically, tp_vectorcall is overridden to optimize this process for specific tp_new and tp_init.
When doing this for user-subclassable types, note that both can be overridden (using __new__() and
__init__(),respectively).
340 Chapter13. ObjectImplementationSupport

| (cid:181) Seealso |
| --- |
| • PEP442: “Safeobjectfinalization”
• ObjectLifeCyclefordetailsabouthowthisslotrelatestootherslots.
• PyObject_CallFinalizer()
• PyObject_CallFinalizerFromDealloc() |

### 第349页

Inheritance:
Thisfieldisneverinherited.
Addedinversion3.9: (thefieldexistssince3.8butit’sonlyusedsince3.9)
unsignedcharPyTypeObject.tp_watched
Internal. Donotuse.
Addedinversion3.12.
13.4.6 Static Types
Traditionally,typesdefinedinCcodearestatic,thatis,astaticPyTypeObjectstructureisdefineddirectlyincode
andinitializedusingPyType_Ready().
ThisresultsintypesthatarelimitedrelativetotypesdefinedinPython:
• Statictypesarelimitedtoonebase,i.e. theycannotusemultipleinheritance.
• Statictypeobjects(butnotnecessarilytheirinstances)areimmutable. Itisnotpossibletoaddormodifythe
typeobject’sattributesfromPython.
• Static type objects are shared across sub-interpreters, so they should not include any subinterpreter-specific
state.
Also,sincePyTypeObjectisonlypartoftheLimitedAPI asanopaquestruct,anyextensionmodulesusingstatic
typesmustbecompiledforaspecificPythonminorversion.
13.4.7 Heap Types
An alternative to static types is heap-allocated types, or heap types for short, which correspond closely to classes
createdbyPython’sclassstatement. HeaptypeshavethePy_TPFLAGS_HEAPTYPEflagset.
This is done by filling a PyType_Spec structure and calling PyType_FromSpec(),
PyType_FromSpecWithBases(),PyType_FromModuleAndSpec(),orPyType_FromMetaclass().
13.4.8 Number Object Structures
typePyNumberMethods
Thisstructureholdspointerstothefunctionswhichanobjectusestoimplementthenumberprotocol. Each
functionisusedbythefunctionofsimilarnamedocumentedintheNumberProtocolsection.
Hereisthestructuredefinition:
typedef struct {
binaryfunc nb_add;
binaryfunc nb_subtract;
binaryfunc nb_multiply;
binaryfunc nb_remainder;
binaryfunc nb_divmod;
ternaryfunc nb_power;
unaryfunc nb_negative;
unaryfunc nb_positive;
unaryfunc nb_absolute;
inquiry nb_bool;
unaryfunc nb_invert;
binaryfunc nb_lshift;
binaryfunc nb_rshift;
binaryfunc nb_and;
binaryfunc nb_xor;
binaryfunc nb_or;
unaryfunc nb_int;
(continuesonnextpage)
13.4. TypeObjectStructures 341

### 第350页

(continuedfrompreviouspage)
void *nb_reserved;
unaryfunc nb_float;
binaryfunc nb_inplace_add;
binaryfunc nb_inplace_subtract;
binaryfunc nb_inplace_multiply;
binaryfunc nb_inplace_remainder;
ternaryfunc nb_inplace_power;
binaryfunc nb_inplace_lshift;
binaryfunc nb_inplace_rshift;
binaryfunc nb_inplace_and;
binaryfunc nb_inplace_xor;
binaryfunc nb_inplace_or;
binaryfunc nb_floor_divide;
binaryfunc nb_true_divide;
binaryfunc nb_inplace_floor_divide;
binaryfunc nb_inplace_true_divide;
unaryfunc nb_index;
binaryfunc nb_matrix_multiply;
binaryfunc nb_inplace_matrix_multiply;
} PyNumberMethods;
(cid:174) Note
Binaryandternaryfunctionsmustcheckthetypeofalltheiroperands,andimplementthenecessarycon-
versions (at least one ofthe operands is an instanceof the defined type). If the operation isnot defined
forthegivenoperands,binaryandternaryfunctionsmustreturnPy_NotImplemented,ifanothererror
occurredtheymustreturnNULLandsetanexception.
(cid:174) Note
Thenb_reserved fieldshouldalwaysbeNULL.Itwaspreviouslycallednb_long,andwasrenamedin
Python3.0.1.
binaryfuncPyNumberMethods.nb_add
binaryfuncPyNumberMethods.nb_subtract
binaryfuncPyNumberMethods.nb_multiply
binaryfuncPyNumberMethods.nb_remainder
binaryfuncPyNumberMethods.nb_divmod
ternaryfuncPyNumberMethods.nb_power
unaryfuncPyNumberMethods.nb_negative
unaryfuncPyNumberMethods.nb_positive
unaryfuncPyNumberMethods.nb_absolute
342 Chapter13. ObjectImplementationSupport

### 第351页

inquiryPyNumberMethods.nb_bool
unaryfuncPyNumberMethods.nb_invert
binaryfuncPyNumberMethods.nb_lshift
binaryfuncPyNumberMethods.nb_rshift
binaryfuncPyNumberMethods.nb_and
binaryfuncPyNumberMethods.nb_xor
binaryfuncPyNumberMethods.nb_or
unaryfuncPyNumberMethods.nb_int
void*PyNumberMethods.nb_reserved
unaryfuncPyNumberMethods.nb_float
binaryfuncPyNumberMethods.nb_inplace_add
binaryfuncPyNumberMethods.nb_inplace_subtract
binaryfuncPyNumberMethods.nb_inplace_multiply
binaryfuncPyNumberMethods.nb_inplace_remainder
ternaryfuncPyNumberMethods.nb_inplace_power
binaryfuncPyNumberMethods.nb_inplace_lshift
binaryfuncPyNumberMethods.nb_inplace_rshift
binaryfuncPyNumberMethods.nb_inplace_and
binaryfuncPyNumberMethods.nb_inplace_xor
binaryfuncPyNumberMethods.nb_inplace_or
binaryfuncPyNumberMethods.nb_floor_divide
binaryfuncPyNumberMethods.nb_true_divide
binaryfuncPyNumberMethods.nb_inplace_floor_divide
binaryfuncPyNumberMethods.nb_inplace_true_divide
unaryfuncPyNumberMethods.nb_index
binaryfuncPyNumberMethods.nb_matrix_multiply
binaryfuncPyNumberMethods.nb_inplace_matrix_multiply
13.4.9 Mapping Object Structures
typePyMappingMethods
Thisstructureholdspointerstothefunctionswhichanobjectusestoimplementthemappingprotocol. Ithas
threemembers:
lenfuncPyMappingMethods.mp_length
ThisfunctionisusedbyPyMapping_Size()andPyObject_Size(),andhasthesamesignature. Thisslot
maybesettoNULLiftheobjecthasnodefinedlength.
13.4. TypeObjectStructures 343

### 第352页

binaryfuncPyMappingMethods.mp_subscript
ThisfunctionisusedbyPyObject_GetItem()andPySequence_GetSlice(),andhasthesamesignature
asPyObject_GetItem(). ThisslotmustbefilledforthePyMapping_Check()functiontoreturn1,itcan
beNULLotherwise.
objobjargprocPyMappingMethods.mp_ass_subscript
ThisfunctionisusedbyPyObject_SetItem(),PyObject_DelItem(),PySequence_SetSlice()and
PySequence_DelSlice(). IthasthesamesignatureasPyObject_SetItem(), butvcanalsobesetto
NULLtodeleteanitem. IfthisslotisNULL,theobjectdoesnotsupportitemassignmentanddeletion.
13.4.10 Sequence Object Structures
typePySequenceMethods
Thisstructureholdspointerstothefunctionswhichanobjectusestoimplementthesequenceprotocol.
lenfuncPySequenceMethods.sq_length
This function is used by PySequence_Size() and PyObject_Size(), and has the same signature. It is
alsousedforhandlingnegativeindicesviathesq_itemandthesq_ass_itemslots.
binaryfuncPySequenceMethods.sq_concat
ThisfunctionisusedbyPySequence_Concat()andhasthesamesignature. Itisalsousedbythe+operator,
aftertryingthenumericadditionviathenb_addslot.
ssizeargfuncPySequenceMethods.sq_repeat
ThisfunctionisusedbyPySequence_Repeat()andhasthesamesignature. Itisalsousedbythe*operator,
aftertryingnumericmultiplicationviathenb_multiplyslot.
ssizeargfuncPySequenceMethods.sq_item
This function is used by PySequence_GetItem() and has the same signature. It is also used by
PyObject_GetItem(),aftertryingthesubscriptionviathemp_subscriptslot. Thisslotmustbefilledfor
thePySequence_Check()functiontoreturn1,itcanbeNULLotherwise.
Negativeindexesarehandledasfollows: ifthesq_lengthslotisfilled,itiscalledandthesequencelengthis
usedtocomputeapositiveindexwhichispassedtosq_item. Ifsq_lengthisNULL,theindexispassedas
istothefunction.
ssizeobjargprocPySequenceMethods.sq_ass_item
This function is used by PySequence_SetItem() and has the same signature. It is also used by
PyObject_SetItem()andPyObject_DelItem(), aftertryingtheitemassignmentanddeletionviathe
mp_ass_subscriptslot. ThisslotmaybelefttoNULLiftheobjectdoesnotsupportitemassignmentand
deletion.
objobjprocPySequenceMethods.sq_contains
ThisfunctionmaybeusedbyPySequence_Contains()andhasthesamesignature. Thisslotmaybeleft
toNULL,inthiscasePySequence_Contains()simplytraversesthesequenceuntilitfindsamatch.
binaryfuncPySequenceMethods.sq_inplace_concat
ThisfunctionisusedbyPySequence_InPlaceConcat()andhasthesamesignature. Itshouldmodifyits
firstoperand,andreturnit. ThisslotmaybelefttoNULL,inthiscasePySequence_InPlaceConcat()will
fallbacktoPySequence_Concat(). Itisalsousedbytheaugmentedassignment+=,aftertryingnumeric
in-placeadditionviathenb_inplace_addslot.
ssizeargfuncPySequenceMethods.sq_inplace_repeat
ThisfunctionisusedbyPySequence_InPlaceRepeat()andhasthesamesignature. Itshouldmodifyits
firstoperand,andreturnit. ThisslotmaybelefttoNULL,inthiscasePySequence_InPlaceRepeat()will
fallbacktoPySequence_Repeat(). Itisalsousedbytheaugmentedassignment*=,aftertryingnumeric
in-placemultiplicationviathenb_inplace_multiplyslot.
344 Chapter13. ObjectImplementationSupport

### 第353页

13.4.11 Buffer Object Structures
typePyBufferProcs
This structure holds pointers to the functions required by the Buffer protocol. The protocol defines how an
exporterobjectcanexposeitsinternaldatatoconsumerobjects.
getbufferprocPyBufferProcs.bf_getbuffer
Thesignatureofthisfunctionis:
int (PyObject *exporter, Py_buffer *view, int flags);
Handlearequesttoexportertofillinviewasspecifiedbyflags. Exceptforpoint(3),animplementationofthis
functionMUSTtakethesesteps:
(1) Checkiftherequestcanbemet. Ifnot,raiseBufferError,setview->objtoNULLandreturn-1.
(2) Fillintherequestedfields.
(3) Incrementaninternalcounterforthenumberofexports.
(4) Setview->objtoexporterandincrementview->obj.
(5) Return0.
Ifexporterispartofachainortreeofbufferproviders,twomainschemescanbeused:
• Re-export: Eachmemberofthetreeactsastheexportingobjectandsetsview->objtoanewreference
toitself.
• Redirect: Thebufferrequestisredirectedtotherootobjectofthetree. Here,view->objwillbeanew
referencetotherootobject.
TheindividualfieldsofviewaredescribedinsectionBufferstructure,theruleshowanexportermustreactto
specificrequestsareinsectionBufferrequesttypes.
AllmemorypointedtointhePy_bufferstructurebelongstotheexporterandmustremainvaliduntilthereare
noconsumersleft. format,shape,strides,suboffsetsandinternalareread-onlyfortheconsumer.
PyBuffer_FillInfo()providesaneasywayofexposingasimplebytesbufferwhiledealingcorrectlywith
allrequesttypes.
PyObject_GetBuffer()istheinterfacefortheconsumerthatwrapsthisfunction.
releasebufferprocPyBufferProcs.bf_releasebuffer
Thesignatureofthisfunctionis:
void (PyObject *exporter, Py_buffer *view);
Handlearequesttoreleasetheresourcesofthebuffer. Ifnoresourcesneedtobereleased,PyBufferProcs.
bf_releasebuffer may be NULL. Otherwise, a standard implementation of this function will take these
optionalsteps:
(1) Decrementaninternalcounterforthenumberofexports.
(2) Ifthecounteris0,freeallmemoryassociatedwithview.
TheexporterMUSTusetheinternalfieldtokeeptrackofbuffer-specificresources. Thisfieldisguaranteed
toremainconstant,whileaconsumerMAYpassacopyoftheoriginalbufferastheviewargument.
ThisfunctionMUSTNOTdecrementview->obj,sincethatisdoneautomaticallyinPyBuffer_Release()
(thisschemeisusefulforbreakingreferencecycles).
PyBuffer_Release()istheinterfacefortheconsumerthatwrapsthisfunction.
13.4. TypeObjectStructures 345

### 第354页

13.4.12 Async Object Structures
Addedinversion3.5.
typePyAsyncMethods
Thisstructureholdspointerstothefunctionsrequiredtoimplementawaitableandasynchronousiteratorob-
jects.
Hereisthestructuredefinition:
typedef struct {
unaryfunc am_await;
unaryfunc am_aiter;
unaryfunc am_anext;
sendfunc am_send;
} PyAsyncMethods;
unaryfuncPyAsyncMethods.am_await
Thesignatureofthisfunctionis:
PyObject *am_await(PyObject *self);
Thereturnedobjectmustbeaniterator,i.e. PyIter_Check()mustreturn1forit.
ThisslotmaybesettoNULLifanobjectisnotanawaitable.
unaryfuncPyAsyncMethods.am_aiter
Thesignatureofthisfunctionis:
PyObject *am_aiter(PyObject *self);
Mustreturnanasynchronousiteratorobject. See__anext__()fordetails.
ThisslotmaybesettoNULLifanobjectdoesnotimplementasynchronousiterationprotocol.
unaryfuncPyAsyncMethods.am_anext
Thesignatureofthisfunctionis:
PyObject *am_anext(PyObject *self);
Mustreturnanawaitableobject. See__anext__()fordetails. ThisslotmaybesettoNULL.
sendfuncPyAsyncMethods.am_send
Thesignatureofthisfunctionis:
PySendResult am_send(PyObject *self, PyObject *arg, PyObject **result);
SeePyIter_Send()fordetails. ThisslotmaybesettoNULL.
Addedinversion3.10.
13.4.13 Slot Type typedefs
typedefPyObject*(*allocfunc)(PyTypeObject*cls,Py_ssize_tnitems)
PartoftheStableABI.Thepurposeofthisfunctionistoseparatememoryallocationfrommemoryinitial-
ization. Itshouldreturnapointertoablockofmemoryofadequatelengthfortheinstance,suitablyaligned,
and initialized to zeros, but with ob_refcnt set to 1 and ob_type set to the type argument. If the type’s
tp_itemsize is non-zero, the object’s ob_size field should be initialized to nitems and the length of the
allocatedmemoryblockshouldbetp_basicsize + nitems*tp_itemsize,roundeduptoamultipleof
sizeof(void*);otherwise,nitemsisnotusedandthelengthoftheblockshouldbetp_basicsize.
Thisfunctionshouldnotdoanyotherinstanceinitialization,noteventoallocateadditionalmemory;thatshould
bedonebytp_new.
346 Chapter13. ObjectImplementationSupport

### 第355页

typedefvoid(*destructor)(PyObject*)
PartoftheStableABI.
typedefvoid(*freefunc)(void*)
Seetp_free.
typedefPyObject*(*newfunc)(PyTypeObject*,PyObject*,PyObject*)
PartoftheStableABI.Seetp_new.
typedefint(*initproc)(PyObject*,PyObject*,PyObject*)
PartoftheStableABI.Seetp_init.
typedefPyObject*(*reprfunc)(PyObject*)
PartoftheStableABI.Seetp_repr.
typedefPyObject*(*getattrfunc)(PyObject*self,char*attr)
PartoftheStableABI.Returnthevalueofthenamedattributefortheobject.
typedefint(*setattrfunc)(PyObject*self,char*attr,PyObject*value)
PartoftheStableABI.Setthevalueofthenamedattributefortheobject. ThevalueargumentissettoNULL
todeletetheattribute.
typedefPyObject*(*getattrofunc)(PyObject*self,PyObject*attr)
PartoftheStableABI.Returnthevalueofthenamedattributefortheobject.
Seetp_getattro.
typedefint(*setattrofunc)(PyObject*self,PyObject*attr,PyObject*value)
PartoftheStableABI.Setthevalueofthenamedattributefortheobject. ThevalueargumentissettoNULL
todeletetheattribute.
Seetp_setattro.
typedefPyObject*(*descrgetfunc)(PyObject*,PyObject*,PyObject*)
PartoftheStableABI.Seetp_descr_get.
typedefint(*descrsetfunc)(PyObject*,PyObject*,PyObject*)
PartoftheStableABI.Seetp_descr_set.
typedefPy_hash_t(*hashfunc)(PyObject*)
PartoftheStableABI.Seetp_hash.
typedefPyObject*(*richcmpfunc)(PyObject*,PyObject*,int)
PartoftheStableABI.Seetp_richcompare.
typedefPyObject*(*getiterfunc)(PyObject*)
PartoftheStableABI.Seetp_iter.
typedefPyObject*(*iternextfunc)(PyObject*)
PartoftheStableABI.Seetp_iternext.
typedefPy_ssize_t(*lenfunc)(PyObject*)
PartoftheStableABI.
typedefint(*getbufferproc)(PyObject*,Py_buffer*,int)
PartoftheStableABIsinceversion3.12.
typedefvoid(*releasebufferproc)(PyObject*,Py_buffer*)
PartoftheStableABIsinceversion3.12.
typedefPyObject*(*unaryfunc)(PyObject*)
PartoftheStableABI.
13.4. TypeObjectStructures 347

### 第356页

typedefPyObject*(*binaryfunc)(PyObject*,PyObject*)
PartoftheStableABI.
typedefPySendResult(*sendfunc)(PyObject*,PyObject*,PyObject**)
Seeam_send.
typedefPyObject*(*ternaryfunc)(PyObject*,PyObject*,PyObject*)
PartoftheStableABI.
typedefPyObject*(*ssizeargfunc)(PyObject*,Py_ssize_t)
PartoftheStableABI.
typedefint(*ssizeobjargproc)(PyObject*,Py_ssize_t,PyObject*)
PartoftheStableABI.
typedefint(*objobjproc)(PyObject*,PyObject*)
PartoftheStableABI.
typedefint(*objobjargproc)(PyObject*,PyObject*,PyObject*)
PartoftheStableABI.
13.4.14 Examples
The following are simple examples of Python type definitions. They include common usage you may encounter.
Somedemonstratetrickycornercases. Formoreexamples,practicalinfo,andatutorial,seedefining-new-typesand
new-types-topics.
Abasicstatictype:
typedef struct {
PyObject_HEAD
const char *data;
} MyObject;
static PyTypeObject MyObject_Type = {
PyVarObject_HEAD_INIT(NULL, 0)
.tp_name = "mymod.MyObject",
.tp_basicsize = sizeof(MyObject),
.tp_doc = PyDoc_STR("My objects"),
.tp_new = myobj_new,
.tp_dealloc = (destructor)myobj_dealloc,
.tp_repr = (reprfunc)myobj_repr,
};
Youmayalsofindoldercode(especiallyintheCPythoncodebase)withamoreverboseinitializer:
static PyTypeObject MyObject_Type = {
PyVarObject_HEAD_INIT(NULL, 0)
"mymod.MyObject", /* tp_name */
sizeof(MyObject), /* tp_basicsize */
0, /* tp_itemsize */
(destructor)myobj_dealloc, /* tp_dealloc */
0, /* tp_vectorcall_offset */
0, /* tp_getattr */
0, /* tp_setattr */
0, /* tp_as_async */
(reprfunc)myobj_repr, /* tp_repr */
0, /* tp_as_number */
0, /* tp_as_sequence */
0, /* tp_as_mapping */
(continuesonnextpage)
348 Chapter13. ObjectImplementationSupport

### 第357页

(continuedfrompreviouspage)
0, /* tp_hash */
0, /* tp_call */
0, /* tp_str */
0, /* tp_getattro */
0, /* tp_setattro */
0, /* tp_as_buffer */
0, /* tp_flags */
PyDoc_STR("My objects"), /* tp_doc */
0, /* tp_traverse */
0, /* tp_clear */
0, /* tp_richcompare */
0, /* tp_weaklistoffset */
0, /* tp_iter */
0, /* tp_iternext */
0, /* tp_methods */
0, /* tp_members */
0, /* tp_getset */
0, /* tp_base */
0, /* tp_dict */
0, /* tp_descr_get */
0, /* tp_descr_set */
0, /* tp_dictoffset */
0, /* tp_init */
0, /* tp_alloc */
myobj_new, /* tp_new */
};
Atypethatsupportsweakrefs,instancedicts,andhashing:
typedef struct {
PyObject_HEAD
const char *data;
} MyObject;
static PyTypeObject MyObject_Type = {
PyVarObject_HEAD_INIT(NULL, 0)
.tp_name = "mymod.MyObject",
.tp_basicsize = sizeof(MyObject),
.tp_doc = PyDoc_STR("My objects"),
.tp_flags = Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE |
Py_TPFLAGS_HAVE_GC | Py_TPFLAGS_MANAGED_DICT |
Py_TPFLAGS_MANAGED_WEAKREF,
.tp_new = myobj_new,
.tp_traverse = (traverseproc)myobj_traverse,
.tp_clear = (inquiry)myobj_clear,
.tp_alloc = PyType_GenericNew,
.tp_dealloc = (destructor)myobj_dealloc,
.tp_repr = (reprfunc)myobj_repr,
.tp_hash = (hashfunc)myobj_hash,
.tp_richcompare = PyBaseObject_Type.tp_richcompare,
};
Astrsubclassthatcannotbesubclassedandcannotbecalledtocreateinstances(e.g. usesaseparatefactoryfunc)
usingPy_TPFLAGS_DISALLOW_INSTANTIATION flag:
typedef struct {
PyUnicodeObject raw;
(continuesonnextpage)
13.4. TypeObjectStructures 349

### 第358页

(continuedfrompreviouspage)
char *extra;
} MyStr;
static PyTypeObject MyStr_Type = {
PyVarObject_HEAD_INIT(NULL, 0)
.tp_name = "mymod.MyStr",
.tp_basicsize = sizeof(MyStr),
.tp_base = NULL, // set to &PyUnicode_Type in module init
.tp_doc = PyDoc_STR("my custom str"),
.tp_flags = Py_TPFLAGS_DEFAULT | Py_TPFLAGS_DISALLOW_INSTANTIATION,
.tp_repr = (reprfunc)myobj_repr,
};
Thesimpleststatictypewithfixed-lengthinstances:
typedef struct {
PyObject_HEAD
} MyObject;
static PyTypeObject MyObject_Type = {
PyVarObject_HEAD_INIT(NULL, 0)
.tp_name = "mymod.MyObject",
};
Thesimpleststatictypewithvariable-lengthinstances:
typedef struct {
PyObject_VAR_HEAD
const char *data[1];
} MyObject;
static PyTypeObject MyObject_Type = {
PyVarObject_HEAD_INIT(NULL, 0)
.tp_name = "mymod.MyObject",
.tp_basicsize = sizeof(MyObject) - sizeof(char *),
.tp_itemsize = sizeof(char *),
};
13.5 Supporting Cyclic Garbage Collection
Python’ssupportfordetectingandcollectinggarbagewhichinvolvescircularreferencesrequiressupportfromobject
typeswhichare“containers”forotherobjectswhichmayalsobecontainers. Typeswhichdonotstorereferencesto
otherobjects,orwhichonlystorereferencestoatomictypes(suchasnumbersorstrings),donotneedtoprovideany
explicitsupportforgarbagecollection.
To create a container type, the tp_flags field of the type object must include the Py_TPFLAGS_HAVE_GC and
provideanimplementationofthetp_traversehandler. Ifinstancesofthetypearemutable,atp_clearimple-
mentationmustalsobeprovided.
Py_TPFLAGS_HAVE_GC
Objectswithatypewiththisflagsetmustconformwiththerulesdocumentedhere. Forconveniencethese
objectswillbereferredtoascontainerobjects.
Constructorsforcontainertypesmustconformtotworules:
1. ThememoryfortheobjectmustbeallocatedusingPyObject_GC_NeworPyObject_GC_NewVar.
2. Once all the fields which may contain references to other containers are initialized, it must call
PyObject_GC_Track().
350 Chapter13. ObjectImplementationSupport

### 第359页

Similarly,thedeallocatorfortheobjectmustconformtoasimilarpairofrules:
1. Beforefieldswhichrefertoothercontainersareinvalidated,PyObject_GC_UnTrack()mustbecalled.
2. Theobject’smemorymustbedeallocatedusingPyObject_GC_Del().
(cid:193) Warning
IfatypeaddsthePy_TPFLAGS_HAVE_GC,thenitmustimplementatleastatp_traversehandleror
explicitlyuseonefromitssubclassorsubclasses.
When calling PyType_Ready() or some of the APIs that indirectly call it like
PyType_FromSpecWithBases()orPyType_FromSpec()theinterpreterwillautomaticallypopulate
thetp_flags,tp_traverseandtp_clearfieldsifthetypeinheritsfromaclassthatimplementsthe
garbagecollectorprotocolandthechildclassdoesnotincludethePy_TPFLAGS_HAVE_GCflag.
PyObject_GC_New(TYPE,typeobj)
AnalogoustoPyObject_NewbutforcontainerobjectswiththePy_TPFLAGS_HAVE_GCflagset.
Donotcallthisdirectlytoallocatememoryforanobject;callthetype’stp_allocslotinstead.
When populating a type’s tp_alloc slot, PyType_GenericAlloc() is preferred over a custom function
thatsimplycallsthismacro.
Memory allocated by this macro must be freed with PyObject_GC_Del() (usually called via the object’s
tp_freeslot).
(cid:181) Seealso
• PyObject_GC_Del()
• PyObject_New
• PyType_GenericAlloc()
• tp_alloc
PyObject_GC_NewVar(TYPE,typeobj,size)
AnalogoustoPyObject_NewVarbutforcontainerobjectswiththePy_TPFLAGS_HAVE_GCflagset.
Donotcallthisdirectlytoallocatememoryforanobject;callthetype’stp_allocslotinstead.
When populating a type’s tp_alloc slot, PyType_GenericAlloc() is preferred over a custom function
thatsimplycallsthismacro.
Memory allocated by this macro must be freed with PyObject_GC_Del() (usually called via the object’s
tp_freeslot).
(cid:181) Seealso
• PyObject_GC_Del()
• PyObject_NewVar
• PyType_GenericAlloc()
• tp_alloc
PyObject*PyUnstable_Object_GC_NewWithExtraData(PyTypeObject*type,size_textra_size)
13.5. SupportingCyclicGarbageCollection 351

| (cid:193) Warning |
| --- |
| IfatypeaddsthePy_TPFLAGS_HAVE_GC,thenitmustimplementatleastatp_traversehandleror
explicitlyuseonefromitssubclassorsubclasses.
When calling PyType_Ready() or some of the APIs that indirectly call it like
PyType_FromSpecWithBases()orPyType_FromSpec()theinterpreterwillautomaticallypopulate
thetp_flags,tp_traverseandtp_clearfieldsifthetypeinheritsfromaclassthatimplementsthe
garbagecollectorprotocolandthechildclassdoesnotincludethePy_TPFLAGS_HAVE_GCflag. |


| (cid:181) Seealso |
| --- |
| • PyObject_GC_Del()
• PyObject_New
• PyType_GenericAlloc()
• tp_alloc |


| (cid:181) Seealso |
| --- |
| • PyObject_GC_Del()
• PyObject_NewVar
• PyType_GenericAlloc()
• tp_alloc |

### 第360页

(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
Analogous to PyObject_GC_New but allocates extra_size bytes at the end of the object (at offset
tp_basicsize). Theallocatedmemoryisinitializedtozeros,exceptforthePython object header.
Theextradatawillbedeallocatedwiththeobject,butotherwiseitisnotmanagedbyPython.
MemoryallocatedbythisfunctionmustbefreedwithPyObject_GC_Del()(usuallycalledviatheobject’s
tp_freeslot).
(cid:193) Warning
Thefunctionismarkedasunstablebecausethefinalmechanismforreservingextradataafteraninstanceis
notyetdecided. Forallocatingavariablenumberoffields,preferusingPyVarObjectandtp_itemsize
instead.
Addedinversion3.12.
PyObject_GC_Resize(TYPE,op,newsize)
ResizeanobjectallocatedbyPyObject_NewVar. ReturnstheresizedobjectoftypeTYPE*(referstoanyC
type)orNULLonfailure.
op must be of type PyVarObject* and must not be tracked by the collector yet. newsize must be of type
Py_ssize_t.
voidPyObject_GC_Track(PyObject*op)
PartoftheStableABI.Addstheobjectoptothesetofcontainerobjectstrackedbythecollector. Thecollector
canrunatunexpectedtimessoobjectsmustbevalidwhilebeingtracked. Thisshouldbecalledonceallthe
fieldsfollowedbythetp_traversehandlerbecomevalid,usuallyneartheendoftheconstructor.
intPyObject_IS_GC(PyObject*obj)
Returnsnon-zeroiftheobjectimplementsthegarbagecollectorprotocol,otherwisereturns0.
Theobjectcannotbetrackedbythegarbagecollectorifthisfunctionreturns0.
intPyObject_GC_IsTracked(PyObject*op)
PartoftheStableABIsinceversion3.9. Returns1iftheobjecttypeofopimplementstheGCprotocoland
opisbeingcurrentlytrackedbythegarbagecollectorand0otherwise.
ThisisanalogoustothePythonfunctiongc.is_tracked().
Addedinversion3.9.
intPyObject_GC_IsFinalized(PyObject*op)
PartoftheStableABIsinceversion3.9. Returns1iftheobjecttypeofopimplementstheGCprotocoland
ophasbeenalreadyfinalizedbythegarbagecollectorand0otherwise.
ThisisanalogoustothePythonfunctiongc.is_finalized().
Addedinversion3.9.
voidPyObject_GC_Del(void*op)
Part of the Stable ABI. Releases memory allocated to an object using PyObject_GC_New or
PyObject_GC_NewVar.
Donotcallthisdirectlytofreeanobject’smemory;callthetype’stp_freeslotinstead.
DonotusethisformemoryallocatedbyPyObject_New,PyObject_NewVar,orrelatedallocationfunctions;
usePyObject_Free()instead.
352 Chapter13. ObjectImplementationSupport

| (cid:193) Warning |
| --- |
| Thefunctionismarkedasunstablebecausethefinalmechanismforreservingextradataafteraninstanceis
notyetdecided. Forallocatingavariablenumberoffields,preferusingPyVarObjectandtp_itemsize
instead. |

### 第361页

(cid:181) Seealso
• PyObject_Free()isthenon-GCequivalentofthisfunction.
• PyObject_GC_New
• PyObject_GC_NewVar
• PyType_GenericAlloc()
• tp_free
voidPyObject_GC_UnTrack(void*op)
PartoftheStableABI.Removetheobjectopfromthesetofcontainerobjectstrackedbythecollector. Note
thatPyObject_GC_Track()canbecalledagainonthisobjecttoadditbacktothesetoftrackedobjects.
The deallocator (tp_dealloc handler) should call this for the object before any of the fields used by the
tp_traversehandlerbecomeinvalid.
Changed in version 3.8: The _PyObject_GC_TRACK() and _PyObject_GC_UNTRACK() macros have been re-
movedfromthepublicCAPI.
Thetp_traversehandleracceptsafunctionparameterofthistype:
typedefint(*visitproc)(PyObject*object,void*arg)
PartoftheStableABI.Typeofthevisitorfunctionpassedtothetp_traversehandler. Thefunctionshould
becalledwithanobjecttotraverseasobjectandthethirdparametertothetp_traversehandlerasarg. The
Pythoncoreusesseveralvisitorfunctionstoimplementcyclicgarbagedetection; it’snotexpectedthatusers
willneedtowritetheirownvisitorfunctions.
Thetp_traversehandlermusthavethefollowingtype:
typedefint(*traverseproc)(PyObject*self,visitprocvisit,void*arg)
PartoftheStableABI.Traversalfunctionforacontainerobject. Implementationsmustcallthevisitfunction
foreachobjectdirectlycontainedbyself,withtheparameterstovisit beingthecontainedobjectandthearg
valuepassedtothehandler. ThevisitfunctionmustnotbecalledwithaNULLobjectargument. Ifvisitreturns
anon-zerovaluethatvalueshouldbereturnedimmediately.
To simplify writing tp_traverse handlers, a Py_VISIT() macro is provided. In order to use this macro, the
tp_traverseimplementationmustnameitsargumentsexactlyvisitandarg:
Py_VISIT(o)
IfthePyObject*oisnotNULL,callthevisit callback,withargumentsoandarg. Ifvisit returnsanon-zero
value,thenreturnit. Usingthismacro,tp_traversehandlerslooklike:
static int
my_traverse(Noddy *self, visitproc visit, void *arg)
{
Py_VISIT(self->foo);
Py_VISIT(self->bar);
return 0;
}
Thetp_clearhandlermustbeoftheinquirytype,orNULLiftheobjectisimmutable.
typedefint(*inquiry)(PyObject*self)
Part of the Stable ABI. Drop references that may have created reference cycles. Immutable objects do not
havetodefinethismethodsincetheycanneverdirectlycreatereferencecycles. Notethattheobjectmuststill
bevalidaftercallingthismethod(don’tjustcallPy_DECREF()onareference). Thecollectorwillcallthis
methodifitdetectsthatthisobjectisinvolvedinareferencecycle.
13.5. SupportingCyclicGarbageCollection 353

| (cid:181) Seealso |
| --- |
| • PyObject_Free()isthenon-GCequivalentofthisfunction.
• PyObject_GC_New
• PyObject_GC_NewVar
• PyType_GenericAlloc()
• tp_free |

### 第362页

13.5.1 Controlling the Garbage Collector State
TheC-APIprovidesthefollowingfunctionsforcontrollinggarbagecollectionruns.
Py_ssize_tPyGC_Collect(void)
PartoftheStableABI.Performafullgarbagecollection,ifthegarbagecollectorisenabled. (Notethatgc.
collect()runsitunconditionally.)
Returns the number of collected + unreachable objects which cannot be collected. If the garbage collector
isdisabledoralreadycollecting,returns0immediately. Errorsduringgarbagecollectionarepassedtosys.
unraisablehook. Thisfunctiondoesnotraiseexceptions.
intPyGC_Enable(void)
PartoftheStableABIsinceversion3.10. Enablethegarbagecollector: similartogc.enable(). Returnsthe
previousstate,0fordisabledand1forenabled.
Addedinversion3.10.
intPyGC_Disable(void)
PartoftheStableABIsinceversion3.10. Disablethegarbagecollector: similartogc.disable(). Returns
thepreviousstate,0fordisabledand1forenabled.
Addedinversion3.10.
intPyGC_IsEnabled(void)
Part of the Stable ABI since version 3.10. Query the state of the garbage collector: similar to gc.
isenabled(). Returnsthecurrentstate,0fordisabledand1forenabled.
Addedinversion3.10.
13.5.2 Querying Garbage Collector State
TheC-APIprovidesthefollowinginterfaceforqueryinginformationaboutthegarbagecollector.
voidPyUnstable_GC_VisitObjects(gcvisitobjects_tcallback,void*arg)
(cid:174)
ThisisUnstableAPI.Itmaychangewithoutwarninginminorreleases.
RunsuppliedcallbackonallliveGC-capableobjects. argispassedthroughtoallinvocationsofcallback.
(cid:193) Warning
Ifnewobjectsare(de)allocatedbythecallbackitisundefinediftheywillbevisited.
Garbagecollectionisdisabledduringoperation. Explicitlyrunningacollectioninthecallbackmaylead
toundefinedbehavioure.g. visitingthesameobjectsmultipletimesornotatall.
Addedinversion3.12.
typedefint(*gcvisitobjects_t)(PyObject*object,void*arg)
TypeofthevisitorfunctiontobepassedtoPyUnstable_GC_VisitObjects(). argisthesameasthearg
passedtoPyUnstable_GC_VisitObjects. Return1tocontinueiteration,return0tostopiteration. Other
returnvaluesarereservedfornowsobehavioronreturninganythingelseisundefined.
Addedinversion3.12.
354 Chapter13. ObjectImplementationSupport

| (cid:193) Warning |
| --- |
| Ifnewobjectsare(de)allocatedbythecallbackitisundefinediftheywillbevisited.
Garbagecollectionisdisabledduringoperation. Explicitlyrunningacollectioninthecallbackmaylead
toundefinedbehavioure.g. visitingthesameobjectsmultipletimesornotatall. |

### 第363页

CHAPTER
FOURTEEN
API AND ABI VERSIONING
14.1 Build-time version constants
CPythonexposesitsversionnumberinthefollowingmacros. Notethatthesecorrespondtotheversioncodeisbuilt
with. SeePy_Versionfortheversionusedatruntime.
SeeCAPIStabilityforadiscussionofAPIandABIstabilityacrossversions.
PY_MAJOR_VERSION
The3in3.4.1a2.
PY_MINOR_VERSION
The4in3.4.1a2.
PY_MICRO_VERSION
The1in3.4.1a2.
PY_RELEASE_LEVEL
Theain3.4.1a2. Thiscanbe0xAforalpha,0xBforbeta,0xCforreleasecandidateor0xFforfinal.
PY_RELEASE_SERIAL
The2in3.4.1a2. Zeroforfinalreleases.
PY_VERSION_HEX
ThePythonversionnumberencodedinasingleinteger. SeePy_PACK_FULL_VERSION()fortheencoding
details.
Usethisfornumericcomparisons,forexample,#if PY_VERSION_HEX >= ....
14.2 Run-time version
constunsignedlongPy_Version
PartoftheStableABIsinceversion3.11. ThePythonruntimeversionnumberencodedinasingleconstant
integer. SeePy_PACK_FULL_VERSION()fortheencodingdetails. ThiscontainsthePythonversionusedat
runtime.
Usethisfornumericcomparisons,forexample,if (Py_Version >= ...).
Addedinversion3.11.
14.3 Bit-packing macros
uint32_tPy_PACK_FULL_VERSION(intmajor,intminor,intmicro,intrelease_level,intrelease_serial)
PartoftheStableABIsinceversion3.14. Returnthegivenversion,encodedasasingle32-bitintegerwiththe
followingstructure:
355

### 第364页

Argument No. ofbits Bitmask Bitshift Examplevalues
3.4.1a2 3.10.0
major 8 0xFF000000 24 0x03 0x03
minor 8 0x00FF0000 16 0x04 0x0A
micro 8 0x0000FF00 8 0x01 0x00
release_level 4 0x000000F0 4 0xA 0xF
release_serial 4 0x0000000F 0 0x2 0x0
Forexample:
Version Py_PACK_FULL_VERSIONarguments Encodedversion
3.4.1a2 (3, 4, 1, 0xA, 2) 0x030401a2
3.10.0 (3, 10, 0, 0xF, 0) 0x030a00f0
Out-ofrangebitsintheargumentsareignored. Thatis,themacrocanbedefinedas:
#ifndef Py_PACK_FULL_VERSION
#define Py_PACK_FULL_VERSION(X, Y, Z, LEVEL, SERIAL) ( \
(((X) & 0xff) << 24) | \
(((Y) & 0xff) << 16) | \
(((Z) & 0xff) << 8) | \
(((LEVEL) & 0xf) << 4) | \
(((SERIAL) & 0xf) << 0))
#endif
Py_PACK_FULL_VERSIONisprimarilyamacro,intendedforusein#ifdirectives,butitisalsoavailableas
anexportedfunction.
Addedinversion3.14.
uint32_tPy_PACK_VERSION(intmajor,intminor)
Part of the Stable ABI since version 3.14. Equivalent to Py_PACK_FULL_VERSION(major, minor, 0,
0, 0). TheresultdoesnotcorrespondtoanyPythonrelease,butisusefulinnumericcomparisons.
Addedinversion3.14.
356 Chapter14. APIandABIVersioning

| Examplev | alues |
| --- | --- |


| major | 8 | 0xFF000000 | 24 | 0x03 | 0x03 |
| --- | --- | --- | --- | --- | --- |
| minor | 8 | 0x00FF0000 | 16 | 0x04 | 0x0A |
| micro | 8 | 0x0000FF00 | 8 | 0x01 | 0x00 |
| release_level | 4 | 0x000000F0 | 4 | 0xA | 0xF |
| release_serial | 4 | 0x0000000F | 0 | 0x2 | 0x0 |


| Version | Py_PACK_FULL_VERSIONarguments | Encodedversion |
| --- | --- | --- |
| 3.4.1a2 | (3, 4, 1, 0xA, 2) | 0x030401a2 |
| 3.10.0 | (3, 10, 0, 0xF, 0) | 0x030a00f0 |

### 第365页

CHAPTER
FIFTEEN
MONITORING C API
Addedinversion3.13.
Anextensionmayneedtointeractwiththeeventmonitoringsystem. Subscribingtoeventsandregisteringcallbacks
canbedoneviathePythonAPIexposedinsys.monitoring.
357

### 第366页

358 Chapter15. MonitoringCAPI

### 第367页

CHAPTER
SIXTEEN
GENERATING EXECUTION EVENTS
ThefunctionsbelowmakeitpossibleforanextensiontofiremonitoringeventsasitemulatestheexecutionofPython
code. EachofthesefunctionsacceptsaPyMonitoringStatestructwhichcontainsconciseinformationaboutthe
activationstateofevents,aswellastheeventarguments,whichincludeaPyObject*representingthecodeobject,
theinstructionoffsetandsometimesadditional, event-specificarguments(seesys.monitoringfordetailsabout
thesignaturesofthedifferenteventcallbacks). Thecodelikeargumentshouldbeaninstanceoftypes.CodeType
orofatypethatemulatesit.
TheVMdisablestracingwhenfiringanevent,sothereisnoneedforusercodetodothat.
Monitoringfunctionsshouldnotbecalledwithanexceptionset,exceptthoselistedbelowasworkingwiththecurrent
exception.
typePyMonitoringState
Representationofthestateofaneventtype. Itisallocatedbytheuserwhileitscontentsaremaintainedbythe
monitoringAPIfunctionsdescribedbelow.
Allofthefunctionsbelowreturn0onsuccessand-1(withanexceptionset)onerror.
Seesys.monitoringfordescriptionsoftheevents.
intPyMonitoring_FirePyStartEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset)
FireaPY_STARTevent.
intPyMonitoring_FirePyResumeEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset)
FireaPY_RESUMEevent.
intPyMonitoring_FirePyReturnEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset,
PyObject*retval)
FireaPY_RETURNevent.
intPyMonitoring_FirePyYieldEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset,PyObject
*retval)
FireaPY_YIELDevent.
intPyMonitoring_FireCallEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset,PyObject
*callable,PyObject*arg0)
FireaCALLevent.
intPyMonitoring_FireLineEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset,intlineno)
FireaLINEevent.
intPyMonitoring_FireJumpEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset,PyObject
*target_offset)
FireaJUMPevent.
intPyMonitoring_FireBranchLeftEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset,
PyObject*target_offset)
FireaBRANCH_LEFTevent.
359

### 第368页

intPyMonitoring_FireBranchRightEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset,
PyObject*target_offset)
FireaBRANCH_RIGHTevent.
intPyMonitoring_FireCReturnEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset,PyObject
*retval)
FireaC_RETURNevent.
intPyMonitoring_FirePyThrowEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset)
FireaPY_THROWeventwiththecurrentexception(asreturnedbyPyErr_GetRaisedException()).
intPyMonitoring_FireRaiseEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset)
FireaRAISEeventwiththecurrentexception(asreturnedbyPyErr_GetRaisedException()).
intPyMonitoring_FireCRaiseEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset)
FireaC_RAISEeventwiththecurrentexception(asreturnedbyPyErr_GetRaisedException()).
intPyMonitoring_FireReraiseEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset)
FireaRERAISEeventwiththecurrentexception(asreturnedbyPyErr_GetRaisedException()).
intPyMonitoring_FireExceptionHandledEvent(PyMonitoringState*state,PyObject*codelike,int32_t
offset)
Fire an EXCEPTION_HANDLED event with the current exception (as returned by
PyErr_GetRaisedException()).
intPyMonitoring_FirePyUnwindEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset)
FireaPY_UNWINDeventwiththecurrentexception(asreturnedbyPyErr_GetRaisedException()).
intPyMonitoring_FireStopIterationEvent(PyMonitoringState*state,PyObject*codelike,int32_toffset,
PyObject*value)
FireaSTOP_ITERATIONevent. IfvalueisaninstanceofStopIteration, itisused. Otherwise, anew
StopIterationinstanceiscreatedwithvalueasitsargument.
16.1 Managing the Monitoring State
Monitoring states can be managed with the help of monitoring scopes. A scope would typically correspond to a
pythonfunction.
intPyMonitoring_EnterScope(PyMonitoringState*state_array,uint64_t*version,constuint8_t*event_types,
Py_ssize_tlength)
Enter a monitored scope. event_types is an array of the event IDs for events that may be fired from the
scope. Forexample,theIDofaPY_STARTeventisthevaluePY_MONITORING_EVENT_PY_START,whichis
numericallyequaltothebase-2logarithmofsys.monitoring.events.PY_START.state_arrayisan
arraywithamonitoringstateentryforeacheventinevent_types,itisallocatedbytheuserbutpopulated
by PyMonitoring_EnterScope() with information about the activation state of the event. The size of
event_types(andhencealsoofstate_array)isgiveninlength.
The version argument is a pointer to a value which should be allocated by the user together with
state_array and initialized to 0, and then set only by PyMonitoring_EnterScope() itself. It allows
thisfunctiontodeterminewhethereventstateshavechangedsincethepreviouscall,andtoreturnquicklyif
theyhavenot.
Thescopesreferredtoherearelexicalscopes: afunction,classormethod. PyMonitoring_EnterScope()
shouldbecalledwheneverthelexicalscopeisentered. Scopescanbereentered,reusingthesamestate_array
and version, in situations like when emulating a recursive Python function. When a code-like’s execution is
paused,suchaswhenemulatingagenerator,thescopeneedstobeexitedandre-entered.
Themacrosforevent_typesare:
360 Chapter16. GeneratingExecutionEvents

### 第369页

Macro Event
BRANCH_LEFT
PY_MONITORING_EVENT_BRANCH_LEFT
BRANCH_RIGHT
PY_MONITORING_EVENT_BRANCH_RIGHT
CALL
PY_MONITORING_EVENT_CALL
C_RAISE
PY_MONITORING_EVENT_C_RAISE
C_RETURN
PY_MONITORING_EVENT_C_RETURN
EXCEPTION_HANDLED
PY_MONITORING_EVENT_EXCEPTION_HANDLED
INSTRUCTION
PY_MONITORING_EVENT_INSTRUCTION
JUMP
PY_MONITORING_EVENT_JUMP
LINE
PY_MONITORING_EVENT_LINE
PY_RESUME
PY_MONITORING_EVENT_PY_RESUME
PY_RETURN
PY_MONITORING_EVENT_PY_RETURN
PY_START
PY_MONITORING_EVENT_PY_START
PY_THROW
PY_MONITORING_EVENT_PY_THROW
PY_UNWIND
PY_MONITORING_EVENT_PY_UNWIND
PY_YIELD
PY_MONITORING_EVENT_PY_YIELD
RAISE
PY_MONITORING_EVENT_RAISE
RERAISE
PY_MONITORING_EVENT_RERAISE
STOP_ITERATION
PY_MONITORING_EVENT_STOP_ITERATION
intPyMonitoring_ExitScope(void)
16.1. ManagingtheMonitoringState 361

| Macro | Event |
| --- | --- |
| PY_MONITORING_EVENT_BRANCH_LEFT | BRANCH_LEFT |
| PY_MONITORING_EVENT_BRANCH_RIGHT | BRANCH_RIGHT |
| PY_MONITORING_EVENT_CALL | CALL |
| PY_MONITORING_EVENT_C_RAISE | C_RAISE |
| PY_MONITORING_EVENT_C_RETURN | C_RETURN |
| PY_MONITORING_EVENT_EXCEPTION_HANDLED | EXCEPTION_HANDLED |
| PY_MONITORING_EVENT_INSTRUCTION | INSTRUCTION |
| PY_MONITORING_EVENT_JUMP | JUMP |
| PY_MONITORING_EVENT_LINE | LINE |
| PY_MONITORING_EVENT_PY_RESUME | PY_RESUME |
| PY_MONITORING_EVENT_PY_RETURN | PY_RETURN |
| PY_MONITORING_EVENT_PY_START | PY_START |
| PY_MONITORING_EVENT_PY_THROW | PY_THROW |
| PY_MONITORING_EVENT_PY_UNWIND | PY_UNWIND |
| PY_MONITORING_EVENT_PY_YIELD | PY_YIELD |
| PY_MONITORING_EVENT_RAISE | RAISE |
| PY_MONITORING_EVENT_RERAISE | RERAISE |
| PY_MONITORING_EVENT_STOP_ITERATION | STOP_ITERATION |

### 第370页

ExitthelastscopethatwasenteredwithPyMonitoring_EnterScope().
intPY_MONITORING_IS_INSTRUMENTED_EVENT(uint8_tev)
ReturntrueiftheeventcorrespondingtotheeventIDevisalocalevent.
Addedinversion3.13.
Deprecatedsinceversion3.14: Thisfunctionissoftdeprecated.
362 Chapter16. GeneratingExecutionEvents

### 第371页

APPENDIX
A
GLOSSARY
>>>
The default Python prompt of the interactive shell. Often seen for code examples which can be executed
interactivelyintheinterpreter.
...
Canreferto:
• ThedefaultPythonpromptoftheinteractiveshellwhenenteringthecodeforanindentedcodeblock,
when within a pair of matching left and right delimiters (parentheses, square brackets, curly braces or
triplequotes),orafterspecifyingadecorator.
• ThethreedotsformoftheEllipsisobject.
abstractbaseclass
Abstractbaseclassescomplementduck-typingbyprovidingawaytodefineinterfaceswhenothertechniques
likehasattr()wouldbeclumsyorsubtlywrong(forexamplewithmagicmethods). ABCsintroducevirtual
subclasses, which are classes that don’t inherit from a class but are still recognized by isinstance() and
issubclass();seetheabcmoduledocumentation. Pythoncomeswithmanybuilt-inABCsfordatastruc-
tures(inthecollections.abcmodule),numbers(inthenumbersmodule),streams(intheiomodule),
importfindersandloaders(intheimportlib.abcmodule). YoucancreateyourownABCswiththeabc
module.
annotatefunction
A function that can be called to retrieve the annotations of an object. This function is accessible as the
__annotate__ attribute of functions, classes, and modules. Annotate functions are a subset of evaluate
functions.
annotation
Alabelassociatedwithavariable,aclassattributeorafunctionparameterorreturnvalue,usedbyconvention
asatypehint.
Annotations of local variables cannot be accessed at runtime, but annotations of global variables, class at-
tributes, and functions can be retrieved by calling annotationlib.get_annotations() on modules,
classes,andfunctions,respectively.
Seevariableannotation, functionannotation, PEP484, PEP526, andPEP649, whichdescribethisfunc-
tionality. Alsoseeannotations-howtoforbestpracticesonworkingwithannotations.
argument
Avaluepassedtoafunction(ormethod)whencallingthefunction. Therearetwokindsofargument:
• keywordargument: anargumentprecededbyanidentifier(e.g. name=)inafunctioncallorpassedasa
valueinadictionaryprecededby**. Forexample,3and5arebothkeywordargumentsinthefollowing
callstocomplex():
complex(real=3, imag=5)
complex(**{'real': 3, 'imag': 5})
• positionalargument: anargumentthatisnotakeywordargument. Positionalargumentscanappearatthe
beginningofanargumentlistand/orbepassedaselementsofaniterableprecededby*. Forexample,3
363

### 第372页

and5arebothpositionalargumentsinthefollowingcalls:
complex(3, 5)
complex(*(3, 5))
Arguments are assigned to the named local variables in a function body. See the calls section for the rules
governingthisassignment. Syntactically,anyexpressioncanbeusedtorepresentanargument;theevaluated
valueisassignedtothelocalvariable.
Seealsotheparameterglossaryentry,theFAQquestiononthedifferencebetweenargumentsandparameters,
andPEP362.
asynchronouscontextmanager
Anobjectwhichcontrolstheenvironmentseeninanasync withstatementbydefining__aenter__()and
__aexit__()methods. IntroducedbyPEP492.
asynchronousgenerator
Afunctionwhichreturnsanasynchronousgeneratoriterator. Itlookslikeacoroutinefunctiondefinedwith
async def except that it contains yield expressions for producing a series of values usable in an async
forloop.
Usuallyreferstoanasynchronousgeneratorfunction, butmayrefertoanasynchronousgeneratoriterator in
somecontexts. Incaseswheretheintendedmeaningisn’tclear,usingthefulltermsavoidsambiguity.
Anasynchronousgeneratorfunctionmaycontainawaitexpressionsaswellasasync for,andasync with
statements.
asynchronousgeneratoriterator
Anobjectcreatedbyanasynchronousgeneratorfunction.
Thisisanasynchronousiteratorwhichwhencalledusingthe__anext__()methodreturnsanawaitableobject
whichwillexecutethebodyoftheasynchronousgeneratorfunctionuntilthenextyieldexpression.
Eachyieldtemporarilysuspendsprocessing,rememberingtheexecutionstate(includinglocalvariablesand
pendingtry-statements). Whentheasynchronousgeneratoriteratoreffectivelyresumeswithanotherawaitable
returnedby__anext__(),itpicksupwhereitleftoff. SeePEP492andPEP525.
asynchronousiterable
An object, that can be used in an async for statement. Must return an asynchronous iterator from its
__aiter__()method. IntroducedbyPEP492.
asynchronousiterator
An object that implements the __aiter__() and __anext__() methods. __anext__() must return an
awaitableobject. async forresolvestheawaitablesreturnedbyanasynchronousiterator’s__anext__()
methoduntilitraisesaStopAsyncIterationexception. IntroducedbyPEP492.
attachedthreadstate
AthreadstatethatisactiveforthecurrentOSthread.
Whenathreadstateisattached,theOSthreadhasaccesstothefullPythonCAPIandcansafelyinvokethe
bytecodeinterpreter.
Unlessafunctionexplicitlynotesotherwise,attemptingtocalltheCAPIwithoutanattachedthreadstatewill
result in a fatal error or undefined behavior. A thread state can be attached and detached explicitly by the
userthroughtheCAPI,orimplicitlybytheruntime,includingduringblockingCcallsandbythebytecode
interpreterinbetweencalls.
OnmostbuildsofPython,havinganattachedthreadstateimpliesthatthecallerholdstheGILforthecurrent
interpreter,soonlyoneOSthreadcanhaveanattachedthreadstateatagivenmoment. Infree-threadedbuilds
ofPython,threadscanconcurrentlyholdanattachedthreadstate,allowingfortrueparallelismofthebytecode
interpreter.
attribute
Avalueassociatedwithanobjectwhichisusuallyreferencedbynameusingdottedexpressions. Forexample,
ifanobjectohasanattributeaitwouldbereferencedaso.a.
364 AppendixA. Glossary

### 第373页

Itispossibletogiveanobjectanattributewhosenameisnotanidentifierasdefinedbyidentifiers,forexample
usingsetattr(),iftheobjectallowsit. Suchanattributewillnotbeaccessibleusingadottedexpression,
andwouldinsteadneedtoberetrievedwithgetattr().
awaitable
Anobjectthatcanbeusedinanawaitexpression. Canbeacoroutineoranobjectwithan__await__()
method. SeealsoPEP492.
BDFL
BenevolentDictatorForLife,a.k.a. GuidovanRossum,Python’screator.
binaryfile
Afileobjectabletoreadandwritebytes-likeobjects. Examplesofbinaryfilesarefilesopenedinbinarymode
('rb','wb'or'rb+'),sys.stdin.buffer,sys.stdout.buffer,andinstancesofio.BytesIOand
gzip.GzipFile.
Seealsotextfileforafileobjectabletoreadandwritestrobjects.
borrowedreference
InPython’sCAPI,aborrowedreferenceisareferencetoanobject,wherethecodeusingtheobjectdoesnot
ownthereference. Itbecomesadanglingpointeriftheobjectisdestroyed. Forexample,agarbagecollection
canremovethelaststrongreferencetotheobjectandsodestroyit.
CallingPy_INCREF()ontheborrowedreferenceisrecommendedtoconvertittoastrongreferencein-place,
exceptwhentheobjectcannotbedestroyedbeforethelastusageoftheborrowedreference. ThePy_NewRef()
functioncanbeusedtocreateanewstrongreference.
bytes-likeobject
An object that supports the Buffer Protocol and can export a C-contiguous buffer. This includes all bytes,
bytearray,andarray.arrayobjects,aswellasmanycommonmemoryviewobjects. Bytes-likeobjects
canbeusedforvariousoperationsthatworkwithbinarydata;theseincludecompression,savingtoabinary
file,andsendingoverasocket.
Someoperationsneedthebinarydatatobemutable. Thedocumentationoftenreferstotheseas“read-write
bytes-likeobjects”. Examplemutablebufferobjectsincludebytearrayandamemoryviewofabytearray.
Other operations require the binary data to be stored in immutable objects (“read-only bytes-like objects”);
examplesoftheseincludebytesandamemoryviewofabytesobject.
bytecode
Pythonsourcecodeiscompiledintobytecode,theinternalrepresentationofaPythonprogramintheCPython
interpreter. Thebytecodeisalsocachedin.pycfilessothatexecutingthesamefileisfasterthesecondtime
(recompilation from source to bytecode can be avoided). This “intermediate language” is said to run on a
virtualmachinethatexecutesthemachinecodecorrespondingtoeachbytecode. Donotethatbytecodesare
notexpectedtoworkbetweendifferentPythonvirtualmachines,nortobestablebetweenPythonreleases.
Alistofbytecodeinstructionscanbefoundinthedocumentationforthedismodule.
callable
Acallableisanobjectthatcanbecalled,possiblywithasetofarguments(seeargument),withthefollowing
syntax:
callable(argument1, argument2, argumentN)
Afunction,andbyextensionamethod,isacallable. Aninstanceofaclassthatimplementsthe__call__()
methodisalsoacallable.
callback
Asubroutinefunctionwhichispassedasanargumenttobeexecutedatsomepointinthefuture.
class
A template for creating user-defined objects. Class definitions normally contain method definitions which
operateoninstancesoftheclass.
classvariable
Avariabledefinedinaclassandintendedtobemodifiedonlyatclasslevel(i.e.,notinaninstanceoftheclass).
365

### 第374页

closurevariable
Afreevariablereferencedfromanestedscopethatisdefinedinanouterscoperatherthanbeingresolvedat
runtime from the globals or builtin namespaces. May be explicitly defined with the nonlocal keyword to
allowwriteaccess,orimplicitlydefinedifthevariableisonlybeingread.
Forexample,intheinnerfunctioninthefollowingcode,bothxandprintarefreevariables,butonlyxis
aclosurevariable:
def outer():
x = 0
def inner():
nonlocal x
x += 1
print(x)
return inner
Duetothecodeobject.co_freevarsattribute(which,despiteitsname,onlyincludesthenamesofclosure
variablesratherthanlistingallreferencedfreevariables),themoregeneralfreevariabletermissometimesused
evenwhentheintendedmeaningistoreferspecificallytoclosurevariables.
complexnumber
Anextensionofthefamiliarrealnumbersysteminwhichallnumbersareexpressedasasumofarealpartand
animaginarypart. Imaginarynumbersarerealmultiplesoftheimaginaryunit(thesquarerootof-1),often
written i in mathematics or j in engineering. Python has built-in support for complex numbers, which are
writtenwiththislatternotation;theimaginarypartiswrittenwithajsuffix,e.g.,3+1j. Togetaccesstocom-
plexequivalentsofthemathmodule,usecmath. Useofcomplexnumbersisafairlyadvancedmathematical
feature. Ifyou’renotawareofaneedforthem,it’salmostcertainyoucansafelyignorethem.
context
Thistermhasdifferentmeaningsdependingonwhereandhowitisused. Somecommonmeanings:
• Thetemporarystateorenvironmentestablishedbyacontextmanagerviaawithstatement.
• The collection of keyvalue bindings associated with a particular contextvars.Context object and
accessedviaContextVarobjects. Alsoseecontextvariable.
• Acontextvars.Contextobject. Alsoseecurrentcontext.
contextmanagementprotocol
The__enter__()and__exit__()methodscalledbythewithstatement. SeePEP343.
contextmanager
Anobjectwhichimplementsthecontextmanagementprotocol andcontrolstheenvironmentseenina with
statement. SeePEP343.
contextvariable
A variable whose value depends on which context is the current context. Values are accessed via
contextvars.ContextVarobjects. Contextvariablesareprimarilyusedtoisolatestatebetweenconcur-
rentasynchronoustasks.
contiguous
AbufferisconsideredcontiguousexactlyifitiseitherC-contiguousorFortrancontiguous. Zero-dimensional
buffersareCandFortrancontiguous. Inone-dimensionalarrays,theitemsmustbelaidoutinmemorynext
toeachother,inorderofincreasingindexesstartingfromzero. InmultidimensionalC-contiguousarrays,the
lastindexvariesthefastestwhenvisitingitemsinorderofmemoryaddress. However,inFortrancontiguous
arrays,thefirstindexvariesthefastest.
coroutine
Coroutines are a more generalized form of subroutines. Subroutines are entered at one point and exited at
anotherpoint. Coroutinescanbeentered,exited,andresumedatmanydifferentpoints. Theycanbeimple-
mentedwiththeasync defstatement. SeealsoPEP492.
coroutinefunction
Afunctionwhichreturnsacoroutineobject. Acoroutinefunctionmaybedefinedwiththeasync defstate-
366 AppendixA. Glossary

### 第375页

ment, and may contain await, async for, and async with keywords. These were introduced by PEP
492.
CPython
ThecanonicalimplementationofthePythonprogramminglanguage,asdistributedonpython.org. Theterm
“CPython”isusedwhennecessarytodistinguishthisimplementationfromotherssuchasJythonorIronPython.
currentcontext
Thecontext (contextvars.Contextobject)thatiscurrentlyusedbyContextVarobjectstoaccess(get
or set) the values of context variables. Each thread has its own current context. Frameworks for executing
asynchronous tasks (see asyncio) associate each task with a context which becomes the current context
wheneverthetaskstartsorresumesexecution.
cyclicisolate
A subgroup of one or more objects that reference each other in a reference cycle, but are not referenced by
objects outside the group. The goal of the cyclic garbage collector is to identify these groups and break the
referencecyclessothatthememorycanbereclaimed.
decorator
Afunctionreturninganotherfunction,usuallyappliedasafunctiontransformationusingthe@wrappersyntax.
Commonexamplesfordecoratorsareclassmethod()andstaticmethod().
Thedecoratorsyntaxismerelysyntacticsugar,thefollowingtwofunctiondefinitionsaresemanticallyequiv-
alent:
def f(arg):
...
f = staticmethod(f)
@staticmethod
def f(arg):
...
The same concept exists for classes, but is less commonly used there. See the documentation for function
definitionsandclassdefinitionsformoreaboutdecorators.
descriptor
Anyobjectwhichdefinesthemethods__get__(),__set__(),or__delete__(). Whenaclassattribute
is a descriptor, its special binding behavior is triggered upon attribute lookup. Normally, using a.b to get,
set or delete an attribute looks up the object named b in the class dictionary for a, but if b is a descriptor,
therespectivedescriptormethodgetscalled. Understandingdescriptorsisakeytoadeepunderstandingof
Pythonbecausetheyarethebasisformanyfeaturesincludingfunctions,methods,properties,classmethods,
staticmethods,andreferencetosuperclasses.
Formoreinformationaboutdescriptors’methods,seedescriptorsortheDescriptorHowToGuide.
dictionary
Anassociativearray,wherearbitrarykeysaremappedtovalues. Thekeyscanbeanyobjectwith__hash__()
and__eq__()methods. CalledahashinPerl.
dictionarycomprehension
A compact way to process all or part of the elements in an iterable and return a dictionary with the re-
sults. results = {n: n ** 2 for n in range(10)}generatesadictionarycontainingkeynmapped
tovaluen ** 2. Seecomprehensions.
dictionaryview
Theobjectsreturnedfromdict.keys(),dict.values(),anddict.items()arecalleddictionaryviews.
Theyprovideadynamicviewonthedictionary’sentries,whichmeansthatwhenthedictionarychanges,the
view reflects these changes. To force the dictionary view to become a full list use list(dictview). See
dict-views.
docstring
Astringliteralwhichappearsasthefirstexpressioninaclass,functionormodule. Whileignoredwhenthe
suiteisexecuted,itisrecognizedbythecompilerandputintothe__doc__attributeoftheenclosingclass,
367

### 第376页

functionormodule. Sinceitisavailableviaintrospection,itisthecanonicalplacefordocumentationofthe
object.
duck-typing
Aprogrammingstylewhichdoesnotlookatanobject’stypetodetermineifithastherightinterface;instead,
the method or attribute is simply called or used (“If it looks like a duck and quacks like a duck, it must be
a duck.”) By emphasizing interfaces rather than specific types, well-designed code improves its flexibility
by allowing polymorphic substitution. Duck-typing avoids tests using type() or isinstance(). (Note,
however, that duck-typing can be complemented with abstract base classes.) Instead, it typically employs
hasattr()testsorEAFPprogramming.
dunder
An informal short-hand for “double underscore”, used when talking about a special method. For example,
__init__isoftenpronounced“dunderinit”.
EAFP
Easier to ask for forgiveness than permission. This common Python coding style assumes the existence of
valid keys or attributes and catches exceptions if the assumption proves false. This clean and fast style is
characterizedbythepresenceofmanytryandexceptstatements. ThetechniquecontrastswiththeLBYL
stylecommontomanyotherlanguagessuchasC.
evaluatefunction
A function that can be called to evaluate a lazily evaluated attribute of an object, such as the value of type
aliasescreatedwiththetypestatement.
expression
Apieceofsyntaxwhichcanbeevaluatedtosomevalue. Inotherwords,anexpressionisanaccumulationof
expressionelementslikeliterals,names,attributeaccess,operatorsorfunctioncallswhichallreturnavalue. In
contrasttomanyotherlanguages,notalllanguageconstructsareexpressions. Therearealsostatementswhich
cannotbeusedasexpressions,suchaswhile. Assignmentsarealsostatements,notexpressions.
extensionmodule
AmodulewritteninCorC++,usingPython’sCAPItointeractwiththecoreandwithusercode.
f-string
f-strings
StringliteralsprefixedwithforFarecommonlycalled“f-strings”whichisshortforformattedstringliterals.
SeealsoPEP498.
fileobject
Anobjectexposingafile-orientedAPI(withmethodssuchasread()orwrite())toanunderlyingresource.
Dependingonthewayitwascreated,afileobjectcanmediateaccesstoarealon-diskfileortoanothertypeof
storageorcommunicationdevice(forexamplestandardinput/output,in-memorybuffers,sockets,pipes,etc.).
Fileobjectsarealsocalledfile-likeobjectsorstreams.
Thereareactuallythreecategoriesoffileobjects: rawbinaryfiles, bufferedbinaryfilesandtextfiles. Their
interfaces are defined in the io module. The canonical way to create a file object is by using the open()
function.
file-likeobject
Asynonymforfileobject.
filesystemencodinganderrorhandler
EncodinganderrorhandlerusedbyPythontodecodebytesfromtheoperatingsystemandencodeUnicodeto
theoperatingsystem.
Thefilesystemencodingmustguaranteetosuccessfullydecodeallbytesbelow128. Ifthefilesystemencoding
failstoprovidethisguarantee,APIfunctionscanraiseUnicodeError.
The sys.getfilesystemencoding() and sys.getfilesystemencodeerrors() functions can be
usedtogetthefilesystemencodinganderrorhandler.
ThefilesystemencodinganderrorhandlerareconfiguredatPythonstartupbythePyConfig_Read()func-
tion: seefilesystem_encodingandfilesystem_errorsmembersofPyConfig.
Seealsothelocaleencoding.
368 AppendixA. Glossary

### 第377页

finder
Anobjectthattriestofindtheloaderforamodulethatisbeingimported.
Therearetwotypesoffinder: metapathfindersforusewithsys.meta_path,andpathentryfindersforuse
withsys.path_hooks.
Seefinders-and-loadersandimportlibformuchmoredetail.
floordivision
Mathematicaldivisionthatroundsdowntonearestinteger. Thefloordivisionoperatoris//. Forexample,the
expression11 // 4evaluatesto2incontrasttothe2.75returnedbyfloattruedivision. Notethat(-11)
// 4is-3becausethatis-2.75roundeddownward. SeePEP238.
freethreading
AthreadingmodelwheremultiplethreadscanrunPythonbytecodesimultaneouslywithinthesameinterpreter.
ThisisincontrasttotheglobalinterpreterlockwhichallowsonlyonethreadtoexecutePythonbytecodeata
time. SeePEP703.
freevariable
Formally, as defined in the language execution model, a free variable is any variable used in a namespace
whichisnotalocalvariableinthatnamespace. Seeclosurevariableforanexample. Pragmatically,duetothe
nameofthecodeobject.co_freevarsattribute,thetermisalsosometimesusedasasynonymforclosure
variable.
function
Aseriesofstatementswhichreturnssomevaluetoacaller. Itcanalsobepassedzeroormoreargumentswhich
maybeusedintheexecutionofthebody. Seealsoparameter,method,andthefunctionsection.
functionannotation
Anannotationofafunctionparameterorreturnvalue.
Function annotations are usually used for type hints: for example, this function is expected to take two int
argumentsandisalsoexpectedtohaveanintreturnvalue:
def sum_two_numbers(a: int, b: int) -> int:
return a + b
Functionannotationsyntaxisexplainedinsectionfunction.
SeevariableannotationandPEP484,whichdescribethisfunctionality. Alsoseeannotations-howtoforbest
practicesonworkingwithannotations.
__future__
Afuturestatement,from __future__ import <feature>,directsthecompilertocompilethecurrent
moduleusingsyntaxorsemanticsthatwillbecomestandardinafuturereleaseofPython. The__future__
moduledocumentsthepossiblevaluesoffeature. Byimportingthismoduleandevaluatingitsvariables,you
canseewhenanewfeaturewasfirstaddedtothelanguageandwhenitwill(ordid)becomethedefault:
>>> import __future__
>>> __future__.division
_Feature((2, 2, 0, 'alpha', 2), (3, 0, 0, 'alpha', 0), 8192)
garbagecollection
Theprocessoffreeingmemorywhenitisnotusedanymore. Pythonperformsgarbagecollectionviareference
countingandacyclicgarbagecollectorthatisabletodetectandbreakreferencecycles. Thegarbagecollector
canbecontrolledusingthegcmodule.
generator
A function which returns a generator iterator. It looks like a normal function except that it contains yield
expressionsforproducingaseriesofvaluesusableinafor-looporthatcanberetrievedoneatatimewiththe
next()function.
Usuallyreferstoageneratorfunction,butmayrefertoageneratoriterator insomecontexts. Incaseswhere
theintendedmeaningisn’tclear,usingthefulltermsavoidsambiguity.
369

### 第378页

generatoriterator
Anobjectcreatedbyageneratorfunction.
Eachyieldtemporarilysuspendsprocessing,rememberingtheexecutionstate(includinglocalvariablesand
pending try-statements). When the generator iterator resumes, it picks up where it left off (in contrast to
functionswhichstartfreshoneveryinvocation).
generatorexpression
Anexpressionthatreturnsaniterator. Itlookslikeanormalexpressionfollowedbyaforclausedefininga
loop variable, range, andan optional if clause. The combinedexpressiongeneratesvaluesfor an enclosing
function:
>>> sum(i*i for i in range(10)) # sum of squares 0, 1, 4, ... 81
285
genericfunction
Afunctioncomposedofmultiplefunctionsimplementingthesameoperationfordifferenttypes. Whichim-
plementationshouldbeusedduringacallisdeterminedbythedispatchalgorithm.
Seealsothesingledispatchglossaryentry,thefunctools.singledispatch()decorator,andPEP443.
generictype
Atypethatcanbeparameterized; typicallyacontainerclasssuchaslistordict. Usedfortypehintsand
annotations.
Formoredetails,seegenericaliastypes,PEP483,PEP484,PEP585,andthetypingmodule.
GIL
Seeglobalinterpreterlock.
globalinterpreterlock
The mechanism used by the CPython interpreter to assure that only one thread executes Python bytecode at
a time. This simplifies the CPython implementation by making the object model (including critical built-in
typessuchasdict)implicitlysafeagainstconcurrentaccess. Lockingtheentireinterpretermakesiteasier
fortheinterpretertobemulti-threaded,attheexpenseofmuchoftheparallelismaffordedbymulti-processor
machines.
However,someextensionmodules,eitherstandardorthird-party,aredesignedsoastoreleasetheGILwhen
doingcomputationallyintensivetaskssuchascompressionorhashing. Also,theGILisalwaysreleasedwhen
doingI/O.
AsofPython3.13, theGILcanbedisabledusingthe--disable-gilbuildconfiguration. Afterbuilding
Pythonwiththisoption,codemustberunwith-X gil=0oraftersettingthePYTHON_GIL=0environment
variable. This feature enables improved performance for multi-threaded applications and makes it easier to
usemulti-coreCPUsefficiently. Formoredetails,seePEP703.
InpriorversionsofPython’sCAPI,afunctionmightdeclarethatitrequirestheGILtobeheldinordertouse
it. Thisreferstohavinganattachedthreadstate.
hash-basedpyc
Abytecodecachefilethatusesthehashratherthanthelast-modifiedtimeofthecorrespondingsourcefileto
determineitsvalidity. Seepyc-invalidation.
hashable
Anobjectishashableifithasahashvaluewhichneverchangesduringitslifetime(itneedsa__hash__()
method), and can be compared to other objects (it needs an __eq__() method). Hashable objects which
compareequalmusthavethesamehashvalue.
Hashabilitymakesanobjectusableasadictionarykeyandasetmember,becausethesedatastructuresusethe
hashvalueinternally.
Most of Python’s immutable built-in objects are hashable; mutable containers (such as lists or dictionaries)
arenot;immutablecontainers(suchastuplesandfrozensets)areonlyhashableiftheirelementsarehashable.
Objectswhichareinstancesofuser-definedclassesarehashablebydefault. Theyallcompareunequal(except
withthemselves),andtheirhashvalueisderivedfromtheirid().
370 AppendixA. Glossary

### 第379页

IDLE
AnIntegratedDevelopmentandLearningEnvironmentforPython. idleisabasiceditorandinterpreterenvi-
ronmentwhichshipswiththestandarddistributionofPython.
immortal
ImmortalobjectsareaCPythonimplementationdetailintroducedinPEP683.
Ifanobjectisimmortal,itsreferencecount isnevermodified,andthereforeitisneverdeallocatedwhilethe
interpreterisrunning. Forexample,TrueandNoneareimmortalinCPython.
Immortalobjectscanbeidentifiedviasys._is_immortal(),orviaPyUnstable_IsImmortal()inthe
CAPI.
immutable
Anobjectwithafixedvalue. Immutableobjectsincludenumbers,stringsandtuples. Suchanobjectcannot
bealtered. Anewobjecthastobecreatedifadifferentvaluehastobestored. Theyplayanimportantrolein
placeswhereaconstanthashvalueisneeded,forexampleasakeyinadictionary.
importpath
Alistoflocations(orpathentries)thataresearchedbythepathbasedfinderformodulestoimport. During
import,thislistoflocationsusuallycomesfromsys.path,butforsubpackagesitmayalsocomefromthe
parentpackage’s__path__attribute.
importing
TheprocessbywhichPythoncodeinonemoduleismadeavailabletoPythoncodeinanothermodule.
importer
Anobjectthatbothfindsandloadsamodule;bothafinderandloaderobject.
interactive
Pythonhasaninteractiveinterpreterwhichmeansyoucanenterstatementsandexpressionsattheinterpreter
prompt, immediately execute them and see their results. Just launch python with no arguments (possibly
by selecting it fromyour computer’s mainmenu). It isa very powerfulway to testout new ideas orinspect
modulesandpackages(rememberhelp(x)). Formoreoninteractivemode,seetut-interac.
interpreted
Pythonisaninterpretedlanguage,asopposedtoacompiledone,thoughthedistinctioncanbeblurrybecause
ofthepresenceofthebytecodecompiler. Thismeansthatsourcefilescanberundirectlywithoutexplicitly
creating an executable which is then run. Interpreted languages typically have a shorter development/debug
cyclethancompiledones,thoughtheirprogramsgenerallyalsorunmoreslowly. Seealsointeractive.
interpretershutdown
Whenaskedtoshutdown,thePythoninterpreterentersaspecialphasewhereitgraduallyreleasesallallocated
resources, suchasmodulesandvariouscriticalinternalstructures. Italsomakesseveralcallstothegarbage
collector. Thiscantriggertheexecutionofcodeinuser-defineddestructorsorweakrefcallbacks. Codeexe-
cutedduringtheshutdownphasecanencountervariousexceptionsastheresourcesitreliesonmaynotfunction
anymore(commonexamplesarelibrarymodulesorthewarningsmachinery).
Themainreasonforinterpretershutdownisthatthe__main__moduleorthescriptbeingrunhasfinished
executing.
iterable
Anobjectcapableofreturningitsmembersoneatatime. Examplesofiterablesincludeallsequencetypes
(such as list, str, and tuple) and some non-sequence types like dict, file objects, and objects of any
classesyoudefinewithan__iter__()methodorwitha__getitem__()methodthatimplementssequence
semantics.
Iterables can be used in a for loop and in many other places where a sequence is needed (zip(), map(),
…). Whenaniterableobjectispassedasanargumenttothebuilt-infunctioniter(),itreturnsaniterator
fortheobject. Thisiteratorisgoodforonepassoverthesetofvalues. Whenusingiterables,itisusuallynot
necessarytocalliter()ordealwithiteratorobjectsyourself. Theforstatementdoesthatautomaticallyfor
you,creatingatemporaryunnamedvariabletoholdtheiteratorforthedurationoftheloop. Seealsoiterator,
sequence,andgenerator.
371

### 第380页

iterator
An object representing a stream of data. Repeated calls to the iterator’s __next__() method (or passing
ittothebuilt-infunctionnext())returnsuccessiveitemsinthestream. Whennomoredataareavailablea
StopIterationexceptionisraisedinstead. Atthispoint,theiteratorobjectisexhaustedandanyfurthercalls
toits__next__()methodjustraiseStopIterationagain. Iteratorsarerequiredtohavean__iter__()
methodthatreturnstheiteratorobjectitselfsoeveryiteratorisalsoiterableandmaybeusedinmostplaces
whereotheriterablesareaccepted. Onenotableexceptioniscodewhichattemptsmultipleiterationpasses. A
containerobject(suchasalist)producesafreshnewiteratoreachtimeyoupassittotheiter()function
oruseitinaforloop. Attemptingthiswithaniteratorwilljustreturnthesameexhaustediteratorobjectused
inthepreviousiterationpass,makingitappearlikeanemptycontainer.
Moreinformationcanbefoundintypeiter.
CPythonimplementationdetail: CPythondoesnotconsistentlyapplytherequirementthataniteratordefine
__iter__(). Andalsopleasenotethatthefree-threadingCPythondoesnotguaranteethethread-safetyof
iteratoroperations.
keyfunction
Akeyfunctionorcollationfunctionisacallablethatreturnsavalueusedforsortingorordering. Forexample,
locale.strxfrm()isusedtoproduceasortkeythatisawareoflocalespecificsortconventions.
A number of tools in Python accept key functions to control how elements are ordered or grouped. They
include min(), max(), sorted(), list.sort(), heapq.merge(), heapq.nsmallest(), heapq.
nlargest(),anditertools.groupby().
There are several ways to create a key function. For example. the str.lower() method can serve as a
key function for case insensitive sorts. Alternatively, a key function can be built from a lambda expression
suchaslambda r: (r[0], r[2]). Also,operator.attrgetter(),operator.itemgetter(),and
operator.methodcaller()arethreekeyfunctionconstructors. SeetheSortingHOWTOforexamples
ofhowtocreateandusekeyfunctions.
keywordargument
Seeargument.
lambda
Ananonymousinlinefunctionconsistingofasingleexpressionwhichisevaluatedwhenthefunctioniscalled.
Thesyntaxtocreatealambdafunctionislambda [parameters]: expression
LBYL
Lookbeforeyouleap. Thiscodingstyleexplicitlytestsforpre-conditionsbeforemakingcallsorlookups. This
stylecontrastswiththeEAFPapproachandischaracterizedbythepresenceofmanyifstatements.
In a multi-threaded environment, the LBYL approach can risk introducing a race condition between “the
looking”and“theleaping”. Forexample, thecode, if key in mapping: return mapping[key] can
failifanotherthreadremoveskeyfrommappingafterthetest,butbeforethelookup. Thisissuecanbesolved
withlocksorbyusingtheEAFPapproach.
lexicalanalyzer
Formalnameforthetokenizer;seetoken.
list
Abuilt-inPythonsequence. Despiteitsnameitismoreakintoanarrayinotherlanguagesthantoalinkedlist
sinceaccesstoelementsisO(1).
listcomprehension
Acompactwaytoprocessallorpartoftheelementsinasequenceandreturnalistwiththeresults. result
= ['{:#04x}'.format(x) for x in range(256) if x % 2 == 0]generatesalistofstringscon-
tainingevenhexnumbers(0x..) intherangefrom0to255. Theifclauseisoptional. Ifomitted,allelements
inrange(256)areprocessed.
loader
An object that loads a module. It must define the exec_module() and create_module() methods to
implementtheLoaderinterface. Aloaderistypicallyreturnedbyafinder. Seealso:
• finders-and-loaders
372 AppendixA. Glossary

### 第381页

• importlib.abc.Loader
• PEP302
localeencoding
On Unix, it is the encoding of the LC_CTYPE locale. It can be set with locale.setlocale(locale.
LC_CTYPE, new_locale).
OnWindows,itistheANSIcodepage(ex: "cp1252").
OnAndroidandVxWorks,Pythonuses"utf-8"asthelocaleencoding.
locale.getencoding()canbeusedtogetthelocaleencoding.
Seealsothefilesystemencodinganderrorhandler.
magicmethod
Aninformalsynonymforspecialmethod.
mapping
A container object that supports arbitrary key lookups and implements the methods specified in the
collections.abc.Mapping or collections.abc.MutableMapping abstract base classes. Exam-
ples include dict, collections.defaultdict, collections.OrderedDict and collections.
Counter.
metapathfinder
Afinderreturnedbyasearchofsys.meta_path. Metapathfindersarerelatedto,butdifferentfrompath
entryfinders.
Seeimportlib.abc.MetaPathFinderforthemethodsthatmetapathfindersimplement.
metaclass
Theclassofaclass. Classdefinitionscreateaclassname, aclassdictionary, andalistofbaseclasses. The
metaclass is responsible for taking those three arguments and creating the class. Most object oriented pro-
gramming languages provide a default implementation. What makes Python special is that it is possible to
createcustommetaclasses. Mostusersneverneedthistool,butwhentheneedarises,metaclassescanprovide
powerful,elegantsolutions. Theyhavebeenusedforloggingattributeaccess,addingthread-safety,tracking
objectcreation,implementingsingletons,andmanyothertasks.
Moreinformationcanbefoundinmetaclasses.
method
Afunctionwhichisdefinedinsideaclassbody. Ifcalledasanattributeofaninstanceofthatclass,themethod
willgettheinstanceobjectasitsfirstargument(whichisusuallycalledself). Seefunctionandnestedscope.
methodresolutionorder
Method Resolution Order is the order in which base classes are searched for a member during lookup. See
python_2.3_mrofordetailsofthealgorithmusedbythePythoninterpretersincethe2.3release.
module
AnobjectthatservesasanorganizationalunitofPythoncode. Moduleshaveanamespacecontainingarbitrary
Pythonobjects. ModulesareloadedintoPythonbytheprocessofimporting.
Seealsopackage.
modulespec
Anamespacecontainingtheimport-relatedinformationusedtoloadamodule. Aninstanceofimportlib.
machinery.ModuleSpec.
Seealsomodule-specs.
MRO
Seemethodresolutionorder.
mutable
Mutableobjectscanchangetheirvaluebutkeeptheirid(). Seealsoimmutable.
373

### 第382页

namedtuple
Theterm“namedtuple”appliestoanytypeorclassthatinheritsfromtupleandwhoseindexableelementsare
alsoaccessibleusingnamedattributes. Thetypeorclassmayhaveotherfeaturesaswell.
Several built-in types are named tuples, including the values returned by time.localtime() and os.
stat(). Anotherexampleissys.float_info:
>>> sys.float_info[1] # indexed access
1024
>>> sys.float_info.max_exp # named field access
1024
>>> isinstance(sys.float_info, tuple) # kind of tuple
True
Some named tuples are built-in types (such as the above examples). Alternatively, a named tuple can be
created from a regular class definition that inherits from tuple and that defines named fields. Such a class
canbewrittenbyhand,oritcanbecreatedbyinheritingtyping.NamedTuple,orwiththefactoryfunction
collections.namedtuple(). Thelattertechniquesalsoaddsomeextramethodsthatmaynotbefound
inhand-writtenorbuilt-innamedtuples.
namespace
The place where a variable is stored. Namespaces are implemented as dictionaries. There are the local,
global and built-in namespaces as well as nested namespaces in objects (in methods). Namespaces support
modularitybypreventingnamingconflicts. Forinstance,thefunctionsbuiltins.openandos.open()are
distinguished by their namespaces. Namespaces also aid readability and maintainability by making it clear
which module implements a function. For instance, writing random.seed() or itertools.islice()
makesitclearthatthosefunctionsareimplementedbytherandomanditertoolsmodules,respectively.
namespacepackage
A package which serves only as a container for subpackages. Namespace packages may have no physical
representation,andspecificallyarenotlikearegularpackagebecausetheyhaveno__init__.pyfile.
Namespacepackagesallowseveralindividuallyinstallablepackagestohaveacommonparentpackage. Oth-
erwise,itisrecommendedtousearegularpackage.
Formoreinformation,seePEP420andreference-namespace-package.
Seealsomodule.
nestedscope
The ability to refer to a variable in an enclosing definition. For instance, a function defined inside another
functioncanrefertovariablesintheouterfunction. Notethatnestedscopesbydefaultworkonlyforreference
andnotforassignment. Localvariablesbothreadandwriteintheinnermostscope. Likewise,globalvariables
readandwritetotheglobalnamespace. Thenonlocalallowswritingtoouterscopes.
new-styleclass
Old name for the flavor of classes now used for all class objects. In earlier Python versions, only
new-style classes could use Python’s newer, versatile features like __slots__, descriptors, properties,
__getattribute__(),classmethods,andstaticmethods.
object
Anydatawithstate(attributesorvalue)anddefinedbehavior(methods). Alsotheultimatebaseclassofany
new-styleclass.
optimizedscope
A scope where target local variable names are reliably known to the compiler when the code is compiled,
allowingoptimizationofreadandwriteaccesstothesenames. Thelocalnamespacesforfunctions,generators,
coroutines,comprehensions,andgeneratorexpressionsareoptimizedinthisfashion. Note: mostinterpreter
optimizationsareappliedtoallscopes,onlythoserelyingonaknownsetoflocalandnonlocalvariablenames
arerestrictedtooptimizedscopes.
package
A Python module which can contain submodules or recursively, subpackages. Technically, a package is a
Pythonmodulewitha__path__attribute.
374 AppendixA. Glossary

### 第383页

Seealsoregularpackageandnamespacepackage.
parameter
Anamedentityinafunction(ormethod)definitionthatspecifiesanargument (orinsomecases,arguments)
thatthefunctioncanaccept. Therearefivekindsofparameter:
• positional-or-keyword: specifiesanargumentthatcanbepassedeitherpositionallyorasakeywordargu-
ment. Thisisthedefaultkindofparameter,forexamplefooandbarinthefollowing:
def func(foo, bar=None): ...
• positional-only: specifiesanargumentthatcanbesuppliedonlybyposition. Positional-onlyparameters
canbedefinedbyincludinga/characterintheparameterlistofthefunctiondefinitionafterthem,for
exampleposonly1andposonly2inthefollowing:
def func(posonly1, posonly2, /, positional_or_keyword): ...
• keyword-only: specifiesanargumentthatcanbesuppliedonlybykeyword. Keyword-onlyparameters
canbedefinedbyincludingasinglevar-positionalparameterorbare*intheparameterlistofthefunction
definitionbeforethem,forexamplekw_only1andkw_only2inthefollowing:
def func(arg, *, kw_only1, kw_only2): ...
• var-positional: specifiesthatanarbitrarysequenceofpositionalargumentscanbeprovided(inaddition
toanypositionalargumentsalreadyacceptedbyotherparameters). Suchaparametercanbedefinedby
prependingtheparameternamewith*,forexampleargsinthefollowing:
def func(*args, **kwargs): ...
• var-keyword: specifiesthatarbitrarilymanykeywordargumentscanbeprovided(inadditiontoanykey-
wordargumentsalreadyacceptedbyotherparameters). Suchaparametercanbedefinedbyprepending
theparameternamewith**,forexamplekwargsintheexampleabove.
Parameters can specify both optional and required arguments, as well as default values for some optional
arguments.
Seealsotheargumentglossaryentry,theFAQquestiononthedifferencebetweenargumentsandparameters,
theinspect.Parameterclass,thefunctionsection,andPEP362.
pathentry
Asinglelocationontheimportpathwhichthepathbasedfinderconsultstofindmodulesforimporting.
pathentryfinder
A finder returned by a callable on sys.path_hooks (i.e. a path entry hook) which knows how to locate
modulesgivenapathentry.
Seeimportlib.abc.PathEntryFinderforthemethodsthatpathentryfindersimplement.
pathentryhook
Acallableonthesys.path_hookslistwhichreturnsapathentryfinderifitknowshowtofindmoduleson
aspecificpathentry.
pathbasedfinder
Oneofthedefaultmetapathfinderswhichsearchesanimportpathformodules.
path-likeobject
An object representing a file system path. A path-like object is either a str or bytes object representing
a path, or an object implementing the os.PathLike protocol. An object that supports the os.PathLike
protocol can be converted to a str or bytes file system path by calling the os.fspath() function; os.
fsdecode() and os.fsencode() can be used to guarantee a str or bytes result instead, respectively.
IntroducedbyPEP519.
PEP
PythonEnhancementProposal. APEPisadesigndocumentprovidinginformationtothePythoncommunity,
375

### 第384页

ordescribinganewfeatureforPythonoritsprocessesorenvironment. PEPsshouldprovideaconcisetechnical
specificationandarationaleforproposedfeatures.
PEPsareintendedtobetheprimarymechanismsforproposingmajornewfeatures,forcollectingcommunity
inputonanissue, andfordocumentingthedesigndecisionsthathavegoneintoPython. ThePEPauthoris
responsibleforbuildingconsensuswithinthecommunityanddocumentingdissentingopinions.
SeePEP1.
portion
A set of files in a single directory (possibly stored in a zip file) that contribute to a namespace package, as
definedinPEP420.
positionalargument
Seeargument.
provisionalAPI
A provisional API is one which has been deliberately excluded from the standard library’s backwards com-
patibility guarantees. While major changes to such interfaces are not expected, as long as they are marked
provisional, backwards incompatible changes (up to and including removal of the interface) may occur if
deemednecessarybycoredevelopers. Suchchangeswillnotbemadegratuitously–theywilloccuronlyif
seriousfundamentalflawsareuncoveredthatweremissedpriortotheinclusionoftheAPI.
Even for provisional APIs, backwards incompatible changes are seen as a “solution of last resort” - every
attemptwillstillbemadetofindabackwardscompatibleresolutiontoanyidentifiedproblems.
Thisprocessallowsthestandardlibrarytocontinuetoevolveovertime,withoutlockinginproblematicdesign
errorsforextendedperiodsoftime. SeePEP411formoredetails.
provisionalpackage
SeeprovisionalAPI.
Python3000
NicknameforthePython3.xreleaseline(coinedlongagowhenthereleaseofversion3wassomethinginthe
distantfuture.) Thisisalsoabbreviated“Py3k”.
Pythonic
AnideaorpieceofcodewhichcloselyfollowsthemostcommonidiomsofthePythonlanguage,ratherthan
implementingcodeusingconceptscommontootherlanguages. Forexample,acommonidiominPythonis
toloopoverallelementsofaniterableusingaforstatement. Manyotherlanguagesdon’thavethistypeof
construct,sopeopleunfamiliarwithPythonsometimesuseanumericalcounterinstead:
for i in range(len(food)):
print(food[i])
Asopposedtothecleaner,Pythonicmethod:
for piece in food:
print(piece)
qualifiedname
Adottednameshowingthe“path”fromamodule’sglobalscopetoaclass,functionormethoddefinedinthat
module, as defined in PEP 3155. For top-level functions and classes, the qualified name is the same as the
object’sname:
>>> class C:
... class D:
... def meth(self):
... pass
...
>>> C.__qualname__
'C'
>>> C.D.__qualname__
(continuesonnextpage)
376 AppendixA. Glossary

### 第385页

(continuedfrompreviouspage)
'C.D'
>>> C.D.meth.__qualname__
'C.D.meth'
Whenusedtorefertomodules,thefullyqualifiednamemeanstheentiredottedpathtothemodule,including
anyparentpackages,e.g. email.mime.text:
>>> import email.mime.text
>>> email.mime.text.__name__
'email.mime.text'
referencecount
Thenumberofreferencestoanobject. Whenthereferencecountofanobjectdropstozero,itisdeallocated.
Some objects are immortal and have reference counts that are never modified, and therefore the objects are
neverdeallocated. ReferencecountingisgenerallynotvisibletoPythoncode, butitisakeyelementofthe
CPythonimplementation. Programmerscancallthesys.getrefcount()functiontoreturnthereference
countforaparticularobject.
InCPython,referencecountsarenotconsideredtobestableorwell-definedvalues;thenumberofreferences
toanobject,andhowthatnumberisaffectedbyPythoncode,maybedifferentbetweenversions.
regularpackage
Atraditionalpackage,suchasadirectorycontainingan__init__.pyfile.
Seealsonamespacepackage.
REPL
Anacronymforthe“read–eval–printloop”,anothernamefortheinteractiveinterpretershell.
__slots__
Adeclarationinsideaclassthatsavesmemorybypre-declaringspaceforinstanceattributesandeliminating
instancedictionaries. Thoughpopular,thetechniqueissomewhattrickytogetrightandisbestreservedfor
rarecaseswheretherearelargenumbersofinstancesinamemory-criticalapplication.
sequence
An iterable which supports efficient element access using integer indices via the __getitem__() special
method and defines a __len__() method that returns the length of the sequence. Some built-in sequence
typesarelist,str,tuple,andbytes. Notethatdictalsosupports__getitem__()and__len__(),
but is considered a mapping rather than a sequence because the lookups use arbitrary hashable keys rather
thanintegers.
Thecollections.abc.Sequenceabstractbaseclassdefinesamuchricherinterfacethatgoesbeyondjust
__getitem__()and__len__(),addingcount(),index(),__contains__(),and__reversed__().
Types that implement this expanded interface can be registered explicitly using register(). For more
documentationonsequencemethodsgenerally,seeCommonSequenceOperations.
setcomprehension
Acompactwaytoprocessallorpartoftheelementsinaniterableandreturnasetwiththeresults. results
= {c for c in 'abracadabra' if c not in 'abc'}generatesthesetofstrings{'r', 'd'}. See
comprehensions.
singledispatch
Aformofgenericfunctiondispatchwheretheimplementationischosenbasedonthetypeofasingleargument.
slice
Anobjectusuallycontainingaportionofasequence. Asliceiscreatedusingthesubscriptnotation,[]with
colons between numbers when several are given, such as in variable_name[1:3:5]. The bracket (sub-
script)notationusessliceobjectsinternally.
softdeprecated
AsoftdeprecatedAPIshouldnotbeusedinnewcode,butitissafeforalreadyexistingcodetouseit. The
APIremainsdocumentedandtested,butwillnotbeenhancedfurther.
377

### 第386页

Softdeprecation,unlikenormaldeprecation,doesnotplanonremovingtheAPIandwillnotemitwarnings.
SeePEP387: SoftDeprecation.
specialmethod
AmethodthatiscalledimplicitlybyPythontoexecuteacertainoperationonatype,suchasaddition. Such
methodshavenamesstartingandendingwithdoubleunderscores. Specialmethodsaredocumentedinspe-
cialnames.
standardlibrary
Thecollectionofpackages,modulesandextensionmodulesdistributedasapartoftheofficialPythoninterpreter
package. Theexactmembershipofthecollectionmayvarybasedonplatform,availablesystemlibraries,or
othercriteria. Documentationcanbefoundatlibrary-index.
Seealsosys.stdlib_module_namesforalistofallpossiblestandardlibrarymodulenames.
statement
Astatementispartofasuite(a“block”ofcode). Astatementiseitheranexpressionoroneofseveralconstructs
withakeyword,suchasif,whileorfor.
statictypechecker
AnexternaltoolthatreadsPythoncodeandanalyzesit, lookingforissuessuchasincorrecttypes. Seealso
typehintsandthetypingmodule.
stdlib
Anabbreviationofstandardlibrary.
strongreference
In Python’s C API, a strong reference is a reference to an object which is owned by the code holding the
reference. ThestrongreferenceistakenbycallingPy_INCREF()whenthereferenceiscreatedandreleased
withPy_DECREF()whenthereferenceisdeleted.
ThePy_NewRef()functioncanbeusedtocreateastrongreferencetoanobject. Usually,thePy_DECREF()
functionmustbecalledonthestrongreferencebeforeexitingthescopeofthestrongreference,toavoidleaking
onereference.
Seealsoborrowedreference.
t-string
t-strings
StringliteralsprefixedwithtorTarecommonlycalled“t-strings”whichisshortfortemplatestringliterals.
textencoding
AstringinPythonisasequenceofUnicodecodepoints(inrangeU+0000–U+10FFFF).Tostoreortransfer
astring,itneedstobeserializedasasequenceofbytes.
Serializingastringintoasequenceofbytesisknownas“encoding”,andrecreatingthestringfromthesequence
ofbytesisknownas“decoding”.
Thereareavarietyofdifferenttextserializationcodecs,whicharecollectivelyreferredtoas“textencodings”.
textfile
Afileobjectabletoreadandwritestrobjects. Often,atextfileactuallyaccessesabyte-orienteddatastream
andhandlesthetextencodingautomatically. Examplesoftextfilesarefilesopenedintextmode('r'or'w'),
sys.stdin,sys.stdout,andinstancesofio.StringIO.
Seealsobinaryfileforafileobjectabletoreadandwritebytes-likeobjects.
threadstate
TheinformationusedbytheCPythonruntimetoruninanOSthread. Forexample,thisincludesthecurrent
exception,ifany,andthestateofthebytecodeinterpreter.
EachthreadstateisboundtoasingleOSthread,butthreadsmayhavemanythreadstatesavailable. Atmost,
oneofthemmaybeattachedatonce.
An attached thread state is required to call most of Python’s C API, unless a function explicitly documents
otherwise. Thebytecodeinterpreteronlyrunsunderanattachedthreadstate.
378 AppendixA. Glossary

### 第387页

Eachthreadstatebelongstoasingleinterpreter,buteachinterpretermayhavemanythreadstates,including
multipleforthesameOSthread. Threadstatesfrommultipleinterpretersmaybeboundtothesamethread,
butonlyonecanbeattachedinthatthreadatanygivenmoment.
SeeThreadStateandtheGlobalInterpreterLockformoreinformation.
token
A small unit of source code, generated by the lexical analyzer (also called the tokenizer). Names, numbers,
strings,operators,newlinesandsimilararerepresentedbytokens.
The tokenize module exposes Python’s lexical analyzer. The token module contains information on the
varioustypesoftokens.
triple-quotedstring
Astringwhichisboundbythreeinstancesofeitheraquotationmark(”)oranapostrophe(‘). Whiletheydon’t
provide any functionality not available with single-quoted strings, they are useful for a number of reasons.
Theyallowyoutoincludeunescapedsingleanddoublequoteswithinastringandtheycanspanmultiplelines
withouttheuseofthecontinuationcharacter,makingthemespeciallyusefulwhenwritingdocstrings.
type
ThetypeofaPythonobjectdetermineswhatkindofobjectitis;everyobjecthasatype. Anobject’stypeis
accessibleasits__class__attributeorcanberetrievedwithtype(obj).
typealias
Asynonymforatype,createdbyassigningthetypetoanidentifier.
Typealiasesareusefulforsimplifyingtypehints. Forexample:
def remove_gray_shades(
colors: list[tuple[int, int, int]]) -> list[tuple[int, int, int]]:
pass
couldbemademorereadablelikethis:
Color = tuple[int, int, int]
def remove_gray_shades(colors: list[Color]) -> list[Color]:
pass
SeetypingandPEP484,whichdescribethisfunctionality.
typehint
Anannotationthatspecifiestheexpectedtypeforavariable,aclassattribute,orafunctionparameterorreturn
value.
TypehintsareoptionalandarenotenforcedbyPythonbuttheyareusefultostatictypecheckers. Theycan
alsoaidIDEswithcodecompletionandrefactoring.
Type hints of global variables, class attributes, and functions, but not local variables, can be accessed using
typing.get_type_hints().
SeetypingandPEP484,whichdescribethisfunctionality.
universalnewlines
Amannerofinterpretingtextstreamsinwhichallofthefollowingarerecognizedasendingaline: theUnix
end-of-lineconvention'\n',theWindowsconvention'\r\n',andtheoldMacintoshconvention'\r'. See
PEP278andPEP3116,aswellasbytes.splitlines()foranadditionaluse.
variableannotation
Anannotationofavariableoraclassattribute.
Whenannotatingavariableoraclassattribute,assignmentisoptional:
class C:
field: 'annotation'
379

### 第388页

Variableannotationsareusuallyusedfortypehints: forexamplethisvariableisexpectedtotakeintvalues:
count: int = 0
Variableannotationsyntaxisexplainedinsectionannassign.
Seefunctionannotation,PEP484andPEP526,whichdescribethisfunctionality. Alsoseeannotations-howto
forbestpracticesonworkingwithannotations.
virtualenvironment
AcooperativelyisolatedruntimeenvironmentthatallowsPythonusersandapplicationstoinstallandupgrade
PythondistributionpackageswithoutinterferingwiththebehaviourofotherPythonapplicationsrunningon
thesamesystem.
Seealsovenv.
virtualmachine
Acomputerdefinedentirelyinsoftware. Python’svirtualmachineexecutesthebytecodeemittedbythebyte-
codecompiler.
walrusoperator
Alight-heartedwaytorefertotheassignmentexpressionoperator:=becauseitlooksabitlikeawalrusifyou
turnyourhead.
ZenofPython
ListingofPythondesignprinciplesandphilosophiesthatarehelpfulinunderstandingandusingthelanguage.
Thelistingcanbefoundbytyping“import this”attheinteractiveprompt.
380 AppendixA. Glossary

### 第389页

APPENDIX
B
ABOUT THIS DOCUMENTATION
Python’sdocumentationisgeneratedfromreStructuredTextsourcesusingSphinx,adocumentationgeneratororigi-
nallycreatedforPythonandnowmaintainedasanindependentproject.
Development of the documentation and its toolchain is an entirely volunteer effort, just like Python itself. If you
wanttocontribute,pleasetakealookatthereporting-bugspageforinformationonhowtodoso. Newvolunteers
arealwayswelcome!
Manythanksgoto:
• FredL.Drake,Jr.,thecreatoroftheoriginalPythondocumentationtoolsetandauthorofmuchofthecontent;
• theDocutilsprojectforcreatingreStructuredTextandtheDocutilssuite;
• FredrikLundhforhisAlternativePythonReferenceprojectfromwhichSphinxgotmanygoodideas.
B.1 Contributors to the Python documentation
ManypeoplehavecontributedtothePythonlanguage,thePythonstandardlibrary,andthePythondocumentation.
SeeMisc/ACKSinthePythonsourcedistributionforapartiallistofcontributors.
ItisonlywiththeinputandcontributionsofthePythoncommunitythatPythonhassuchwonderfuldocumentation
–ThankYou!
381

### 第390页

382 AppendixB. Aboutthisdocumentation

### 第391页

APPENDIX
C
HISTORY AND LICENSE
C.1 History of the software
Pythonwascreatedintheearly1990sbyGuidovanRossumatStichtingMathematischCentrum(CWI,seehttps:
//www.cwi.nl)intheNetherlandsasasuccessorofalanguagecalledABC.GuidoremainsPython’sprincipalauthor,
althoughitincludesmanycontributionsfromothers.
In1995,GuidocontinuedhisworkonPythonattheCorporationforNationalResearchInitiatives(CNRI,seehttps:
//www.cnri.reston.va.us)inReston,Virginiawherehereleasedseveralversionsofthesoftware.
InMay2000,GuidoandthePythoncoredevelopmentteammovedtoBeOpen.comtoformtheBeOpenPythonLabs
team. InOctoberofthesameyear,thePythonLabsteammovedtoDigitalCreations,whichbecameZopeCorpo-
ration. In2001,thePythonSoftwareFoundation(PSF,seehttps://www.python.org/psf/)wasformed,anon-profit
organization created specifically to own Python-related Intellectual Property. Zope Corporation was a sponsoring
memberofthePSF.
AllPythonreleasesareOpenSource(seehttps://opensource.orgfortheOpenSourceDefinition). Historically,most,
butnotall,PythonreleaseshavealsobeenGPL-compatible;thetablebelowsummarizesthevariousreleases.
Release Derivedfrom Year Owner GPL-compatible? (1)
0.9.0thru1.2 n/a 1991-1995 CWI yes
1.3thru1.5.2 1.2 1995-1999 CNRI yes
1.6 1.5.2 2000 CNRI no
2.0 1.6 2000 BeOpen.com no
1.6.1 1.6 2001 CNRI yes(2)
2.1 2.0+1.6.1 2001 PSF no
2.0.1 2.0+1.6.1 2001 PSF yes
2.1.1 2.1+2.0.1 2001 PSF yes
2.1.2 2.1.1 2002 PSF yes
2.1.3 2.1.2 2002 PSF yes
2.2andabove 2.1.1 2001-now PSF yes
(cid:174) Note
(1) GPL-compatibledoesn’tmeanthatwe’redistributingPythonundertheGPL.AllPythonlicenses,unlike
the GPL, let you distribute a modified version without making your changes open source. The GPL-
compatible licenses make it possible to combine Python with other software that is released under the
GPL;theothersdon’t.
(2) AccordingtoRichardStallman,1.6.1isnotGPL-compatible,becauseitslicensehasachoiceoflawclause.
AccordingtoCNRI,however, Stallman’slawyerhastoldCNRI’slawyerthat1.6.1is“notincompatible”
withtheGPL.
ThankstothemanyoutsidevolunteerswhohaveworkedunderGuido’sdirectiontomakethesereleasespossible.
383

| Release | Derivedfrom | Year | Owner | GPL-compatible? (1) |
| --- | --- | --- | --- | --- |
| 0.9.0thru1.2 | n/a | 1991-1995 | CWI | yes |
| 1.3thru1.5.2 | 1.2 | 1995-1999 | CNRI | yes |
| 1.6 | 1.5.2 | 2000 | CNRI | no |
| 2.0 | 1.6 | 2000 | BeOpen.com | no |
| 1.6.1 | 1.6 | 2001 | CNRI | yes(2) |
| 2.1 | 2.0+1.6.1 | 2001 | PSF | no |
| 2.0.1 | 2.0+1.6.1 | 2001 | PSF | yes |
| 2.1.1 | 2.1+2.0.1 | 2001 | PSF | yes |
| 2.1.2 | 2.1.1 | 2002 | PSF | yes |
| 2.1.3 | 2.1.2 | 2002 | PSF | yes |
| 2.2andabove | 2.1.1 | 2001-now | PSF | yes |

### 第392页

C.2 Terms and conditions for accessing or otherwise using Python
PythonsoftwareanddocumentationarelicensedunderthePythonSoftwareFoundationLicenseVersion2.
StartingwithPython3.8.6,examples,recipes,andothercodeinthedocumentationareduallicensedunderthePSF
LicenseVersion2andtheZero-ClauseBSDlicense.
SomesoftwareincorporatedintoPythonisunderdifferentlicenses. Thelicensesarelistedwithcodefallingunder
thatlicense. SeeLicensesandAcknowledgementsforIncorporatedSoftwareforanincompletelistoftheselicenses.
C.2.1 PYTHON SOFTWARE FOUNDATION LICENSE VERSION 2
1. This LICENSE AGREEMENT is between the Python Software Foundation ("PSF"), and
the Individual or Organization ("Licensee") accessing and otherwise using this
software ("Python") in source or binary form and its associated documentation.
2. Subject to the terms and conditions of this License Agreement, PSF hereby
grants Licensee a nonexclusive, royalty-free, world-wide license to reproduce,
analyze, test, perform and/or display publicly, prepare derivative works,
distribute, and otherwise use Python alone or in any derivative
version, provided, however, that PSF's License Agreement and PSF's notice of
copyright, i.e., "Copyright © 2001 Python Software Foundation; All Rights
Reserved" are retained in Python alone or in any derivative version
prepared by Licensee.
3. In the event Licensee prepares a derivative work that is based on or
incorporates Python or any part thereof, and wants to make the
derivative work available to others as provided herein, then Licensee hereby
agrees to include in any such work a brief summary of the changes made to␣
,→Python.
4. PSF is making Python available to Licensee on an "AS IS" basis.
PSF MAKES NO REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED. BY WAY OF
EXAMPLE, BUT NOT LIMITATION, PSF MAKES NO AND DISCLAIMS ANY REPRESENTATION OR
WARRANTY OF MERCHANTABILITY OR FITNESS FOR ANY PARTICULAR PURPOSE OR THAT THE
USE OF PYTHON WILL NOT INFRINGE ANY THIRD PARTY RIGHTS.
5. PSF SHALL NOT BE LIABLE TO LICENSEE OR ANY OTHER USERS OF PYTHON
FOR ANY INCIDENTAL, SPECIAL, OR CONSEQUENTIAL DAMAGES OR LOSS AS A RESULT OF
MODIFYING, DISTRIBUTING, OR OTHERWISE USING PYTHON, OR ANY DERIVATIVE
THEREOF, EVEN IF ADVISED OF THE POSSIBILITY THEREOF.
6. This License Agreement will automatically terminate upon a material breach of
its terms and conditions.
7. Nothing in this License Agreement shall be deemed to create any relationship
of agency, partnership, or joint venture between PSF and Licensee. This License
Agreement does not grant permission to use PSF trademarks or trade name in a
trademark sense to endorse or promote products or services of Licensee, or any
third party.
8. By copying, installing or otherwise using Python, Licensee agrees
to be bound by the terms and conditions of this License Agreement.
384 AppendixC. HistoryandLicense

### 第393页

C.2.2 BEOPEN.COM LICENSE AGREEMENT FOR PYTHON 2.0
BEOPENPYTHONOPENSOURCELICENSEAGREEMENTVERSION1
1. This LICENSE AGREEMENT is between BeOpen.com ("BeOpen"), having an office at
160 Saratoga Avenue, Santa Clara, CA 95051, and the Individual or Organization
("Licensee") accessing and otherwise using this software in source or binary
form and its associated documentation ("the Software").
2. Subject to the terms and conditions of this BeOpen Python License Agreement,
BeOpen hereby grants Licensee a non-exclusive, royalty-free, world-wide license
to reproduce, analyze, test, perform and/or display publicly, prepare derivative
works, distribute, and otherwise use the Software alone or in any derivative
version, provided, however, that the BeOpen Python License is retained in the
Software, alone or in any derivative version prepared by Licensee.
3. BeOpen is making the Software available to Licensee on an "AS IS" basis.
BEOPEN MAKES NO REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED. BY WAY OF
EXAMPLE, BUT NOT LIMITATION, BEOPEN MAKES NO AND DISCLAIMS ANY REPRESENTATION OR
WARRANTY OF MERCHANTABILITY OR FITNESS FOR ANY PARTICULAR PURPOSE OR THAT THE
USE OF THE SOFTWARE WILL NOT INFRINGE ANY THIRD PARTY RIGHTS.
4. BEOPEN SHALL NOT BE LIABLE TO LICENSEE OR ANY OTHER USERS OF THE SOFTWARE FOR
ANY INCIDENTAL, SPECIAL, OR CONSEQUENTIAL DAMAGES OR LOSS AS A RESULT OF USING,
MODIFYING OR DISTRIBUTING THE SOFTWARE, OR ANY DERIVATIVE THEREOF, EVEN IF
ADVISED OF THE POSSIBILITY THEREOF.
5. This License Agreement will automatically terminate upon a material breach of
its terms and conditions.
6. This License Agreement shall be governed by and interpreted in all respects
by the law of the State of California, excluding conflict of law provisions.
Nothing in this License Agreement shall be deemed to create any relationship of
agency, partnership, or joint venture between BeOpen and Licensee. This License
Agreement does not grant permission to use BeOpen trademarks or trade names in a
trademark sense to endorse or promote products or services of Licensee, or any
third party. As an exception, the "BeOpen Python" logos available at
http://www.pythonlabs.com/logos.html may be used according to the permissions
granted on that web page.
7. By copying, installing or otherwise using the software, Licensee agrees to be
bound by the terms and conditions of this License Agreement.
C.2.3 CNRI LICENSE AGREEMENT FOR PYTHON 1.6.1
1. This LICENSE AGREEMENT is between the Corporation for National Research
Initiatives, having an office at 1895 Preston White Drive, Reston, VA 20191
("CNRI"), and the Individual or Organization ("Licensee") accessing and
otherwise using Python 1.6.1 software in source or binary form and its
associated documentation.
2. Subject to the terms and conditions of this License Agreement, CNRI hereby
grants Licensee a nonexclusive, royalty-free, world-wide license to reproduce,
analyze, test, perform and/or display publicly, prepare derivative works,
distribute, and otherwise use Python 1.6.1 alone or in any derivative version,
provided, however, that CNRI's License Agreement and CNRI's notice of copyright,
i.e., "Copyright © 1995-2001 Corporation for National Research Initiatives; All
(continuesonnextpage)
C.2. TermsandconditionsforaccessingorotherwiseusingPython 385

### 第394页

(continuedfrompreviouspage)
Rights Reserved" are retained in Python 1.6.1 alone or in any derivative version
prepared by Licensee. Alternately, in lieu of CNRI's License Agreement,
Licensee may substitute the following text (omitting the quotes): "Python 1.6.1
is made available subject to the terms and conditions in CNRI's License
Agreement. This Agreement together with Python 1.6.1 may be located on the
internet using the following unique, persistent identifier (known as a handle):
1895.22/1013. This Agreement may also be obtained from a proxy server on the
internet using the following URL: http://hdl.handle.net/1895.22/1013".
3. In the event Licensee prepares a derivative work that is based on or
incorporates Python 1.6.1 or any part thereof, and wants to make the derivative
work available to others as provided herein, then Licensee hereby agrees to
include in any such work a brief summary of the changes made to Python 1.6.1.
4. CNRI is making Python 1.6.1 available to Licensee on an "AS IS" basis. CNRI
MAKES NO REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED. BY WAY OF EXAMPLE,
BUT NOT LIMITATION, CNRI MAKES NO AND DISCLAIMS ANY REPRESENTATION OR WARRANTY
OF MERCHANTABILITY OR FITNESS FOR ANY PARTICULAR PURPOSE OR THAT THE USE OF
PYTHON 1.6.1 WILL NOT INFRINGE ANY THIRD PARTY RIGHTS.
5. CNRI SHALL NOT BE LIABLE TO LICENSEE OR ANY OTHER USERS OF PYTHON 1.6.1 FOR
ANY INCIDENTAL, SPECIAL, OR CONSEQUENTIAL DAMAGES OR LOSS AS A RESULT OF
MODIFYING, DISTRIBUTING, OR OTHERWISE USING PYTHON 1.6.1, OR ANY DERIVATIVE
THEREOF, EVEN IF ADVISED OF THE POSSIBILITY THEREOF.
6. This License Agreement will automatically terminate upon a material breach of
its terms and conditions.
7. This License Agreement shall be governed by the federal intellectual property
law of the United States, including without limitation the federal copyright
law, and, to the extent such U.S. federal law does not apply, by the law of the
Commonwealth of Virginia, excluding Virginia's conflict of law provisions.
Notwithstanding the foregoing, with regard to derivative works based on Python
1.6.1 that incorporate non-separable material that was previously distributed
under the GNU General Public License (GPL), the law of the Commonwealth of
Virginia shall govern this License Agreement only as to issues arising under or
with respect to Paragraphs 4, 5, and 7 of this License Agreement. Nothing in
this License Agreement shall be deemed to create any relationship of agency,
partnership, or joint venture between CNRI and Licensee. This License Agreement
does not grant permission to use CNRI trademarks or trade name in a trademark
sense to endorse or promote products or services of Licensee, or any third
party.
8. By clicking on the "ACCEPT" button where indicated, or by copying, installing
or otherwise using Python 1.6.1, Licensee agrees to be bound by the terms and
conditions of this License Agreement.
C.2.4 CWI LICENSE AGREEMENT FOR PYTHON 0.9.0 THROUGH 1.2
Copyright © 1991 - 1995, Stichting Mathematisch Centrum Amsterdam, The
Netherlands. All rights reserved.
Permission to use, copy, modify, and distribute this software and its
documentation for any purpose and without fee is hereby granted, provided that
the above copyright notice appear in all copies and that both that copyright
(continuesonnextpage)
386 AppendixC. HistoryandLicense

### 第395页

(continuedfrompreviouspage)
notice and this permission notice appear in supporting documentation, and that
the name of Stichting Mathematisch Centrum or CWI not be used in advertising or
publicity pertaining to distribution of the software without specific, written
prior permission.
STICHTING MATHEMATISCH CENTRUM DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS
SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO
EVENT SHALL STICHTING MATHEMATISCH CENTRUM BE LIABLE FOR ANY SPECIAL, INDIRECT
OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE,
DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS
ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS
SOFTWARE.
C.2.5 ZERO-CLAUSE BSD LICENSE FOR CODE IN THE PYTHON DOCUMENTA-
TION
Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.
THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
C.3 Licenses and Acknowledgements for Incorporated Software
Thissectionisanincomplete,butgrowinglistoflicensesandacknowledgementsforthird-partysoftwareincorporated
inthePythondistribution.
C.3.1 Mersenne Twister
The_randomCextensionunderlyingtherandommoduleincludescodebasedonadownloadfromhttp://www.math.
sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/emt19937ar.html. Thefollowingaretheverbatimcommentsfromthe
originalcode:
A C-program for MT19937, with initialization improved 2002/1/26.
Coded by Takuji Nishimura and Makoto Matsumoto.
Before using, initialize the state by using init_genrand(seed)
or init_by_array(init_key, key_length).
Copyright (C) 1997 - 2002, Makoto Matsumoto and Takuji Nishimura,
All rights reserved.
Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:
1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.
(continuesonnextpage)
C.3. LicensesandAcknowledgementsforIncorporatedSoftware 387

### 第396页

(continuedfrompreviouspage)
2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.
3. The names of its contributors may not be used to endorse or promote
products derived from this software without specific prior written
permission.
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
Any feedback is very welcome.
http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/emt.html
email: m-mat @ math.sci.hiroshima-u.ac.jp (remove space)
C.3.2 Sockets
Thesocketmoduleusesthefunctions,getaddrinfo(),andgetnameinfo(),whicharecodedinseparatesource
filesfromtheWIDEProject,https://www.wide.ad.jp/.
Copyright (C) 1995, 1996, 1997, and 1998 WIDE Project.
All rights reserved.
Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:
1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.
3. Neither the name of the project nor the names of its contributors
may be used to endorse or promote products derived from this software
without specific prior written permission.
THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
SUCH DAMAGE.
388 AppendixC. HistoryandLicense

### 第397页

C.3.3 Asynchronous socket services
Thetest.support.asynchatandtest.support.asyncoremodulescontainthefollowingnotice:
Copyright 1996 by Sam Rushing
All Rights Reserved
Permission to use, copy, modify, and distribute this software and
its documentation for any purpose and without fee is hereby
granted, provided that the above copyright notice appear in all
copies and that both that copyright notice and this permission
notice appear in supporting documentation, and that the name of Sam
Rushing not be used in advertising or publicity pertaining to
distribution of the software without specific, written prior
permission.
SAM RUSHING DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,
INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN
NO EVENT SHALL SAM RUSHING BE LIABLE FOR ANY SPECIAL, INDIRECT OR
CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS
OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
C.3.4 Cookie management
Thehttp.cookiesmodulecontainsthefollowingnotice:
Copyright 2000 by Timothy O'Malley <timo@alum.mit.edu>
All Rights Reserved
Permission to use, copy, modify, and distribute this software
and its documentation for any purpose and without fee is hereby
granted, provided that the above copyright notice appear in all
copies and that both that copyright notice and this permission
notice appear in supporting documentation, and that the name of
Timothy O'Malley not be used in advertising or publicity
pertaining to distribution of the software without specific, written
prior permission.
Timothy O'Malley DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS
SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS, IN NO EVENT SHALL Timothy O'Malley BE LIABLE FOR
ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,
WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS
ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
C.3.5 Execution tracing
Thetracemodulecontainsthefollowingnotice:
portions copyright 2001, Autonomous Zones Industries, Inc., all rights...
err... reserved and offered to the public under the terms of the
Python 2.2 license.
(continuesonnextpage)
C.3. LicensesandAcknowledgementsforIncorporatedSoftware 389

### 第398页

(continuedfrompreviouspage)
Author: Zooko O'Whielacronx
http://zooko.com/
mailto:zooko@zooko.com
Copyright 2000, Mojam Media, Inc., all rights reserved.
Author: Skip Montanaro
Copyright 1999, Bioreason, Inc., all rights reserved.
Author: Andrew Dalke
Copyright 1995-1997, Automatrix, Inc., all rights reserved.
Author: Skip Montanaro
Copyright 1991-1995, Stichting Mathematisch Centrum, all rights reserved.
Permission to use, copy, modify, and distribute this Python software and
its associated documentation for any purpose without fee is hereby
granted, provided that the above copyright notice appears in all copies,
and that both that copyright notice and this permission notice appear in
supporting documentation, and that the name of neither Automatrix,
Bioreason or Mojam Media be used in advertising or publicity pertaining to
distribution of the software without specific, written prior permission.
C.3.6 UUencode and UUdecode functions
Theuucodeccontainsthefollowingnotice:
Copyright 1994 by Lance Ellinghouse
Cathedral City, California Republic, United States of America.
All Rights Reserved
Permission to use, copy, modify, and distribute this software and its
documentation for any purpose and without fee is hereby granted,
provided that the above copyright notice appear in all copies and that
both that copyright notice and this permission notice appear in
supporting documentation, and that the name of Lance Ellinghouse
not be used in advertising or publicity pertaining to distribution
of the software without specific, written prior permission.
LANCE ELLINGHOUSE DISCLAIMS ALL WARRANTIES WITH REGARD TO
THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND
FITNESS, IN NO EVENT SHALL LANCE ELLINGHOUSE CENTRUM BE LIABLE
FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT
OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
Modified by Jack Jansen, CWI, July 1995:
- Use binascii module to do the actual line-by-line conversion
between ascii and binary. This results in a 1000-fold speedup. The C
version is still 5 times faster, though.
- Arguments more compliant with Python standard
390 AppendixC. HistoryandLicense

### 第399页

C.3.7 XML Remote Procedure Calls
Thexmlrpc.clientmodulecontainsthefollowingnotice:
The XML-RPC client interface is
Copyright (c) 1999-2002 by Secret Labs AB
Copyright (c) 1999-2002 by Fredrik Lundh
By obtaining, using, and/or copying this software and/or its
associated documentation, you agree that you have read, understood,
and will comply with the following terms and conditions:
Permission to use, copy, modify, and distribute this software and
its associated documentation for any purpose and without fee is
hereby granted, provided that the above copyright notice appears in
all copies, and that both that copyright notice and this permission
notice appear in supporting documentation, and that the name of
Secret Labs AB or the author not be used in advertising or publicity
pertaining to distribution of the software without specific, written
prior permission.
SECRET LABS AB AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD
TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANT-
ABILITY AND FITNESS. IN NO EVENT SHALL SECRET LABS AB OR THE AUTHOR
BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY
DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,
WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS
ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE
OF THIS SOFTWARE.
C.3.8 test_epoll
Thetest.test_epollmodulecontainsthefollowingnotice:
Copyright (c) 2001-2006 Twisted Matrix Laboratories.
Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:
The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
C.3. LicensesandAcknowledgementsforIncorporatedSoftware 391

### 第400页

C.3.9 Select kqueue
Theselectmodulecontainsthefollowingnoticeforthekqueueinterface:
Copyright (c) 2000 Doug White, 2006 James Knight, 2007 Christian Heimes
All rights reserved.
Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:
1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.
THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
SUCH DAMAGE.
C.3.10 SipHash24
ThefilePython/pyhash.ccontainsMarekMajkowski’implementationofDanBernstein’sSipHash24algorithm.
Itcontainsthefollowingnote:
<MIT License>
Copyright (c) 2013 Marek Majkowski <marek@popcount.org>
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
</MIT License>
Original location:
https://github.com/majek/csiphash/
Solution inspired by code from:
Samuel Neves (supercop/crypto_auth/siphash24/little)
djb (supercop/crypto_auth/siphash24/little2)
Jean-Philippe Aumasson (https://131002.net/siphash/siphash24.c)
392 AppendixC. HistoryandLicense

### 第401页

C.3.11 strtod and dtoa
ThefilePython/dtoa.c,whichsuppliesCfunctionsdtoaandstrtodforconversionofCdoublestoandfromstrings,
isderivedfromthefileofthesamenamebyDavidM.Gay, currentlyavailablefromhttps://web.archive.org/web/
20220517033456/http://www.netlib.org/fp/dtoa.c. The original file, as retrieved on March 16, 2009, contains the
followingcopyrightandlicensingnotice:
/****************************************************************
*
* The author of this software is David M. Gay.
*
* Copyright (c) 1991, 2000, 2001 by Lucent Technologies.
*
* Permission to use, copy, modify, and distribute this software for any
* purpose without fee is hereby granted, provided that this entire notice
* is included in all copies of any software which is or includes a copy
* or modification of this software and in all copies of the supporting
* documentation for such software.
*
* THIS SOFTWARE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED
* WARRANTY. IN PARTICULAR, NEITHER THE AUTHOR NOR LUCENT MAKES ANY
* REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY
* OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.
*
***************************************************************/
C.3.12 OpenSSL
Themoduleshashlib,posixandsslusetheOpenSSLlibraryforaddedperformanceifmadeavailablebythe
operatingsystem. Additionally,theWindowsandmacOSinstallersforPythonmayincludeacopyoftheOpenSSL
libraries,soweincludeacopyoftheOpenSSLlicensehere. FortheOpenSSL3.0release,andlaterreleasesderived
fromthat,theApacheLicensev2applies:
Apache License
Version 2.0, January 2004
https://www.apache.org/licenses/
TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
1. Definitions.
"License" shall mean the terms and conditions for use, reproduction,
and distribution as defined by Sections 1 through 9 of this document.
"Licensor" shall mean the copyright owner or entity authorized by
the copyright owner that is granting the License.
"Legal Entity" shall mean the union of the acting entity and all
other entities that control, are controlled by, or are under common
control with that entity. For the purposes of this definition,
"control" means (i) the power, direct or indirect, to cause the
direction or management of such entity, whether by contract or
otherwise, or (ii) ownership of fifty percent (50%) or more of the
outstanding shares, or (iii) beneficial ownership of such entity.
"You" (or "Your") shall mean an individual or Legal Entity
exercising permissions granted by this License.
(continuesonnextpage)
C.3. LicensesandAcknowledgementsforIncorporatedSoftware 393

### 第402页

(continuedfrompreviouspage)
"Source" form shall mean the preferred form for making modifications,
including but not limited to software source code, documentation
source, and configuration files.
"Object" form shall mean any form resulting from mechanical
transformation or translation of a Source form, including but
not limited to compiled object code, generated documentation,
and conversions to other media types.
"Work" shall mean the work of authorship, whether in Source or
Object form, made available under the License, as indicated by a
copyright notice that is included in or attached to the work
(an example is provided in the Appendix below).
"Derivative Works" shall mean any work, whether in Source or Object
form, that is based on (or derived from) the Work and for which the
editorial revisions, annotations, elaborations, or other modifications
represent, as a whole, an original work of authorship. For the purposes
of this License, Derivative Works shall not include works that remain
separable from, or merely link (or bind by name) to the interfaces of,
the Work and Derivative Works thereof.
"Contribution" shall mean any work of authorship, including
the original version of the Work and any modifications or additions
to that Work or Derivative Works thereof, that is intentionally
submitted to Licensor for inclusion in the Work by the copyright owner
or by an individual or Legal Entity authorized to submit on behalf of
the copyright owner. For the purposes of this definition, "submitted"
means any form of electronic, verbal, or written communication sent
to the Licensor or its representatives, including but not limited to
communication on electronic mailing lists, source code control systems,
and issue tracking systems that are managed by, or on behalf of, the
Licensor for the purpose of discussing and improving the Work, but
excluding communication that is conspicuously marked or otherwise
designated in writing by the copyright owner as "Not a Contribution."
"Contributor" shall mean Licensor and any individual or Legal Entity
on behalf of whom a Contribution has been received by Licensor and
subsequently incorporated within the Work.
2. Grant of Copyright License. Subject to the terms and conditions of
this License, each Contributor hereby grants to You a perpetual,
worldwide, non-exclusive, no-charge, royalty-free, irrevocable
copyright license to reproduce, prepare Derivative Works of,
publicly display, publicly perform, sublicense, and distribute the
Work and such Derivative Works in Source or Object form.
3. Grant of Patent License. Subject to the terms and conditions of
this License, each Contributor hereby grants to You a perpetual,
worldwide, non-exclusive, no-charge, royalty-free, irrevocable
(except as stated in this section) patent license to make, have made,
use, offer to sell, sell, import, and otherwise transfer the Work,
where such license applies only to those patent claims licensable
by such Contributor that are necessarily infringed by their
Contribution(s) alone or by combination of their Contribution(s)
with the Work to which such Contribution(s) was submitted. If You
(continuesonnextpage)
394 AppendixC. HistoryandLicense

### 第403页

(continuedfrompreviouspage)
institute patent litigation against any entity (including a
cross-claim or counterclaim in a lawsuit) alleging that the Work
or a Contribution incorporated within the Work constitutes direct
or contributory patent infringement, then any patent licenses
granted to You under this License for that Work shall terminate
as of the date such litigation is filed.
4. Redistribution. You may reproduce and distribute copies of the
Work or Derivative Works thereof in any medium, with or without
modifications, and in Source or Object form, provided that You
meet the following conditions:
(a) You must give any other recipients of the Work or
Derivative Works a copy of this License; and
(b) You must cause any modified files to carry prominent notices
stating that You changed the files; and
(c) You must retain, in the Source form of any Derivative Works
that You distribute, all copyright, patent, trademark, and
attribution notices from the Source form of the Work,
excluding those notices that do not pertain to any part of
the Derivative Works; and
(d) If the Work includes a "NOTICE" text file as part of its
distribution, then any Derivative Works that You distribute must
include a readable copy of the attribution notices contained
within such NOTICE file, excluding those notices that do not
pertain to any part of the Derivative Works, in at least one
of the following places: within a NOTICE text file distributed
as part of the Derivative Works; within the Source form or
documentation, if provided along with the Derivative Works; or,
within a display generated by the Derivative Works, if and
wherever such third-party notices normally appear. The contents
of the NOTICE file are for informational purposes only and
do not modify the License. You may add Your own attribution
notices within Derivative Works that You distribute, alongside
or as an addendum to the NOTICE text from the Work, provided
that such additional attribution notices cannot be construed
as modifying the License.
You may add Your own copyright statement to Your modifications and
may provide additional or different license terms and conditions
for use, reproduction, or distribution of Your modifications, or
for any such Derivative Works as a whole, provided Your use,
reproduction, and distribution of the Work otherwise complies with
the conditions stated in this License.
5. Submission of Contributions. Unless You explicitly state otherwise,
any Contribution intentionally submitted for inclusion in the Work
by You to the Licensor shall be under the terms and conditions of
this License, without any additional terms or conditions.
Notwithstanding the above, nothing herein shall supersede or modify
the terms of any separate license agreement you may have executed
with Licensor regarding such Contributions.
(continuesonnextpage)
C.3. LicensesandAcknowledgementsforIncorporatedSoftware 395

### 第404页

(continuedfrompreviouspage)
6. Trademarks. This License does not grant permission to use the trade
names, trademarks, service marks, or product names of the Licensor,
except as required for reasonable and customary use in describing the
origin of the Work and reproducing the content of the NOTICE file.
7. Disclaimer of Warranty. Unless required by applicable law or
agreed to in writing, Licensor provides the Work (and each
Contributor provides its Contributions) on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied, including, without limitation, any warranties or conditions
of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
PARTICULAR PURPOSE. You are solely responsible for determining the
appropriateness of using or redistributing the Work and assume any
risks associated with Your exercise of permissions under this License.
8. Limitation of Liability. In no event and under no legal theory,
whether in tort (including negligence), contract, or otherwise,
unless required by applicable law (such as deliberate and grossly
negligent acts) or agreed to in writing, shall any Contributor be
liable to You for damages, including any direct, indirect, special,
incidental, or consequential damages of any character arising as a
result of this License or out of the use or inability to use the
Work (including but not limited to damages for loss of goodwill,
work stoppage, computer failure or malfunction, or any and all
other commercial damages or losses), even if such Contributor
has been advised of the possibility of such damages.
9. Accepting Warranty or Additional Liability. While redistributing
the Work or Derivative Works thereof, You may choose to offer,
and charge a fee for, acceptance of support, warranty, indemnity,
or other liability obligations and/or rights consistent with this
License. However, in accepting such obligations, You may act only
on Your own behalf and on Your sole responsibility, not on behalf
of any other Contributor, and only if You agree to indemnify,
defend, and hold each Contributor harmless for any liability
incurred by, or claims asserted against, such Contributor by reason
of your accepting any such warranty or additional liability.
END OF TERMS AND CONDITIONS
C.3.13 expat
The pyexpat extension is built using an included copy of the expat sources unless the build is configured
--with-system-expat:
Copyright (c) 1998, 1999, 2000 Thai Open Source Software Center Ltd
and Clark Cooper
Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:
(continuesonnextpage)
396 AppendixC. HistoryandLicense

### 第405页

(continuedfrompreviouspage)
The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
C.3.14 libffi
The_ctypesCextensionunderlyingthectypesmoduleisbuiltusinganincludedcopyofthelibffisourcesunless
thebuildisconfigured--with-system-libffi:
Copyright (c) 1996-2008 Red Hat, Inc and others.
Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:
The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
DEALINGS IN THE SOFTWARE.
C.3.15 zlib
Thezlibextensionisbuiltusinganincludedcopyofthezlibsourcesifthezlibversionfoundonthesystemistoo
oldtobeusedforthebuild:
Copyright (C) 1995-2011 Jean-loup Gailly and Mark Adler
This software is provided 'as-is', without any express or implied
warranty. In no event will the authors be held liable for any damages
arising from the use of this software.
Permission is granted to anyone to use this software for any purpose,
including commercial applications, and to alter it and redistribute it
freely, subject to the following restrictions:
1. The origin of this software must not be misrepresented; you must not
claim that you wrote the original software. If you use this software
in a product, an acknowledgment in the product documentation would be
(continuesonnextpage)
C.3. LicensesandAcknowledgementsforIncorporatedSoftware 397

### 第406页

(continuedfrompreviouspage)
appreciated but is not required.
2. Altered source versions must be plainly marked as such, and must not be
misrepresented as being the original software.
3. This notice may not be removed or altered from any source distribution.
Jean-loup Gailly Mark Adler
jloup@gzip.org madler@alumni.caltech.edu
C.3.16 cfuhash
Theimplementationofthehashtableusedbythetracemallocisbasedonthecfuhashproject:
Copyright (c) 2005 Don Owens
All rights reserved.
This code is released under the BSD license:
Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:
* Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.
* Redistributions in binary form must reproduce the above
copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided
with the distribution.
* Neither the name of the author nor the names of its
contributors may be used to endorse or promote products derived
from this software without specific prior written permission.
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
OF THE POSSIBILITY OF SUCH DAMAGE.
C.3.17 libmpdec
The_decimalCextensionunderlyingthedecimalmoduleisbuiltusinganincludedcopyofthelibmpdeclibrary
unlessthebuildisconfigured--with-system-libmpdec:
Copyright (c) 2008-2020 Stefan Krah. All rights reserved.
Redistribution and use in source and binary forms, with or without
(continuesonnextpage)
398 AppendixC. HistoryandLicense

### 第407页

(continuedfrompreviouspage)
modification, are permitted provided that the following conditions
are met:
1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.
THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
SUCH DAMAGE.
C.3.18 W3C C14N test suite
TheC14N2.0testsuiteinthetestpackage(Lib/test/xmltestdata/c14n-20/)wasretrievedfromtheW3C
websiteathttps://www.w3.org/TR/xml-c14n2-testcases/andisdistributedunderthe3-clauseBSDlicense:
Copyright (c) 2013 W3C(R) (MIT, ERCIM, Keio, Beihang),
All Rights Reserved.
Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:
* Redistributions of works must retain the original copyright notice,
this list of conditions and the following disclaimer.
* Redistributions in binary form must reproduce the original copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.
* Neither the name of the W3C nor the names of its contributors may be
used to endorse or promote products derived from this work without
specific prior written permission.
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
C.3. LicensesandAcknowledgementsforIncorporatedSoftware 399

### 第408页

C.3.19 mimalloc
MITLicense:
Copyright (c) 2018-2021 Microsoft Corporation, Daan Leijen
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
C.3.20 asyncio
Partsoftheasynciomoduleareincorporatedfromuvloop0.16,whichisdistributedundertheMITlicense:
Copyright (c) 2015-2021 MagicStack Inc. http://magic.io
Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:
The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
C.3.21 Global Unbounded Sequences (GUS)
The file Python/qsbr.c is adapted from FreeBSD’s “Global Unbounded Sequences” safe memory reclamation
schemeinsubr_smr.c. Thefileisdistributedunderthe2-ClauseBSDLicense:
Copyright (c) 2019,2020 Jeffrey Roberson <jeff@FreeBSD.org>
Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
(continuesonnextpage)
400 AppendixC. HistoryandLicense

### 第409页

(continuedfrompreviouspage)
are met:
1. Redistributions of source code must retain the above copyright
notice unmodified, this list of conditions, and the following
disclaimer.
2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.
THIS SOFTWARE IS PROVIDED BY THE AUTHOR "AS IS" AND ANY EXPRESS OR
IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
C.3.22 Zstandard bindings
ZstandardbindingsinModules/_zstdandLib/compression/zstdarebasedoncodefromthepyzstdlibrary,
copyrightMaLinandcontributors. Thepyzstdcodeisdistributedunderthe3-ClauseBSDLicense:
Copyright (c) 2020-present, Ma Lin and contributors.
All rights reserved.
Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:
1. Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.
3. Neither the name of the copyright holder nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
C.3. LicensesandAcknowledgementsforIncorporatedSoftware 401

### 第410页

402 AppendixC. HistoryandLicense

### 第411页

APPENDIX
D
COPYRIGHT
Pythonandthisdocumentationis:
Copyright©2001PythonSoftwareFoundation. Allrightsreserved.
Copyright©2000BeOpen.com. Allrightsreserved.
Copyright©1995-2000CorporationforNationalResearchInitiatives. Allrightsreserved.
Copyright©1991-1995StichtingMathematischCentrum. Allrightsreserved.
SeeHistoryandLicenseforcompletelicenseandpermissionsinformation.
403

### 第412页

404 AppendixD. Copyright

### 第413页

BIBLIOGRAPHY
[win] PyExc_WindowsErrorisonlydefinedonWindows; protectcodethatusesthisbytestingthattheprepro-
cessormacroMS_WINDOWSisdefined.
405

### 第414页

406 Bibliography

### 第415页

INDEX
Non-alphabetical A
...,363 abort(Cfunction),80
ellipsis literal,363 abs
>>>,363 built-in function,118
__all__(packagevariable),80 abstract base class,363
__dict__(moduleattribute),201 allocfunc(Ctype),346
__doc__(moduleattribute),201 annotate function,363
__file__(moduleattribute),201,202 annotation,363
__future__,369 argument,363
__import__ argv(inmodulesys),234,267
built-in function,80 ascii
__loader__(moduleattribute),201 built-in function,107
__main__ asynchronous context manager,364
module,11,229,244,245 asynchronous generator,364
__name__(moduleattribute),201 asynchronous generator iterator,364
__package__(moduleattribute),201 asynchronous iterable,364
__PYVENV_LAUNCHER__,268,274 asynchronous iterator,364
__slots__,377 attached thread state,364
_frozen(Cstruct),83 attribute,364
_inittab(Cstruct),84 awaitable,365
_inittab.initfunc(Cmember),84
B
_inittab.name(Cmember),84
_Py_c_diff(Cfunction),153 BDFL,365
_Py_c_neg(Cfunction),153 binary file,365
_Py_c_pow(Cfunction),153 binaryfunc(Ctype),347
_Py_c_prod(Cfunction),153 borrowed reference,365
_Py_c_quot(Cfunction),153 buffer interface
_Py_c_sum(Cfunction),152 (see buffer protocol),125
_Py_NoneStruct(Cvar),297 buffer object
_PyBytes_Resize(Cfunction),156 (see buffer protocol),125
_PyCode_GetExtra(Cfunction),199 buffer protocol,125
_PyCode_SetExtra(Cfunction),199 built-in function
_PyEval_RequestCodeExtraIndex (C function), __import__,80
199 abs,118
_PyFrameEvalFunction(Ctype),242 ascii,107
_PyInterpreterFrame(Cstruct),217 bytes,108
_PyInterpreterState_GetEvalFrameFunc (C classmethod,305
function),242 compile,82
_PyInterpreterState_SetEvalFrameFunc (C divmod,118
function),242 float,120
_PyObject_GetDictPtr(Cfunction),107 hash,108,322
_PyObject_New(Cfunction),295 int,120
_PyObject_NewVar(Cfunction),295 len,109,121,123,182,186,189
_PyTuple_Resize(Cfunction),180 pow,118,120
_thread repr,107,321
module,238 staticmethod,305
407

### 第416页

tuple,122,183 coroutine function,366
type,108 CPython,367
builtins current context,367
module,11,229,244,245 cyclic isolate,367
bytearray
D
object,156
bytecode,365 decorator,367
bytes descrgetfunc(Ctype),347
built-in function,108 descriptor,367
object,154 descrsetfunc(Ctype),347
bytes-like object,365 destructor(Ctype),347
dictionary,367
C
object,184
callable,365 dictionary comprehension,367
callback,365 dictionary view,367
calloc(Cfunction),283 divmod
Capsule built-in function,118
object,213 docstring,367
C-contiguous,128,366 duck-typing,368
class,365 dunder,368
class variable,365
E
classmethod
built-in function,305 EAFP,368
cleanup functions,80 environment variable
close(inmoduleos),245 __PYVENV_LAUNCHER__,268,274
closure variable,366 PATH,12
CO_ASYNC_GENERATOR(Cmacro),198 PYTHON_CPU_COUNT,271
CO_COROUTINE(Cmacro),198 PYTHON_FROZEN_MODULES,270
CO_FUTURE_ABSOLUTE_IMPORT(Cmacro),198 PYTHON_GIL,370
CO_FUTURE_ANNOTATIONS(Cmacro),198 PYTHON_PERF_JIT_SUPPORT,276
CO_FUTURE_DIVISION(Cmacro),198 PYTHON_PRESITE,275
CO_FUTURE_GENERATOR_STOP(Cmacro),198 PYTHONCOERCECLOCALE,279
CO_FUTURE_PRINT_FUNCTION(Cmacro),198 PYTHONDEBUG,226,273
CO_FUTURE_UNICODE_LITERALS(Cmacro),198 PYTHONDEVMODE,269
CO_FUTURE_WITH_STATEMENT(Cmacro),198 PYTHONDONTWRITEBYTECODE,227,277
CO_GENERATOR(Cmacro),198 PYTHONDUMPREFS,269
CO_HAS_DOCSTRING(Cmacro),198 PYTHONDUMPREFSFILE,269
CO_ITERABLE_COROUTINE(Cmacro),198 PYTHONEXECUTABLE,274
CO_METHOD(Cmacro),198 PYTHONFAULTHANDLER,270
CO_NESTED(Cmacro),198 PYTHONHASHSEED,227,270
CO_NEWLOCALS(Cmacro),198 PYTHONHOME,12,227,235,271
CO_OPTIMIZED(Cmacro),198 PYTHONINSPECT,227,271
CO_VARARGS(Cmacro),198 PYTHONINTMAXSTRDIGITS,271
CO_VARKEYWORDS(Cmacro),198 PYTHONIOENCODING,275
code object,194 PYTHONLEGACYWINDOWSFSENCODING,228,264
Common Vulnerabilities and Exposures PYTHONLEGACYWINDOWSSTDIO,228,272
CVE 2008-5983,234 PYTHONMALLOC,284,288,290,291
compile PYTHONMALLOCSTATS,272,284
built-in function,82 PYTHONNODEBUGRANGES,268
complex number,366 PYTHONNOUSERSITE,228,276
object,152 PYTHONOPTIMIZE,228,273
context,366 PYTHONPATH,12,227,272
context management protocol,366 PYTHONPERFSUPPORT,276
context manager,366 PYTHONPLATLIBDIR,272
context variable,366 PYTHONPROFILEIMPORTTIME,271
contiguous,128,366 PYTHONPYCACHEPREFIX,274
copyright(inmodulesys),233 PYTHONSAFEPATH,267
coroutine,366 PYTHONTRACEMALLOC,276
408 Index

### 第417页

PYTHONUNBUFFERED,229,268 hashable,370
PYTHONUTF8,265,279 hashfunc(Ctype),347
PYTHONVERBOSE,229,277
I
PYTHONWARNINGS,277
EOFError(built-inexception),200 IDLE,371
evaluate function,368 immortal,371
exc_info(inmodulesys),10 immutable,371
executable(inmodulesys),233 import path,371
exit(Cfunction),80 importer,371
expression,368 importing,371
extension module,368 incr_item(),10,11
initproc(Ctype),347
F
inquiry(Ctype),353
f-string,368 instancemethod
f-strings,368 object,193
file int
object,200 built-in function,120
file object,368 integer
file-like object,368 object,140
filesystem encoding and error handler,368 interactive,371
finder,369 interpreted,371
float interpreter lock,235
built-in function,120 interpreter shutdown,371
floating-point iterable,371
object,150 iterator,372
floor division,369 iternextfunc(Ctype),347
Fortran contiguous,128,366
K
free(Cfunction),283
free threading,369 key function,372
free variable,369 KeyboardInterrupt(built-inexception),58,59
freefunc(Ctype),347 keyword argument,372
freeze utility,83
frozenset L
object,189
lambda,372
function,369
LBYL,372
object,190
len
function annotation,369
built-in function, 109, 121, 123, 182, 186,
189
G
lenfunc(Ctype),347
garbage collection,369 lexical analyzer,372
gcvisitobjects_t(Ctype),354 list,372
generator,369 object,182
generator expression,370 list comprehension,372
generator iterator,370 loader,372
generic function,370 locale encoding,373
generic type,370 lock, interpreter,235
getattrfunc(Ctype),347
long integer
getattrofunc(Ctype),347 object,140
getbufferproc(Ctype),347 LONG_MAX(Cmacro),142
getiterfunc(Ctype),347
getter(Ctype),310 M
GIL,370
magic
global interpreter lock,235,370 method,373
magic method,373
H
main(),232,234,267
hash malloc(Cfunction),283
built-in function,108,322 mapping,373
hash-based pyc,370 object,184
Index 409

### 第418页

memoryview integer,140
object,211 list,182
meta path finder,373 long integer,140
metaclass,373 mapping,184
METH_CLASS(Cmacro),305 memoryview,211
METH_COEXIST(Cmacro),306 method,193
METH_FASTCALL(Cmacro),305 module,201
METH_KEYWORDS(Cmacro),304 None,140
METH_METHOD(Cmacro),305 numeric,140
METH_NOARGS(Cmacro),305 sequence,154
METH_O(Cmacro),305 set,189
METH_STATIC(Cmacro),305 tuple,179
METH_VARARGS(Cmacro),304 type,6,133
method,373 objobjargproc(Ctype),348
magic,373 objobjproc(Ctype),348
object,193 optimized scope,374
special,378 OverflowError(built-inexception),142,143
method resolution order,373
P
MethodType(inmoduletypes),190,193
module,373 package,374
__main__,11,229,244,245
package variable
_thread,238 __all__,80
builtins,11,229,244,245 parameter,375
object,201 PATH,12
searchpath,11,229,233
path
signal,58,59 modulesearch,11,229,233
sys,11,229,244,245 path(inmodulesys),11,229,233
module spec,373 path based finder,375
modules(inmodulesys),80,229 path entry,375
ModuleType(inmoduletypes),201 path entry finder,375
MRO,373 path entry hook,375
mutable,373 path-like object,375
PEP,375
N
platform(inmodulesys),233
named tuple,374 portion,376
namespace,374 positional argument,376
namespace package,374 pow
nested scope,374 built-in function,118,120
new-style class,374 provisional API,376
newfunc(Ctype),347 provisional package,376
None Py_ABS(Cmacro),4
object,140 Py_AddPendingCall(Cfunction),246
numeric Py_ALWAYS_INLINE(Cmacro),4
object,140 Py_ASNATIVEBYTES_ALLOW_INDEX(Cmacro),146
Py_ASNATIVEBYTES_BIG_ENDIAN(Cmacro),146
O
Py_ASNATIVEBYTES_DEFAULTS(Cmacro),146
object,374 Py_ASNATIVEBYTES_LITTLE_ENDIAN (C macro),
bytearray,156 146
bytes,154 Py_ASNATIVEBYTES_NATIVE_ENDIAN (C macro),
Capsule,213 146
code,194 Py_ASNATIVEBYTES_REJECT_NEGATIVE (C macro),
complex number,152 146
dictionary,184 Py_ASNATIVEBYTES_UNSIGNED_BUFFER (C macro),
file,200 146
floating-point,150 Py_AtExit(Cfunction),80
frozenset,189 Py_AUDIT_READ(Cmacro),307
function,190 Py_AuditHookFunction(Ctype),79
instancemethod,193 Py_BEGIN_ALLOW_THREADS(Cmacro),236,240
410 Index

### 第419页

Py_BEGIN_CRITICAL_SECTION(Cmacro),253 Py_eval_input(Cvar),46
Py_BEGIN_CRITICAL_SECTION2(Cmacro),254 Py_Exit(Cfunction),80
Py_BEGIN_CRITICAL_SECTION2_MUTEX (C macro), Py_ExitStatusException(Cfunction),263
254 Py_False(Cvar),150
Py_BEGIN_CRITICAL_SECTION_MUTEX (C macro), Py_FatalError(Cfunction),80
253 Py_FatalError(),234
Py_BLOCK_THREADS(Cmacro),240 Py_fclose(Cfunction),78
Py_buffer(Ctype),126 Py_FdIsInteractive(Cfunction),75
Py_buffer.buf(Cmember),126 Py_file_input(Cvar),46
Py_buffer.format(Cmember),126 Py_Finalize(Cfunction),230
Py_buffer.internal(Cmember),127 Py_FinalizeEx(Cfunction),80,229,230,245
Py_buffer.itemsize(Cmember),126 Py_fopen(Cfunction),77
Py_buffer.len(Cmember),126 Py_FrozenFlag(Cvar),227
Py_buffer.ndim(Cmember),126 Py_GE(Cmacro),332
Py_buffer.obj(Cmember),126 Py_GenericAlias(Cfunction),224
Py_buffer.readonly(Cmember),126 Py_GenericAliasType(Cvar),224
Py_buffer.shape(Cmember),126 Py_GetArgcArgv(Cfunction),281
Py_buffer.strides(Cmember),127 Py_GetBuildInfo(Cfunction),234
Py_buffer.suboffsets(Cmember),127 Py_GetCompiler(Cfunction),234
Py_BuildValue(Cfunction),92 Py_GetConstant(Cfunction),103
Py_BytesMain(Cfunction),230 Py_GetConstantBorrowed(Cfunction),104
Py_BytesWarningFlag(Cvar),226 Py_GetCopyright(Cfunction),233
Py_CHARMASK(Cmacro),4 Py_GETENV(Cmacro),5
Py_CLEANUP_SUPPORTED(Cmacro),89 Py_GetExecPrefix(Cfunction),12,232
Py_CLEAR(Cfunction),48 Py_GetPath(Cfunction),12,233
Py_CompileString(Cfunction),45,46 Py_GetPath(),232
Py_CompileStringExFlags(Cfunction),45 Py_GetPlatform(Cfunction),233
Py_CompileStringFlags(Cfunction),45 Py_GetPrefix(Cfunction),12,232
Py_CompileStringObject(Cfunction),45 Py_GetProgramFullPath(Cfunction),12,233
Py_complex(Ctype),152 Py_GetProgramName(Cfunction),232
Py_complex.imag(Cmember),152 Py_GetPythonHome(Cfunction),235
Py_complex.real(Cmember),152 Py_GetVersion(Cfunction),233
Py_CONSTANT_ELLIPSIS(Cmacro),104 Py_GT(Cmacro),332
Py_CONSTANT_EMPTY_BYTES(Cmacro),104 Py_hash_t(Ctype),96
Py_CONSTANT_EMPTY_STR(Cmacro),104 Py_HashBuffer(Cfunction),97
Py_CONSTANT_EMPTY_TUPLE(Cmacro),104 Py_HashPointer(Cfunction),96
Py_CONSTANT_FALSE(Cmacro),104 Py_HashRandomizationFlag(Cvar),227
Py_CONSTANT_NONE(Cmacro),104 Py_IgnoreEnvironmentFlag(Cvar),227
Py_CONSTANT_NOT_IMPLEMENTED(Cmacro),104 Py_INCREF(Cfunction),6,47
Py_CONSTANT_ONE(Cmacro),104 Py_IncRef(Cfunction),49
Py_CONSTANT_TRUE(Cmacro),104 Py_Initialize(Cfunction),11,229,245
Py_CONSTANT_ZERO(Cmacro),104 Py_Initialize(),232
PY_CXX_CONST(Cmacro),91 Py_InitializeEx(Cfunction),229
Py_DEBUG(Cmacro),12 Py_InitializeFromConfig(Cfunction),229
Py_DebugFlag(Cvar),226 Py_InitializeFromInitConfig(Cfunction),258
Py_DecodeLocale(Cfunction),76 Py_InspectFlag(Cvar),227
Py_DECREF(Cfunction),6,48 Py_InteractiveFlag(Cvar),227
Py_DecRef(Cfunction),49 Py_Is(Cfunction),302
Py_DEPRECATED(Cmacro),5 Py_IS_TYPE(Cfunction),302
Py_DontWriteBytecodeFlag(Cvar),226 Py_IsFalse(Cfunction),302
Py_Ellipsis(Cvar),211 Py_IsFinalizing(Cfunction),229
Py_EncodeLocale(Cfunction),77 Py_IsInitialized(Cfunction),12,229
Py_END_ALLOW_THREADS(Cmacro),236,240 Py_IsNone(Cfunction),302
Py_END_CRITICAL_SECTION(Cmacro),253 Py_IsolatedFlag(Cvar),227
Py_END_CRITICAL_SECTION2(Cmacro),254 Py_IsTrue(Cfunction),302
Py_EndInterpreter(Cfunction),245 Py_LE(Cmacro),332
Py_EnterRecursiveCall(Cfunction),62 Py_LeaveRecursiveCall(Cfunction),62
Py_EQ(Cmacro),332 Py_LegacyWindowsFSEncodingFlag(Cvar),228
Index 411

### 第420页

Py_LegacyWindowsStdioFlag(Cvar),228 Py_OptimizeFlag(Cvar),228
Py_LIMITED_API(Cmacro),15 Py_PACK_FULL_VERSION(Cfunction),355
Py_LT(Cmacro),332 Py_PACK_VERSION(Cfunction),356
Py_Main(Cfunction),230 Py_PreInitialize(Cfunction),265
PY_MAJOR_VERSION(Cmacro),355 Py_PreInitializeFromArgs(Cfunction),265
Py_MARSHAL_VERSION(Cmacro),84 Py_PreInitializeFromBytesArgs (C function),
Py_MAX(Cmacro),5 265
Py_MEMBER_SIZE(Cmacro),5 Py_PRINT_RAW(Cmacro),104,201
PY_MICRO_VERSION(Cmacro),355 Py_QuietFlag(Cvar),228
Py_MIN(Cmacro),5 Py_READONLY(Cmacro),307
PY_MINOR_VERSION(Cmacro),355 Py_REFCNT(Cfunction),47
Py_mod_create(Cmacro),203 Py_RELATIVE_OFFSET(Cmacro),307
Py_mod_exec(Cmacro),204 PY_RELEASE_LEVEL(Cmacro),355
Py_mod_gil(Cmacro),204 PY_RELEASE_SERIAL(Cmacro),355
Py_MOD_GIL_NOT_USED(Cmacro),204 Py_ReprEnter(Cfunction),63
Py_MOD_GIL_USED(Cmacro),204 Py_ReprLeave(Cfunction),63
Py_mod_multiple_interpreters(Cmacro),204 Py_RETURN_FALSE(Cmacro),150
Py_MOD_MULTIPLE_INTERPRETERS_NOT_SUPPORTED Py_RETURN_NONE(Cmacro),140
(Cmacro),204 Py_RETURN_NOTIMPLEMENTED(Cmacro),104
Py_MOD_MULTIPLE_INTERPRETERS_SUPPORTED (C Py_RETURN_RICHCOMPARE(Cmacro),332
macro),204 Py_RETURN_TRUE(Cmacro),150
Py_MOD_PER_INTERPRETER_GIL_SUPPORTED (C Py_RunMain(Cfunction),231
macro),204 Py_SET_REFCNT(Cfunction),47
PY_MONITORING_EVENT_BRANCH_LEFT (C macro), Py_SET_SIZE(Cfunction),303
361 Py_SET_TYPE(Cfunction),303
PY_MONITORING_EVENT_BRANCH_RIGHT (C macro), Py_SetProgramName(Cfunction),232
361 Py_SetPythonHome(Cfunction),235
PY_MONITORING_EVENT_C_RAISE(Cmacro),361 Py_SETREF(Cmacro),49
PY_MONITORING_EVENT_C_RETURN(Cmacro),361 Py_single_input(Cvar),46
PY_MONITORING_EVENT_CALL(Cmacro),361 Py_SIZE(Cfunction),303
PY_MONITORING_EVENT_EXCEPTION_HANDLED (C Py_ssize_t(Ctype),9
macro),361 PY_SSIZE_T_MAX(Cmacro),143
PY_MONITORING_EVENT_INSTRUCTION (C macro), Py_STRINGIFY(Cmacro),5
361 Py_T_BOOL(Cmacro),309
PY_MONITORING_EVENT_JUMP(Cmacro),361 Py_T_BYTE(Cmacro),309
PY_MONITORING_EVENT_LINE(Cmacro),361 Py_T_CHAR(Cmacro),309
PY_MONITORING_EVENT_PY_RESUME(Cmacro),361 Py_T_DOUBLE(Cmacro),309
PY_MONITORING_EVENT_PY_RETURN(Cmacro),361 Py_T_FLOAT(Cmacro),309
PY_MONITORING_EVENT_PY_START(Cmacro),361 Py_T_INT(Cmacro),309
PY_MONITORING_EVENT_PY_THROW(Cmacro),361 Py_T_LONG(Cmacro),309
PY_MONITORING_EVENT_PY_UNWIND(Cmacro),361 Py_T_LONGLONG(Cmacro),309
PY_MONITORING_EVENT_PY_YIELD(Cmacro),361 Py_T_OBJECT_EX(Cmacro),309
PY_MONITORING_EVENT_RAISE(Cmacro),361 Py_T_PYSSIZET(Cmacro),309
PY_MONITORING_EVENT_RERAISE(Cmacro),361 Py_T_SHORT(Cmacro),309
PY_MONITORING_EVENT_STOP_ITERATION (C Py_T_STRING(Cmacro),309
macro),361 Py_T_STRING_INPLACE(Cmacro),309
PY_MONITORING_IS_INSTRUMENTED_EVENT (C Py_T_UBYTE(Cmacro),309
function),362 Py_T_UINT(Cmacro),309
Py_NE(Cmacro),332 Py_T_ULONG(Cmacro),309
Py_NewInterpreter(Cfunction),245 Py_T_ULONGLONG(Cmacro),309
Py_NewInterpreterFromConfig(Cfunction),244 Py_T_USHORT(Cmacro),309
Py_NewRef(Cfunction),48 Py_tp_token(Cmacro),139
Py_NO_INLINE(Cmacro),5 Py_TP_USE_SPEC(Cmacro),140
Py_None(Cvar),140 Py_TPFLAGS_BASE_EXC_SUBCLASS(Cmacro),326
Py_NoSiteFlag(Cvar),228 Py_TPFLAGS_BASETYPE(Cmacro),324
Py_NotImplemented(Cvar),104 Py_TPFLAGS_BYTES_SUBCLASS(Cmacro),326
Py_NoUserSiteDirectory(Cvar),228 Py_TPFLAGS_DEFAULT(Cmacro),325
Py_OpenCodeHookFunction(Ctype),200 Py_TPFLAGS_DICT_SUBCLASS(Cmacro),326
412 Index

### 第421页

Py_TPFLAGS_DISALLOW_INSTANTIATION(Cmacro), Py_VaBuildValue(Cfunction),94
326 PY_VECTORCALL_ARGUMENTS_OFFSET (C macro),
Py_TPFLAGS_HAVE_FINALIZE(Cmacro),326 114
Py_TPFLAGS_HAVE_GC(Cmacro),324 Py_VerboseFlag(Cvar),229
Py_TPFLAGS_HAVE_VECTORCALL(Cmacro),326 Py_Version(Cvar),355
Py_TPFLAGS_HEAPTYPE(Cmacro),324 PY_VERSION_HEX(Cmacro),355
Py_TPFLAGS_IMMUTABLETYPE(Cmacro),326 Py_VISIT(Cmacro),353
Py_TPFLAGS_ITEMS_AT_END(Cmacro),325 Py_XDECREF(Cfunction),11,48
Py_TPFLAGS_LIST_SUBCLASS(Cmacro),326 Py_XINCREF(Cfunction),47
Py_TPFLAGS_LONG_SUBCLASS(Cmacro),326 Py_XNewRef(Cfunction),48
Py_TPFLAGS_MANAGED_DICT(Cmacro),325 Py_XSETREF(Cmacro),49
Py_TPFLAGS_MANAGED_WEAKREF(Cmacro),325 PyAIter_Check(Cfunction),124
Py_TPFLAGS_MAPPING(Cmacro),327 PyAnySet_Check(Cfunction),189
Py_TPFLAGS_METHOD_DESCRIPTOR(Cmacro),325 PyAnySet_CheckExact(Cfunction),189
Py_TPFLAGS_READY(Cmacro),324 PyArg_Parse(Cfunction),90
Py_TPFLAGS_READYING(Cmacro),324 PyArg_ParseTuple(Cfunction),90
Py_TPFLAGS_SEQUENCE(Cmacro),327 PyArg_ParseTupleAndKeywords(Cfunction),90
Py_TPFLAGS_TUPLE_SUBCLASS(Cmacro),326 PyArg_UnpackTuple(Cfunction),91
Py_TPFLAGS_TYPE_SUBCLASS(Cmacro),326 PyArg_ValidateKeywordArguments (C function),
Py_TPFLAGS_UNICODE_SUBCLASS(Cmacro),326 90
Py_TPFLAGS_VALID_VERSION_TAG(Cmacro),327 PyArg_VaParse(Cfunction),90
Py_tracefunc(Ctype),247 PyArg_VaParseTupleAndKeywords(Cfunction),90
Py_True(Cvar),150 PyASCIIObject(Ctype),158
Py_tss_NEEDS_INIT(Cmacro),250 PyAsyncMethods(Ctype),346
Py_tss_t(Ctype),250 PyAsyncMethods.am_aiter(Cmember),346
Py_TYPE(Cfunction),302 PyAsyncMethods.am_anext(Cmember),346
Py_UCS1(Ctype),157 PyAsyncMethods.am_await(Cmember),346
Py_UCS2(Ctype),157 PyAsyncMethods.am_send(Cmember),346
Py_UCS4(Ctype),157 PyBaseObject_Type(Cvar),302
Py_uhash_t(Ctype),96 PyBool_Check(Cfunction),150
Py_UNBLOCK_THREADS(Cmacro),240 PyBool_FromLong(Cfunction),150
Py_UnbufferedStdioFlag(Cvar),229 PyBool_Type(Cvar),150
Py_UNICODE(Ctype),178 PyBUF_ANY_CONTIGUOUS(Cmacro),128
Py_UNICODE_IS_HIGH_SURROGATE(Cfunction),160 PyBUF_C_CONTIGUOUS(Cmacro),128
Py_UNICODE_IS_LOW_SURROGATE(Cfunction),160 PyBUF_CONTIG(Cmacro),129
Py_UNICODE_IS_SURROGATE(Cfunction),160 PyBUF_CONTIG_RO(Cmacro),129
Py_UNICODE_ISALNUM(Cfunction),160 PyBUF_F_CONTIGUOUS(Cmacro),128
Py_UNICODE_ISALPHA(Cfunction),160 PyBUF_FORMAT(Cmacro),127
Py_UNICODE_ISDECIMAL(Cfunction),159 PyBUF_FULL(Cmacro),129
Py_UNICODE_ISDIGIT(Cfunction),159 PyBUF_FULL_RO(Cmacro),129
Py_UNICODE_ISLINEBREAK(Cfunction),159 PyBUF_INDIRECT(Cmacro),128
Py_UNICODE_ISLOWER(Cfunction),159 PyBUF_MAX_NDIM(Cmacro),127
Py_UNICODE_ISNUMERIC(Cfunction),160 PyBUF_ND(Cmacro),128
Py_UNICODE_ISPRINTABLE(Cfunction),160 PyBUF_READ(Cmacro),211
Py_UNICODE_ISSPACE(Cfunction),159 PyBUF_RECORDS(Cmacro),129
Py_UNICODE_ISTITLE(Cfunction),159 PyBUF_RECORDS_RO(Cmacro),129
Py_UNICODE_ISUPPER(Cfunction),159 PyBUF_SIMPLE(Cmacro),128
Py_UNICODE_JOIN_SURROGATES(Cfunction),160 PyBUF_STRIDED(Cmacro),129
Py_UNICODE_REPLACEMENT_CHARACTER (C macro), PyBUF_STRIDED_RO(Cmacro),129
169 PyBUF_STRIDES(Cmacro),128
Py_UNICODE_TODECIMAL(Cfunction),160 PyBUF_WRITABLE(Cmacro),127
Py_UNICODE_TODIGIT(Cfunction),160 PyBUF_WRITE(Cmacro),211
Py_UNICODE_TOLOWER(Cfunction),160 PyBuffer_FillContiguousStrides (C function),
Py_UNICODE_TONUMERIC(Cfunction),160 131
Py_UNICODE_TOTITLE(Cfunction),160 PyBuffer_FillInfo(Cfunction),131
Py_UNICODE_TOUPPER(Cfunction),160 PyBuffer_FromContiguous(Cfunction),131
Py_UNREACHABLE(Cmacro),5 PyBuffer_GetPointer(Cfunction),131
Py_UNUSED(Cmacro),5 PyBuffer_IsContiguous(Cfunction),131
Index 413

### 第422页

PyBuffer_Release(Cfunction),130 PyCell_New(Cfunction),194
PyBuffer_SizeFromFormat(Cfunction),131 PyCell_SET(Cfunction),194
PyBuffer_ToContiguous(Cfunction),131 PyCell_Set(Cfunction),194
PyBufferProcs(Ctype),125,345 PyCell_Type(Cvar),194
PyBufferProcs.bf_getbuffer(Cmember),345 PyCellObject(Ctype),193
PyBufferProcs.bf_releasebuffer (C member), PyCF_ALLOW_TOP_LEVEL_AWAIT(Cmacro),46
345 PyCF_ONLY_AST(Cmacro),46
PyByteArray_AS_STRING(Cfunction),157 PyCF_OPTIMIZED_AST(Cmacro),46
PyByteArray_AsString(Cfunction),157 PyCF_TYPE_COMMENTS(Cmacro),46
PyByteArray_Check(Cfunction),156 PyCFunction(Ctype),303
PyByteArray_CheckExact(Cfunction),156 PyCFunction_New(Cfunction),306
PyByteArray_Concat(Cfunction),156 PyCFunction_NewEx(Cfunction),306
PyByteArray_FromObject(Cfunction),156 PyCFunctionFast(Ctype),303
PyByteArray_FromStringAndSize (C function), PyCFunctionFastWithKeywords(Ctype),304
156 PyCFunctionWithKeywords(Ctype),303
PyByteArray_GET_SIZE(Cfunction),157 PyCMethod(Ctype),304
PyByteArray_Resize(Cfunction),157 PyCMethod_New(Cfunction),306
PyByteArray_Size(Cfunction),157 PyCode_Addr2Line(Cfunction),195
PyByteArray_Type(Cvar),156 PyCode_Addr2Location(Cfunction),195
PyByteArrayObject(Ctype),156 PyCode_AddWatcher(Cfunction),196
PyBytes_AS_STRING(Cfunction),155 PyCode_Check(Cfunction),194
PyBytes_AsString(Cfunction),155 PyCode_ClearWatcher(Cfunction),196
PyBytes_AsStringAndSize(Cfunction),155 PyCode_GetCellvars(Cfunction),196
PyBytes_Check(Cfunction),154 PyCode_GetCode(Cfunction),196
PyBytes_CheckExact(Cfunction),154 PyCode_GetFreevars(Cfunction),196
PyBytes_Concat(Cfunction),155 PyCode_GetNumFree(Cfunction),194
PyBytes_ConcatAndDel(Cfunction),156 PyCode_GetVarnames(Cfunction),196
PyBytes_FromFormat(Cfunction),154 PyCode_New(Cfunction),195
PyBytes_FromFormatV(Cfunction),155 PyCode_NewEmpty(Cfunction),195
PyBytes_FromObject(Cfunction),155 PyCode_NewWithPosOnlyArgs(Cfunction),195
PyBytes_FromString(Cfunction),154 PyCode_Type(Cvar),194
PyBytes_FromStringAndSize(Cfunction),154 PyCode_WatchCallback(Ctype),196
PyBytes_GET_SIZE(Cfunction),155 PyCodec_BackslashReplaceErrors (C function),
PyBytes_Join(Cfunction),156 100
PyBytes_Size(Cfunction),155 PyCodec_Decode(Cfunction),98
PyBytes_Type(Cvar),154 PyCodec_Decoder(Cfunction),99
PyBytesObject(Ctype),154 PyCodec_Encode(Cfunction),98
PyCallable_Check(Cfunction),117 PyCodec_Encoder(Cfunction),99
PyCallIter_Check(Cfunction),209 PyCodec_IgnoreErrors(Cfunction),99
PyCallIter_New(Cfunction),209 PyCodec_IncrementalDecoder(Cfunction),99
PyCallIter_Type(Cvar),209 PyCodec_IncrementalEncoder(Cfunction),99
PyCapsule(Ctype),213 PyCodec_KnownEncoding(Cfunction),98
PyCapsule_CheckExact(Cfunction),214 PyCodec_LookupError(Cfunction),99
PyCapsule_Destructor(Ctype),213 PyCodec_NameReplaceErrors(Cfunction),100
PyCapsule_GetContext(Cfunction),214 PyCodec_Register(Cfunction),98
PyCapsule_GetDestructor(Cfunction),214 PyCodec_RegisterError(Cfunction),99
PyCapsule_GetName(Cfunction),214 PyCodec_ReplaceErrors(Cfunction),99
PyCapsule_GetPointer(Cfunction),214 PyCodec_StreamReader(Cfunction),99
PyCapsule_Import(Cfunction),214 PyCodec_StreamWriter(Cfunction),99
PyCapsule_IsValid(Cfunction),215 PyCodec_StrictErrors(Cfunction),99
PyCapsule_New(Cfunction),214 PyCodec_Unregister(Cfunction),98
PyCapsule_SetContext(Cfunction),215 PyCodec_XMLCharRefReplaceErrors (C function),
PyCapsule_SetDestructor(Cfunction),215 100
PyCapsule_SetName(Cfunction),215 PyCodeEvent(Ctype),196
PyCapsule_SetPointer(Cfunction),215 PyCodeObject(Ctype),194
PyCell_Check(Cfunction),194 PyCompactUnicodeObject(Ctype),158
PyCell_GET(Cfunction),194 PyCompilerFlags(Cstruct),46
PyCell_Get(Cfunction),194
414 Index

### 第423页

PyCompilerFlags.cf_feature_version (C mem- PyConfig.module_search_paths(Cmember),272
ber),46 PyConfig.module_search_paths_set (C mem-
PyCompilerFlags.cf_flags(Cmember),46 ber),272
PyComplex_AsCComplex(Cfunction),154 PyConfig.optimization_level(Cmember),273
PyComplex_Check(Cfunction),153 PyConfig.orig_argv(Cmember),273
PyComplex_CheckExact(Cfunction),153 PyConfig.parse_argv(Cmember),273
PyComplex_FromCComplex(Cfunction),153 PyConfig.parser_debug(Cmember),273
PyComplex_FromDoubles(Cfunction),153 PyConfig.pathconfig_warnings(Cmember),273
PyComplex_ImagAsDouble(Cfunction),153 PyConfig.perf_profiling(Cmember),276
PyComplex_RealAsDouble(Cfunction),153 PyConfig.platlibdir(Cmember),272
PyComplex_Type(Cvar),153 PyConfig.prefix(Cmember),273
PyComplexObject(Ctype),153 PyConfig.program_name(Cmember),274
PyConfig(Ctype),266 PyConfig.pycache_prefix(Cmember),274
PyConfig_Clear(Cfunction),267 PyConfig.pythonpath_env(Cmember),272
PyConfig_Get(Cfunction),259 PyConfig.quiet(Cmember),274
PyConfig_GetInt(Cfunction),260 PyConfig.run_command(Cmember),274
PyConfig_InitIsolatedConfig(Cfunction),266 PyConfig.run_filename(Cmember),274
PyConfig_InitPythonConfig(Cfunction),266 PyConfig.run_module(Cmember),274
PyConfig_Names(Cfunction),260 PyConfig.run_presite(Cmember),274
PyConfig._pystats(Cmember),277 PyConfig.safe_path(Cmember),267
PyConfig_Read(Cfunction),266 PyConfig.show_ref_count(Cmember),275
PyConfig_Set(Cfunction),260 PyConfig.site_import(Cmember),275
PyConfig_SetArgv(Cfunction),266 PyConfig.skip_source_first_line (C member),
PyConfig_SetBytesArgv(Cfunction),266 275
PyConfig_SetBytesString(Cfunction),266 PyConfig.stdio_encoding(Cmember),275
PyConfig_SetString(Cfunction),266 PyConfig.stdio_errors(Cmember),275
PyConfig_SetWideStringList(Cfunction),266 PyConfig.stdlib_dir(Cmember),276
PyConfig.argv(Cmember),267 PyConfig.tracemalloc(Cmember),275
PyConfig.base_exec_prefix(Cmember),268 PyConfig.use_environment(Cmember),276
PyConfig.base_executable(Cmember),268 PyConfig.use_frozen_modules(Cmember),270
PyConfig.base_prefix(Cmember),268 PyConfig.use_hash_seed(Cmember),270
PyConfig.buffered_stdio(Cmember),268 PyConfig.use_system_logger(Cmember),276
PyConfig.bytes_warning(Cmember),268 PyConfig.user_site_directory(Cmember),276
PyConfig.check_hash_pycs_mode (C member), PyConfig.verbose(Cmember),276
268 PyConfig.warn_default_encoding (C member),
PyConfig.code_debug_ranges(Cmember),268 268
PyConfig.configure_c_stdio(Cmember),269 PyConfig.warnoptions(Cmember),277
PyConfig.cpu_count(Cmember),271 PyConfig.write_bytecode(Cmember),277
PyConfig.dev_mode(Cmember),269 PyConfig.xoptions(Cmember),277
PyConfig.dump_refs(Cmember),269 PyContext(Ctype),218
PyConfig.dump_refs_file(Cmember),269 PyContext_AddWatcher(Cfunction),219
PyConfig.exec_prefix(Cmember),269 PyContext_CheckExact(Cfunction),219
PyConfig.executable(Cmember),269 PyContext_ClearWatcher(Cfunction),219
PyConfig.faulthandler(Cmember),270 PyContext_Copy(Cfunction),219
PyConfig.filesystem_encoding(Cmember),270 PyContext_CopyCurrent(Cfunction),219
PyConfig.filesystem_errors(Cmember),270 PyContext_Enter(Cfunction),219
PyConfig.hash_seed(Cmember),270 PyContext_Exit(Cfunction),219
PyConfig.home(Cmember),270 PyContext_New(Cfunction),219
PyConfig.import_time(Cmember),271 PyContext_Type(Cvar),219
PyConfig.inspect(Cmember),271 PyContext_WatchCallback(Ctype),220
PyConfig.install_signal_handlers (C mem- PyContextEvent(Ctype),219
ber),271 PyContextToken(Ctype),219
PyConfig.int_max_str_digits(Cmember),271 PyContextToken_CheckExact(Cfunction),219
PyConfig.interactive(Cmember),271 PyContextToken_Type(Cvar),219
PyConfig.isolated(Cmember),272 PyContextVar(Ctype),219
PyConfig.legacy_windows_stdio (C member), PyContextVar_CheckExact(Cfunction),219
272 PyContextVar_Get(Cfunction),220
PyConfig.malloc_stats(Cmember),272 PyContextVar_New(Cfunction),220
Index 415

### 第424页

PyContextVar_Reset(Cfunction),220 PyDict_Check(Cfunction),184
PyContextVar_Set(Cfunction),220 PyDict_CheckExact(Cfunction),184
PyContextVar_Type(Cvar),219 PyDict_Clear(Cfunction),184
PyCoro_CheckExact(Cfunction),218 PyDict_ClearWatcher(Cfunction),188
PyCoro_New(Cfunction),218 PyDict_Contains(Cfunction),184
PyCoro_Type(Cvar),218 PyDict_ContainsString(Cfunction),184
PyCoroObject(Ctype),218 PyDict_Copy(Cfunction),184
PyDate_Check(Cfunction),221 PyDict_DelItem(Cfunction),184
PyDate_CheckExact(Cfunction),221 PyDict_DelItemString(Cfunction),184
PyDate_FromDate(Cfunction),222 PyDict_GetItem(Cfunction),185
PyDate_FromTimestamp(Cfunction),224 PyDict_GetItemRef(Cfunction),184
PyDateTime_Check(Cfunction),221 PyDict_GetItemString(Cfunction),185
PyDateTime_CheckExact(Cfunction),221 PyDict_GetItemStringRef(Cfunction),185
PyDateTime_Date(Ctype),220 PyDict_GetItemWithError(Cfunction),185
PyDateTime_DATE_GET_FOLD(Cfunction),223 PyDict_Items(Cfunction),186
PyDateTime_DATE_GET_HOUR(Cfunction),222 PyDict_Keys(Cfunction),186
PyDateTime_DATE_GET_MICROSECOND (C function), PyDict_Merge(Cfunction),187
223 PyDict_MergeFromSeq2(Cfunction),187
PyDateTime_DATE_GET_MINUTE(Cfunction),223 PyDict_New(Cfunction),184
PyDateTime_DATE_GET_SECOND(Cfunction),223 PyDict_Next(Cfunction),186
PyDateTime_DATE_GET_TZINFO(Cfunction),223 PyDict_Pop(Cfunction),186
PyDateTime_DateTime(Ctype),220 PyDict_PopString(Cfunction),186
PyDateTime_DateTimeType(Cvar),221 PyDict_SetDefault(Cfunction),185
PyDateTime_DateType(Cvar),221 PyDict_SetDefaultRef(Cfunction),185
PyDateTime_Delta(Ctype),221 PyDict_SetItem(Cfunction),184
PyDateTime_DELTA_GET_DAYS(Cfunction),223 PyDict_SetItemString(Cfunction),184
PyDateTime_DELTA_GET_MICROSECONDS (C func- PyDict_Size(Cfunction),186
tion),223 PyDict_Type(Cvar),184
PyDateTime_DELTA_GET_SECONDS(Cfunction),223 PyDict_Unwatch(Cfunction),188
PyDateTime_DeltaType(Cvar),221 PyDict_Update(Cfunction),187
PyDateTime_FromDateAndTime(Cfunction),222 PyDict_Values(Cfunction),186
PyDateTime_FromDateAndTimeAndFold (C func- PyDict_Watch(Cfunction),188
tion),222 PyDict_WatchCallback(Ctype),188
PyDateTime_FromTimestamp(Cfunction),223 PyDict_WatchEvent(Ctype),188
PyDateTime_GET_DAY(Cfunction),222 PyDictObject(Ctype),184
PyDateTime_GET_MONTH(Cfunction),222 PyDictProxy_New(Cfunction),184
PyDateTime_GET_YEAR(Cfunction),222 PyDoc_STR(Cmacro),6
PyDateTime_Time(Ctype),220 PyDoc_STRVAR(Cmacro),6
PyDateTime_TIME_GET_FOLD(Cfunction),223 PyEllipsis_Type(Cvar),211
PyDateTime_TIME_GET_HOUR(Cfunction),223 PyErr_BadArgument(Cfunction),52
PyDateTime_TIME_GET_MICROSECOND (C function), PyErr_BadInternalCall(Cfunction),54
223 PyErr_CheckSignals(Cfunction),58
PyDateTime_TIME_GET_MINUTE(Cfunction),223 PyErr_Clear(Cfunction),10,11,51
PyDateTime_TIME_GET_SECOND(Cfunction),223 PyErr_DisplayException(Cfunction),52
PyDateTime_TIME_GET_TZINFO(Cfunction),223 PyErr_ExceptionMatches(Cfunction),11,55
PyDateTime_TimeType(Cvar),221 PyErr_Fetch(Cfunction),56
PyDateTime_TimeZone_UTC(Cvar),221 PyErr_Format(Cfunction),52
PyDateTime_TZInfoType(Cvar),221 PyErr_FormatUnraisable(Cfunction),52
PyDelta_Check(Cfunction),221 PyErr_FormatV(Cfunction),52
PyDelta_CheckExact(Cfunction),221 PyErr_GetExcInfo(Cfunction),58
PyDelta_FromDSU(Cfunction),222 PyErr_GetHandledException(Cfunction),57
PyDescr_IsData(Cfunction),209 PyErr_GetRaisedException(Cfunction),56
PyDescr_NewClassMethod(Cfunction),209 PyErr_GivenExceptionMatches(Cfunction),56
PyDescr_NewGetSet(Cfunction),209 PyErr_NewException(Cfunction),60
PyDescr_NewMember(Cfunction),209 PyErr_NewExceptionWithDoc(Cfunction),60
PyDescr_NewMethod(Cfunction),209 PyErr_NoMemory(Cfunction),53
PyDescr_NewWrapper(Cfunction),209 PyErr_NormalizeException(Cfunction),57
PyDict_AddWatcher(Cfunction),187 PyErr_Occurred(Cfunction),10,55
416 Index

### 第425页

PyErr_Print(Cfunction),51 PyEval_ReleaseThread(),238
PyErr_PrintEx(Cfunction),51 PyEval_RestoreThread(Cfunction),236,238
PyErr_ResourceWarning(Cfunction),55 PyEval_RestoreThread(),238
PyErr_Restore(Cfunction),57 PyEval_SaveThread(Cfunction),236,238
PyErr_SetExcFromWindowsErr(Cfunction),53 PyEval_SaveThread(),238
PyErr_SetExcFromWindowsErrWithFilename (C PyEval_SetProfile(Cfunction),248
function),54 PyEval_SetProfileAllThreads(Cfunction),248
PyErr_SetExcFromWindowsErrWithFilenameObjecPtyEval_SetTrace(Cfunction),248
(Cfunction),53 PyEval_SetTraceAllThreads(Cfunction),248
PyErr_SetExcFromWindowsErrWithFilenameObjecPtysExc_ArithmeticError(Cvar),63
(Cfunction),54 PyExc_AssertionError(Cvar),63
PyErr_SetExcInfo(Cfunction),58 PyExc_AttributeError(Cvar),63
PyErr_SetFromErrno(Cfunction),53 PyExc_BaseException(Cvar),63
PyErr_SetFromErrnoWithFilename (C function), PyExc_BaseExceptionGroup(Cvar),63
53 PyExc_BlockingIOError(Cvar),63
PyErr_SetFromErrnoWithFilenameObject (C PyExc_BrokenPipeError(Cvar),64
function),53 PyExc_BufferError(Cvar),64
PyErr_SetFromErrnoWithFilenameObjects (C PyExc_BytesWarning(Cvar),69
function),53 PyExc_ChildProcessError(Cvar),64
PyErr_SetFromWindowsErr(Cfunction),53 PyExc_ConnectionAbortedError(Cvar),64
PyErr_SetFromWindowsErrWithFilename (C PyExc_ConnectionError(Cvar),64
function),53 PyExc_ConnectionRefusedError(Cvar),64
PyErr_SetHandledException(Cfunction),57 PyExc_ConnectionResetError(Cvar),64
PyErr_SetImportError(Cfunction),54 PyExc_DeprecationWarning(Cvar),69
PyErr_SetImportErrorSubclass(Cfunction),54 PyExc_EncodingWarning(Cvar),69
PyErr_SetInterrupt(Cfunction),59 PyExc_EnvironmentError(Cvar),68
PyErr_SetInterruptEx(Cfunction),59 PyExc_EOFError(Cvar),64
PyErr_SetNone(Cfunction),52 PyExc_Exception(Cvar),63
PyErr_SetObject(Cfunction),52 PyExc_FileExistsError(Cvar),64
PyErr_SetRaisedException(Cfunction),56 PyExc_FileNotFoundError(Cvar),64
PyErr_SetString(Cfunction),10,52 PyExc_FloatingPointError(Cvar),64
PyErr_SyntaxLocation(Cfunction),54 PyExc_FutureWarning(Cvar),69
PyErr_SyntaxLocationEx(Cfunction),54 PyExc_GeneratorExit(Cvar),64
PyErr_SyntaxLocationObject(Cfunction),54 PyExc_ImportError(Cvar),64
PyErr_WarnEx(Cfunction),55 PyExc_ImportWarning(Cvar),69
PyErr_WarnExplicit(Cfunction),55 PyExc_IndentationError(Cvar),65
PyErr_WarnExplicitObject(Cfunction),55 PyExc_IndexError(Cvar),65
PyErr_WarnFormat(Cfunction),55 PyExc_InterruptedError(Cvar),65
PyErr_WriteUnraisable(Cfunction),51 PyExc_IOError(Cvar),68
PyEval_AcquireThread(Cfunction),243 PyExc_IsADirectoryError(Cvar),65
PyEval_AcquireThread(),238 PyExc_KeyboardInterrupt(Cvar),65
PyEval_EvalCode(Cfunction),45 PyExc_KeyError(Cvar),65
PyEval_EvalCodeEx(Cfunction),45 PyExc_LookupError(Cvar),65
PyEval_EvalFrame(Cfunction),46 PyExc_MemoryError(Cvar),65
PyEval_EvalFrameEx(Cfunction),46 PyExc_ModuleNotFoundError(Cvar),65
PyEval_GetBuiltins(Cfunction),97 PyExc_NameError(Cvar),65
PyEval_GetFrame(Cfunction),97 PyExc_NotADirectoryError(Cvar),65
PyEval_GetFrameBuiltins(Cfunction),98 PyExc_NotImplementedError(Cvar),65
PyEval_GetFrameGlobals(Cfunction),98 PyExc_OSError(Cvar),65
PyEval_GetFrameLocals(Cfunction),98 PyExc_OverflowError(Cvar),66
PyEval_GetFuncDesc(Cfunction),98 PyExc_PendingDeprecationWarning(Cvar),69
PyEval_GetFuncName(Cfunction),98 PyExc_PermissionError(Cvar),66
PyEval_GetGlobals(Cfunction),97 PyExc_ProcessLookupError(Cvar),66
PyEval_GetLocals(Cfunction),97 PyExc_PythonFinalizationError(Cvar),66
PyEval_InitThreads(Cfunction),238 PyExc_RecursionError(Cvar),66
PyEval_InitThreads(),229 PyExc_ReferenceError(Cvar),66
PyEval_MergeCompilerFlags(Cfunction),46 PyExc_ResourceWarning(Cvar),69
PyEval_ReleaseThread(Cfunction),243 PyExc_RuntimeError(Cvar),66
Index 417

### 第426页

PyExc_RuntimeWarning(Cvar),69 PyFrame_GetGlobals(Cfunction),216
PyExc_StopAsyncIteration(Cvar),66 PyFrame_GetLasti(Cfunction),216
PyExc_StopIteration(Cvar),66 PyFrame_GetLineNumber(Cfunction),216
PyExc_SyntaxError(Cvar),66 PyFrame_GetLocals(Cfunction),216
PyExc_SyntaxWarning(Cvar),69 PyFrame_GetVar(Cfunction),216
PyExc_SystemError(Cvar),66 PyFrame_GetVarString(Cfunction),216
PyExc_SystemExit(Cvar),66 PyFrame_Type(Cvar),215
PyExc_TabError(Cvar),66 PyFrameLocalsProxy_Check(Cfunction),217
PyExc_TimeoutError(Cvar),66 PyFrameLocalsProxy_Type(Cvar),217
PyExc_TypeError(Cvar),67 PyFrameObject(Ctype),215
PyExc_UnboundLocalError(Cvar),67 PyFrozenSet_Check(Cfunction),189
PyExc_UnicodeDecodeError(Cvar),67 PyFrozenSet_CheckExact(Cfunction),189
PyExc_UnicodeEncodeError(Cvar),67 PyFrozenSet_New(Cfunction),189
PyExc_UnicodeError(Cvar),67 PyFrozenSet_Type(Cvar),189
PyExc_UnicodeTranslateError(Cvar),67 PyFunction_AddWatcher(Cfunction),192
PyExc_UnicodeWarning(Cvar),69 PyFunction_Check(Cfunction),190
PyExc_UserWarning(Cvar),69 PyFunction_ClearWatcher(Cfunction),192
PyExc_ValueError(Cvar),67 PyFunction_GET_ANNOTATIONS(Cfunction),191
PyExc_Warning(Cvar),69 PyFunction_GET_CLOSURE(Cfunction),191
PyExc_WindowsError(Cvar),68 PyFunction_GET_CODE(Cfunction),191
PyExc_ZeroDivisionError(Cvar),67 PyFunction_GET_DEFAULTS(Cfunction),191
PyException_GetArgs(Cfunction),60 PyFunction_GET_GLOBALS(Cfunction),191
PyException_GetCause(Cfunction),60 PyFunction_GET_KW_DEFAULTS(Cfunction),191
PyException_GetContext(Cfunction),60 PyFunction_GET_MODULE(Cfunction),191
PyException_GetTraceback(Cfunction),60 PyFunction_GetAnnotations(Cfunction),191
PyException_SetArgs(Cfunction),60 PyFunction_GetClosure(Cfunction),191
PyException_SetCause(Cfunction),60 PyFunction_GetCode(Cfunction),191
PyException_SetContext(Cfunction),60 PyFunction_GetDefaults(Cfunction),191
PyException_SetTraceback(Cfunction),60 PyFunction_GetGlobals(Cfunction),191
PyExceptionClass_Check(Cfunction),60 PyFunction_GetKwDefaults(Cfunction),191
PyExceptionClass_Name(Cfunction),60 PyFunction_GetModule(Cfunction),191
PyFile_FromFd(Cfunction),200 PyFunction_New(Cfunction),190
PyFile_GetLine(Cfunction),200 PyFunction_NewWithQualName(Cfunction),190
PyFile_SetOpenCodeHook(Cfunction),200 PyFunction_SetAnnotations(Cfunction),191
PyFile_WriteObject(Cfunction),200 PyFunction_SetClosure(Cfunction),191
PyFile_WriteString(Cfunction),201 PyFunction_SetDefaults(Cfunction),191
PyFloat_AS_DOUBLE(Cfunction),151 PyFunction_SetVectorcall(Cfunction),191
PyFloat_AsDouble(Cfunction),151 PyFunction_Type(Cvar),190
PyFloat_Check(Cfunction),150 PyFunction_WatchCallback(Ctype),192
PyFloat_CheckExact(Cfunction),150 PyFunction_WatchEvent(Ctype),192
PyFloat_FromDouble(Cfunction),151 PyFunctionObject(Ctype),190
PyFloat_FromString(Cfunction),151 PyGC_Collect(Cfunction),354
PyFloat_GetInfo(Cfunction),151 PyGC_Disable(Cfunction),354
PyFloat_GetMax(Cfunction),151 PyGC_Enable(Cfunction),354
PyFloat_GetMin(Cfunction),151 PyGC_IsEnabled(Cfunction),354
PyFloat_Pack2(Cfunction),152 PyGen_Check(Cfunction),218
PyFloat_Pack4(Cfunction),152 PyGen_CheckExact(Cfunction),218
PyFloat_Pack8(Cfunction),152 PyGen_New(Cfunction),218
PyFloat_Type(Cvar),150 PyGen_NewWithQualName(Cfunction),218
PyFloat_Unpack2(Cfunction),152 PyGen_Type(Cvar),218
PyFloat_Unpack4(Cfunction),152 PyGenObject(Ctype),217
PyFloat_Unpack8(Cfunction),152 PyGetSetDef(Ctype),310
PyFloatObject(Ctype),150 PyGetSetDef.closure(Cmember),310
PyFrame_Check(Cfunction),215 PyGetSetDef.doc(Cmember),310
PyFrame_GetBack(Cfunction),215 PyGetSetDef.get(Cmember),310
PyFrame_GetBuiltins(Cfunction),215 PyGetSetDef.name(Cmember),310
PyFrame_GetCode(Cfunction),216 PyGetSetDef.set(Cmember),310
PyFrame_GetGenerator(Cfunction),216 PyGILState_Check(Cfunction),240
418 Index

### 第427页

PyGILState_Ensure(Cfunction),239 PyInitConfig_SetInt(Cfunction),257
PyGILState_GetThisThreadState (C function), PyInitConfig_SetStr(Cfunction),257
240 PyInitConfig_SetStrList(Cfunction),257
PyGILState_Release(Cfunction),240 PyInstanceMethod_Check(Cfunction),193
PyHASH_BITS(Cmacro),96 PyInstanceMethod_Function(Cfunction),193
PyHash_FuncDef(Ctype),96 PyInstanceMethod_GET_FUNCTION (C function),
PyHash_FuncDef.hash(Cmember),96 193
PyHash_FuncDef.hash_bits(Cmember),96 PyInstanceMethod_New(Cfunction),193
PyHash_FuncDef.name(Cmember),96 PyInstanceMethod_Type(Cvar),193
PyHash_FuncDef.seed_bits(Cmember),96 PyInterpreterConfig(Ctype),243
PyHash_GetFuncDef(Cfunction),96 PyInterpreterConfig_DEFAULT_GIL (C macro),
PyHASH_IMAG(Cmacro),96 244
PyHASH_INF(Cmacro),96 PyInterpreterConfig_OWN_GIL(Cmacro),244
PyHASH_MODULUS(Cmacro),96 PyInterpreterConfig_SHARED_GIL (C macro),
PyHASH_MULTIPLIER(Cmacro),96 244
PyImport_AddModule(Cfunction),81 PyInterpreterConfig.allow_daemon_threads
PyImport_AddModuleObject(Cfunction),81 (Cmember),244
PyImport_AddModuleRef(Cfunction),81 PyInterpreterConfig.allow_exec (C member),
PyImport_AppendInittab(Cfunction),83 244
PyImport_ExecCodeModule(Cfunction),81 PyInterpreterConfig.allow_fork (C member),
PyImport_ExecCodeModuleEx(Cfunction),82 244
PyImport_ExecCodeModuleObject(Cfunction),82 PyInterpreterConfig.allow_threads (C mem-
PyImport_ExecCodeModuleWithPathnames (C ber),244
function),82 PyInterpreterConfig.check_multi_interp_extensi
PyImport_ExtendInittab(Cfunction),84 (Cmember),244
PyImport_FrozenModules(Cvar),83 PyInterpreterConfig.gil(Cmember),244
PyImport_GetImporter(Cfunction),83 PyInterpreterConfig.use_main_obmalloc (C
PyImport_GetMagicNumber(Cfunction),82 member),244
PyImport_GetMagicTag(Cfunction),82 PyInterpreterState(Ctype),238
PyImport_GetModule(Cfunction),83 PyInterpreterState_Clear(Cfunction),241
PyImport_GetModuleDict(Cfunction),83 PyInterpreterState_Delete(Cfunction),241
PyImport_Import(Cfunction),81 PyInterpreterState_Get(Cfunction),242
PyImport_ImportFrozenModule(Cfunction),83 PyInterpreterState_GetDict(Cfunction),242
PyImport_ImportFrozenModuleObject (C func- PyInterpreterState_GetID(Cfunction),242
tion),83 PyInterpreterState_Head(Cfunction),249
PyImport_ImportModule(Cfunction),80 PyInterpreterState_Main(Cfunction),249
PyImport_ImportModuleAttr(Cfunction),84 PyInterpreterState_New(Cfunction),241
PyImport_ImportModuleAttrString (C function), PyInterpreterState_Next(Cfunction),249
84 PyInterpreterState_ThreadHead (C function),
PyImport_ImportModuleEx(Cfunction),80 249
PyImport_ImportModuleLevel(Cfunction),81 PyIter_Check(Cfunction),124
PyImport_ImportModuleLevelObject (C func- PyIter_Next(Cfunction),124
tion),81 PyIter_NextItem(Cfunction),124
PyImport_ImportModuleNoBlock(Cfunction),80 PyIter_Send(Cfunction),125
PyImport_ReloadModule(Cfunction),81 PyList_Append(Cfunction),183
PyIndex_Check(Cfunction),120 PyList_AsTuple(Cfunction),183
PyInit_modulename(Cfunction),72 PyList_Check(Cfunction),182
PyInitConfig(Cstruct),256 PyList_CheckExact(Cfunction),182
PyInitConfig_AddModule(Cfunction),257 PyList_Clear(Cfunction),183
PyInitConfig_Create(Cfunction),256 PyList_Extend(Cfunction),183
PyInitConfig_Free(Cfunction),256 PyList_GET_ITEM(Cfunction),182
PyInitConfig_FreeStrList(Cfunction),257 PyList_GET_SIZE(Cfunction),182
PyInitConfig_GetError(Cfunction),256 PyList_GetItem(Cfunction),8,182
PyInitConfig_GetExitCode(Cfunction),256 PyList_GetItemRef(Cfunction),182
PyInitConfig_GetInt(Cfunction),256 PyList_GetSlice(Cfunction),183
PyInitConfig_GetStr(Cfunction),257 PyList_Insert(Cfunction),183
PyInitConfig_GetStrList(Cfunction),257 PyList_New(Cfunction),182
PyInitConfig_HasOption(Cfunction),256 PyList_Reverse(Cfunction),183
Index 419

### 第428页

PyList_SET_ITEM(Cfunction),182 PyLongExport.negative(Cmember),149
PyList_SetItem(Cfunction),7,182 PyLongExport.value(Cmember),149
PyList_SetSlice(Cfunction),183 PyLongLayout(Cstruct),148
PyList_Size(Cfunction),182 PyLongLayout.bits_per_digit(Cmember),148
PyList_Sort(Cfunction),183 PyLongLayout.digit_endianness (C member),
PyList_Type(Cvar),182 148
PyListObject(Ctype),182 PyLongLayout.digit_size(Cmember),148
PyLong_AS_LONG(Cfunction),142 PyLongLayout.digits_order(Cmember),148
PyLong_AsDouble(Cfunction),144 PyLongObject(Ctype),140
PyLong_AsInt(Cfunction),142 PyLongWriter(Cstruct),149
PyLong_AsInt32(Cfunction),144 PyLongWriter_Create(Cfunction),149
PyLong_AsInt64(Cfunction),144 PyLongWriter_Discard(Cfunction),150
PyLong_AsLong(Cfunction),142 PyLongWriter_Finish(Cfunction),150
PyLong_AsLongAndOverflow(Cfunction),142 PyMapping_Check(Cfunction),123
PyLong_AsLongLong(Cfunction),142 PyMapping_DelItem(Cfunction),123
PyLong_AsLongLongAndOverflow(Cfunction),143 PyMapping_DelItemString(Cfunction),123
PyLong_AsNativeBytes(Cfunction),144 PyMapping_GetItemString(Cfunction),123
PyLong_AsSize_t(Cfunction),143 PyMapping_GetOptionalItem(Cfunction),123
PyLong_AsSsize_t(Cfunction),143 PyMapping_GetOptionalItemString (C function),
PyLong_AsUInt32(Cfunction),144 123
PyLong_AsUInt64(Cfunction),144 PyMapping_HasKey(Cfunction),123
PyLong_AsUnsignedLong(Cfunction),143 PyMapping_HasKeyString(Cfunction),124
PyLong_AsUnsignedLongLong(Cfunction),143 PyMapping_HasKeyStringWithError (C function),
PyLong_AsUnsignedLongLongMask (C function), 123
143 PyMapping_HasKeyWithError(Cfunction),123
PyLong_AsUnsignedLongMask(Cfunction),143 PyMapping_Items(Cfunction),124
PyLong_AsVoidPtr(Cfunction),144 PyMapping_Keys(Cfunction),124
PyLong_Check(Cfunction),140 PyMapping_Length(Cfunction),123
PyLong_CheckExact(Cfunction),140 PyMapping_SetItemString(Cfunction),123
PyLong_Export(Cfunction),149 PyMapping_Size(Cfunction),123
PyLong_FreeExport(Cfunction),149 PyMapping_Values(Cfunction),124
PyLong_FromDouble(Cfunction),141 PyMappingMethods(Ctype),343
PyLong_FromInt32(Cfunction),141 PyMappingMethods.mp_ass_subscript (C mem-
PyLong_FromInt64(Cfunction),141 ber),344
PyLong_FromLong(Cfunction),140 PyMappingMethods.mp_length(Cmember),343
PyLong_FromLongLong(Cfunction),141 PyMappingMethods.mp_subscript (C member),
PyLong_FromNativeBytes(Cfunction),142 343
PyLong_FromSize_t(Cfunction),141 PyMarshal_ReadLastObjectFromFile (C func-
PyLong_FromSsize_t(Cfunction),141 tion),85
PyLong_FromString(Cfunction),141 PyMarshal_ReadLongFromFile(Cfunction),84
PyLong_FromUInt32(Cfunction),141 PyMarshal_ReadObjectFromFile(Cfunction),85
PyLong_FromUInt64(Cfunction),141 PyMarshal_ReadObjectFromString (C function),
PyLong_FromUnicodeObject(Cfunction),141 85
PyLong_FromUnsignedLong(Cfunction),141 PyMarshal_ReadShortFromFile(Cfunction),85
PyLong_FromUnsignedLongLong(Cfunction),141 PyMarshal_WriteLongToFile(Cfunction),84
PyLong_FromUnsignedNativeBytes (C function), PyMarshal_WriteObjectToFile(Cfunction),84
142 PyMarshal_WriteObjectToString(Cfunction),84
PyLong_FromVoidPtr(Cfunction),141 PyMem_Calloc(Cfunction),285
PyLong_GetInfo(Cfunction),147 PyMem_Del(Cfunction),286
PyLong_GetNativeLayout(Cfunction),148 PYMEM_DOMAIN_MEM(Cmacro),289
PyLong_GetSign(Cfunction),147 PYMEM_DOMAIN_OBJ(Cmacro),289
PyLong_IsNegative(Cfunction),147 PYMEM_DOMAIN_RAW(Cmacro),288
PyLong_IsPositive(Cfunction),147 PyMem_Free(Cfunction),286
PyLong_IsZero(Cfunction),147 PyMem_GetAllocator(Cfunction),289
PyLong_Type(Cvar),140 PyMem_Malloc(Cfunction),285
PyLongExport(Cstruct),148 PyMem_New(Cmacro),286
PyLongExport.digits(Cmember),149 PyMem_RawCalloc(Cfunction),284
PyLongExport.ndigits(Cmember),149 PyMem_RawFree(Cfunction),285
420 Index

### 第429页

PyMem_RawMalloc(Cfunction),284 PyModule_GetState(Cfunction),201
PyMem_RawRealloc(Cfunction),285 PyModule_New(Cfunction),201
PyMem_Realloc(Cfunction),285 PyModule_NewObject(Cfunction),201
PyMem_Resize(Cmacro),286 PyModule_SetDocString(Cfunction),208
PyMem_SetAllocator(Cfunction),289 PyModule_Type(Cvar),201
PyMem_SetupDebugHooks(Cfunction),289 PyModuleDef(Ctype),202
PyMemAllocatorDomain(Ctype),288 PyModuleDef_Init(Cfunction),72
PyMemAllocatorEx(Ctype),288 PyModuleDef_Slot(Ctype),203
PyMember_GetOne(Cfunction),307 PyModuleDef_Slot.slot(Cmember),203
PyMember_SetOne(Cfunction),307 PyModuleDef_Slot.value(Cmember),203
PyMemberDef(Ctype),306 PyModuleDef.m_base(Cmember),202
PyMemberDef.doc(Cmember),306 PyModuleDef.m_clear(Cmember),203
PyMemberDef.flags(Cmember),306 PyModuleDef.m_doc(Cmember),202
PyMemberDef.name(Cmember),306 PyModuleDef.m_free(Cmember),203
PyMemberDef.offset(Cmember),306 PyModuleDef.m_methods(Cmember),202
PyMemberDef.type(Cmember),306 PyModuleDef.m_name(Cmember),202
PyMemoryView_Check(Cfunction),212 PyModuleDef.m_size(Cmember),202
PyMemoryView_FromBuffer(Cfunction),211 PyModuleDef.m_slots(Cmember),202
PyMemoryView_FromMemory(Cfunction),211 PyModuleDef.m_slots.m_reload(Cmember),203
PyMemoryView_FromObject(Cfunction),211 PyModuleDef.m_traverse(Cmember),203
PyMemoryView_GET_BASE(Cfunction),212 PyMonitoring_EnterScope(Cfunction),360
PyMemoryView_GET_BUFFER(Cfunction),212 PyMonitoring_ExitScope(Cfunction),361
PyMemoryView_GetContiguous(Cfunction),211 PyMonitoring_FireBranchLeftEvent (C func-
PyMethod_Check(Cfunction),193 tion),359
PyMethod_Function(Cfunction),193 PyMonitoring_FireBranchRightEvent (C func-
PyMethod_GET_FUNCTION(Cfunction),193 tion),359
PyMethod_GET_SELF(Cfunction),193 PyMonitoring_FireCallEvent(Cfunction),359
PyMethod_New(Cfunction),193 PyMonitoring_FireCRaiseEvent(Cfunction),360
PyMethod_Self(Cfunction),193 PyMonitoring_FireCReturnEvent (C function),
PyMethod_Type(Cvar),193 360
PyMethodDef(Ctype),304 PyMonitoring_FireExceptionHandledEvent (C
PyMethodDef.ml_doc(Cmember),304 function),360
PyMethodDef.ml_flags(Cmember),304 PyMonitoring_FireJumpEvent(Cfunction),359
PyMethodDef.ml_meth(Cmember),304 PyMonitoring_FireLineEvent(Cfunction),359
PyMethodDef.ml_name(Cmember),304 PyMonitoring_FirePyResumeEvent (C function),
PyMODINIT_FUNC(Cmacro),72 359
PyModule_Add(Cfunction),206 PyMonitoring_FirePyReturnEvent (C function),
PyModule_AddFunctions(Cfunction),207 359
PyModule_AddIntConstant(Cfunction),207 PyMonitoring_FirePyStartEvent (C function),
PyModule_AddIntMacro(Cmacro),207 359
PyModule_AddObject(Cfunction),207 PyMonitoring_FirePyThrowEvent (C function),
PyModule_AddObjectRef(Cfunction),206 360
PyModule_AddStringConstant(Cfunction),207 PyMonitoring_FirePyUnwindEvent (C function),
PyModule_AddStringMacro(Cmacro),207 360
PyModule_AddType(Cfunction),207 PyMonitoring_FirePyYieldEvent (C function),
PyModule_Check(Cfunction),201 359
PyModule_CheckExact(Cfunction),201 PyMonitoring_FireRaiseEvent(Cfunction),360
PyModule_Create(Cfunction),205 PyMonitoring_FireReraiseEvent (C function),
PyModule_Create2(Cfunction),205 360
PyModule_ExecDef(Cfunction),205 PyMonitoring_FireStopIterationEvent (C
PyModule_FromDefAndSpec(Cfunction),205 function),360
PyModule_FromDefAndSpec2(Cfunction),205 PyMonitoringState(Ctype),359
PyModule_GetDef(Cfunction),201 PyMutex(Ctype),252
PyModule_GetDict(Cfunction),201 PyMutex_IsLocked(Cfunction),252
PyModule_GetFilename(Cfunction),202 PyMutex_Lock(Cfunction),252
PyModule_GetFilenameObject(Cfunction),201 PyMutex_Unlock(Cfunction),252
PyModule_GetName(Cfunction),201 PyNumber_Absolute(Cfunction),118
PyModule_GetNameObject(Cfunction),201 PyNumber_Add(Cfunction),118
Index 421

### 第430页

PyNumber_And(Cfunction),119 PyNumberMethods.nb_inplace_or (C member),
PyNumber_AsSsize_t(Cfunction),120 343
PyNumber_Check(Cfunction),118 PyNumberMethods.nb_inplace_power (C mem-
PyNumber_Divmod(Cfunction),118 ber),343
PyNumber_Float(Cfunction),120 PyNumberMethods.nb_inplace_remainder (C
PyNumber_FloorDivide(Cfunction),118 member),343
PyNumber_Index(Cfunction),120 PyNumberMethods.nb_inplace_rshift (C mem-
PyNumber_InPlaceAdd(Cfunction),119 ber),343
PyNumber_InPlaceAnd(Cfunction),120 PyNumberMethods.nb_inplace_subtract (C
PyNumber_InPlaceFloorDivide(Cfunction),119 member),343
PyNumber_InPlaceLshift(Cfunction),120 PyNumberMethods.nb_inplace_true_divide (C
PyNumber_InPlaceMatrixMultiply (C function), member),343
119 PyNumberMethods.nb_inplace_xor (C member),
PyNumber_InPlaceMultiply(Cfunction),119 343
PyNumber_InPlaceOr(Cfunction),120 PyNumberMethods.nb_int(Cmember),343
PyNumber_InPlacePower(Cfunction),119 PyNumberMethods.nb_invert(Cmember),343
PyNumber_InPlaceRemainder(Cfunction),119 PyNumberMethods.nb_lshift(Cmember),343
PyNumber_InPlaceRshift(Cfunction),120 PyNumberMethods.nb_matrix_multiply (C mem-
PyNumber_InPlaceSubtract(Cfunction),119 ber),343
PyNumber_InPlaceTrueDivide(Cfunction),119 PyNumberMethods.nb_multiply(Cmember),342
PyNumber_InPlaceXor(Cfunction),120 PyNumberMethods.nb_negative(Cmember),342
PyNumber_Invert(Cfunction),118 PyNumberMethods.nb_or(Cmember),343
PyNumber_Long(Cfunction),120 PyNumberMethods.nb_positive(Cmember),342
PyNumber_Lshift(Cfunction),119 PyNumberMethods.nb_power(Cmember),342
PyNumber_MatrixMultiply(Cfunction),118 PyNumberMethods.nb_remainder(Cmember),342
PyNumber_Multiply(Cfunction),118 PyNumberMethods.nb_reserved(Cmember),343
PyNumber_Negative(Cfunction),118 PyNumberMethods.nb_rshift(Cmember),343
PyNumber_Or(Cfunction),119 PyNumberMethods.nb_subtract(Cmember),342
PyNumber_Positive(Cfunction),118 PyNumberMethods.nb_true_divide (C member),
PyNumber_Power(Cfunction),118 343
PyNumber_Remainder(Cfunction),118 PyNumberMethods.nb_xor(Cmember),343
PyNumber_Rshift(Cfunction),119 PyObject(Ctype),301
PyNumber_Subtract(Cfunction),118 PyObject_ASCII(Cfunction),107
PyNumber_ToBase(Cfunction),120 PyObject_AsFileDescriptor(Cfunction),200
PyNumber_TrueDivide(Cfunction),118 PyObject_Bytes(Cfunction),108
PyNumber_Xor(Cfunction),119 PyObject_Call(Cfunction),115
PyNumberMethods(Ctype),341 PyObject_CallFinalizer(Cfunction),301
PyNumberMethods.nb_absolute(Cmember),342 PyObject_CallFinalizerFromDealloc (C func-
PyNumberMethods.nb_add(Cmember),342 tion),301
PyNumberMethods.nb_and(Cmember),343 PyObject_CallFunction(Cfunction),116
PyNumberMethods.nb_bool(Cmember),342 PyObject_CallFunctionObjArgs(Cfunction),116
PyNumberMethods.nb_divmod(Cmember),342 PyObject_CallMethod(Cfunction),116
PyNumberMethods.nb_float(Cmember),343 PyObject_CallMethodNoArgs(Cfunction),116
PyNumberMethods.nb_floor_divide (C member), PyObject_CallMethodObjArgs(Cfunction),116
343 PyObject_CallMethodOneArg(Cfunction),117
PyNumberMethods.nb_index(Cmember),343 PyObject_CallNoArgs(Cfunction),115
PyNumberMethods.nb_inplace_add (C member), PyObject_CallObject(Cfunction),116
343 PyObject_Calloc(Cfunction),287
PyNumberMethods.nb_inplace_and (C member), PyObject_CallOneArg(Cfunction),116
343 PyObject_CheckBuffer(Cfunction),130
PyNumberMethods.nb_inplace_floor_divide PyObject_ClearManagedDict(Cfunction),110
(Cmember),343 PyObject_ClearWeakRefs(Cfunction),213
PyNumberMethods.nb_inplace_lshift (C mem- PyObject_CopyData(Cfunction),131
ber),343 PyObject_Del(Cfunction),297
PyNumberMethods.nb_inplace_matrix_multiply PyObject_DelAttr(Cfunction),106
(Cmember),343 PyObject_DelAttrString(Cfunction),106
PyNumberMethods.nb_inplace_multiply (C PyObject_DelItem(Cfunction),109
member),343 PyObject_DelItemString(Cfunction),109
422 Index

### 第431页

PyObject_Dir(Cfunction),109 PyObject_SetItem(Cfunction),109
PyObject_Format(Cfunction),107 PyObject_Size(Cfunction),109
PyObject_Free(Cfunction),287 PyObject_Str(Cfunction),107
PyObject_GC_Del(Cfunction),352 PyObject_Type(Cfunction),108
PyObject_GC_IsFinalized(Cfunction),352 PyObject_TypeCheck(Cfunction),108
PyObject_GC_IsTracked(Cfunction),352 PyObject_VAR_HEAD(Cmacro),302
PyObject_GC_New(Cmacro),351 PyObject_Vectorcall(Cfunction),117
PyObject_GC_NewVar(Cmacro),351 PyObject_VectorcallDict(Cfunction),117
PyObject_GC_Resize(Cmacro),352 PyObject_VectorcallMethod(Cfunction),117
PyObject_GC_Track(Cfunction),352 PyObject_VisitManagedDict(Cfunction),110
PyObject_GC_UnTrack(Cfunction),353 PyObjectArenaAllocator(Ctype),291
PyObject_GenericGetAttr(Cfunction),106 PyObject.ob_refcnt(Cmember),301
PyObject_GenericGetDict(Cfunction),106 PyObject.ob_type(Cmember),301
PyObject_GenericHash(Cfunction),97 PyOS_AfterFork(Cfunction),76
PyObject_GenericSetAttr(Cfunction),106 PyOS_AfterFork_Child(Cfunction),76
PyObject_GenericSetDict(Cfunction),107 PyOS_AfterFork_Parent(Cfunction),75
PyObject_GetAIter(Cfunction),109 PyOS_BeforeFork(Cfunction),75
PyObject_GetArenaAllocator(Cfunction),291 PyOS_CheckStack(Cfunction),76
PyObject_GetAttr(Cfunction),105 PyOS_double_to_string(Cfunction),95
PyObject_GetAttrString(Cfunction),105 PyOS_FSPath(Cfunction),75
PyObject_GetBuffer(Cfunction),130 PyOS_getsig(Cfunction),76
PyObject_GetItem(Cfunction),109 PyOS_InputHook(Cvar),44
PyObject_GetItemData(Cfunction),110 PyOS_ReadlineFunctionPointer(Cvar),44
PyObject_GetIter(Cfunction),109 PyOS_setsig(Cfunction),76
PyObject_GetOptionalAttr(Cfunction),105 PyOS_sighandler_t(Ctype),76
PyObject_GetOptionalAttrString (C function), PyOS_snprintf(Cfunction),94
106 PyOS_stricmp(Cfunction),95
PyObject_GetTypeData(Cfunction),109 PyOS_string_to_double(Cfunction),95
PyObject_HasAttr(Cfunction),105 PyOS_strnicmp(Cfunction),95
PyObject_HasAttrString(Cfunction),105 PyOS_strtol(Cfunction),94
PyObject_HasAttrStringWithError (C function), PyOS_strtoul(Cfunction),94
105 PyOS_vsnprintf(Cfunction),94
PyObject_HasAttrWithError(Cfunction),105 PyPreConfig(Ctype),263
PyObject_Hash(Cfunction),108 PyPreConfig_InitIsolatedConfig (C function),
PyObject_HashNotImplemented(Cfunction),108 263
PyObject_HEAD(Cmacro),302 PyPreConfig_InitPythonConfig(Cfunction),263
PyObject_HEAD_INIT(Cmacro),303 PyPreConfig.allocator(Cmember),263
PyObject_Init(Cfunction),295 PyPreConfig.coerce_c_locale(Cmember),264
PyObject_InitVar(Cfunction),295 PyPreConfig.coerce_c_locale_warn (C mem-
PyObject_IS_GC(Cfunction),352 ber),264
PyObject_IsInstance(Cfunction),108 PyPreConfig.configure_locale(Cmember),264
PyObject_IsSubclass(Cfunction),108 PyPreConfig.dev_mode(Cmember),264
PyObject_IsTrue(Cfunction),108 PyPreConfig.isolated(Cmember),264
PyObject_Length(Cfunction),109 PyPreConfig.legacy_windows_fs_encoding (C
PyObject_LengthHint(Cfunction),109 member),264
PyObject_Malloc(Cfunction),287 PyPreConfig.parse_argv(Cmember),264
PyObject_New(Cmacro),295 PyPreConfig.use_environment(Cmember),265
PyObject_NewVar(Cmacro),296 PyPreConfig.utf8_mode(Cmember),265
PyObject_Not(Cfunction),108 PyProperty_Type(Cvar),209
PyObject_Print(Cfunction),104 PyRefTracer(Ctype),249
PyObject_Realloc(Cfunction),287 PyRefTracer_CREATE(Cvar),249
PyObject_Repr(Cfunction),107 PyRefTracer_DESTROY(Cvar),249
PyObject_RichCompare(Cfunction),107 PyRefTracer_GetTracer(Cfunction),249
PyObject_RichCompareBool(Cfunction),107 PyRefTracer_SetTracer(Cfunction),249
PyObject_SelfIter(Cfunction),109 PyRun_AnyFile(Cfunction),43
PyObject_SetArenaAllocator(Cfunction),291 PyRun_AnyFileEx(Cfunction),43
PyObject_SetAttr(Cfunction),106 PyRun_AnyFileExFlags(Cfunction),43
PyObject_SetAttrString(Cfunction),106 PyRun_AnyFileFlags(Cfunction),43
Index 423

### 第432页

PyRun_File(Cfunction),45 PySet_CheckExact(Cfunction),189
PyRun_FileEx(Cfunction),45 PySet_Clear(Cfunction),190
PyRun_FileExFlags(Cfunction),45 PySet_Contains(Cfunction),190
PyRun_FileFlags(Cfunction),45 PySet_Discard(Cfunction),190
PyRun_InteractiveLoop(Cfunction),44 PySet_GET_SIZE(Cfunction),189
PyRun_InteractiveLoopFlags(Cfunction),44 PySet_New(Cfunction),189
PyRun_InteractiveOne(Cfunction),44 PySet_Pop(Cfunction),190
PyRun_InteractiveOneFlags(Cfunction),44 PySet_Size(Cfunction),189
PyRun_SimpleFile(Cfunction),43 PySet_Type(Cvar),189
PyRun_SimpleFileEx(Cfunction),43 PySetObject(Ctype),189
PyRun_SimpleFileExFlags(Cfunction),43 PySignal_SetWakeupFd(Cfunction),59
PyRun_SimpleString(Cfunction),43 PySlice_AdjustIndices(Cfunction),211
PyRun_SimpleStringFlags(Cfunction),43 PySlice_Check(Cfunction),210
PyRun_String(Cfunction),44 PySlice_GetIndices(Cfunction),210
PyRun_StringFlags(Cfunction),44 PySlice_GetIndicesEx(Cfunction),210
PySendResult(Ctype),125 PySlice_New(Cfunction),210
PySeqIter_Check(Cfunction),209 PySlice_Type(Cvar),210
PySeqIter_New(Cfunction),209 PySlice_Unpack(Cfunction),211
PySeqIter_Type(Cvar),209 PyState_AddModule(Cfunction),208
PySequence_Check(Cfunction),121 PyState_FindModule(Cfunction),208
PySequence_Concat(Cfunction),121 PyState_RemoveModule(Cfunction),209
PySequence_Contains(Cfunction),122 PyStatus(Ctype),262
PySequence_Count(Cfunction),121 PyStatus_Error(Cfunction),262
PySequence_DelItem(Cfunction),121 PyStatus_Exception(Cfunction),262
PySequence_DelSlice(Cfunction),121 PyStatus_Exit(Cfunction),262
PySequence_Fast(Cfunction),122 PyStatus_IsError(Cfunction),262
PySequence_Fast_GET_ITEM(Cfunction),122 PyStatus_IsExit(Cfunction),262
PySequence_Fast_GET_SIZE(Cfunction),122 PyStatus_NoMemory(Cfunction),262
PySequence_Fast_ITEMS(Cfunction),122 PyStatus_Ok(Cfunction),262
PySequence_GetItem(Cfunction),8,121 PyStatus.err_msg(Cmember),262
PySequence_GetSlice(Cfunction),121 PyStatus.exitcode(Cmember),262
PySequence_In(Cfunction),122 PyStatus.func(Cmember),262
PySequence_Index(Cfunction),122 PyStructSequence_Desc(Ctype),180
PySequence_InPlaceConcat(Cfunction),121 PyStructSequence_Desc.doc(Cmember),180
PySequence_InPlaceRepeat(Cfunction),121 PyStructSequence_Desc.fields(Cmember),181
PySequence_ITEM(Cfunction),122 PyStructSequence_Desc.n_in_sequence (C
PySequence_Length(Cfunction),121 member),181
PySequence_List(Cfunction),122 PyStructSequence_Desc.name(Cmember),180
PySequence_Repeat(Cfunction),121 PyStructSequence_Field(Ctype),181
PySequence_SetItem(Cfunction),121 PyStructSequence_Field.doc(Cmember),181
PySequence_SetSlice(Cfunction),121 PyStructSequence_Field.name(Cmember),181
PySequence_Size(Cfunction),121 PyStructSequence_GET_ITEM(Cfunction),181
PySequence_Tuple(Cfunction),122 PyStructSequence_GetItem(Cfunction),181
PySequenceMethods(Ctype),344 PyStructSequence_InitType(Cfunction),180
PySequenceMethods.sq_ass_item (C member), PyStructSequence_InitType2(Cfunction),180
344 PyStructSequence_New(Cfunction),181
PySequenceMethods.sq_concat(Cmember),344 PyStructSequence_NewType(Cfunction),180
PySequenceMethods.sq_contains (C member), PyStructSequence_SET_ITEM(Cfunction),181
344 PyStructSequence_SetItem(Cfunction),181
PySequenceMethods.sq_inplace_concat (C PyStructSequence_UnnamedField(Cvar),181
member),344 PySys_AddAuditHook(Cfunction),79
PySequenceMethods.sq_inplace_repeat (C PySys_Audit(Cfunction),79
member),344 PySys_AuditTuple(Cfunction),79
PySequenceMethods.sq_item(Cmember),344 PySys_FormatStderr(Cfunction),78
PySequenceMethods.sq_length(Cmember),344 PySys_FormatStdout(Cfunction),78
PySequenceMethods.sq_repeat(Cmember),344 PySys_GetObject(Cfunction),78
PySet_Add(Cfunction),190 PySys_GetXOptions(Cfunction),79
PySet_Check(Cfunction),189 PySys_ResetWarnOptions(Cfunction),78
424 Index

### 第433页

PySys_SetArgv(Cfunction),234 PEP 3147,83
PySys_SetArgvEx(Cfunction),234 PEP 3151,67
PySys_SetObject(Cfunction),78 PEP 3155,376
PySys_WriteStderr(Cfunction),78 PYTHON_ABI_VERSION(Cmacro),205
PySys_WriteStdout(Cfunction),78 PYTHON_API_VERSION(Cmacro),205
Python 3000,376 PYTHON_CPU_COUNT,271
Python Enhancement Proposals PYTHON_FROZEN_MODULES,270
PEP 1,376 PYTHON_GIL,370
PEP 7,3,6 PYTHON_PERF_JIT_SUPPORT,276
PEP 238,369 PYTHON_PRESITE,275
PEP 278,379 PYTHONCOERCECLOCALE,279
PEP 302,373 PYTHONDEBUG,226,273
PEP 343,366 PYTHONDEVMODE,269
PEP 353,10 PYTHONDONTWRITEBYTECODE,227,277
PEP 362,364,375 PYTHONDUMPREFS,269
PEP 383,166,167 PYTHONDUMPREFSFILE,269
PEP 387,15,16 PYTHONEXECUTABLE,274
PEP 393,157 PYTHONFAULTHANDLER,270
PEP 411,376 PYTHONHASHSEED,227,270
PEP 420,374,376 PYTHONHOME,12,227,235,271
PEP 442,300,340 Pythonic,376
PEP 443,370 PYTHONINSPECT,227,271
PEP 446,78 PYTHONINTMAXSTRDIGITS,271
PEP 451,203 PYTHONIOENCODING,275
PEP 456,96 PYTHONLEGACYWINDOWSFSENCODING,228,264
PEP 483,370 PYTHONLEGACYWINDOWSSTDIO,228,272
PEP 484,363,369,370,379,380 PYTHONMALLOC,284,288,290,291
PEP 489,71,72,244 PYTHONMALLOCSTATS,272,284
PEP 492,364367 PYTHONNODEBUGRANGES,268
PEP 498,368 PYTHONNOUSERSITE,228,276
PEP 519,375 PYTHONOPTIMIZE,228,273
PEP 523,217,242 PYTHONPATH,12,227,272
PEP 525,364 PYTHONPERFSUPPORT,276
PEP 526,363,380 PYTHONPLATLIBDIR,272
PEP 528,228,272 PYTHONPROFILEIMPORTTIME,271
PEP 529,167,228 PYTHONPYCACHEPREFIX,274
PEP 538,279 PYTHONSAFEPATH,267
PEP 539,250 PYTHONTRACEMALLOC,276
PEP 540,279 PYTHONUNBUFFERED,229,268
PEP 552,269 PYTHONUTF8,265,279
PEP 554,246 PYTHONVERBOSE,229,277
PEP 578,79 PYTHONWARNINGS,277
PEP 585,370 PyThread_create_key(Cfunction),251
PEP 587,261 PyThread_delete_key(Cfunction),251
PEP 590,113 PyThread_delete_key_value(Cfunction),251
PEP 623,157 PyThread_get_key_value(Cfunction),251
PEP 0626#out-of-process-debuggers-and-prPoyfTihlreerasd,_ReInitTLS(Cfunction),251
195 PyThread_set_key_value(Cfunction),251
PEP 634,327 PyThread_tss_alloc(Cfunction),250
PEP 649,363 PyThread_tss_create(Cfunction),251
PEP 667,97,216,217 PyThread_tss_delete(Cfunction),251
PEP 0683,47,48,371 PyThread_tss_free(Cfunction),250
PEP 684,238,246 PyThread_tss_get(Cfunction),251
PEP 703,369,370 PyThread_tss_is_created(Cfunction),251
PEP 741,255 PyThread_tss_set(Cfunction),251
PEP 3116,379 PyThreadState(Ctype),235,238
PEP 3119,108 PyThreadState_Clear(Cfunction),241
PEP 3121,202 PyThreadState_Delete(Cfunction),241
Index 425

### 第434页

PyThreadState_DeleteCurrent(Cfunction),241 PyType_Freeze(Cfunction),138
PyThreadState_EnterTracing(Cfunction),242 PyType_FromMetaclass(Cfunction),137
PyThreadState_Get(Cfunction),239 PyType_FromModuleAndSpec(Cfunction),137
PyThreadState_GetDict(Cfunction),242 PyType_FromSpec(Cfunction),138
PyThreadState_GetFrame(Cfunction),241 PyType_FromSpecWithBases(Cfunction),137
PyThreadState_GetID(Cfunction),241 PyType_GenericAlloc(Cfunction),134
PyThreadState_GetInterpreter(Cfunction),241 PyType_GenericNew(Cfunction),135
PyThreadState_GetUnchecked(Cfunction),239 PyType_GetBaseByToken(Cfunction),136
PyThreadState_LeaveTracing(Cfunction),242 PyType_GetDict(Cfunction),133
PyThreadState_New(Cfunction),241 PyType_GetFlags(Cfunction),133
PyThreadState_Next(Cfunction),249 PyType_GetFullyQualifiedName(Cfunction),135
PyThreadState_SetAsyncExc(Cfunction),243 PyType_GetModule(Cfunction),136
PyThreadState_Swap(Cfunction),239 PyType_GetModuleByDef(Cfunction),136
PyThreadState.interp(Cmember),238 PyType_GetModuleName(Cfunction),135
PyTime_AsSecondsDouble(Cfunction),101 PyType_GetModuleState(Cfunction),136
PyTime_Check(Cfunction),221 PyType_GetName(Cfunction),135
PyTime_CheckExact(Cfunction),221 PyType_GetQualName(Cfunction),135
PyTime_FromTime(Cfunction),222 PyType_GetSlot(Cfunction),135
PyTime_FromTimeAndFold(Cfunction),222 PyType_GetTypeDataSize(Cfunction),110
PyTime_MAX(Cvar),100 PyType_HasFeature(Cfunction),134
PyTime_MIN(Cvar),100 PyType_IS_GC(Cfunction),134
PyTime_Monotonic(Cfunction),100 PyType_IsSubtype(Cfunction),134
PyTime_MonotonicRaw(Cfunction),101 PyType_Modified(Cfunction),134
PyTime_PerfCounter(Cfunction),100 PyType_Ready(Cfunction),135
PyTime_PerfCounterRaw(Cfunction),101 PyType_Slot(Ctype),139
PyTime_t(Ctype),100 PyType_Slot.pfunc(Cmember),139
PyTime_Time(Cfunction),100 PyType_Slot.slot(Cmember),139
PyTime_TimeRaw(Cfunction),101 PyType_Spec(Ctype),138
PyTimeZone_FromOffset(Cfunction),222 PyType_Spec.basicsize(Cmember),138
PyTimeZone_FromOffsetAndName(Cfunction),222 PyType_Spec.flags(Cmember),138
PyTrace_C_CALL(Cvar),248 PyType_Spec.itemsize(Cmember),138
PyTrace_C_EXCEPTION(Cvar),248 PyType_Spec.name(Cmember),138
PyTrace_C_RETURN(Cvar),248 PyType_Spec.slots(Cmember),139
PyTrace_CALL(Cvar),247 PyType_Type(Cvar),133
PyTrace_EXCEPTION(Cvar),247 PyType_Watch(Cfunction),134
PyTrace_LINE(Cvar),248 PyType_WatchCallback(Ctype),134
PyTrace_OPCODE(Cvar),248 PyTypeObject(Ctype),133
PyTrace_RETURN(Cvar),248 PyTypeObject.tp_alloc(Cmember),336
PyTraceMalloc_Track(Cfunction),292 PyTypeObject.tp_as_async(Cmember),321
PyTraceMalloc_Untrack(Cfunction),292 PyTypeObject.tp_as_buffer(Cmember),323
PyTuple_Check(Cfunction),179 PyTypeObject.tp_as_mapping(Cmember),322
PyTuple_CheckExact(Cfunction),179 PyTypeObject.tp_as_number(Cmember),322
PyTuple_GET_ITEM(Cfunction),179 PyTypeObject.tp_as_sequence(Cmember),322
PyTuple_GET_SIZE(Cfunction),179 PyTypeObject.tp_base(Cmember),333
PyTuple_GetItem(Cfunction),179 PyTypeObject.tp_bases(Cmember),337
PyTuple_GetSlice(Cfunction),179 PyTypeObject.tp_basicsize(Cmember),317
PyTuple_New(Cfunction),179 PyTypeObject.tp_cache(Cmember),337
PyTuple_Pack(Cfunction),179 PyTypeObject.tp_call(Cmember),322
PyTuple_SET_ITEM(Cfunction),180 PyTypeObject.tp_clear(Cmember),329
PyTuple_SetItem(Cfunction),7,179 PyTypeObject.tp_dealloc(Cmember),318
PyTuple_Size(Cfunction),179 PyTypeObject.tp_del(Cmember),338
PyTuple_Type(Cvar),179 PyTypeObject.tp_descr_get(Cmember),334
PyTupleObject(Ctype),179 PyTypeObject.tp_descr_set(Cmember),334
PyType_AddWatcher(Cfunction),134 PyTypeObject.tp_dict(Cmember),334
PyType_Check(Cfunction),133 PyTypeObject.tp_dictoffset(Cmember),335
PyType_CheckExact(Cfunction),133 PyTypeObject.tp_doc(Cmember),328
PyType_ClearCache(Cfunction),133 PyTypeObject.tp_finalize(Cmember),338
PyType_ClearWatcher(Cfunction),134 PyTypeObject.tp_flags(Cmember),323
426 Index

### 第435页

PyTypeObject.tp_free(Cmember),336 PyUnicode_BuildEncodingMap(Cfunction),164
PyTypeObject.tp_getattr(Cmember),321 PyUnicode_Check(Cfunction),158
PyTypeObject.tp_getattro(Cmember),323 PyUnicode_CHECK_INTERNED(Cfunction),176
PyTypeObject.tp_getset(Cmember),333 PyUnicode_CheckExact(Cfunction),158
PyTypeObject.tp_hash(Cmember),322 PyUnicode_Compare(Cfunction),175
PyTypeObject.tp_init(Cmember),335 PyUnicode_CompareWithASCIIString (C func-
PyTypeObject.tp_is_gc(Cmember),337 tion),175
PyTypeObject.tp_itemsize(Cmember),317 PyUnicode_Concat(Cfunction),173
PyTypeObject.tp_iter(Cmember),333 PyUnicode_Contains(Cfunction),176
PyTypeObject.tp_iternext(Cmember),333 PyUnicode_CopyCharacters(Cfunction),165
PyTypeObject.tp_members(Cmember),333 PyUnicode_Count(Cfunction),175
PyTypeObject.tp_methods(Cmember),333 PyUnicode_DATA(Cfunction),158
PyTypeObject.tp_mro(Cmember),337 PyUnicode_Decode(Cfunction),169
PyTypeObject.tp_name(Cmember),317 PyUnicode_DecodeASCII(Cfunction),172
PyTypeObject.tp_new(Cmember),336 PyUnicode_DecodeCharmap(Cfunction),172
PyTypeObject.tp_repr(Cmember),321 PyUnicode_DecodeCodePageStateful (C func-
PyTypeObject.tp_richcompare(Cmember),331 tion),173
PyTypeObject.tp_setattr(Cmember),321 PyUnicode_DecodeFSDefault(Cfunction),167
PyTypeObject.tp_setattro(Cmember),323 PyUnicode_DecodeFSDefaultAndSize (C func-
PyTypeObject.tp_str(Cmember),322 tion),167
PyTypeObject.tp_subclasses(Cmember),337 PyUnicode_DecodeLatin1(Cfunction),172
PyTypeObject.tp_traverse(Cmember),328 PyUnicode_DecodeLocale(Cfunction),166
PyTypeObject.tp_vectorcall(Cmember),340 PyUnicode_DecodeLocaleAndSize (C function),
PyTypeObject.tp_vectorcall_offset (C mem- 166
ber),320 PyUnicode_DecodeMBCS(Cfunction),173
PyTypeObject.tp_version_tag(Cmember),338 PyUnicode_DecodeMBCSStateful(Cfunction),173
PyTypeObject.tp_watched(Cmember),341 PyUnicode_DecodeRawUnicodeEscape (C func-
PyTypeObject.tp_weaklist(Cmember),338 tion),172
PyTypeObject.tp_weaklistoffset (C member), PyUnicode_DecodeUnicodeEscape (C function),
332 171
PyTZInfo_Check(Cfunction),221 PyUnicode_DecodeUTF7(Cfunction),171
PyTZInfo_CheckExact(Cfunction),222 PyUnicode_DecodeUTF7Stateful(Cfunction),171
PyUnicode_1BYTE_DATA(Cfunction),158 PyUnicode_DecodeUTF8(Cfunction),169
PyUnicode_1BYTE_KIND(Cmacro),158 PyUnicode_DecodeUTF8Stateful(Cfunction),169
PyUnicode_2BYTE_DATA(Cfunction),158 PyUnicode_DecodeUTF16(Cfunction),171
PyUnicode_2BYTE_KIND(Cmacro),158 PyUnicode_DecodeUTF16Stateful (C function),
PyUnicode_4BYTE_DATA(Cfunction),158 171
PyUnicode_4BYTE_KIND(Cmacro),158 PyUnicode_DecodeUTF32(Cfunction),170
PyUnicode_Append(Cfunction),164 PyUnicode_DecodeUTF32Stateful (C function),
PyUnicode_AppendAndDel(Cfunction),164 170
PyUnicode_AsASCIIString(Cfunction),172 PyUnicode_EncodeCodePage(Cfunction),173
PyUnicode_AsCharmapString(Cfunction),173 PyUnicode_EncodeFSDefault(Cfunction),167
PyUnicode_AsEncodedString(Cfunction),169 PyUnicode_EncodeLocale(Cfunction),166
PyUnicode_AsLatin1String(Cfunction),172 PyUnicode_Equal(Cfunction),175
PyUnicode_AsMBCSString(Cfunction),173 PyUnicode_EqualToUTF8(Cfunction),175
PyUnicode_AsRawUnicodeEscapeString (C func- PyUnicode_EqualToUTF8AndSize(Cfunction),175
tion),172 PyUnicode_Fill(Cfunction),165
PyUnicode_AsUCS4(Cfunction),165 PyUnicode_Find(Cfunction),174
PyUnicode_AsUCS4Copy(Cfunction),166 PyUnicode_FindChar(Cfunction),174
PyUnicode_AsUnicodeEscapeString (C function), PyUnicode_Format(Cfunction),176
171 PyUnicode_FromEncodedObject(Cfunction),164
PyUnicode_AsUTF8(Cfunction),170 PyUnicode_FromFormat(Cfunction),161
PyUnicode_AsUTF8AndSize(Cfunction),169 PyUnicode_FromFormatV(Cfunction),164
PyUnicode_AsUTF8String(Cfunction),169 PyUnicode_FromKindAndData(Cfunction),161
PyUnicode_AsUTF16String(Cfunction),171 PyUnicode_FromObject(Cfunction),164
PyUnicode_AsUTF32String(Cfunction),170 PyUnicode_FromOrdinal(Cfunction),164
PyUnicode_AsWideChar(Cfunction),168 PyUnicode_FromString(Cfunction),161
PyUnicode_AsWideCharString(Cfunction),168 PyUnicode_FromStringAndSize(Cfunction),161
Index 427

### 第436页

PyUnicode_FromWideChar(Cfunction),168 PyUnicodeIter_Type(Cvar),157
PyUnicode_FSConverter(Cfunction),167 PyUnicodeObject(Ctype),158
PyUnicode_FSDecoder(Cfunction),167 PyUnicodeTranslateError_GetEnd (C function),
PyUnicode_GET_LENGTH(Cfunction),158 62
PyUnicode_GetDefaultEncoding(Cfunction),164 PyUnicodeTranslateError_GetObject (C func-
PyUnicode_GetLength(Cfunction),164 tion),61
PyUnicode_InternFromString(Cfunction),176 PyUnicodeTranslateError_GetReason (C func-
PyUnicode_InternInPlace(Cfunction),176 tion),62
PyUnicode_IS_ASCII(Cfunction),159 PyUnicodeTranslateError_GetStart (C func-
PyUnicode_IS_READY(Cfunction),178 tion),61
PyUnicode_IsIdentifier(Cfunction),159 PyUnicodeTranslateError_SetEnd (C function),
PyUnicode_Join(Cfunction),174 62
PyUnicode_KIND(Cfunction),158 PyUnicodeTranslateError_SetReason (C func-
PyUnicode_MAX_CHAR_VALUE(Cfunction),159 tion),62
PyUnicode_New(Cfunction),160 PyUnicodeTranslateError_SetStart (C func-
PyUnicode_Partition(Cfunction),174 tion),61
PyUnicode_READ(Cfunction),159 PyUnicodeWriter(Ctype),177
PyUnicode_READ_CHAR(Cfunction),159 PyUnicodeWriter_Create(Cfunction),177
PyUnicode_ReadChar(Cfunction),165 PyUnicodeWriter_DecodeUTF8Stateful (C func-
PyUnicode_READY(Cfunction),178 tion),178
PyUnicode_Replace(Cfunction),175 PyUnicodeWriter_Discard(Cfunction),177
PyUnicode_Resize(Cfunction),165 PyUnicodeWriter_Finish(Cfunction),177
PyUnicode_RichCompare(Cfunction),176 PyUnicodeWriter_Format(Cfunction),178
PyUnicode_RPartition(Cfunction),174 PyUnicodeWriter_WriteASCII(Cfunction),177
PyUnicode_RSplit(Cfunction),174 PyUnicodeWriter_WriteChar(Cfunction),177
PyUnicode_Split(Cfunction),174 PyUnicodeWriter_WriteRepr(Cfunction),178
PyUnicode_Splitlines(Cfunction),174 PyUnicodeWriter_WriteStr(Cfunction),178
PyUnicode_Substring(Cfunction),165 PyUnicodeWriter_WriteSubstring (C function),
PyUnicode_Tailmatch(Cfunction),174 178
PyUnicode_Translate(Cfunction),173 PyUnicodeWriter_WriteUCS4(Cfunction),177
PyUnicode_Type(Cvar),157 PyUnicodeWriter_WriteUTF8(Cfunction),177
PyUnicode_WRITE(Cfunction),158 PyUnicodeWriter_WriteWideChar (C function),
PyUnicode_WriteChar(Cfunction),165 177
PyUnicodeDecodeError_Create(Cfunction),61 PyUnstable,15
PyUnicodeDecodeError_GetEncoding (C func- PyUnstable_AtExit(Cfunction),231
tion),61 PyUnstable_Code_GetExtra(Cfunction),199
PyUnicodeDecodeError_GetEnd(Cfunction),62 PyUnstable_Code_GetFirstFree(Cfunction),194
PyUnicodeDecodeError_GetObject (C function), PyUnstable_Code_New(Cfunction),194
61 PyUnstable_Code_NewWithPosOnlyArgs (C func-
PyUnicodeDecodeError_GetReason (C function), tion),195
62 PyUnstable_Code_SetExtra(Cfunction),199
PyUnicodeDecodeError_GetStart(Cfunction),61 PyUnstable_EnableTryIncRef(Cfunction),112
PyUnicodeDecodeError_SetEnd(Cfunction),62 PyUnstable_Eval_RequestCodeExtraIndex (C
PyUnicodeDecodeError_SetReason (C function), function),199
62 PyUnstable_Exc_PrepReraiseStar (C function),
PyUnicodeDecodeError_SetStart(Cfunction),61 61
PyUnicodeEncodeError_GetEncoding (C func- PyUnstable_GC_VisitObjects(Cfunction),354
tion),61 PyUnstable_InterpreterFrame_GetCode (C
PyUnicodeEncodeError_GetEnd(Cfunction),62 function),217
PyUnicodeEncodeError_GetObject (C function), PyUnstable_InterpreterFrame_GetLasti (C
61 function),217
PyUnicodeEncodeError_GetReason (C function), PyUnstable_InterpreterFrame_GetLine (C
62 function),217
PyUnicodeEncodeError_GetStart(Cfunction),61 PyUnstable_IsImmortal(Cfunction),111
PyUnicodeEncodeError_SetEnd(Cfunction),62 PyUnstable_Long_CompactValue(Cfunction),148
PyUnicodeEncodeError_SetReason (C function), PyUnstable_Long_IsCompact(Cfunction),147
62 PyUnstable_Module_SetGIL(Cfunction),208
PyUnicodeEncodeError_SetStart(Cfunction),61 PyUnstable_Object_ClearWeakRefsNoCallbacks
428 Index

### 第437页

(Cfunction),213 sequence,377
PyUnstable_Object_EnableDeferredRefcount object,154
(Cfunction),110 set
PyUnstable_Object_GC_NewWithExtraData (C object,189
function),351 set comprehension,377
PyUnstable_Object_IsUniquelyReferenced (C set_all(),8
function),113 setattrfunc(Ctype),347
PyUnstable_Object_IsUniqueReferencedTemporasreytattrofunc(Ctype),347
(Cfunction),110 setswitchinterval(inmodulesys),235
PyUnstable_PerfMapState_Fini(Cfunction),102 setter(Ctype),310
PyUnstable_PerfMapState_Init(Cfunction),101 SIGINT(Cmacro),58,59
PyUnstable_TryIncRef(Cfunction),111 signal
PyUnstable_Type_AssignVersionTag (C func- module,58,59
tion),136 single dispatch,377
PyUnstable_WritePerfMapEntry(Cfunction),101 SIZE_MAX(Cmacro),143
PyVarObject(Ctype),301 slice,377
PyVarObject_HEAD_INIT(Cmacro),303 soft deprecated,377
PyVarObject.ob_size(Cmember),301 special
PyVectorcall_Call(Cfunction),115 method,378
PyVectorcall_Function(Cfunction),115 special method,378
PyVectorcall_NARGS(Cfunction),114 ssizeargfunc(Ctype),348
PyWeakref_Check(Cfunction),212 ssizeobjargproc(Ctype),348
PyWeakref_CheckProxy(Cfunction),212 standard library,378
PyWeakref_CheckRef(Cfunction),212 statement,378
PyWeakref_GET_OBJECT(Cfunction),213 static type checker,378
PyWeakref_GetObject(Cfunction),212 staticmethod
PyWeakref_GetRef(Cfunction),212 built-in function,305
PyWeakref_IsDead(Cfunction),213 stderr(inmodulesys),244,245
PyWeakref_NewProxy(Cfunction),212 stdin(inmodulesys),244,245
PyWeakref_NewRef(Cfunction),212 stdlib,378
PyWideStringList(Ctype),261 stdout(inmodulesys),244,245
PyWideStringList_Append(Cfunction),261 strerror(Cfunction),53
PyWideStringList_Insert(Cfunction),262 string
PyWideStringList.items(Cmember),262 PyObject_Str(Cfunction),107
PyWideStringList.length(Cmember),262 strong reference,378
PyWrapper_New(Cfunction),210 structmember.h,310
sum_list(),9
Q
sum_sequence(),9,10
qualified name,376 sys
module,11,229,244,245
R SystemError(built-inexception),201,202
READ_RESTRICTED(Cmacro),308
T
READONLY(Cmacro),308
realloc(Cfunction),283 t-string,378
reference count,377 t-strings,378
regular package,377 T_BOOL(Cmacro),310
releasebufferproc(Ctype),347 T_BYTE(Cmacro),310
REPL,377 T_CHAR(Cmacro),310
repr T_DOUBLE(Cmacro),310
built-in function,107,321 T_FLOAT(Cmacro),310
reprfunc(Ctype),347 T_INT(Cmacro),310
RESTRICTED(Cmacro),308 T_LONG(Cmacro),310
richcmpfunc(Ctype),347 T_LONGLONG(Cmacro),310
T_NONE(Cmacro),310
S T_OBJECT(Cmacro),310
T_OBJECT_EX(Cmacro),310
search
T_PYSSIZET(Cmacro),310
path,module,11,229,233
T_SHORT(Cmacro),310
sendfunc(Ctype),348
Index 429

### 第438页

T_STRING(Cmacro),310
T_STRING_INPLACE(Cmacro),310
T_UBYTE(Cmacro),310
T_UINT(Cmacro),310
T_ULONG(Cmacro),310
T_ULONGULONG(Cmacro),310
T_USHORT(Cmacro),310
ternaryfunc(Ctype),348
text encoding,378
text file,378
thread state,378
token,379
traverseproc(Ctype),353
triple-quoted string,379
tuple
built-in function,122,183
object,179
type,379
built-in function,108
object,6,133
type alias,379
type hint,379
U
ULONG_MAX(Cmacro),143
unaryfunc(Ctype),347
universal newlines,379
USE_STACKCHECK(Cmacro),76
V
variable annotation,379
vectorcallfunc(Ctype),114
version(inmodulesys),233,234
virtual environment,380
virtual machine,380
visitproc(Ctype),353
W
walrus operator,380
WRITE_RESTRICTED(Cmacro),308
Z
Zen of Python,380
430 Index

